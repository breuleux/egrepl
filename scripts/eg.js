require=(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
var $2399=function(type$2402){var f$2406;(f$2406=type$2402["::check"]);if((f$2406===(void 0))){return function(value$2412){return (value$2412 instanceof type$2402);};}else{return function(value$2416){return f$2406.call(type$2402,value$2416);};}};
var $2418=(function(o,m){if(typeof(m)==='string'||typeof(m)==='number'){return o[m];}else{return o['::send'](m);}});
var $2419=function(dest$2422,values$2423){var k$2428;(k$2428=null);$2426:for(k$2428 in values$2423){if(values$2423.hasOwnProperty(k$2428)){(dest$2422[k$2428]=values$2423[k$2428]);}}return dest$2422;};
var $2436=function($2438$2441){var ph$2447;(ph$2447=$2438$2441);var $2443$2453;($2443$2453=ph$2447);var bridge$2445$2458;var x$2462;(bridge$2445$2458=$2443$2453);if((((typeof(bridge$2445$2458)==="string")&&((x$2462=bridge$2445$2458),true))||((typeof(bridge$2445$2458)==="number")&&((x$2462=bridge$2445$2458),true)))){return ["value",x$2462];}else{var other$2473;(other$2473=$2443$2453);return other$2473["::serialize_ast"]();}};
var send$2173;(send$2173=function(obj$2180,$2177$2181){var ph$2187;var msg$2188;var t0$2190;(t0$2190=$2177$2181);(msg$2188=t0$2190);(ph$2187=t0$2190);var $2183$2199;($2183$2199=ph$2187);var bridge$2185$2204;(bridge$2185$2204=$2183$2199);if(((typeof(bridge$2185$2204)==="string")||(typeof(bridge$2185$2204)==="number"))){return obj$2180[msg$2188];}else{var other$2216;(other$2216=$2183$2199);return obj$2180["::send"](msg$2188);}});(Array[":::project"]=function($2222$2225){var ph$2230;var value$2231;var t0$2233;(t0$2233=$2222$2225);(value$2231=t0$2233);(ph$2230=t0$2233);var $2227$2242;($2227$2242=ph$2230);if($2399(Array)($2227$2242)){return [true,value$2231];}else{$2227$2242;return [true,[value$2231]];}});(Array.prototype["::check"]=function(value$2260){if((value$2260 instanceof Array)){var i$2266;(i$2266=0);$2263:for(;(i$2266<this.length);(i$2266++)){if(($2418(this,i$2266)!==$2418(value$2260,i$2266))){return false;}}return true;}else{return false;}});(Array.prototype["::clone"]=function(){return $2419(this.slice(0),this);});(Array.prototype[":::project"]=function(value$2285){if((value$2285 instanceof Array)){var i$2291;(i$2291=0);$2288:for(;(i$2291<this.length);(i$2291++)){if(($2418(this,i$2291)!==$2418(value$2285,i$2291))){return [true,[value$2285]];}}return [true,value$2285.slice(this.length)];}else{return [true,[value$2285]];}});(Array.prototype["::serialize_ast"]=function(){return ["array"].concat(this.map($2436));});(RegExp.prototype["::check"]=function($2309$2312){var ph$2317;(ph$2317=$2309$2312);var $2314$2323;($2314$2323=ph$2317);var value$2331;if((typeof($2314$2323)==="string")){(value$2331=$2314$2323);if(value$2331.match(this)){return true;}else{return false;}}else{var other$2336;(other$2336=$2314$2323);return false;}});(RegExp.prototype[":::project"]=function($2342$2345){var ph$2350;(ph$2350=$2342$2345);var $2347$2356;($2347$2356=ph$2350);var value$2364;if((typeof($2347$2356)==="string")){(value$2364=$2347$2356);var $2367$2372;($2367$2372=value$2364.match(this));var m$2380;if(($2367$2372===null)){(m$2380=$2367$2372);return [false,null];}else{var m$2385;(m$2385=$2367$2372);return [true,m$2385];}}else{var other$2389;(other$2389=$2347$2356);return [false,null];}});(Function.prototype["::send"]=function(args$2396){return this.apply(this,args$2396);});
var $3163=function(arr$3166){var results$3172;var l$3173;(results$3172=[]);(l$3173=arr$3166.length);var i$3182;(i$3182=0);$3171:for(;(i$3182<l$3173);(i$3182++)){results$3172.push([i$3182,$2418(arr$3166,i$3182)]);}return results$3172;};
var $2930=function(){var $2931$2937;($2931$2937=function(tags$2942){var it$0$2945;(it$0$2945=function(){if((!$2399($2931$2937)(this))){return Object.create($2931$2937.prototype);}else{return this;}}());(it$0$2945["tags"]=tags$2942);return it$0$2945;});($2931$2937.prototype["create"]=function(){var it$0$2965;var self$2966;(it$0$2965=this);(self$2966=this);var $2963$2975;($2963$2975=arguments);var t0$2980;var message$2984;var args$2985;(t0$2980=$2963$2975.length);if((t0$2980>=0)){(message$2984=function(){if((0>=t0$2980)){return "";}else{return $2963$2975[0];}}());(args$2985=Array.prototype.slice.call($2963$2975,1));var e$2998;(e$2998=Error(message$2984));(e$2998["::tags"]=it$0$2965.tags);(e$2998["args"]=args$2985);var temp$3014;(temp$3014=$3163(args$2985));var $length$3020;($length$3020=temp$3014.length);var $index$3026;($index$3026=0);$2999:for(;($index$3026<$length$3020);($index$3026++)){var m$3035;(m$3035=temp$3014[$index$3026]);var t0$3040;var t1$3041;var i$3045;var arg$3046;(t0$3040=m$3035);if(((t0$3040 instanceof Array)&&(((t1$3041=t0$3040.length)),(t1$3041===2)))){(i$3045=t0$3040[0]);(arg$3046=t0$3040[1]);(e$2998[i$3045]=arg$3046);}else{$2911(m$3035);}}(e$2998["length"]=args$2985.length);(e$2998["name"]=["E"].concat(it$0$2965.tags).join("."));return e$2998;}else{$2911($2963$2975);}});($2931$2937.prototype["::check"]=function(e$3076){var it$0$3080;var self$3081;(it$0$3080=this);(self$3081=this);var tags$3091;if(((!e$3076)||(!$2399(Error)(e$3076)))){return false;}(tags$3091=(e$3076["::tags"]||[]));var temp$3102;(temp$3102=it$0$3080.tags);var $length$3108;($length$3108=temp$3102.length);var $index$3114;($index$3114=0);$3092:for(;($index$3114<$length$3108);($index$3114++)){var m$3123;(m$3123=temp$3102[$index$3114]);var tag$3131;(tag$3131=m$3123);if((tags$3091.indexOf(tag$3131)===-1)){return false;}else{false;}}return true;});($2931$2937.prototype["::deconstruct"]=function(e$3140){var it$0$3144;var self$3145;(it$0$3144=this);(self$3145=this);return e$3140.args;});$2419($2931$2937,$2419(function(){var accum$3156;(accum$3156=({}));(accum$3156["::name"]="$2931");return accum$3156;}(),function(){var accum$3160;(accum$3160=({}));(accum$3160["::egclass"]=true);return accum$3160;}()));return $2931$2937;}();
var $2911=function(value$2914,url$2915,start$2916,end$2917){var err$2921;(err$2921=$2930(["match"]).create("Could not find a match for value",({"value":value$2914})));if(url$2915){(err$2921["location"]=["location",url$2915,start$2916,end$2917]);}throw err$2921;};
var $3361=Object.keys;
var $3362=function($3364$3367,key$3368){var ph$3376;(ph$3376=$3364$3367);var $3370$3382;($3370$3382=ph$3376);var bridge$3372$3387;(bridge$3372$3387=$3370$3382);if(((bridge$3372$3387===null)||(bridge$3372$3387===(void 0)))){return false;}else{var x$3399;if((typeof($3370$3382)==="string")){(x$3399=$3370$3382);return (key$3368 in String.prototype);}else{var x$3404;if((typeof($3370$3382)==="number")){(x$3404=$3370$3382);return (key$3368 in Number.prototype);}else{var x$3409;(x$3409=$3370$3382);return (key$3368 in x$3409);}}}};
var $3189=function($3191$3194,b$3195){var ph$3209;var a$3210;var t0$3212;(t0$3212=$3191$3194);(a$3210=t0$3212);(ph$3209=t0$3212);var $3197$3221;($3197$3221=ph$3209);var bridge$3200$3226;if(($3197$3221===b$3195)){return true;}else{(bridge$3200$3226=$3197$3221);if((function(){var bridge$3201$3240;(bridge$3201$3240=bridge$3200$3226);return (function(){var bridge$3202$3247;(bridge$3202$3247=bridge$3201$3240);return (function(){var bridge$3203$3254;(bridge$3203$3254=bridge$3202$3247);return (function(){var bridge$3204$3261;(bridge$3204$3261=bridge$3203$3254);return ((typeof(bridge$3204$3261)==="number")||(typeof(bridge$3204$3261)==="string"));}()||(bridge$3203$3254===null));}()||(bridge$3202$3247===(void 0)));}()||(bridge$3201$3240===true));}()||(bridge$3200$3226===false))){return false;}else{if($2399(Array)($3197$3221)){if(((!$2399(Array)(b$3195))||(a$3210.length!==b$3195.length))){return false;}var i$3277;(i$3277=0);$3273:for(;(i$3277<a$3210.length);(i$3277++)){if((!$3189(a$3210[i$3277],b$3195[i$3277]))){return false;}}return true;}else{$3197$3221;if((((Object.getPrototypeOf(a$3210)===Object.prototype)&&$2399(Object)(b$3195))&&(Object.getPrototypeOf(b$3195)===Object.prototype))){var ka$3291;(ka$3291=$3361(a$3210));if((!$3189(ka$3291.sort(),$3361(b$3195).sort()))){return false;}var temp$3302;(temp$3302=ka$3291);var $length$3308;($length$3308=temp$3302.length);var $index$3314;($index$3314=0);$3292:for(;($index$3314<$length$3308);($index$3314++)){var m$3323;(m$3323=temp$3302[$index$3314]);var k$3331;(k$3331=m$3323);if((!$3189(a$3210[k$3331],b$3195[k$3331]))){return false;}}return true;}else{if($3362($3197$3221,"::serialize")){$3197$3221["::serialize"];var $3338$3343;($3338$3343=b$3195);if($3362($3338$3343,"::serialize")){$3338$3343["::serialize"];return $3189(a$3210["::serialize"](),b$3195["::serialize"]());}else{var otherwise$3355;(otherwise$3355=$3338$3343);return false;}}else{var otherwise$3359;(otherwise$3359=$3197$3221);return false;}}}}}};var CodeMirror$2478;(CodeMirror$2478=require("codemirror"));CodeMirror$2478.defineMode("earl-grey",function(config$2484,parserConfig$2485){var accum$2498;var accum$2505;var accum$2801;var accum$2865;var re$2489;(re$2489=({"id":RegExp("(?:^[a-zA-Z$_](?:[a-zA-Z$_0-9]*))",""),"numr":RegExp("(?:^((?:\\d+))[rR]((?:[A-Za-z0-9_]+))(?:(?:\\.((?:[A-Za-z0-9_]+)))?))",""),"num":RegExp("(?:^((?:[0-9_]+))(?:(?:\\.((?:\\d+)))?)(?:(?:[eE]((?:[+-]?)(?:[0-9_]+)))?))",""),"lowprio":RegExp("(?:(?:(?:(?:(?:(?:(?:(?:=|=>)|->)|%)|:)|with)|where)|each)(?:(?: +)|$))",""),"op":RegExp("(?:^(?:[+\\-*/~\\^<>=%&|?!@#.:']+))",""),"op2_open":RegExp("(?:^[\\[\\{])",""),"comma":RegExp("(?:^,)",""),"op2_close":RegExp("(?:^[\\}\\]])",""),"op3":RegExp("(?:^(?:(?:(?:(?:(?:(?:(?:(?:(?:with|where)|when)|and)|not)|or)|in)|mod)|each)|as)(?:(?:[+\\-*/~\\^<>=%&|?!@#.:']+)|\\b))",""),"op4":RegExp("(?:^`((?:[A-Za-z0-9_$]+))`)","")}));return $2419(((accum$2498=({})),((accum$2498["startState"]=function(){return ({"mode":"code","previous":null,"sol":true,"nest":[[0,0,false]]});}),accum$2498)),$2419(((accum$2505=({})),((accum$2505["token"]=function(stream$2510,state$2511){var a$2540;var t0$2536;var $2519$2531;var index$2522;var $2585$2659;var $2581$2654;var n$2732;var n$2738;var $2579$2647;var $2594$2603;var $2572$2597;var $2770$2775;var $2557$2562;var result$2515;if(stream$2510.sol()){(state$2511["sol"]=true);(index$2522=(state$2511.nest.length-1));($2519$2531=$2418(state$2511.nest,index$2522));if((($2519$2531 instanceof Array)&&(((t0$2536=$2519$2531.length)),(t0$2536===3)))){(a$2540=$2519$2531[0]);$2519$2531[1];$2519$2531[2];(state$2511.nest[index$2522]=[a$2540,stream$2510.indentation(),false]);}else{$2519$2531;undefined;}}(result$2515=((($2557$2562=state$2511.mode)),function(){if(($2557$2562==="code")){($2572$2597=stream$2510.peek());if(($2572$2597==="\"")){stream$2510.next();(state$2511["mode"]="string");return "string";}else{if(($2572$2597===";")){stream$2510.skipToEnd();return "comment";}else{$2572$2597;if(stream$2510.match(RegExp("\\.[A-Za-z0-9$]+",""))){(state$2511["previous"]="id");return "string";}else{if(stream$2510.match(RegExp("@[A-Za-z0-9$]+",""))){(state$2511["previous"]="id");return "attribute";}else{if(stream$2510.match(RegExp("pass|return|break|continue|match",""))){(state$2511["previous"]="id");return "keyword";}else{($2579$2647=$2572$2597);if(stream$2510.match(re$2489.id)){($2581$2654=$2579$2647);if(($2399(RegExp("lowprio|comma",""))(state$2511.previous)||state$2511.sol)){$2581$2654;if(stream$2510.match(RegExp(" *:| +[A-Za-z0-9$\\[\\{\"]",""),false)){(state$2511["previous"]="id");return "keyword";}else{if(stream$2510.match(RegExp(" +[+\\-*/~^<>=%&|?!@#.:']+[A-Za-z0-9$\\[\\{]",""),false)){(state$2511["previous"]="id");return "keyword";}else{(state$2511["previous"]="id");return "variable";}}}else{$2579$2647;(state$2511["previous"]="id");return "variable";}}else{$2572$2597;if((stream$2510.match(re$2489.numr)||stream$2510.match(re$2489.num))){(state$2511["previous"]="id");return "number";}else{if(stream$2510.match(re$2489.lowprio)){(state$2511["previous"]="lowprio");return "operator";}else{if(((stream$2510.match(re$2489.op)||stream$2510.match(re$2489["op3"]))||stream$2510.match(re$2489["op4"]))){(state$2511["previous"]="op");return "operator";}else{if(stream$2510.match(re$2489["op2_open"])){(state$2511["previous"]="lowprio");state$2511.nest.push(function(){if(stream$2510.eol()){(n$2732=$2418(state$2511.nest,(state$2511.nest.length-1))[1]);return [n$2732,(n$2732+config$2484.indentUnit),true];}else{(n$2738=stream$2510.column());return [n$2738,(n$2738+1),true];}}());return "punctuation";}else{if(stream$2510.match(re$2489.comma)){(state$2511["previous"]="comma");return "punctuation";}else{if(stream$2510.match(re$2489["op2_close"])){(state$2511["previous"]="punct");if((state$2511.nest.length>1)){state$2511.nest.pop();}return "punctuation";}else{stream$2510.next();return null;}}}}}}}}}}}}}else{if(($2557$2562==="string")){stream$2510.match(RegExp("(\\\\\"|[^\"])+",""));($2770$2775=stream$2510.eat(RegExp("\"","")));if(($2770$2775===(void 0))){return "string";}else{$2770$2775;(state$2511["mode"]="code");(state$2511["previous"]="id");return "string";}}else{$2911($2557$2562);}}}()));return result$2515;}),accum$2505)),$2419(((accum$2801=({})),((accum$2801["indent"]=function(state$2806,line$2807){var index$2828;var index$2842;var t0$2820;var t1$2821;var $2812$2851;var outer$2815;var inner$2816;var first$2817;var add$2818;(t0$2820=(((index$2828=(state$2806.nest.length-1))),$2418(state$2806.nest,index$2828)));if(((t0$2820 instanceof Array)&&(((t1$2821=t0$2820.length)),(t1$2821===3)))){(outer$2815=t0$2820[0]);(inner$2816=t0$2820[1]);(first$2817=t0$2820[2]);}else{$2911((((index$2842=(state$2806.nest.length-1))),$2418(state$2806.nest,index$2842)),"/home/olivier/git/egrepl/src/earlmode.eg",4958,5034);}(add$2818=function(){if(((!first$2817)&&($3189(state$2806.previous,"lowprio")||$3189(state$2806.previous,"op")))){return config$2484.indentUnit;}else{return 0;}}());($2812$2851=line$2807);if($2399(RegExp("(?:^[\\]\\}])",""))($2812$2851)){return (outer$2815+add$2818);}else{$2812$2851;return (inner$2816+add$2818);}}),accum$2801)),$2419(((accum$2865=({})),((accum$2865["blankLine"]=function(state$2870){var a$2896;var t0$2892;var $2875$2887;var index$2878;(state$2870["sol"]=true);(index$2878=(state$2870.nest.length-1));($2875$2887=$2418(state$2870.nest,index$2878));if((($2875$2887 instanceof Array)&&(((t0$2892=$2875$2887.length)),(t0$2892===3)))){(a$2896=$2875$2887[0]);$2875$2887[1];$2875$2887[2];(state$2870.nest[index$2878]=[a$2896,0,false]);}else{$2875$2887;return undefined;}}),accum$2865)),({"lineComment":";;","electricInput":RegExp("(?:^(?: *)[\\]\\}]$)","")})))));});

},{"codemirror":7}],2:[function(require,module,exports){
// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

// TODO actually recognize syntax of TypeScript constructs

(function(mod) {
  if (typeof exports == "object" && typeof module == "object") // CommonJS
    mod(require("codemirror"));
  else if (typeof define == "function" && define.amd) // AMD
    define(["codemirror"], mod);
  else // Plain browser env
    mod(CodeMirror);
})(function(CodeMirror) {
"use strict";

CodeMirror.defineMode("javascript", function(config, parserConfig) {
  var indentUnit = config.indentUnit;
  var statementIndent = parserConfig.statementIndent;
  var jsonldMode = parserConfig.jsonld;
  var jsonMode = parserConfig.json || jsonldMode;
  var isTS = parserConfig.typescript;

  // Tokenizer

  var keywords = function(){
    function kw(type) {return {type: type, style: "keyword"};}
    var A = kw("keyword a"), B = kw("keyword b"), C = kw("keyword c");
    var operator = kw("operator"), atom = {type: "atom", style: "atom"};

    var jsKeywords = {
      "if": kw("if"), "while": A, "with": A, "else": B, "do": B, "try": B, "finally": B,
      "return": C, "break": C, "continue": C, "new": C, "delete": C, "throw": C, "debugger": C,
      "var": kw("var"), "const": kw("var"), "let": kw("var"),
      "function": kw("function"), "catch": kw("catch"),
      "for": kw("for"), "switch": kw("switch"), "case": kw("case"), "default": kw("default"),
      "in": operator, "typeof": operator, "instanceof": operator,
      "true": atom, "false": atom, "null": atom, "undefined": atom, "NaN": atom, "Infinity": atom,
      "this": kw("this"), "module": kw("module"), "class": kw("class"), "super": kw("atom"),
      "yield": C, "export": kw("export"), "import": kw("import"), "extends": C
    };

    // Extend the 'normal' keywords with the TypeScript language extensions
    if (isTS) {
      var type = {type: "variable", style: "variable-3"};
      var tsKeywords = {
        // object-like things
        "interface": kw("interface"),
        "extends": kw("extends"),
        "constructor": kw("constructor"),

        // scope modifiers
        "public": kw("public"),
        "private": kw("private"),
        "protected": kw("protected"),
        "static": kw("static"),

        // types
        "string": type, "number": type, "bool": type, "any": type
      };

      for (var attr in tsKeywords) {
        jsKeywords[attr] = tsKeywords[attr];
      }
    }

    return jsKeywords;
  }();

  var isOperatorChar = /[+\-*&%=<>!?|~^]/;
  var isJsonldKeyword = /^@(context|id|value|language|type|container|list|set|reverse|index|base|vocab|graph)"/;

  function readRegexp(stream) {
    var escaped = false, next, inSet = false;
    while ((next = stream.next()) != null) {
      if (!escaped) {
        if (next == "/" && !inSet) return;
        if (next == "[") inSet = true;
        else if (inSet && next == "]") inSet = false;
      }
      escaped = !escaped && next == "\\";
    }
  }

  // Used as scratch variables to communicate multiple values without
  // consing up tons of objects.
  var type, content;
  function ret(tp, style, cont) {
    type = tp; content = cont;
    return style;
  }
  function tokenBase(stream, state) {
    var ch = stream.next();
    if (ch == '"' || ch == "'") {
      state.tokenize = tokenString(ch);
      return state.tokenize(stream, state);
    } else if (ch == "." && stream.match(/^\d+(?:[eE][+\-]?\d+)?/)) {
      return ret("number", "number");
    } else if (ch == "." && stream.match("..")) {
      return ret("spread", "meta");
    } else if (/[\[\]{}\(\),;\:\.]/.test(ch)) {
      return ret(ch);
    } else if (ch == "=" && stream.eat(">")) {
      return ret("=>", "operator");
    } else if (ch == "0" && stream.eat(/x/i)) {
      stream.eatWhile(/[\da-f]/i);
      return ret("number", "number");
    } else if (/\d/.test(ch)) {
      stream.match(/^\d*(?:\.\d*)?(?:[eE][+\-]?\d+)?/);
      return ret("number", "number");
    } else if (ch == "/") {
      if (stream.eat("*")) {
        state.tokenize = tokenComment;
        return tokenComment(stream, state);
      } else if (stream.eat("/")) {
        stream.skipToEnd();
        return ret("comment", "comment");
      } else if (state.lastType == "operator" || state.lastType == "keyword c" ||
               state.lastType == "sof" || /^[\[{}\(,;:]$/.test(state.lastType)) {
        readRegexp(stream);
        stream.eatWhile(/[gimy]/); // 'y' is "sticky" option in Mozilla
        return ret("regexp", "string-2");
      } else {
        stream.eatWhile(isOperatorChar);
        return ret("operator", "operator", stream.current());
      }
    } else if (ch == "`") {
      state.tokenize = tokenQuasi;
      return tokenQuasi(stream, state);
    } else if (ch == "#") {
      stream.skipToEnd();
      return ret("error", "error");
    } else if (isOperatorChar.test(ch)) {
      stream.eatWhile(isOperatorChar);
      return ret("operator", "operator", stream.current());
    } else {
      stream.eatWhile(/[\w\$_]/);
      var word = stream.current(), known = keywords.propertyIsEnumerable(word) && keywords[word];
      return (known && state.lastType != ".") ? ret(known.type, known.style, word) :
                     ret("variable", "variable", word);
    }
  }

  function tokenString(quote) {
    return function(stream, state) {
      var escaped = false, next;
      if (jsonldMode && stream.peek() == "@" && stream.match(isJsonldKeyword)){
        state.tokenize = tokenBase;
        return ret("jsonld-keyword", "meta");
      }
      while ((next = stream.next()) != null) {
        if (next == quote && !escaped) break;
        escaped = !escaped && next == "\\";
      }
      if (!escaped) state.tokenize = tokenBase;
      return ret("string", "string");
    };
  }

  function tokenComment(stream, state) {
    var maybeEnd = false, ch;
    while (ch = stream.next()) {
      if (ch == "/" && maybeEnd) {
        state.tokenize = tokenBase;
        break;
      }
      maybeEnd = (ch == "*");
    }
    return ret("comment", "comment");
  }

  function tokenQuasi(stream, state) {
    var escaped = false, next;
    while ((next = stream.next()) != null) {
      if (!escaped && (next == "`" || next == "$" && stream.eat("{"))) {
        state.tokenize = tokenBase;
        break;
      }
      escaped = !escaped && next == "\\";
    }
    return ret("quasi", "string-2", stream.current());
  }

  var brackets = "([{}])";
  // This is a crude lookahead trick to try and notice that we're
  // parsing the argument patterns for a fat-arrow function before we
  // actually hit the arrow token. It only works if the arrow is on
  // the same line as the arguments and there's no strange noise
  // (comments) in between. Fallback is to only notice when we hit the
  // arrow, and not declare the arguments as locals for the arrow
  // body.
  function findFatArrow(stream, state) {
    if (state.fatArrowAt) state.fatArrowAt = null;
    var arrow = stream.string.indexOf("=>", stream.start);
    if (arrow < 0) return;

    var depth = 0, sawSomething = false;
    for (var pos = arrow - 1; pos >= 0; --pos) {
      var ch = stream.string.charAt(pos);
      var bracket = brackets.indexOf(ch);
      if (bracket >= 0 && bracket < 3) {
        if (!depth) { ++pos; break; }
        if (--depth == 0) break;
      } else if (bracket >= 3 && bracket < 6) {
        ++depth;
      } else if (/[$\w]/.test(ch)) {
        sawSomething = true;
      } else if (sawSomething && !depth) {
        ++pos;
        break;
      }
    }
    if (sawSomething && !depth) state.fatArrowAt = pos;
  }

  // Parser

  var atomicTypes = {"atom": true, "number": true, "variable": true, "string": true, "regexp": true, "this": true, "jsonld-keyword": true};

  function JSLexical(indented, column, type, align, prev, info) {
    this.indented = indented;
    this.column = column;
    this.type = type;
    this.prev = prev;
    this.info = info;
    if (align != null) this.align = align;
  }

  function inScope(state, varname) {
    for (var v = state.localVars; v; v = v.next)
      if (v.name == varname) return true;
    for (var cx = state.context; cx; cx = cx.prev) {
      for (var v = cx.vars; v; v = v.next)
        if (v.name == varname) return true;
    }
  }

  function parseJS(state, style, type, content, stream) {
    var cc = state.cc;
    // Communicate our context to the combinators.
    // (Less wasteful than consing up a hundred closures on every call.)
    cx.state = state; cx.stream = stream; cx.marked = null, cx.cc = cc; cx.style = style;

    if (!state.lexical.hasOwnProperty("align"))
      state.lexical.align = true;

    while(true) {
      var combinator = cc.length ? cc.pop() : jsonMode ? expression : statement;
      if (combinator(type, content)) {
        while(cc.length && cc[cc.length - 1].lex)
          cc.pop()();
        if (cx.marked) return cx.marked;
        if (type == "variable" && inScope(state, content)) return "variable-2";
        return style;
      }
    }
  }

  // Combinator utils

  var cx = {state: null, column: null, marked: null, cc: null};
  function pass() {
    for (var i = arguments.length - 1; i >= 0; i--) cx.cc.push(arguments[i]);
  }
  function cont() {
    pass.apply(null, arguments);
    return true;
  }
  function register(varname) {
    function inList(list) {
      for (var v = list; v; v = v.next)
        if (v.name == varname) return true;
      return false;
    }
    var state = cx.state;
    if (state.context) {
      cx.marked = "def";
      if (inList(state.localVars)) return;
      state.localVars = {name: varname, next: state.localVars};
    } else {
      if (inList(state.globalVars)) return;
      if (parserConfig.globalVars)
        state.globalVars = {name: varname, next: state.globalVars};
    }
  }

  // Combinators

  var defaultVars = {name: "this", next: {name: "arguments"}};
  function pushcontext() {
    cx.state.context = {prev: cx.state.context, vars: cx.state.localVars};
    cx.state.localVars = defaultVars;
  }
  function popcontext() {
    cx.state.localVars = cx.state.context.vars;
    cx.state.context = cx.state.context.prev;
  }
  function pushlex(type, info) {
    var result = function() {
      var state = cx.state, indent = state.indented;
      if (state.lexical.type == "stat") indent = state.lexical.indented;
      state.lexical = new JSLexical(indent, cx.stream.column(), type, null, state.lexical, info);
    };
    result.lex = true;
    return result;
  }
  function poplex() {
    var state = cx.state;
    if (state.lexical.prev) {
      if (state.lexical.type == ")")
        state.indented = state.lexical.indented;
      state.lexical = state.lexical.prev;
    }
  }
  poplex.lex = true;

  function expect(wanted) {
    function exp(type) {
      if (type == wanted) return cont();
      else if (wanted == ";") return pass();
      else return cont(exp);
    };
    return exp;
  }

  function statement(type, value) {
    if (type == "var") return cont(pushlex("vardef", value.length), vardef, expect(";"), poplex);
    if (type == "keyword a") return cont(pushlex("form"), expression, statement, poplex);
    if (type == "keyword b") return cont(pushlex("form"), statement, poplex);
    if (type == "{") return cont(pushlex("}"), block, poplex);
    if (type == ";") return cont();
    if (type == "if") {
      if (cx.state.lexical.info == "else" && cx.state.cc[cx.state.cc.length - 1] == poplex)
        cx.state.cc.pop()();
      return cont(pushlex("form"), expression, statement, poplex, maybeelse);
    }
    if (type == "function") return cont(functiondef);
    if (type == "for") return cont(pushlex("form"), forspec, statement, poplex);
    if (type == "variable") return cont(pushlex("stat"), maybelabel);
    if (type == "switch") return cont(pushlex("form"), expression, pushlex("}", "switch"), expect("{"),
                                      block, poplex, poplex);
    if (type == "case") return cont(expression, expect(":"));
    if (type == "default") return cont(expect(":"));
    if (type == "catch") return cont(pushlex("form"), pushcontext, expect("("), funarg, expect(")"),
                                     statement, poplex, popcontext);
    if (type == "module") return cont(pushlex("form"), pushcontext, afterModule, popcontext, poplex);
    if (type == "class") return cont(pushlex("form"), className, poplex);
    if (type == "export") return cont(pushlex("form"), afterExport, poplex);
    if (type == "import") return cont(pushlex("form"), afterImport, poplex);
    return pass(pushlex("stat"), expression, expect(";"), poplex);
  }
  function expression(type) {
    return expressionInner(type, false);
  }
  function expressionNoComma(type) {
    return expressionInner(type, true);
  }
  function expressionInner(type, noComma) {
    if (cx.state.fatArrowAt == cx.stream.start) {
      var body = noComma ? arrowBodyNoComma : arrowBody;
      if (type == "(") return cont(pushcontext, pushlex(")"), commasep(pattern, ")"), poplex, expect("=>"), body, popcontext);
      else if (type == "variable") return pass(pushcontext, pattern, expect("=>"), body, popcontext);
    }

    var maybeop = noComma ? maybeoperatorNoComma : maybeoperatorComma;
    if (atomicTypes.hasOwnProperty(type)) return cont(maybeop);
    if (type == "function") return cont(functiondef, maybeop);
    if (type == "keyword c") return cont(noComma ? maybeexpressionNoComma : maybeexpression);
    if (type == "(") return cont(pushlex(")"), maybeexpression, comprehension, expect(")"), poplex, maybeop);
    if (type == "operator" || type == "spread") return cont(noComma ? expressionNoComma : expression);
    if (type == "[") return cont(pushlex("]"), arrayLiteral, poplex, maybeop);
    if (type == "{") return contCommasep(objprop, "}", null, maybeop);
    if (type == "quasi") { return pass(quasi, maybeop); }
    return cont();
  }
  function maybeexpression(type) {
    if (type.match(/[;\}\)\],]/)) return pass();
    return pass(expression);
  }
  function maybeexpressionNoComma(type) {
    if (type.match(/[;\}\)\],]/)) return pass();
    return pass(expressionNoComma);
  }

  function maybeoperatorComma(type, value) {
    if (type == ",") return cont(expression);
    return maybeoperatorNoComma(type, value, false);
  }
  function maybeoperatorNoComma(type, value, noComma) {
    var me = noComma == false ? maybeoperatorComma : maybeoperatorNoComma;
    var expr = noComma == false ? expression : expressionNoComma;
    if (value == "=>") return cont(pushcontext, noComma ? arrowBodyNoComma : arrowBody, popcontext);
    if (type == "operator") {
      if (/\+\+|--/.test(value)) return cont(me);
      if (value == "?") return cont(expression, expect(":"), expr);
      return cont(expr);
    }
    if (type == "quasi") { return pass(quasi, me); }
    if (type == ";") return;
    if (type == "(") return contCommasep(expressionNoComma, ")", "call", me);
    if (type == ".") return cont(property, me);
    if (type == "[") return cont(pushlex("]"), maybeexpression, expect("]"), poplex, me);
  }
  function quasi(type, value) {
    if (type != "quasi") return pass();
    if (value.slice(value.length - 2) != "${") return cont(quasi);
    return cont(expression, continueQuasi);
  }
  function continueQuasi(type) {
    if (type == "}") {
      cx.marked = "string-2";
      cx.state.tokenize = tokenQuasi;
      return cont(quasi);
    }
  }
  function arrowBody(type) {
    findFatArrow(cx.stream, cx.state);
    if (type == "{") return pass(statement);
    return pass(expression);
  }
  function arrowBodyNoComma(type) {
    findFatArrow(cx.stream, cx.state);
    if (type == "{") return pass(statement);
    return pass(expressionNoComma);
  }
  function maybelabel(type) {
    if (type == ":") return cont(poplex, statement);
    return pass(maybeoperatorComma, expect(";"), poplex);
  }
  function property(type) {
    if (type == "variable") {cx.marked = "property"; return cont();}
  }
  function objprop(type, value) {
    if (type == "variable" || cx.style == "keyword") {
      cx.marked = "property";
      if (value == "get" || value == "set") return cont(getterSetter);
      return cont(afterprop);
    } else if (type == "number" || type == "string") {
      cx.marked = jsonldMode ? "property" : (cx.style + " property");
      return cont(afterprop);
    } else if (type == "jsonld-keyword") {
      return cont(afterprop);
    } else if (type == "[") {
      return cont(expression, expect("]"), afterprop);
    }
  }
  function getterSetter(type) {
    if (type != "variable") return pass(afterprop);
    cx.marked = "property";
    return cont(functiondef);
  }
  function afterprop(type) {
    if (type == ":") return cont(expressionNoComma);
    if (type == "(") return pass(functiondef);
  }
  function commasep(what, end) {
    function proceed(type) {
      if (type == ",") {
        var lex = cx.state.lexical;
        if (lex.info == "call") lex.pos = (lex.pos || 0) + 1;
        return cont(what, proceed);
      }
      if (type == end) return cont();
      return cont(expect(end));
    }
    return function(type) {
      if (type == end) return cont();
      return pass(what, proceed);
    };
  }
  function contCommasep(what, end, info) {
    for (var i = 3; i < arguments.length; i++)
      cx.cc.push(arguments[i]);
    return cont(pushlex(end, info), commasep(what, end), poplex);
  }
  function block(type) {
    if (type == "}") return cont();
    return pass(statement, block);
  }
  function maybetype(type) {
    if (isTS && type == ":") return cont(typedef);
  }
  function typedef(type) {
    if (type == "variable"){cx.marked = "variable-3"; return cont();}
  }
  function vardef() {
    return pass(pattern, maybetype, maybeAssign, vardefCont);
  }
  function pattern(type, value) {
    if (type == "variable") { register(value); return cont(); }
    if (type == "[") return contCommasep(pattern, "]");
    if (type == "{") return contCommasep(proppattern, "}");
  }
  function proppattern(type, value) {
    if (type == "variable" && !cx.stream.match(/^\s*:/, false)) {
      register(value);
      return cont(maybeAssign);
    }
    if (type == "variable") cx.marked = "property";
    return cont(expect(":"), pattern, maybeAssign);
  }
  function maybeAssign(_type, value) {
    if (value == "=") return cont(expressionNoComma);
  }
  function vardefCont(type) {
    if (type == ",") return cont(vardef);
  }
  function maybeelse(type, value) {
    if (type == "keyword b" && value == "else") return cont(pushlex("form", "else"), statement, poplex);
  }
  function forspec(type) {
    if (type == "(") return cont(pushlex(")"), forspec1, expect(")"), poplex);
  }
  function forspec1(type) {
    if (type == "var") return cont(vardef, expect(";"), forspec2);
    if (type == ";") return cont(forspec2);
    if (type == "variable") return cont(formaybeinof);
    return pass(expression, expect(";"), forspec2);
  }
  function formaybeinof(_type, value) {
    if (value == "in" || value == "of") { cx.marked = "keyword"; return cont(expression); }
    return cont(maybeoperatorComma, forspec2);
  }
  function forspec2(type, value) {
    if (type == ";") return cont(forspec3);
    if (value == "in" || value == "of") { cx.marked = "keyword"; return cont(expression); }
    return pass(expression, expect(";"), forspec3);
  }
  function forspec3(type) {
    if (type != ")") cont(expression);
  }
  function functiondef(type, value) {
    if (value == "*") {cx.marked = "keyword"; return cont(functiondef);}
    if (type == "variable") {register(value); return cont(functiondef);}
    if (type == "(") return cont(pushcontext, pushlex(")"), commasep(funarg, ")"), poplex, statement, popcontext);
  }
  function funarg(type) {
    if (type == "spread") return cont(funarg);
    return pass(pattern, maybetype);
  }
  function className(type, value) {
    if (type == "variable") {register(value); return cont(classNameAfter);}
  }
  function classNameAfter(type, value) {
    if (value == "extends") return cont(expression, classNameAfter);
    if (type == "{") return cont(pushlex("}"), classBody, poplex);
  }
  function classBody(type, value) {
    if (type == "variable" || cx.style == "keyword") {
      cx.marked = "property";
      if (value == "get" || value == "set") return cont(classGetterSetter, functiondef, classBody);
      return cont(functiondef, classBody);
    }
    if (value == "*") {
      cx.marked = "keyword";
      return cont(classBody);
    }
    if (type == ";") return cont(classBody);
    if (type == "}") return cont();
  }
  function classGetterSetter(type) {
    if (type != "variable") return pass();
    cx.marked = "property";
    return cont();
  }
  function afterModule(type, value) {
    if (type == "string") return cont(statement);
    if (type == "variable") { register(value); return cont(maybeFrom); }
  }
  function afterExport(_type, value) {
    if (value == "*") { cx.marked = "keyword"; return cont(maybeFrom, expect(";")); }
    if (value == "default") { cx.marked = "keyword"; return cont(expression, expect(";")); }
    return pass(statement);
  }
  function afterImport(type) {
    if (type == "string") return cont();
    return pass(importSpec, maybeFrom);
  }
  function importSpec(type, value) {
    if (type == "{") return contCommasep(importSpec, "}");
    if (type == "variable") register(value);
    return cont();
  }
  function maybeFrom(_type, value) {
    if (value == "from") { cx.marked = "keyword"; return cont(expression); }
  }
  function arrayLiteral(type) {
    if (type == "]") return cont();
    return pass(expressionNoComma, maybeArrayComprehension);
  }
  function maybeArrayComprehension(type) {
    if (type == "for") return pass(comprehension, expect("]"));
    if (type == ",") return cont(commasep(expressionNoComma, "]"));
    return pass(commasep(expressionNoComma, "]"));
  }
  function comprehension(type) {
    if (type == "for") return cont(forspec, comprehension);
    if (type == "if") return cont(expression, comprehension);
  }

  // Interface

  return {
    startState: function(basecolumn) {
      var state = {
        tokenize: tokenBase,
        lastType: "sof",
        cc: [],
        lexical: new JSLexical((basecolumn || 0) - indentUnit, 0, "block", false),
        localVars: parserConfig.localVars,
        context: parserConfig.localVars && {vars: parserConfig.localVars},
        indented: 0
      };
      if (parserConfig.globalVars && typeof parserConfig.globalVars == "object")
        state.globalVars = parserConfig.globalVars;
      return state;
    },

    token: function(stream, state) {
      if (stream.sol()) {
        if (!state.lexical.hasOwnProperty("align"))
          state.lexical.align = false;
        state.indented = stream.indentation();
        findFatArrow(stream, state);
      }
      if (state.tokenize != tokenComment && stream.eatSpace()) return null;
      var style = state.tokenize(stream, state);
      if (type == "comment") return style;
      state.lastType = type == "operator" && (content == "++" || content == "--") ? "incdec" : type;
      return parseJS(state, style, type, content, stream);
    },

    indent: function(state, textAfter) {
      if (state.tokenize == tokenComment) return CodeMirror.Pass;
      if (state.tokenize != tokenBase) return 0;
      var firstChar = textAfter && textAfter.charAt(0), lexical = state.lexical;
      // Kludge to prevent 'maybelse' from blocking lexical scope pops
      if (!/^\s*else\b/.test(textAfter)) for (var i = state.cc.length - 1; i >= 0; --i) {
        var c = state.cc[i];
        if (c == poplex) lexical = lexical.prev;
        else if (c != maybeelse) break;
      }
      if (lexical.type == "stat" && firstChar == "}") lexical = lexical.prev;
      if (statementIndent && lexical.type == ")" && lexical.prev.type == "stat")
        lexical = lexical.prev;
      var type = lexical.type, closing = firstChar == type;

      if (type == "vardef") return lexical.indented + (state.lastType == "operator" || state.lastType == "," ? lexical.info + 1 : 0);
      else if (type == "form" && firstChar == "{") return lexical.indented;
      else if (type == "form") return lexical.indented + indentUnit;
      else if (type == "stat")
        return lexical.indented + (state.lastType == "operator" || state.lastType == "," ? statementIndent || indentUnit : 0);
      else if (lexical.info == "switch" && !closing && parserConfig.doubleIndentSwitch != false)
        return lexical.indented + (/^(?:case|default)\b/.test(textAfter) ? indentUnit : 2 * indentUnit);
      else if (lexical.align) return lexical.column + (closing ? 0 : 1);
      else return lexical.indented + (closing ? 0 : indentUnit);
    },

    electricChars: ":{}",
    blockCommentStart: jsonMode ? null : "/*",
    blockCommentEnd: jsonMode ? null : "*/",
    lineComment: jsonMode ? null : "//",
    fold: "brace",

    helperType: jsonMode ? "json" : "javascript",
    jsonldMode: jsonldMode,
    jsonMode: jsonMode
  };
});

CodeMirror.registerHelper("wordChars", "javascript", /[\\w$]/);

CodeMirror.defineMIME("text/javascript", "javascript");
CodeMirror.defineMIME("text/ecmascript", "javascript");
CodeMirror.defineMIME("application/javascript", "javascript");
CodeMirror.defineMIME("application/x-javascript", "javascript");
CodeMirror.defineMIME("application/ecmascript", "javascript");
CodeMirror.defineMIME("application/json", {name: "javascript", json: true});
CodeMirror.defineMIME("application/x-json", {name: "javascript", json: true});
CodeMirror.defineMIME("application/ld+json", {name: "javascript", jsonld: true});
CodeMirror.defineMIME("text/typescript", { name: "javascript", typescript: true });
CodeMirror.defineMIME("application/typescript", { name: "javascript", typescript: true });

});

},{"codemirror":7}],3:[function(require,module,exports){
var $3647=function(type$3650){var f$3654;(f$3654=type$3650["::check"]);if((f$3654===(void 0))){return function(value$3660){return (value$3660 instanceof type$3650);};}else{return function(value$3664){return f$3654.call(type$3650,value$3664);};}};
var $3666=(function(o,m){if(typeof(m)==='string'||typeof(m)==='number'){return o[m];}else{return o['::send'](m);}});
var $3667=function(dest$3670,values$3671){var k$3676;(k$3676=null);$3674:for(k$3676 in values$3671){if(values$3671.hasOwnProperty(k$3676)){(dest$3670[k$3676]=values$3671[k$3676]);}}return dest$3670;};
var $3684=function($3686$3689){var ph$3695;(ph$3695=$3686$3689);var $3691$3701;($3691$3701=ph$3695);var bridge$3693$3706;var x$3710;(bridge$3693$3706=$3691$3701);if((((typeof(bridge$3693$3706)==="string")&&((x$3710=bridge$3693$3706),true))||((typeof(bridge$3693$3706)==="number")&&((x$3710=bridge$3693$3706),true)))){return ["value",x$3710];}else{var other$3721;(other$3721=$3691$3701);return other$3721["::serialize_ast"]();}};
var send$3421;(send$3421=function(obj$3428,$3425$3429){var ph$3435;var msg$3436;var t0$3438;(t0$3438=$3425$3429);(msg$3436=t0$3438);(ph$3435=t0$3438);var $3431$3447;($3431$3447=ph$3435);var bridge$3433$3452;(bridge$3433$3452=$3431$3447);if(((typeof(bridge$3433$3452)==="string")||(typeof(bridge$3433$3452)==="number"))){return obj$3428[msg$3436];}else{var other$3464;(other$3464=$3431$3447);return obj$3428["::send"](msg$3436);}});(Array[":::project"]=function($3470$3473){var ph$3478;var value$3479;var t0$3481;(t0$3481=$3470$3473);(value$3479=t0$3481);(ph$3478=t0$3481);var $3475$3490;($3475$3490=ph$3478);if($3647(Array)($3475$3490)){return [true,value$3479];}else{$3475$3490;return [true,[value$3479]];}});(Array.prototype["::check"]=function(value$3508){if((value$3508 instanceof Array)){var i$3514;(i$3514=0);$3511:for(;(i$3514<this.length);(i$3514++)){if(($3666(this,i$3514)!==$3666(value$3508,i$3514))){return false;}}return true;}else{return false;}});(Array.prototype["::clone"]=function(){return $3667(this.slice(0),this);});(Array.prototype[":::project"]=function(value$3533){if((value$3533 instanceof Array)){var i$3539;(i$3539=0);$3536:for(;(i$3539<this.length);(i$3539++)){if(($3666(this,i$3539)!==$3666(value$3533,i$3539))){return [true,[value$3533]];}}return [true,value$3533.slice(this.length)];}else{return [true,[value$3533]];}});(Array.prototype["::serialize_ast"]=function(){return ["array"].concat(this.map($3684));});(RegExp.prototype["::check"]=function($3557$3560){var ph$3565;(ph$3565=$3557$3560);var $3562$3571;($3562$3571=ph$3565);var value$3579;if((typeof($3562$3571)==="string")){(value$3579=$3562$3571);if(value$3579.match(this)){return true;}else{return false;}}else{var other$3584;(other$3584=$3562$3571);return false;}});(RegExp.prototype[":::project"]=function($3590$3593){var ph$3598;(ph$3598=$3590$3593);var $3595$3604;($3595$3604=ph$3598);var value$3612;if((typeof($3595$3604)==="string")){(value$3612=$3595$3604);var $3615$3620;($3615$3620=value$3612.match(this));var m$3628;if(($3615$3620===null)){(m$3628=$3615$3620);return [false,null];}else{var m$3633;(m$3633=$3615$3620);return [true,m$3633];}}else{var other$3637;(other$3637=$3595$3604);return [false,null];}});(Function.prototype["::send"]=function(args$3644){return this.apply(this,args$3644);});
var $4483=Object.keys;
var $4484=function($4486$4489,key$4490){var ph$4498;(ph$4498=$4486$4489);var $4492$4504;($4492$4504=ph$4498);var bridge$4494$4509;(bridge$4494$4509=$4492$4504);if(((bridge$4494$4509===null)||(bridge$4494$4509===(void 0)))){return false;}else{var x$4521;if((typeof($4492$4504)==="string")){(x$4521=$4492$4504);return (key$4490 in String.prototype);}else{var x$4526;if((typeof($4492$4504)==="number")){(x$4526=$4492$4504);return (key$4490 in Number.prototype);}else{var x$4531;(x$4531=$4492$4504);return (key$4490 in x$4531);}}}};
var $4311=function($4313$4316,b$4317){var ph$4331;var a$4332;var t0$4334;(t0$4334=$4313$4316);(a$4332=t0$4334);(ph$4331=t0$4334);var $4319$4343;($4319$4343=ph$4331);var bridge$4322$4348;if(($4319$4343===b$4317)){return true;}else{(bridge$4322$4348=$4319$4343);if((function(){var bridge$4323$4362;(bridge$4323$4362=bridge$4322$4348);return (function(){var bridge$4324$4369;(bridge$4324$4369=bridge$4323$4362);return (function(){var bridge$4325$4376;(bridge$4325$4376=bridge$4324$4369);return (function(){var bridge$4326$4383;(bridge$4326$4383=bridge$4325$4376);return ((typeof(bridge$4326$4383)==="number")||(typeof(bridge$4326$4383)==="string"));}()||(bridge$4325$4376===null));}()||(bridge$4324$4369===(void 0)));}()||(bridge$4323$4362===true));}()||(bridge$4322$4348===false))){return false;}else{if($3647(Array)($4319$4343)){if(((!$3647(Array)(b$4317))||(a$4332.length!==b$4317.length))){return false;}var i$4399;(i$4399=0);$4395:for(;(i$4399<a$4332.length);(i$4399++)){if((!$4311(a$4332[i$4399],b$4317[i$4399]))){return false;}}return true;}else{$4319$4343;if((((Object.getPrototypeOf(a$4332)===Object.prototype)&&$3647(Object)(b$4317))&&(Object.getPrototypeOf(b$4317)===Object.prototype))){var ka$4413;(ka$4413=$4483(a$4332));if((!$4311(ka$4413.sort(),$4483(b$4317).sort()))){return false;}var temp$4424;(temp$4424=ka$4413);var $length$4430;($length$4430=temp$4424.length);var $index$4436;($index$4436=0);$4414:for(;($index$4436<$length$4430);($index$4436++)){var m$4445;(m$4445=temp$4424[$index$4436]);var k$4453;(k$4453=m$4445);if((!$4311(a$4332[k$4453],b$4317[k$4453]))){return false;}}return true;}else{if($4484($4319$4343,"::serialize")){$4319$4343["::serialize"];var $4460$4465;($4460$4465=b$4317);if($4484($4460$4465,"::serialize")){$4460$4465["::serialize"];return $4311(a$4332["::serialize"](),b$4317["::serialize"]());}else{var otherwise$4477;(otherwise$4477=$4460$4465);return false;}}else{var otherwise$4481;(otherwise$4481=$4319$4343);return false;}}}}}};
var $4305=function(x$4308,y$4309){return (!$4311(x$4308,y$4309));};var accum$4293;var accum$4297;var keynames$3736;var prevent$3737;var Interactor$3738;(keynames$3736=({8:"Backspace",9:"Tab",13:"Enter",16:"S-",17:"C-",18:"A-",27:"Esc",32:"Space",33:"PgUp",34:"PgDn",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12"}));(prevent$3737=function(event$3746){event$3746.preventDefault();return event$3746.stopPropagation();});(Interactor$3738=function(target$3754){var accum$3778;var accum$3785;var accum$3792;var accum$3799;var it$0$3757;(it$0$3757=function(){if((!$3647(Interactor$3738)(this))){return Object.create(Interactor$3738.prototype);}else{return this;}}());(it$0$3757["functions"]=(target$3754.interactor_functions||target$3754));(it$0$3757["more_functions"]=$3667(((accum$3778=({})),((accum$3778["default"]=function(){return "default";}),accum$3778)),$3667(((accum$3785=({})),((accum$3785["stick"]=function(){return "stick";}),accum$3785)),$3667(((accum$3792=({})),((accum$3792["break"]=function(){return "break";}),accum$3792)),((accum$3799=({})),((accum$3799["none"]=function(){return (void 0);}),accum$3799))))));(it$0$3757["current_bindings"]=null);(it$0$3757["global_bindings"]=null);return it$0$3757;});(Interactor$3738.prototype["set_bindings"]=function(new_bindings$3817){var it$0$3821;var self$3822;(it$0$3821=this);(self$3822=this);(it$0$3821["current_bindings"]=null);(it$0$3821["global_bindings"]=new_bindings$3817);});(Interactor$3738.prototype["execute"]=function(c$3843,e$3844){var f$3877;var $index$3915;var $length$3909;var temp$3903;var result$3893;var cmd$3971;var cmds$3888;var f$3883;var cmd$3872;var $3857$3864;var it$0$3848;var self$3849;(it$0$3848=this);(self$3849=this);($3857$3864=c$3843);if((typeof($3857$3864)==="string")){(cmd$3872=$3857$3864);(f$3877=($3666(it$0$3848.functions,cmd$3872)||$3666(it$0$3848.more_functions,cmd$3872)));return f$3877(e$3844);}else{if($3647(Function)($3857$3864)){(f$3883=$3857$3864);return f$3883(it$0$3848.target,e$3844);}else{if($3647(Array)($3857$3864)){(cmds$3888=$3857$3864);(result$3893=null);(temp$3903=cmds$3888);($length$3909=temp$3903.length);($index$3915=0);$3894:for(;($index$3915<$length$3909);($index$3915++)){var other$3967;var $3936$3946;var cmd$3932;var m$3924;(m$3924=temp$3903[$index$3915]);(cmd$3932=m$3924);(result$3893=it$0$3848.execute(cmd$3932,e$3844));($3936$3946=result$3893);if(($3936$3946==="break")){prevent$3737(e$3844);break $3894;}else{if(($3936$3946==="default")){break $3894;}else{if(($3936$3946==="ignore")){continue $3894;}else{(other$3967=$3936$3946);prevent$3737(e$3844);}}}}return result$3893;}else{(cmd$3971=$3857$3864);(it$0$3848["current_bindings"]=cmd$3971);return "break stick";}}}});(Interactor$3738.prototype["process_codes"]=function(codes$3982,e$3983){var $index$4033;var $length$4027;var temp$4021;var otherwise$4127;var $4087$4096;var $4082$4090;var result$4134;var t0$4071;var $4000$4066;var bindings$4003;var just_modifiers$4004;var commands$4005;var it$0$3987;var self$3988;(it$0$3987=this);(self$3988=this);(bindings$4003=(it$0$3987.current_bindings||it$0$3987.global_bindings));(just_modifiers$4004=null);(commands$4005=[]);(temp$4021=codes$3982);($length$4027=temp$4021.length);($index$4033=0);$4006:for(;($index$4033<$length$4027);($index$4033++)){var command$4054;var code$4050;var m$4042;(m$4042=temp$4021[$index$4033]);(code$4050=m$4042);if($3647(RegExp("^([ACS]-)+$",""))(code$4050)){(just_modifiers$4004=true);}(command$4054=$3666(bindings$4003,code$4050));if($4305(command$4054,(void 0))){commands$4005.push(command$4054);}}($4000$4066=commands$4005);if((($4000$4066 instanceof Array)&&(((t0$4071=$4000$4066.length)),(t0$4071===0)))){($4082$4090=null);$4082$4090;if((it$0$3987.current_bindings&&it$0$3987.current_bindings._eat)){if((!just_modifiers$4004)){(it$0$3987["current_bindings"]=null);}return prevent$3737(e$3983);}else{if((it$0$3987.current_bindings&&it$0$3987.current_bindings._browser)){if((!just_modifiers$4004)){(it$0$3987["current_bindings"]=null);}}else{if((it$0$3987.current_bindings&&(!just_modifiers$4004))){(it$0$3987["current_bindings"]=null);return it$0$3987.process_codes(codes$3982,e$3983);}else{(otherwise$4127=$4082$4090);return null;}}}}else{$4000$4066;(result$4134=it$0$3987.execute(commands$4005,e$3983));if(($4311(result$4134,(void 0))||(result$4134.match&&result$4134.match("break")))){prevent$3737(e$3983);}if((((!((result$4134&&result$4134.match)&&result$4134.match("stick")))&&it$0$3987.current_bindings)&&(!it$0$3987.current_bindings._stick))){(it$0$3987["current_bindings"]=null);}}});(Interactor$3738.prototype["getcode"]=function(e$4148){var otherwise$4196;var $4168$4181;var $4163$4175;var code$4169;var it$0$4152;var self$4153;(it$0$4152=this);(self$4153=this);(code$4169=($3666(keynames$3736,e$4148.which)||(("<"+e$4148.which)+">")));($4163$4175=null);$4163$4175;if((e$4148.shiftKey&&$4305(code$4169,"S-"))){return ("S-"+code$4169);}else{if((e$4148.altKey&&$4305(code$4169,"A-"))){return ("A-"+code$4169);}else{if(((e$4148.ctrlKey||e$4148.metaKey)&&$4305(code$4169,"C-"))){return ("C-"+code$4169);}else{(otherwise$4196=$4163$4175);return code$4169;}}}});(Interactor$3738.prototype["keyup"]=function(e$4202){var it$0$4206;var self$4207;(it$0$4206=this);(self$4207=this);return it$0$4206.process_codes(["!^All",("^"+it$0$4206.getcode(e$4202)),"^All"],e$4202);});(Interactor$3738.prototype["keydown"]=function(e$4219){var it$0$4223;var self$4224;(it$0$4223=this);(self$4224=this);return it$0$4223.process_codes(["!All",it$0$4223.getcode(e$4219),"All"],e$4219);});(Interactor$3738.prototype["keypress"]=function(e$4236){var key$4252;var code$4253;var it$0$4240;var self$4241;(it$0$4240=this);(self$4241=this);(key$4252=e$4236.which);(code$4253=("="+String.fromCharCode(key$4252)));return it$0$4240.process_codes(["!=All",code$4253,"=All"],e$4236);});(Interactor$3738.prototype["install"]=function(element$4264){var it$0$4268;var self$4269;(it$0$4268=this);(self$4269=this);(element$4264["onkeydown"]=it$0$4268.keydown.bind(it$0$4268));(element$4264["onkeyup"]=it$0$4268.keyup.bind(it$0$4268));(element$4264["onkeypress"]=it$0$4268.keypress.bind(it$0$4268));});$3667(Interactor$3738,$3667(((accum$4293=({})),((accum$4293["::name"]="Interactor"),accum$4293)),((accum$4297=({})),((accum$4297["::egclass"]=true),accum$4297))));Interactor$3738;(exports["Interactor"]=Interactor$3738);

},{}],"eXk3/i":[function(require,module,exports){
var $4769=function(type$4772){var f$4776;(f$4776=type$4772["::check"]);if((f$4776===(void 0))){return function(value$4782){return (value$4782 instanceof type$4772);};}else{return function(value$4786){return f$4776.call(type$4772,value$4786);};}};
var $4788=(function(o,m){if(typeof(m)==='string'||typeof(m)==='number'){return o[m];}else{return o['::send'](m);}});
var $4789=function(dest$4792,values$4793){var k$4798;(k$4798=null);$4796:for(k$4798 in values$4793){if(values$4793.hasOwnProperty(k$4798)){(dest$4792[k$4798]=values$4793[k$4798]);}}return dest$4792;};
var $4806=function($4808$4811){var ph$4817;(ph$4817=$4808$4811);var $4813$4823;($4813$4823=ph$4817);var bridge$4815$4828;var x$4832;(bridge$4815$4828=$4813$4823);if((((typeof(bridge$4815$4828)==="string")&&((x$4832=bridge$4815$4828),true))||((typeof(bridge$4815$4828)==="number")&&((x$4832=bridge$4815$4828),true)))){return ["value",x$4832];}else{var other$4843;(other$4843=$4813$4823);return other$4843["::serialize_ast"]();}};
var send$4543;(send$4543=function(obj$4550,$4547$4551){var ph$4557;var msg$4558;var t0$4560;(t0$4560=$4547$4551);(msg$4558=t0$4560);(ph$4557=t0$4560);var $4553$4569;($4553$4569=ph$4557);var bridge$4555$4574;(bridge$4555$4574=$4553$4569);if(((typeof(bridge$4555$4574)==="string")||(typeof(bridge$4555$4574)==="number"))){return obj$4550[msg$4558];}else{var other$4586;(other$4586=$4553$4569);return obj$4550["::send"](msg$4558);}});(Array[":::project"]=function($4592$4595){var ph$4600;var value$4601;var t0$4603;(t0$4603=$4592$4595);(value$4601=t0$4603);(ph$4600=t0$4603);var $4597$4612;($4597$4612=ph$4600);if($4769(Array)($4597$4612)){return [true,value$4601];}else{$4597$4612;return [true,[value$4601]];}});(Array.prototype["::check"]=function(value$4630){if((value$4630 instanceof Array)){var i$4636;(i$4636=0);$4633:for(;(i$4636<this.length);(i$4636++)){if(($4788(this,i$4636)!==$4788(value$4630,i$4636))){return false;}}return true;}else{return false;}});(Array.prototype["::clone"]=function(){return $4789(this.slice(0),this);});(Array.prototype[":::project"]=function(value$4655){if((value$4655 instanceof Array)){var i$4661;(i$4661=0);$4658:for(;(i$4661<this.length);(i$4661++)){if(($4788(this,i$4661)!==$4788(value$4655,i$4661))){return [true,[value$4655]];}}return [true,value$4655.slice(this.length)];}else{return [true,[value$4655]];}});(Array.prototype["::serialize_ast"]=function(){return ["array"].concat(this.map($4806));});(RegExp.prototype["::check"]=function($4679$4682){var ph$4687;(ph$4687=$4679$4682);var $4684$4693;($4684$4693=ph$4687);var value$4701;if((typeof($4684$4693)==="string")){(value$4701=$4684$4693);if(value$4701.match(this)){return true;}else{return false;}}else{var other$4706;(other$4706=$4684$4693);return false;}});(RegExp.prototype[":::project"]=function($4712$4715){var ph$4720;(ph$4720=$4712$4715);var $4717$4726;($4717$4726=ph$4720);var value$4734;if((typeof($4717$4726)==="string")){(value$4734=$4717$4726);var $4737$4742;($4737$4742=value$4734.match(this));var m$4750;if(($4737$4742===null)){(m$4750=$4737$4742);return [false,null];}else{var m$4755;(m$4755=$4737$4742);return [true,m$4755];}}else{var other$4759;(other$4759=$4717$4726);return [false,null];}});(Function.prototype["::send"]=function(args$4766){return this.apply(this,args$4766);});
var $7851=function(obj$7854){var results$7859;(results$7859=[]);var k$7864;(k$7864=null);$7858:for(k$7864 in obj$7854){if(Object.prototype.hasOwnProperty.call(obj$7854,k$7864)){results$7859.push([k$7864,$4788(obj$7854,k$7864)]);}}return results$7859;};
var $8120=function(arr$8123){var results$8129;var l$8130;(results$8129=[]);(l$8130=arr$8123.length);var i$8139;(i$8139=0);$8128:for(;(i$8139<l$8130);(i$8139++)){results$8129.push([i$8139,$4788(arr$8123,i$8139)]);}return results$8129;};
var $7887=function(){var $7888$7894;($7888$7894=function(tags$7899){var it$0$7902;(it$0$7902=function(){if((!$4769($7888$7894)(this))){return Object.create($7888$7894.prototype);}else{return this;}}());(it$0$7902["tags"]=tags$7899);return it$0$7902;});($7888$7894.prototype["create"]=function(){var it$0$7922;var self$7923;(it$0$7922=this);(self$7923=this);var $7920$7932;($7920$7932=arguments);var t0$7937;var message$7941;var args$7942;(t0$7937=$7920$7932.length);if((t0$7937>=0)){(message$7941=function(){if((0>=t0$7937)){return "";}else{return $7920$7932[0];}}());(args$7942=Array.prototype.slice.call($7920$7932,1));var e$7955;(e$7955=Error(message$7941));(e$7955["::tags"]=it$0$7922.tags);(e$7955["args"]=args$7942);var temp$7971;(temp$7971=$8120(args$7942));var $length$7977;($length$7977=temp$7971.length);var $index$7983;($index$7983=0);$7956:for(;($index$7983<$length$7977);($index$7983++)){var m$7992;(m$7992=temp$7971[$index$7983]);var t0$7997;var t1$7998;var i$8002;var arg$8003;(t0$7997=m$7992);if(((t0$7997 instanceof Array)&&(((t1$7998=t0$7997.length)),(t1$7998===2)))){(i$8002=t0$7997[0]);(arg$8003=t0$7997[1]);(e$7955[i$8002]=arg$8003);}else{$7868(m$7992);}}(e$7955["length"]=args$7942.length);(e$7955["name"]=["E"].concat(it$0$7922.tags).join("."));return e$7955;}else{$7868($7920$7932);}});($7888$7894.prototype["::check"]=function(e$8033){var it$0$8037;var self$8038;(it$0$8037=this);(self$8038=this);var tags$8048;if(((!e$8033)||(!$4769(Error)(e$8033)))){return false;}(tags$8048=(e$8033["::tags"]||[]));var temp$8059;(temp$8059=it$0$8037.tags);var $length$8065;($length$8065=temp$8059.length);var $index$8071;($index$8071=0);$8049:for(;($index$8071<$length$8065);($index$8071++)){var m$8080;(m$8080=temp$8059[$index$8071]);var tag$8088;(tag$8088=m$8080);if((tags$8048.indexOf(tag$8088)===-1)){return false;}else{false;}}return true;});($7888$7894.prototype["::deconstruct"]=function(e$8097){var it$0$8101;var self$8102;(it$0$8101=this);(self$8102=this);return e$8097.args;});$4789($7888$7894,$4789(function(){var accum$8113;(accum$8113=({}));(accum$8113["::name"]="$7888");return accum$8113;}(),function(){var accum$8117;(accum$8117=({}));(accum$8117["::egclass"]=true);return accum$8117;}()));return $7888$7894;}();
var $7868=function(value$7871,url$7872,start$7873,end$7874){var err$7878;(err$7878=$7887(["match"]).create("Could not find a match for value",({"value":value$7871})));if(url$7872){(err$7878["location"]=["location",url$7872,start$7873,end$7874]);}throw err$7878;};
var $8146=function(type$8149){return function(value$8153){var f$8157;(f$8157=type$8149[":::project"]);if((f$8157===(void 0))){(f$8157=type$8149["::project"]);if((f$8157===(void 0))){return [true,type$8149(value$8153)];}else{var rval$8170;(rval$8170=false);try{(rval$8170=[true,f$8157(value$8153)]);}catch(excv$8181){var e$8187;(e$8187=excv$8181);(rval$8170=[false,null]);}return rval$8170;}}else{return f$8157.call(type$8149,value$8153);}};};
var $8482=function($8484$8487,key$8488){var ph$8496;(ph$8496=$8484$8487);var $8490$8502;($8490$8502=ph$8496);var bridge$8492$8507;(bridge$8492$8507=$8490$8502);if(((bridge$8492$8507===null)||(bridge$8492$8507===(void 0)))){return false;}else{var x$8519;if((typeof($8490$8502)==="string")){(x$8519=$8490$8502);return (key$8488 in String.prototype);}else{var x$8524;if((typeof($8490$8502)==="number")){(x$8524=$8490$8502);return (key$8488 in Number.prototype);}else{var x$8529;(x$8529=$8490$8502);return (key$8488 in x$8529);}}}};
var $8193=function(){var $8194$8199;($8194$8199=function($8203$8210,$8205$8211,$8207$8212){var it$0$8215;(it$0$8215=function(){if((!$4769($8194$8199)(this))){return Object.create($8194$8199.prototype);}else{return this;}}());var t0$8222;(t0$8222=$8146(Array)($8203$8210));if(t0$8222[0]){(it$0$8215["tags"]=t0$8222[1]);}else{$7868($8203$8210);}(it$0$8215["props"]=$8205$8211);var t0$8234;(t0$8234=$8146(Array)($8207$8212));if(t0$8234[0]){(it$0$8215["children"]=t0$8234[1]);}else{$7868($8207$8212);}undefined;return it$0$8215;});$4789(function(){var accum$8248;(accum$8248=({}));(accum$8248["::check"]=function(x$8253){return (((x$8253&&x$8253.tags)&&x$8253.props)&&x$8253.children);});return accum$8248;}(),$4789(function(){var accum$8256;(accum$8256=({}));(accum$8256[":::project"]=function($8260$8263){var ph$8268;(ph$8268=$8260$8263);var $8265$8274;($8265$8274=ph$8268);var tags$8282;var props$8283;var children$8284;if(($8482($8265$8274,"tags")&&((tags$8282=$8265$8274.tags),($8482($8265$8274,"props")&&((props$8283=$8265$8274.props),$8482($8265$8274,"children")))))){(children$8284=$8265$8274.children);return [true,[tags$8282,props$8283,children$8284]];}else{$8265$8274;return [false,null];}});return accum$8256;}(),$4789(function(){var accum$8293;(accum$8293=({}));(accum$8293["::name"]="$8194");return accum$8293;}(),function(){var accum$8297;(accum$8297=({}));(accum$8297["::egclass"]=true);return accum$8297;}())));($8194$8199.prototype["::check"]=function($8303$8306){var it$0$8310;var self$8311;(it$0$8310=this);(self$8311=this);var ph$8322;(ph$8322=$8303$8306);var $8319$8328;($8319$8328=ph$8322);var n$8336;if($4769($8193)($8319$8328)){(n$8336=$8319$8328);var temp$8346;(temp$8346=it$0$8310.tags);var $length$8352;($length$8352=temp$8346.length);var $index$8358;($index$8358=0);$8340:for(;($index$8358<$length$8352);($index$8358++)){var m$8367;(m$8367=temp$8346[$index$8358]);var c$8375;(c$8375=m$8367);if((n$8336.tags.indexOf(c$8375)===-1)){return false;}else{false;}}return true;}else{$8319$8328;return false;}});($8194$8199.prototype[":::project"]=function($8386$8389){var it$0$8393;var self$8394;(it$0$8393=this);(self$8394=this);var ph$8405;(ph$8405=$8386$8389);var $8402$8411;($8402$8411=ph$8405);var n$8419;if($4769(it$0$8393)($8402$8411)){(n$8419=$8402$8411);return [true,[n$8419.tags,n$8419.props,n$8419.children]];}else{$8402$8411;return [false,null];}});$4789($8194$8199,$4789(function(){var accum$8430;(accum$8430=({}));(accum$8430["::check"]=function(x$8435){return (((x$8435&&x$8435.tags)&&x$8435.props)&&x$8435.children);});return accum$8430;}(),$4789(function(){var accum$8438;(accum$8438=({}));(accum$8438[":::project"]=function($8442$8445){var ph$8450;(ph$8450=$8442$8445);var $8447$8456;($8447$8456=ph$8450);var tags$8464;var props$8465;var children$8466;if(($8482($8447$8456,"tags")&&((tags$8464=$8447$8456.tags),($8482($8447$8456,"props")&&((props$8465=$8447$8456.props),$8482($8447$8456,"children")))))){(children$8466=$8447$8456.children);return [true,[tags$8464,props$8465,children$8466]];}else{$8447$8456;return [false,null];}});return accum$8438;}(),$4789(function(){var accum$8475;(accum$8475=({}));(accum$8475["::name"]="$8194");return accum$8475;}(),function(){var accum$8479;(accum$8479=({}));(accum$8479["::egclass"]=true);return accum$8479;}()))));return $8194$8199;}();
var $8703=Object.keys;
var $8531=function($8533$8536,b$8537){var ph$8551;var a$8552;var t0$8554;(t0$8554=$8533$8536);(a$8552=t0$8554);(ph$8551=t0$8554);var $8539$8563;($8539$8563=ph$8551);var bridge$8542$8568;if(($8539$8563===b$8537)){return true;}else{(bridge$8542$8568=$8539$8563);if((function(){var bridge$8543$8582;(bridge$8543$8582=bridge$8542$8568);return (function(){var bridge$8544$8589;(bridge$8544$8589=bridge$8543$8582);return (function(){var bridge$8545$8596;(bridge$8545$8596=bridge$8544$8589);return (function(){var bridge$8546$8603;(bridge$8546$8603=bridge$8545$8596);return ((typeof(bridge$8546$8603)==="number")||(typeof(bridge$8546$8603)==="string"));}()||(bridge$8545$8596===null));}()||(bridge$8544$8589===(void 0)));}()||(bridge$8543$8582===true));}()||(bridge$8542$8568===false))){return false;}else{if($4769(Array)($8539$8563)){if(((!$4769(Array)(b$8537))||(a$8552.length!==b$8537.length))){return false;}var i$8619;(i$8619=0);$8615:for(;(i$8619<a$8552.length);(i$8619++)){if((!$8531(a$8552[i$8619],b$8537[i$8619]))){return false;}}return true;}else{$8539$8563;if((((Object.getPrototypeOf(a$8552)===Object.prototype)&&$4769(Object)(b$8537))&&(Object.getPrototypeOf(b$8537)===Object.prototype))){var ka$8633;(ka$8633=$8703(a$8552));if((!$8531(ka$8633.sort(),$8703(b$8537).sort()))){return false;}var temp$8644;(temp$8644=ka$8633);var $length$8650;($length$8650=temp$8644.length);var $index$8656;($index$8656=0);$8634:for(;($index$8656<$length$8650);($index$8656++)){var m$8665;(m$8665=temp$8644[$index$8656]);var k$8673;(k$8673=m$8665);if((!$8531(a$8552[k$8673],b$8537[k$8673]))){return false;}}return true;}else{if($8482($8539$8563,"::serialize")){$8539$8563["::serialize"];var $8680$8685;($8680$8685=b$8537);if($8482($8680$8685,"::serialize")){$8680$8685["::serialize"];return $8531(a$8552["::serialize"](),b$8537["::serialize"]());}else{var otherwise$8697;(otherwise$8697=$8680$8685);return false;}}else{var otherwise$8701;(otherwise$8701=$8539$8563);return false;}}}}}};
var $8726=function($8728$8731){var ph$8741;var x$8742;var t0$8744;(t0$8744=$8728$8731);(x$8742=t0$8744);(ph$8741=t0$8744);var $8733$8753;($8733$8753=ph$8741);var bridge$8735$8758;(bridge$8735$8758=$8733$8753);if((function(){var bridge$8736$8768;(bridge$8736$8768=bridge$8735$8758);return (function(){var bridge$8737$8775;(bridge$8737$8775=bridge$8736$8768);return ((bridge$8737$8775===(void 0))||(bridge$8737$8775===null));}()||(typeof(bridge$8736$8768)==="string"));}()||(typeof(bridge$8735$8758)==="number"))){return x$8742;}else{if($8482($8733$8753,"::clone")){$8733$8753["::clone"];return x$8742["::clone"]();}else{$8733$8753;if((Object.getPrototypeOf(x$8742)===Object.prototype)){var dest$8793;(dest$8793=({}));var k$8798;(k$8798=null);$8792:for(k$8798 in x$8742){if(Object.prototype.hasOwnProperty.call(x$8742,k$8798)){(dest$8793[k$8798]=x$8742[k$8798]);}}return dest$8793;}else{var other$8808;(other$8808=$8733$8753);throw $7887(["clone"]).create("Object cannot be cloned",({"obj":x$8742}));}}}};
var $8704=function(a$8707,b$8708){var dest$8713;(dest$8713=$8726(a$8707));var k$8718;(k$8718=null);$8712:for(k$8718 in b$8708){if(Object.prototype.hasOwnProperty.call(b$8708,k$8718)){(dest$8713[k$8718]=b$8708[k$8718]);}}return dest$8713;};var accum$6863;var accum$6867;var kb$5261;var eg$5262;var $4849$5263;var GenSym$5264;var $4850$5265;var Location$5266;var highlight_locations$5267;var format_error$5268;var $4851$5269;var tokenize$5270;var $4852$5271;var parse$5272;var quaint$5273;var CodeMirror$5274;var $4853$5275;var $4854$5276;var $4855$5277;var gensym$5278;var create_node$5279;var make_dom$5280;var mktable$5281;var repr$5282;var goto_end$5283;var insert_before_caret$5284;var Repl$5285;var make_cards$5286;var setup$5287;(kb$5261=require("./kb"));(eg$5262=require("earl-grey/earl-grey"));($4849$5263=require("earl-grey/util"));(GenSym$5264=$4849$5263.GenSym);($4850$5265=require("earl-grey/location"));(Location$5266=$4850$5265.Location);(highlight_locations$5267=$4850$5265.highlight_locations);(format_error$5268=$4850$5265.format_error);($4851$5269=require("earl-grey/lex"));(tokenize$5270=$4851$5269.tokenize);($4852$5271=require("earl-grey/parse"));(parse$5272=$4852$5271.parse);(quaint$5273=require("quaint"));(CodeMirror$5274=require("codemirror"));($4853$5275=require("codemirror/addon/runmode/runmode"));($4854$5276=require("./earlmode"));($4855$5277=require("./javascript"));(gensym$5278=GenSym$5264("io_"));(create_node$5279=function(tag$5346,kv$5347,contents$5348){var $index$5378;var $length$5372;var temp$5366;var $index$5431;var $length$5425;var temp$5419;var node$5352;(node$5352=document.createElement(tag$5346));(temp$5366=$7851(kv$5347));($length$5372=temp$5366.length);($index$5378=0);$5353:for(;($index$5378<$length$5372);($index$5378++)){var k$5397;var v$5398;var t0$5392;var t1$5393;var m$5387;(m$5387=temp$5366[$index$5378]);(t0$5392=m$5387);if(((t0$5392 instanceof Array)&&(((t1$5393=t0$5392.length)),(t1$5393===2)))){(k$5397=t0$5392[0]);(v$5398=t0$5392[1]);(node$5352[k$5397]=v$5398);}else{$7868(m$5387,"/home/olivier/git/egrepl/src/repl.eg",1921,1967);}}(temp$5419=$8146(Array)(contents$5348)[1]);($length$5425=temp$5419.length);($index$5431=0);$5356:for(;($index$5431<$length$5425);($index$5431++)){var other$5458;var s$5449;var t0$5445;var m$5440;(m$5440=temp$5419[$index$5431]);(t0$5445=m$5440);if((typeof(t0$5445)==="string")){(s$5449=t0$5445);node$5352.appendChild(document.createTextNode(s$5449));}else{(other$5458=m$5440);node$5352.appendChild(other$5458);}}return node$5352;});(make_dom$5280=function(){var $index$5534;var $length$5528;var temp$5522;var node$5512;var $index$5600;var $length$5594;var temp$5588;var $index$5668;var $length$5662;var temp$5656;var $index$5741;var $length$5735;var temp$5729;var acc$5723;var $index$5800;var $length$5794;var temp$5788;var acc$5782;var other$5775;var $5566$5708;var tag$5569;var classes$5570;var node$5571;var other$5822;var tags$5555;var props$5556;var children$5557;var args$5507;var s$5498;var $5472$5495;var t0$5493;var default_tag$5484;var $5467$5485;var t0$5480;var $5465$5475;($5465$5475=arguments);(t0$5480=$5465$5475.length);if(((t0$5480>=1)&&(t0$5480<=2))){($5467$5485=$5465$5475[0]);(default_tag$5484=function(){if((1>=t0$5480)){return "div";}else{return $5465$5475[1];}}());(t0$5493=$5467$5485);if((typeof(t0$5493)==="string")){(s$5498=t0$5493);return document.createTextNode(s$5498);}else{if($4769(Array)(t0$5493)){(args$5507=t0$5493);(node$5512=document.createElement("span"));(temp$5522=args$5507);($length$5528=temp$5522.length);($index$5534=0);$5513:for(;($index$5534<$length$5528);($index$5534++)){var arg$5551;var m$5543;(m$5543=temp$5522[$index$5534]);(arg$5551=m$5543);node$5512.appendChild(make_dom$5280(arg$5551,default_tag$5484));}return node$5512;}else{if(($4769($8193)(t0$5493)&&($8482(t0$5493,"tags")&&((tags$5555=t0$5493.tags),($8482(t0$5493,"props")&&((props$5556=t0$5493.props),$8482(t0$5493,"children"))))))){(children$5557=t0$5493.children);(tag$5569=default_tag$5484);(classes$5570=[]);(temp$5588=tags$5555);($length$5594=temp$5588.length);($index$5600=0);$5572:for(;($index$5600<$length$5594);($index$5600++)){var other$5639;var name$5620;var t0$5614;var t1$5615;var t2$5616;var m$5609;(m$5609=temp$5588[$index$5600]);(t0$5614=$8146(RegExp("^\\.(.*)",""))(m$5609));if((t0$5614[0]&&(((t1$5615=t0$5614[1])),(((t2$5616=t1$5615.length)),(t2$5616===2))))){t1$5615[0];(name$5620=t1$5615[1]);classes$5570.push(name$5620);}else{(other$5639=m$5609);(tag$5569=other$5639);}}(node$5571=document.createElement(tag$5569));if(classes$5570.length){(node$5571["className"]=classes$5570.join(" "));}(temp$5656=$7851(props$5556));($length$5662=temp$5656.length);($index$5668=0);$5576:for(;($index$5668<$length$5662);($index$5668++)){var k$5687;var v$5688;var t0$5682;var t1$5683;var m$5677;(m$5677=temp$5656[$index$5668]);(t0$5682=m$5677);if(((t0$5682 instanceof Array)&&(((t1$5683=t0$5682.length)),(t1$5683===2)))){(k$5687=t0$5682[0]);(v$5688=t0$5682[1]);(node$5571[k$5687]=v$5688);}else{$7868(m$5677,"/home/olivier/git/egrepl/src/repl.eg",2695,2751);}}($5566$5708=tag$5569);if(($5566$5708==="raw")){(acc$5723=[]);(temp$5729=children$5557);($length$5735=temp$5729.length);($index$5741=0);$5718:for(;($index$5741<$length$5735);($index$5741++)){var s$5759;var t0$5755;var m$5750;(m$5750=temp$5729[$index$5741]);(t0$5755=m$5750);if((typeof(t0$5755)==="string")){(s$5759=t0$5755);acc$5723.push(((node$5571["innerHTML"]=s$5759)));}else{$7868(m$5750,"/home/olivier/git/egrepl/src/repl.eg",2778,2879);}}acc$5723;}else{(other$5775=$5566$5708);(acc$5782=[]);(temp$5788=children$5557);($length$5794=temp$5788.length);($index$5800=0);$5777:for(;($index$5800<$length$5794);($index$5800++)){var c$5817;var m$5809;(m$5809=temp$5788[$index$5800]);(c$5817=m$5809);acc$5782.push(node$5571.appendChild(make_dom$5280(c$5817,default_tag$5484)));}acc$5782;}return node$5571;}else{(other$5822=$5467$5485);return make_dom$5280([true,String(other$5822)][1]);}}}}else{$7868($5465$5475);}});(mktable$5281=function(){var other$5874;var $5857$5862;var $index$5900;var $length$5894;var temp$5888;var acc$5882;var its$5854;var x$5844;var recur$5845;var t0$5840;var $5831$5835;($5831$5835=arguments);(t0$5840=$5831$5835.length);if(((t0$5840>=1)&&(t0$5840<=2))){(x$5844=$5831$5835[0]);(recur$5845=function(){if((1>=t0$5840)){return repr$5282;}else{return $5831$5835[1];}}());(its$5854=((($5857$5862=x$5844)),function(){if($4769(Array)($5857$5862)){return x$5844;}else{(other$5874=$5857$5862);return $7851(x$5844);}}()));if(its$5854.length){return $8193(["table",".object"],({}),(((acc$5882=[])),(((temp$5888=its$5854)),((($length$5894=temp$5888.length)),((($index$5900=0)),function(){$5877:for(;($index$5900<$length$5894);($index$5900++)){var k$5919;var v$5920;var t0$5914;var t1$5915;var m$5909;(m$5909=temp$5888[$index$5900]);(t0$5914=m$5909);if(((t0$5914 instanceof Array)&&(((t1$5915=t0$5914.length)),(t1$5915===2)))){(k$5919=t0$5914[0]);(v$5920=t0$5914[1]);acc$5882.push($8193(["tr"],({}),[$8193(["th"],({}),recur$5845(k$5919,repr$5282)),$8193(["td"],({}),recur$5845(v$5920,repr$5282))]));}else{$7868(m$5909,"/home/olivier/git/egrepl/src/repl.eg",4164,4298);}}}()))),acc$5882));}else{return $8193([".object",".empty"],({}),[]);}}else{$7868($5831$5835);}});(repr$5282=function(){var $index$6072;var $length$6066;var temp$6060;var acc$6054;var other$6124;var f$6115;var n$6094;var entries$6046;var $5961$6001;var $5962$6002;var t0$5998;var t1$5999;var x$5976;var recur$5977;var $5944$5978;var t0$5970;var t1$5971;var t2$5972;var $5942$5965;($5942$5965=arguments);(t0$5970=$5942$5965.length);if((((t0$5970>=1)&&(t0$5970<=2))&&(((t1$5971=$5942$5965[0])),((x$5976=t1$5971),(($5944$5978=t1$5971),(((t2$5972=function(){if((1>=t0$5970)){return repr$5282;}else{return $5942$5965[1];}}())),$4769(Function)(t2$5972))))))){(recur$5977=t2$5972);if(($5944$5978===true)){return $8193([".special",".true"],({}),"true");}else{if(($5944$5978===false)){return $8193([".special",".false"],({}),"false");}else{if(($5944$5978===null)){return $8193([".special",".nil"],({}),"null");}else{if(($5944$5978===(void 0))){return $8193([".special",".nil"],({}),"undefined");}else{if((typeof($5944$5978)==="number")){return $8193([".num"],({}),String(x$5976));}else{if(($5944$5978==="")){return $8193([".str",".empty"],({}),[]);}else{if((typeof($5944$5978)==="string")){return $8193([".str"],({}),x$5976);}else{(t0$5998=$5944$5978);if((($5962$6002=$4769(Array)(t0$5998))&&(((t1$5999=t0$5998.length)),(t1$5999===0)))){return $8193([".sequence",".empty"],({}),[]);}else{if($5962$6002){(entries$6046=t0$5998);return $8193([".sequence"],({}),(((acc$6054=[])),(((temp$6060=entries$6046)),((($length$6066=temp$6060.length)),((($index$6072=0)),function(){$6049:for(;($index$6072<$length$6066);($index$6072++)){var x$6089;var m$6081;(m$6081=temp$6060[$index$6072]);(x$6089=m$6081);acc$6054.push(recur$5977(x$6089,repr$5282));}}()))),acc$6054));}else{if($4769($8193)(t0$5998)){(n$6094=t0$5998);return n$6094;}else{$5944$5978;if(x$5976["::repr"]){return x$5976["::repr"](recur$5977);}else{if((Object.getPrototypeOf(x$5976)===Object.prototype)){return mktable$5281(x$5976);}else{if((x$5976.constructor&&x$5976.constructor["::egclass"])){return $8193([".instance"],({}),[$8193([".classname"],({}),x$5976.constructor["::name"]),mktable$5281(x$5976)]);}else{if(x$5976["::egclass"]){return $8193([".class"],({}),[$8193([".classname"],({}),("Class "+x$5976["::name"])),mktable$5281(x$5976.prototype)]);}else{(t0$5998=$5944$5978);if($4769(Function)(t0$5998)){(f$6115=t0$5998);return $8193([".function"],({}),function(){if(f$6115.name){return f$6115.name;}else{return "<anonymous>";}}());}else{(other$6124=$5944$5978);return $8193([".unknown"],({}),other$6124.toString());}}}}}}}}}}}}}}}}else{$7868($5942$5965);}});(goto_end$5283=function(elem$6133){var range$6138;var selection$6139;(range$6138=document.createRange());range$6138.selectNodeContents(elem$6133);range$6138.collapse(false);(selection$6139=window.getSelection());selection$6139.removeAllRanges();return selection$6139.addRange(range$6138);});(insert_before_caret$5284=function(text$6151){var other$6177;var $6160$6165;var it$0$6192;var it$0$6202;var range$6186;var node$6156;var sel$6157;(node$6156=((($6160$6165=text$6151)),function(){if((typeof($6160$6165)==="string")){return document.createTextNode(text$6151);}else{(other$6177=$6160$6165);return other$6177;}}()));(sel$6157=window.getSelection());if(sel$6157.rangeCount){(range$6186=sel$6157.getRangeAt(0));(it$0$6192=range$6186);it$0$6192.collapse(false);it$0$6192.insertNode(node$6156);(range$6186=range$6186.cloneRange());(it$0$6202=range$6186);it$0$6202.selectNodeContents(node$6156);it$0$6202.collapse(false);sel$6157.removeAllRanges();return sel$6157.addRange(range$6186);}});(Error.prototype["::repr"]=function(){return format_error$5268(this);});(Repl$5285=function($6217$6228,$6219$6229,$6221$6230,$6223$6231,$6225$6232){var it$0$6235;(it$0$6235=function(){if((!$4769(Repl$5285)(this))){return Object.create(Repl$5285.prototype);}else{return this;}}());(it$0$6235["box"]=$6217$6228);(it$0$6235["target"]=$6219$6229);(it$0$6235["inputbox"]=$6221$6230);(it$0$6235["textarea"]=$6223$6231);(it$0$6235["evaluator"]=$6225$6232);(it$0$6235["url"]="<repl>");(it$0$6235["gen"]=eg$5262.Generator(true));(it$0$6235["multiline"]=false);it$0$6235.setup_cm(it$0$6235.textarea);it$0$6235.set_multiline(false);(it$0$6235["cursor"]=0);(it$0$6235["history"]=[""]);return it$0$6235;});(Repl$5285.prototype["setup_cm"]=function(textarea$6282){var accum$6310;var accum$6382;var accum$6386;var accum$6394;var accum$6435;var accum$6476;var accum$6489;var accum$6493;var accum$6497;var it$0$6286;var self$6287;(it$0$6286=this);(self$6287=this);(it$0$6286["cm"]=CodeMirror$5274.fromTextArea(textarea$6282,({"indentUnit":3,"viewportMargin":(1/0)})));it$0$6286.cm.addKeyMap($4789(((accum$6310=({})),((accum$6310["Enter"]=function($6314$6317){var t0$6326;var $6360$6373;var $6357$6367;var state$6361;var e$6344;var $6322$6341;var $6319$6335;var ph$6323;var cm$6324;(t0$6326=$6314$6317);(cm$6324=t0$6326);(ph$6323=t0$6326);($6319$6335=ph$6323);(e$6344=(cm$6324.lineCount()-1));$6319$6335;if((cm$6324.getCursor().line<e$6344)){return CodeMirror$5274.Pass;}else{(state$6361=cm$6324.getStateAfter(e$6344));($6357$6367=null);$6357$6367;if(((((state$6361.mode!=="code")||(state$6361.nest.length>1))||$4769(RegExp("lowprio|op",""))(state$6361.previous))||((state$6361.nest[0][1]>0)&&(!$4769(RegExp("^\\s*$",""))(cm$6324.getLine(e$6344)))))){return CodeMirror$5274.Pass;}else{return it$0$6286.submit();}}}),accum$6310)),$4789(((accum$6382=({})),((accum$6382["Ctrl-Enter"]="newlineAndIndent"),accum$6382)),$4789(((accum$6386=({})),((accum$6386["Shift-Enter"]=function(cm$6391){return it$0$6286.submit();}),accum$6386)),$4789(((accum$6394=({})),((accum$6394["Up"]=function($6398$6401){var t0$6410;var $6406$6425;var $6403$6419;var ph$6407;var cm$6408;(t0$6410=$6398$6401);(cm$6408=t0$6410);(ph$6407=t0$6410);($6403$6419=ph$6407);$6403$6419;if(((it$0$6286.cursor>0)&&(it$0$6286.cm.getCursor().line===0))){it$0$6286.cm.setValue($4788(it$0$6286.history,(--it$0$6286.cursor)));it$0$6286.cm.setCursor(it$0$6286.cm.lineCount(),0);return it$0$6286.sink();}else{return CodeMirror$5274.Pass;}}),accum$6394)),$4789(((accum$6435=({})),((accum$6435["Down"]=function($6439$6442){var t0$6451;var $6447$6466;var $6444$6460;var ph$6448;var cm$6449;(t0$6451=$6439$6442);(cm$6449=t0$6451);(ph$6448=t0$6451);($6444$6460=ph$6448);$6444$6460;if(((it$0$6286.cursor<(it$0$6286.history.length-1))&&(it$0$6286.cm.getCursor().line===(it$0$6286.cm.lineCount()-1)))){it$0$6286.cm.setValue($4788(it$0$6286.history,(++it$0$6286.cursor)));it$0$6286.cm.setCursor(0,it$0$6286.cm.getLine(0).length);return it$0$6286.sink();}else{return CodeMirror$5274.Pass;}}),accum$6435)),$4789(({"Tab":"indentAuto"}),$4789(((accum$6476=({})),((accum$6476["Ctrl-L"]=function($6480$6483){$6480$6483;return jQuery(it$0$6286.target).empty();}),accum$6476)),$4789(((accum$6489=({})),((accum$6489["Ctrl-A"]="goLineStart"),accum$6489)),$4789(((accum$6493=({})),((accum$6493["Ctrl-E"]="goLineEnd"),accum$6493)),((accum$6497=({})),((accum$6497["Ctrl-K"]="killLine"),accum$6497))))))))))));it$0$6286.cm.setOption("mode","earl-grey");return it$0$6286.cm.setSize("auto","auto");});(Repl$5285.prototype["sink"]=function(){var it$0$6507;var self$6508;(it$0$6507=this);(self$6508=this);return setTimeout(function(){return jQuery(it$0$6507.box).scrollTop(it$0$6507.box.scrollHeight);},0);});(Repl$5285.prototype["add_to_history"]=function(text$6523){var hl$6539;var it$0$6527;var self$6528;(it$0$6527=this);(self$6528=this);(hl$6539=it$0$6527.history.length);if(((text$6523!=="")&&(!((hl$6539>1)&&$8531($4788(it$0$6527.history,(hl$6539-2)),text$6523))))){(it$0$6527.history[(hl$6539-1)]=text$6523);it$0$6527.history.push("");}(it$0$6527["cursor"]=(it$0$6527.history.length-1));});(Repl$5285.prototype["submit"]=function(){var text$6569;var it$0$6558;var self$6559;(it$0$6558=this);(self$6559=this);it$0$6558.set_multiline(false);(text$6569=it$0$6558.cm.getValue());it$0$6558.process(text$6569);it$0$6558.cm.setValue("");return it$0$6558.sink();});(Repl$5285.prototype["set_multiline"]=function($6576$6579){var t0$6597;var $6592$6606;var ph$6595;var it$0$6583;var self$6584;(it$0$6583=this);(self$6584=this);(t0$6597=$6576$6579);(it$0$6583["multiline"]=t0$6597);(ph$6595=t0$6597);($6592$6606=ph$6595);if($6592$6606){return jQuery(it$0$6583.inputbox).addClass("multiline");}else{if((!$6592$6606)){return jQuery(it$0$6583.inputbox).removeClass("multiline");}else{$7868($6592$6606);}}});(Repl$5285.prototype["generate"]=function(text$6626){var it$0$6630;var self$6631;(it$0$6630=this);(self$6631=this);return it$0$6630.gen.generate(eg$5262.Source(text$6626,it$0$6630.url));});(Repl$5285.prototype["eval"]=function(text$6643){var rval$6684;var gen$6659;var handle$6660;var it$0$6647;var self$6648;(it$0$6647=this);(self$6648=this);(gen$6659=function(){var g$6670;(g$6670=it$0$6647.generate(text$6643));return ["success",it$0$6647.evaluator(g$6670)];});(handle$6660=function(e$6679){return ["failure",e$6679];});(rval$6684=false);try{(rval$6684=gen$6659());}catch(excv$6695){var e$6701;(e$6701=excv$6695);(rval$6684=handle$6660(e$6701));}return rval$6684;});(Repl$5285.prototype["process"]=function(){var hl$6772;var error$6825;var value$6820;var n$6810;var $6766$6791;var $6767$6792;var $6768$6793;var $6769$6794;var t0$6788;var t1$6789;var $6760$6783;var real_text$6750;var node$6751;var name$6752;var collapse$6753;var on$6754;var text$6735;var display_in$6736;var t0$6731;var $6714$6726;var it$0$6716;var self$6717;(it$0$6716=this);(self$6717=this);($6714$6726=arguments);(t0$6731=$6714$6726.length);if(((t0$6731>=1)&&(t0$6731<=2))){(text$6735=$6714$6726[0]);(display_in$6736=function(){if((1>=t0$6731)){return true;}else{return $6714$6726[1];}}());it$0$6716.add_to_history(text$6735);(real_text$6750=text$6735);(node$6751=make_dom$5280($8193([".io"],({}),[function(){if(display_in$6736){(hl$6772=[]);CodeMirror$5274.runMode((text$6735||" "),"earl-grey",function(text$6778,style$6779){return hl$6772.push(function(){if(style$6779){return $8193(["span",(".cm-"+style$6779)],({}),text$6778);}else{return $8193(["span"],({}),text$6778);}}());});return $8193([".in"],({}),[$8193([".inbanner"],({}),[]),$8193([".entry"],({}),$8193([".cm-s-default"],({}),hl$6772))]);}else{return "";}}(),((($6760$6783=it$0$6716.eval(real_text$6750))),($6760$6783,function(){if((text$6735.trim()==="")){return "";}else{if((($6766$6791=($6760$6783 instanceof Array))&&(((t0$6788=$6760$6783.length)),(($6768$6793=(t0$6788===2))&&(($6769$6794=($6760$6783[0]==="success"))&&($6760$6783[1]===(void 0))))))){return "";}else{if(($6769$6794&&(((t1$6789=$6760$6783[1])),$4769($8193)(t1$6789)))){(n$6810=t1$6789);return $8193([".display"],({}),n$6810);}else{if($6769$6794){(value$6820=$6760$6783[1]);return $8193([".out"],({}),[$8193([".outbanner"],({}),[]),$8193([".result"],({}),$8193([".eg"],({}),repr$5282(value$6820)))]);}else{if(($6768$6793&&($6760$6783[0]==="failure"))){(error$6825=$6760$6783[1]);return $8193([".err"],({}),[$8193([".errbanner"],({}),[]),$8193([".result"],({}),$8193([".eg"],({}),repr$5282(error$6825)))]);}else{$7868($6760$6783);}}}}}}()))])));(name$6752=gensym$5278());(node$6751["id"]=name$6752);it$0$6716.target.appendChild(node$6751);(collapse$6753=function(e$6841){var at_top$6845;e$6841.stopPropagation();(at_top$6845=$8531((it$0$6716.box.scrollTop+jQuery(it$0$6716.box).height()),it$0$6716.box.scrollHeight));jQuery(this).toggleClass("collapsed");if(at_top$6845){return jQuery(it$0$6716.box).scrollTop(it$0$6716.box.scrollHeight);}});(on$6754=function(sel$6855){return jQuery(((("#"+name$6752)+" ")+sel$6855));});on$6754(".sequence").addClass("complex");on$6754(".object").addClass("complex");on$6754(".complex").click(collapse$6753);on$6754(".complex .complex .complex").addClass("collapsed");on$6754(".error_args.syntax").addClass("collapsed").click(collapse$6753);return on$6754(".traceback").addClass("collapsed").click(collapse$6753);}else{$7868($6714$6726);}});$4789(Repl$5285,$4789(((accum$6863=({})),((accum$6863["::name"]="Repl"),accum$6863)),((accum$6867=({})),((accum$6867["::egclass"]=true),accum$6867))));Repl$5285;(make_cards$5286=function(repl$6874){var accum$7285;var accum$7416;var accum$7559;var accum$7587;var $index$7632;var $length$7626;var temp$7620;var $index$7690;var $length$7684;var temp$7678;var $index$7750;var $length$7744;var temp$7738;var acc$7732;var mktable2$6892;var clickable$6893;var clickable_row$6894;var getcode$6895;var shed$6896;var dispatch$6897;var components$6898;var cards$6899;var files$6900;var Q$6901;var tutorial$6902;var i$6903;(mktable2$6892=function(){var other$6957;var $6940$6945;var $index$6983;var $length$6977;var temp$6971;var acc$6965;var its$6937;var x$6927;var recur$6928;var t0$6923;var $6914$6918;($6914$6918=arguments);(t0$6923=$6914$6918.length);if(((t0$6923>=1)&&(t0$6923<=2))){(x$6927=$6914$6918[0]);(recur$6928=function(){if((1>=t0$6923)){return repr$5282;}else{return $6914$6918[1];}}());(its$6937=((($6940$6945=x$6927)),function(){if($4769(Array)($6940$6945)){return x$6927;}else{(other$6957=$6940$6945);return $7851(x$6927);}}()));return $8193(["table"],({}),(((acc$6965=[])),(((temp$6971=its$6937)),((($length$6977=temp$6971.length)),((($index$6983=0)),function(){$6960:for(;($index$6983<$length$6977);($index$6983++)){var k$7002;var v$7003;var t0$6997;var t1$6998;var m$6992;(m$6992=temp$6971[$index$6983]);(t0$6997=m$6992);if(((t0$6997 instanceof Array)&&(((t1$6998=t0$6997.length)),(t1$6998===2)))){(k$7002=t0$6997[0]);(v$7003=t0$6997[1]);acc$6965.push($8193(["tr"],({}),[$8193(["th"],({}),recur$6928(k$7002,repr$5282)),$8193(["td"],({}),recur$6928(v$7003,repr$5282))]));}else{$7868(m$6992,"/home/olivier/git/egrepl/src/repl.eg",14189,14309);}}}()))),acc$6965));}else{$7868($6914$6918);}});(clickable$6893=function(){var $7061$7066;var click$7049;var cls$7050;var code$7038;var text$7039;var t0$7034;var $7025$7029;($7025$7029=arguments);(t0$7034=$7025$7029.length);if(((t0$7034>=1)&&(t0$7034<=2))){(code$7038=$7025$7029[0]);(text$7039=function(){if((1>=t0$7034)){return null;}else{return $7025$7029[1];}}());(click$7049=function(e$7055){e$7055.preventDefault();repl$6874.process(code$7038);repl$6874.sink();return repl$6874.cm.focus();});(cls$7050=((($7061$7066=code$7038)),function(){if($4769(RegExp("^help",""))($7061$7066)){return ".help";}else{$7061$7066;return ".clickable";}}()));return $8193([cls$7050],({"onclick":click$7049}),[(text$7039||code$7038)]);}else{$7868($7025$7029);}});(clickable_row$6894=function(){var $index$7131;var $length$7125;var temp$7119;var acc$7113;var items$7100;var t0$7096;var $7087$7091;($7087$7091=arguments);(t0$7096=$7087$7091.length);if((t0$7096>=0)){(items$7100=Array.prototype.slice.call($7087$7091,0));return $8193(["span"],({}),(((acc$7113=[])),(((temp$7119=items$7100)),((($length$7125=temp$7119.length)),((($index$7131=0)),function(){$7107:for(;($index$7131<$length$7125);($index$7131++)){var item$7154;var item$7148;var m$7140;(m$7140=temp$7119[$index$7131]);(item$7148=m$7140);if(($index$7131===0)){acc$7113.push(clickable$6893(item$7148));}else{(item$7154=m$7140);acc$7113.push($8193(["span"],({}),[$8193(["span",".separator"],({}),""),clickable$6893(item$7154)]));}}}()))),acc$7113));}else{$7868($7087$7091);}});(getcode$6895=function(node$7164){var t0$7189;var t1$7190;var t2$7191;var $index$7240;var $length$7234;var temp$7228;var acc$7222;var xs$7214;var code$7171;var lines$7172;var indent$7173;var line0$7174;var nindent$7175;(code$7171=shed$6896(node$7164).location.text());(lines$7172=code$7171.split("\n"));$7182:while($4769(RegExp("^ *$",""))(lines$7172[0])){lines$7172.shift();}$7185:while($4769(RegExp("^ *$",""))($4788(lines$7172,(lines$7172.length-1)))){lines$7172.pop();}(t0$7189=$8146(RegExp("( *)(.*)",""))(lines$7172[0]));if((t0$7189[0]&&(((t1$7190=t0$7189[1])),(((t2$7191=t1$7190.length)),(t2$7191===3))))){t1$7190[0];(indent$7173=t1$7190[1]);(line0$7174=t1$7190[2]);}else{$7868(lines$7172[0],"/home/olivier/git/egrepl/src/repl.eg",15097,15112);}(nindent$7175=indent$7173.length);(xs$7214=[line0$7174].concat((((acc$7222=[])),(((temp$7228=lines$7172.slice(1))),((($length$7234=temp$7228.length)),((($index$7240=0)),function(){$7217:for(;($index$7240<$length$7234);($index$7240++)){var line$7257;var m$7249;(m$7249=temp$7228[$index$7240]);(line$7257=m$7249);acc$7222.push(line$7257.slice(nindent$7175));}}()))),acc$7222)));return xs$7214.join("\n");});(shed$6896=function(node$7266){var it$0$7270;(it$0$7270=node$7266);return quaint$5273.shed(it$0$7270);});(dispatch$6897=quaint$5273.dispatch.clone());(components$6898=$4789(((accum$7285=({})),((accum$7285["maybe label / code"]=function(engine$7292,node$7293,$7289$7294){var t0$7302;var $index$7388;var $length$7382;var temp$7376;var acc$7370;var xs2$7362;var xs$7357;var x$7347;var $7332$7343;var $7333$7344;var t0$7341;var $7329$7336;var label$7413;var t0$7318;var $7296$7313;var ph$7299;var code$7300;(t0$7302=$7289$7294);if(($8482(t0$7302,"label")&&((ph$7299=t0$7302.label),$8482(t0$7302,"code")))){(code$7300=t0$7302.code);}else{$7868($7289$7294);}($7296$7313=ph$7299);if((($7296$7313 instanceof Array)&&(((t0$7318=$7296$7313.length)),((t0$7318===2)&&(($7296$7313[0]==="text")&&($7296$7313[1]==="")))))){($7329$7336=quaint$5273.collapse("/",code$7300));if((($7332$7343=($7329$7336 instanceof Array))&&(((t0$7341=$7329$7336.length)),(t0$7341===1)))){(x$7347=$7329$7336[0]);return clickable$6893(getcode$6895(x$7347));}else{if(($7332$7343&&(t0$7341>=0))){(xs$7357=Array.prototype.slice.call($7329$7336,0));(xs2$7362=(((acc$7370=[])),(((temp$7376=xs$7357)),((($length$7382=temp$7376.length)),((($index$7388=0)),function(){$7365:for(;($index$7388<$length$7382);($index$7388++)){var x$7405;var m$7397;(m$7397=temp$7376[$index$7388]);(x$7405=m$7397);acc$7370.push(getcode$6895(x$7405));}}()))),acc$7370));return $4788(clickable_row$6894,xs2$7362);}else{$7868($7329$7336);}}}else{(label$7413=$7296$7313);return clickable$6893(getcode$6895(code$7300),shed$6896(label$7413).location.text());}}),accum$7285)),$4789(((accum$7416=({})),((accum$7416["maybe label /? topic"]=function(engine$7423,node$7424,$7420$7425){var t0$7433;var code$7488;var $index$7525;var $length$7519;var temp$7513;var acc$7507;var xs2$7499;var xs$7494;var x$7478;var $7463$7474;var $7464$7475;var t0$7472;var $7460$7467;var label$7556;var t0$7449;var $7427$7444;var ph$7430;var topic$7431;(t0$7433=$7420$7425);if(($8482(t0$7433,"label")&&((ph$7430=t0$7433.label),$8482(t0$7433,"topic")))){(topic$7431=t0$7433.topic);}else{$7868($7420$7425);}($7427$7444=ph$7430);if((($7427$7444 instanceof Array)&&(((t0$7449=$7427$7444.length)),((t0$7449===2)&&(($7427$7444[0]==="text")&&($7427$7444[1]==="")))))){($7460$7467=quaint$5273.collapse("/",topic$7431));if((($7463$7474=($7460$7467 instanceof Array))&&(((t0$7472=$7460$7467.length)),(t0$7472===1)))){(x$7478=$7460$7467[0]);(code$7488=getcode$6895(x$7478));return clickable$6893(("help "+code$7488),code$7488);}else{if(($7463$7474&&(t0$7472>=0))){(xs$7494=Array.prototype.slice.call($7460$7467,0));(xs2$7499=(((acc$7507=[])),(((temp$7513=xs$7494)),((($length$7519=temp$7513.length)),((($index$7525=0)),function(){$7502:for(;($index$7525<$length$7519);($index$7525++)){var code$7547;var x$7542;var m$7534;(m$7534=temp$7513[$index$7525]);(x$7542=m$7534);acc$7507.push((((code$7547=getcode$6895(x$7542))),getcode$6895(("help "+code$7547),code$7547)));}}()))),acc$7507));return $4788(clickable_row$6894,xs2$7499);}else{$7868($7460$7467);}}}else{(label$7556=$7427$7444);return clickable$6893(getcode$6895(("help "+topic$7431)),shed$6896(label$7556).location.text());}}),accum$7416)),$4789(((accum$7559=({})),((accum$7559["topic --> contents"]=function(engine$7566,node$7567,$7563$7568){var t0$7574;var topic$7571;var contents$7572;(t0$7574=$7563$7568);if(($8482(t0$7574,"topic")&&((topic$7571=t0$7574.topic),$8482(t0$7574,"contents")))){(contents$7572=t0$7574.contents);}else{$7868($7563$7568);}(cards$6899[topic$7571.location.text()]=$8193([".card"],({}),engine$7566.run(contents$7572)));}),accum$7559)),((accum$7587=({})),((accum$7587["topic --> desc --> contents"]=function(engine$7594,node$7595,$7591$7596){var t0$7603;var topic$7599;var desc$7600;var contents$7601;(t0$7603=$7591$7596);if(($8482(t0$7603,"topic")&&((topic$7599=t0$7603.topic),($8482(t0$7603,"desc")&&((desc$7600=t0$7603.desc),$8482(t0$7603,"contents")))))){(contents$7601=t0$7603.contents);}else{$7868($7591$7596);}(cards$6899[topic$7599.location.text()]=$4789($8193([".card"],({}),engine$7594.run(contents$7601)),({"description":engine$7594.run(desc$7600)})));}),accum$7587))))));(temp$7620=$7851(components$6898));($length$7626=temp$7620.length);($index$7632=0);$6904:for(;($index$7632<$length$7626);($index$7632++)){var spec$7651;var fn$7652;var t0$7646;var t1$7647;var m$7641;(m$7641=temp$7620[$index$7632]);(t0$7646=m$7641);if(((t0$7646 instanceof Array)&&(((t1$7647=t0$7646.length)),(t1$7647===2)))){(spec$7651=t0$7646[0]);(fn$7652=t0$7646[1]);dispatch$6897.register(quaint$5273.Spec(spec$7651,fn$7652));}else{$7868(m$7641,"/home/olivier/git/egrepl/src/repl.eg",16684,16776);}}(cards$6899=({}));(files$6900=["\ntut0 -->\n\n  === The Earl Grey programming language\n\n  Earl Grey is a new language that compiles to JavaScript. Why should\n  you care? Good question!\n\n  * Advanced [pattern matching]/[help patterns]\n  * Arbitrary new features can be defined with macros/[help macros]\n\n  ==== What to do from here\n\n  * Peruse /help as a quick start\n  * Consult the index/[help index] for a list of all help topics\n  * Look at examples/[help examples]\n  * ... or simply type or click /next to start the __tutorial!\n\n\n\ntut1 -->\n\n  === Basics\n\n  Click on boxes like /this to evaluate their contents.\n\n  ==== Strings\n\n  / \"hello world\" / [.word] / \"My name is \\\"Olivier\\\"\"\n\n  ==== Numbers\n\n  | __Decimal       | / 1 / 1.4 / 4.93e51\n  | __Hex           | / 16rFF / 16r100 / 16rDEADBEEF / 16r0.8\n  | __[Binary etc.] | / 2r1110 / 3r20 / 36rZAZZ\n\n  ==== Function calls\n\n  | __Call    | / alert{\"Hello!\"} / alert with \"Hello!\"\n  | __Methods | [/ \"hello\".substring{1}]\n\n  /next => variables\n\n\ntut2 -->\n\n  === Variables\n\n  | Declare __read-only | / let x = 1234\n  | Declare __mutable   | / var x = 1234\n  | __Set a variable    | / x = 1234\n\n  Attempting to set a variable that has not yet been declared will\n  create a __read-only variable in the local scope.\n\n  .note ..\n    __Note: as a convenience, all variables declared interactively in\n    the top scope are in fact mutable.\n\n  You can create blocks with their own local variables using `[[]],\n  `let or `where.\n\n  / [[let a = 10, let b = 90, a + b]]\n\n  / let [a = 10, b = 90]: a + b\n\n  /\n    a + b where\n       a = 10\n       b = 90\n\n  Be are that `[[]] only creates a block when it encloses more than\n  one expression. An indented block is completely equivalent to\n  wrapping it in `[[]]~s.\n\n  /next => data structures\n\n\ntut3 -->\n\n  === Data structures\n\n  Earl Grey uses curly braces `{} to define all data structures.\n\n  | __Arrays  | / {1, 2, 3} / {1, {2, 3}} / {\"hello\"}\n  | __Objects | / {name = .Peter, age = 20} / {\"a\" => 123}\n\n  The empty array is `{} and the empty object is `{=}.\n\n  ==== Deconstruction\n\n  You can extract array elements and object fields into variables\n  directly:\n\n  / {x, y} = {11, 22}\n\n  / {x, *rest, y} = {111, 222, 333, 444}\n\n  / {=> name} = {name = .Peter, age = 20}\n\n  ==== Operations\n\n  | __Concatenation   | / {1, 2} ++ {3, 4, 5}\n  | __[Merge objects] | / {name = .Kim} & {age = 39}\n\n  /next => control structures\n\n\ntut4 -->\n\n  === Control structures\n\n  `if and `while are available:\n\n  /\n    if 13 > 0:\n       then: \"This number is positive!\"\n       else: \"This number is negative!\"\n\n  /\n    i = 3\n    while i > 0:\n       alert{i}\n    i--\n\n  Notice that both branches of `if must be nested. The expression form\n  of `if is simply /if{1, .yes, .no}.\n\n  /next => control structures \\[2\\]\n\n\ntut5 -->\n\n  === Control structures \\[2\\]\n\n  Earl Grey's `if nests poorly, so if you want to write many clauses\n  use `match.\n\n  /\n    x = 13\n    match:\n       when x > 0 -> .positive\n       when x < 0 -> .negative\n       when x == 0 -> .zero\n\n  You can also match on the variable directly!\n\n  /\n    x = 13\n    match x:\n       > 0 -> .positive\n       < 0 -> .negative\n       0 -> .zero\n\n  The left hand side of the arrow is a special pattern matching\n  language, whereas `when takes a standard expression.\"\n\n  /next => each\n\n\ntut6 -->\n\n  === `each\n\n  A single operator serves both looping over data structures and list\n  comprehensions.\n\n  / {1, 2, 3} each i -> i * i\n\n  / 1..10 each i -> i * i\n\n  / 1..10 each i when i mod 2 == 0 -> i\n\n  You can have more than one clause.\n\n  /\n    {1, 2, .hello, 4, 72, 99, {}} each\n        String? s -> {s, .string}\n        Number? i when i mod 2 == 0 -> {i, .even}\n        Number? i when i mod 2 == 1 -> {i, .odd}\n        x -> {x, .dunno}\n\n  `first and `last are special patterns.\n\n  /\n    acc = \"\"\n    {.a, .b, .c, .d} each\n       first x -> acc += \"<\" + x\n       last x -> acc += \"; \" + x + \">\"\n       x -> acc += \"; \" + x\n    acc\n\n  /next => functions\n\n\ntut7 -->\n\n  === Functions\n\n  Functions are declared with `[=] or `[->]. For instance, the\n  following are equivalent:\n\n  / f{x, y} = [x * x + y * y] ** 0.5\n\n  / f = {x, y} -> [x * x + y * y] ** 0.5\n\n  It works inside object definitions as well, of course\n\n  / {add1{x} = x + 1, add2{x} = x + 2}\n\n  Pattern matching is deeply integrated in Earl Grey. \"For instance:\"\n\n  /\n    fact{match} =\n       0 or 1 -> 1\n       n -> n * fact{n - 1}\n\n  /next => type checking and coercion\n\n\ntut8 -->\n\n  === Type checking and coercion\n\n  | __[Type checking] | / String? .hello / Number? 1 / Array? .nope / R\"x$\"? .simplex\n  | __Coercion        | / String! {1, 2} / Number! \"3.14\" / Array! .yep\n\n  Both type checking and coercion can be used in patterns. Observe the\n  difference in behavior of the following functions:\n\n  / f{1, \"2\"} where f{x, y} = x + y\n\n  / f{1, \"2\"} where f{Number? x, Number? y} = x + y\n\n  / f{1, \"2\"} where f{Number! x, Number! y} = x + y\n\n  Functions naturally act as coercers:\n\n  / parseInt! x = \"99\"\n\n  ==== Predicates\n\n  You can create your own predicates with the `predicate builtin.\n\n  /\n     predicate! even{x} = x mod 2 == 0\n     even? x = 2  ;; this will succeed\n     even? x = 3  ;; but this will fail\n\n  /next => classes\n\n\ntut9 -->\n\n  === Classes\n\n  Classes are declared with the `class macro. As a convenience, `[@]\n  can be used to refer to fields and members of the instance.\n\n  /\n    class Person:\n       constructor{name, age, job} =\n          @name = name\n          @age = age\n          @job = job\n       hello{} =\n          \"Hello, I am \" + @name + \", \" + @age + \", and I am a \" + @job\n\n  The `new keyword is optional. I prefer to avoid it.\n\n  / Person{.Sonia, 25, .baker}\n\n  / Person{.Jack, 56, \"serial murderer\"}.hello{}\n\n  /next => HTML generation\n\n\ntut10 -->\n\n  === Here, let's have some fun\n\n  The `[%] operator creates structured data which is directly\n  translated as HTML by this evaluation environment. Try these:\n\n  / [b % .hello] / [i % .world]\n\n  We can print out a multiplication table!\n\n  /\n    table % 1..10 each i ->\n       tr % 1..10 each j ->\n          td % i * j\n\n  /next => the end\n\n\ntut11 -->\n\n  === The end\n\n  This is the end of this humble tutorial, but you can keep messing\n  around with the language, it's a lot of fun :\\)\n\n\n","\n\ntopics --> Help starting point -->\n\n   === Help\n\n   ==== Basic topics\n\n   The /?index contains a list of all help topics.\n\n\n\ninterface --> REPL interface (keyboard bindings etc.) -->\n\n  === Keyboard controls\n\n  | `[Up/Down]           | Navigate history\n  | `[Enter/Shift-Enter] | Evaluate an expression\n  | `[Control-l]         | Clear the screen\n  | `[Control-m]         | Toggle multiline mode\n\n\nnumbers --> Numeric values -->\n\n  === Numbers\n\n  Integers and floating point numbers can be written in decimal form\n  with the usual syntax, e.g. /[10 + 89.99]. The semantics are the\n  same as JavaScript.\n\n  Number literals can be written in other bases with the\n  `[<radix>r<int>.<frac>] syntax.\n\n  | __Decimal       | / 1 / 1.4 / 4.93e51\n  | __Hexadecimal   | / 16rFF / 16r100 / 16rDEADBEEF / 16r0.8\n  | __[Binary etc.] | / 2r1110 / 3r20 / 36rZAZZ\n\n  ==== Numerical operations\n\n  | __Addition            | / 10 + 20\n  | __Subtraction         | / 10 - 20\n  | __Multiplication      | / 7 * 9\n  | __Division            | / [10 / 3]\n  | __[Integer division]  | / 10 // 3\n  | __Modulo              | / 24 mod 7\n  | __Exponentiation      | / 3 ** 3\n  | __[Test if number]    | / Number? 31\n  | __[Convert to number] | / Number! \"31\"\n\n\nstrings --> Strings -->\n\n  === Strings\n\n  Strings are delimited by quotation marks (`[\"]):\n\n  / \"Hello world!\"\n\n  The backslash \\\\ can be used to escape quotation marks or create\n  special characters like line breaks:\n\n  / \"Hello, my name is \\\"Olivier\\\"\"\n\n  / \"Line 1\\nLine 2\\nLine 3\"\n\n  A string can span multiple lines:\n\n  /\n    \"this is\n     perfectly acceptable\"\n\n  As a shortcut, purely alphanumeric strings can be denoted with the\n  dot operator: [/[.ABC]], [/[.Peter]], [/[.XYZ == \"XYZ\"]]. Note that\n  if the string is an operator, for instance the `where operator, then\n  it must be written `[\"where\"] or `[.[where]].\n\n\n\nvariables --> Deciaring and setting variables -->\n\n  === Variables\n\n  | Declare __read-only | / let x = 1234\n  | Declare __mutable   | / var x = 1234\n  | __Set a variable    | / x = 1234\n\n  Attempting to set a variable that has not yet been declared will\n  create a __read-only variable in the local scope.\n\n  .note ..\n    __Note: as a convenience, all variables declared interactively in\n    the top scope are in fact mutable.\n\n  You can create blocks/[help blocks] with their own local variables\n  using `[[]], `let or `where.\n\n  / [[let a = 10, let b = 90, a + b]]\n\n  / let [a = 10, b = 90]: a + b\n\n  /\n    a + b where\n       a = 10\n       b = 90\n\n  Be are that `[[]] only creates a block when it encloses more than\n  one expression. An indented block is completely equivalent to\n  wrapping it in `[[]]~s.\n\n\n\n","\nblocks --> Blocks and indent -->\n\n  === Blocks and indent\n\n  A __block is a sequence of statements or expressions. Blocks are\n  defined using square brackets `[[]]. Variables defined inside a\n  block are only valid in expressions within that block.\n\n  `[[]] is also used for __grouping. It only creates a block when it\n  encloses more than one expression, therefore `[[let x = 0]] and\n  `[let x = 0] are completely equivalent with respect to scoping.\n\n  An indented block is completely equivalent to wrapping it in\n  `[[]]~s. For instance these two blocks are equivalent:\n\n  one <-\n    /\n      if 1 > 0: [\n         \"I sure hope so!\"\n      ]\n\n  two <-\n    /\n       if 1 > 0:\n          \"I sure hope so!\"\n\n  | {one} | {two}\n\n  Note that line breaks are always equivalent to commas.\n\n\npredicates --> Predicates (`[pred? x]) -->\n\n  === Predicates\n\n  The expression `[P? x] tests whether `x satisfies the __predicate\n  `P. Here are a few examples from the base language:\n\n  / String? .hello / Number? 1 / Array? .nope / R\"x$\"? .simplex / true? 123\n\n  Predicates can also be used as patterns. As a pattern, a predicate\n  matches a value if and only if that value satisfies the predicate:\n\n  /\n     match \"apple banana cantaloupe\":\n        R\"[^ ]{5,5}\"? -> \"there is a 5-letter word\"\n        else -> \"there are no 5-letter words\"\n\n  Note that predicates do not modify or transform their arguments, but\n  projectors/[help projectors] can.\n\n  ==== Defining a predicate\n\n  To evaluate `[P? x] EG tries each of the following, in sequence:\n\n  # `[P[\"::check\"]{x}] must return a boolean.\n\n  # `instanceof{x, P}: if `P has no `[::check] method, `[P? x]\n    verifies that `x is an instance of `P.\n\n  ==== Simple predicates\n\n  You can create a predicate from a function with `[predicate!]\n\n  /\n     predicate! even{x} =\n        x mod 2 == 0\n     even? x = 2  ;; this will succeed\n     even? x = 3  ;; but this will fail\n\n  `[predicate!] wraps a function to define a `[::check] method. The\n  function can still be called normally, e.g. /even{7}.\n\n\n\nprojectors --> Projectors (`[proj! x]) -->\n\n  === Projectors\n\n  If `P is a predicate or a type it is usual to define `[P! x] to\n  transform `x so that `[P? [P! x]] is true. In other words, it\n  \"projects\" `x to `P~'s value space:\n\n  / String! {1, 2} / Number! \"3.14\" / Array! .yep\n\n  This is not always the case. For instance, [/ R\"(.)(.*)\"! \"abcd\"]\n  returns an array of matches.\n\n  Projectors are especially useful in patterns. For instance we can\n  directly translate the arguments of a function to strings:\n\n  /\n     concat{String! x, String! y} = x + y\n     concat{123, 456}\n\n\n  ==== Defining a projector\n\n  To evaluate `[P! x] EG tries each of the following, in sequence:\n\n  # `[P[\":::project\"]{x}] (_three colons) must return a tuple\n    `{success, value}. If `success is false the match is considered to\n    fail. It should never throw exceptions.\n\n  # `[P[\"::project\"]{x}] (_two colons) must either return a\n    transformed value for `x or throw an exception (the exception\n    means the match is a failure and will therefore be swallowed by\n    the pattern matcher).\n\n  # `P{x}. If `P has no projection methods it is simply called. This\n    means any function is by default a projector:\n\n    /\n       double{x} = x + x\n       double! x = 7\n       x\n\n    Unlike the previous case, exceptions thrown by function projectors\n    are not swallowed by the pattern matcher.\n\n","\nexamples --> List of examples -->\n\n  === Examples\n\n  Click on an example's name to view and execute the code associated\n  to it. If you want to edit the code, you can press `Up to recall it\n  from history, `Control-M to trigger multiline mode (if necessary),\n  and `Control-Enter to resubmit.\n\n\n  ==== Classics\n\n  Fibonacci numbers /\n     fib{match} =\n        0 -> 0\n        1 -> 1\n        n -> fib{n - 1} + fib{n - 2}\n\n     fib{30}\n  [[imperative]] /\n     fib{n} =\n        var {a, b} = {0, 1}\n        1..n each _ ->\n           {a, b} = {b, a + b}\n        a\n\n     fib{30}\n  span.separator ..\n  Factorial numbers /   \n     fact{match} =\n        0 -> 1\n        n -> n * fact{n - 1}\n\n     fact{15}\n\n  The \"99 bottles of beer\" song (long output) /\n     bottle{match} =\n        0 -> \"no more bottles\"\n        1 -> \"one bottle\"\n        n -> [String! n] + \" bottles\"\n     \n     action{match} =\n        0 -> \"Go to the store and buy some more,\"\n        n -> \"Take one down and pass it around,\"\n     \n     capitalize{s} =\n        s[0].toUpperCase{} + s.substring{1}\n     \n     lines = {}\n     0..99 each i ->\n        n = 99 - i\n        lines.push with\n           capitalize{bottle{n}} + \" of beer on the wall, \" + bottle{n} + \" of beer.\"\n           action{n} + \" \" + bottle{[n + 99] mod 100} + \" of beer on the wall.\"\n           \"\"\n     lines.join{\"\\n\"}\n\n\n  ==== Language features\n\n  Point class /\n     class Point:\n        constructor{@x, @y} =\n           pass\n        distance{p} =\n           [dx*dx + dy*dy] ** 0.5 where\n              dx = @x - p.x\n              dy = @y - p.y\n\n     p1 = Point{100, 300}\n     p2 = Point{400, 700}\n     {p1, p2\n      Point? p1, Point? {400, 700}\n      p1.distance{p2}}\n\n\n  ==== Cool tricks\n\n  Local operator redefinition /\n     10 + 90 where\n        a + b = a - b\n\n\n  ==== Macros\n\n  Swap operator /\n     macro [<=>]{*, #data{a, b}}:\n        ;; EG enforces hygiene, so there cannot be a conflict\n        ;; between the \"temp\" variable declared by the macro\n        ;; and other existing variables with the same name\n        '[let temp = ^a\n          ^a = ^b\n          ^b = temp]\n\n     var {foo, bar} = {8, 88}\n     foo <=> bar\n     {foo, bar}\n\n  Unless /\n     macro unless{*, #data{test, body}}:\n        'if{not ^test, ^body}\n\n     unless 0:\n        \"yes\"\n\n  Anonymous function /\n     macro [~]{*, #data{#void{}, body}}:\n        ;; We mark the $ variable to be resolved in the same\n        ;; environment as the body (this must be done for any\n        ;; variable introduced by a macro in order to make it\n        ;; visible)\n        dolla = body.env.mark{'$}\n        ' | {^dolla} -> ^body\n\n     add10 = ~[$ + 10]\n     first4 = ~$.substring{0, 4}\n\n     {add10{91}, first4{\"hello\"}}\n\n"]);(Q$6901=quaint$5273.Engine(dispatch$6897));(temp$7678=files$6900);($length$7684=temp$7678.length);($index$7690=0);$6907:for(;($index$7690<$length$7684);($index$7690++)){var file$7707;var m$7699;(m$7699=temp$7678[$index$7690]);(file$7707=m$7699);Q$6901.run(file$7707);}(tutorial$6902=[]);(i$6903=0);$7715:while($4788(cards$6899,("tut"+String(i$6903)))){tutorial$6902.push($4788(cards$6899,("tut"+String(i$6903))));(i$6903=(i$6903+1));}(tutorial$6902["description"]="Earl Grey tutorial");(cards$6899["tutorial"]=tutorial$6902);(cards$6899["index"]=$8193([".card"],({}),[$8193(["h3"],({}),"Index"),mktable2$6892((((acc$7732=[])),(((temp$7738=$7851(cards$6899).sort())),((($length$7744=temp$7738.length)),((($index$7750=0)),function(){$7727:for(;($index$7750<$length$7744);($index$7750++)){var k$7769;var v$7770;var t0$7764;var t1$7765;var m$7759;(m$7759=temp$7738[$index$7750]);(t0$7764=m$7759);if(((t0$7764 instanceof Array)&&(((t1$7765=t0$7764.length)),((t1$7765===2)&&((k$7769=t0$7764[0]),((v$7770=t0$7764[1]),(!$4769(RegExp("^tut[0-9]+",""))(k$7769)))))))){acc$7732.push([clickable$6893(("help "+k$7769),k$7769),v$7770.description]);}else{false;}}}()))),acc$7732))]));return [cards$6899,Q$6901];});(setup$5287=function(){var t0$7804;var t1$7805;var repl$7798;var engine$7799;(repl$7798=Repl$5285(document.getElementById("box"),document.getElementById("interactive"),document.getElementById("inputbox"),document.getElementById("code"),eval));(t0$7804=make_cards$5286(repl$7798));if(((t0$7804 instanceof Array)&&(((t1$7805=t0$7804.length)),(t1$7805===2)))){(window["_cards"]=t0$7804[0]);(engine$7799=t0$7804[1]);}else{$7868(make_cards$5286(repl$7798),"/home/olivier/git/egrepl/src/repl.eg",17674,17694);}(window["quaint"]=$8704(quaint$5273,({"engine":engine$7799})));repl$7798.eval("\n\n      globals:\n         _cards, alert, document\n         window, _current, _next, _help\n         quaint\n\n      var _current = 0\n\n      _next{} =\n         _current += 1\n         _cards.tutorial[_current]\n\n      _help{match} =\n         \"\" -> _cards.topics\n         topic -> _cards[topic] or [\"Invalid help topic: \\\"\" + topic + \"\\\"\"]\n\n      macro next{_, _, form, _}:\n         '[^form.env.mark{'_next}]{}\n\n      macro help{_, _, form, match}:\n         do: h = form.env.mark{'_help}\n         #symbol{topic} or #value{topic} ->\n            '[^h]{^=topic}\n         #void{} -> '[^h]{\"\"}\n\n      macro Q{_, _, _, arg}:\n         '[.card % quaint.engine.run{^arg}]\n   ");repl$7798.process("_cards.tutorial[0]",false);repl$7798.cm.focus();return repl$7798;});(exports["Repl"]=Repl$5285);(exports["Interactor"]=kb$5261.Interactor);(exports["parse"]=parse$5272);(exports["tokenize"]=tokenize$5270);(exports["Source"]=eg$5262.Source);(exports["make_cards"]=make_cards$5286);(exports["setup"]=setup$5287);

},{"./earlmode":1,"./javascript":2,"./kb":3,"codemirror":7,"codemirror/addon/runmode/runmode":6,"earl-grey/earl-grey":8,"earl-grey/lex":10,"earl-grey/location":11,"earl-grey/parse":13,"earl-grey/util":18,"quaint":19}],"repl":[function(require,module,exports){
module.exports=require('eXk3/i');
},{}],6:[function(require,module,exports){
// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

(function(mod) {
  if (typeof exports == "object" && typeof module == "object") // CommonJS
    mod(require("../../lib/codemirror"));
  else if (typeof define == "function" && define.amd) // AMD
    define(["../../lib/codemirror"], mod);
  else // Plain browser env
    mod(CodeMirror);
})(function(CodeMirror) {
"use strict";

CodeMirror.runMode = function(string, modespec, callback, options) {
  var mode = CodeMirror.getMode(CodeMirror.defaults, modespec);
  var ie = /MSIE \d/.test(navigator.userAgent);
  var ie_lt9 = ie && (document.documentMode == null || document.documentMode < 9);

  if (callback.nodeType == 1) {
    var tabSize = (options && options.tabSize) || CodeMirror.defaults.tabSize;
    var node = callback, col = 0;
    node.innerHTML = "";
    callback = function(text, style) {
      if (text == "\n") {
        // Emitting LF or CRLF on IE8 or earlier results in an incorrect display.
        // Emitting a carriage return makes everything ok.
        node.appendChild(document.createTextNode(ie_lt9 ? '\r' : text));
        col = 0;
        return;
      }
      var content = "";
      // replace tabs
      for (var pos = 0;;) {
        var idx = text.indexOf("\t", pos);
        if (idx == -1) {
          content += text.slice(pos);
          col += text.length - pos;
          break;
        } else {
          col += idx - pos;
          content += text.slice(pos, idx);
          var size = tabSize - col % tabSize;
          col += size;
          for (var i = 0; i < size; ++i) content += " ";
          pos = idx + 1;
        }
      }

      if (style) {
        var sp = node.appendChild(document.createElement("span"));
        sp.className = "cm-" + style.replace(/ +/g, " cm-");
        sp.appendChild(document.createTextNode(content));
      } else {
        node.appendChild(document.createTextNode(content));
      }
    };
  }

  var lines = CodeMirror.splitLines(string), state = (options && options.state) || CodeMirror.startState(mode);
  for (var i = 0, e = lines.length; i < e; ++i) {
    if (i) callback("\n");
    var stream = new CodeMirror.StringStream(lines[i]);
    if (!stream.string && mode.blankLine) mode.blankLine(state);
    while (!stream.eol()) {
      var style = mode.token(stream, state);
      callback(stream.current(), style, i, stream.start, state);
      stream.start = stream.pos;
    }
  }
};

});

},{"../../lib/codemirror":7}],7:[function(require,module,exports){
// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: http://codemirror.net/LICENSE

// This is CodeMirror (http://codemirror.net), a code editor
// implemented in JavaScript on top of the browser's DOM.
//
// You can find some technical background for some of the code below
// at http://marijnhaverbeke.nl/blog/#cm-internals .

(function(mod) {
  if (typeof exports == "object" && typeof module == "object") // CommonJS
    module.exports = mod();
  else if (typeof define == "function" && define.amd) // AMD
    return define([], mod);
  else // Plain browser env
    this.CodeMirror = mod();
})(function() {
  "use strict";

  // BROWSER SNIFFING

  // Kludges for bugs and behavior differences that can't be feature
  // detected are enabled based on userAgent etc sniffing.

  var gecko = /gecko\/\d/i.test(navigator.userAgent);
  // ie_uptoN means Internet Explorer version N or lower
  var ie_upto10 = /MSIE \d/.test(navigator.userAgent);
  var ie_11up = /Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(navigator.userAgent);
  var ie = ie_upto10 || ie_11up;
  var ie_version = ie && (ie_upto10 ? document.documentMode || 6 : ie_11up[1]);
  var webkit = /WebKit\//.test(navigator.userAgent);
  var qtwebkit = webkit && /Qt\/\d+\.\d+/.test(navigator.userAgent);
  var chrome = /Chrome\//.test(navigator.userAgent);
  var presto = /Opera\//.test(navigator.userAgent);
  var safari = /Apple Computer/.test(navigator.vendor);
  var khtml = /KHTML\//.test(navigator.userAgent);
  var mac_geMountainLion = /Mac OS X 1\d\D([8-9]|\d\d)\D/.test(navigator.userAgent);
  var phantom = /PhantomJS/.test(navigator.userAgent);

  var ios = /AppleWebKit/.test(navigator.userAgent) && /Mobile\/\w+/.test(navigator.userAgent);
  // This is woefully incomplete. Suggestions for alternative methods welcome.
  var mobile = ios || /Android|webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(navigator.userAgent);
  var mac = ios || /Mac/.test(navigator.platform);
  var windows = /win/i.test(navigator.platform);

  var presto_version = presto && navigator.userAgent.match(/Version\/(\d*\.\d*)/);
  if (presto_version) presto_version = Number(presto_version[1]);
  if (presto_version && presto_version >= 15) { presto = false; webkit = true; }
  // Some browsers use the wrong event properties to signal cmd/ctrl on OS X
  var flipCtrlCmd = mac && (qtwebkit || presto && (presto_version == null || presto_version < 12.11));
  var captureRightClick = gecko || (ie && ie_version >= 9);

  // Optimize some code when these features are not used.
  var sawReadOnlySpans = false, sawCollapsedSpans = false;

  // EDITOR CONSTRUCTOR

  // A CodeMirror instance represents an editor. This is the object
  // that user code is usually dealing with.

  function CodeMirror(place, options) {
    if (!(this instanceof CodeMirror)) return new CodeMirror(place, options);

    this.options = options = options || {};
    // Determine effective options based on given values and defaults.
    copyObj(defaults, options, false);
    setGuttersForLineNumbers(options);

    var doc = options.value;
    if (typeof doc == "string") doc = new Doc(doc, options.mode);
    this.doc = doc;

    var display = this.display = new Display(place, doc);
    display.wrapper.CodeMirror = this;
    updateGutters(this);
    themeChanged(this);
    if (options.lineWrapping)
      this.display.wrapper.className += " CodeMirror-wrap";
    if (options.autofocus && !mobile) focusInput(this);

    this.state = {
      keyMaps: [],  // stores maps added by addKeyMap
      overlays: [], // highlighting overlays, as added by addOverlay
      modeGen: 0,   // bumped when mode/overlay changes, used to invalidate highlighting info
      overwrite: false, focused: false,
      suppressEdits: false, // used to disable editing during key handlers when in readOnly mode
      pasteIncoming: false, cutIncoming: false, // help recognize paste/cut edits in readInput
      draggingText: false,
      highlight: new Delayed() // stores highlight worker timeout
    };

    // Override magic textarea content restore that IE sometimes does
    // on our hidden textarea on reload
    if (ie && ie_version < 11) setTimeout(bind(resetInput, this, true), 20);

    registerEventHandlers(this);
    ensureGlobalHandlers();

    var cm = this;
    runInOp(this, function() {
      cm.curOp.forceUpdate = true;
      attachDoc(cm, doc);

      if ((options.autofocus && !mobile) || activeElt() == display.input)
        setTimeout(bind(onFocus, cm), 20);
      else
        onBlur(cm);

      for (var opt in optionHandlers) if (optionHandlers.hasOwnProperty(opt))
        optionHandlers[opt](cm, options[opt], Init);
      for (var i = 0; i < initHooks.length; ++i) initHooks[i](cm);
    });
  }

  // DISPLAY CONSTRUCTOR

  // The display handles the DOM integration, both for input reading
  // and content drawing. It holds references to DOM nodes and
  // display-related state.

  function Display(place, doc) {
    var d = this;

    // The semihidden textarea that is focused when the editor is
    // focused, and receives input.
    var input = d.input = elt("textarea", null, null, "position: absolute; padding: 0; width: 1px; height: 1em; outline: none");
    // The textarea is kept positioned near the cursor to prevent the
    // fact that it'll be scrolled into view on input from scrolling
    // our fake cursor out of view. On webkit, when wrap=off, paste is
    // very slow. So make the area wide instead.
    if (webkit) input.style.width = "1000px";
    else input.setAttribute("wrap", "off");
    // If border: 0; -- iOS fails to open keyboard (issue #1287)
    if (ios) input.style.border = "1px solid black";
    input.setAttribute("autocorrect", "off"); input.setAttribute("autocapitalize", "off"); input.setAttribute("spellcheck", "false");

    // Wraps and hides input textarea
    d.inputDiv = elt("div", [input], null, "overflow: hidden; position: relative; width: 3px; height: 0px;");
    // The fake scrollbar elements.
    d.scrollbarH = elt("div", [elt("div", null, null, "height: 100%; min-height: 1px")], "CodeMirror-hscrollbar");
    d.scrollbarV = elt("div", [elt("div", null, null, "min-width: 1px")], "CodeMirror-vscrollbar");
    // Covers bottom-right square when both scrollbars are present.
    d.scrollbarFiller = elt("div", null, "CodeMirror-scrollbar-filler");
    // Covers bottom of gutter when coverGutterNextToScrollbar is on
    // and h scrollbar is present.
    d.gutterFiller = elt("div", null, "CodeMirror-gutter-filler");
    // Will contain the actual code, positioned to cover the viewport.
    d.lineDiv = elt("div", null, "CodeMirror-code");
    // Elements are added to these to represent selection and cursors.
    d.selectionDiv = elt("div", null, null, "position: relative; z-index: 1");
    d.cursorDiv = elt("div", null, "CodeMirror-cursors");
    // A visibility: hidden element used to find the size of things.
    d.measure = elt("div", null, "CodeMirror-measure");
    // When lines outside of the viewport are measured, they are drawn in this.
    d.lineMeasure = elt("div", null, "CodeMirror-measure");
    // Wraps everything that needs to exist inside the vertically-padded coordinate system
    d.lineSpace = elt("div", [d.measure, d.lineMeasure, d.selectionDiv, d.cursorDiv, d.lineDiv],
                      null, "position: relative; outline: none");
    // Moved around its parent to cover visible view.
    d.mover = elt("div", [elt("div", [d.lineSpace], "CodeMirror-lines")], null, "position: relative");
    // Set to the height of the document, allowing scrolling.
    d.sizer = elt("div", [d.mover], "CodeMirror-sizer");
    // Behavior of elts with overflow: auto and padding is
    // inconsistent across browsers. This is used to ensure the
    // scrollable area is big enough.
    d.heightForcer = elt("div", null, null, "position: absolute; height: " + scrollerCutOff + "px; width: 1px;");
    // Will contain the gutters, if any.
    d.gutters = elt("div", null, "CodeMirror-gutters");
    d.lineGutter = null;
    // Actual scrollable element.
    d.scroller = elt("div", [d.sizer, d.heightForcer, d.gutters], "CodeMirror-scroll");
    d.scroller.setAttribute("tabIndex", "-1");
    // The element in which the editor lives.
    d.wrapper = elt("div", [d.inputDiv, d.scrollbarH, d.scrollbarV,
                            d.scrollbarFiller, d.gutterFiller, d.scroller], "CodeMirror");

    // Work around IE7 z-index bug (not perfect, hence IE7 not really being supported)
    if (ie && ie_version < 8) { d.gutters.style.zIndex = -1; d.scroller.style.paddingRight = 0; }
    // Needed to hide big blue blinking cursor on Mobile Safari
    if (ios) input.style.width = "0px";
    if (!webkit) d.scroller.draggable = true;
    // Needed to handle Tab key in KHTML
    if (khtml) { d.inputDiv.style.height = "1px"; d.inputDiv.style.position = "absolute"; }
    // Need to set a minimum width to see the scrollbar on IE7 (but must not set it on IE8).
    if (ie && ie_version < 8) d.scrollbarH.style.minHeight = d.scrollbarV.style.minWidth = "18px";

    if (place.appendChild) place.appendChild(d.wrapper);
    else place(d.wrapper);

    // Current rendered range (may be bigger than the view window).
    d.viewFrom = d.viewTo = doc.first;
    // Information about the rendered lines.
    d.view = [];
    // Holds info about a single rendered line when it was rendered
    // for measurement, while not in view.
    d.externalMeasured = null;
    // Empty space (in pixels) above the view
    d.viewOffset = 0;
    d.lastSizeC = 0;
    d.updateLineNumbers = null;

    // Used to only resize the line number gutter when necessary (when
    // the amount of lines crosses a boundary that makes its width change)
    d.lineNumWidth = d.lineNumInnerWidth = d.lineNumChars = null;
    // See readInput and resetInput
    d.prevInput = "";
    // Set to true when a non-horizontal-scrolling line widget is
    // added. As an optimization, line widget aligning is skipped when
    // this is false.
    d.alignWidgets = false;
    // Flag that indicates whether we expect input to appear real soon
    // now (after some event like 'keypress' or 'input') and are
    // polling intensively.
    d.pollingFast = false;
    // Self-resetting timeout for the poller
    d.poll = new Delayed();

    d.cachedCharWidth = d.cachedTextHeight = d.cachedPaddingH = null;

    // Tracks when resetInput has punted to just putting a short
    // string into the textarea instead of the full selection.
    d.inaccurateSelection = false;

    // Tracks the maximum line length so that the horizontal scrollbar
    // can be kept static when scrolling.
    d.maxLine = null;
    d.maxLineLength = 0;
    d.maxLineChanged = false;

    // Used for measuring wheel scrolling granularity
    d.wheelDX = d.wheelDY = d.wheelStartX = d.wheelStartY = null;

    // True when shift is held down.
    d.shift = false;

    // Used to track whether anything happened since the context menu
    // was opened.
    d.selForContextMenu = null;
  }

  // STATE UPDATES

  // Used to get the editor into a consistent state again when options change.

  function loadMode(cm) {
    cm.doc.mode = CodeMirror.getMode(cm.options, cm.doc.modeOption);
    resetModeState(cm);
  }

  function resetModeState(cm) {
    cm.doc.iter(function(line) {
      if (line.stateAfter) line.stateAfter = null;
      if (line.styles) line.styles = null;
    });
    cm.doc.frontier = cm.doc.first;
    startWorker(cm, 100);
    cm.state.modeGen++;
    if (cm.curOp) regChange(cm);
  }

  function wrappingChanged(cm) {
    if (cm.options.lineWrapping) {
      addClass(cm.display.wrapper, "CodeMirror-wrap");
      cm.display.sizer.style.minWidth = "";
    } else {
      rmClass(cm.display.wrapper, "CodeMirror-wrap");
      findMaxLine(cm);
    }
    estimateLineHeights(cm);
    regChange(cm);
    clearCaches(cm);
    setTimeout(function(){updateScrollbars(cm);}, 100);
  }

  // Returns a function that estimates the height of a line, to use as
  // first approximation until the line becomes visible (and is thus
  // properly measurable).
  function estimateHeight(cm) {
    var th = textHeight(cm.display), wrapping = cm.options.lineWrapping;
    var perLine = wrapping && Math.max(5, cm.display.scroller.clientWidth / charWidth(cm.display) - 3);
    return function(line) {
      if (lineIsHidden(cm.doc, line)) return 0;

      var widgetsHeight = 0;
      if (line.widgets) for (var i = 0; i < line.widgets.length; i++) {
        if (line.widgets[i].height) widgetsHeight += line.widgets[i].height;
      }

      if (wrapping)
        return widgetsHeight + (Math.ceil(line.text.length / perLine) || 1) * th;
      else
        return widgetsHeight + th;
    };
  }

  function estimateLineHeights(cm) {
    var doc = cm.doc, est = estimateHeight(cm);
    doc.iter(function(line) {
      var estHeight = est(line);
      if (estHeight != line.height) updateLineHeight(line, estHeight);
    });
  }

  function keyMapChanged(cm) {
    var map = keyMap[cm.options.keyMap], style = map.style;
    cm.display.wrapper.className = cm.display.wrapper.className.replace(/\s*cm-keymap-\S+/g, "") +
      (style ? " cm-keymap-" + style : "");
  }

  function themeChanged(cm) {
    cm.display.wrapper.className = cm.display.wrapper.className.replace(/\s*cm-s-\S+/g, "") +
      cm.options.theme.replace(/(^|\s)\s*/g, " cm-s-");
    clearCaches(cm);
  }

  function guttersChanged(cm) {
    updateGutters(cm);
    regChange(cm);
    setTimeout(function(){alignHorizontally(cm);}, 20);
  }

  // Rebuild the gutter elements, ensure the margin to the left of the
  // code matches their width.
  function updateGutters(cm) {
    var gutters = cm.display.gutters, specs = cm.options.gutters;
    removeChildren(gutters);
    for (var i = 0; i < specs.length; ++i) {
      var gutterClass = specs[i];
      var gElt = gutters.appendChild(elt("div", null, "CodeMirror-gutter " + gutterClass));
      if (gutterClass == "CodeMirror-linenumbers") {
        cm.display.lineGutter = gElt;
        gElt.style.width = (cm.display.lineNumWidth || 1) + "px";
      }
    }
    gutters.style.display = i ? "" : "none";
    updateGutterSpace(cm);
  }

  function updateGutterSpace(cm) {
    var width = cm.display.gutters.offsetWidth;
    cm.display.sizer.style.marginLeft = width + "px";
    cm.display.scrollbarH.style.left = cm.options.fixedGutter ? width + "px" : 0;
  }

  // Compute the character length of a line, taking into account
  // collapsed ranges (see markText) that might hide parts, and join
  // other lines onto it.
  function lineLength(line) {
    if (line.height == 0) return 0;
    var len = line.text.length, merged, cur = line;
    while (merged = collapsedSpanAtStart(cur)) {
      var found = merged.find(0, true);
      cur = found.from.line;
      len += found.from.ch - found.to.ch;
    }
    cur = line;
    while (merged = collapsedSpanAtEnd(cur)) {
      var found = merged.find(0, true);
      len -= cur.text.length - found.from.ch;
      cur = found.to.line;
      len += cur.text.length - found.to.ch;
    }
    return len;
  }

  // Find the longest line in the document.
  function findMaxLine(cm) {
    var d = cm.display, doc = cm.doc;
    d.maxLine = getLine(doc, doc.first);
    d.maxLineLength = lineLength(d.maxLine);
    d.maxLineChanged = true;
    doc.iter(function(line) {
      var len = lineLength(line);
      if (len > d.maxLineLength) {
        d.maxLineLength = len;
        d.maxLine = line;
      }
    });
  }

  // Make sure the gutters options contains the element
  // "CodeMirror-linenumbers" when the lineNumbers option is true.
  function setGuttersForLineNumbers(options) {
    var found = indexOf(options.gutters, "CodeMirror-linenumbers");
    if (found == -1 && options.lineNumbers) {
      options.gutters = options.gutters.concat(["CodeMirror-linenumbers"]);
    } else if (found > -1 && !options.lineNumbers) {
      options.gutters = options.gutters.slice(0);
      options.gutters.splice(found, 1);
    }
  }

  // SCROLLBARS

  function hScrollbarTakesSpace(cm) {
    return cm.display.scroller.clientHeight - cm.display.wrapper.clientHeight < scrollerCutOff - 3;
  }

  // Prepare DOM reads needed to update the scrollbars. Done in one
  // shot to minimize update/measure roundtrips.
  function measureForScrollbars(cm) {
    var scroll = cm.display.scroller;
    return {
      clientHeight: scroll.clientHeight,
      barHeight: cm.display.scrollbarV.clientHeight,
      scrollWidth: scroll.scrollWidth, clientWidth: scroll.clientWidth,
      hScrollbarTakesSpace: hScrollbarTakesSpace(cm),
      barWidth: cm.display.scrollbarH.clientWidth,
      docHeight: Math.round(cm.doc.height + paddingVert(cm.display))
    };
  }

  // Re-synchronize the fake scrollbars with the actual size of the
  // content.
  function updateScrollbars(cm, measure) {
    if (!measure) measure = measureForScrollbars(cm);
    var d = cm.display, sWidth = scrollbarWidth(d.measure);
    var scrollHeight = measure.docHeight + scrollerCutOff;
    var needsH = measure.scrollWidth > measure.clientWidth;
    if (needsH && measure.scrollWidth <= measure.clientWidth + 1 &&
        sWidth > 0 && !measure.hScrollbarTakesSpace)
      needsH = false; // (Issue #2562)
    var needsV = scrollHeight > measure.clientHeight;

    if (needsV) {
      d.scrollbarV.style.display = "block";
      d.scrollbarV.style.bottom = needsH ? sWidth + "px" : "0";
      // A bug in IE8 can cause this value to be negative, so guard it.
      d.scrollbarV.firstChild.style.height =
        Math.max(0, scrollHeight - measure.clientHeight + (measure.barHeight || d.scrollbarV.clientHeight)) + "px";
    } else {
      d.scrollbarV.style.display = "";
      d.scrollbarV.firstChild.style.height = "0";
    }
    if (needsH) {
      d.scrollbarH.style.display = "block";
      d.scrollbarH.style.right = needsV ? sWidth + "px" : "0";
      d.scrollbarH.firstChild.style.width =
        (measure.scrollWidth - measure.clientWidth + (measure.barWidth || d.scrollbarH.clientWidth)) + "px";
    } else {
      d.scrollbarH.style.display = "";
      d.scrollbarH.firstChild.style.width = "0";
    }
    if (needsH && needsV) {
      d.scrollbarFiller.style.display = "block";
      d.scrollbarFiller.style.height = d.scrollbarFiller.style.width = sWidth + "px";
    } else d.scrollbarFiller.style.display = "";
    if (needsH && cm.options.coverGutterNextToScrollbar && cm.options.fixedGutter) {
      d.gutterFiller.style.display = "block";
      d.gutterFiller.style.height = sWidth + "px";
      d.gutterFiller.style.width = d.gutters.offsetWidth + "px";
    } else d.gutterFiller.style.display = "";

    if (!cm.state.checkedOverlayScrollbar && measure.clientHeight > 0) {
      if (sWidth === 0) {
        var w = mac && !mac_geMountainLion ? "12px" : "18px";
        d.scrollbarV.style.minWidth = d.scrollbarH.style.minHeight = w;
        var barMouseDown = function(e) {
          if (e_target(e) != d.scrollbarV && e_target(e) != d.scrollbarH)
            operation(cm, onMouseDown)(e);
        };
        on(d.scrollbarV, "mousedown", barMouseDown);
        on(d.scrollbarH, "mousedown", barMouseDown);
      }
      cm.state.checkedOverlayScrollbar = true;
    }
  }

  // Compute the lines that are visible in a given viewport (defaults
  // the the current scroll position). viewPort may contain top,
  // height, and ensure (see op.scrollToPos) properties.
  function visibleLines(display, doc, viewPort) {
    var top = viewPort && viewPort.top != null ? Math.max(0, viewPort.top) : display.scroller.scrollTop;
    top = Math.floor(top - paddingTop(display));
    var bottom = viewPort && viewPort.bottom != null ? viewPort.bottom : top + display.wrapper.clientHeight;

    var from = lineAtHeight(doc, top), to = lineAtHeight(doc, bottom);
    // Ensure is a {from: {line, ch}, to: {line, ch}} object, and
    // forces those lines into the viewport (if possible).
    if (viewPort && viewPort.ensure) {
      var ensureFrom = viewPort.ensure.from.line, ensureTo = viewPort.ensure.to.line;
      if (ensureFrom < from)
        return {from: ensureFrom,
                to: lineAtHeight(doc, heightAtLine(getLine(doc, ensureFrom)) + display.wrapper.clientHeight)};
      if (Math.min(ensureTo, doc.lastLine()) >= to)
        return {from: lineAtHeight(doc, heightAtLine(getLine(doc, ensureTo)) - display.wrapper.clientHeight),
                to: ensureTo};
    }
    return {from: from, to: Math.max(to, from + 1)};
  }

  // LINE NUMBERS

  // Re-align line numbers and gutter marks to compensate for
  // horizontal scrolling.
  function alignHorizontally(cm) {
    var display = cm.display, view = display.view;
    if (!display.alignWidgets && (!display.gutters.firstChild || !cm.options.fixedGutter)) return;
    var comp = compensateForHScroll(display) - display.scroller.scrollLeft + cm.doc.scrollLeft;
    var gutterW = display.gutters.offsetWidth, left = comp + "px";
    for (var i = 0; i < view.length; i++) if (!view[i].hidden) {
      if (cm.options.fixedGutter && view[i].gutter)
        view[i].gutter.style.left = left;
      var align = view[i].alignable;
      if (align) for (var j = 0; j < align.length; j++)
        align[j].style.left = left;
    }
    if (cm.options.fixedGutter)
      display.gutters.style.left = (comp + gutterW) + "px";
  }

  // Used to ensure that the line number gutter is still the right
  // size for the current document size. Returns true when an update
  // is needed.
  function maybeUpdateLineNumberWidth(cm) {
    if (!cm.options.lineNumbers) return false;
    var doc = cm.doc, last = lineNumberFor(cm.options, doc.first + doc.size - 1), display = cm.display;
    if (last.length != display.lineNumChars) {
      var test = display.measure.appendChild(elt("div", [elt("div", last)],
                                                 "CodeMirror-linenumber CodeMirror-gutter-elt"));
      var innerW = test.firstChild.offsetWidth, padding = test.offsetWidth - innerW;
      display.lineGutter.style.width = "";
      display.lineNumInnerWidth = Math.max(innerW, display.lineGutter.offsetWidth - padding);
      display.lineNumWidth = display.lineNumInnerWidth + padding;
      display.lineNumChars = display.lineNumInnerWidth ? last.length : -1;
      display.lineGutter.style.width = display.lineNumWidth + "px";
      updateGutterSpace(cm);
      return true;
    }
    return false;
  }

  function lineNumberFor(options, i) {
    return String(options.lineNumberFormatter(i + options.firstLineNumber));
  }

  // Computes display.scroller.scrollLeft + display.gutters.offsetWidth,
  // but using getBoundingClientRect to get a sub-pixel-accurate
  // result.
  function compensateForHScroll(display) {
    return display.scroller.getBoundingClientRect().left - display.sizer.getBoundingClientRect().left;
  }

  // DISPLAY DRAWING

  // Updates the display, selection, and scrollbars, using the
  // information in display.view to find out which nodes are no longer
  // up-to-date. Tries to bail out early when no changes are needed,
  // unless forced is true.
  // Returns true if an actual update happened, false otherwise.
  function updateDisplay(cm, viewPort, forced) {
    var oldFrom = cm.display.viewFrom, oldTo = cm.display.viewTo, updated;
    var visible = visibleLines(cm.display, cm.doc, viewPort);
    for (var first = true;; first = false) {
      var oldWidth = cm.display.scroller.clientWidth;
      if (!updateDisplayInner(cm, visible, forced)) break;
      updated = true;

      // If the max line changed since it was last measured, measure it,
      // and ensure the document's width matches it.
      if (cm.display.maxLineChanged && !cm.options.lineWrapping)
        adjustContentWidth(cm);

      var barMeasure = measureForScrollbars(cm);
      updateSelection(cm);
      setDocumentHeight(cm, barMeasure);
      updateScrollbars(cm, barMeasure);
      if (webkit && cm.options.lineWrapping)
        checkForWebkitWidthBug(cm, barMeasure); // (Issue #2420)
      if (webkit && barMeasure.scrollWidth > barMeasure.clientWidth &&
          barMeasure.scrollWidth < barMeasure.clientWidth + 1 &&
          !hScrollbarTakesSpace(cm))
        updateScrollbars(cm); // (Issue #2562)
      if (first && cm.options.lineWrapping && oldWidth != cm.display.scroller.clientWidth) {
        forced = true;
        continue;
      }
      forced = false;

      // Clip forced viewport to actual scrollable area.
      if (viewPort && viewPort.top != null)
        viewPort = {top: Math.min(barMeasure.docHeight - scrollerCutOff - barMeasure.clientHeight, viewPort.top)};
      // Updated line heights might result in the drawn area not
      // actually covering the viewport. Keep looping until it does.
      visible = visibleLines(cm.display, cm.doc, viewPort);
      if (visible.from >= cm.display.viewFrom && visible.to <= cm.display.viewTo)
        break;
    }

    cm.display.updateLineNumbers = null;
    if (updated) {
      signalLater(cm, "update", cm);
      if (cm.display.viewFrom != oldFrom || cm.display.viewTo != oldTo)
        signalLater(cm, "viewportChange", cm, cm.display.viewFrom, cm.display.viewTo);
    }
    return updated;
  }

  // Does the actual updating of the line display. Bails out
  // (returning false) when there is nothing to be done and forced is
  // false.
  function updateDisplayInner(cm, visible, forced) {
    var display = cm.display, doc = cm.doc;
    if (!display.wrapper.offsetWidth) {
      resetView(cm);
      return;
    }

    // Bail out if the visible area is already rendered and nothing changed.
    if (!forced && visible.from >= display.viewFrom && visible.to <= display.viewTo &&
        (display.updateLineNumbers == null || display.updateLineNumbers >= display.viewTo) &&
        countDirtyView(cm) == 0)
      return;

    if (maybeUpdateLineNumberWidth(cm))
      resetView(cm);
    var dims = getDimensions(cm);

    // Compute a suitable new viewport (from & to)
    var end = doc.first + doc.size;
    var from = Math.max(visible.from - cm.options.viewportMargin, doc.first);
    var to = Math.min(end, visible.to + cm.options.viewportMargin);
    if (display.viewFrom < from && from - display.viewFrom < 20) from = Math.max(doc.first, display.viewFrom);
    if (display.viewTo > to && display.viewTo - to < 20) to = Math.min(end, display.viewTo);
    if (sawCollapsedSpans) {
      from = visualLineNo(cm.doc, from);
      to = visualLineEndNo(cm.doc, to);
    }

    var different = from != display.viewFrom || to != display.viewTo ||
      display.lastSizeC != display.wrapper.clientHeight;
    adjustView(cm, from, to);

    display.viewOffset = heightAtLine(getLine(cm.doc, display.viewFrom));
    // Position the mover div to align with the current scroll position
    cm.display.mover.style.top = display.viewOffset + "px";

    var toUpdate = countDirtyView(cm);
    if (!different && toUpdate == 0 && !forced) return;

    // For big changes, we hide the enclosing element during the
    // update, since that speeds up the operations on most browsers.
    var focused = activeElt();
    if (toUpdate > 4) display.lineDiv.style.display = "none";
    patchDisplay(cm, display.updateLineNumbers, dims);
    if (toUpdate > 4) display.lineDiv.style.display = "";
    // There might have been a widget with a focused element that got
    // hidden or updated, if so re-focus it.
    if (focused && activeElt() != focused && focused.offsetHeight) focused.focus();

    // Prevent selection and cursors from interfering with the scroll
    // width.
    removeChildren(display.cursorDiv);
    removeChildren(display.selectionDiv);

    if (different) {
      display.lastSizeC = display.wrapper.clientHeight;
      startWorker(cm, 400);
    }

    updateHeightsInViewport(cm);

    return true;
  }

  function adjustContentWidth(cm) {
    var display = cm.display;
    var width = measureChar(cm, display.maxLine, display.maxLine.text.length).left;
    display.maxLineChanged = false;
    var minWidth = Math.max(0, width + 3);
    var maxScrollLeft = Math.max(0, display.sizer.offsetLeft + minWidth + scrollerCutOff - display.scroller.clientWidth);
    display.sizer.style.minWidth = minWidth + "px";
    if (maxScrollLeft < cm.doc.scrollLeft)
      setScrollLeft(cm, Math.min(display.scroller.scrollLeft, maxScrollLeft), true);
  }

  function setDocumentHeight(cm, measure) {
    cm.display.sizer.style.minHeight = cm.display.heightForcer.style.top = measure.docHeight + "px";
    cm.display.gutters.style.height = Math.max(measure.docHeight, measure.clientHeight - scrollerCutOff) + "px";
  }

  function checkForWebkitWidthBug(cm, measure) {
    // Work around Webkit bug where it sometimes reserves space for a
    // non-existing phantom scrollbar in the scroller (Issue #2420)
    if (cm.display.sizer.offsetWidth + cm.display.gutters.offsetWidth < cm.display.scroller.clientWidth - 1) {
      cm.display.sizer.style.minHeight = cm.display.heightForcer.style.top = "0px";
      cm.display.gutters.style.height = measure.docHeight + "px";
    }
  }

  // Read the actual heights of the rendered lines, and update their
  // stored heights to match.
  function updateHeightsInViewport(cm) {
    var display = cm.display;
    var prevBottom = display.lineDiv.offsetTop;
    for (var i = 0; i < display.view.length; i++) {
      var cur = display.view[i], height;
      if (cur.hidden) continue;
      if (ie && ie_version < 8) {
        var bot = cur.node.offsetTop + cur.node.offsetHeight;
        height = bot - prevBottom;
        prevBottom = bot;
      } else {
        var box = cur.node.getBoundingClientRect();
        height = box.bottom - box.top;
      }
      var diff = cur.line.height - height;
      if (height < 2) height = textHeight(display);
      if (diff > .001 || diff < -.001) {
        updateLineHeight(cur.line, height);
        updateWidgetHeight(cur.line);
        if (cur.rest) for (var j = 0; j < cur.rest.length; j++)
          updateWidgetHeight(cur.rest[j]);
      }
    }
  }

  // Read and store the height of line widgets associated with the
  // given line.
  function updateWidgetHeight(line) {
    if (line.widgets) for (var i = 0; i < line.widgets.length; ++i)
      line.widgets[i].height = line.widgets[i].node.offsetHeight;
  }

  // Do a bulk-read of the DOM positions and sizes needed to draw the
  // view, so that we don't interleave reading and writing to the DOM.
  function getDimensions(cm) {
    var d = cm.display, left = {}, width = {};
    for (var n = d.gutters.firstChild, i = 0; n; n = n.nextSibling, ++i) {
      left[cm.options.gutters[i]] = n.offsetLeft;
      width[cm.options.gutters[i]] = n.offsetWidth;
    }
    return {fixedPos: compensateForHScroll(d),
            gutterTotalWidth: d.gutters.offsetWidth,
            gutterLeft: left,
            gutterWidth: width,
            wrapperWidth: d.wrapper.clientWidth};
  }

  // Sync the actual display DOM structure with display.view, removing
  // nodes for lines that are no longer in view, and creating the ones
  // that are not there yet, and updating the ones that are out of
  // date.
  function patchDisplay(cm, updateNumbersFrom, dims) {
    var display = cm.display, lineNumbers = cm.options.lineNumbers;
    var container = display.lineDiv, cur = container.firstChild;

    function rm(node) {
      var next = node.nextSibling;
      // Works around a throw-scroll bug in OS X Webkit
      if (webkit && mac && cm.display.currentWheelTarget == node)
        node.style.display = "none";
      else
        node.parentNode.removeChild(node);
      return next;
    }

    var view = display.view, lineN = display.viewFrom;
    // Loop over the elements in the view, syncing cur (the DOM nodes
    // in display.lineDiv) with the view as we go.
    for (var i = 0; i < view.length; i++) {
      var lineView = view[i];
      if (lineView.hidden) {
      } else if (!lineView.node) { // Not drawn yet
        var node = buildLineElement(cm, lineView, lineN, dims);
        container.insertBefore(node, cur);
      } else { // Already drawn
        while (cur != lineView.node) cur = rm(cur);
        var updateNumber = lineNumbers && updateNumbersFrom != null &&
          updateNumbersFrom <= lineN && lineView.lineNumber;
        if (lineView.changes) {
          if (indexOf(lineView.changes, "gutter") > -1) updateNumber = false;
          updateLineForChanges(cm, lineView, lineN, dims);
        }
        if (updateNumber) {
          removeChildren(lineView.lineNumber);
          lineView.lineNumber.appendChild(document.createTextNode(lineNumberFor(cm.options, lineN)));
        }
        cur = lineView.node.nextSibling;
      }
      lineN += lineView.size;
    }
    while (cur) cur = rm(cur);
  }

  // When an aspect of a line changes, a string is added to
  // lineView.changes. This updates the relevant part of the line's
  // DOM structure.
  function updateLineForChanges(cm, lineView, lineN, dims) {
    for (var j = 0; j < lineView.changes.length; j++) {
      var type = lineView.changes[j];
      if (type == "text") updateLineText(cm, lineView);
      else if (type == "gutter") updateLineGutter(cm, lineView, lineN, dims);
      else if (type == "class") updateLineClasses(lineView);
      else if (type == "widget") updateLineWidgets(lineView, dims);
    }
    lineView.changes = null;
  }

  // Lines with gutter elements, widgets or a background class need to
  // be wrapped, and have the extra elements added to the wrapper div
  function ensureLineWrapped(lineView) {
    if (lineView.node == lineView.text) {
      lineView.node = elt("div", null, null, "position: relative");
      if (lineView.text.parentNode)
        lineView.text.parentNode.replaceChild(lineView.node, lineView.text);
      lineView.node.appendChild(lineView.text);
      if (ie && ie_version < 8) lineView.node.style.zIndex = 2;
    }
    return lineView.node;
  }

  function updateLineBackground(lineView) {
    var cls = lineView.bgClass ? lineView.bgClass + " " + (lineView.line.bgClass || "") : lineView.line.bgClass;
    if (cls) cls += " CodeMirror-linebackground";
    if (lineView.background) {
      if (cls) lineView.background.className = cls;
      else { lineView.background.parentNode.removeChild(lineView.background); lineView.background = null; }
    } else if (cls) {
      var wrap = ensureLineWrapped(lineView);
      lineView.background = wrap.insertBefore(elt("div", null, cls), wrap.firstChild);
    }
  }

  // Wrapper around buildLineContent which will reuse the structure
  // in display.externalMeasured when possible.
  function getLineContent(cm, lineView) {
    var ext = cm.display.externalMeasured;
    if (ext && ext.line == lineView.line) {
      cm.display.externalMeasured = null;
      lineView.measure = ext.measure;
      return ext.built;
    }
    return buildLineContent(cm, lineView);
  }

  // Redraw the line's text. Interacts with the background and text
  // classes because the mode may output tokens that influence these
  // classes.
  function updateLineText(cm, lineView) {
    var cls = lineView.text.className;
    var built = getLineContent(cm, lineView);
    if (lineView.text == lineView.node) lineView.node = built.pre;
    lineView.text.parentNode.replaceChild(built.pre, lineView.text);
    lineView.text = built.pre;
    if (built.bgClass != lineView.bgClass || built.textClass != lineView.textClass) {
      lineView.bgClass = built.bgClass;
      lineView.textClass = built.textClass;
      updateLineClasses(lineView);
    } else if (cls) {
      lineView.text.className = cls;
    }
  }

  function updateLineClasses(lineView) {
    updateLineBackground(lineView);
    if (lineView.line.wrapClass)
      ensureLineWrapped(lineView).className = lineView.line.wrapClass;
    else if (lineView.node != lineView.text)
      lineView.node.className = "";
    var textClass = lineView.textClass ? lineView.textClass + " " + (lineView.line.textClass || "") : lineView.line.textClass;
    lineView.text.className = textClass || "";
  }

  function updateLineGutter(cm, lineView, lineN, dims) {
    if (lineView.gutter) {
      lineView.node.removeChild(lineView.gutter);
      lineView.gutter = null;
    }
    var markers = lineView.line.gutterMarkers;
    if (cm.options.lineNumbers || markers) {
      var wrap = ensureLineWrapped(lineView);
      var gutterWrap = lineView.gutter =
        wrap.insertBefore(elt("div", null, "CodeMirror-gutter-wrapper", "position: absolute; left: " +
                              (cm.options.fixedGutter ? dims.fixedPos : -dims.gutterTotalWidth) + "px"),
                          lineView.text);
      if (cm.options.lineNumbers && (!markers || !markers["CodeMirror-linenumbers"]))
        lineView.lineNumber = gutterWrap.appendChild(
          elt("div", lineNumberFor(cm.options, lineN),
              "CodeMirror-linenumber CodeMirror-gutter-elt",
              "left: " + dims.gutterLeft["CodeMirror-linenumbers"] + "px; width: "
              + cm.display.lineNumInnerWidth + "px"));
      if (markers) for (var k = 0; k < cm.options.gutters.length; ++k) {
        var id = cm.options.gutters[k], found = markers.hasOwnProperty(id) && markers[id];
        if (found)
          gutterWrap.appendChild(elt("div", [found], "CodeMirror-gutter-elt", "left: " +
                                     dims.gutterLeft[id] + "px; width: " + dims.gutterWidth[id] + "px"));
      }
    }
  }

  function updateLineWidgets(lineView, dims) {
    if (lineView.alignable) lineView.alignable = null;
    for (var node = lineView.node.firstChild, next; node; node = next) {
      var next = node.nextSibling;
      if (node.className == "CodeMirror-linewidget")
        lineView.node.removeChild(node);
    }
    insertLineWidgets(lineView, dims);
  }

  // Build a line's DOM representation from scratch
  function buildLineElement(cm, lineView, lineN, dims) {
    var built = getLineContent(cm, lineView);
    lineView.text = lineView.node = built.pre;
    if (built.bgClass) lineView.bgClass = built.bgClass;
    if (built.textClass) lineView.textClass = built.textClass;

    updateLineClasses(lineView);
    updateLineGutter(cm, lineView, lineN, dims);
    insertLineWidgets(lineView, dims);
    return lineView.node;
  }

  // A lineView may contain multiple logical lines (when merged by
  // collapsed spans). The widgets for all of them need to be drawn.
  function insertLineWidgets(lineView, dims) {
    insertLineWidgetsFor(lineView.line, lineView, dims, true);
    if (lineView.rest) for (var i = 0; i < lineView.rest.length; i++)
      insertLineWidgetsFor(lineView.rest[i], lineView, dims, false);
  }

  function insertLineWidgetsFor(line, lineView, dims, allowAbove) {
    if (!line.widgets) return;
    var wrap = ensureLineWrapped(lineView);
    for (var i = 0, ws = line.widgets; i < ws.length; ++i) {
      var widget = ws[i], node = elt("div", [widget.node], "CodeMirror-linewidget");
      if (!widget.handleMouseEvents) node.ignoreEvents = true;
      positionLineWidget(widget, node, lineView, dims);
      if (allowAbove && widget.above)
        wrap.insertBefore(node, lineView.gutter || lineView.text);
      else
        wrap.appendChild(node);
      signalLater(widget, "redraw");
    }
  }

  function positionLineWidget(widget, node, lineView, dims) {
    if (widget.noHScroll) {
      (lineView.alignable || (lineView.alignable = [])).push(node);
      var width = dims.wrapperWidth;
      node.style.left = dims.fixedPos + "px";
      if (!widget.coverGutter) {
        width -= dims.gutterTotalWidth;
        node.style.paddingLeft = dims.gutterTotalWidth + "px";
      }
      node.style.width = width + "px";
    }
    if (widget.coverGutter) {
      node.style.zIndex = 5;
      node.style.position = "relative";
      if (!widget.noHScroll) node.style.marginLeft = -dims.gutterTotalWidth + "px";
    }
  }

  // POSITION OBJECT

  // A Pos instance represents a position within the text.
  var Pos = CodeMirror.Pos = function(line, ch) {
    if (!(this instanceof Pos)) return new Pos(line, ch);
    this.line = line; this.ch = ch;
  };

  // Compare two positions, return 0 if they are the same, a negative
  // number when a is less, and a positive number otherwise.
  var cmp = CodeMirror.cmpPos = function(a, b) { return a.line - b.line || a.ch - b.ch; };

  function copyPos(x) {return Pos(x.line, x.ch);}
  function maxPos(a, b) { return cmp(a, b) < 0 ? b : a; }
  function minPos(a, b) { return cmp(a, b) < 0 ? a : b; }

  // SELECTION / CURSOR

  // Selection objects are immutable. A new one is created every time
  // the selection changes. A selection is one or more non-overlapping
  // (and non-touching) ranges, sorted, and an integer that indicates
  // which one is the primary selection (the one that's scrolled into
  // view, that getCursor returns, etc).
  function Selection(ranges, primIndex) {
    this.ranges = ranges;
    this.primIndex = primIndex;
  }

  Selection.prototype = {
    primary: function() { return this.ranges[this.primIndex]; },
    equals: function(other) {
      if (other == this) return true;
      if (other.primIndex != this.primIndex || other.ranges.length != this.ranges.length) return false;
      for (var i = 0; i < this.ranges.length; i++) {
        var here = this.ranges[i], there = other.ranges[i];
        if (cmp(here.anchor, there.anchor) != 0 || cmp(here.head, there.head) != 0) return false;
      }
      return true;
    },
    deepCopy: function() {
      for (var out = [], i = 0; i < this.ranges.length; i++)
        out[i] = new Range(copyPos(this.ranges[i].anchor), copyPos(this.ranges[i].head));
      return new Selection(out, this.primIndex);
    },
    somethingSelected: function() {
      for (var i = 0; i < this.ranges.length; i++)
        if (!this.ranges[i].empty()) return true;
      return false;
    },
    contains: function(pos, end) {
      if (!end) end = pos;
      for (var i = 0; i < this.ranges.length; i++) {
        var range = this.ranges[i];
        if (cmp(end, range.from()) >= 0 && cmp(pos, range.to()) <= 0)
          return i;
      }
      return -1;
    }
  };

  function Range(anchor, head) {
    this.anchor = anchor; this.head = head;
  }

  Range.prototype = {
    from: function() { return minPos(this.anchor, this.head); },
    to: function() { return maxPos(this.anchor, this.head); },
    empty: function() {
      return this.head.line == this.anchor.line && this.head.ch == this.anchor.ch;
    }
  };

  // Take an unsorted, potentially overlapping set of ranges, and
  // build a selection out of it. 'Consumes' ranges array (modifying
  // it).
  function normalizeSelection(ranges, primIndex) {
    var prim = ranges[primIndex];
    ranges.sort(function(a, b) { return cmp(a.from(), b.from()); });
    primIndex = indexOf(ranges, prim);
    for (var i = 1; i < ranges.length; i++) {
      var cur = ranges[i], prev = ranges[i - 1];
      if (cmp(prev.to(), cur.from()) >= 0) {
        var from = minPos(prev.from(), cur.from()), to = maxPos(prev.to(), cur.to());
        var inv = prev.empty() ? cur.from() == cur.head : prev.from() == prev.head;
        if (i <= primIndex) --primIndex;
        ranges.splice(--i, 2, new Range(inv ? to : from, inv ? from : to));
      }
    }
    return new Selection(ranges, primIndex);
  }

  function simpleSelection(anchor, head) {
    return new Selection([new Range(anchor, head || anchor)], 0);
  }

  // Most of the external API clips given positions to make sure they
  // actually exist within the document.
  function clipLine(doc, n) {return Math.max(doc.first, Math.min(n, doc.first + doc.size - 1));}
  function clipPos(doc, pos) {
    if (pos.line < doc.first) return Pos(doc.first, 0);
    var last = doc.first + doc.size - 1;
    if (pos.line > last) return Pos(last, getLine(doc, last).text.length);
    return clipToLen(pos, getLine(doc, pos.line).text.length);
  }
  function clipToLen(pos, linelen) {
    var ch = pos.ch;
    if (ch == null || ch > linelen) return Pos(pos.line, linelen);
    else if (ch < 0) return Pos(pos.line, 0);
    else return pos;
  }
  function isLine(doc, l) {return l >= doc.first && l < doc.first + doc.size;}
  function clipPosArray(doc, array) {
    for (var out = [], i = 0; i < array.length; i++) out[i] = clipPos(doc, array[i]);
    return out;
  }

  // SELECTION UPDATES

  // The 'scroll' parameter given to many of these indicated whether
  // the new cursor position should be scrolled into view after
  // modifying the selection.

  // If shift is held or the extend flag is set, extends a range to
  // include a given position (and optionally a second position).
  // Otherwise, simply returns the range between the given positions.
  // Used for cursor motion and such.
  function extendRange(doc, range, head, other) {
    if (doc.cm && doc.cm.display.shift || doc.extend) {
      var anchor = range.anchor;
      if (other) {
        var posBefore = cmp(head, anchor) < 0;
        if (posBefore != (cmp(other, anchor) < 0)) {
          anchor = head;
          head = other;
        } else if (posBefore != (cmp(head, other) < 0)) {
          head = other;
        }
      }
      return new Range(anchor, head);
    } else {
      return new Range(other || head, head);
    }
  }

  // Extend the primary selection range, discard the rest.
  function extendSelection(doc, head, other, options) {
    setSelection(doc, new Selection([extendRange(doc, doc.sel.primary(), head, other)], 0), options);
  }

  // Extend all selections (pos is an array of selections with length
  // equal the number of selections)
  function extendSelections(doc, heads, options) {
    for (var out = [], i = 0; i < doc.sel.ranges.length; i++)
      out[i] = extendRange(doc, doc.sel.ranges[i], heads[i], null);
    var newSel = normalizeSelection(out, doc.sel.primIndex);
    setSelection(doc, newSel, options);
  }

  // Updates a single range in the selection.
  function replaceOneSelection(doc, i, range, options) {
    var ranges = doc.sel.ranges.slice(0);
    ranges[i] = range;
    setSelection(doc, normalizeSelection(ranges, doc.sel.primIndex), options);
  }

  // Reset the selection to a single range.
  function setSimpleSelection(doc, anchor, head, options) {
    setSelection(doc, simpleSelection(anchor, head), options);
  }

  // Give beforeSelectionChange handlers a change to influence a
  // selection update.
  function filterSelectionChange(doc, sel) {
    var obj = {
      ranges: sel.ranges,
      update: function(ranges) {
        this.ranges = [];
        for (var i = 0; i < ranges.length; i++)
          this.ranges[i] = new Range(clipPos(doc, ranges[i].anchor),
                                     clipPos(doc, ranges[i].head));
      }
    };
    signal(doc, "beforeSelectionChange", doc, obj);
    if (doc.cm) signal(doc.cm, "beforeSelectionChange", doc.cm, obj);
    if (obj.ranges != sel.ranges) return normalizeSelection(obj.ranges, obj.ranges.length - 1);
    else return sel;
  }

  function setSelectionReplaceHistory(doc, sel, options) {
    var done = doc.history.done, last = lst(done);
    if (last && last.ranges) {
      done[done.length - 1] = sel;
      setSelectionNoUndo(doc, sel, options);
    } else {
      setSelection(doc, sel, options);
    }
  }

  // Set a new selection.
  function setSelection(doc, sel, options) {
    setSelectionNoUndo(doc, sel, options);
    addSelectionToHistory(doc, doc.sel, doc.cm ? doc.cm.curOp.id : NaN, options);
  }

  function setSelectionNoUndo(doc, sel, options) {
    if (hasHandler(doc, "beforeSelectionChange") || doc.cm && hasHandler(doc.cm, "beforeSelectionChange"))
      sel = filterSelectionChange(doc, sel);

    var bias = options && options.bias ||
      (cmp(sel.primary().head, doc.sel.primary().head) < 0 ? -1 : 1);
    setSelectionInner(doc, skipAtomicInSelection(doc, sel, bias, true));

    if (!(options && options.scroll === false) && doc.cm)
      ensureCursorVisible(doc.cm);
  }

  function setSelectionInner(doc, sel) {
    if (sel.equals(doc.sel)) return;

    doc.sel = sel;

    if (doc.cm) {
      doc.cm.curOp.updateInput = doc.cm.curOp.selectionChanged = true;
      signalCursorActivity(doc.cm);
    }
    signalLater(doc, "cursorActivity", doc);
  }

  // Verify that the selection does not partially select any atomic
  // marked ranges.
  function reCheckSelection(doc) {
    setSelectionInner(doc, skipAtomicInSelection(doc, doc.sel, null, false), sel_dontScroll);
  }

  // Return a selection that does not partially select any atomic
  // ranges.
  function skipAtomicInSelection(doc, sel, bias, mayClear) {
    var out;
    for (var i = 0; i < sel.ranges.length; i++) {
      var range = sel.ranges[i];
      var newAnchor = skipAtomic(doc, range.anchor, bias, mayClear);
      var newHead = skipAtomic(doc, range.head, bias, mayClear);
      if (out || newAnchor != range.anchor || newHead != range.head) {
        if (!out) out = sel.ranges.slice(0, i);
        out[i] = new Range(newAnchor, newHead);
      }
    }
    return out ? normalizeSelection(out, sel.primIndex) : sel;
  }

  // Ensure a given position is not inside an atomic range.
  function skipAtomic(doc, pos, bias, mayClear) {
    var flipped = false, curPos = pos;
    var dir = bias || 1;
    doc.cantEdit = false;
    search: for (;;) {
      var line = getLine(doc, curPos.line);
      if (line.markedSpans) {
        for (var i = 0; i < line.markedSpans.length; ++i) {
          var sp = line.markedSpans[i], m = sp.marker;
          if ((sp.from == null || (m.inclusiveLeft ? sp.from <= curPos.ch : sp.from < curPos.ch)) &&
              (sp.to == null || (m.inclusiveRight ? sp.to >= curPos.ch : sp.to > curPos.ch))) {
            if (mayClear) {
              signal(m, "beforeCursorEnter");
              if (m.explicitlyCleared) {
                if (!line.markedSpans) break;
                else {--i; continue;}
              }
            }
            if (!m.atomic) continue;
            var newPos = m.find(dir < 0 ? -1 : 1);
            if (cmp(newPos, curPos) == 0) {
              newPos.ch += dir;
              if (newPos.ch < 0) {
                if (newPos.line > doc.first) newPos = clipPos(doc, Pos(newPos.line - 1));
                else newPos = null;
              } else if (newPos.ch > line.text.length) {
                if (newPos.line < doc.first + doc.size - 1) newPos = Pos(newPos.line + 1, 0);
                else newPos = null;
              }
              if (!newPos) {
                if (flipped) {
                  // Driven in a corner -- no valid cursor position found at all
                  // -- try again *with* clearing, if we didn't already
                  if (!mayClear) return skipAtomic(doc, pos, bias, true);
                  // Otherwise, turn off editing until further notice, and return the start of the doc
                  doc.cantEdit = true;
                  return Pos(doc.first, 0);
                }
                flipped = true; newPos = pos; dir = -dir;
              }
            }
            curPos = newPos;
            continue search;
          }
        }
      }
      return curPos;
    }
  }

  // SELECTION DRAWING

  // Redraw the selection and/or cursor
  function updateSelection(cm) {
    var display = cm.display, doc = cm.doc;
    var curFragment = document.createDocumentFragment();
    var selFragment = document.createDocumentFragment();

    for (var i = 0; i < doc.sel.ranges.length; i++) {
      var range = doc.sel.ranges[i];
      var collapsed = range.empty();
      if (collapsed || cm.options.showCursorWhenSelecting)
        drawSelectionCursor(cm, range, curFragment);
      if (!collapsed)
        drawSelectionRange(cm, range, selFragment);
    }

    // Move the hidden textarea near the cursor to prevent scrolling artifacts
    if (cm.options.moveInputWithCursor) {
      var headPos = cursorCoords(cm, doc.sel.primary().head, "div");
      var wrapOff = display.wrapper.getBoundingClientRect(), lineOff = display.lineDiv.getBoundingClientRect();
      var top = Math.max(0, Math.min(display.wrapper.clientHeight - 10,
                                     headPos.top + lineOff.top - wrapOff.top));
      var left = Math.max(0, Math.min(display.wrapper.clientWidth - 10,
                                      headPos.left + lineOff.left - wrapOff.left));
      display.inputDiv.style.top = top + "px";
      display.inputDiv.style.left = left + "px";
    }

    removeChildrenAndAdd(display.cursorDiv, curFragment);
    removeChildrenAndAdd(display.selectionDiv, selFragment);
  }

  // Draws a cursor for the given range
  function drawSelectionCursor(cm, range, output) {
    var pos = cursorCoords(cm, range.head, "div", null, null, !cm.options.singleCursorHeightPerLine);

    var cursor = output.appendChild(elt("div", "\u00a0", "CodeMirror-cursor"));
    cursor.style.left = pos.left + "px";
    cursor.style.top = pos.top + "px";
    cursor.style.height = Math.max(0, pos.bottom - pos.top) * cm.options.cursorHeight + "px";

    if (pos.other) {
      // Secondary cursor, shown when on a 'jump' in bi-directional text
      var otherCursor = output.appendChild(elt("div", "\u00a0", "CodeMirror-cursor CodeMirror-secondarycursor"));
      otherCursor.style.display = "";
      otherCursor.style.left = pos.other.left + "px";
      otherCursor.style.top = pos.other.top + "px";
      otherCursor.style.height = (pos.other.bottom - pos.other.top) * .85 + "px";
    }
  }

  // Draws the given range as a highlighted selection
  function drawSelectionRange(cm, range, output) {
    var display = cm.display, doc = cm.doc;
    var fragment = document.createDocumentFragment();
    var padding = paddingH(cm.display), leftSide = padding.left, rightSide = display.lineSpace.offsetWidth - padding.right;

    function add(left, top, width, bottom) {
      if (top < 0) top = 0;
      top = Math.round(top);
      bottom = Math.round(bottom);
      fragment.appendChild(elt("div", null, "CodeMirror-selected", "position: absolute; left: " + left +
                               "px; top: " + top + "px; width: " + (width == null ? rightSide - left : width) +
                               "px; height: " + (bottom - top) + "px"));
    }

    function drawForLine(line, fromArg, toArg) {
      var lineObj = getLine(doc, line);
      var lineLen = lineObj.text.length;
      var start, end;
      function coords(ch, bias) {
        return charCoords(cm, Pos(line, ch), "div", lineObj, bias);
      }

      iterateBidiSections(getOrder(lineObj), fromArg || 0, toArg == null ? lineLen : toArg, function(from, to, dir) {
        var leftPos = coords(from, "left"), rightPos, left, right;
        if (from == to) {
          rightPos = leftPos;
          left = right = leftPos.left;
        } else {
          rightPos = coords(to - 1, "right");
          if (dir == "rtl") { var tmp = leftPos; leftPos = rightPos; rightPos = tmp; }
          left = leftPos.left;
          right = rightPos.right;
        }
        if (fromArg == null && from == 0) left = leftSide;
        if (rightPos.top - leftPos.top > 3) { // Different lines, draw top part
          add(left, leftPos.top, null, leftPos.bottom);
          left = leftSide;
          if (leftPos.bottom < rightPos.top) add(left, leftPos.bottom, null, rightPos.top);
        }
        if (toArg == null && to == lineLen) right = rightSide;
        if (!start || leftPos.top < start.top || leftPos.top == start.top && leftPos.left < start.left)
          start = leftPos;
        if (!end || rightPos.bottom > end.bottom || rightPos.bottom == end.bottom && rightPos.right > end.right)
          end = rightPos;
        if (left < leftSide + 1) left = leftSide;
        add(left, rightPos.top, right - left, rightPos.bottom);
      });
      return {start: start, end: end};
    }

    var sFrom = range.from(), sTo = range.to();
    if (sFrom.line == sTo.line) {
      drawForLine(sFrom.line, sFrom.ch, sTo.ch);
    } else {
      var fromLine = getLine(doc, sFrom.line), toLine = getLine(doc, sTo.line);
      var singleVLine = visualLine(fromLine) == visualLine(toLine);
      var leftEnd = drawForLine(sFrom.line, sFrom.ch, singleVLine ? fromLine.text.length + 1 : null).end;
      var rightStart = drawForLine(sTo.line, singleVLine ? 0 : null, sTo.ch).start;
      if (singleVLine) {
        if (leftEnd.top < rightStart.top - 2) {
          add(leftEnd.right, leftEnd.top, null, leftEnd.bottom);
          add(leftSide, rightStart.top, rightStart.left, rightStart.bottom);
        } else {
          add(leftEnd.right, leftEnd.top, rightStart.left - leftEnd.right, leftEnd.bottom);
        }
      }
      if (leftEnd.bottom < rightStart.top)
        add(leftSide, leftEnd.bottom, null, rightStart.top);
    }

    output.appendChild(fragment);
  }

  // Cursor-blinking
  function restartBlink(cm) {
    if (!cm.state.focused) return;
    var display = cm.display;
    clearInterval(display.blinker);
    var on = true;
    display.cursorDiv.style.visibility = "";
    if (cm.options.cursorBlinkRate > 0)
      display.blinker = setInterval(function() {
        display.cursorDiv.style.visibility = (on = !on) ? "" : "hidden";
      }, cm.options.cursorBlinkRate);
    else if (cm.options.cursorBlinkRate < 0)
      display.cursorDiv.style.visibility = "hidden";
  }

  // HIGHLIGHT WORKER

  function startWorker(cm, time) {
    if (cm.doc.mode.startState && cm.doc.frontier < cm.display.viewTo)
      cm.state.highlight.set(time, bind(highlightWorker, cm));
  }

  function highlightWorker(cm) {
    var doc = cm.doc;
    if (doc.frontier < doc.first) doc.frontier = doc.first;
    if (doc.frontier >= cm.display.viewTo) return;
    var end = +new Date + cm.options.workTime;
    var state = copyState(doc.mode, getStateBefore(cm, doc.frontier));

    runInOp(cm, function() {
    doc.iter(doc.frontier, Math.min(doc.first + doc.size, cm.display.viewTo + 500), function(line) {
      if (doc.frontier >= cm.display.viewFrom) { // Visible
        var oldStyles = line.styles;
        var highlighted = highlightLine(cm, line, state, true);
        line.styles = highlighted.styles;
        var oldCls = line.styleClasses, newCls = highlighted.classes;
        if (newCls) line.styleClasses = newCls;
        else if (oldCls) line.styleClasses = null;
        var ischange = !oldStyles || oldStyles.length != line.styles.length ||
          oldCls != newCls && (!oldCls || !newCls || oldCls.bgClass != newCls.bgClass || oldCls.textClass != newCls.textClass);
        for (var i = 0; !ischange && i < oldStyles.length; ++i) ischange = oldStyles[i] != line.styles[i];
        if (ischange) regLineChange(cm, doc.frontier, "text");
        line.stateAfter = copyState(doc.mode, state);
      } else {
        processLine(cm, line.text, state);
        line.stateAfter = doc.frontier % 5 == 0 ? copyState(doc.mode, state) : null;
      }
      ++doc.frontier;
      if (+new Date > end) {
        startWorker(cm, cm.options.workDelay);
        return true;
      }
    });
    });
  }

  // Finds the line to start with when starting a parse. Tries to
  // find a line with a stateAfter, so that it can start with a
  // valid state. If that fails, it returns the line with the
  // smallest indentation, which tends to need the least context to
  // parse correctly.
  function findStartLine(cm, n, precise) {
    var minindent, minline, doc = cm.doc;
    var lim = precise ? -1 : n - (cm.doc.mode.innerMode ? 1000 : 100);
    for (var search = n; search > lim; --search) {
      if (search <= doc.first) return doc.first;
      var line = getLine(doc, search - 1);
      if (line.stateAfter && (!precise || search <= doc.frontier)) return search;
      var indented = countColumn(line.text, null, cm.options.tabSize);
      if (minline == null || minindent > indented) {
        minline = search - 1;
        minindent = indented;
      }
    }
    return minline;
  }

  function getStateBefore(cm, n, precise) {
    var doc = cm.doc, display = cm.display;
    if (!doc.mode.startState) return true;
    var pos = findStartLine(cm, n, precise), state = pos > doc.first && getLine(doc, pos-1).stateAfter;
    if (!state) state = startState(doc.mode);
    else state = copyState(doc.mode, state);
    doc.iter(pos, n, function(line) {
      processLine(cm, line.text, state);
      var save = pos == n - 1 || pos % 5 == 0 || pos >= display.viewFrom && pos < display.viewTo;
      line.stateAfter = save ? copyState(doc.mode, state) : null;
      ++pos;
    });
    if (precise) doc.frontier = pos;
    return state;
  }

  // POSITION MEASUREMENT

  function paddingTop(display) {return display.lineSpace.offsetTop;}
  function paddingVert(display) {return display.mover.offsetHeight - display.lineSpace.offsetHeight;}
  function paddingH(display) {
    if (display.cachedPaddingH) return display.cachedPaddingH;
    var e = removeChildrenAndAdd(display.measure, elt("pre", "x"));
    var style = window.getComputedStyle ? window.getComputedStyle(e) : e.currentStyle;
    var data = {left: parseInt(style.paddingLeft), right: parseInt(style.paddingRight)};
    if (!isNaN(data.left) && !isNaN(data.right)) display.cachedPaddingH = data;
    return data;
  }

  // Ensure the lineView.wrapping.heights array is populated. This is
  // an array of bottom offsets for the lines that make up a drawn
  // line. When lineWrapping is on, there might be more than one
  // height.
  function ensureLineHeights(cm, lineView, rect) {
    var wrapping = cm.options.lineWrapping;
    var curWidth = wrapping && cm.display.scroller.clientWidth;
    if (!lineView.measure.heights || wrapping && lineView.measure.width != curWidth) {
      var heights = lineView.measure.heights = [];
      if (wrapping) {
        lineView.measure.width = curWidth;
        var rects = lineView.text.firstChild.getClientRects();
        for (var i = 0; i < rects.length - 1; i++) {
          var cur = rects[i], next = rects[i + 1];
          if (Math.abs(cur.bottom - next.bottom) > 2)
            heights.push((cur.bottom + next.top) / 2 - rect.top);
        }
      }
      heights.push(rect.bottom - rect.top);
    }
  }

  // Find a line map (mapping character offsets to text nodes) and a
  // measurement cache for the given line number. (A line view might
  // contain multiple lines when collapsed ranges are present.)
  function mapFromLineView(lineView, line, lineN) {
    if (lineView.line == line)
      return {map: lineView.measure.map, cache: lineView.measure.cache};
    for (var i = 0; i < lineView.rest.length; i++)
      if (lineView.rest[i] == line)
        return {map: lineView.measure.maps[i], cache: lineView.measure.caches[i]};
    for (var i = 0; i < lineView.rest.length; i++)
      if (lineNo(lineView.rest[i]) > lineN)
        return {map: lineView.measure.maps[i], cache: lineView.measure.caches[i], before: true};
  }

  // Render a line into the hidden node display.externalMeasured. Used
  // when measurement is needed for a line that's not in the viewport.
  function updateExternalMeasurement(cm, line) {
    line = visualLine(line);
    var lineN = lineNo(line);
    var view = cm.display.externalMeasured = new LineView(cm.doc, line, lineN);
    view.lineN = lineN;
    var built = view.built = buildLineContent(cm, view);
    view.text = built.pre;
    removeChildrenAndAdd(cm.display.lineMeasure, built.pre);
    return view;
  }

  // Get a {top, bottom, left, right} box (in line-local coordinates)
  // for a given character.
  function measureChar(cm, line, ch, bias) {
    return measureCharPrepared(cm, prepareMeasureForLine(cm, line), ch, bias);
  }

  // Find a line view that corresponds to the given line number.
  function findViewForLine(cm, lineN) {
    if (lineN >= cm.display.viewFrom && lineN < cm.display.viewTo)
      return cm.display.view[findViewIndex(cm, lineN)];
    var ext = cm.display.externalMeasured;
    if (ext && lineN >= ext.lineN && lineN < ext.lineN + ext.size)
      return ext;
  }

  // Measurement can be split in two steps, the set-up work that
  // applies to the whole line, and the measurement of the actual
  // character. Functions like coordsChar, that need to do a lot of
  // measurements in a row, can thus ensure that the set-up work is
  // only done once.
  function prepareMeasureForLine(cm, line) {
    var lineN = lineNo(line);
    var view = findViewForLine(cm, lineN);
    if (view && !view.text)
      view = null;
    else if (view && view.changes)
      updateLineForChanges(cm, view, lineN, getDimensions(cm));
    if (!view)
      view = updateExternalMeasurement(cm, line);

    var info = mapFromLineView(view, line, lineN);
    return {
      line: line, view: view, rect: null,
      map: info.map, cache: info.cache, before: info.before,
      hasHeights: false
    };
  }

  // Given a prepared measurement object, measures the position of an
  // actual character (or fetches it from the cache).
  function measureCharPrepared(cm, prepared, ch, bias, varHeight) {
    if (prepared.before) ch = -1;
    var key = ch + (bias || ""), found;
    if (prepared.cache.hasOwnProperty(key)) {
      found = prepared.cache[key];
    } else {
      if (!prepared.rect)
        prepared.rect = prepared.view.text.getBoundingClientRect();
      if (!prepared.hasHeights) {
        ensureLineHeights(cm, prepared.view, prepared.rect);
        prepared.hasHeights = true;
      }
      found = measureCharInner(cm, prepared, ch, bias);
      if (!found.bogus) prepared.cache[key] = found;
    }
    return {left: found.left, right: found.right,
            top: varHeight ? found.rtop : found.top,
            bottom: varHeight ? found.rbottom : found.bottom};
  }

  var nullRect = {left: 0, right: 0, top: 0, bottom: 0};

  function measureCharInner(cm, prepared, ch, bias) {
    var map = prepared.map;

    var node, start, end, collapse;
    // First, search the line map for the text node corresponding to,
    // or closest to, the target character.
    for (var i = 0; i < map.length; i += 3) {
      var mStart = map[i], mEnd = map[i + 1];
      if (ch < mStart) {
        start = 0; end = 1;
        collapse = "left";
      } else if (ch < mEnd) {
        start = ch - mStart;
        end = start + 1;
      } else if (i == map.length - 3 || ch == mEnd && map[i + 3] > ch) {
        end = mEnd - mStart;
        start = end - 1;
        if (ch >= mEnd) collapse = "right";
      }
      if (start != null) {
        node = map[i + 2];
        if (mStart == mEnd && bias == (node.insertLeft ? "left" : "right"))
          collapse = bias;
        if (bias == "left" && start == 0)
          while (i && map[i - 2] == map[i - 3] && map[i - 1].insertLeft) {
            node = map[(i -= 3) + 2];
            collapse = "left";
          }
        if (bias == "right" && start == mEnd - mStart)
          while (i < map.length - 3 && map[i + 3] == map[i + 4] && !map[i + 5].insertLeft) {
            node = map[(i += 3) + 2];
            collapse = "right";
          }
        break;
      }
    }

    var rect;
    if (node.nodeType == 3) { // If it is a text node, use a range to retrieve the coordinates.
      while (start && isExtendingChar(prepared.line.text.charAt(mStart + start))) --start;
      while (mStart + end < mEnd && isExtendingChar(prepared.line.text.charAt(mStart + end))) ++end;
      if (ie && ie_version < 9 && start == 0 && end == mEnd - mStart) {
        rect = node.parentNode.getBoundingClientRect();
      } else if (ie && cm.options.lineWrapping) {
        var rects = range(node, start, end).getClientRects();
        if (rects.length)
          rect = rects[bias == "right" ? rects.length - 1 : 0];
        else
          rect = nullRect;
      } else {
        rect = range(node, start, end).getBoundingClientRect() || nullRect;
      }
    } else { // If it is a widget, simply get the box for the whole widget.
      if (start > 0) collapse = bias = "right";
      var rects;
      if (cm.options.lineWrapping && (rects = node.getClientRects()).length > 1)
        rect = rects[bias == "right" ? rects.length - 1 : 0];
      else
        rect = node.getBoundingClientRect();
    }
    if (ie && ie_version < 9 && !start && (!rect || !rect.left && !rect.right)) {
      var rSpan = node.parentNode.getClientRects()[0];
      if (rSpan)
        rect = {left: rSpan.left, right: rSpan.left + charWidth(cm.display), top: rSpan.top, bottom: rSpan.bottom};
      else
        rect = nullRect;
    }

    var rtop = rect.top - prepared.rect.top, rbot = rect.bottom - prepared.rect.top;
    var mid = (rtop + rbot) / 2;
    var heights = prepared.view.measure.heights;
    for (var i = 0; i < heights.length - 1; i++)
      if (mid < heights[i]) break;
    var top = i ? heights[i - 1] : 0, bot = heights[i];
    var result = {left: (collapse == "right" ? rect.right : rect.left) - prepared.rect.left,
                  right: (collapse == "left" ? rect.left : rect.right) - prepared.rect.left,
                  top: top, bottom: bot};
    if (!rect.left && !rect.right) result.bogus = true;
    if (!cm.options.singleCursorHeightPerLine) { result.rtop = rtop; result.rbottom = rbot; }
    return result;
  }

  function clearLineMeasurementCacheFor(lineView) {
    if (lineView.measure) {
      lineView.measure.cache = {};
      lineView.measure.heights = null;
      if (lineView.rest) for (var i = 0; i < lineView.rest.length; i++)
        lineView.measure.caches[i] = {};
    }
  }

  function clearLineMeasurementCache(cm) {
    cm.display.externalMeasure = null;
    removeChildren(cm.display.lineMeasure);
    for (var i = 0; i < cm.display.view.length; i++)
      clearLineMeasurementCacheFor(cm.display.view[i]);
  }

  function clearCaches(cm) {
    clearLineMeasurementCache(cm);
    cm.display.cachedCharWidth = cm.display.cachedTextHeight = cm.display.cachedPaddingH = null;
    if (!cm.options.lineWrapping) cm.display.maxLineChanged = true;
    cm.display.lineNumChars = null;
  }

  function pageScrollX() { return window.pageXOffset || (document.documentElement || document.body).scrollLeft; }
  function pageScrollY() { return window.pageYOffset || (document.documentElement || document.body).scrollTop; }

  // Converts a {top, bottom, left, right} box from line-local
  // coordinates into another coordinate system. Context may be one of
  // "line", "div" (display.lineDiv), "local"/null (editor), or "page".
  function intoCoordSystem(cm, lineObj, rect, context) {
    if (lineObj.widgets) for (var i = 0; i < lineObj.widgets.length; ++i) if (lineObj.widgets[i].above) {
      var size = widgetHeight(lineObj.widgets[i]);
      rect.top += size; rect.bottom += size;
    }
    if (context == "line") return rect;
    if (!context) context = "local";
    var yOff = heightAtLine(lineObj);
    if (context == "local") yOff += paddingTop(cm.display);
    else yOff -= cm.display.viewOffset;
    if (context == "page" || context == "window") {
      var lOff = cm.display.lineSpace.getBoundingClientRect();
      yOff += lOff.top + (context == "window" ? 0 : pageScrollY());
      var xOff = lOff.left + (context == "window" ? 0 : pageScrollX());
      rect.left += xOff; rect.right += xOff;
    }
    rect.top += yOff; rect.bottom += yOff;
    return rect;
  }

  // Coverts a box from "div" coords to another coordinate system.
  // Context may be "window", "page", "div", or "local"/null.
  function fromCoordSystem(cm, coords, context) {
    if (context == "div") return coords;
    var left = coords.left, top = coords.top;
    // First move into "page" coordinate system
    if (context == "page") {
      left -= pageScrollX();
      top -= pageScrollY();
    } else if (context == "local" || !context) {
      var localBox = cm.display.sizer.getBoundingClientRect();
      left += localBox.left;
      top += localBox.top;
    }

    var lineSpaceBox = cm.display.lineSpace.getBoundingClientRect();
    return {left: left - lineSpaceBox.left, top: top - lineSpaceBox.top};
  }

  function charCoords(cm, pos, context, lineObj, bias) {
    if (!lineObj) lineObj = getLine(cm.doc, pos.line);
    return intoCoordSystem(cm, lineObj, measureChar(cm, lineObj, pos.ch, bias), context);
  }

  // Returns a box for a given cursor position, which may have an
  // 'other' property containing the position of the secondary cursor
  // on a bidi boundary.
  function cursorCoords(cm, pos, context, lineObj, preparedMeasure, varHeight) {
    lineObj = lineObj || getLine(cm.doc, pos.line);
    if (!preparedMeasure) preparedMeasure = prepareMeasureForLine(cm, lineObj);
    function get(ch, right) {
      var m = measureCharPrepared(cm, preparedMeasure, ch, right ? "right" : "left", varHeight);
      if (right) m.left = m.right; else m.right = m.left;
      return intoCoordSystem(cm, lineObj, m, context);
    }
    function getBidi(ch, partPos) {
      var part = order[partPos], right = part.level % 2;
      if (ch == bidiLeft(part) && partPos && part.level < order[partPos - 1].level) {
        part = order[--partPos];
        ch = bidiRight(part) - (part.level % 2 ? 0 : 1);
        right = true;
      } else if (ch == bidiRight(part) && partPos < order.length - 1 && part.level < order[partPos + 1].level) {
        part = order[++partPos];
        ch = bidiLeft(part) - part.level % 2;
        right = false;
      }
      if (right && ch == part.to && ch > part.from) return get(ch - 1);
      return get(ch, right);
    }
    var order = getOrder(lineObj), ch = pos.ch;
    if (!order) return get(ch);
    var partPos = getBidiPartAt(order, ch);
    var val = getBidi(ch, partPos);
    if (bidiOther != null) val.other = getBidi(ch, bidiOther);
    return val;
  }

  // Used to cheaply estimate the coordinates for a position. Used for
  // intermediate scroll updates.
  function estimateCoords(cm, pos) {
    var left = 0, pos = clipPos(cm.doc, pos);
    if (!cm.options.lineWrapping) left = charWidth(cm.display) * pos.ch;
    var lineObj = getLine(cm.doc, pos.line);
    var top = heightAtLine(lineObj) + paddingTop(cm.display);
    return {left: left, right: left, top: top, bottom: top + lineObj.height};
  }

  // Positions returned by coordsChar contain some extra information.
  // xRel is the relative x position of the input coordinates compared
  // to the found position (so xRel > 0 means the coordinates are to
  // the right of the character position, for example). When outside
  // is true, that means the coordinates lie outside the line's
  // vertical range.
  function PosWithInfo(line, ch, outside, xRel) {
    var pos = Pos(line, ch);
    pos.xRel = xRel;
    if (outside) pos.outside = true;
    return pos;
  }

  // Compute the character position closest to the given coordinates.
  // Input must be lineSpace-local ("div" coordinate system).
  function coordsChar(cm, x, y) {
    var doc = cm.doc;
    y += cm.display.viewOffset;
    if (y < 0) return PosWithInfo(doc.first, 0, true, -1);
    var lineN = lineAtHeight(doc, y), last = doc.first + doc.size - 1;
    if (lineN > last)
      return PosWithInfo(doc.first + doc.size - 1, getLine(doc, last).text.length, true, 1);
    if (x < 0) x = 0;

    var lineObj = getLine(doc, lineN);
    for (;;) {
      var found = coordsCharInner(cm, lineObj, lineN, x, y);
      var merged = collapsedSpanAtEnd(lineObj);
      var mergedPos = merged && merged.find(0, true);
      if (merged && (found.ch > mergedPos.from.ch || found.ch == mergedPos.from.ch && found.xRel > 0))
        lineN = lineNo(lineObj = mergedPos.to.line);
      else
        return found;
    }
  }

  function coordsCharInner(cm, lineObj, lineNo, x, y) {
    var innerOff = y - heightAtLine(lineObj);
    var wrongLine = false, adjust = 2 * cm.display.wrapper.clientWidth;
    var preparedMeasure = prepareMeasureForLine(cm, lineObj);

    function getX(ch) {
      var sp = cursorCoords(cm, Pos(lineNo, ch), "line", lineObj, preparedMeasure);
      wrongLine = true;
      if (innerOff > sp.bottom) return sp.left - adjust;
      else if (innerOff < sp.top) return sp.left + adjust;
      else wrongLine = false;
      return sp.left;
    }

    var bidi = getOrder(lineObj), dist = lineObj.text.length;
    var from = lineLeft(lineObj), to = lineRight(lineObj);
    var fromX = getX(from), fromOutside = wrongLine, toX = getX(to), toOutside = wrongLine;

    if (x > toX) return PosWithInfo(lineNo, to, toOutside, 1);
    // Do a binary search between these bounds.
    for (;;) {
      if (bidi ? to == from || to == moveVisually(lineObj, from, 1) : to - from <= 1) {
        var ch = x < fromX || x - fromX <= toX - x ? from : to;
        var xDiff = x - (ch == from ? fromX : toX);
        while (isExtendingChar(lineObj.text.charAt(ch))) ++ch;
        var pos = PosWithInfo(lineNo, ch, ch == from ? fromOutside : toOutside,
                              xDiff < -1 ? -1 : xDiff > 1 ? 1 : 0);
        return pos;
      }
      var step = Math.ceil(dist / 2), middle = from + step;
      if (bidi) {
        middle = from;
        for (var i = 0; i < step; ++i) middle = moveVisually(lineObj, middle, 1);
      }
      var middleX = getX(middle);
      if (middleX > x) {to = middle; toX = middleX; if (toOutside = wrongLine) toX += 1000; dist = step;}
      else {from = middle; fromX = middleX; fromOutside = wrongLine; dist -= step;}
    }
  }

  var measureText;
  // Compute the default text height.
  function textHeight(display) {
    if (display.cachedTextHeight != null) return display.cachedTextHeight;
    if (measureText == null) {
      measureText = elt("pre");
      // Measure a bunch of lines, for browsers that compute
      // fractional heights.
      for (var i = 0; i < 49; ++i) {
        measureText.appendChild(document.createTextNode("x"));
        measureText.appendChild(elt("br"));
      }
      measureText.appendChild(document.createTextNode("x"));
    }
    removeChildrenAndAdd(display.measure, measureText);
    var height = measureText.offsetHeight / 50;
    if (height > 3) display.cachedTextHeight = height;
    removeChildren(display.measure);
    return height || 1;
  }

  // Compute the default character width.
  function charWidth(display) {
    if (display.cachedCharWidth != null) return display.cachedCharWidth;
    var anchor = elt("span", "xxxxxxxxxx");
    var pre = elt("pre", [anchor]);
    removeChildrenAndAdd(display.measure, pre);
    var rect = anchor.getBoundingClientRect(), width = (rect.right - rect.left) / 10;
    if (width > 2) display.cachedCharWidth = width;
    return width || 10;
  }

  // OPERATIONS

  // Operations are used to wrap a series of changes to the editor
  // state in such a way that each change won't have to update the
  // cursor and display (which would be awkward, slow, and
  // error-prone). Instead, display updates are batched and then all
  // combined and executed at once.

  var nextOpId = 0;
  // Start a new operation.
  function startOperation(cm) {
    cm.curOp = {
      viewChanged: false,      // Flag that indicates that lines might need to be redrawn
      startHeight: cm.doc.height, // Used to detect need to update scrollbar
      forceUpdate: false,      // Used to force a redraw
      updateInput: null,       // Whether to reset the input textarea
      typing: false,           // Whether this reset should be careful to leave existing text (for compositing)
      changeObjs: null,        // Accumulated changes, for firing change events
      cursorActivityHandlers: null, // Set of handlers to fire cursorActivity on
      selectionChanged: false, // Whether the selection needs to be redrawn
      updateMaxLine: false,    // Set when the widest line needs to be determined anew
      scrollLeft: null, scrollTop: null, // Intermediate scroll position, not pushed to DOM yet
      scrollToPos: null,       // Used to scroll to a specific position
      id: ++nextOpId           // Unique ID
    };
    if (!delayedCallbackDepth++) delayedCallbacks = [];
  }

  // Finish an operation, updating the display and signalling delayed events
  function endOperation(cm) {
    var op = cm.curOp, doc = cm.doc, display = cm.display;
    cm.curOp = null;

    if (op.updateMaxLine) findMaxLine(cm);

    // If it looks like an update might be needed, call updateDisplay
    if (op.viewChanged || op.forceUpdate || op.scrollTop != null ||
        op.scrollToPos && (op.scrollToPos.from.line < display.viewFrom ||
                           op.scrollToPos.to.line >= display.viewTo) ||
        display.maxLineChanged && cm.options.lineWrapping) {
      var updated = updateDisplay(cm, {top: op.scrollTop, ensure: op.scrollToPos}, op.forceUpdate);
      if (cm.display.scroller.offsetHeight) cm.doc.scrollTop = cm.display.scroller.scrollTop;
    }
    // If no update was run, but the selection changed, redraw that.
    if (!updated && op.selectionChanged) updateSelection(cm);
    if (!updated && op.startHeight != cm.doc.height) updateScrollbars(cm);

    // Abort mouse wheel delta measurement, when scrolling explicitly
    if (display.wheelStartX != null && (op.scrollTop != null || op.scrollLeft != null || op.scrollToPos))
      display.wheelStartX = display.wheelStartY = null;

    // Propagate the scroll position to the actual DOM scroller
    if (op.scrollTop != null && display.scroller.scrollTop != op.scrollTop) {
      var top = Math.max(0, Math.min(display.scroller.scrollHeight - display.scroller.clientHeight, op.scrollTop));
      display.scroller.scrollTop = display.scrollbarV.scrollTop = doc.scrollTop = top;
    }
    if (op.scrollLeft != null && display.scroller.scrollLeft != op.scrollLeft) {
      var left = Math.max(0, Math.min(display.scroller.scrollWidth - display.scroller.clientWidth, op.scrollLeft));
      display.scroller.scrollLeft = display.scrollbarH.scrollLeft = doc.scrollLeft = left;
      alignHorizontally(cm);
    }
    // If we need to scroll a specific position into view, do so.
    if (op.scrollToPos) {
      var coords = scrollPosIntoView(cm, clipPos(cm.doc, op.scrollToPos.from),
                                     clipPos(cm.doc, op.scrollToPos.to), op.scrollToPos.margin);
      if (op.scrollToPos.isCursor && cm.state.focused) maybeScrollWindow(cm, coords);
    }

    if (op.selectionChanged) restartBlink(cm);

    if (cm.state.focused && op.updateInput)
      resetInput(cm, op.typing);

    // Fire events for markers that are hidden/unidden by editing or
    // undoing
    var hidden = op.maybeHiddenMarkers, unhidden = op.maybeUnhiddenMarkers;
    if (hidden) for (var i = 0; i < hidden.length; ++i)
      if (!hidden[i].lines.length) signal(hidden[i], "hide");
    if (unhidden) for (var i = 0; i < unhidden.length; ++i)
      if (unhidden[i].lines.length) signal(unhidden[i], "unhide");

    var delayed;
    if (!--delayedCallbackDepth) {
      delayed = delayedCallbacks;
      delayedCallbacks = null;
    }
    // Fire change events, and delayed event handlers
    if (op.changeObjs)
      signal(cm, "changes", cm, op.changeObjs);
    if (delayed) for (var i = 0; i < delayed.length; ++i) delayed[i]();
    if (op.cursorActivityHandlers)
      for (var i = 0; i < op.cursorActivityHandlers.length; i++)
        op.cursorActivityHandlers[i](cm);
  }

  // Run the given function in an operation
  function runInOp(cm, f) {
    if (cm.curOp) return f();
    startOperation(cm);
    try { return f(); }
    finally { endOperation(cm); }
  }
  // Wraps a function in an operation. Returns the wrapped function.
  function operation(cm, f) {
    return function() {
      if (cm.curOp) return f.apply(cm, arguments);
      startOperation(cm);
      try { return f.apply(cm, arguments); }
      finally { endOperation(cm); }
    };
  }
  // Used to add methods to editor and doc instances, wrapping them in
  // operations.
  function methodOp(f) {
    return function() {
      if (this.curOp) return f.apply(this, arguments);
      startOperation(this);
      try { return f.apply(this, arguments); }
      finally { endOperation(this); }
    };
  }
  function docMethodOp(f) {
    return function() {
      var cm = this.cm;
      if (!cm || cm.curOp) return f.apply(this, arguments);
      startOperation(cm);
      try { return f.apply(this, arguments); }
      finally { endOperation(cm); }
    };
  }

  // VIEW TRACKING

  // These objects are used to represent the visible (currently drawn)
  // part of the document. A LineView may correspond to multiple
  // logical lines, if those are connected by collapsed ranges.
  function LineView(doc, line, lineN) {
    // The starting line
    this.line = line;
    // Continuing lines, if any
    this.rest = visualLineContinued(line);
    // Number of logical lines in this visual line
    this.size = this.rest ? lineNo(lst(this.rest)) - lineN + 1 : 1;
    this.node = this.text = null;
    this.hidden = lineIsHidden(doc, line);
  }

  // Create a range of LineView objects for the given lines.
  function buildViewArray(cm, from, to) {
    var array = [], nextPos;
    for (var pos = from; pos < to; pos = nextPos) {
      var view = new LineView(cm.doc, getLine(cm.doc, pos), pos);
      nextPos = pos + view.size;
      array.push(view);
    }
    return array;
  }

  // Updates the display.view data structure for a given change to the
  // document. From and to are in pre-change coordinates. Lendiff is
  // the amount of lines added or subtracted by the change. This is
  // used for changes that span multiple lines, or change the way
  // lines are divided into visual lines. regLineChange (below)
  // registers single-line changes.
  function regChange(cm, from, to, lendiff) {
    if (from == null) from = cm.doc.first;
    if (to == null) to = cm.doc.first + cm.doc.size;
    if (!lendiff) lendiff = 0;

    var display = cm.display;
    if (lendiff && to < display.viewTo &&
        (display.updateLineNumbers == null || display.updateLineNumbers > from))
      display.updateLineNumbers = from;

    cm.curOp.viewChanged = true;

    if (from >= display.viewTo) { // Change after
      if (sawCollapsedSpans && visualLineNo(cm.doc, from) < display.viewTo)
        resetView(cm);
    } else if (to <= display.viewFrom) { // Change before
      if (sawCollapsedSpans && visualLineEndNo(cm.doc, to + lendiff) > display.viewFrom) {
        resetView(cm);
      } else {
        display.viewFrom += lendiff;
        display.viewTo += lendiff;
      }
    } else if (from <= display.viewFrom && to >= display.viewTo) { // Full overlap
      resetView(cm);
    } else if (from <= display.viewFrom) { // Top overlap
      var cut = viewCuttingPoint(cm, to, to + lendiff, 1);
      if (cut) {
        display.view = display.view.slice(cut.index);
        display.viewFrom = cut.lineN;
        display.viewTo += lendiff;
      } else {
        resetView(cm);
      }
    } else if (to >= display.viewTo) { // Bottom overlap
      var cut = viewCuttingPoint(cm, from, from, -1);
      if (cut) {
        display.view = display.view.slice(0, cut.index);
        display.viewTo = cut.lineN;
      } else {
        resetView(cm);
      }
    } else { // Gap in the middle
      var cutTop = viewCuttingPoint(cm, from, from, -1);
      var cutBot = viewCuttingPoint(cm, to, to + lendiff, 1);
      if (cutTop && cutBot) {
        display.view = display.view.slice(0, cutTop.index)
          .concat(buildViewArray(cm, cutTop.lineN, cutBot.lineN))
          .concat(display.view.slice(cutBot.index));
        display.viewTo += lendiff;
      } else {
        resetView(cm);
      }
    }

    var ext = display.externalMeasured;
    if (ext) {
      if (to < ext.lineN)
        ext.lineN += lendiff;
      else if (from < ext.lineN + ext.size)
        display.externalMeasured = null;
    }
  }

  // Register a change to a single line. Type must be one of "text",
  // "gutter", "class", "widget"
  function regLineChange(cm, line, type) {
    cm.curOp.viewChanged = true;
    var display = cm.display, ext = cm.display.externalMeasured;
    if (ext && line >= ext.lineN && line < ext.lineN + ext.size)
      display.externalMeasured = null;

    if (line < display.viewFrom || line >= display.viewTo) return;
    var lineView = display.view[findViewIndex(cm, line)];
    if (lineView.node == null) return;
    var arr = lineView.changes || (lineView.changes = []);
    if (indexOf(arr, type) == -1) arr.push(type);
  }

  // Clear the view.
  function resetView(cm) {
    cm.display.viewFrom = cm.display.viewTo = cm.doc.first;
    cm.display.view = [];
    cm.display.viewOffset = 0;
  }

  // Find the view element corresponding to a given line. Return null
  // when the line isn't visible.
  function findViewIndex(cm, n) {
    if (n >= cm.display.viewTo) return null;
    n -= cm.display.viewFrom;
    if (n < 0) return null;
    var view = cm.display.view;
    for (var i = 0; i < view.length; i++) {
      n -= view[i].size;
      if (n < 0) return i;
    }
  }

  function viewCuttingPoint(cm, oldN, newN, dir) {
    var index = findViewIndex(cm, oldN), diff, view = cm.display.view;
    if (!sawCollapsedSpans || newN == cm.doc.first + cm.doc.size)
      return {index: index, lineN: newN};
    for (var i = 0, n = cm.display.viewFrom; i < index; i++)
      n += view[i].size;
    if (n != oldN) {
      if (dir > 0) {
        if (index == view.length - 1) return null;
        diff = (n + view[index].size) - oldN;
        index++;
      } else {
        diff = n - oldN;
      }
      oldN += diff; newN += diff;
    }
    while (visualLineNo(cm.doc, newN) != newN) {
      if (index == (dir < 0 ? 0 : view.length - 1)) return null;
      newN += dir * view[index - (dir < 0 ? 1 : 0)].size;
      index += dir;
    }
    return {index: index, lineN: newN};
  }

  // Force the view to cover a given range, adding empty view element
  // or clipping off existing ones as needed.
  function adjustView(cm, from, to) {
    var display = cm.display, view = display.view;
    if (view.length == 0 || from >= display.viewTo || to <= display.viewFrom) {
      display.view = buildViewArray(cm, from, to);
      display.viewFrom = from;
    } else {
      if (display.viewFrom > from)
        display.view = buildViewArray(cm, from, display.viewFrom).concat(display.view);
      else if (display.viewFrom < from)
        display.view = display.view.slice(findViewIndex(cm, from));
      display.viewFrom = from;
      if (display.viewTo < to)
        display.view = display.view.concat(buildViewArray(cm, display.viewTo, to));
      else if (display.viewTo > to)
        display.view = display.view.slice(0, findViewIndex(cm, to));
    }
    display.viewTo = to;
  }

  // Count the number of lines in the view whose DOM representation is
  // out of date (or nonexistent).
  function countDirtyView(cm) {
    var view = cm.display.view, dirty = 0;
    for (var i = 0; i < view.length; i++) {
      var lineView = view[i];
      if (!lineView.hidden && (!lineView.node || lineView.changes)) ++dirty;
    }
    return dirty;
  }

  // INPUT HANDLING

  // Poll for input changes, using the normal rate of polling. This
  // runs as long as the editor is focused.
  function slowPoll(cm) {
    if (cm.display.pollingFast) return;
    cm.display.poll.set(cm.options.pollInterval, function() {
      readInput(cm);
      if (cm.state.focused) slowPoll(cm);
    });
  }

  // When an event has just come in that is likely to add or change
  // something in the input textarea, we poll faster, to ensure that
  // the change appears on the screen quickly.
  function fastPoll(cm) {
    var missed = false;
    cm.display.pollingFast = true;
    function p() {
      var changed = readInput(cm);
      if (!changed && !missed) {missed = true; cm.display.poll.set(60, p);}
      else {cm.display.pollingFast = false; slowPoll(cm);}
    }
    cm.display.poll.set(20, p);
  }

  // Read input from the textarea, and update the document to match.
  // When something is selected, it is present in the textarea, and
  // selected (unless it is huge, in which case a placeholder is
  // used). When nothing is selected, the cursor sits after previously
  // seen text (can be empty), which is stored in prevInput (we must
  // not reset the textarea when typing, because that breaks IME).
  function readInput(cm) {
    var input = cm.display.input, prevInput = cm.display.prevInput, doc = cm.doc;
    // Since this is called a *lot*, try to bail out as cheaply as
    // possible when it is clear that nothing happened. hasSelection
    // will be the case when there is a lot of text in the textarea,
    // in which case reading its value would be expensive.
    if (!cm.state.focused || (hasSelection(input) && !prevInput) || isReadOnly(cm) || cm.options.disableInput)
      return false;
    // See paste handler for more on the fakedLastChar kludge
    if (cm.state.pasteIncoming && cm.state.fakedLastChar) {
      input.value = input.value.substring(0, input.value.length - 1);
      cm.state.fakedLastChar = false;
    }
    var text = input.value;
    // If nothing changed, bail.
    if (text == prevInput && !cm.somethingSelected()) return false;
    // Work around nonsensical selection resetting in IE9/10
    if (ie && ie_version >= 9 && cm.display.inputHasSelection === text) {
      resetInput(cm);
      return false;
    }

    var withOp = !cm.curOp;
    if (withOp) startOperation(cm);
    cm.display.shift = false;

    if (text.charCodeAt(0) == 0x200b && doc.sel == cm.display.selForContextMenu && !prevInput)
      prevInput = "\u200b";
    // Find the part of the input that is actually new
    var same = 0, l = Math.min(prevInput.length, text.length);
    while (same < l && prevInput.charCodeAt(same) == text.charCodeAt(same)) ++same;
    var inserted = text.slice(same), textLines = splitLines(inserted);

    // When pasing N lines into N selections, insert one line per selection
    var multiPaste = cm.state.pasteIncoming && textLines.length > 1 && doc.sel.ranges.length == textLines.length;

    // Normal behavior is to insert the new text into every selection
    for (var i = doc.sel.ranges.length - 1; i >= 0; i--) {
      var range = doc.sel.ranges[i];
      var from = range.from(), to = range.to();
      // Handle deletion
      if (same < prevInput.length)
        from = Pos(from.line, from.ch - (prevInput.length - same));
      // Handle overwrite
      else if (cm.state.overwrite && range.empty() && !cm.state.pasteIncoming)
        to = Pos(to.line, Math.min(getLine(doc, to.line).text.length, to.ch + lst(textLines).length));
      var updateInput = cm.curOp.updateInput;
      var changeEvent = {from: from, to: to, text: multiPaste ? [textLines[i]] : textLines,
                         origin: cm.state.pasteIncoming ? "paste" : cm.state.cutIncoming ? "cut" : "+input"};
      makeChange(cm.doc, changeEvent);
      signalLater(cm, "inputRead", cm, changeEvent);
      // When an 'electric' character is inserted, immediately trigger a reindent
      if (inserted && !cm.state.pasteIncoming && cm.options.electricChars &&
          cm.options.smartIndent && range.head.ch < 100 &&
          (!i || doc.sel.ranges[i - 1].head.line != range.head.line)) {
        var mode = cm.getModeAt(range.head);
        if (mode.electricChars) {
          for (var j = 0; j < mode.electricChars.length; j++)
            if (inserted.indexOf(mode.electricChars.charAt(j)) > -1) {
              indentLine(cm, range.head.line, "smart");
              break;
            }
        } else if (mode.electricInput) {
          var end = changeEnd(changeEvent);
          if (mode.electricInput.test(getLine(doc, end.line).text.slice(0, end.ch)))
            indentLine(cm, range.head.line, "smart");
        }
      }
    }
    ensureCursorVisible(cm);
    cm.curOp.updateInput = updateInput;
    cm.curOp.typing = true;

    // Don't leave long text in the textarea, since it makes further polling slow
    if (text.length > 1000 || text.indexOf("\n") > -1) input.value = cm.display.prevInput = "";
    else cm.display.prevInput = text;
    if (withOp) endOperation(cm);
    cm.state.pasteIncoming = cm.state.cutIncoming = false;
    return true;
  }

  // Reset the input to correspond to the selection (or to be empty,
  // when not typing and nothing is selected)
  function resetInput(cm, typing) {
    var minimal, selected, doc = cm.doc;
    if (cm.somethingSelected()) {
      cm.display.prevInput = "";
      var range = doc.sel.primary();
      minimal = hasCopyEvent &&
        (range.to().line - range.from().line > 100 || (selected = cm.getSelection()).length > 1000);
      var content = minimal ? "-" : selected || cm.getSelection();
      cm.display.input.value = content;
      if (cm.state.focused) selectInput(cm.display.input);
      if (ie && ie_version >= 9) cm.display.inputHasSelection = content;
    } else if (!typing) {
      cm.display.prevInput = cm.display.input.value = "";
      if (ie && ie_version >= 9) cm.display.inputHasSelection = null;
    }
    cm.display.inaccurateSelection = minimal;
  }

  function focusInput(cm) {
    if (cm.options.readOnly != "nocursor" && (!mobile || activeElt() != cm.display.input))
      cm.display.input.focus();
  }

  function ensureFocus(cm) {
    if (!cm.state.focused) { focusInput(cm); onFocus(cm); }
  }

  function isReadOnly(cm) {
    return cm.options.readOnly || cm.doc.cantEdit;
  }

  // EVENT HANDLERS

  // Attach the necessary event handlers when initializing the editor
  function registerEventHandlers(cm) {
    var d = cm.display;
    on(d.scroller, "mousedown", operation(cm, onMouseDown));
    // Older IE's will not fire a second mousedown for a double click
    if (ie && ie_version < 11)
      on(d.scroller, "dblclick", operation(cm, function(e) {
        if (signalDOMEvent(cm, e)) return;
        var pos = posFromMouse(cm, e);
        if (!pos || clickInGutter(cm, e) || eventInWidget(cm.display, e)) return;
        e_preventDefault(e);
        var word = findWordAt(cm, pos);
        extendSelection(cm.doc, word.anchor, word.head);
      }));
    else
      on(d.scroller, "dblclick", function(e) { signalDOMEvent(cm, e) || e_preventDefault(e); });
    // Prevent normal selection in the editor (we handle our own)
    on(d.lineSpace, "selectstart", function(e) {
      if (!eventInWidget(d, e)) e_preventDefault(e);
    });
    // Some browsers fire contextmenu *after* opening the menu, at
    // which point we can't mess with it anymore. Context menu is
    // handled in onMouseDown for these browsers.
    if (!captureRightClick) on(d.scroller, "contextmenu", function(e) {onContextMenu(cm, e);});

    // Sync scrolling between fake scrollbars and real scrollable
    // area, ensure viewport is updated when scrolling.
    on(d.scroller, "scroll", function() {
      if (d.scroller.clientHeight) {
        setScrollTop(cm, d.scroller.scrollTop);
        setScrollLeft(cm, d.scroller.scrollLeft, true);
        signal(cm, "scroll", cm);
      }
    });
    on(d.scrollbarV, "scroll", function() {
      if (d.scroller.clientHeight) setScrollTop(cm, d.scrollbarV.scrollTop);
    });
    on(d.scrollbarH, "scroll", function() {
      if (d.scroller.clientHeight) setScrollLeft(cm, d.scrollbarH.scrollLeft);
    });

    // Listen to wheel events in order to try and update the viewport on time.
    on(d.scroller, "mousewheel", function(e){onScrollWheel(cm, e);});
    on(d.scroller, "DOMMouseScroll", function(e){onScrollWheel(cm, e);});

    // Prevent clicks in the scrollbars from killing focus
    function reFocus() { if (cm.state.focused) setTimeout(bind(focusInput, cm), 0); }
    on(d.scrollbarH, "mousedown", reFocus);
    on(d.scrollbarV, "mousedown", reFocus);
    // Prevent wrapper from ever scrolling
    on(d.wrapper, "scroll", function() { d.wrapper.scrollTop = d.wrapper.scrollLeft = 0; });

    on(d.input, "keyup", operation(cm, onKeyUp));
    on(d.input, "input", function() {
      if (ie && ie_version >= 9 && cm.display.inputHasSelection) cm.display.inputHasSelection = null;
      fastPoll(cm);
    });
    on(d.input, "keydown", operation(cm, onKeyDown));
    on(d.input, "keypress", operation(cm, onKeyPress));
    on(d.input, "focus", bind(onFocus, cm));
    on(d.input, "blur", bind(onBlur, cm));

    function drag_(e) {
      if (!signalDOMEvent(cm, e)) e_stop(e);
    }
    if (cm.options.dragDrop) {
      on(d.scroller, "dragstart", function(e){onDragStart(cm, e);});
      on(d.scroller, "dragenter", drag_);
      on(d.scroller, "dragover", drag_);
      on(d.scroller, "drop", operation(cm, onDrop));
    }
    on(d.scroller, "paste", function(e) {
      if (eventInWidget(d, e)) return;
      cm.state.pasteIncoming = true;
      focusInput(cm);
      fastPoll(cm);
    });
    on(d.input, "paste", function() {
      // Workaround for webkit bug https://bugs.webkit.org/show_bug.cgi?id=90206
      // Add a char to the end of textarea before paste occur so that
      // selection doesn't span to the end of textarea.
      if (webkit && !cm.state.fakedLastChar && !(new Date - cm.state.lastMiddleDown < 200)) {
        var start = d.input.selectionStart, end = d.input.selectionEnd;
        d.input.value += "$";
        // The selection end needs to be set before the start, otherwise there
        // can be an intermediate non-empty selection between the two, which
        // can override the middle-click paste buffer on linux and cause the
        // wrong thing to get pasted.
        d.input.selectionEnd = end;
        d.input.selectionStart = start;
        cm.state.fakedLastChar = true;
      }
      cm.state.pasteIncoming = true;
      fastPoll(cm);
    });

    function prepareCopyCut(e) {
      if (cm.somethingSelected()) {
        if (d.inaccurateSelection) {
          d.prevInput = "";
          d.inaccurateSelection = false;
          d.input.value = cm.getSelection();
          selectInput(d.input);
        }
      } else {
        var text = "", ranges = [];
        for (var i = 0; i < cm.doc.sel.ranges.length; i++) {
          var line = cm.doc.sel.ranges[i].head.line;
          var lineRange = {anchor: Pos(line, 0), head: Pos(line + 1, 0)};
          ranges.push(lineRange);
          text += cm.getRange(lineRange.anchor, lineRange.head);
        }
        if (e.type == "cut") {
          cm.setSelections(ranges, null, sel_dontScroll);
        } else {
          d.prevInput = "";
          d.input.value = text;
          selectInput(d.input);
        }
      }
      if (e.type == "cut") cm.state.cutIncoming = true;
    }
    on(d.input, "cut", prepareCopyCut);
    on(d.input, "copy", prepareCopyCut);

    // Needed to handle Tab key in KHTML
    if (khtml) on(d.sizer, "mouseup", function() {
      if (activeElt() == d.input) d.input.blur();
      focusInput(cm);
    });
  }

  // Called when the window resizes
  function onResize(cm) {
    // Might be a text scaling operation, clear size caches.
    var d = cm.display;
    d.cachedCharWidth = d.cachedTextHeight = d.cachedPaddingH = null;
    cm.setSize();
  }

  // MOUSE EVENTS

  // Return true when the given mouse event happened in a widget
  function eventInWidget(display, e) {
    for (var n = e_target(e); n != display.wrapper; n = n.parentNode) {
      if (!n || n.ignoreEvents || n.parentNode == display.sizer && n != display.mover) return true;
    }
  }

  // Given a mouse event, find the corresponding position. If liberal
  // is false, it checks whether a gutter or scrollbar was clicked,
  // and returns null if it was. forRect is used by rectangular
  // selections, and tries to estimate a character position even for
  // coordinates beyond the right of the text.
  function posFromMouse(cm, e, liberal, forRect) {
    var display = cm.display;
    if (!liberal) {
      var target = e_target(e);
      if (target == display.scrollbarH || target == display.scrollbarV ||
          target == display.scrollbarFiller || target == display.gutterFiller) return null;
    }
    var x, y, space = display.lineSpace.getBoundingClientRect();
    // Fails unpredictably on IE[67] when mouse is dragged around quickly.
    try { x = e.clientX - space.left; y = e.clientY - space.top; }
    catch (e) { return null; }
    var coords = coordsChar(cm, x, y), line;
    if (forRect && coords.xRel == 1 && (line = getLine(cm.doc, coords.line).text).length == coords.ch) {
      var colDiff = countColumn(line, line.length, cm.options.tabSize) - line.length;
      coords = Pos(coords.line, Math.max(0, Math.round((x - paddingH(cm.display).left) / charWidth(cm.display)) - colDiff));
    }
    return coords;
  }

  // A mouse down can be a single click, double click, triple click,
  // start of selection drag, start of text drag, new cursor
  // (ctrl-click), rectangle drag (alt-drag), or xwin
  // middle-click-paste. Or it might be a click on something we should
  // not interfere with, such as a scrollbar or widget.
  function onMouseDown(e) {
    if (signalDOMEvent(this, e)) return;
    var cm = this, display = cm.display;
    display.shift = e.shiftKey;

    if (eventInWidget(display, e)) {
      if (!webkit) {
        // Briefly turn off draggability, to allow widgets to do
        // normal dragging things.
        display.scroller.draggable = false;
        setTimeout(function(){display.scroller.draggable = true;}, 100);
      }
      return;
    }
    if (clickInGutter(cm, e)) return;
    var start = posFromMouse(cm, e);
    window.focus();

    switch (e_button(e)) {
    case 1:
      if (start)
        leftButtonDown(cm, e, start);
      else if (e_target(e) == display.scroller)
        e_preventDefault(e);
      break;
    case 2:
      if (webkit) cm.state.lastMiddleDown = +new Date;
      if (start) extendSelection(cm.doc, start);
      setTimeout(bind(focusInput, cm), 20);
      e_preventDefault(e);
      break;
    case 3:
      if (captureRightClick) onContextMenu(cm, e);
      break;
    }
  }

  var lastClick, lastDoubleClick;
  function leftButtonDown(cm, e, start) {
    setTimeout(bind(ensureFocus, cm), 0);

    var now = +new Date, type;
    if (lastDoubleClick && lastDoubleClick.time > now - 400 && cmp(lastDoubleClick.pos, start) == 0) {
      type = "triple";
    } else if (lastClick && lastClick.time > now - 400 && cmp(lastClick.pos, start) == 0) {
      type = "double";
      lastDoubleClick = {time: now, pos: start};
    } else {
      type = "single";
      lastClick = {time: now, pos: start};
    }

    var sel = cm.doc.sel, modifier = mac ? e.metaKey : e.ctrlKey;
    if (cm.options.dragDrop && dragAndDrop && !isReadOnly(cm) &&
        type == "single" && sel.contains(start) > -1 && sel.somethingSelected())
      leftButtonStartDrag(cm, e, start, modifier);
    else
      leftButtonSelect(cm, e, start, type, modifier);
  }

  // Start a text drag. When it ends, see if any dragging actually
  // happen, and treat as a click if it didn't.
  function leftButtonStartDrag(cm, e, start, modifier) {
    var display = cm.display;
    var dragEnd = operation(cm, function(e2) {
      if (webkit) display.scroller.draggable = false;
      cm.state.draggingText = false;
      off(document, "mouseup", dragEnd);
      off(display.scroller, "drop", dragEnd);
      if (Math.abs(e.clientX - e2.clientX) + Math.abs(e.clientY - e2.clientY) < 10) {
        e_preventDefault(e2);
        if (!modifier)
          extendSelection(cm.doc, start);
        focusInput(cm);
        // Work around unexplainable focus problem in IE9 (#2127)
        if (ie && ie_version == 9)
          setTimeout(function() {document.body.focus(); focusInput(cm);}, 20);
      }
    });
    // Let the drag handler handle this.
    if (webkit) display.scroller.draggable = true;
    cm.state.draggingText = dragEnd;
    // IE's approach to draggable
    if (display.scroller.dragDrop) display.scroller.dragDrop();
    on(document, "mouseup", dragEnd);
    on(display.scroller, "drop", dragEnd);
  }

  // Normal selection, as opposed to text dragging.
  function leftButtonSelect(cm, e, start, type, addNew) {
    var display = cm.display, doc = cm.doc;
    e_preventDefault(e);

    var ourRange, ourIndex, startSel = doc.sel;
    if (addNew && !e.shiftKey) {
      ourIndex = doc.sel.contains(start);
      if (ourIndex > -1)
        ourRange = doc.sel.ranges[ourIndex];
      else
        ourRange = new Range(start, start);
    } else {
      ourRange = doc.sel.primary();
    }

    if (e.altKey) {
      type = "rect";
      if (!addNew) ourRange = new Range(start, start);
      start = posFromMouse(cm, e, true, true);
      ourIndex = -1;
    } else if (type == "double") {
      var word = findWordAt(cm, start);
      if (cm.display.shift || doc.extend)
        ourRange = extendRange(doc, ourRange, word.anchor, word.head);
      else
        ourRange = word;
    } else if (type == "triple") {
      var line = new Range(Pos(start.line, 0), clipPos(doc, Pos(start.line + 1, 0)));
      if (cm.display.shift || doc.extend)
        ourRange = extendRange(doc, ourRange, line.anchor, line.head);
      else
        ourRange = line;
    } else {
      ourRange = extendRange(doc, ourRange, start);
    }

    if (!addNew) {
      ourIndex = 0;
      setSelection(doc, new Selection([ourRange], 0), sel_mouse);
      startSel = doc.sel;
    } else if (ourIndex > -1) {
      replaceOneSelection(doc, ourIndex, ourRange, sel_mouse);
    } else {
      ourIndex = doc.sel.ranges.length;
      setSelection(doc, normalizeSelection(doc.sel.ranges.concat([ourRange]), ourIndex),
                   {scroll: false, origin: "*mouse"});
    }

    var lastPos = start;
    function extendTo(pos) {
      if (cmp(lastPos, pos) == 0) return;
      lastPos = pos;

      if (type == "rect") {
        var ranges = [], tabSize = cm.options.tabSize;
        var startCol = countColumn(getLine(doc, start.line).text, start.ch, tabSize);
        var posCol = countColumn(getLine(doc, pos.line).text, pos.ch, tabSize);
        var left = Math.min(startCol, posCol), right = Math.max(startCol, posCol);
        for (var line = Math.min(start.line, pos.line), end = Math.min(cm.lastLine(), Math.max(start.line, pos.line));
             line <= end; line++) {
          var text = getLine(doc, line).text, leftPos = findColumn(text, left, tabSize);
          if (left == right)
            ranges.push(new Range(Pos(line, leftPos), Pos(line, leftPos)));
          else if (text.length > leftPos)
            ranges.push(new Range(Pos(line, leftPos), Pos(line, findColumn(text, right, tabSize))));
        }
        if (!ranges.length) ranges.push(new Range(start, start));
        setSelection(doc, normalizeSelection(startSel.ranges.slice(0, ourIndex).concat(ranges), ourIndex),
                     {origin: "*mouse", scroll: false});
        cm.scrollIntoView(pos);
      } else {
        var oldRange = ourRange;
        var anchor = oldRange.anchor, head = pos;
        if (type != "single") {
          if (type == "double")
            var range = findWordAt(cm, pos);
          else
            var range = new Range(Pos(pos.line, 0), clipPos(doc, Pos(pos.line + 1, 0)));
          if (cmp(range.anchor, anchor) > 0) {
            head = range.head;
            anchor = minPos(oldRange.from(), range.anchor);
          } else {
            head = range.anchor;
            anchor = maxPos(oldRange.to(), range.head);
          }
        }
        var ranges = startSel.ranges.slice(0);
        ranges[ourIndex] = new Range(clipPos(doc, anchor), head);
        setSelection(doc, normalizeSelection(ranges, ourIndex), sel_mouse);
      }
    }

    var editorSize = display.wrapper.getBoundingClientRect();
    // Used to ensure timeout re-tries don't fire when another extend
    // happened in the meantime (clearTimeout isn't reliable -- at
    // least on Chrome, the timeouts still happen even when cleared,
    // if the clear happens after their scheduled firing time).
    var counter = 0;

    function extend(e) {
      var curCount = ++counter;
      var cur = posFromMouse(cm, e, true, type == "rect");
      if (!cur) return;
      if (cmp(cur, lastPos) != 0) {
        ensureFocus(cm);
        extendTo(cur);
        var visible = visibleLines(display, doc);
        if (cur.line >= visible.to || cur.line < visible.from)
          setTimeout(operation(cm, function(){if (counter == curCount) extend(e);}), 150);
      } else {
        var outside = e.clientY < editorSize.top ? -20 : e.clientY > editorSize.bottom ? 20 : 0;
        if (outside) setTimeout(operation(cm, function() {
          if (counter != curCount) return;
          display.scroller.scrollTop += outside;
          extend(e);
        }), 50);
      }
    }

    function done(e) {
      counter = Infinity;
      e_preventDefault(e);
      focusInput(cm);
      off(document, "mousemove", move);
      off(document, "mouseup", up);
      doc.history.lastSelOrigin = null;
    }

    var move = operation(cm, function(e) {
      if (!e_button(e)) done(e);
      else extend(e);
    });
    var up = operation(cm, done);
    on(document, "mousemove", move);
    on(document, "mouseup", up);
  }

  // Determines whether an event happened in the gutter, and fires the
  // handlers for the corresponding event.
  function gutterEvent(cm, e, type, prevent, signalfn) {
    try { var mX = e.clientX, mY = e.clientY; }
    catch(e) { return false; }
    if (mX >= Math.floor(cm.display.gutters.getBoundingClientRect().right)) return false;
    if (prevent) e_preventDefault(e);

    var display = cm.display;
    var lineBox = display.lineDiv.getBoundingClientRect();

    if (mY > lineBox.bottom || !hasHandler(cm, type)) return e_defaultPrevented(e);
    mY -= lineBox.top - display.viewOffset;

    for (var i = 0; i < cm.options.gutters.length; ++i) {
      var g = display.gutters.childNodes[i];
      if (g && g.getBoundingClientRect().right >= mX) {
        var line = lineAtHeight(cm.doc, mY);
        var gutter = cm.options.gutters[i];
        signalfn(cm, type, cm, line, gutter, e);
        return e_defaultPrevented(e);
      }
    }
  }

  function clickInGutter(cm, e) {
    return gutterEvent(cm, e, "gutterClick", true, signalLater);
  }

  // Kludge to work around strange IE behavior where it'll sometimes
  // re-fire a series of drag-related events right after the drop (#1551)
  var lastDrop = 0;

  function onDrop(e) {
    var cm = this;
    if (signalDOMEvent(cm, e) || eventInWidget(cm.display, e))
      return;
    e_preventDefault(e);
    if (ie) lastDrop = +new Date;
    var pos = posFromMouse(cm, e, true), files = e.dataTransfer.files;
    if (!pos || isReadOnly(cm)) return;
    // Might be a file drop, in which case we simply extract the text
    // and insert it.
    if (files && files.length && window.FileReader && window.File) {
      var n = files.length, text = Array(n), read = 0;
      var loadFile = function(file, i) {
        var reader = new FileReader;
        reader.onload = operation(cm, function() {
          text[i] = reader.result;
          if (++read == n) {
            pos = clipPos(cm.doc, pos);
            var change = {from: pos, to: pos, text: splitLines(text.join("\n")), origin: "paste"};
            makeChange(cm.doc, change);
            setSelectionReplaceHistory(cm.doc, simpleSelection(pos, changeEnd(change)));
          }
        });
        reader.readAsText(file);
      };
      for (var i = 0; i < n; ++i) loadFile(files[i], i);
    } else { // Normal drop
      // Don't do a replace if the drop happened inside of the selected text.
      if (cm.state.draggingText && cm.doc.sel.contains(pos) > -1) {
        cm.state.draggingText(e);
        // Ensure the editor is re-focused
        setTimeout(bind(focusInput, cm), 20);
        return;
      }
      try {
        var text = e.dataTransfer.getData("Text");
        if (text) {
          if (cm.state.draggingText && !(mac ? e.metaKey : e.ctrlKey))
            var selected = cm.listSelections();
          setSelectionNoUndo(cm.doc, simpleSelection(pos, pos));
          if (selected) for (var i = 0; i < selected.length; ++i)
            replaceRange(cm.doc, "", selected[i].anchor, selected[i].head, "drag");
          cm.replaceSelection(text, "around", "paste");
          focusInput(cm);
        }
      }
      catch(e){}
    }
  }

  function onDragStart(cm, e) {
    if (ie && (!cm.state.draggingText || +new Date - lastDrop < 100)) { e_stop(e); return; }
    if (signalDOMEvent(cm, e) || eventInWidget(cm.display, e)) return;

    e.dataTransfer.setData("Text", cm.getSelection());

    // Use dummy image instead of default browsers image.
    // Recent Safari (~6.0.2) have a tendency to segfault when this happens, so we don't do it there.
    if (e.dataTransfer.setDragImage && !safari) {
      var img = elt("img", null, null, "position: fixed; left: 0; top: 0;");
      img.src = "data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==";
      if (presto) {
        img.width = img.height = 1;
        cm.display.wrapper.appendChild(img);
        // Force a relayout, or Opera won't use our image for some obscure reason
        img._top = img.offsetTop;
      }
      e.dataTransfer.setDragImage(img, 0, 0);
      if (presto) img.parentNode.removeChild(img);
    }
  }

  // SCROLL EVENTS

  // Sync the scrollable area and scrollbars, ensure the viewport
  // covers the visible area.
  function setScrollTop(cm, val) {
    if (Math.abs(cm.doc.scrollTop - val) < 2) return;
    cm.doc.scrollTop = val;
    if (!gecko) updateDisplay(cm, {top: val});
    if (cm.display.scroller.scrollTop != val) cm.display.scroller.scrollTop = val;
    if (cm.display.scrollbarV.scrollTop != val) cm.display.scrollbarV.scrollTop = val;
    if (gecko) updateDisplay(cm);
    startWorker(cm, 100);
  }
  // Sync scroller and scrollbar, ensure the gutter elements are
  // aligned.
  function setScrollLeft(cm, val, isScroller) {
    if (isScroller ? val == cm.doc.scrollLeft : Math.abs(cm.doc.scrollLeft - val) < 2) return;
    val = Math.min(val, cm.display.scroller.scrollWidth - cm.display.scroller.clientWidth);
    cm.doc.scrollLeft = val;
    alignHorizontally(cm);
    if (cm.display.scroller.scrollLeft != val) cm.display.scroller.scrollLeft = val;
    if (cm.display.scrollbarH.scrollLeft != val) cm.display.scrollbarH.scrollLeft = val;
  }

  // Since the delta values reported on mouse wheel events are
  // unstandardized between browsers and even browser versions, and
  // generally horribly unpredictable, this code starts by measuring
  // the scroll effect that the first few mouse wheel events have,
  // and, from that, detects the way it can convert deltas to pixel
  // offsets afterwards.
  //
  // The reason we want to know the amount a wheel event will scroll
  // is that it gives us a chance to update the display before the
  // actual scrolling happens, reducing flickering.

  var wheelSamples = 0, wheelPixelsPerUnit = null;
  // Fill in a browser-detected starting value on browsers where we
  // know one. These don't have to be accurate -- the result of them
  // being wrong would just be a slight flicker on the first wheel
  // scroll (if it is large enough).
  if (ie) wheelPixelsPerUnit = -.53;
  else if (gecko) wheelPixelsPerUnit = 15;
  else if (chrome) wheelPixelsPerUnit = -.7;
  else if (safari) wheelPixelsPerUnit = -1/3;

  function onScrollWheel(cm, e) {
    var dx = e.wheelDeltaX, dy = e.wheelDeltaY;
    if (dx == null && e.detail && e.axis == e.HORIZONTAL_AXIS) dx = e.detail;
    if (dy == null && e.detail && e.axis == e.VERTICAL_AXIS) dy = e.detail;
    else if (dy == null) dy = e.wheelDelta;

    var display = cm.display, scroll = display.scroller;
    // Quit if there's nothing to scroll here
    if (!(dx && scroll.scrollWidth > scroll.clientWidth ||
          dy && scroll.scrollHeight > scroll.clientHeight)) return;

    // Webkit browsers on OS X abort momentum scrolls when the target
    // of the scroll event is removed from the scrollable element.
    // This hack (see related code in patchDisplay) makes sure the
    // element is kept around.
    if (dy && mac && webkit) {
      outer: for (var cur = e.target, view = display.view; cur != scroll; cur = cur.parentNode) {
        for (var i = 0; i < view.length; i++) {
          if (view[i].node == cur) {
            cm.display.currentWheelTarget = cur;
            break outer;
          }
        }
      }
    }

    // On some browsers, horizontal scrolling will cause redraws to
    // happen before the gutter has been realigned, causing it to
    // wriggle around in a most unseemly way. When we have an
    // estimated pixels/delta value, we just handle horizontal
    // scrolling entirely here. It'll be slightly off from native, but
    // better than glitching out.
    if (dx && !gecko && !presto && wheelPixelsPerUnit != null) {
      if (dy)
        setScrollTop(cm, Math.max(0, Math.min(scroll.scrollTop + dy * wheelPixelsPerUnit, scroll.scrollHeight - scroll.clientHeight)));
      setScrollLeft(cm, Math.max(0, Math.min(scroll.scrollLeft + dx * wheelPixelsPerUnit, scroll.scrollWidth - scroll.clientWidth)));
      e_preventDefault(e);
      display.wheelStartX = null; // Abort measurement, if in progress
      return;
    }

    // 'Project' the visible viewport to cover the area that is being
    // scrolled into view (if we know enough to estimate it).
    if (dy && wheelPixelsPerUnit != null) {
      var pixels = dy * wheelPixelsPerUnit;
      var top = cm.doc.scrollTop, bot = top + display.wrapper.clientHeight;
      if (pixels < 0) top = Math.max(0, top + pixels - 50);
      else bot = Math.min(cm.doc.height, bot + pixels + 50);
      updateDisplay(cm, {top: top, bottom: bot});
    }

    if (wheelSamples < 20) {
      if (display.wheelStartX == null) {
        display.wheelStartX = scroll.scrollLeft; display.wheelStartY = scroll.scrollTop;
        display.wheelDX = dx; display.wheelDY = dy;
        setTimeout(function() {
          if (display.wheelStartX == null) return;
          var movedX = scroll.scrollLeft - display.wheelStartX;
          var movedY = scroll.scrollTop - display.wheelStartY;
          var sample = (movedY && display.wheelDY && movedY / display.wheelDY) ||
            (movedX && display.wheelDX && movedX / display.wheelDX);
          display.wheelStartX = display.wheelStartY = null;
          if (!sample) return;
          wheelPixelsPerUnit = (wheelPixelsPerUnit * wheelSamples + sample) / (wheelSamples + 1);
          ++wheelSamples;
        }, 200);
      } else {
        display.wheelDX += dx; display.wheelDY += dy;
      }
    }
  }

  // KEY EVENTS

  // Run a handler that was bound to a key.
  function doHandleBinding(cm, bound, dropShift) {
    if (typeof bound == "string") {
      bound = commands[bound];
      if (!bound) return false;
    }
    // Ensure previous input has been read, so that the handler sees a
    // consistent view of the document
    if (cm.display.pollingFast && readInput(cm)) cm.display.pollingFast = false;
    var prevShift = cm.display.shift, done = false;
    try {
      if (isReadOnly(cm)) cm.state.suppressEdits = true;
      if (dropShift) cm.display.shift = false;
      done = bound(cm) != Pass;
    } finally {
      cm.display.shift = prevShift;
      cm.state.suppressEdits = false;
    }
    return done;
  }

  // Collect the currently active keymaps.
  function allKeyMaps(cm) {
    var maps = cm.state.keyMaps.slice(0);
    if (cm.options.extraKeys) maps.push(cm.options.extraKeys);
    maps.push(cm.options.keyMap);
    return maps;
  }

  var maybeTransition;
  // Handle a key from the keydown event.
  function handleKeyBinding(cm, e) {
    // Handle automatic keymap transitions
    var startMap = getKeyMap(cm.options.keyMap), next = startMap.auto;
    clearTimeout(maybeTransition);
    if (next && !isModifierKey(e)) maybeTransition = setTimeout(function() {
      if (getKeyMap(cm.options.keyMap) == startMap) {
        cm.options.keyMap = (next.call ? next.call(null, cm) : next);
        keyMapChanged(cm);
      }
    }, 50);

    var name = keyName(e, true), handled = false;
    if (!name) return false;
    var keymaps = allKeyMaps(cm);

    if (e.shiftKey) {
      // First try to resolve full name (including 'Shift-'). Failing
      // that, see if there is a cursor-motion command (starting with
      // 'go') bound to the keyname without 'Shift-'.
      handled = lookupKey("Shift-" + name, keymaps, function(b) {return doHandleBinding(cm, b, true);})
             || lookupKey(name, keymaps, function(b) {
                  if (typeof b == "string" ? /^go[A-Z]/.test(b) : b.motion)
                    return doHandleBinding(cm, b);
                });
    } else {
      handled = lookupKey(name, keymaps, function(b) { return doHandleBinding(cm, b); });
    }

    if (handled) {
      e_preventDefault(e);
      restartBlink(cm);
      signalLater(cm, "keyHandled", cm, name, e);
    }
    return handled;
  }

  // Handle a key from the keypress event
  function handleCharBinding(cm, e, ch) {
    var handled = lookupKey("'" + ch + "'", allKeyMaps(cm),
                            function(b) { return doHandleBinding(cm, b, true); });
    if (handled) {
      e_preventDefault(e);
      restartBlink(cm);
      signalLater(cm, "keyHandled", cm, "'" + ch + "'", e);
    }
    return handled;
  }

  var lastStoppedKey = null;
  function onKeyDown(e) {
    var cm = this;
    ensureFocus(cm);
    if (signalDOMEvent(cm, e)) return;
    // IE does strange things with escape.
    if (ie && ie_version < 11 && e.keyCode == 27) e.returnValue = false;
    var code = e.keyCode;
    cm.display.shift = code == 16 || e.shiftKey;
    var handled = handleKeyBinding(cm, e);
    if (presto) {
      lastStoppedKey = handled ? code : null;
      // Opera has no cut event... we try to at least catch the key combo
      if (!handled && code == 88 && !hasCopyEvent && (mac ? e.metaKey : e.ctrlKey))
        cm.replaceSelection("", null, "cut");
    }

    // Turn mouse into crosshair when Alt is held on Mac.
    if (code == 18 && !/\bCodeMirror-crosshair\b/.test(cm.display.lineDiv.className))
      showCrossHair(cm);
  }

  function showCrossHair(cm) {
    var lineDiv = cm.display.lineDiv;
    addClass(lineDiv, "CodeMirror-crosshair");

    function up(e) {
      if (e.keyCode == 18 || !e.altKey) {
        rmClass(lineDiv, "CodeMirror-crosshair");
        off(document, "keyup", up);
        off(document, "mouseover", up);
      }
    }
    on(document, "keyup", up);
    on(document, "mouseover", up);
  }

  function onKeyUp(e) {
    if (signalDOMEvent(this, e)) return;
    if (e.keyCode == 16) this.doc.sel.shift = false;
  }

  function onKeyPress(e) {
    var cm = this;
    if (signalDOMEvent(cm, e) || e.ctrlKey || mac && e.metaKey) return;
    var keyCode = e.keyCode, charCode = e.charCode;
    if (presto && keyCode == lastStoppedKey) {lastStoppedKey = null; e_preventDefault(e); return;}
    if (((presto && (!e.which || e.which < 10)) || khtml) && handleKeyBinding(cm, e)) return;
    var ch = String.fromCharCode(charCode == null ? keyCode : charCode);
    if (handleCharBinding(cm, e, ch)) return;
    if (ie && ie_version >= 9) cm.display.inputHasSelection = null;
    fastPoll(cm);
  }

  // FOCUS/BLUR EVENTS

  function onFocus(cm) {
    if (cm.options.readOnly == "nocursor") return;
    if (!cm.state.focused) {
      signal(cm, "focus", cm);
      cm.state.focused = true;
      addClass(cm.display.wrapper, "CodeMirror-focused");
      // The prevInput test prevents this from firing when a context
      // menu is closed (since the resetInput would kill the
      // select-all detection hack)
      if (!cm.curOp && cm.display.selForContextMenu != cm.doc.sel) {
        resetInput(cm);
        if (webkit) setTimeout(bind(resetInput, cm, true), 0); // Issue #1730
      }
    }
    slowPoll(cm);
    restartBlink(cm);
  }
  function onBlur(cm) {
    if (cm.state.focused) {
      signal(cm, "blur", cm);
      cm.state.focused = false;
      rmClass(cm.display.wrapper, "CodeMirror-focused");
    }
    clearInterval(cm.display.blinker);
    setTimeout(function() {if (!cm.state.focused) cm.display.shift = false;}, 150);
  }

  // CONTEXT MENU HANDLING

  // To make the context menu work, we need to briefly unhide the
  // textarea (making it as unobtrusive as possible) to let the
  // right-click take effect on it.
  function onContextMenu(cm, e) {
    if (signalDOMEvent(cm, e, "contextmenu")) return;
    var display = cm.display;
    if (eventInWidget(display, e) || contextMenuInGutter(cm, e)) return;

    var pos = posFromMouse(cm, e), scrollPos = display.scroller.scrollTop;
    if (!pos || presto) return; // Opera is difficult.

    // Reset the current text selection only if the click is done outside of the selection
    // and 'resetSelectionOnContextMenu' option is true.
    var reset = cm.options.resetSelectionOnContextMenu;
    if (reset && cm.doc.sel.contains(pos) == -1)
      operation(cm, setSelection)(cm.doc, simpleSelection(pos), sel_dontScroll);

    var oldCSS = display.input.style.cssText;
    display.inputDiv.style.position = "absolute";
    display.input.style.cssText = "position: fixed; width: 30px; height: 30px; top: " + (e.clientY - 5) +
      "px; left: " + (e.clientX - 5) + "px; z-index: 1000; background: " +
      (ie ? "rgba(255, 255, 255, .05)" : "transparent") +
      "; outline: none; border-width: 0; outline: none; overflow: hidden; opacity: .05; filter: alpha(opacity=5);";
    focusInput(cm);
    resetInput(cm);
    // Adds "Select all" to context menu in FF
    if (!cm.somethingSelected()) display.input.value = display.prevInput = " ";
    display.selForContextMenu = cm.doc.sel;
    clearTimeout(display.detectingSelectAll);

    // Select-all will be greyed out if there's nothing to select, so
    // this adds a zero-width space so that we can later check whether
    // it got selected.
    function prepareSelectAllHack() {
      if (display.input.selectionStart != null) {
        var selected = cm.somethingSelected();
        var extval = display.input.value = "\u200b" + (selected ? display.input.value : "");
        display.prevInput = selected ? "" : "\u200b";
        display.input.selectionStart = 1; display.input.selectionEnd = extval.length;
        // Re-set this, in case some other handler touched the
        // selection in the meantime.
        display.selForContextMenu = cm.doc.sel;
      }
    }
    function rehide() {
      display.inputDiv.style.position = "relative";
      display.input.style.cssText = oldCSS;
      if (ie && ie_version < 9) display.scrollbarV.scrollTop = display.scroller.scrollTop = scrollPos;
      slowPoll(cm);

      // Try to detect the user choosing select-all
      if (display.input.selectionStart != null) {
        if (!ie || (ie && ie_version < 9)) prepareSelectAllHack();
        var i = 0, poll = function() {
          if (display.selForContextMenu == cm.doc.sel && display.input.selectionStart == 0)
            operation(cm, commands.selectAll)(cm);
          else if (i++ < 10) display.detectingSelectAll = setTimeout(poll, 500);
          else resetInput(cm);
        };
        display.detectingSelectAll = setTimeout(poll, 200);
      }
    }

    if (ie && ie_version >= 9) prepareSelectAllHack();
    if (captureRightClick) {
      e_stop(e);
      var mouseup = function() {
        off(window, "mouseup", mouseup);
        setTimeout(rehide, 20);
      };
      on(window, "mouseup", mouseup);
    } else {
      setTimeout(rehide, 50);
    }
  }

  function contextMenuInGutter(cm, e) {
    if (!hasHandler(cm, "gutterContextMenu")) return false;
    return gutterEvent(cm, e, "gutterContextMenu", false, signal);
  }

  // UPDATING

  // Compute the position of the end of a change (its 'to' property
  // refers to the pre-change end).
  var changeEnd = CodeMirror.changeEnd = function(change) {
    if (!change.text) return change.to;
    return Pos(change.from.line + change.text.length - 1,
               lst(change.text).length + (change.text.length == 1 ? change.from.ch : 0));
  };

  // Adjust a position to refer to the post-change position of the
  // same text, or the end of the change if the change covers it.
  function adjustForChange(pos, change) {
    if (cmp(pos, change.from) < 0) return pos;
    if (cmp(pos, change.to) <= 0) return changeEnd(change);

    var line = pos.line + change.text.length - (change.to.line - change.from.line) - 1, ch = pos.ch;
    if (pos.line == change.to.line) ch += changeEnd(change).ch - change.to.ch;
    return Pos(line, ch);
  }

  function computeSelAfterChange(doc, change) {
    var out = [];
    for (var i = 0; i < doc.sel.ranges.length; i++) {
      var range = doc.sel.ranges[i];
      out.push(new Range(adjustForChange(range.anchor, change),
                         adjustForChange(range.head, change)));
    }
    return normalizeSelection(out, doc.sel.primIndex);
  }

  function offsetPos(pos, old, nw) {
    if (pos.line == old.line)
      return Pos(nw.line, pos.ch - old.ch + nw.ch);
    else
      return Pos(nw.line + (pos.line - old.line), pos.ch);
  }

  // Used by replaceSelections to allow moving the selection to the
  // start or around the replaced test. Hint may be "start" or "around".
  function computeReplacedSel(doc, changes, hint) {
    var out = [];
    var oldPrev = Pos(doc.first, 0), newPrev = oldPrev;
    for (var i = 0; i < changes.length; i++) {
      var change = changes[i];
      var from = offsetPos(change.from, oldPrev, newPrev);
      var to = offsetPos(changeEnd(change), oldPrev, newPrev);
      oldPrev = change.to;
      newPrev = to;
      if (hint == "around") {
        var range = doc.sel.ranges[i], inv = cmp(range.head, range.anchor) < 0;
        out[i] = new Range(inv ? to : from, inv ? from : to);
      } else {
        out[i] = new Range(from, from);
      }
    }
    return new Selection(out, doc.sel.primIndex);
  }

  // Allow "beforeChange" event handlers to influence a change
  function filterChange(doc, change, update) {
    var obj = {
      canceled: false,
      from: change.from,
      to: change.to,
      text: change.text,
      origin: change.origin,
      cancel: function() { this.canceled = true; }
    };
    if (update) obj.update = function(from, to, text, origin) {
      if (from) this.from = clipPos(doc, from);
      if (to) this.to = clipPos(doc, to);
      if (text) this.text = text;
      if (origin !== undefined) this.origin = origin;
    };
    signal(doc, "beforeChange", doc, obj);
    if (doc.cm) signal(doc.cm, "beforeChange", doc.cm, obj);

    if (obj.canceled) return null;
    return {from: obj.from, to: obj.to, text: obj.text, origin: obj.origin};
  }

  // Apply a change to a document, and add it to the document's
  // history, and propagating it to all linked documents.
  function makeChange(doc, change, ignoreReadOnly) {
    if (doc.cm) {
      if (!doc.cm.curOp) return operation(doc.cm, makeChange)(doc, change, ignoreReadOnly);
      if (doc.cm.state.suppressEdits) return;
    }

    if (hasHandler(doc, "beforeChange") || doc.cm && hasHandler(doc.cm, "beforeChange")) {
      change = filterChange(doc, change, true);
      if (!change) return;
    }

    // Possibly split or suppress the update based on the presence
    // of read-only spans in its range.
    var split = sawReadOnlySpans && !ignoreReadOnly && removeReadOnlyRanges(doc, change.from, change.to);
    if (split) {
      for (var i = split.length - 1; i >= 0; --i)
        makeChangeInner(doc, {from: split[i].from, to: split[i].to, text: i ? [""] : change.text});
    } else {
      makeChangeInner(doc, change);
    }
  }

  function makeChangeInner(doc, change) {
    if (change.text.length == 1 && change.text[0] == "" && cmp(change.from, change.to) == 0) return;
    var selAfter = computeSelAfterChange(doc, change);
    addChangeToHistory(doc, change, selAfter, doc.cm ? doc.cm.curOp.id : NaN);

    makeChangeSingleDoc(doc, change, selAfter, stretchSpansOverChange(doc, change));
    var rebased = [];

    linkedDocs(doc, function(doc, sharedHist) {
      if (!sharedHist && indexOf(rebased, doc.history) == -1) {
        rebaseHist(doc.history, change);
        rebased.push(doc.history);
      }
      makeChangeSingleDoc(doc, change, null, stretchSpansOverChange(doc, change));
    });
  }

  // Revert a change stored in a document's history.
  function makeChangeFromHistory(doc, type, allowSelectionOnly) {
    if (doc.cm && doc.cm.state.suppressEdits) return;

    var hist = doc.history, event, selAfter = doc.sel;
    var source = type == "undo" ? hist.done : hist.undone, dest = type == "undo" ? hist.undone : hist.done;

    // Verify that there is a useable event (so that ctrl-z won't
    // needlessly clear selection events)
    for (var i = 0; i < source.length; i++) {
      event = source[i];
      if (allowSelectionOnly ? event.ranges && !event.equals(doc.sel) : !event.ranges)
        break;
    }
    if (i == source.length) return;
    hist.lastOrigin = hist.lastSelOrigin = null;

    for (;;) {
      event = source.pop();
      if (event.ranges) {
        pushSelectionToHistory(event, dest);
        if (allowSelectionOnly && !event.equals(doc.sel)) {
          setSelection(doc, event, {clearRedo: false});
          return;
        }
        selAfter = event;
      }
      else break;
    }

    // Build up a reverse change object to add to the opposite history
    // stack (redo when undoing, and vice versa).
    var antiChanges = [];
    pushSelectionToHistory(selAfter, dest);
    dest.push({changes: antiChanges, generation: hist.generation});
    hist.generation = event.generation || ++hist.maxGeneration;

    var filter = hasHandler(doc, "beforeChange") || doc.cm && hasHandler(doc.cm, "beforeChange");

    for (var i = event.changes.length - 1; i >= 0; --i) {
      var change = event.changes[i];
      change.origin = type;
      if (filter && !filterChange(doc, change, false)) {
        source.length = 0;
        return;
      }

      antiChanges.push(historyChangeFromChange(doc, change));

      var after = i ? computeSelAfterChange(doc, change, null) : lst(source);
      makeChangeSingleDoc(doc, change, after, mergeOldSpans(doc, change));
      if (!i && doc.cm) doc.cm.scrollIntoView(change);
      var rebased = [];

      // Propagate to the linked documents
      linkedDocs(doc, function(doc, sharedHist) {
        if (!sharedHist && indexOf(rebased, doc.history) == -1) {
          rebaseHist(doc.history, change);
          rebased.push(doc.history);
        }
        makeChangeSingleDoc(doc, change, null, mergeOldSpans(doc, change));
      });
    }
  }

  // Sub-views need their line numbers shifted when text is added
  // above or below them in the parent document.
  function shiftDoc(doc, distance) {
    if (distance == 0) return;
    doc.first += distance;
    doc.sel = new Selection(map(doc.sel.ranges, function(range) {
      return new Range(Pos(range.anchor.line + distance, range.anchor.ch),
                       Pos(range.head.line + distance, range.head.ch));
    }), doc.sel.primIndex);
    if (doc.cm) {
      regChange(doc.cm, doc.first, doc.first - distance, distance);
      for (var d = doc.cm.display, l = d.viewFrom; l < d.viewTo; l++)
        regLineChange(doc.cm, l, "gutter");
    }
  }

  // More lower-level change function, handling only a single document
  // (not linked ones).
  function makeChangeSingleDoc(doc, change, selAfter, spans) {
    if (doc.cm && !doc.cm.curOp)
      return operation(doc.cm, makeChangeSingleDoc)(doc, change, selAfter, spans);

    if (change.to.line < doc.first) {
      shiftDoc(doc, change.text.length - 1 - (change.to.line - change.from.line));
      return;
    }
    if (change.from.line > doc.lastLine()) return;

    // Clip the change to the size of this doc
    if (change.from.line < doc.first) {
      var shift = change.text.length - 1 - (doc.first - change.from.line);
      shiftDoc(doc, shift);
      change = {from: Pos(doc.first, 0), to: Pos(change.to.line + shift, change.to.ch),
                text: [lst(change.text)], origin: change.origin};
    }
    var last = doc.lastLine();
    if (change.to.line > last) {
      change = {from: change.from, to: Pos(last, getLine(doc, last).text.length),
                text: [change.text[0]], origin: change.origin};
    }

    change.removed = getBetween(doc, change.from, change.to);

    if (!selAfter) selAfter = computeSelAfterChange(doc, change, null);
    if (doc.cm) makeChangeSingleDocInEditor(doc.cm, change, spans);
    else updateDoc(doc, change, spans);
    setSelectionNoUndo(doc, selAfter, sel_dontScroll);
  }

  // Handle the interaction of a change to a document with the editor
  // that this document is part of.
  function makeChangeSingleDocInEditor(cm, change, spans) {
    var doc = cm.doc, display = cm.display, from = change.from, to = change.to;

    var recomputeMaxLength = false, checkWidthStart = from.line;
    if (!cm.options.lineWrapping) {
      checkWidthStart = lineNo(visualLine(getLine(doc, from.line)));
      doc.iter(checkWidthStart, to.line + 1, function(line) {
        if (line == display.maxLine) {
          recomputeMaxLength = true;
          return true;
        }
      });
    }

    if (doc.sel.contains(change.from, change.to) > -1)
      signalCursorActivity(cm);

    updateDoc(doc, change, spans, estimateHeight(cm));

    if (!cm.options.lineWrapping) {
      doc.iter(checkWidthStart, from.line + change.text.length, function(line) {
        var len = lineLength(line);
        if (len > display.maxLineLength) {
          display.maxLine = line;
          display.maxLineLength = len;
          display.maxLineChanged = true;
          recomputeMaxLength = false;
        }
      });
      if (recomputeMaxLength) cm.curOp.updateMaxLine = true;
    }

    // Adjust frontier, schedule worker
    doc.frontier = Math.min(doc.frontier, from.line);
    startWorker(cm, 400);

    var lendiff = change.text.length - (to.line - from.line) - 1;
    // Remember that these lines changed, for updating the display
    if (from.line == to.line && change.text.length == 1 && !isWholeLineUpdate(cm.doc, change))
      regLineChange(cm, from.line, "text");
    else
      regChange(cm, from.line, to.line + 1, lendiff);

    var changesHandler = hasHandler(cm, "changes"), changeHandler = hasHandler(cm, "change");
    if (changeHandler || changesHandler) {
      var obj = {
        from: from, to: to,
        text: change.text,
        removed: change.removed,
        origin: change.origin
      };
      if (changeHandler) signalLater(cm, "change", cm, obj);
      if (changesHandler) (cm.curOp.changeObjs || (cm.curOp.changeObjs = [])).push(obj);
    }
    cm.display.selForContextMenu = null;
  }

  function replaceRange(doc, code, from, to, origin) {
    if (!to) to = from;
    if (cmp(to, from) < 0) { var tmp = to; to = from; from = tmp; }
    if (typeof code == "string") code = splitLines(code);
    makeChange(doc, {from: from, to: to, text: code, origin: origin});
  }

  // SCROLLING THINGS INTO VIEW

  // If an editor sits on the top or bottom of the window, partially
  // scrolled out of view, this ensures that the cursor is visible.
  function maybeScrollWindow(cm, coords) {
    var display = cm.display, box = display.sizer.getBoundingClientRect(), doScroll = null;
    if (coords.top + box.top < 0) doScroll = true;
    else if (coords.bottom + box.top > (window.innerHeight || document.documentElement.clientHeight)) doScroll = false;
    if (doScroll != null && !phantom) {
      var scrollNode = elt("div", "\u200b", null, "position: absolute; top: " +
                           (coords.top - display.viewOffset - paddingTop(cm.display)) + "px; height: " +
                           (coords.bottom - coords.top + scrollerCutOff) + "px; left: " +
                           coords.left + "px; width: 2px;");
      cm.display.lineSpace.appendChild(scrollNode);
      scrollNode.scrollIntoView(doScroll);
      cm.display.lineSpace.removeChild(scrollNode);
    }
  }

  // Scroll a given position into view (immediately), verifying that
  // it actually became visible (as line heights are accurately
  // measured, the position of something may 'drift' during drawing).
  function scrollPosIntoView(cm, pos, end, margin) {
    if (margin == null) margin = 0;
    for (;;) {
      var changed = false, coords = cursorCoords(cm, pos);
      var endCoords = !end || end == pos ? coords : cursorCoords(cm, end);
      var scrollPos = calculateScrollPos(cm, Math.min(coords.left, endCoords.left),
                                         Math.min(coords.top, endCoords.top) - margin,
                                         Math.max(coords.left, endCoords.left),
                                         Math.max(coords.bottom, endCoords.bottom) + margin);
      var startTop = cm.doc.scrollTop, startLeft = cm.doc.scrollLeft;
      if (scrollPos.scrollTop != null) {
        setScrollTop(cm, scrollPos.scrollTop);
        if (Math.abs(cm.doc.scrollTop - startTop) > 1) changed = true;
      }
      if (scrollPos.scrollLeft != null) {
        setScrollLeft(cm, scrollPos.scrollLeft);
        if (Math.abs(cm.doc.scrollLeft - startLeft) > 1) changed = true;
      }
      if (!changed) return coords;
    }
  }

  // Scroll a given set of coordinates into view (immediately).
  function scrollIntoView(cm, x1, y1, x2, y2) {
    var scrollPos = calculateScrollPos(cm, x1, y1, x2, y2);
    if (scrollPos.scrollTop != null) setScrollTop(cm, scrollPos.scrollTop);
    if (scrollPos.scrollLeft != null) setScrollLeft(cm, scrollPos.scrollLeft);
  }

  // Calculate a new scroll position needed to scroll the given
  // rectangle into view. Returns an object with scrollTop and
  // scrollLeft properties. When these are undefined, the
  // vertical/horizontal position does not need to be adjusted.
  function calculateScrollPos(cm, x1, y1, x2, y2) {
    var display = cm.display, snapMargin = textHeight(cm.display);
    if (y1 < 0) y1 = 0;
    var screentop = cm.curOp && cm.curOp.scrollTop != null ? cm.curOp.scrollTop : display.scroller.scrollTop;
    var screen = display.scroller.clientHeight - scrollerCutOff, result = {};
    var docBottom = cm.doc.height + paddingVert(display);
    var atTop = y1 < snapMargin, atBottom = y2 > docBottom - snapMargin;
    if (y1 < screentop) {
      result.scrollTop = atTop ? 0 : y1;
    } else if (y2 > screentop + screen) {
      var newTop = Math.min(y1, (atBottom ? docBottom : y2) - screen);
      if (newTop != screentop) result.scrollTop = newTop;
    }

    var screenleft = cm.curOp && cm.curOp.scrollLeft != null ? cm.curOp.scrollLeft : display.scroller.scrollLeft;
    var screenw = display.scroller.clientWidth - scrollerCutOff;
    x1 += display.gutters.offsetWidth; x2 += display.gutters.offsetWidth;
    var gutterw = display.gutters.offsetWidth;
    var atLeft = x1 < gutterw + 10;
    if (x1 < screenleft + gutterw || atLeft) {
      if (atLeft) x1 = 0;
      result.scrollLeft = Math.max(0, x1 - 10 - gutterw);
    } else if (x2 > screenw + screenleft - 3) {
      result.scrollLeft = x2 + 10 - screenw;
    }
    return result;
  }

  // Store a relative adjustment to the scroll position in the current
  // operation (to be applied when the operation finishes).
  function addToScrollPos(cm, left, top) {
    if (left != null || top != null) resolveScrollToPos(cm);
    if (left != null)
      cm.curOp.scrollLeft = (cm.curOp.scrollLeft == null ? cm.doc.scrollLeft : cm.curOp.scrollLeft) + left;
    if (top != null)
      cm.curOp.scrollTop = (cm.curOp.scrollTop == null ? cm.doc.scrollTop : cm.curOp.scrollTop) + top;
  }

  // Make sure that at the end of the operation the current cursor is
  // shown.
  function ensureCursorVisible(cm) {
    resolveScrollToPos(cm);
    var cur = cm.getCursor(), from = cur, to = cur;
    if (!cm.options.lineWrapping) {
      from = cur.ch ? Pos(cur.line, cur.ch - 1) : cur;
      to = Pos(cur.line, cur.ch + 1);
    }
    cm.curOp.scrollToPos = {from: from, to: to, margin: cm.options.cursorScrollMargin, isCursor: true};
  }

  // When an operation has its scrollToPos property set, and another
  // scroll action is applied before the end of the operation, this
  // 'simulates' scrolling that position into view in a cheap way, so
  // that the effect of intermediate scroll commands is not ignored.
  function resolveScrollToPos(cm) {
    var range = cm.curOp.scrollToPos;
    if (range) {
      cm.curOp.scrollToPos = null;
      var from = estimateCoords(cm, range.from), to = estimateCoords(cm, range.to);
      var sPos = calculateScrollPos(cm, Math.min(from.left, to.left),
                                    Math.min(from.top, to.top) - range.margin,
                                    Math.max(from.right, to.right),
                                    Math.max(from.bottom, to.bottom) + range.margin);
      cm.scrollTo(sPos.scrollLeft, sPos.scrollTop);
    }
  }

  // API UTILITIES

  // Indent the given line. The how parameter can be "smart",
  // "add"/null, "subtract", or "prev". When aggressive is false
  // (typically set to true for forced single-line indents), empty
  // lines are not indented, and places where the mode returns Pass
  // are left alone.
  function indentLine(cm, n, how, aggressive) {
    var doc = cm.doc, state;
    if (how == null) how = "add";
    if (how == "smart") {
      // Fall back to "prev" when the mode doesn't have an indentation
      // method.
      if (!cm.doc.mode.indent) how = "prev";
      else state = getStateBefore(cm, n);
    }

    var tabSize = cm.options.tabSize;
    var line = getLine(doc, n), curSpace = countColumn(line.text, null, tabSize);
    if (line.stateAfter) line.stateAfter = null;
    var curSpaceString = line.text.match(/^\s*/)[0], indentation;
    if (!aggressive && !/\S/.test(line.text)) {
      indentation = 0;
      how = "not";
    } else if (how == "smart") {
      indentation = cm.doc.mode.indent(state, line.text.slice(curSpaceString.length), line.text);
      if (indentation == Pass) {
        if (!aggressive) return;
        how = "prev";
      }
    }
    if (how == "prev") {
      if (n > doc.first) indentation = countColumn(getLine(doc, n-1).text, null, tabSize);
      else indentation = 0;
    } else if (how == "add") {
      indentation = curSpace + cm.options.indentUnit;
    } else if (how == "subtract") {
      indentation = curSpace - cm.options.indentUnit;
    } else if (typeof how == "number") {
      indentation = curSpace + how;
    }
    indentation = Math.max(0, indentation);

    var indentString = "", pos = 0;
    if (cm.options.indentWithTabs)
      for (var i = Math.floor(indentation / tabSize); i; --i) {pos += tabSize; indentString += "\t";}
    if (pos < indentation) indentString += spaceStr(indentation - pos);

    if (indentString != curSpaceString) {
      replaceRange(cm.doc, indentString, Pos(n, 0), Pos(n, curSpaceString.length), "+input");
    } else {
      // Ensure that, if the cursor was in the whitespace at the start
      // of the line, it is moved to the end of that space.
      for (var i = 0; i < doc.sel.ranges.length; i++) {
        var range = doc.sel.ranges[i];
        if (range.head.line == n && range.head.ch < curSpaceString.length) {
          var pos = Pos(n, curSpaceString.length);
          replaceOneSelection(doc, i, new Range(pos, pos));
          break;
        }
      }
    }
    line.stateAfter = null;
  }

  // Utility for applying a change to a line by handle or number,
  // returning the number and optionally registering the line as
  // changed.
  function changeLine(doc, handle, changeType, op) {
    var no = handle, line = handle;
    if (typeof handle == "number") line = getLine(doc, clipLine(doc, handle));
    else no = lineNo(handle);
    if (no == null) return null;
    if (op(line, no) && doc.cm) regLineChange(doc.cm, no, changeType);
    return line;
  }

  // Helper for deleting text near the selection(s), used to implement
  // backspace, delete, and similar functionality.
  function deleteNearSelection(cm, compute) {
    var ranges = cm.doc.sel.ranges, kill = [];
    // Build up a set of ranges to kill first, merging overlapping
    // ranges.
    for (var i = 0; i < ranges.length; i++) {
      var toKill = compute(ranges[i]);
      while (kill.length && cmp(toKill.from, lst(kill).to) <= 0) {
        var replaced = kill.pop();
        if (cmp(replaced.from, toKill.from) < 0) {
          toKill.from = replaced.from;
          break;
        }
      }
      kill.push(toKill);
    }
    // Next, remove those actual ranges.
    runInOp(cm, function() {
      for (var i = kill.length - 1; i >= 0; i--)
        replaceRange(cm.doc, "", kill[i].from, kill[i].to, "+delete");
      ensureCursorVisible(cm);
    });
  }

  // Used for horizontal relative motion. Dir is -1 or 1 (left or
  // right), unit can be "char", "column" (like char, but doesn't
  // cross line boundaries), "word" (across next word), or "group" (to
  // the start of next group of word or non-word-non-whitespace
  // chars). The visually param controls whether, in right-to-left
  // text, direction 1 means to move towards the next index in the
  // string, or towards the character to the right of the current
  // position. The resulting position will have a hitSide=true
  // property if it reached the end of the document.
  function findPosH(doc, pos, dir, unit, visually) {
    var line = pos.line, ch = pos.ch, origDir = dir;
    var lineObj = getLine(doc, line);
    var possible = true;
    function findNextLine() {
      var l = line + dir;
      if (l < doc.first || l >= doc.first + doc.size) return (possible = false);
      line = l;
      return lineObj = getLine(doc, l);
    }
    function moveOnce(boundToLine) {
      var next = (visually ? moveVisually : moveLogically)(lineObj, ch, dir, true);
      if (next == null) {
        if (!boundToLine && findNextLine()) {
          if (visually) ch = (dir < 0 ? lineRight : lineLeft)(lineObj);
          else ch = dir < 0 ? lineObj.text.length : 0;
        } else return (possible = false);
      } else ch = next;
      return true;
    }

    if (unit == "char") moveOnce();
    else if (unit == "column") moveOnce(true);
    else if (unit == "word" || unit == "group") {
      var sawType = null, group = unit == "group";
      var helper = doc.cm && doc.cm.getHelper(pos, "wordChars");
      for (var first = true;; first = false) {
        if (dir < 0 && !moveOnce(!first)) break;
        var cur = lineObj.text.charAt(ch) || "\n";
        var type = isWordChar(cur, helper) ? "w"
          : group && cur == "\n" ? "n"
          : !group || /\s/.test(cur) ? null
          : "p";
        if (group && !first && !type) type = "s";
        if (sawType && sawType != type) {
          if (dir < 0) {dir = 1; moveOnce();}
          break;
        }

        if (type) sawType = type;
        if (dir > 0 && !moveOnce(!first)) break;
      }
    }
    var result = skipAtomic(doc, Pos(line, ch), origDir, true);
    if (!possible) result.hitSide = true;
    return result;
  }

  // For relative vertical movement. Dir may be -1 or 1. Unit can be
  // "page" or "line". The resulting position will have a hitSide=true
  // property if it reached the end of the document.
  function findPosV(cm, pos, dir, unit) {
    var doc = cm.doc, x = pos.left, y;
    if (unit == "page") {
      var pageSize = Math.min(cm.display.wrapper.clientHeight, window.innerHeight || document.documentElement.clientHeight);
      y = pos.top + dir * (pageSize - (dir < 0 ? 1.5 : .5) * textHeight(cm.display));
    } else if (unit == "line") {
      y = dir > 0 ? pos.bottom + 3 : pos.top - 3;
    }
    for (;;) {
      var target = coordsChar(cm, x, y);
      if (!target.outside) break;
      if (dir < 0 ? y <= 0 : y >= doc.height) { target.hitSide = true; break; }
      y += dir * 5;
    }
    return target;
  }

  // Find the word at the given position (as returned by coordsChar).
  function findWordAt(cm, pos) {
    var doc = cm.doc, line = getLine(doc, pos.line).text;
    var start = pos.ch, end = pos.ch;
    if (line) {
      var helper = cm.getHelper(pos, "wordChars");
      if ((pos.xRel < 0 || end == line.length) && start) --start; else ++end;
      var startChar = line.charAt(start);
      var check = isWordChar(startChar, helper)
        ? function(ch) { return isWordChar(ch, helper); }
        : /\s/.test(startChar) ? function(ch) {return /\s/.test(ch);}
        : function(ch) {return !/\s/.test(ch) && !isWordChar(ch);};
      while (start > 0 && check(line.charAt(start - 1))) --start;
      while (end < line.length && check(line.charAt(end))) ++end;
    }
    return new Range(Pos(pos.line, start), Pos(pos.line, end));
  }

  // EDITOR METHODS

  // The publicly visible API. Note that methodOp(f) means
  // 'wrap f in an operation, performed on its `this` parameter'.

  // This is not the complete set of editor methods. Most of the
  // methods defined on the Doc type are also injected into
  // CodeMirror.prototype, for backwards compatibility and
  // convenience.

  CodeMirror.prototype = {
    constructor: CodeMirror,
    focus: function(){window.focus(); focusInput(this); fastPoll(this);},

    setOption: function(option, value) {
      var options = this.options, old = options[option];
      if (options[option] == value && option != "mode") return;
      options[option] = value;
      if (optionHandlers.hasOwnProperty(option))
        operation(this, optionHandlers[option])(this, value, old);
    },

    getOption: function(option) {return this.options[option];},
    getDoc: function() {return this.doc;},

    addKeyMap: function(map, bottom) {
      this.state.keyMaps[bottom ? "push" : "unshift"](map);
    },
    removeKeyMap: function(map) {
      var maps = this.state.keyMaps;
      for (var i = 0; i < maps.length; ++i)
        if (maps[i] == map || (typeof maps[i] != "string" && maps[i].name == map)) {
          maps.splice(i, 1);
          return true;
        }
    },

    addOverlay: methodOp(function(spec, options) {
      var mode = spec.token ? spec : CodeMirror.getMode(this.options, spec);
      if (mode.startState) throw new Error("Overlays may not be stateful.");
      this.state.overlays.push({mode: mode, modeSpec: spec, opaque: options && options.opaque});
      this.state.modeGen++;
      regChange(this);
    }),
    removeOverlay: methodOp(function(spec) {
      var overlays = this.state.overlays;
      for (var i = 0; i < overlays.length; ++i) {
        var cur = overlays[i].modeSpec;
        if (cur == spec || typeof spec == "string" && cur.name == spec) {
          overlays.splice(i, 1);
          this.state.modeGen++;
          regChange(this);
          return;
        }
      }
    }),

    indentLine: methodOp(function(n, dir, aggressive) {
      if (typeof dir != "string" && typeof dir != "number") {
        if (dir == null) dir = this.options.smartIndent ? "smart" : "prev";
        else dir = dir ? "add" : "subtract";
      }
      if (isLine(this.doc, n)) indentLine(this, n, dir, aggressive);
    }),
    indentSelection: methodOp(function(how) {
      var ranges = this.doc.sel.ranges, end = -1;
      for (var i = 0; i < ranges.length; i++) {
        var range = ranges[i];
        if (!range.empty()) {
          var start = Math.max(end, range.from().line);
          var to = range.to();
          end = Math.min(this.lastLine(), to.line - (to.ch ? 0 : 1)) + 1;
          for (var j = start; j < end; ++j)
            indentLine(this, j, how);
        } else if (range.head.line > end) {
          indentLine(this, range.head.line, how, true);
          end = range.head.line;
          if (i == this.doc.sel.primIndex) ensureCursorVisible(this);
        }
      }
    }),

    // Fetch the parser token for a given character. Useful for hacks
    // that want to inspect the mode state (say, for completion).
    getTokenAt: function(pos, precise) {
      var doc = this.doc;
      pos = clipPos(doc, pos);
      var state = getStateBefore(this, pos.line, precise), mode = this.doc.mode;
      var line = getLine(doc, pos.line);
      var stream = new StringStream(line.text, this.options.tabSize);
      while (stream.pos < pos.ch && !stream.eol()) {
        stream.start = stream.pos;
        var style = readToken(mode, stream, state);
      }
      return {start: stream.start,
              end: stream.pos,
              string: stream.current(),
              type: style || null,
              state: state};
    },

    getTokenTypeAt: function(pos) {
      pos = clipPos(this.doc, pos);
      var styles = getLineStyles(this, getLine(this.doc, pos.line));
      var before = 0, after = (styles.length - 1) / 2, ch = pos.ch;
      var type;
      if (ch == 0) type = styles[2];
      else for (;;) {
        var mid = (before + after) >> 1;
        if ((mid ? styles[mid * 2 - 1] : 0) >= ch) after = mid;
        else if (styles[mid * 2 + 1] < ch) before = mid + 1;
        else { type = styles[mid * 2 + 2]; break; }
      }
      var cut = type ? type.indexOf("cm-overlay ") : -1;
      return cut < 0 ? type : cut == 0 ? null : type.slice(0, cut - 1);
    },

    getModeAt: function(pos) {
      var mode = this.doc.mode;
      if (!mode.innerMode) return mode;
      return CodeMirror.innerMode(mode, this.getTokenAt(pos).state).mode;
    },

    getHelper: function(pos, type) {
      return this.getHelpers(pos, type)[0];
    },

    getHelpers: function(pos, type) {
      var found = [];
      if (!helpers.hasOwnProperty(type)) return helpers;
      var help = helpers[type], mode = this.getModeAt(pos);
      if (typeof mode[type] == "string") {
        if (help[mode[type]]) found.push(help[mode[type]]);
      } else if (mode[type]) {
        for (var i = 0; i < mode[type].length; i++) {
          var val = help[mode[type][i]];
          if (val) found.push(val);
        }
      } else if (mode.helperType && help[mode.helperType]) {
        found.push(help[mode.helperType]);
      } else if (help[mode.name]) {
        found.push(help[mode.name]);
      }
      for (var i = 0; i < help._global.length; i++) {
        var cur = help._global[i];
        if (cur.pred(mode, this) && indexOf(found, cur.val) == -1)
          found.push(cur.val);
      }
      return found;
    },

    getStateAfter: function(line, precise) {
      var doc = this.doc;
      line = clipLine(doc, line == null ? doc.first + doc.size - 1: line);
      return getStateBefore(this, line + 1, precise);
    },

    cursorCoords: function(start, mode) {
      var pos, range = this.doc.sel.primary();
      if (start == null) pos = range.head;
      else if (typeof start == "object") pos = clipPos(this.doc, start);
      else pos = start ? range.from() : range.to();
      return cursorCoords(this, pos, mode || "page");
    },

    charCoords: function(pos, mode) {
      return charCoords(this, clipPos(this.doc, pos), mode || "page");
    },

    coordsChar: function(coords, mode) {
      coords = fromCoordSystem(this, coords, mode || "page");
      return coordsChar(this, coords.left, coords.top);
    },

    lineAtHeight: function(height, mode) {
      height = fromCoordSystem(this, {top: height, left: 0}, mode || "page").top;
      return lineAtHeight(this.doc, height + this.display.viewOffset);
    },
    heightAtLine: function(line, mode) {
      var end = false, last = this.doc.first + this.doc.size - 1;
      if (line < this.doc.first) line = this.doc.first;
      else if (line > last) { line = last; end = true; }
      var lineObj = getLine(this.doc, line);
      return intoCoordSystem(this, lineObj, {top: 0, left: 0}, mode || "page").top +
        (end ? this.doc.height - heightAtLine(lineObj) : 0);
    },

    defaultTextHeight: function() { return textHeight(this.display); },
    defaultCharWidth: function() { return charWidth(this.display); },

    setGutterMarker: methodOp(function(line, gutterID, value) {
      return changeLine(this.doc, line, "gutter", function(line) {
        var markers = line.gutterMarkers || (line.gutterMarkers = {});
        markers[gutterID] = value;
        if (!value && isEmpty(markers)) line.gutterMarkers = null;
        return true;
      });
    }),

    clearGutter: methodOp(function(gutterID) {
      var cm = this, doc = cm.doc, i = doc.first;
      doc.iter(function(line) {
        if (line.gutterMarkers && line.gutterMarkers[gutterID]) {
          line.gutterMarkers[gutterID] = null;
          regLineChange(cm, i, "gutter");
          if (isEmpty(line.gutterMarkers)) line.gutterMarkers = null;
        }
        ++i;
      });
    }),

    addLineWidget: methodOp(function(handle, node, options) {
      return addLineWidget(this, handle, node, options);
    }),

    removeLineWidget: function(widget) { widget.clear(); },

    lineInfo: function(line) {
      if (typeof line == "number") {
        if (!isLine(this.doc, line)) return null;
        var n = line;
        line = getLine(this.doc, line);
        if (!line) return null;
      } else {
        var n = lineNo(line);
        if (n == null) return null;
      }
      return {line: n, handle: line, text: line.text, gutterMarkers: line.gutterMarkers,
              textClass: line.textClass, bgClass: line.bgClass, wrapClass: line.wrapClass,
              widgets: line.widgets};
    },

    getViewport: function() { return {from: this.display.viewFrom, to: this.display.viewTo};},

    addWidget: function(pos, node, scroll, vert, horiz) {
      var display = this.display;
      pos = cursorCoords(this, clipPos(this.doc, pos));
      var top = pos.bottom, left = pos.left;
      node.style.position = "absolute";
      display.sizer.appendChild(node);
      if (vert == "over") {
        top = pos.top;
      } else if (vert == "above" || vert == "near") {
        var vspace = Math.max(display.wrapper.clientHeight, this.doc.height),
        hspace = Math.max(display.sizer.clientWidth, display.lineSpace.clientWidth);
        // Default to positioning above (if specified and possible); otherwise default to positioning below
        if ((vert == 'above' || pos.bottom + node.offsetHeight > vspace) && pos.top > node.offsetHeight)
          top = pos.top - node.offsetHeight;
        else if (pos.bottom + node.offsetHeight <= vspace)
          top = pos.bottom;
        if (left + node.offsetWidth > hspace)
          left = hspace - node.offsetWidth;
      }
      node.style.top = top + "px";
      node.style.left = node.style.right = "";
      if (horiz == "right") {
        left = display.sizer.clientWidth - node.offsetWidth;
        node.style.right = "0px";
      } else {
        if (horiz == "left") left = 0;
        else if (horiz == "middle") left = (display.sizer.clientWidth - node.offsetWidth) / 2;
        node.style.left = left + "px";
      }
      if (scroll)
        scrollIntoView(this, left, top, left + node.offsetWidth, top + node.offsetHeight);
    },

    triggerOnKeyDown: methodOp(onKeyDown),
    triggerOnKeyPress: methodOp(onKeyPress),
    triggerOnKeyUp: methodOp(onKeyUp),

    execCommand: function(cmd) {
      if (commands.hasOwnProperty(cmd))
        return commands[cmd](this);
    },

    findPosH: function(from, amount, unit, visually) {
      var dir = 1;
      if (amount < 0) { dir = -1; amount = -amount; }
      for (var i = 0, cur = clipPos(this.doc, from); i < amount; ++i) {
        cur = findPosH(this.doc, cur, dir, unit, visually);
        if (cur.hitSide) break;
      }
      return cur;
    },

    moveH: methodOp(function(dir, unit) {
      var cm = this;
      cm.extendSelectionsBy(function(range) {
        if (cm.display.shift || cm.doc.extend || range.empty())
          return findPosH(cm.doc, range.head, dir, unit, cm.options.rtlMoveVisually);
        else
          return dir < 0 ? range.from() : range.to();
      }, sel_move);
    }),

    deleteH: methodOp(function(dir, unit) {
      var sel = this.doc.sel, doc = this.doc;
      if (sel.somethingSelected())
        doc.replaceSelection("", null, "+delete");
      else
        deleteNearSelection(this, function(range) {
          var other = findPosH(doc, range.head, dir, unit, false);
          return dir < 0 ? {from: other, to: range.head} : {from: range.head, to: other};
        });
    }),

    findPosV: function(from, amount, unit, goalColumn) {
      var dir = 1, x = goalColumn;
      if (amount < 0) { dir = -1; amount = -amount; }
      for (var i = 0, cur = clipPos(this.doc, from); i < amount; ++i) {
        var coords = cursorCoords(this, cur, "div");
        if (x == null) x = coords.left;
        else coords.left = x;
        cur = findPosV(this, coords, dir, unit);
        if (cur.hitSide) break;
      }
      return cur;
    },

    moveV: methodOp(function(dir, unit) {
      var cm = this, doc = this.doc, goals = [];
      var collapse = !cm.display.shift && !doc.extend && doc.sel.somethingSelected();
      doc.extendSelectionsBy(function(range) {
        if (collapse)
          return dir < 0 ? range.from() : range.to();
        var headPos = cursorCoords(cm, range.head, "div");
        if (range.goalColumn != null) headPos.left = range.goalColumn;
        goals.push(headPos.left);
        var pos = findPosV(cm, headPos, dir, unit);
        if (unit == "page" && range == doc.sel.primary())
          addToScrollPos(cm, null, charCoords(cm, pos, "div").top - headPos.top);
        return pos;
      }, sel_move);
      if (goals.length) for (var i = 0; i < doc.sel.ranges.length; i++)
        doc.sel.ranges[i].goalColumn = goals[i];
    }),

    toggleOverwrite: function(value) {
      if (value != null && value == this.state.overwrite) return;
      if (this.state.overwrite = !this.state.overwrite)
        addClass(this.display.cursorDiv, "CodeMirror-overwrite");
      else
        rmClass(this.display.cursorDiv, "CodeMirror-overwrite");

      signal(this, "overwriteToggle", this, this.state.overwrite);
    },
    hasFocus: function() { return activeElt() == this.display.input; },

    scrollTo: methodOp(function(x, y) {
      if (x != null || y != null) resolveScrollToPos(this);
      if (x != null) this.curOp.scrollLeft = x;
      if (y != null) this.curOp.scrollTop = y;
    }),
    getScrollInfo: function() {
      var scroller = this.display.scroller, co = scrollerCutOff;
      return {left: scroller.scrollLeft, top: scroller.scrollTop,
              height: scroller.scrollHeight - co, width: scroller.scrollWidth - co,
              clientHeight: scroller.clientHeight - co, clientWidth: scroller.clientWidth - co};
    },

    scrollIntoView: methodOp(function(range, margin) {
      if (range == null) {
        range = {from: this.doc.sel.primary().head, to: null};
        if (margin == null) margin = this.options.cursorScrollMargin;
      } else if (typeof range == "number") {
        range = {from: Pos(range, 0), to: null};
      } else if (range.from == null) {
        range = {from: range, to: null};
      }
      if (!range.to) range.to = range.from;
      range.margin = margin || 0;

      if (range.from.line != null) {
        resolveScrollToPos(this);
        this.curOp.scrollToPos = range;
      } else {
        var sPos = calculateScrollPos(this, Math.min(range.from.left, range.to.left),
                                      Math.min(range.from.top, range.to.top) - range.margin,
                                      Math.max(range.from.right, range.to.right),
                                      Math.max(range.from.bottom, range.to.bottom) + range.margin);
        this.scrollTo(sPos.scrollLeft, sPos.scrollTop);
      }
    }),

    setSize: methodOp(function(width, height) {
      var cm = this;
      function interpret(val) {
        return typeof val == "number" || /^\d+$/.test(String(val)) ? val + "px" : val;
      }
      if (width != null) cm.display.wrapper.style.width = interpret(width);
      if (height != null) cm.display.wrapper.style.height = interpret(height);
      if (cm.options.lineWrapping) clearLineMeasurementCache(this);
      var lineNo = cm.display.viewFrom;
      cm.doc.iter(lineNo, cm.display.viewTo, function(line) {
        if (line.widgets) for (var i = 0; i < line.widgets.length; i++)
          if (line.widgets[i].noHScroll) { regLineChange(cm, lineNo, "widget"); break; }
        ++lineNo;
      });
      cm.curOp.forceUpdate = true;
      signal(cm, "refresh", this);
    }),

    operation: function(f){return runInOp(this, f);},

    refresh: methodOp(function() {
      var oldHeight = this.display.cachedTextHeight;
      regChange(this);
      this.curOp.forceUpdate = true;
      clearCaches(this);
      this.scrollTo(this.doc.scrollLeft, this.doc.scrollTop);
      updateGutterSpace(this);
      if (oldHeight == null || Math.abs(oldHeight - textHeight(this.display)) > .5)
        estimateLineHeights(this);
      signal(this, "refresh", this);
    }),

    swapDoc: methodOp(function(doc) {
      var old = this.doc;
      old.cm = null;
      attachDoc(this, doc);
      clearCaches(this);
      resetInput(this);
      this.scrollTo(doc.scrollLeft, doc.scrollTop);
      signalLater(this, "swapDoc", this, old);
      return old;
    }),

    getInputField: function(){return this.display.input;},
    getWrapperElement: function(){return this.display.wrapper;},
    getScrollerElement: function(){return this.display.scroller;},
    getGutterElement: function(){return this.display.gutters;}
  };
  eventMixin(CodeMirror);

  // OPTION DEFAULTS

  // The default configuration options.
  var defaults = CodeMirror.defaults = {};
  // Functions to run when options are changed.
  var optionHandlers = CodeMirror.optionHandlers = {};

  function option(name, deflt, handle, notOnInit) {
    CodeMirror.defaults[name] = deflt;
    if (handle) optionHandlers[name] =
      notOnInit ? function(cm, val, old) {if (old != Init) handle(cm, val, old);} : handle;
  }

  // Passed to option handlers when there is no old value.
  var Init = CodeMirror.Init = {toString: function(){return "CodeMirror.Init";}};

  // These two are, on init, called from the constructor because they
  // have to be initialized before the editor can start at all.
  option("value", "", function(cm, val) {
    cm.setValue(val);
  }, true);
  option("mode", null, function(cm, val) {
    cm.doc.modeOption = val;
    loadMode(cm);
  }, true);

  option("indentUnit", 2, loadMode, true);
  option("indentWithTabs", false);
  option("smartIndent", true);
  option("tabSize", 4, function(cm) {
    resetModeState(cm);
    clearCaches(cm);
    regChange(cm);
  }, true);
  option("specialChars", /[\t\u0000-\u0019\u00ad\u200b\u2028\u2029\ufeff]/g, function(cm, val) {
    cm.options.specialChars = new RegExp(val.source + (val.test("\t") ? "" : "|\t"), "g");
    cm.refresh();
  }, true);
  option("specialCharPlaceholder", defaultSpecialCharPlaceholder, function(cm) {cm.refresh();}, true);
  option("electricChars", true);
  option("rtlMoveVisually", !windows);
  option("wholeLineUpdateBefore", true);

  option("theme", "default", function(cm) {
    themeChanged(cm);
    guttersChanged(cm);
  }, true);
  option("keyMap", "default", keyMapChanged);
  option("extraKeys", null);

  option("lineWrapping", false, wrappingChanged, true);
  option("gutters", [], function(cm) {
    setGuttersForLineNumbers(cm.options);
    guttersChanged(cm);
  }, true);
  option("fixedGutter", true, function(cm, val) {
    cm.display.gutters.style.left = val ? compensateForHScroll(cm.display) + "px" : "0";
    cm.refresh();
  }, true);
  option("coverGutterNextToScrollbar", false, updateScrollbars, true);
  option("lineNumbers", false, function(cm) {
    setGuttersForLineNumbers(cm.options);
    guttersChanged(cm);
  }, true);
  option("firstLineNumber", 1, guttersChanged, true);
  option("lineNumberFormatter", function(integer) {return integer;}, guttersChanged, true);
  option("showCursorWhenSelecting", false, updateSelection, true);

  option("resetSelectionOnContextMenu", true);

  option("readOnly", false, function(cm, val) {
    if (val == "nocursor") {
      onBlur(cm);
      cm.display.input.blur();
      cm.display.disabled = true;
    } else {
      cm.display.disabled = false;
      if (!val) resetInput(cm);
    }
  });
  option("disableInput", false, function(cm, val) {if (!val) resetInput(cm);}, true);
  option("dragDrop", true);

  option("cursorBlinkRate", 530);
  option("cursorScrollMargin", 0);
  option("cursorHeight", 1, updateSelection, true);
  option("singleCursorHeightPerLine", true, updateSelection, true);
  option("workTime", 100);
  option("workDelay", 100);
  option("flattenSpans", true, resetModeState, true);
  option("addModeClass", false, resetModeState, true);
  option("pollInterval", 100);
  option("undoDepth", 200, function(cm, val){cm.doc.history.undoDepth = val;});
  option("historyEventDelay", 1250);
  option("viewportMargin", 10, function(cm){cm.refresh();}, true);
  option("maxHighlightLength", 10000, resetModeState, true);
  option("moveInputWithCursor", true, function(cm, val) {
    if (!val) cm.display.inputDiv.style.top = cm.display.inputDiv.style.left = 0;
  });

  option("tabindex", null, function(cm, val) {
    cm.display.input.tabIndex = val || "";
  });
  option("autofocus", null);

  // MODE DEFINITION AND QUERYING

  // Known modes, by name and by MIME
  var modes = CodeMirror.modes = {}, mimeModes = CodeMirror.mimeModes = {};

  // Extra arguments are stored as the mode's dependencies, which is
  // used by (legacy) mechanisms like loadmode.js to automatically
  // load a mode. (Preferred mechanism is the require/define calls.)
  CodeMirror.defineMode = function(name, mode) {
    if (!CodeMirror.defaults.mode && name != "null") CodeMirror.defaults.mode = name;
    if (arguments.length > 2) {
      mode.dependencies = [];
      for (var i = 2; i < arguments.length; ++i) mode.dependencies.push(arguments[i]);
    }
    modes[name] = mode;
  };

  CodeMirror.defineMIME = function(mime, spec) {
    mimeModes[mime] = spec;
  };

  // Given a MIME type, a {name, ...options} config object, or a name
  // string, return a mode config object.
  CodeMirror.resolveMode = function(spec) {
    if (typeof spec == "string" && mimeModes.hasOwnProperty(spec)) {
      spec = mimeModes[spec];
    } else if (spec && typeof spec.name == "string" && mimeModes.hasOwnProperty(spec.name)) {
      var found = mimeModes[spec.name];
      if (typeof found == "string") found = {name: found};
      spec = createObj(found, spec);
      spec.name = found.name;
    } else if (typeof spec == "string" && /^[\w\-]+\/[\w\-]+\+xml$/.test(spec)) {
      return CodeMirror.resolveMode("application/xml");
    }
    if (typeof spec == "string") return {name: spec};
    else return spec || {name: "null"};
  };

  // Given a mode spec (anything that resolveMode accepts), find and
  // initialize an actual mode object.
  CodeMirror.getMode = function(options, spec) {
    var spec = CodeMirror.resolveMode(spec);
    var mfactory = modes[spec.name];
    if (!mfactory) return CodeMirror.getMode(options, "text/plain");
    var modeObj = mfactory(options, spec);
    if (modeExtensions.hasOwnProperty(spec.name)) {
      var exts = modeExtensions[spec.name];
      for (var prop in exts) {
        if (!exts.hasOwnProperty(prop)) continue;
        if (modeObj.hasOwnProperty(prop)) modeObj["_" + prop] = modeObj[prop];
        modeObj[prop] = exts[prop];
      }
    }
    modeObj.name = spec.name;
    if (spec.helperType) modeObj.helperType = spec.helperType;
    if (spec.modeProps) for (var prop in spec.modeProps)
      modeObj[prop] = spec.modeProps[prop];

    return modeObj;
  };

  // Minimal default mode.
  CodeMirror.defineMode("null", function() {
    return {token: function(stream) {stream.skipToEnd();}};
  });
  CodeMirror.defineMIME("text/plain", "null");

  // This can be used to attach properties to mode objects from
  // outside the actual mode definition.
  var modeExtensions = CodeMirror.modeExtensions = {};
  CodeMirror.extendMode = function(mode, properties) {
    var exts = modeExtensions.hasOwnProperty(mode) ? modeExtensions[mode] : (modeExtensions[mode] = {});
    copyObj(properties, exts);
  };

  // EXTENSIONS

  CodeMirror.defineExtension = function(name, func) {
    CodeMirror.prototype[name] = func;
  };
  CodeMirror.defineDocExtension = function(name, func) {
    Doc.prototype[name] = func;
  };
  CodeMirror.defineOption = option;

  var initHooks = [];
  CodeMirror.defineInitHook = function(f) {initHooks.push(f);};

  var helpers = CodeMirror.helpers = {};
  CodeMirror.registerHelper = function(type, name, value) {
    if (!helpers.hasOwnProperty(type)) helpers[type] = CodeMirror[type] = {_global: []};
    helpers[type][name] = value;
  };
  CodeMirror.registerGlobalHelper = function(type, name, predicate, value) {
    CodeMirror.registerHelper(type, name, value);
    helpers[type]._global.push({pred: predicate, val: value});
  };

  // MODE STATE HANDLING

  // Utility functions for working with state. Exported because nested
  // modes need to do this for their inner modes.

  var copyState = CodeMirror.copyState = function(mode, state) {
    if (state === true) return state;
    if (mode.copyState) return mode.copyState(state);
    var nstate = {};
    for (var n in state) {
      var val = state[n];
      if (val instanceof Array) val = val.concat([]);
      nstate[n] = val;
    }
    return nstate;
  };

  var startState = CodeMirror.startState = function(mode, a1, a2) {
    return mode.startState ? mode.startState(a1, a2) : true;
  };

  // Given a mode and a state (for that mode), find the inner mode and
  // state at the position that the state refers to.
  CodeMirror.innerMode = function(mode, state) {
    while (mode.innerMode) {
      var info = mode.innerMode(state);
      if (!info || info.mode == mode) break;
      state = info.state;
      mode = info.mode;
    }
    return info || {mode: mode, state: state};
  };

  // STANDARD COMMANDS

  // Commands are parameter-less actions that can be performed on an
  // editor, mostly used for keybindings.
  var commands = CodeMirror.commands = {
    selectAll: function(cm) {cm.setSelection(Pos(cm.firstLine(), 0), Pos(cm.lastLine()), sel_dontScroll);},
    singleSelection: function(cm) {
      cm.setSelection(cm.getCursor("anchor"), cm.getCursor("head"), sel_dontScroll);
    },
    killLine: function(cm) {
      deleteNearSelection(cm, function(range) {
        if (range.empty()) {
          var len = getLine(cm.doc, range.head.line).text.length;
          if (range.head.ch == len && range.head.line < cm.lastLine())
            return {from: range.head, to: Pos(range.head.line + 1, 0)};
          else
            return {from: range.head, to: Pos(range.head.line, len)};
        } else {
          return {from: range.from(), to: range.to()};
        }
      });
    },
    deleteLine: function(cm) {
      deleteNearSelection(cm, function(range) {
        return {from: Pos(range.from().line, 0),
                to: clipPos(cm.doc, Pos(range.to().line + 1, 0))};
      });
    },
    delLineLeft: function(cm) {
      deleteNearSelection(cm, function(range) {
        return {from: Pos(range.from().line, 0), to: range.from()};
      });
    },
    undo: function(cm) {cm.undo();},
    redo: function(cm) {cm.redo();},
    undoSelection: function(cm) {cm.undoSelection();},
    redoSelection: function(cm) {cm.redoSelection();},
    goDocStart: function(cm) {cm.extendSelection(Pos(cm.firstLine(), 0));},
    goDocEnd: function(cm) {cm.extendSelection(Pos(cm.lastLine()));},
    goLineStart: function(cm) {
      cm.extendSelectionsBy(function(range) { return lineStart(cm, range.head.line); },
                            {origin: "+move", bias: 1});
    },
    goLineStartSmart: function(cm) {
      cm.extendSelectionsBy(function(range) {
        var start = lineStart(cm, range.head.line);
        var line = cm.getLineHandle(start.line);
        var order = getOrder(line);
        if (!order || order[0].level == 0) {
          var firstNonWS = Math.max(0, line.text.search(/\S/));
          var inWS = range.head.line == start.line && range.head.ch <= firstNonWS && range.head.ch;
          return Pos(start.line, inWS ? 0 : firstNonWS);
        }
        return start;
      }, {origin: "+move", bias: 1});
    },
    goLineEnd: function(cm) {
      cm.extendSelectionsBy(function(range) { return lineEnd(cm, range.head.line); },
                            {origin: "+move", bias: -1});
    },
    goLineRight: function(cm) {
      cm.extendSelectionsBy(function(range) {
        var top = cm.charCoords(range.head, "div").top + 5;
        return cm.coordsChar({left: cm.display.lineDiv.offsetWidth + 100, top: top}, "div");
      }, sel_move);
    },
    goLineLeft: function(cm) {
      cm.extendSelectionsBy(function(range) {
        var top = cm.charCoords(range.head, "div").top + 5;
        return cm.coordsChar({left: 0, top: top}, "div");
      }, sel_move);
    },
    goLineUp: function(cm) {cm.moveV(-1, "line");},
    goLineDown: function(cm) {cm.moveV(1, "line");},
    goPageUp: function(cm) {cm.moveV(-1, "page");},
    goPageDown: function(cm) {cm.moveV(1, "page");},
    goCharLeft: function(cm) {cm.moveH(-1, "char");},
    goCharRight: function(cm) {cm.moveH(1, "char");},
    goColumnLeft: function(cm) {cm.moveH(-1, "column");},
    goColumnRight: function(cm) {cm.moveH(1, "column");},
    goWordLeft: function(cm) {cm.moveH(-1, "word");},
    goGroupRight: function(cm) {cm.moveH(1, "group");},
    goGroupLeft: function(cm) {cm.moveH(-1, "group");},
    goWordRight: function(cm) {cm.moveH(1, "word");},
    delCharBefore: function(cm) {cm.deleteH(-1, "char");},
    delCharAfter: function(cm) {cm.deleteH(1, "char");},
    delWordBefore: function(cm) {cm.deleteH(-1, "word");},
    delWordAfter: function(cm) {cm.deleteH(1, "word");},
    delGroupBefore: function(cm) {cm.deleteH(-1, "group");},
    delGroupAfter: function(cm) {cm.deleteH(1, "group");},
    indentAuto: function(cm) {cm.indentSelection("smart");},
    indentMore: function(cm) {cm.indentSelection("add");},
    indentLess: function(cm) {cm.indentSelection("subtract");},
    insertTab: function(cm) {cm.replaceSelection("\t");},
    insertSoftTab: function(cm) {
      var spaces = [], ranges = cm.listSelections(), tabSize = cm.options.tabSize;
      for (var i = 0; i < ranges.length; i++) {
        var pos = ranges[i].from();
        var col = countColumn(cm.getLine(pos.line), pos.ch, tabSize);
        spaces.push(new Array(tabSize - col % tabSize + 1).join(" "));
      }
      cm.replaceSelections(spaces);
    },
    defaultTab: function(cm) {
      if (cm.somethingSelected()) cm.indentSelection("add");
      else cm.execCommand("insertTab");
    },
    transposeChars: function(cm) {
      runInOp(cm, function() {
        var ranges = cm.listSelections(), newSel = [];
        for (var i = 0; i < ranges.length; i++) {
          var cur = ranges[i].head, line = getLine(cm.doc, cur.line).text;
          if (line) {
            if (cur.ch == line.length) cur = new Pos(cur.line, cur.ch - 1);
            if (cur.ch > 0) {
              cur = new Pos(cur.line, cur.ch + 1);
              cm.replaceRange(line.charAt(cur.ch - 1) + line.charAt(cur.ch - 2),
                              Pos(cur.line, cur.ch - 2), cur, "+transpose");
            } else if (cur.line > cm.doc.first) {
              var prev = getLine(cm.doc, cur.line - 1).text;
              if (prev)
                cm.replaceRange(line.charAt(0) + "\n" + prev.charAt(prev.length - 1),
                                Pos(cur.line - 1, prev.length - 1), Pos(cur.line, 1), "+transpose");
            }
          }
          newSel.push(new Range(cur, cur));
        }
        cm.setSelections(newSel);
      });
    },
    newlineAndIndent: function(cm) {
      runInOp(cm, function() {
        var len = cm.listSelections().length;
        for (var i = 0; i < len; i++) {
          var range = cm.listSelections()[i];
          cm.replaceRange("\n", range.anchor, range.head, "+input");
          cm.indentLine(range.from().line + 1, null, true);
          ensureCursorVisible(cm);
        }
      });
    },
    toggleOverwrite: function(cm) {cm.toggleOverwrite();}
  };

  // STANDARD KEYMAPS

  var keyMap = CodeMirror.keyMap = {};
  keyMap.basic = {
    "Left": "goCharLeft", "Right": "goCharRight", "Up": "goLineUp", "Down": "goLineDown",
    "End": "goLineEnd", "Home": "goLineStartSmart", "PageUp": "goPageUp", "PageDown": "goPageDown",
    "Delete": "delCharAfter", "Backspace": "delCharBefore", "Shift-Backspace": "delCharBefore",
    "Tab": "defaultTab", "Shift-Tab": "indentAuto",
    "Enter": "newlineAndIndent", "Insert": "toggleOverwrite",
    "Esc": "singleSelection"
  };
  // Note that the save and find-related commands aren't defined by
  // default. User code or addons can define them. Unknown commands
  // are simply ignored.
  keyMap.pcDefault = {
    "Ctrl-A": "selectAll", "Ctrl-D": "deleteLine", "Ctrl-Z": "undo", "Shift-Ctrl-Z": "redo", "Ctrl-Y": "redo",
    "Ctrl-Home": "goDocStart", "Ctrl-Up": "goDocStart", "Ctrl-End": "goDocEnd", "Ctrl-Down": "goDocEnd",
    "Ctrl-Left": "goGroupLeft", "Ctrl-Right": "goGroupRight", "Alt-Left": "goLineStart", "Alt-Right": "goLineEnd",
    "Ctrl-Backspace": "delGroupBefore", "Ctrl-Delete": "delGroupAfter", "Ctrl-S": "save", "Ctrl-F": "find",
    "Ctrl-G": "findNext", "Shift-Ctrl-G": "findPrev", "Shift-Ctrl-F": "replace", "Shift-Ctrl-R": "replaceAll",
    "Ctrl-[": "indentLess", "Ctrl-]": "indentMore",
    "Ctrl-U": "undoSelection", "Shift-Ctrl-U": "redoSelection", "Alt-U": "redoSelection",
    fallthrough: "basic"
  };
  keyMap.macDefault = {
    "Cmd-A": "selectAll", "Cmd-D": "deleteLine", "Cmd-Z": "undo", "Shift-Cmd-Z": "redo", "Cmd-Y": "redo",
    "Cmd-Up": "goDocStart", "Cmd-End": "goDocEnd", "Cmd-Down": "goDocEnd", "Alt-Left": "goGroupLeft",
    "Alt-Right": "goGroupRight", "Cmd-Left": "goLineStart", "Cmd-Right": "goLineEnd", "Alt-Backspace": "delGroupBefore",
    "Ctrl-Alt-Backspace": "delGroupAfter", "Alt-Delete": "delGroupAfter", "Cmd-S": "save", "Cmd-F": "find",
    "Cmd-G": "findNext", "Shift-Cmd-G": "findPrev", "Cmd-Alt-F": "replace", "Shift-Cmd-Alt-F": "replaceAll",
    "Cmd-[": "indentLess", "Cmd-]": "indentMore", "Cmd-Backspace": "delLineLeft",
    "Cmd-U": "undoSelection", "Shift-Cmd-U": "redoSelection",
    fallthrough: ["basic", "emacsy"]
  };
  // Very basic readline/emacs-style bindings, which are standard on Mac.
  keyMap.emacsy = {
    "Ctrl-F": "goCharRight", "Ctrl-B": "goCharLeft", "Ctrl-P": "goLineUp", "Ctrl-N": "goLineDown",
    "Alt-F": "goWordRight", "Alt-B": "goWordLeft", "Ctrl-A": "goLineStart", "Ctrl-E": "goLineEnd",
    "Ctrl-V": "goPageDown", "Shift-Ctrl-V": "goPageUp", "Ctrl-D": "delCharAfter", "Ctrl-H": "delCharBefore",
    "Alt-D": "delWordAfter", "Alt-Backspace": "delWordBefore", "Ctrl-K": "killLine", "Ctrl-T": "transposeChars"
  };
  keyMap["default"] = mac ? keyMap.macDefault : keyMap.pcDefault;

  // KEYMAP DISPATCH

  function getKeyMap(val) {
    if (typeof val == "string") return keyMap[val];
    else return val;
  }

  // Given an array of keymaps and a key name, call handle on any
  // bindings found, until that returns a truthy value, at which point
  // we consider the key handled. Implements things like binding a key
  // to false stopping further handling and keymap fallthrough.
  var lookupKey = CodeMirror.lookupKey = function(name, maps, handle) {
    function lookup(map) {
      map = getKeyMap(map);
      var found = map[name];
      if (found === false) return "stop";
      if (found != null && handle(found)) return true;
      if (map.nofallthrough) return "stop";

      var fallthrough = map.fallthrough;
      if (fallthrough == null) return false;
      if (Object.prototype.toString.call(fallthrough) != "[object Array]")
        return lookup(fallthrough);
      for (var i = 0; i < fallthrough.length; ++i) {
        var done = lookup(fallthrough[i]);
        if (done) return done;
      }
      return false;
    }

    for (var i = 0; i < maps.length; ++i) {
      var done = lookup(maps[i]);
      if (done) return done != "stop";
    }
  };

  // Modifier key presses don't count as 'real' key presses for the
  // purpose of keymap fallthrough.
  var isModifierKey = CodeMirror.isModifierKey = function(event) {
    var name = keyNames[event.keyCode];
    return name == "Ctrl" || name == "Alt" || name == "Shift" || name == "Mod";
  };

  // Look up the name of a key as indicated by an event object.
  var keyName = CodeMirror.keyName = function(event, noShift) {
    if (presto && event.keyCode == 34 && event["char"]) return false;
    var name = keyNames[event.keyCode];
    if (name == null || event.altGraphKey) return false;
    if (event.altKey) name = "Alt-" + name;
    if (flipCtrlCmd ? event.metaKey : event.ctrlKey) name = "Ctrl-" + name;
    if (flipCtrlCmd ? event.ctrlKey : event.metaKey) name = "Cmd-" + name;
    if (!noShift && event.shiftKey) name = "Shift-" + name;
    return name;
  };

  // FROMTEXTAREA

  CodeMirror.fromTextArea = function(textarea, options) {
    if (!options) options = {};
    options.value = textarea.value;
    if (!options.tabindex && textarea.tabindex)
      options.tabindex = textarea.tabindex;
    if (!options.placeholder && textarea.placeholder)
      options.placeholder = textarea.placeholder;
    // Set autofocus to true if this textarea is focused, or if it has
    // autofocus and no other element is focused.
    if (options.autofocus == null) {
      var hasFocus = activeElt();
      options.autofocus = hasFocus == textarea ||
        textarea.getAttribute("autofocus") != null && hasFocus == document.body;
    }

    function save() {textarea.value = cm.getValue();}
    if (textarea.form) {
      on(textarea.form, "submit", save);
      // Deplorable hack to make the submit method do the right thing.
      if (!options.leaveSubmitMethodAlone) {
        var form = textarea.form, realSubmit = form.submit;
        try {
          var wrappedSubmit = form.submit = function() {
            save();
            form.submit = realSubmit;
            form.submit();
            form.submit = wrappedSubmit;
          };
        } catch(e) {}
      }
    }

    textarea.style.display = "none";
    var cm = CodeMirror(function(node) {
      textarea.parentNode.insertBefore(node, textarea.nextSibling);
    }, options);
    cm.save = save;
    cm.getTextArea = function() { return textarea; };
    cm.toTextArea = function() {
      save();
      textarea.parentNode.removeChild(cm.getWrapperElement());
      textarea.style.display = "";
      if (textarea.form) {
        off(textarea.form, "submit", save);
        if (typeof textarea.form.submit == "function")
          textarea.form.submit = realSubmit;
      }
    };
    return cm;
  };

  // STRING STREAM

  // Fed to the mode parsers, provides helper functions to make
  // parsers more succinct.

  var StringStream = CodeMirror.StringStream = function(string, tabSize) {
    this.pos = this.start = 0;
    this.string = string;
    this.tabSize = tabSize || 8;
    this.lastColumnPos = this.lastColumnValue = 0;
    this.lineStart = 0;
  };

  StringStream.prototype = {
    eol: function() {return this.pos >= this.string.length;},
    sol: function() {return this.pos == this.lineStart;},
    peek: function() {return this.string.charAt(this.pos) || undefined;},
    next: function() {
      if (this.pos < this.string.length)
        return this.string.charAt(this.pos++);
    },
    eat: function(match) {
      var ch = this.string.charAt(this.pos);
      if (typeof match == "string") var ok = ch == match;
      else var ok = ch && (match.test ? match.test(ch) : match(ch));
      if (ok) {++this.pos; return ch;}
    },
    eatWhile: function(match) {
      var start = this.pos;
      while (this.eat(match)){}
      return this.pos > start;
    },
    eatSpace: function() {
      var start = this.pos;
      while (/[\s\u00a0]/.test(this.string.charAt(this.pos))) ++this.pos;
      return this.pos > start;
    },
    skipToEnd: function() {this.pos = this.string.length;},
    skipTo: function(ch) {
      var found = this.string.indexOf(ch, this.pos);
      if (found > -1) {this.pos = found; return true;}
    },
    backUp: function(n) {this.pos -= n;},
    column: function() {
      if (this.lastColumnPos < this.start) {
        this.lastColumnValue = countColumn(this.string, this.start, this.tabSize, this.lastColumnPos, this.lastColumnValue);
        this.lastColumnPos = this.start;
      }
      return this.lastColumnValue - (this.lineStart ? countColumn(this.string, this.lineStart, this.tabSize) : 0);
    },
    indentation: function() {
      return countColumn(this.string, null, this.tabSize) -
        (this.lineStart ? countColumn(this.string, this.lineStart, this.tabSize) : 0);
    },
    match: function(pattern, consume, caseInsensitive) {
      if (typeof pattern == "string") {
        var cased = function(str) {return caseInsensitive ? str.toLowerCase() : str;};
        var substr = this.string.substr(this.pos, pattern.length);
        if (cased(substr) == cased(pattern)) {
          if (consume !== false) this.pos += pattern.length;
          return true;
        }
      } else {
        var match = this.string.slice(this.pos).match(pattern);
        if (match && match.index > 0) return null;
        if (match && consume !== false) this.pos += match[0].length;
        return match;
      }
    },
    current: function(){return this.string.slice(this.start, this.pos);},
    hideFirstChars: function(n, inner) {
      this.lineStart += n;
      try { return inner(); }
      finally { this.lineStart -= n; }
    }
  };

  // TEXTMARKERS

  // Created with markText and setBookmark methods. A TextMarker is a
  // handle that can be used to clear or find a marked position in the
  // document. Line objects hold arrays (markedSpans) containing
  // {from, to, marker} object pointing to such marker objects, and
  // indicating that such a marker is present on that line. Multiple
  // lines may point to the same marker when it spans across lines.
  // The spans will have null for their from/to properties when the
  // marker continues beyond the start/end of the line. Markers have
  // links back to the lines they currently touch.

  var TextMarker = CodeMirror.TextMarker = function(doc, type) {
    this.lines = [];
    this.type = type;
    this.doc = doc;
  };
  eventMixin(TextMarker);

  // Clear the marker.
  TextMarker.prototype.clear = function() {
    if (this.explicitlyCleared) return;
    var cm = this.doc.cm, withOp = cm && !cm.curOp;
    if (withOp) startOperation(cm);
    if (hasHandler(this, "clear")) {
      var found = this.find();
      if (found) signalLater(this, "clear", found.from, found.to);
    }
    var min = null, max = null;
    for (var i = 0; i < this.lines.length; ++i) {
      var line = this.lines[i];
      var span = getMarkedSpanFor(line.markedSpans, this);
      if (cm && !this.collapsed) regLineChange(cm, lineNo(line), "text");
      else if (cm) {
        if (span.to != null) max = lineNo(line);
        if (span.from != null) min = lineNo(line);
      }
      line.markedSpans = removeMarkedSpan(line.markedSpans, span);
      if (span.from == null && this.collapsed && !lineIsHidden(this.doc, line) && cm)
        updateLineHeight(line, textHeight(cm.display));
    }
    if (cm && this.collapsed && !cm.options.lineWrapping) for (var i = 0; i < this.lines.length; ++i) {
      var visual = visualLine(this.lines[i]), len = lineLength(visual);
      if (len > cm.display.maxLineLength) {
        cm.display.maxLine = visual;
        cm.display.maxLineLength = len;
        cm.display.maxLineChanged = true;
      }
    }

    if (min != null && cm && this.collapsed) regChange(cm, min, max + 1);
    this.lines.length = 0;
    this.explicitlyCleared = true;
    if (this.atomic && this.doc.cantEdit) {
      this.doc.cantEdit = false;
      if (cm) reCheckSelection(cm.doc);
    }
    if (cm) signalLater(cm, "markerCleared", cm, this);
    if (withOp) endOperation(cm);
    if (this.parent) this.parent.clear();
  };

  // Find the position of the marker in the document. Returns a {from,
  // to} object by default. Side can be passed to get a specific side
  // -- 0 (both), -1 (left), or 1 (right). When lineObj is true, the
  // Pos objects returned contain a line object, rather than a line
  // number (used to prevent looking up the same line twice).
  TextMarker.prototype.find = function(side, lineObj) {
    if (side == null && this.type == "bookmark") side = 1;
    var from, to;
    for (var i = 0; i < this.lines.length; ++i) {
      var line = this.lines[i];
      var span = getMarkedSpanFor(line.markedSpans, this);
      if (span.from != null) {
        from = Pos(lineObj ? line : lineNo(line), span.from);
        if (side == -1) return from;
      }
      if (span.to != null) {
        to = Pos(lineObj ? line : lineNo(line), span.to);
        if (side == 1) return to;
      }
    }
    return from && {from: from, to: to};
  };

  // Signals that the marker's widget changed, and surrounding layout
  // should be recomputed.
  TextMarker.prototype.changed = function() {
    var pos = this.find(-1, true), widget = this, cm = this.doc.cm;
    if (!pos || !cm) return;
    runInOp(cm, function() {
      var line = pos.line, lineN = lineNo(pos.line);
      var view = findViewForLine(cm, lineN);
      if (view) {
        clearLineMeasurementCacheFor(view);
        cm.curOp.selectionChanged = cm.curOp.forceUpdate = true;
      }
      cm.curOp.updateMaxLine = true;
      if (!lineIsHidden(widget.doc, line) && widget.height != null) {
        var oldHeight = widget.height;
        widget.height = null;
        var dHeight = widgetHeight(widget) - oldHeight;
        if (dHeight)
          updateLineHeight(line, line.height + dHeight);
      }
    });
  };

  TextMarker.prototype.attachLine = function(line) {
    if (!this.lines.length && this.doc.cm) {
      var op = this.doc.cm.curOp;
      if (!op.maybeHiddenMarkers || indexOf(op.maybeHiddenMarkers, this) == -1)
        (op.maybeUnhiddenMarkers || (op.maybeUnhiddenMarkers = [])).push(this);
    }
    this.lines.push(line);
  };
  TextMarker.prototype.detachLine = function(line) {
    this.lines.splice(indexOf(this.lines, line), 1);
    if (!this.lines.length && this.doc.cm) {
      var op = this.doc.cm.curOp;
      (op.maybeHiddenMarkers || (op.maybeHiddenMarkers = [])).push(this);
    }
  };

  // Collapsed markers have unique ids, in order to be able to order
  // them, which is needed for uniquely determining an outer marker
  // when they overlap (they may nest, but not partially overlap).
  var nextMarkerId = 0;

  // Create a marker, wire it up to the right lines, and
  function markText(doc, from, to, options, type) {
    // Shared markers (across linked documents) are handled separately
    // (markTextShared will call out to this again, once per
    // document).
    if (options && options.shared) return markTextShared(doc, from, to, options, type);
    // Ensure we are in an operation.
    if (doc.cm && !doc.cm.curOp) return operation(doc.cm, markText)(doc, from, to, options, type);

    var marker = new TextMarker(doc, type), diff = cmp(from, to);
    if (options) copyObj(options, marker, false);
    // Don't connect empty markers unless clearWhenEmpty is false
    if (diff > 0 || diff == 0 && marker.clearWhenEmpty !== false)
      return marker;
    if (marker.replacedWith) {
      // Showing up as a widget implies collapsed (widget replaces text)
      marker.collapsed = true;
      marker.widgetNode = elt("span", [marker.replacedWith], "CodeMirror-widget");
      if (!options.handleMouseEvents) marker.widgetNode.ignoreEvents = true;
      if (options.insertLeft) marker.widgetNode.insertLeft = true;
    }
    if (marker.collapsed) {
      if (conflictingCollapsedRange(doc, from.line, from, to, marker) ||
          from.line != to.line && conflictingCollapsedRange(doc, to.line, from, to, marker))
        throw new Error("Inserting collapsed marker partially overlapping an existing one");
      sawCollapsedSpans = true;
    }

    if (marker.addToHistory)
      addChangeToHistory(doc, {from: from, to: to, origin: "markText"}, doc.sel, NaN);

    var curLine = from.line, cm = doc.cm, updateMaxLine;
    doc.iter(curLine, to.line + 1, function(line) {
      if (cm && marker.collapsed && !cm.options.lineWrapping && visualLine(line) == cm.display.maxLine)
        updateMaxLine = true;
      if (marker.collapsed && curLine != from.line) updateLineHeight(line, 0);
      addMarkedSpan(line, new MarkedSpan(marker,
                                         curLine == from.line ? from.ch : null,
                                         curLine == to.line ? to.ch : null));
      ++curLine;
    });
    // lineIsHidden depends on the presence of the spans, so needs a second pass
    if (marker.collapsed) doc.iter(from.line, to.line + 1, function(line) {
      if (lineIsHidden(doc, line)) updateLineHeight(line, 0);
    });

    if (marker.clearOnEnter) on(marker, "beforeCursorEnter", function() { marker.clear(); });

    if (marker.readOnly) {
      sawReadOnlySpans = true;
      if (doc.history.done.length || doc.history.undone.length)
        doc.clearHistory();
    }
    if (marker.collapsed) {
      marker.id = ++nextMarkerId;
      marker.atomic = true;
    }
    if (cm) {
      // Sync editor state
      if (updateMaxLine) cm.curOp.updateMaxLine = true;
      if (marker.collapsed)
        regChange(cm, from.line, to.line + 1);
      else if (marker.className || marker.title || marker.startStyle || marker.endStyle)
        for (var i = from.line; i <= to.line; i++) regLineChange(cm, i, "text");
      if (marker.atomic) reCheckSelection(cm.doc);
      signalLater(cm, "markerAdded", cm, marker);
    }
    return marker;
  }

  // SHARED TEXTMARKERS

  // A shared marker spans multiple linked documents. It is
  // implemented as a meta-marker-object controlling multiple normal
  // markers.
  var SharedTextMarker = CodeMirror.SharedTextMarker = function(markers, primary) {
    this.markers = markers;
    this.primary = primary;
    for (var i = 0; i < markers.length; ++i)
      markers[i].parent = this;
  };
  eventMixin(SharedTextMarker);

  SharedTextMarker.prototype.clear = function() {
    if (this.explicitlyCleared) return;
    this.explicitlyCleared = true;
    for (var i = 0; i < this.markers.length; ++i)
      this.markers[i].clear();
    signalLater(this, "clear");
  };
  SharedTextMarker.prototype.find = function(side, lineObj) {
    return this.primary.find(side, lineObj);
  };

  function markTextShared(doc, from, to, options, type) {
    options = copyObj(options);
    options.shared = false;
    var markers = [markText(doc, from, to, options, type)], primary = markers[0];
    var widget = options.widgetNode;
    linkedDocs(doc, function(doc) {
      if (widget) options.widgetNode = widget.cloneNode(true);
      markers.push(markText(doc, clipPos(doc, from), clipPos(doc, to), options, type));
      for (var i = 0; i < doc.linked.length; ++i)
        if (doc.linked[i].isParent) return;
      primary = lst(markers);
    });
    return new SharedTextMarker(markers, primary);
  }

  function findSharedMarkers(doc) {
    return doc.findMarks(Pos(doc.first, 0), doc.clipPos(Pos(doc.lastLine())),
                         function(m) { return m.parent; });
  }

  function copySharedMarkers(doc, markers) {
    for (var i = 0; i < markers.length; i++) {
      var marker = markers[i], pos = marker.find();
      var mFrom = doc.clipPos(pos.from), mTo = doc.clipPos(pos.to);
      if (cmp(mFrom, mTo)) {
        var subMark = markText(doc, mFrom, mTo, marker.primary, marker.primary.type);
        marker.markers.push(subMark);
        subMark.parent = marker;
      }
    }
  }

  function detachSharedMarkers(markers) {
    for (var i = 0; i < markers.length; i++) {
      var marker = markers[i], linked = [marker.primary.doc];;
      linkedDocs(marker.primary.doc, function(d) { linked.push(d); });
      for (var j = 0; j < marker.markers.length; j++) {
        var subMarker = marker.markers[j];
        if (indexOf(linked, subMarker.doc) == -1) {
          subMarker.parent = null;
          marker.markers.splice(j--, 1);
        }
      }
    }
  }

  // TEXTMARKER SPANS

  function MarkedSpan(marker, from, to) {
    this.marker = marker;
    this.from = from; this.to = to;
  }

  // Search an array of spans for a span matching the given marker.
  function getMarkedSpanFor(spans, marker) {
    if (spans) for (var i = 0; i < spans.length; ++i) {
      var span = spans[i];
      if (span.marker == marker) return span;
    }
  }
  // Remove a span from an array, returning undefined if no spans are
  // left (we don't store arrays for lines without spans).
  function removeMarkedSpan(spans, span) {
    for (var r, i = 0; i < spans.length; ++i)
      if (spans[i] != span) (r || (r = [])).push(spans[i]);
    return r;
  }
  // Add a span to a line.
  function addMarkedSpan(line, span) {
    line.markedSpans = line.markedSpans ? line.markedSpans.concat([span]) : [span];
    span.marker.attachLine(line);
  }

  // Used for the algorithm that adjusts markers for a change in the
  // document. These functions cut an array of spans at a given
  // character position, returning an array of remaining chunks (or
  // undefined if nothing remains).
  function markedSpansBefore(old, startCh, isInsert) {
    if (old) for (var i = 0, nw; i < old.length; ++i) {
      var span = old[i], marker = span.marker;
      var startsBefore = span.from == null || (marker.inclusiveLeft ? span.from <= startCh : span.from < startCh);
      if (startsBefore || span.from == startCh && marker.type == "bookmark" && (!isInsert || !span.marker.insertLeft)) {
        var endsAfter = span.to == null || (marker.inclusiveRight ? span.to >= startCh : span.to > startCh);
        (nw || (nw = [])).push(new MarkedSpan(marker, span.from, endsAfter ? null : span.to));
      }
    }
    return nw;
  }
  function markedSpansAfter(old, endCh, isInsert) {
    if (old) for (var i = 0, nw; i < old.length; ++i) {
      var span = old[i], marker = span.marker;
      var endsAfter = span.to == null || (marker.inclusiveRight ? span.to >= endCh : span.to > endCh);
      if (endsAfter || span.from == endCh && marker.type == "bookmark" && (!isInsert || span.marker.insertLeft)) {
        var startsBefore = span.from == null || (marker.inclusiveLeft ? span.from <= endCh : span.from < endCh);
        (nw || (nw = [])).push(new MarkedSpan(marker, startsBefore ? null : span.from - endCh,
                                              span.to == null ? null : span.to - endCh));
      }
    }
    return nw;
  }

  // Given a change object, compute the new set of marker spans that
  // cover the line in which the change took place. Removes spans
  // entirely within the change, reconnects spans belonging to the
  // same marker that appear on both sides of the change, and cuts off
  // spans partially within the change. Returns an array of span
  // arrays with one element for each line in (after) the change.
  function stretchSpansOverChange(doc, change) {
    var oldFirst = isLine(doc, change.from.line) && getLine(doc, change.from.line).markedSpans;
    var oldLast = isLine(doc, change.to.line) && getLine(doc, change.to.line).markedSpans;
    if (!oldFirst && !oldLast) return null;

    var startCh = change.from.ch, endCh = change.to.ch, isInsert = cmp(change.from, change.to) == 0;
    // Get the spans that 'stick out' on both sides
    var first = markedSpansBefore(oldFirst, startCh, isInsert);
    var last = markedSpansAfter(oldLast, endCh, isInsert);

    // Next, merge those two ends
    var sameLine = change.text.length == 1, offset = lst(change.text).length + (sameLine ? startCh : 0);
    if (first) {
      // Fix up .to properties of first
      for (var i = 0; i < first.length; ++i) {
        var span = first[i];
        if (span.to == null) {
          var found = getMarkedSpanFor(last, span.marker);
          if (!found) span.to = startCh;
          else if (sameLine) span.to = found.to == null ? null : found.to + offset;
        }
      }
    }
    if (last) {
      // Fix up .from in last (or move them into first in case of sameLine)
      for (var i = 0; i < last.length; ++i) {
        var span = last[i];
        if (span.to != null) span.to += offset;
        if (span.from == null) {
          var found = getMarkedSpanFor(first, span.marker);
          if (!found) {
            span.from = offset;
            if (sameLine) (first || (first = [])).push(span);
          }
        } else {
          span.from += offset;
          if (sameLine) (first || (first = [])).push(span);
        }
      }
    }
    // Make sure we didn't create any zero-length spans
    if (first) first = clearEmptySpans(first);
    if (last && last != first) last = clearEmptySpans(last);

    var newMarkers = [first];
    if (!sameLine) {
      // Fill gap with whole-line-spans
      var gap = change.text.length - 2, gapMarkers;
      if (gap > 0 && first)
        for (var i = 0; i < first.length; ++i)
          if (first[i].to == null)
            (gapMarkers || (gapMarkers = [])).push(new MarkedSpan(first[i].marker, null, null));
      for (var i = 0; i < gap; ++i)
        newMarkers.push(gapMarkers);
      newMarkers.push(last);
    }
    return newMarkers;
  }

  // Remove spans that are empty and don't have a clearWhenEmpty
  // option of false.
  function clearEmptySpans(spans) {
    for (var i = 0; i < spans.length; ++i) {
      var span = spans[i];
      if (span.from != null && span.from == span.to && span.marker.clearWhenEmpty !== false)
        spans.splice(i--, 1);
    }
    if (!spans.length) return null;
    return spans;
  }

  // Used for un/re-doing changes from the history. Combines the
  // result of computing the existing spans with the set of spans that
  // existed in the history (so that deleting around a span and then
  // undoing brings back the span).
  function mergeOldSpans(doc, change) {
    var old = getOldSpans(doc, change);
    var stretched = stretchSpansOverChange(doc, change);
    if (!old) return stretched;
    if (!stretched) return old;

    for (var i = 0; i < old.length; ++i) {
      var oldCur = old[i], stretchCur = stretched[i];
      if (oldCur && stretchCur) {
        spans: for (var j = 0; j < stretchCur.length; ++j) {
          var span = stretchCur[j];
          for (var k = 0; k < oldCur.length; ++k)
            if (oldCur[k].marker == span.marker) continue spans;
          oldCur.push(span);
        }
      } else if (stretchCur) {
        old[i] = stretchCur;
      }
    }
    return old;
  }

  // Used to 'clip' out readOnly ranges when making a change.
  function removeReadOnlyRanges(doc, from, to) {
    var markers = null;
    doc.iter(from.line, to.line + 1, function(line) {
      if (line.markedSpans) for (var i = 0; i < line.markedSpans.length; ++i) {
        var mark = line.markedSpans[i].marker;
        if (mark.readOnly && (!markers || indexOf(markers, mark) == -1))
          (markers || (markers = [])).push(mark);
      }
    });
    if (!markers) return null;
    var parts = [{from: from, to: to}];
    for (var i = 0; i < markers.length; ++i) {
      var mk = markers[i], m = mk.find(0);
      for (var j = 0; j < parts.length; ++j) {
        var p = parts[j];
        if (cmp(p.to, m.from) < 0 || cmp(p.from, m.to) > 0) continue;
        var newParts = [j, 1], dfrom = cmp(p.from, m.from), dto = cmp(p.to, m.to);
        if (dfrom < 0 || !mk.inclusiveLeft && !dfrom)
          newParts.push({from: p.from, to: m.from});
        if (dto > 0 || !mk.inclusiveRight && !dto)
          newParts.push({from: m.to, to: p.to});
        parts.splice.apply(parts, newParts);
        j += newParts.length - 1;
      }
    }
    return parts;
  }

  // Connect or disconnect spans from a line.
  function detachMarkedSpans(line) {
    var spans = line.markedSpans;
    if (!spans) return;
    for (var i = 0; i < spans.length; ++i)
      spans[i].marker.detachLine(line);
    line.markedSpans = null;
  }
  function attachMarkedSpans(line, spans) {
    if (!spans) return;
    for (var i = 0; i < spans.length; ++i)
      spans[i].marker.attachLine(line);
    line.markedSpans = spans;
  }

  // Helpers used when computing which overlapping collapsed span
  // counts as the larger one.
  function extraLeft(marker) { return marker.inclusiveLeft ? -1 : 0; }
  function extraRight(marker) { return marker.inclusiveRight ? 1 : 0; }

  // Returns a number indicating which of two overlapping collapsed
  // spans is larger (and thus includes the other). Falls back to
  // comparing ids when the spans cover exactly the same range.
  function compareCollapsedMarkers(a, b) {
    var lenDiff = a.lines.length - b.lines.length;
    if (lenDiff != 0) return lenDiff;
    var aPos = a.find(), bPos = b.find();
    var fromCmp = cmp(aPos.from, bPos.from) || extraLeft(a) - extraLeft(b);
    if (fromCmp) return -fromCmp;
    var toCmp = cmp(aPos.to, bPos.to) || extraRight(a) - extraRight(b);
    if (toCmp) return toCmp;
    return b.id - a.id;
  }

  // Find out whether a line ends or starts in a collapsed span. If
  // so, return the marker for that span.
  function collapsedSpanAtSide(line, start) {
    var sps = sawCollapsedSpans && line.markedSpans, found;
    if (sps) for (var sp, i = 0; i < sps.length; ++i) {
      sp = sps[i];
      if (sp.marker.collapsed && (start ? sp.from : sp.to) == null &&
          (!found || compareCollapsedMarkers(found, sp.marker) < 0))
        found = sp.marker;
    }
    return found;
  }
  function collapsedSpanAtStart(line) { return collapsedSpanAtSide(line, true); }
  function collapsedSpanAtEnd(line) { return collapsedSpanAtSide(line, false); }

  // Test whether there exists a collapsed span that partially
  // overlaps (covers the start or end, but not both) of a new span.
  // Such overlap is not allowed.
  function conflictingCollapsedRange(doc, lineNo, from, to, marker) {
    var line = getLine(doc, lineNo);
    var sps = sawCollapsedSpans && line.markedSpans;
    if (sps) for (var i = 0; i < sps.length; ++i) {
      var sp = sps[i];
      if (!sp.marker.collapsed) continue;
      var found = sp.marker.find(0);
      var fromCmp = cmp(found.from, from) || extraLeft(sp.marker) - extraLeft(marker);
      var toCmp = cmp(found.to, to) || extraRight(sp.marker) - extraRight(marker);
      if (fromCmp >= 0 && toCmp <= 0 || fromCmp <= 0 && toCmp >= 0) continue;
      if (fromCmp <= 0 && (cmp(found.to, from) > 0 || (sp.marker.inclusiveRight && marker.inclusiveLeft)) ||
          fromCmp >= 0 && (cmp(found.from, to) < 0 || (sp.marker.inclusiveLeft && marker.inclusiveRight)))
        return true;
    }
  }

  // A visual line is a line as drawn on the screen. Folding, for
  // example, can cause multiple logical lines to appear on the same
  // visual line. This finds the start of the visual line that the
  // given line is part of (usually that is the line itself).
  function visualLine(line) {
    var merged;
    while (merged = collapsedSpanAtStart(line))
      line = merged.find(-1, true).line;
    return line;
  }

  // Returns an array of logical lines that continue the visual line
  // started by the argument, or undefined if there are no such lines.
  function visualLineContinued(line) {
    var merged, lines;
    while (merged = collapsedSpanAtEnd(line)) {
      line = merged.find(1, true).line;
      (lines || (lines = [])).push(line);
    }
    return lines;
  }

  // Get the line number of the start of the visual line that the
  // given line number is part of.
  function visualLineNo(doc, lineN) {
    var line = getLine(doc, lineN), vis = visualLine(line);
    if (line == vis) return lineN;
    return lineNo(vis);
  }
  // Get the line number of the start of the next visual line after
  // the given line.
  function visualLineEndNo(doc, lineN) {
    if (lineN > doc.lastLine()) return lineN;
    var line = getLine(doc, lineN), merged;
    if (!lineIsHidden(doc, line)) return lineN;
    while (merged = collapsedSpanAtEnd(line))
      line = merged.find(1, true).line;
    return lineNo(line) + 1;
  }

  // Compute whether a line is hidden. Lines count as hidden when they
  // are part of a visual line that starts with another line, or when
  // they are entirely covered by collapsed, non-widget span.
  function lineIsHidden(doc, line) {
    var sps = sawCollapsedSpans && line.markedSpans;
    if (sps) for (var sp, i = 0; i < sps.length; ++i) {
      sp = sps[i];
      if (!sp.marker.collapsed) continue;
      if (sp.from == null) return true;
      if (sp.marker.widgetNode) continue;
      if (sp.from == 0 && sp.marker.inclusiveLeft && lineIsHiddenInner(doc, line, sp))
        return true;
    }
  }
  function lineIsHiddenInner(doc, line, span) {
    if (span.to == null) {
      var end = span.marker.find(1, true);
      return lineIsHiddenInner(doc, end.line, getMarkedSpanFor(end.line.markedSpans, span.marker));
    }
    if (span.marker.inclusiveRight && span.to == line.text.length)
      return true;
    for (var sp, i = 0; i < line.markedSpans.length; ++i) {
      sp = line.markedSpans[i];
      if (sp.marker.collapsed && !sp.marker.widgetNode && sp.from == span.to &&
          (sp.to == null || sp.to != span.from) &&
          (sp.marker.inclusiveLeft || span.marker.inclusiveRight) &&
          lineIsHiddenInner(doc, line, sp)) return true;
    }
  }

  // LINE WIDGETS

  // Line widgets are block elements displayed above or below a line.

  var LineWidget = CodeMirror.LineWidget = function(cm, node, options) {
    if (options) for (var opt in options) if (options.hasOwnProperty(opt))
      this[opt] = options[opt];
    this.cm = cm;
    this.node = node;
  };
  eventMixin(LineWidget);

  function adjustScrollWhenAboveVisible(cm, line, diff) {
    if (heightAtLine(line) < ((cm.curOp && cm.curOp.scrollTop) || cm.doc.scrollTop))
      addToScrollPos(cm, null, diff);
  }

  LineWidget.prototype.clear = function() {
    var cm = this.cm, ws = this.line.widgets, line = this.line, no = lineNo(line);
    if (no == null || !ws) return;
    for (var i = 0; i < ws.length; ++i) if (ws[i] == this) ws.splice(i--, 1);
    if (!ws.length) line.widgets = null;
    var height = widgetHeight(this);
    runInOp(cm, function() {
      adjustScrollWhenAboveVisible(cm, line, -height);
      regLineChange(cm, no, "widget");
      updateLineHeight(line, Math.max(0, line.height - height));
    });
  };
  LineWidget.prototype.changed = function() {
    var oldH = this.height, cm = this.cm, line = this.line;
    this.height = null;
    var diff = widgetHeight(this) - oldH;
    if (!diff) return;
    runInOp(cm, function() {
      cm.curOp.forceUpdate = true;
      adjustScrollWhenAboveVisible(cm, line, diff);
      updateLineHeight(line, line.height + diff);
    });
  };

  function widgetHeight(widget) {
    if (widget.height != null) return widget.height;
    if (!contains(document.body, widget.node)) {
      var parentStyle = "position: relative;";
      if (widget.coverGutter)
        parentStyle += "margin-left: -" + widget.cm.getGutterElement().offsetWidth + "px;";
      removeChildrenAndAdd(widget.cm.display.measure, elt("div", [widget.node], null, parentStyle));
    }
    return widget.height = widget.node.offsetHeight;
  }

  function addLineWidget(cm, handle, node, options) {
    var widget = new LineWidget(cm, node, options);
    if (widget.noHScroll) cm.display.alignWidgets = true;
    changeLine(cm.doc, handle, "widget", function(line) {
      var widgets = line.widgets || (line.widgets = []);
      if (widget.insertAt == null) widgets.push(widget);
      else widgets.splice(Math.min(widgets.length - 1, Math.max(0, widget.insertAt)), 0, widget);
      widget.line = line;
      if (!lineIsHidden(cm.doc, line)) {
        var aboveVisible = heightAtLine(line) < cm.doc.scrollTop;
        updateLineHeight(line, line.height + widgetHeight(widget));
        if (aboveVisible) addToScrollPos(cm, null, widget.height);
        cm.curOp.forceUpdate = true;
      }
      return true;
    });
    return widget;
  }

  // LINE DATA STRUCTURE

  // Line objects. These hold state related to a line, including
  // highlighting info (the styles array).
  var Line = CodeMirror.Line = function(text, markedSpans, estimateHeight) {
    this.text = text;
    attachMarkedSpans(this, markedSpans);
    this.height = estimateHeight ? estimateHeight(this) : 1;
  };
  eventMixin(Line);
  Line.prototype.lineNo = function() { return lineNo(this); };

  // Change the content (text, markers) of a line. Automatically
  // invalidates cached information and tries to re-estimate the
  // line's height.
  function updateLine(line, text, markedSpans, estimateHeight) {
    line.text = text;
    if (line.stateAfter) line.stateAfter = null;
    if (line.styles) line.styles = null;
    if (line.order != null) line.order = null;
    detachMarkedSpans(line);
    attachMarkedSpans(line, markedSpans);
    var estHeight = estimateHeight ? estimateHeight(line) : 1;
    if (estHeight != line.height) updateLineHeight(line, estHeight);
  }

  // Detach a line from the document tree and its markers.
  function cleanUpLine(line) {
    line.parent = null;
    detachMarkedSpans(line);
  }

  function extractLineClasses(type, output) {
    if (type) for (;;) {
      var lineClass = type.match(/(?:^|\s+)line-(background-)?(\S+)/);
      if (!lineClass) break;
      type = type.slice(0, lineClass.index) + type.slice(lineClass.index + lineClass[0].length);
      var prop = lineClass[1] ? "bgClass" : "textClass";
      if (output[prop] == null)
        output[prop] = lineClass[2];
      else if (!(new RegExp("(?:^|\s)" + lineClass[2] + "(?:$|\s)")).test(output[prop]))
        output[prop] += " " + lineClass[2];
    }
    return type;
  }

  function callBlankLine(mode, state) {
    if (mode.blankLine) return mode.blankLine(state);
    if (!mode.innerMode) return;
    var inner = CodeMirror.innerMode(mode, state);
    if (inner.mode.blankLine) return inner.mode.blankLine(inner.state);
  }

  function readToken(mode, stream, state) {
    for (var i = 0; i < 10; i++) {
      var style = mode.token(stream, state);
      if (stream.pos > stream.start) return style;
    }
    throw new Error("Mode " + mode.name + " failed to advance stream.");
  }

  // Run the given mode's parser over a line, calling f for each token.
  function runMode(cm, text, mode, state, f, lineClasses, forceToEnd) {
    var flattenSpans = mode.flattenSpans;
    if (flattenSpans == null) flattenSpans = cm.options.flattenSpans;
    var curStart = 0, curStyle = null;
    var stream = new StringStream(text, cm.options.tabSize), style;
    if (text == "") extractLineClasses(callBlankLine(mode, state), lineClasses);
    while (!stream.eol()) {
      if (stream.pos > cm.options.maxHighlightLength) {
        flattenSpans = false;
        if (forceToEnd) processLine(cm, text, state, stream.pos);
        stream.pos = text.length;
        style = null;
      } else {
        style = extractLineClasses(readToken(mode, stream, state), lineClasses);
      }
      if (cm.options.addModeClass) {
        var mName = CodeMirror.innerMode(mode, state).mode.name;
        if (mName) style = "m-" + (style ? mName + " " + style : mName);
      }
      if (!flattenSpans || curStyle != style) {
        if (curStart < stream.start) f(stream.start, curStyle);
        curStart = stream.start; curStyle = style;
      }
      stream.start = stream.pos;
    }
    while (curStart < stream.pos) {
      // Webkit seems to refuse to render text nodes longer than 57444 characters
      var pos = Math.min(stream.pos, curStart + 50000);
      f(pos, curStyle);
      curStart = pos;
    }
  }

  // Compute a style array (an array starting with a mode generation
  // -- for invalidation -- followed by pairs of end positions and
  // style strings), which is used to highlight the tokens on the
  // line.
  function highlightLine(cm, line, state, forceToEnd) {
    // A styles array always starts with a number identifying the
    // mode/overlays that it is based on (for easy invalidation).
    var st = [cm.state.modeGen], lineClasses = {};
    // Compute the base array of styles
    runMode(cm, line.text, cm.doc.mode, state, function(end, style) {
      st.push(end, style);
    }, lineClasses, forceToEnd);

    // Run overlays, adjust style array.
    for (var o = 0; o < cm.state.overlays.length; ++o) {
      var overlay = cm.state.overlays[o], i = 1, at = 0;
      runMode(cm, line.text, overlay.mode, true, function(end, style) {
        var start = i;
        // Ensure there's a token end at the current position, and that i points at it
        while (at < end) {
          var i_end = st[i];
          if (i_end > end)
            st.splice(i, 1, end, st[i+1], i_end);
          i += 2;
          at = Math.min(end, i_end);
        }
        if (!style) return;
        if (overlay.opaque) {
          st.splice(start, i - start, end, "cm-overlay " + style);
          i = start + 2;
        } else {
          for (; start < i; start += 2) {
            var cur = st[start+1];
            st[start+1] = (cur ? cur + " " : "") + "cm-overlay " + style;
          }
        }
      }, lineClasses);
    }

    return {styles: st, classes: lineClasses.bgClass || lineClasses.textClass ? lineClasses : null};
  }

  function getLineStyles(cm, line) {
    if (!line.styles || line.styles[0] != cm.state.modeGen) {
      var result = highlightLine(cm, line, line.stateAfter = getStateBefore(cm, lineNo(line)));
      line.styles = result.styles;
      if (result.classes) line.styleClasses = result.classes;
      else if (line.styleClasses) line.styleClasses = null;
    }
    return line.styles;
  }

  // Lightweight form of highlight -- proceed over this line and
  // update state, but don't save a style array. Used for lines that
  // aren't currently visible.
  function processLine(cm, text, state, startAt) {
    var mode = cm.doc.mode;
    var stream = new StringStream(text, cm.options.tabSize);
    stream.start = stream.pos = startAt || 0;
    if (text == "") callBlankLine(mode, state);
    while (!stream.eol() && stream.pos <= cm.options.maxHighlightLength) {
      readToken(mode, stream, state);
      stream.start = stream.pos;
    }
  }

  // Convert a style as returned by a mode (either null, or a string
  // containing one or more styles) to a CSS style. This is cached,
  // and also looks for line-wide styles.
  var styleToClassCache = {}, styleToClassCacheWithMode = {};
  function interpretTokenStyle(style, options) {
    if (!style || /^\s*$/.test(style)) return null;
    var cache = options.addModeClass ? styleToClassCacheWithMode : styleToClassCache;
    return cache[style] ||
      (cache[style] = style.replace(/\S+/g, "cm-$&"));
  }

  // Render the DOM representation of the text of a line. Also builds
  // up a 'line map', which points at the DOM nodes that represent
  // specific stretches of text, and is used by the measuring code.
  // The returned object contains the DOM node, this map, and
  // information about line-wide styles that were set by the mode.
  function buildLineContent(cm, lineView) {
    // The padding-right forces the element to have a 'border', which
    // is needed on Webkit to be able to get line-level bounding
    // rectangles for it (in measureChar).
    var content = elt("span", null, null, webkit ? "padding-right: .1px" : null);
    var builder = {pre: elt("pre", [content]), content: content, col: 0, pos: 0, cm: cm};
    lineView.measure = {};

    // Iterate over the logical lines that make up this visual line.
    for (var i = 0; i <= (lineView.rest ? lineView.rest.length : 0); i++) {
      var line = i ? lineView.rest[i - 1] : lineView.line, order;
      builder.pos = 0;
      builder.addToken = buildToken;
      // Optionally wire in some hacks into the token-rendering
      // algorithm, to deal with browser quirks.
      if ((ie || webkit) && cm.getOption("lineWrapping"))
        builder.addToken = buildTokenSplitSpaces(builder.addToken);
      if (hasBadBidiRects(cm.display.measure) && (order = getOrder(line)))
        builder.addToken = buildTokenBadBidi(builder.addToken, order);
      builder.map = [];
      insertLineContent(line, builder, getLineStyles(cm, line));
      if (line.styleClasses) {
        if (line.styleClasses.bgClass)
          builder.bgClass = joinClasses(line.styleClasses.bgClass, builder.bgClass || "");
        if (line.styleClasses.textClass)
          builder.textClass = joinClasses(line.styleClasses.textClass, builder.textClass || "");
      }

      // Ensure at least a single node is present, for measuring.
      if (builder.map.length == 0)
        builder.map.push(0, 0, builder.content.appendChild(zeroWidthElement(cm.display.measure)));

      // Store the map and a cache object for the current logical line
      if (i == 0) {
        lineView.measure.map = builder.map;
        lineView.measure.cache = {};
      } else {
        (lineView.measure.maps || (lineView.measure.maps = [])).push(builder.map);
        (lineView.measure.caches || (lineView.measure.caches = [])).push({});
      }
    }

    signal(cm, "renderLine", cm, lineView.line, builder.pre);
    if (builder.pre.className)
      builder.textClass = joinClasses(builder.pre.className, builder.textClass || "");
    return builder;
  }

  function defaultSpecialCharPlaceholder(ch) {
    var token = elt("span", "\u2022", "cm-invalidchar");
    token.title = "\\u" + ch.charCodeAt(0).toString(16);
    return token;
  }

  // Build up the DOM representation for a single token, and add it to
  // the line map. Takes care to render special characters separately.
  function buildToken(builder, text, style, startStyle, endStyle, title) {
    if (!text) return;
    var special = builder.cm.options.specialChars, mustWrap = false;
    if (!special.test(text)) {
      builder.col += text.length;
      var content = document.createTextNode(text);
      builder.map.push(builder.pos, builder.pos + text.length, content);
      if (ie && ie_version < 9) mustWrap = true;
      builder.pos += text.length;
    } else {
      var content = document.createDocumentFragment(), pos = 0;
      while (true) {
        special.lastIndex = pos;
        var m = special.exec(text);
        var skipped = m ? m.index - pos : text.length - pos;
        if (skipped) {
          var txt = document.createTextNode(text.slice(pos, pos + skipped));
          if (ie && ie_version < 9) content.appendChild(elt("span", [txt]));
          else content.appendChild(txt);
          builder.map.push(builder.pos, builder.pos + skipped, txt);
          builder.col += skipped;
          builder.pos += skipped;
        }
        if (!m) break;
        pos += skipped + 1;
        if (m[0] == "\t") {
          var tabSize = builder.cm.options.tabSize, tabWidth = tabSize - builder.col % tabSize;
          var txt = content.appendChild(elt("span", spaceStr(tabWidth), "cm-tab"));
          builder.col += tabWidth;
        } else {
          var txt = builder.cm.options.specialCharPlaceholder(m[0]);
          if (ie && ie_version < 9) content.appendChild(elt("span", [txt]));
          else content.appendChild(txt);
          builder.col += 1;
        }
        builder.map.push(builder.pos, builder.pos + 1, txt);
        builder.pos++;
      }
    }
    if (style || startStyle || endStyle || mustWrap) {
      var fullStyle = style || "";
      if (startStyle) fullStyle += startStyle;
      if (endStyle) fullStyle += endStyle;
      var token = elt("span", [content], fullStyle);
      if (title) token.title = title;
      return builder.content.appendChild(token);
    }
    builder.content.appendChild(content);
  }

  function buildTokenSplitSpaces(inner) {
    function split(old) {
      var out = " ";
      for (var i = 0; i < old.length - 2; ++i) out += i % 2 ? " " : "\u00a0";
      out += " ";
      return out;
    }
    return function(builder, text, style, startStyle, endStyle, title) {
      inner(builder, text.replace(/ {3,}/g, split), style, startStyle, endStyle, title);
    };
  }

  // Work around nonsense dimensions being reported for stretches of
  // right-to-left text.
  function buildTokenBadBidi(inner, order) {
    return function(builder, text, style, startStyle, endStyle, title) {
      style = style ? style + " cm-force-border" : "cm-force-border";
      var start = builder.pos, end = start + text.length;
      for (;;) {
        // Find the part that overlaps with the start of this text
        for (var i = 0; i < order.length; i++) {
          var part = order[i];
          if (part.to > start && part.from <= start) break;
        }
        if (part.to >= end) return inner(builder, text, style, startStyle, endStyle, title);
        inner(builder, text.slice(0, part.to - start), style, startStyle, null, title);
        startStyle = null;
        text = text.slice(part.to - start);
        start = part.to;
      }
    };
  }

  function buildCollapsedSpan(builder, size, marker, ignoreWidget) {
    var widget = !ignoreWidget && marker.widgetNode;
    if (widget) {
      builder.map.push(builder.pos, builder.pos + size, widget);
      builder.content.appendChild(widget);
    }
    builder.pos += size;
  }

  // Outputs a number of spans to make up a line, taking highlighting
  // and marked text into account.
  function insertLineContent(line, builder, styles) {
    var spans = line.markedSpans, allText = line.text, at = 0;
    if (!spans) {
      for (var i = 1; i < styles.length; i+=2)
        builder.addToken(builder, allText.slice(at, at = styles[i]), interpretTokenStyle(styles[i+1], builder.cm.options));
      return;
    }

    var len = allText.length, pos = 0, i = 1, text = "", style;
    var nextChange = 0, spanStyle, spanEndStyle, spanStartStyle, title, collapsed;
    for (;;) {
      if (nextChange == pos) { // Update current marker set
        spanStyle = spanEndStyle = spanStartStyle = title = "";
        collapsed = null; nextChange = Infinity;
        var foundBookmarks = [];
        for (var j = 0; j < spans.length; ++j) {
          var sp = spans[j], m = sp.marker;
          if (sp.from <= pos && (sp.to == null || sp.to > pos)) {
            if (sp.to != null && nextChange > sp.to) { nextChange = sp.to; spanEndStyle = ""; }
            if (m.className) spanStyle += " " + m.className;
            if (m.startStyle && sp.from == pos) spanStartStyle += " " + m.startStyle;
            if (m.endStyle && sp.to == nextChange) spanEndStyle += " " + m.endStyle;
            if (m.title && !title) title = m.title;
            if (m.collapsed && (!collapsed || compareCollapsedMarkers(collapsed.marker, m) < 0))
              collapsed = sp;
          } else if (sp.from > pos && nextChange > sp.from) {
            nextChange = sp.from;
          }
          if (m.type == "bookmark" && sp.from == pos && m.widgetNode) foundBookmarks.push(m);
        }
        if (collapsed && (collapsed.from || 0) == pos) {
          buildCollapsedSpan(builder, (collapsed.to == null ? len + 1 : collapsed.to) - pos,
                             collapsed.marker, collapsed.from == null);
          if (collapsed.to == null) return;
        }
        if (!collapsed && foundBookmarks.length) for (var j = 0; j < foundBookmarks.length; ++j)
          buildCollapsedSpan(builder, 0, foundBookmarks[j]);
      }
      if (pos >= len) break;

      var upto = Math.min(len, nextChange);
      while (true) {
        if (text) {
          var end = pos + text.length;
          if (!collapsed) {
            var tokenText = end > upto ? text.slice(0, upto - pos) : text;
            builder.addToken(builder, tokenText, style ? style + spanStyle : spanStyle,
                             spanStartStyle, pos + tokenText.length == nextChange ? spanEndStyle : "", title);
          }
          if (end >= upto) {text = text.slice(upto - pos); pos = upto; break;}
          pos = end;
          spanStartStyle = "";
        }
        text = allText.slice(at, at = styles[i++]);
        style = interpretTokenStyle(styles[i++], builder.cm.options);
      }
    }
  }

  // DOCUMENT DATA STRUCTURE

  // By default, updates that start and end at the beginning of a line
  // are treated specially, in order to make the association of line
  // widgets and marker elements with the text behave more intuitive.
  function isWholeLineUpdate(doc, change) {
    return change.from.ch == 0 && change.to.ch == 0 && lst(change.text) == "" &&
      (!doc.cm || doc.cm.options.wholeLineUpdateBefore);
  }

  // Perform a change on the document data structure.
  function updateDoc(doc, change, markedSpans, estimateHeight) {
    function spansFor(n) {return markedSpans ? markedSpans[n] : null;}
    function update(line, text, spans) {
      updateLine(line, text, spans, estimateHeight);
      signalLater(line, "change", line, change);
    }

    var from = change.from, to = change.to, text = change.text;
    var firstLine = getLine(doc, from.line), lastLine = getLine(doc, to.line);
    var lastText = lst(text), lastSpans = spansFor(text.length - 1), nlines = to.line - from.line;

    // Adjust the line structure
    if (isWholeLineUpdate(doc, change)) {
      // This is a whole-line replace. Treated specially to make
      // sure line objects move the way they are supposed to.
      for (var i = 0, added = []; i < text.length - 1; ++i)
        added.push(new Line(text[i], spansFor(i), estimateHeight));
      update(lastLine, lastLine.text, lastSpans);
      if (nlines) doc.remove(from.line, nlines);
      if (added.length) doc.insert(from.line, added);
    } else if (firstLine == lastLine) {
      if (text.length == 1) {
        update(firstLine, firstLine.text.slice(0, from.ch) + lastText + firstLine.text.slice(to.ch), lastSpans);
      } else {
        for (var added = [], i = 1; i < text.length - 1; ++i)
          added.push(new Line(text[i], spansFor(i), estimateHeight));
        added.push(new Line(lastText + firstLine.text.slice(to.ch), lastSpans, estimateHeight));
        update(firstLine, firstLine.text.slice(0, from.ch) + text[0], spansFor(0));
        doc.insert(from.line + 1, added);
      }
    } else if (text.length == 1) {
      update(firstLine, firstLine.text.slice(0, from.ch) + text[0] + lastLine.text.slice(to.ch), spansFor(0));
      doc.remove(from.line + 1, nlines);
    } else {
      update(firstLine, firstLine.text.slice(0, from.ch) + text[0], spansFor(0));
      update(lastLine, lastText + lastLine.text.slice(to.ch), lastSpans);
      for (var i = 1, added = []; i < text.length - 1; ++i)
        added.push(new Line(text[i], spansFor(i), estimateHeight));
      if (nlines > 1) doc.remove(from.line + 1, nlines - 1);
      doc.insert(from.line + 1, added);
    }

    signalLater(doc, "change", doc, change);
  }

  // The document is represented as a BTree consisting of leaves, with
  // chunk of lines in them, and branches, with up to ten leaves or
  // other branch nodes below them. The top node is always a branch
  // node, and is the document object itself (meaning it has
  // additional methods and properties).
  //
  // All nodes have parent links. The tree is used both to go from
  // line numbers to line objects, and to go from objects to numbers.
  // It also indexes by height, and is used to convert between height
  // and line object, and to find the total height of the document.
  //
  // See also http://marijnhaverbeke.nl/blog/codemirror-line-tree.html

  function LeafChunk(lines) {
    this.lines = lines;
    this.parent = null;
    for (var i = 0, height = 0; i < lines.length; ++i) {
      lines[i].parent = this;
      height += lines[i].height;
    }
    this.height = height;
  }

  LeafChunk.prototype = {
    chunkSize: function() { return this.lines.length; },
    // Remove the n lines at offset 'at'.
    removeInner: function(at, n) {
      for (var i = at, e = at + n; i < e; ++i) {
        var line = this.lines[i];
        this.height -= line.height;
        cleanUpLine(line);
        signalLater(line, "delete");
      }
      this.lines.splice(at, n);
    },
    // Helper used to collapse a small branch into a single leaf.
    collapse: function(lines) {
      lines.push.apply(lines, this.lines);
    },
    // Insert the given array of lines at offset 'at', count them as
    // having the given height.
    insertInner: function(at, lines, height) {
      this.height += height;
      this.lines = this.lines.slice(0, at).concat(lines).concat(this.lines.slice(at));
      for (var i = 0; i < lines.length; ++i) lines[i].parent = this;
    },
    // Used to iterate over a part of the tree.
    iterN: function(at, n, op) {
      for (var e = at + n; at < e; ++at)
        if (op(this.lines[at])) return true;
    }
  };

  function BranchChunk(children) {
    this.children = children;
    var size = 0, height = 0;
    for (var i = 0; i < children.length; ++i) {
      var ch = children[i];
      size += ch.chunkSize(); height += ch.height;
      ch.parent = this;
    }
    this.size = size;
    this.height = height;
    this.parent = null;
  }

  BranchChunk.prototype = {
    chunkSize: function() { return this.size; },
    removeInner: function(at, n) {
      this.size -= n;
      for (var i = 0; i < this.children.length; ++i) {
        var child = this.children[i], sz = child.chunkSize();
        if (at < sz) {
          var rm = Math.min(n, sz - at), oldHeight = child.height;
          child.removeInner(at, rm);
          this.height -= oldHeight - child.height;
          if (sz == rm) { this.children.splice(i--, 1); child.parent = null; }
          if ((n -= rm) == 0) break;
          at = 0;
        } else at -= sz;
      }
      // If the result is smaller than 25 lines, ensure that it is a
      // single leaf node.
      if (this.size - n < 25 &&
          (this.children.length > 1 || !(this.children[0] instanceof LeafChunk))) {
        var lines = [];
        this.collapse(lines);
        this.children = [new LeafChunk(lines)];
        this.children[0].parent = this;
      }
    },
    collapse: function(lines) {
      for (var i = 0; i < this.children.length; ++i) this.children[i].collapse(lines);
    },
    insertInner: function(at, lines, height) {
      this.size += lines.length;
      this.height += height;
      for (var i = 0; i < this.children.length; ++i) {
        var child = this.children[i], sz = child.chunkSize();
        if (at <= sz) {
          child.insertInner(at, lines, height);
          if (child.lines && child.lines.length > 50) {
            while (child.lines.length > 50) {
              var spilled = child.lines.splice(child.lines.length - 25, 25);
              var newleaf = new LeafChunk(spilled);
              child.height -= newleaf.height;
              this.children.splice(i + 1, 0, newleaf);
              newleaf.parent = this;
            }
            this.maybeSpill();
          }
          break;
        }
        at -= sz;
      }
    },
    // When a node has grown, check whether it should be split.
    maybeSpill: function() {
      if (this.children.length <= 10) return;
      var me = this;
      do {
        var spilled = me.children.splice(me.children.length - 5, 5);
        var sibling = new BranchChunk(spilled);
        if (!me.parent) { // Become the parent node
          var copy = new BranchChunk(me.children);
          copy.parent = me;
          me.children = [copy, sibling];
          me = copy;
        } else {
          me.size -= sibling.size;
          me.height -= sibling.height;
          var myIndex = indexOf(me.parent.children, me);
          me.parent.children.splice(myIndex + 1, 0, sibling);
        }
        sibling.parent = me.parent;
      } while (me.children.length > 10);
      me.parent.maybeSpill();
    },
    iterN: function(at, n, op) {
      for (var i = 0; i < this.children.length; ++i) {
        var child = this.children[i], sz = child.chunkSize();
        if (at < sz) {
          var used = Math.min(n, sz - at);
          if (child.iterN(at, used, op)) return true;
          if ((n -= used) == 0) break;
          at = 0;
        } else at -= sz;
      }
    }
  };

  var nextDocId = 0;
  var Doc = CodeMirror.Doc = function(text, mode, firstLine) {
    if (!(this instanceof Doc)) return new Doc(text, mode, firstLine);
    if (firstLine == null) firstLine = 0;

    BranchChunk.call(this, [new LeafChunk([new Line("", null)])]);
    this.first = firstLine;
    this.scrollTop = this.scrollLeft = 0;
    this.cantEdit = false;
    this.cleanGeneration = 1;
    this.frontier = firstLine;
    var start = Pos(firstLine, 0);
    this.sel = simpleSelection(start);
    this.history = new History(null);
    this.id = ++nextDocId;
    this.modeOption = mode;

    if (typeof text == "string") text = splitLines(text);
    updateDoc(this, {from: start, to: start, text: text});
    setSelection(this, simpleSelection(start), sel_dontScroll);
  };

  Doc.prototype = createObj(BranchChunk.prototype, {
    constructor: Doc,
    // Iterate over the document. Supports two forms -- with only one
    // argument, it calls that for each line in the document. With
    // three, it iterates over the range given by the first two (with
    // the second being non-inclusive).
    iter: function(from, to, op) {
      if (op) this.iterN(from - this.first, to - from, op);
      else this.iterN(this.first, this.first + this.size, from);
    },

    // Non-public interface for adding and removing lines.
    insert: function(at, lines) {
      var height = 0;
      for (var i = 0; i < lines.length; ++i) height += lines[i].height;
      this.insertInner(at - this.first, lines, height);
    },
    remove: function(at, n) { this.removeInner(at - this.first, n); },

    // From here, the methods are part of the public interface. Most
    // are also available from CodeMirror (editor) instances.

    getValue: function(lineSep) {
      var lines = getLines(this, this.first, this.first + this.size);
      if (lineSep === false) return lines;
      return lines.join(lineSep || "\n");
    },
    setValue: docMethodOp(function(code) {
      var top = Pos(this.first, 0), last = this.first + this.size - 1;
      makeChange(this, {from: top, to: Pos(last, getLine(this, last).text.length),
                        text: splitLines(code), origin: "setValue"}, true);
      setSelection(this, simpleSelection(top));
    }),
    replaceRange: function(code, from, to, origin) {
      from = clipPos(this, from);
      to = to ? clipPos(this, to) : from;
      replaceRange(this, code, from, to, origin);
    },
    getRange: function(from, to, lineSep) {
      var lines = getBetween(this, clipPos(this, from), clipPos(this, to));
      if (lineSep === false) return lines;
      return lines.join(lineSep || "\n");
    },

    getLine: function(line) {var l = this.getLineHandle(line); return l && l.text;},

    getLineHandle: function(line) {if (isLine(this, line)) return getLine(this, line);},
    getLineNumber: function(line) {return lineNo(line);},

    getLineHandleVisualStart: function(line) {
      if (typeof line == "number") line = getLine(this, line);
      return visualLine(line);
    },

    lineCount: function() {return this.size;},
    firstLine: function() {return this.first;},
    lastLine: function() {return this.first + this.size - 1;},

    clipPos: function(pos) {return clipPos(this, pos);},

    getCursor: function(start) {
      var range = this.sel.primary(), pos;
      if (start == null || start == "head") pos = range.head;
      else if (start == "anchor") pos = range.anchor;
      else if (start == "end" || start == "to" || start === false) pos = range.to();
      else pos = range.from();
      return pos;
    },
    listSelections: function() { return this.sel.ranges; },
    somethingSelected: function() {return this.sel.somethingSelected();},

    setCursor: docMethodOp(function(line, ch, options) {
      setSimpleSelection(this, clipPos(this, typeof line == "number" ? Pos(line, ch || 0) : line), null, options);
    }),
    setSelection: docMethodOp(function(anchor, head, options) {
      setSimpleSelection(this, clipPos(this, anchor), clipPos(this, head || anchor), options);
    }),
    extendSelection: docMethodOp(function(head, other, options) {
      extendSelection(this, clipPos(this, head), other && clipPos(this, other), options);
    }),
    extendSelections: docMethodOp(function(heads, options) {
      extendSelections(this, clipPosArray(this, heads, options));
    }),
    extendSelectionsBy: docMethodOp(function(f, options) {
      extendSelections(this, map(this.sel.ranges, f), options);
    }),
    setSelections: docMethodOp(function(ranges, primary, options) {
      if (!ranges.length) return;
      for (var i = 0, out = []; i < ranges.length; i++)
        out[i] = new Range(clipPos(this, ranges[i].anchor),
                           clipPos(this, ranges[i].head));
      if (primary == null) primary = Math.min(ranges.length - 1, this.sel.primIndex);
      setSelection(this, normalizeSelection(out, primary), options);
    }),
    addSelection: docMethodOp(function(anchor, head, options) {
      var ranges = this.sel.ranges.slice(0);
      ranges.push(new Range(clipPos(this, anchor), clipPos(this, head || anchor)));
      setSelection(this, normalizeSelection(ranges, ranges.length - 1), options);
    }),

    getSelection: function(lineSep) {
      var ranges = this.sel.ranges, lines;
      for (var i = 0; i < ranges.length; i++) {
        var sel = getBetween(this, ranges[i].from(), ranges[i].to());
        lines = lines ? lines.concat(sel) : sel;
      }
      if (lineSep === false) return lines;
      else return lines.join(lineSep || "\n");
    },
    getSelections: function(lineSep) {
      var parts = [], ranges = this.sel.ranges;
      for (var i = 0; i < ranges.length; i++) {
        var sel = getBetween(this, ranges[i].from(), ranges[i].to());
        if (lineSep !== false) sel = sel.join(lineSep || "\n");
        parts[i] = sel;
      }
      return parts;
    },
    replaceSelection: function(code, collapse, origin) {
      var dup = [];
      for (var i = 0; i < this.sel.ranges.length; i++)
        dup[i] = code;
      this.replaceSelections(dup, collapse, origin || "+input");
    },
    replaceSelections: docMethodOp(function(code, collapse, origin) {
      var changes = [], sel = this.sel;
      for (var i = 0; i < sel.ranges.length; i++) {
        var range = sel.ranges[i];
        changes[i] = {from: range.from(), to: range.to(), text: splitLines(code[i]), origin: origin};
      }
      var newSel = collapse && collapse != "end" && computeReplacedSel(this, changes, collapse);
      for (var i = changes.length - 1; i >= 0; i--)
        makeChange(this, changes[i]);
      if (newSel) setSelectionReplaceHistory(this, newSel);
      else if (this.cm) ensureCursorVisible(this.cm);
    }),
    undo: docMethodOp(function() {makeChangeFromHistory(this, "undo");}),
    redo: docMethodOp(function() {makeChangeFromHistory(this, "redo");}),
    undoSelection: docMethodOp(function() {makeChangeFromHistory(this, "undo", true);}),
    redoSelection: docMethodOp(function() {makeChangeFromHistory(this, "redo", true);}),

    setExtending: function(val) {this.extend = val;},
    getExtending: function() {return this.extend;},

    historySize: function() {
      var hist = this.history, done = 0, undone = 0;
      for (var i = 0; i < hist.done.length; i++) if (!hist.done[i].ranges) ++done;
      for (var i = 0; i < hist.undone.length; i++) if (!hist.undone[i].ranges) ++undone;
      return {undo: done, redo: undone};
    },
    clearHistory: function() {this.history = new History(this.history.maxGeneration);},

    markClean: function() {
      this.cleanGeneration = this.changeGeneration(true);
    },
    changeGeneration: function(forceSplit) {
      if (forceSplit)
        this.history.lastOp = this.history.lastOrigin = null;
      return this.history.generation;
    },
    isClean: function (gen) {
      return this.history.generation == (gen || this.cleanGeneration);
    },

    getHistory: function() {
      return {done: copyHistoryArray(this.history.done),
              undone: copyHistoryArray(this.history.undone)};
    },
    setHistory: function(histData) {
      var hist = this.history = new History(this.history.maxGeneration);
      hist.done = copyHistoryArray(histData.done.slice(0), null, true);
      hist.undone = copyHistoryArray(histData.undone.slice(0), null, true);
    },

    addLineClass: docMethodOp(function(handle, where, cls) {
      return changeLine(this, handle, "class", function(line) {
        var prop = where == "text" ? "textClass" : where == "background" ? "bgClass" : "wrapClass";
        if (!line[prop]) line[prop] = cls;
        else if (new RegExp("(?:^|\\s)" + cls + "(?:$|\\s)").test(line[prop])) return false;
        else line[prop] += " " + cls;
        return true;
      });
    }),
    removeLineClass: docMethodOp(function(handle, where, cls) {
      return changeLine(this, handle, "class", function(line) {
        var prop = where == "text" ? "textClass" : where == "background" ? "bgClass" : "wrapClass";
        var cur = line[prop];
        if (!cur) return false;
        else if (cls == null) line[prop] = null;
        else {
          var found = cur.match(new RegExp("(?:^|\\s+)" + cls + "(?:$|\\s+)"));
          if (!found) return false;
          var end = found.index + found[0].length;
          line[prop] = cur.slice(0, found.index) + (!found.index || end == cur.length ? "" : " ") + cur.slice(end) || null;
        }
        return true;
      });
    }),

    markText: function(from, to, options) {
      return markText(this, clipPos(this, from), clipPos(this, to), options, "range");
    },
    setBookmark: function(pos, options) {
      var realOpts = {replacedWith: options && (options.nodeType == null ? options.widget : options),
                      insertLeft: options && options.insertLeft,
                      clearWhenEmpty: false, shared: options && options.shared};
      pos = clipPos(this, pos);
      return markText(this, pos, pos, realOpts, "bookmark");
    },
    findMarksAt: function(pos) {
      pos = clipPos(this, pos);
      var markers = [], spans = getLine(this, pos.line).markedSpans;
      if (spans) for (var i = 0; i < spans.length; ++i) {
        var span = spans[i];
        if ((span.from == null || span.from <= pos.ch) &&
            (span.to == null || span.to >= pos.ch))
          markers.push(span.marker.parent || span.marker);
      }
      return markers;
    },
    findMarks: function(from, to, filter) {
      from = clipPos(this, from); to = clipPos(this, to);
      var found = [], lineNo = from.line;
      this.iter(from.line, to.line + 1, function(line) {
        var spans = line.markedSpans;
        if (spans) for (var i = 0; i < spans.length; i++) {
          var span = spans[i];
          if (!(lineNo == from.line && from.ch > span.to ||
                span.from == null && lineNo != from.line||
                lineNo == to.line && span.from > to.ch) &&
              (!filter || filter(span.marker)))
            found.push(span.marker.parent || span.marker);
        }
        ++lineNo;
      });
      return found;
    },
    getAllMarks: function() {
      var markers = [];
      this.iter(function(line) {
        var sps = line.markedSpans;
        if (sps) for (var i = 0; i < sps.length; ++i)
          if (sps[i].from != null) markers.push(sps[i].marker);
      });
      return markers;
    },

    posFromIndex: function(off) {
      var ch, lineNo = this.first;
      this.iter(function(line) {
        var sz = line.text.length + 1;
        if (sz > off) { ch = off; return true; }
        off -= sz;
        ++lineNo;
      });
      return clipPos(this, Pos(lineNo, ch));
    },
    indexFromPos: function (coords) {
      coords = clipPos(this, coords);
      var index = coords.ch;
      if (coords.line < this.first || coords.ch < 0) return 0;
      this.iter(this.first, coords.line, function (line) {
        index += line.text.length + 1;
      });
      return index;
    },

    copy: function(copyHistory) {
      var doc = new Doc(getLines(this, this.first, this.first + this.size), this.modeOption, this.first);
      doc.scrollTop = this.scrollTop; doc.scrollLeft = this.scrollLeft;
      doc.sel = this.sel;
      doc.extend = false;
      if (copyHistory) {
        doc.history.undoDepth = this.history.undoDepth;
        doc.setHistory(this.getHistory());
      }
      return doc;
    },

    linkedDoc: function(options) {
      if (!options) options = {};
      var from = this.first, to = this.first + this.size;
      if (options.from != null && options.from > from) from = options.from;
      if (options.to != null && options.to < to) to = options.to;
      var copy = new Doc(getLines(this, from, to), options.mode || this.modeOption, from);
      if (options.sharedHist) copy.history = this.history;
      (this.linked || (this.linked = [])).push({doc: copy, sharedHist: options.sharedHist});
      copy.linked = [{doc: this, isParent: true, sharedHist: options.sharedHist}];
      copySharedMarkers(copy, findSharedMarkers(this));
      return copy;
    },
    unlinkDoc: function(other) {
      if (other instanceof CodeMirror) other = other.doc;
      if (this.linked) for (var i = 0; i < this.linked.length; ++i) {
        var link = this.linked[i];
        if (link.doc != other) continue;
        this.linked.splice(i, 1);
        other.unlinkDoc(this);
        detachSharedMarkers(findSharedMarkers(this));
        break;
      }
      // If the histories were shared, split them again
      if (other.history == this.history) {
        var splitIds = [other.id];
        linkedDocs(other, function(doc) {splitIds.push(doc.id);}, true);
        other.history = new History(null);
        other.history.done = copyHistoryArray(this.history.done, splitIds);
        other.history.undone = copyHistoryArray(this.history.undone, splitIds);
      }
    },
    iterLinkedDocs: function(f) {linkedDocs(this, f);},

    getMode: function() {return this.mode;},
    getEditor: function() {return this.cm;}
  });

  // Public alias.
  Doc.prototype.eachLine = Doc.prototype.iter;

  // Set up methods on CodeMirror's prototype to redirect to the editor's document.
  var dontDelegate = "iter insert remove copy getEditor".split(" ");
  for (var prop in Doc.prototype) if (Doc.prototype.hasOwnProperty(prop) && indexOf(dontDelegate, prop) < 0)
    CodeMirror.prototype[prop] = (function(method) {
      return function() {return method.apply(this.doc, arguments);};
    })(Doc.prototype[prop]);

  eventMixin(Doc);

  // Call f for all linked documents.
  function linkedDocs(doc, f, sharedHistOnly) {
    function propagate(doc, skip, sharedHist) {
      if (doc.linked) for (var i = 0; i < doc.linked.length; ++i) {
        var rel = doc.linked[i];
        if (rel.doc == skip) continue;
        var shared = sharedHist && rel.sharedHist;
        if (sharedHistOnly && !shared) continue;
        f(rel.doc, shared);
        propagate(rel.doc, doc, shared);
      }
    }
    propagate(doc, null, true);
  }

  // Attach a document to an editor.
  function attachDoc(cm, doc) {
    if (doc.cm) throw new Error("This document is already in use.");
    cm.doc = doc;
    doc.cm = cm;
    estimateLineHeights(cm);
    loadMode(cm);
    if (!cm.options.lineWrapping) findMaxLine(cm);
    cm.options.mode = doc.modeOption;
    regChange(cm);
  }

  // LINE UTILITIES

  // Find the line object corresponding to the given line number.
  function getLine(doc, n) {
    n -= doc.first;
    if (n < 0 || n >= doc.size) throw new Error("There is no line " + (n + doc.first) + " in the document.");
    for (var chunk = doc; !chunk.lines;) {
      for (var i = 0;; ++i) {
        var child = chunk.children[i], sz = child.chunkSize();
        if (n < sz) { chunk = child; break; }
        n -= sz;
      }
    }
    return chunk.lines[n];
  }

  // Get the part of a document between two positions, as an array of
  // strings.
  function getBetween(doc, start, end) {
    var out = [], n = start.line;
    doc.iter(start.line, end.line + 1, function(line) {
      var text = line.text;
      if (n == end.line) text = text.slice(0, end.ch);
      if (n == start.line) text = text.slice(start.ch);
      out.push(text);
      ++n;
    });
    return out;
  }
  // Get the lines between from and to, as array of strings.
  function getLines(doc, from, to) {
    var out = [];
    doc.iter(from, to, function(line) { out.push(line.text); });
    return out;
  }

  // Update the height of a line, propagating the height change
  // upwards to parent nodes.
  function updateLineHeight(line, height) {
    var diff = height - line.height;
    if (diff) for (var n = line; n; n = n.parent) n.height += diff;
  }

  // Given a line object, find its line number by walking up through
  // its parent links.
  function lineNo(line) {
    if (line.parent == null) return null;
    var cur = line.parent, no = indexOf(cur.lines, line);
    for (var chunk = cur.parent; chunk; cur = chunk, chunk = chunk.parent) {
      for (var i = 0;; ++i) {
        if (chunk.children[i] == cur) break;
        no += chunk.children[i].chunkSize();
      }
    }
    return no + cur.first;
  }

  // Find the line at the given vertical position, using the height
  // information in the document tree.
  function lineAtHeight(chunk, h) {
    var n = chunk.first;
    outer: do {
      for (var i = 0; i < chunk.children.length; ++i) {
        var child = chunk.children[i], ch = child.height;
        if (h < ch) { chunk = child; continue outer; }
        h -= ch;
        n += child.chunkSize();
      }
      return n;
    } while (!chunk.lines);
    for (var i = 0; i < chunk.lines.length; ++i) {
      var line = chunk.lines[i], lh = line.height;
      if (h < lh) break;
      h -= lh;
    }
    return n + i;
  }


  // Find the height above the given line.
  function heightAtLine(lineObj) {
    lineObj = visualLine(lineObj);

    var h = 0, chunk = lineObj.parent;
    for (var i = 0; i < chunk.lines.length; ++i) {
      var line = chunk.lines[i];
      if (line == lineObj) break;
      else h += line.height;
    }
    for (var p = chunk.parent; p; chunk = p, p = chunk.parent) {
      for (var i = 0; i < p.children.length; ++i) {
        var cur = p.children[i];
        if (cur == chunk) break;
        else h += cur.height;
      }
    }
    return h;
  }

  // Get the bidi ordering for the given line (and cache it). Returns
  // false for lines that are fully left-to-right, and an array of
  // BidiSpan objects otherwise.
  function getOrder(line) {
    var order = line.order;
    if (order == null) order = line.order = bidiOrdering(line.text);
    return order;
  }

  // HISTORY

  function History(startGen) {
    // Arrays of change events and selections. Doing something adds an
    // event to done and clears undo. Undoing moves events from done
    // to undone, redoing moves them in the other direction.
    this.done = []; this.undone = [];
    this.undoDepth = Infinity;
    // Used to track when changes can be merged into a single undo
    // event
    this.lastModTime = this.lastSelTime = 0;
    this.lastOp = null;
    this.lastOrigin = this.lastSelOrigin = null;
    // Used by the isClean() method
    this.generation = this.maxGeneration = startGen || 1;
  }

  // Create a history change event from an updateDoc-style change
  // object.
  function historyChangeFromChange(doc, change) {
    var histChange = {from: copyPos(change.from), to: changeEnd(change), text: getBetween(doc, change.from, change.to)};
    attachLocalSpans(doc, histChange, change.from.line, change.to.line + 1);
    linkedDocs(doc, function(doc) {attachLocalSpans(doc, histChange, change.from.line, change.to.line + 1);}, true);
    return histChange;
  }

  // Pop all selection events off the end of a history array. Stop at
  // a change event.
  function clearSelectionEvents(array) {
    while (array.length) {
      var last = lst(array);
      if (last.ranges) array.pop();
      else break;
    }
  }

  // Find the top change event in the history. Pop off selection
  // events that are in the way.
  function lastChangeEvent(hist, force) {
    if (force) {
      clearSelectionEvents(hist.done);
      return lst(hist.done);
    } else if (hist.done.length && !lst(hist.done).ranges) {
      return lst(hist.done);
    } else if (hist.done.length > 1 && !hist.done[hist.done.length - 2].ranges) {
      hist.done.pop();
      return lst(hist.done);
    }
  }

  // Register a change in the history. Merges changes that are within
  // a single operation, ore are close together with an origin that
  // allows merging (starting with "+") into a single event.
  function addChangeToHistory(doc, change, selAfter, opId) {
    var hist = doc.history;
    hist.undone.length = 0;
    var time = +new Date, cur;

    if ((hist.lastOp == opId ||
         hist.lastOrigin == change.origin && change.origin &&
         ((change.origin.charAt(0) == "+" && doc.cm && hist.lastModTime > time - doc.cm.options.historyEventDelay) ||
          change.origin.charAt(0) == "*")) &&
        (cur = lastChangeEvent(hist, hist.lastOp == opId))) {
      // Merge this change into the last event
      var last = lst(cur.changes);
      if (cmp(change.from, change.to) == 0 && cmp(change.from, last.to) == 0) {
        // Optimized case for simple insertion -- don't want to add
        // new changesets for every character typed
        last.to = changeEnd(change);
      } else {
        // Add new sub-event
        cur.changes.push(historyChangeFromChange(doc, change));
      }
    } else {
      // Can not be merged, start a new event.
      var before = lst(hist.done);
      if (!before || !before.ranges)
        pushSelectionToHistory(doc.sel, hist.done);
      cur = {changes: [historyChangeFromChange(doc, change)],
             generation: hist.generation};
      hist.done.push(cur);
      while (hist.done.length > hist.undoDepth) {
        hist.done.shift();
        if (!hist.done[0].ranges) hist.done.shift();
      }
    }
    hist.done.push(selAfter);
    hist.generation = ++hist.maxGeneration;
    hist.lastModTime = hist.lastSelTime = time;
    hist.lastOp = opId;
    hist.lastOrigin = hist.lastSelOrigin = change.origin;

    if (!last) signal(doc, "historyAdded");
  }

  function selectionEventCanBeMerged(doc, origin, prev, sel) {
    var ch = origin.charAt(0);
    return ch == "*" ||
      ch == "+" &&
      prev.ranges.length == sel.ranges.length &&
      prev.somethingSelected() == sel.somethingSelected() &&
      new Date - doc.history.lastSelTime <= (doc.cm ? doc.cm.options.historyEventDelay : 500);
  }

  // Called whenever the selection changes, sets the new selection as
  // the pending selection in the history, and pushes the old pending
  // selection into the 'done' array when it was significantly
  // different (in number of selected ranges, emptiness, or time).
  function addSelectionToHistory(doc, sel, opId, options) {
    var hist = doc.history, origin = options && options.origin;

    // A new event is started when the previous origin does not match
    // the current, or the origins don't allow matching. Origins
    // starting with * are always merged, those starting with + are
    // merged when similar and close together in time.
    if (opId == hist.lastOp ||
        (origin && hist.lastSelOrigin == origin &&
         (hist.lastModTime == hist.lastSelTime && hist.lastOrigin == origin ||
          selectionEventCanBeMerged(doc, origin, lst(hist.done), sel))))
      hist.done[hist.done.length - 1] = sel;
    else
      pushSelectionToHistory(sel, hist.done);

    hist.lastSelTime = +new Date;
    hist.lastSelOrigin = origin;
    hist.lastOp = opId;
    if (options && options.clearRedo !== false)
      clearSelectionEvents(hist.undone);
  }

  function pushSelectionToHistory(sel, dest) {
    var top = lst(dest);
    if (!(top && top.ranges && top.equals(sel)))
      dest.push(sel);
  }

  // Used to store marked span information in the history.
  function attachLocalSpans(doc, change, from, to) {
    var existing = change["spans_" + doc.id], n = 0;
    doc.iter(Math.max(doc.first, from), Math.min(doc.first + doc.size, to), function(line) {
      if (line.markedSpans)
        (existing || (existing = change["spans_" + doc.id] = {}))[n] = line.markedSpans;
      ++n;
    });
  }

  // When un/re-doing restores text containing marked spans, those
  // that have been explicitly cleared should not be restored.
  function removeClearedSpans(spans) {
    if (!spans) return null;
    for (var i = 0, out; i < spans.length; ++i) {
      if (spans[i].marker.explicitlyCleared) { if (!out) out = spans.slice(0, i); }
      else if (out) out.push(spans[i]);
    }
    return !out ? spans : out.length ? out : null;
  }

  // Retrieve and filter the old marked spans stored in a change event.
  function getOldSpans(doc, change) {
    var found = change["spans_" + doc.id];
    if (!found) return null;
    for (var i = 0, nw = []; i < change.text.length; ++i)
      nw.push(removeClearedSpans(found[i]));
    return nw;
  }

  // Used both to provide a JSON-safe object in .getHistory, and, when
  // detaching a document, to split the history in two
  function copyHistoryArray(events, newGroup, instantiateSel) {
    for (var i = 0, copy = []; i < events.length; ++i) {
      var event = events[i];
      if (event.ranges) {
        copy.push(instantiateSel ? Selection.prototype.deepCopy.call(event) : event);
        continue;
      }
      var changes = event.changes, newChanges = [];
      copy.push({changes: newChanges});
      for (var j = 0; j < changes.length; ++j) {
        var change = changes[j], m;
        newChanges.push({from: change.from, to: change.to, text: change.text});
        if (newGroup) for (var prop in change) if (m = prop.match(/^spans_(\d+)$/)) {
          if (indexOf(newGroup, Number(m[1])) > -1) {
            lst(newChanges)[prop] = change[prop];
            delete change[prop];
          }
        }
      }
    }
    return copy;
  }

  // Rebasing/resetting history to deal with externally-sourced changes

  function rebaseHistSelSingle(pos, from, to, diff) {
    if (to < pos.line) {
      pos.line += diff;
    } else if (from < pos.line) {
      pos.line = from;
      pos.ch = 0;
    }
  }

  // Tries to rebase an array of history events given a change in the
  // document. If the change touches the same lines as the event, the
  // event, and everything 'behind' it, is discarded. If the change is
  // before the event, the event's positions are updated. Uses a
  // copy-on-write scheme for the positions, to avoid having to
  // reallocate them all on every rebase, but also avoid problems with
  // shared position objects being unsafely updated.
  function rebaseHistArray(array, from, to, diff) {
    for (var i = 0; i < array.length; ++i) {
      var sub = array[i], ok = true;
      if (sub.ranges) {
        if (!sub.copied) { sub = array[i] = sub.deepCopy(); sub.copied = true; }
        for (var j = 0; j < sub.ranges.length; j++) {
          rebaseHistSelSingle(sub.ranges[j].anchor, from, to, diff);
          rebaseHistSelSingle(sub.ranges[j].head, from, to, diff);
        }
        continue;
      }
      for (var j = 0; j < sub.changes.length; ++j) {
        var cur = sub.changes[j];
        if (to < cur.from.line) {
          cur.from = Pos(cur.from.line + diff, cur.from.ch);
          cur.to = Pos(cur.to.line + diff, cur.to.ch);
        } else if (from <= cur.to.line) {
          ok = false;
          break;
        }
      }
      if (!ok) {
        array.splice(0, i + 1);
        i = 0;
      }
    }
  }

  function rebaseHist(hist, change) {
    var from = change.from.line, to = change.to.line, diff = change.text.length - (to - from) - 1;
    rebaseHistArray(hist.done, from, to, diff);
    rebaseHistArray(hist.undone, from, to, diff);
  }

  // EVENT UTILITIES

  // Due to the fact that we still support jurassic IE versions, some
  // compatibility wrappers are needed.

  var e_preventDefault = CodeMirror.e_preventDefault = function(e) {
    if (e.preventDefault) e.preventDefault();
    else e.returnValue = false;
  };
  var e_stopPropagation = CodeMirror.e_stopPropagation = function(e) {
    if (e.stopPropagation) e.stopPropagation();
    else e.cancelBubble = true;
  };
  function e_defaultPrevented(e) {
    return e.defaultPrevented != null ? e.defaultPrevented : e.returnValue == false;
  }
  var e_stop = CodeMirror.e_stop = function(e) {e_preventDefault(e); e_stopPropagation(e);};

  function e_target(e) {return e.target || e.srcElement;}
  function e_button(e) {
    var b = e.which;
    if (b == null) {
      if (e.button & 1) b = 1;
      else if (e.button & 2) b = 3;
      else if (e.button & 4) b = 2;
    }
    if (mac && e.ctrlKey && b == 1) b = 3;
    return b;
  }

  // EVENT HANDLING

  // Lightweight event framework. on/off also work on DOM nodes,
  // registering native DOM handlers.

  var on = CodeMirror.on = function(emitter, type, f) {
    if (emitter.addEventListener)
      emitter.addEventListener(type, f, false);
    else if (emitter.attachEvent)
      emitter.attachEvent("on" + type, f);
    else {
      var map = emitter._handlers || (emitter._handlers = {});
      var arr = map[type] || (map[type] = []);
      arr.push(f);
    }
  };

  var off = CodeMirror.off = function(emitter, type, f) {
    if (emitter.removeEventListener)
      emitter.removeEventListener(type, f, false);
    else if (emitter.detachEvent)
      emitter.detachEvent("on" + type, f);
    else {
      var arr = emitter._handlers && emitter._handlers[type];
      if (!arr) return;
      for (var i = 0; i < arr.length; ++i)
        if (arr[i] == f) { arr.splice(i, 1); break; }
    }
  };

  var signal = CodeMirror.signal = function(emitter, type /*, values...*/) {
    var arr = emitter._handlers && emitter._handlers[type];
    if (!arr) return;
    var args = Array.prototype.slice.call(arguments, 2);
    for (var i = 0; i < arr.length; ++i) arr[i].apply(null, args);
  };

  // Often, we want to signal events at a point where we are in the
  // middle of some work, but don't want the handler to start calling
  // other methods on the editor, which might be in an inconsistent
  // state or simply not expect any other events to happen.
  // signalLater looks whether there are any handlers, and schedules
  // them to be executed when the last operation ends, or, if no
  // operation is active, when a timeout fires.
  var delayedCallbacks, delayedCallbackDepth = 0;
  function signalLater(emitter, type /*, values...*/) {
    var arr = emitter._handlers && emitter._handlers[type];
    if (!arr) return;
    var args = Array.prototype.slice.call(arguments, 2);
    if (!delayedCallbacks) {
      ++delayedCallbackDepth;
      delayedCallbacks = [];
      setTimeout(fireDelayed, 0);
    }
    function bnd(f) {return function(){f.apply(null, args);};};
    for (var i = 0; i < arr.length; ++i)
      delayedCallbacks.push(bnd(arr[i]));
  }

  function fireDelayed() {
    --delayedCallbackDepth;
    var delayed = delayedCallbacks;
    delayedCallbacks = null;
    for (var i = 0; i < delayed.length; ++i) delayed[i]();
  }

  // The DOM events that CodeMirror handles can be overridden by
  // registering a (non-DOM) handler on the editor for the event name,
  // and preventDefault-ing the event in that handler.
  function signalDOMEvent(cm, e, override) {
    signal(cm, override || e.type, cm, e);
    return e_defaultPrevented(e) || e.codemirrorIgnore;
  }

  function signalCursorActivity(cm) {
    var arr = cm._handlers && cm._handlers.cursorActivity;
    if (!arr) return;
    var set = cm.curOp.cursorActivityHandlers || (cm.curOp.cursorActivityHandlers = []);
    for (var i = 0; i < arr.length; ++i) if (indexOf(set, arr[i]) == -1)
      set.push(arr[i]);
  }

  function hasHandler(emitter, type) {
    var arr = emitter._handlers && emitter._handlers[type];
    return arr && arr.length > 0;
  }

  // Add on and off methods to a constructor's prototype, to make
  // registering events on such objects more convenient.
  function eventMixin(ctor) {
    ctor.prototype.on = function(type, f) {on(this, type, f);};
    ctor.prototype.off = function(type, f) {off(this, type, f);};
  }

  // MISC UTILITIES

  // Number of pixels added to scroller and sizer to hide scrollbar
  var scrollerCutOff = 30;

  // Returned or thrown by various protocols to signal 'I'm not
  // handling this'.
  var Pass = CodeMirror.Pass = {toString: function(){return "CodeMirror.Pass";}};

  // Reused option objects for setSelection & friends
  var sel_dontScroll = {scroll: false}, sel_mouse = {origin: "*mouse"}, sel_move = {origin: "+move"};

  function Delayed() {this.id = null;}
  Delayed.prototype.set = function(ms, f) {
    clearTimeout(this.id);
    this.id = setTimeout(f, ms);
  };

  // Counts the column offset in a string, taking tabs into account.
  // Used mostly to find indentation.
  var countColumn = CodeMirror.countColumn = function(string, end, tabSize, startIndex, startValue) {
    if (end == null) {
      end = string.search(/[^\s\u00a0]/);
      if (end == -1) end = string.length;
    }
    for (var i = startIndex || 0, n = startValue || 0;;) {
      var nextTab = string.indexOf("\t", i);
      if (nextTab < 0 || nextTab >= end)
        return n + (end - i);
      n += nextTab - i;
      n += tabSize - (n % tabSize);
      i = nextTab + 1;
    }
  };

  // The inverse of countColumn -- find the offset that corresponds to
  // a particular column.
  function findColumn(string, goal, tabSize) {
    for (var pos = 0, col = 0;;) {
      var nextTab = string.indexOf("\t", pos);
      if (nextTab == -1) nextTab = string.length;
      var skipped = nextTab - pos;
      if (nextTab == string.length || col + skipped >= goal)
        return pos + Math.min(skipped, goal - col);
      col += nextTab - pos;
      col += tabSize - (col % tabSize);
      pos = nextTab + 1;
      if (col >= goal) return pos;
    }
  }

  var spaceStrs = [""];
  function spaceStr(n) {
    while (spaceStrs.length <= n)
      spaceStrs.push(lst(spaceStrs) + " ");
    return spaceStrs[n];
  }

  function lst(arr) { return arr[arr.length-1]; }

  var selectInput = function(node) { node.select(); };
  if (ios) // Mobile Safari apparently has a bug where select() is broken.
    selectInput = function(node) { node.selectionStart = 0; node.selectionEnd = node.value.length; };
  else if (ie) // Suppress mysterious IE10 errors
    selectInput = function(node) { try { node.select(); } catch(_e) {} };

  function indexOf(array, elt) {
    for (var i = 0; i < array.length; ++i)
      if (array[i] == elt) return i;
    return -1;
  }
  if ([].indexOf) indexOf = function(array, elt) { return array.indexOf(elt); };
  function map(array, f) {
    var out = [];
    for (var i = 0; i < array.length; i++) out[i] = f(array[i], i);
    return out;
  }
  if ([].map) map = function(array, f) { return array.map(f); };

  function createObj(base, props) {
    var inst;
    if (Object.create) {
      inst = Object.create(base);
    } else {
      var ctor = function() {};
      ctor.prototype = base;
      inst = new ctor();
    }
    if (props) copyObj(props, inst);
    return inst;
  };

  function copyObj(obj, target, overwrite) {
    if (!target) target = {};
    for (var prop in obj)
      if (obj.hasOwnProperty(prop) && (overwrite !== false || !target.hasOwnProperty(prop)))
        target[prop] = obj[prop];
    return target;
  }

  function bind(f) {
    var args = Array.prototype.slice.call(arguments, 1);
    return function(){return f.apply(null, args);};
  }

  var nonASCIISingleCaseWordChar = /[\u00df\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;
  var isWordCharBasic = CodeMirror.isWordChar = function(ch) {
    return /\w/.test(ch) || ch > "\x80" &&
      (ch.toUpperCase() != ch.toLowerCase() || nonASCIISingleCaseWordChar.test(ch));
  };
  function isWordChar(ch, helper) {
    if (!helper) return isWordCharBasic(ch);
    if (helper.source.indexOf("\\w") > -1 && isWordCharBasic(ch)) return true;
    return helper.test(ch);
  }

  function isEmpty(obj) {
    for (var n in obj) if (obj.hasOwnProperty(n) && obj[n]) return false;
    return true;
  }

  // Extending unicode characters. A series of a non-extending char +
  // any number of extending chars is treated as a single unit as far
  // as editing and measuring is concerned. This is not fully correct,
  // since some scripts/fonts/browsers also treat other configurations
  // of code points as a group.
  var extendingChars = /[\u0300-\u036f\u0483-\u0489\u0591-\u05bd\u05bf\u05c1\u05c2\u05c4\u05c5\u05c7\u0610-\u061a\u064b-\u065e\u0670\u06d6-\u06dc\u06de-\u06e4\u06e7\u06e8\u06ea-\u06ed\u0711\u0730-\u074a\u07a6-\u07b0\u07eb-\u07f3\u0816-\u0819\u081b-\u0823\u0825-\u0827\u0829-\u082d\u0900-\u0902\u093c\u0941-\u0948\u094d\u0951-\u0955\u0962\u0963\u0981\u09bc\u09be\u09c1-\u09c4\u09cd\u09d7\u09e2\u09e3\u0a01\u0a02\u0a3c\u0a41\u0a42\u0a47\u0a48\u0a4b-\u0a4d\u0a51\u0a70\u0a71\u0a75\u0a81\u0a82\u0abc\u0ac1-\u0ac5\u0ac7\u0ac8\u0acd\u0ae2\u0ae3\u0b01\u0b3c\u0b3e\u0b3f\u0b41-\u0b44\u0b4d\u0b56\u0b57\u0b62\u0b63\u0b82\u0bbe\u0bc0\u0bcd\u0bd7\u0c3e-\u0c40\u0c46-\u0c48\u0c4a-\u0c4d\u0c55\u0c56\u0c62\u0c63\u0cbc\u0cbf\u0cc2\u0cc6\u0ccc\u0ccd\u0cd5\u0cd6\u0ce2\u0ce3\u0d3e\u0d41-\u0d44\u0d4d\u0d57\u0d62\u0d63\u0dca\u0dcf\u0dd2-\u0dd4\u0dd6\u0ddf\u0e31\u0e34-\u0e3a\u0e47-\u0e4e\u0eb1\u0eb4-\u0eb9\u0ebb\u0ebc\u0ec8-\u0ecd\u0f18\u0f19\u0f35\u0f37\u0f39\u0f71-\u0f7e\u0f80-\u0f84\u0f86\u0f87\u0f90-\u0f97\u0f99-\u0fbc\u0fc6\u102d-\u1030\u1032-\u1037\u1039\u103a\u103d\u103e\u1058\u1059\u105e-\u1060\u1071-\u1074\u1082\u1085\u1086\u108d\u109d\u135f\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17b7-\u17bd\u17c6\u17c9-\u17d3\u17dd\u180b-\u180d\u18a9\u1920-\u1922\u1927\u1928\u1932\u1939-\u193b\u1a17\u1a18\u1a56\u1a58-\u1a5e\u1a60\u1a62\u1a65-\u1a6c\u1a73-\u1a7c\u1a7f\u1b00-\u1b03\u1b34\u1b36-\u1b3a\u1b3c\u1b42\u1b6b-\u1b73\u1b80\u1b81\u1ba2-\u1ba5\u1ba8\u1ba9\u1c2c-\u1c33\u1c36\u1c37\u1cd0-\u1cd2\u1cd4-\u1ce0\u1ce2-\u1ce8\u1ced\u1dc0-\u1de6\u1dfd-\u1dff\u200c\u200d\u20d0-\u20f0\u2cef-\u2cf1\u2de0-\u2dff\u302a-\u302f\u3099\u309a\ua66f-\ua672\ua67c\ua67d\ua6f0\ua6f1\ua802\ua806\ua80b\ua825\ua826\ua8c4\ua8e0-\ua8f1\ua926-\ua92d\ua947-\ua951\ua980-\ua982\ua9b3\ua9b6-\ua9b9\ua9bc\uaa29-\uaa2e\uaa31\uaa32\uaa35\uaa36\uaa43\uaa4c\uaab0\uaab2-\uaab4\uaab7\uaab8\uaabe\uaabf\uaac1\uabe5\uabe8\uabed\udc00-\udfff\ufb1e\ufe00-\ufe0f\ufe20-\ufe26\uff9e\uff9f]/;
  function isExtendingChar(ch) { return ch.charCodeAt(0) >= 768 && extendingChars.test(ch); }

  // DOM UTILITIES

  function elt(tag, content, className, style) {
    var e = document.createElement(tag);
    if (className) e.className = className;
    if (style) e.style.cssText = style;
    if (typeof content == "string") e.appendChild(document.createTextNode(content));
    else if (content) for (var i = 0; i < content.length; ++i) e.appendChild(content[i]);
    return e;
  }

  var range;
  if (document.createRange) range = function(node, start, end) {
    var r = document.createRange();
    r.setEnd(node, end);
    r.setStart(node, start);
    return r;
  };
  else range = function(node, start, end) {
    var r = document.body.createTextRange();
    r.moveToElementText(node.parentNode);
    r.collapse(true);
    r.moveEnd("character", end);
    r.moveStart("character", start);
    return r;
  };

  function removeChildren(e) {
    for (var count = e.childNodes.length; count > 0; --count)
      e.removeChild(e.firstChild);
    return e;
  }

  function removeChildrenAndAdd(parent, e) {
    return removeChildren(parent).appendChild(e);
  }

  function contains(parent, child) {
    if (parent.contains)
      return parent.contains(child);
    while (child = child.parentNode)
      if (child == parent) return true;
  }

  function activeElt() { return document.activeElement; }
  // Older versions of IE throws unspecified error when touching
  // document.activeElement in some cases (during loading, in iframe)
  if (ie && ie_version < 11) activeElt = function() {
    try { return document.activeElement; }
    catch(e) { return document.body; }
  };

  function classTest(cls) { return new RegExp("\\b" + cls + "\\b\\s*"); }
  function rmClass(node, cls) {
    var test = classTest(cls);
    if (test.test(node.className)) node.className = node.className.replace(test, "");
  }
  function addClass(node, cls) {
    if (!classTest(cls).test(node.className)) node.className += " " + cls;
  }
  function joinClasses(a, b) {
    var as = a.split(" ");
    for (var i = 0; i < as.length; i++)
      if (as[i] && !classTest(as[i]).test(b)) b += " " + as[i];
    return b;
  }

  // WINDOW-WIDE EVENTS

  // These must be handled carefully, because naively registering a
  // handler for each editor will cause the editors to never be
  // garbage collected.

  function forEachCodeMirror(f) {
    if (!document.body.getElementsByClassName) return;
    var byClass = document.body.getElementsByClassName("CodeMirror");
    for (var i = 0; i < byClass.length; i++) {
      var cm = byClass[i].CodeMirror;
      if (cm) f(cm);
    }
  }

  var globalsRegistered = false;
  function ensureGlobalHandlers() {
    if (globalsRegistered) return;
    registerGlobalHandlers();
    globalsRegistered = true;
  }
  function registerGlobalHandlers() {
    // When the window resizes, we need to refresh active editors.
    var resizeTimer;
    on(window, "resize", function() {
      if (resizeTimer == null) resizeTimer = setTimeout(function() {
        resizeTimer = null;
        knownScrollbarWidth = null;
        forEachCodeMirror(onResize);
      }, 100);
    });
    // When the window loses focus, we want to show the editor as blurred
    on(window, "blur", function() {
      forEachCodeMirror(onBlur);
    });
  }

  // FEATURE DETECTION

  // Detect drag-and-drop
  var dragAndDrop = function() {
    // There is *some* kind of drag-and-drop support in IE6-8, but I
    // couldn't get it to work yet.
    if (ie && ie_version < 9) return false;
    var div = elt('div');
    return "draggable" in div || "dragDrop" in div;
  }();

  var knownScrollbarWidth;
  function scrollbarWidth(measure) {
    if (knownScrollbarWidth != null) return knownScrollbarWidth;
    var test = elt("div", null, null, "width: 50px; height: 50px; overflow-x: scroll");
    removeChildrenAndAdd(measure, test);
    if (test.offsetWidth)
      knownScrollbarWidth = test.offsetHeight - test.clientHeight;
    return knownScrollbarWidth || 0;
  }

  var zwspSupported;
  function zeroWidthElement(measure) {
    if (zwspSupported == null) {
      var test = elt("span", "\u200b");
      removeChildrenAndAdd(measure, elt("span", [test, document.createTextNode("x")]));
      if (measure.firstChild.offsetHeight != 0)
        zwspSupported = test.offsetWidth <= 1 && test.offsetHeight > 2 && !(ie && ie_version < 8);
    }
    if (zwspSupported) return elt("span", "\u200b");
    else return elt("span", "\u00a0", null, "display: inline-block; width: 1px; margin-right: -1px");
  }

  // Feature-detect IE's crummy client rect reporting for bidi text
  var badBidiRects;
  function hasBadBidiRects(measure) {
    if (badBidiRects != null) return badBidiRects;
    var txt = removeChildrenAndAdd(measure, document.createTextNode("A\u062eA"));
    var r0 = range(txt, 0, 1).getBoundingClientRect();
    if (r0.left == r0.right) return false;
    var r1 = range(txt, 1, 2).getBoundingClientRect();
    return badBidiRects = (r1.right - r0.right < 3);
  }

  // See if "".split is the broken IE version, if so, provide an
  // alternative way to split lines.
  var splitLines = CodeMirror.splitLines = "\n\nb".split(/\n/).length != 3 ? function(string) {
    var pos = 0, result = [], l = string.length;
    while (pos <= l) {
      var nl = string.indexOf("\n", pos);
      if (nl == -1) nl = string.length;
      var line = string.slice(pos, string.charAt(nl - 1) == "\r" ? nl - 1 : nl);
      var rt = line.indexOf("\r");
      if (rt != -1) {
        result.push(line.slice(0, rt));
        pos += rt + 1;
      } else {
        result.push(line);
        pos = nl + 1;
      }
    }
    return result;
  } : function(string){return string.split(/\r\n?|\n/);};

  var hasSelection = window.getSelection ? function(te) {
    try { return te.selectionStart != te.selectionEnd; }
    catch(e) { return false; }
  } : function(te) {
    try {var range = te.ownerDocument.selection.createRange();}
    catch(e) {}
    if (!range || range.parentElement() != te) return false;
    return range.compareEndPoints("StartToEnd", range) != 0;
  };

  var hasCopyEvent = (function() {
    var e = elt("div");
    if ("oncopy" in e) return true;
    e.setAttribute("oncopy", "return;");
    return typeof e.oncopy == "function";
  })();

  // KEY NAMES

  var keyNames = {3: "Enter", 8: "Backspace", 9: "Tab", 13: "Enter", 16: "Shift", 17: "Ctrl", 18: "Alt",
                  19: "Pause", 20: "CapsLock", 27: "Esc", 32: "Space", 33: "PageUp", 34: "PageDown", 35: "End",
                  36: "Home", 37: "Left", 38: "Up", 39: "Right", 40: "Down", 44: "PrintScrn", 45: "Insert",
                  46: "Delete", 59: ";", 61: "=", 91: "Mod", 92: "Mod", 93: "Mod", 107: "=", 109: "-", 127: "Delete",
                  173: "-", 186: ";", 187: "=", 188: ",", 189: "-", 190: ".", 191: "/", 192: "`", 219: "[", 220: "\\",
                  221: "]", 222: "'", 63232: "Up", 63233: "Down", 63234: "Left", 63235: "Right", 63272: "Delete",
                  63273: "Home", 63275: "End", 63276: "PageUp", 63277: "PageDown", 63302: "Insert"};
  CodeMirror.keyNames = keyNames;
  (function() {
    // Number keys
    for (var i = 0; i < 10; i++) keyNames[i + 48] = keyNames[i + 96] = String(i);
    // Alphabetic keys
    for (var i = 65; i <= 90; i++) keyNames[i] = String.fromCharCode(i);
    // Function keys
    for (var i = 1; i <= 12; i++) keyNames[i + 111] = keyNames[i + 63235] = "F" + i;
  })();

  // BIDI HELPERS

  function iterateBidiSections(order, from, to, f) {
    if (!order) return f(from, to, "ltr");
    var found = false;
    for (var i = 0; i < order.length; ++i) {
      var part = order[i];
      if (part.from < to && part.to > from || from == to && part.to == from) {
        f(Math.max(part.from, from), Math.min(part.to, to), part.level == 1 ? "rtl" : "ltr");
        found = true;
      }
    }
    if (!found) f(from, to, "ltr");
  }

  function bidiLeft(part) { return part.level % 2 ? part.to : part.from; }
  function bidiRight(part) { return part.level % 2 ? part.from : part.to; }

  function lineLeft(line) { var order = getOrder(line); return order ? bidiLeft(order[0]) : 0; }
  function lineRight(line) {
    var order = getOrder(line);
    if (!order) return line.text.length;
    return bidiRight(lst(order));
  }

  function lineStart(cm, lineN) {
    var line = getLine(cm.doc, lineN);
    var visual = visualLine(line);
    if (visual != line) lineN = lineNo(visual);
    var order = getOrder(visual);
    var ch = !order ? 0 : order[0].level % 2 ? lineRight(visual) : lineLeft(visual);
    return Pos(lineN, ch);
  }
  function lineEnd(cm, lineN) {
    var merged, line = getLine(cm.doc, lineN);
    while (merged = collapsedSpanAtEnd(line)) {
      line = merged.find(1, true).line;
      lineN = null;
    }
    var order = getOrder(line);
    var ch = !order ? line.text.length : order[0].level % 2 ? lineLeft(line) : lineRight(line);
    return Pos(lineN == null ? lineNo(line) : lineN, ch);
  }

  function compareBidiLevel(order, a, b) {
    var linedir = order[0].level;
    if (a == linedir) return true;
    if (b == linedir) return false;
    return a < b;
  }
  var bidiOther;
  function getBidiPartAt(order, pos) {
    bidiOther = null;
    for (var i = 0, found; i < order.length; ++i) {
      var cur = order[i];
      if (cur.from < pos && cur.to > pos) return i;
      if ((cur.from == pos || cur.to == pos)) {
        if (found == null) {
          found = i;
        } else if (compareBidiLevel(order, cur.level, order[found].level)) {
          if (cur.from != cur.to) bidiOther = found;
          return i;
        } else {
          if (cur.from != cur.to) bidiOther = i;
          return found;
        }
      }
    }
    return found;
  }

  function moveInLine(line, pos, dir, byUnit) {
    if (!byUnit) return pos + dir;
    do pos += dir;
    while (pos > 0 && isExtendingChar(line.text.charAt(pos)));
    return pos;
  }

  // This is needed in order to move 'visually' through bi-directional
  // text -- i.e., pressing left should make the cursor go left, even
  // when in RTL text. The tricky part is the 'jumps', where RTL and
  // LTR text touch each other. This often requires the cursor offset
  // to move more than one unit, in order to visually move one unit.
  function moveVisually(line, start, dir, byUnit) {
    var bidi = getOrder(line);
    if (!bidi) return moveLogically(line, start, dir, byUnit);
    var pos = getBidiPartAt(bidi, start), part = bidi[pos];
    var target = moveInLine(line, start, part.level % 2 ? -dir : dir, byUnit);

    for (;;) {
      if (target > part.from && target < part.to) return target;
      if (target == part.from || target == part.to) {
        if (getBidiPartAt(bidi, target) == pos) return target;
        part = bidi[pos += dir];
        return (dir > 0) == part.level % 2 ? part.to : part.from;
      } else {
        part = bidi[pos += dir];
        if (!part) return null;
        if ((dir > 0) == part.level % 2)
          target = moveInLine(line, part.to, -1, byUnit);
        else
          target = moveInLine(line, part.from, 1, byUnit);
      }
    }
  }

  function moveLogically(line, start, dir, byUnit) {
    var target = start + dir;
    if (byUnit) while (target > 0 && isExtendingChar(line.text.charAt(target))) target += dir;
    return target < 0 || target > line.text.length ? null : target;
  }

  // Bidirectional ordering algorithm
  // See http://unicode.org/reports/tr9/tr9-13.html for the algorithm
  // that this (partially) implements.

  // One-char codes used for character types:
  // L (L):   Left-to-Right
  // R (R):   Right-to-Left
  // r (AL):  Right-to-Left Arabic
  // 1 (EN):  European Number
  // + (ES):  European Number Separator
  // % (ET):  European Number Terminator
  // n (AN):  Arabic Number
  // , (CS):  Common Number Separator
  // m (NSM): Non-Spacing Mark
  // b (BN):  Boundary Neutral
  // s (B):   Paragraph Separator
  // t (S):   Segment Separator
  // w (WS):  Whitespace
  // N (ON):  Other Neutrals

  // Returns null if characters are ordered as they appear
  // (left-to-right), or an array of sections ({from, to, level}
  // objects) in the order in which they occur visually.
  var bidiOrdering = (function() {
    // Character types for codepoints 0 to 0xff
    var lowTypes = "bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLN";
    // Character types for codepoints 0x600 to 0x6ff
    var arabicTypes = "rrrrrrrrrrrr,rNNmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmrrrrrrrnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmNmmmm";
    function charType(code) {
      if (code <= 0xf7) return lowTypes.charAt(code);
      else if (0x590 <= code && code <= 0x5f4) return "R";
      else if (0x600 <= code && code <= 0x6ed) return arabicTypes.charAt(code - 0x600);
      else if (0x6ee <= code && code <= 0x8ac) return "r";
      else if (0x2000 <= code && code <= 0x200b) return "w";
      else if (code == 0x200c) return "b";
      else return "L";
    }

    var bidiRE = /[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/;
    var isNeutral = /[stwN]/, isStrong = /[LRr]/, countsAsLeft = /[Lb1n]/, countsAsNum = /[1n]/;
    // Browsers seem to always treat the boundaries of block elements as being L.
    var outerType = "L";

    function BidiSpan(level, from, to) {
      this.level = level;
      this.from = from; this.to = to;
    }

    return function(str) {
      if (!bidiRE.test(str)) return false;
      var len = str.length, types = [];
      for (var i = 0, type; i < len; ++i)
        types.push(type = charType(str.charCodeAt(i)));

      // W1. Examine each non-spacing mark (NSM) in the level run, and
      // change the type of the NSM to the type of the previous
      // character. If the NSM is at the start of the level run, it will
      // get the type of sor.
      for (var i = 0, prev = outerType; i < len; ++i) {
        var type = types[i];
        if (type == "m") types[i] = prev;
        else prev = type;
      }

      // W2. Search backwards from each instance of a European number
      // until the first strong type (R, L, AL, or sor) is found. If an
      // AL is found, change the type of the European number to Arabic
      // number.
      // W3. Change all ALs to R.
      for (var i = 0, cur = outerType; i < len; ++i) {
        var type = types[i];
        if (type == "1" && cur == "r") types[i] = "n";
        else if (isStrong.test(type)) { cur = type; if (type == "r") types[i] = "R"; }
      }

      // W4. A single European separator between two European numbers
      // changes to a European number. A single common separator between
      // two numbers of the same type changes to that type.
      for (var i = 1, prev = types[0]; i < len - 1; ++i) {
        var type = types[i];
        if (type == "+" && prev == "1" && types[i+1] == "1") types[i] = "1";
        else if (type == "," && prev == types[i+1] &&
                 (prev == "1" || prev == "n")) types[i] = prev;
        prev = type;
      }

      // W5. A sequence of European terminators adjacent to European
      // numbers changes to all European numbers.
      // W6. Otherwise, separators and terminators change to Other
      // Neutral.
      for (var i = 0; i < len; ++i) {
        var type = types[i];
        if (type == ",") types[i] = "N";
        else if (type == "%") {
          for (var end = i + 1; end < len && types[end] == "%"; ++end) {}
          var replace = (i && types[i-1] == "!") || (end < len && types[end] == "1") ? "1" : "N";
          for (var j = i; j < end; ++j) types[j] = replace;
          i = end - 1;
        }
      }

      // W7. Search backwards from each instance of a European number
      // until the first strong type (R, L, or sor) is found. If an L is
      // found, then change the type of the European number to L.
      for (var i = 0, cur = outerType; i < len; ++i) {
        var type = types[i];
        if (cur == "L" && type == "1") types[i] = "L";
        else if (isStrong.test(type)) cur = type;
      }

      // N1. A sequence of neutrals takes the direction of the
      // surrounding strong text if the text on both sides has the same
      // direction. European and Arabic numbers act as if they were R in
      // terms of their influence on neutrals. Start-of-level-run (sor)
      // and end-of-level-run (eor) are used at level run boundaries.
      // N2. Any remaining neutrals take the embedding direction.
      for (var i = 0; i < len; ++i) {
        if (isNeutral.test(types[i])) {
          for (var end = i + 1; end < len && isNeutral.test(types[end]); ++end) {}
          var before = (i ? types[i-1] : outerType) == "L";
          var after = (end < len ? types[end] : outerType) == "L";
          var replace = before || after ? "L" : "R";
          for (var j = i; j < end; ++j) types[j] = replace;
          i = end - 1;
        }
      }

      // Here we depart from the documented algorithm, in order to avoid
      // building up an actual levels array. Since there are only three
      // levels (0, 1, 2) in an implementation that doesn't take
      // explicit embedding into account, we can build up the order on
      // the fly, without following the level-based algorithm.
      var order = [], m;
      for (var i = 0; i < len;) {
        if (countsAsLeft.test(types[i])) {
          var start = i;
          for (++i; i < len && countsAsLeft.test(types[i]); ++i) {}
          order.push(new BidiSpan(0, start, i));
        } else {
          var pos = i, at = order.length;
          for (++i; i < len && types[i] != "L"; ++i) {}
          for (var j = pos; j < i;) {
            if (countsAsNum.test(types[j])) {
              if (pos < j) order.splice(at, 0, new BidiSpan(1, pos, j));
              var nstart = j;
              for (++j; j < i && countsAsNum.test(types[j]); ++j) {}
              order.splice(at, 0, new BidiSpan(2, nstart, j));
              pos = j;
            } else ++j;
          }
          if (pos < i) order.splice(at, 0, new BidiSpan(1, pos, i));
        }
      }
      if (order[0].level == 1 && (m = str.match(/^\s+/))) {
        order[0].from = m[0].length;
        order.unshift(new BidiSpan(0, 0, m[0].length));
      }
      if (lst(order).level == 1 && (m = str.match(/\s+$/))) {
        lst(order).to -= m[0].length;
        order.push(new BidiSpan(0, len - m[0].length, len));
      }
      if (order[0].level != lst(order).level)
        order.push(new BidiSpan(order[0].level, len, len));

      return order;
    };
  })();

  // THE END

  CodeMirror.version = "4.3.0";

  return CodeMirror;
});

},{}],8:[function(require,module,exports){
(function (global){
var $237=function(type$240){var f$244;(f$244=type$240["::check"]);if((f$244===(void 0))){return function(value$250){return (value$250 instanceof type$240);};}else{return function(value$254){return f$244.call(type$240,value$254);};}};
var $256=(function(o,m){if(typeof(m)==='string'||typeof(m)==='number'){return o[m];}else{return o['::send'](m);}});
var $257=function(dest$260,values$261){var k$266;(k$266=null);$264:for(k$266 in values$261){if(values$261.hasOwnProperty(k$266)){(dest$260[k$266]=values$261[k$266]);}}return dest$260;};
var $274=function($276$279){var ph$285;(ph$285=$276$279);var $281$291;($281$291=ph$285);var bridge$283$296;var x$300;(bridge$283$296=$281$291);if((((typeof(bridge$283$296)==="string")&&((x$300=bridge$283$296),true))||((typeof(bridge$283$296)==="number")&&((x$300=bridge$283$296),true)))){return ["value",x$300];}else{var other$311;(other$311=$281$291);return other$311["::serialize_ast"]();}};
var send$11;(send$11=function(obj$18,$15$19){var ph$25;var msg$26;var t0$28;(t0$28=$15$19);(msg$26=t0$28);(ph$25=t0$28);var $21$37;($21$37=ph$25);var bridge$23$42;(bridge$23$42=$21$37);if(((typeof(bridge$23$42)==="string")||(typeof(bridge$23$42)==="number"))){return obj$18[msg$26];}else{var other$54;(other$54=$21$37);return obj$18["::send"](msg$26);}});(Array[":::project"]=function($60$63){var ph$68;var value$69;var t0$71;(t0$71=$60$63);(value$69=t0$71);(ph$68=t0$71);var $65$80;($65$80=ph$68);if($237(Array)($65$80)){return [true,value$69];}else{$65$80;return [true,[value$69]];}});(Array.prototype["::check"]=function(value$98){if((value$98 instanceof Array)){var i$104;(i$104=0);$101:for(;(i$104<this.length);(i$104++)){if(($256(this,i$104)!==$256(value$98,i$104))){return false;}}return true;}else{return false;}});(Array.prototype["::clone"]=function(){return $257(this.slice(0),this);});(Array.prototype[":::project"]=function(value$123){if((value$123 instanceof Array)){var i$129;(i$129=0);$126:for(;(i$129<this.length);(i$129++)){if(($256(this,i$129)!==$256(value$123,i$129))){return [true,[value$123]];}}return [true,value$123.slice(this.length)];}else{return [true,[value$123]];}});(Array.prototype["::serialize_ast"]=function(){return ["array"].concat(this.map($274));});(RegExp.prototype["::check"]=function($147$150){var ph$155;(ph$155=$147$150);var $152$161;($152$161=ph$155);var value$169;if((typeof($152$161)==="string")){(value$169=$152$161);if(value$169.match(this)){return true;}else{return false;}}else{var other$174;(other$174=$152$161);return false;}});(RegExp.prototype[":::project"]=function($180$183){var ph$188;(ph$188=$180$183);var $185$194;($185$194=ph$188);var value$202;if((typeof($185$194)==="string")){(value$202=$185$194);var $205$210;($205$210=value$202.match(this));var m$218;if(($205$210===null)){(m$218=$205$210);return [false,null];}else{var m$223;(m$223=$205$210);return [true,m$223];}}else{var other$227;(other$227=$185$194);return [false,null];}});(Function.prototype["::send"]=function(args$234){return this.apply(this,args$234);});
var $1259=function(arr$1262){var results$1268;var l$1269;(results$1268=[]);(l$1269=arr$1262.length);var i$1278;(i$1278=0);$1267:for(;(i$1278<l$1269);(i$1278++)){results$1268.push([i$1278,$256(arr$1262,i$1278)]);}return results$1268;};
var $1026=function(){var $1027$1033;($1027$1033=function(tags$1038){var it$0$1041;(it$0$1041=function(){if((!$237($1027$1033)(this))){return Object.create($1027$1033.prototype);}else{return this;}}());(it$0$1041["tags"]=tags$1038);return it$0$1041;});($1027$1033.prototype["create"]=function(){var it$0$1061;var self$1062;(it$0$1061=this);(self$1062=this);var $1059$1071;($1059$1071=arguments);var t0$1076;var message$1080;var args$1081;(t0$1076=$1059$1071.length);if((t0$1076>=0)){(message$1080=function(){if((0>=t0$1076)){return "";}else{return $1059$1071[0];}}());(args$1081=Array.prototype.slice.call($1059$1071,1));var e$1094;(e$1094=Error(message$1080));(e$1094["::tags"]=it$0$1061.tags);(e$1094["args"]=args$1081);var temp$1110;(temp$1110=$1259(args$1081));var $length$1116;($length$1116=temp$1110.length);var $index$1122;($index$1122=0);$1095:for(;($index$1122<$length$1116);($index$1122++)){var m$1131;(m$1131=temp$1110[$index$1122]);var t0$1136;var t1$1137;var i$1141;var arg$1142;(t0$1136=m$1131);if(((t0$1136 instanceof Array)&&(((t1$1137=t0$1136.length)),(t1$1137===2)))){(i$1141=t0$1136[0]);(arg$1142=t0$1136[1]);(e$1094[i$1141]=arg$1142);}else{$1007(m$1131);}}(e$1094["length"]=args$1081.length);(e$1094["name"]=["E"].concat(it$0$1061.tags).join("."));return e$1094;}else{$1007($1059$1071);}});($1027$1033.prototype["::check"]=function(e$1172){var it$0$1176;var self$1177;(it$0$1176=this);(self$1177=this);var tags$1187;if(((!e$1172)||(!$237(Error)(e$1172)))){return false;}(tags$1187=(e$1172["::tags"]||[]));var temp$1198;(temp$1198=it$0$1176.tags);var $length$1204;($length$1204=temp$1198.length);var $index$1210;($index$1210=0);$1188:for(;($index$1210<$length$1204);($index$1210++)){var m$1219;(m$1219=temp$1198[$index$1210]);var tag$1227;(tag$1227=m$1219);if((tags$1187.indexOf(tag$1227)===-1)){return false;}else{false;}}return true;});($1027$1033.prototype["::deconstruct"]=function(e$1236){var it$0$1240;var self$1241;(it$0$1240=this);(self$1241=this);return e$1236.args;});$257($1027$1033,$257(function(){var accum$1252;(accum$1252=({}));(accum$1252["::name"]="$1027");return accum$1252;}(),function(){var accum$1256;(accum$1256=({}));(accum$1256["::egclass"]=true);return accum$1256;}()));return $1027$1033;}();
var $1007=function(value$1010,url$1011,start$1012,end$1013){var err$1017;(err$1017=$1026(["match"]).create("Could not find a match for value",({"value":value$1010})));if(url$1011){(err$1017["location"]=["location",url$1011,start$1012,end$1013]);}throw err$1017;};
var $1285=function($1287$1290,key$1291){var ph$1299;(ph$1299=$1287$1290);var $1293$1305;($1293$1305=ph$1299);var bridge$1295$1310;(bridge$1295$1310=$1293$1305);if(((bridge$1295$1310===null)||(bridge$1295$1310===(void 0)))){return false;}else{var x$1322;if((typeof($1293$1305)==="string")){(x$1322=$1293$1305);return (key$1291 in String.prototype);}else{var x$1327;if((typeof($1293$1305)==="number")){(x$1327=$1293$1305);return (key$1291 in Number.prototype);}else{var x$1332;(x$1332=$1293$1305);return (key$1291 in x$1332);}}}};
var $1334=function(obj$1337){var results$1342;(results$1342=[]);var k$1347;(k$1347=null);$1341:for(k$1347 in obj$1337){if(Object.prototype.hasOwnProperty.call(obj$1337,k$1347)){results$1342.push([k$1347,$256(obj$1337,k$1347)]);}}return results$1342;};
var $1351=function(type$1354){return function(value$1358){var f$1362;(f$1362=type$1354[":::project"]);if((f$1362===(void 0))){(f$1362=type$1354["::project"]);if((f$1362===(void 0))){return [true,type$1354(value$1358)];}else{var rval$1375;(rval$1375=false);try{(rval$1375=[true,f$1362(value$1358)]);}catch(excv$1386){var e$1392;(e$1392=excv$1386);(rval$1375=[false,null]);}return rval$1375;}}else{return f$1362.call(type$1354,value$1358);}};};var accum$963;var accum$967;var $315$346;var Source$347;var Location$348;var highlight_locations$349;var $316$350;var tokenize$351;var $317$352;var parse$353;var $318$354;var translate$355;var Translator$356;var std$357;var exp$358;var opt$359;var vm$360;var module$361;var path$362;var version$363;var evaluator$364;var generate_from_ast$365;var generate$366;var Generator$367;($315$346=require("./location"));(Source$347=$315$346.Source);(Location$348=$315$346.Location);(highlight_locations$349=$315$346.highlight_locations);($316$350=require("./lex"));(tokenize$351=$316$350.tokenize);($317$352=require("./parse"));(parse$353=$317$352.parse);($318$354=require("./translate-js"));(translate$355=$318$354.translate);(Translator$356=$318$354.Translator);(std$357=require("./stdenv"));(exp$358=require("./expand"));(opt$359=require("./opt"));(vm$360=require("vm"));(module$361=require("module"));(path$362=require("path"));(version$363="zero");(evaluator$364=function($425$428){var t0$437;var accum$480;var paths$462;var e_module$463;var e_require$464;var $433$452;var $430$446;var ph$434;var options$435;(t0$437=$425$428);(options$435=t0$437);(ph$434=t0$437);($430$446=ph$434);$430$446;if(module$361._nodeModulePaths){(paths$462=module$361._nodeModulePaths(options$435.cwd));(e_module$463=(new module$361(options$435.showname)));$257(e_module$463,({"filename":options$435.filename,"paths":paths$462}));(e_require$464=function(path$475){return module$361._load(path$475,e_module$463,true);});$257(e_require$464,$257(({"main":e_module$463}),$257(((accum$480=({})),((accum$480["resolve"]=function(path$485){return module$361._resolveFileName(path$485,e_module$463);}),accum$480)),({"paths":paths$462,"cache":require.cache}))));$257(global,({"__filename":options$435.filename,"__dirname":path$362.dirname(options$435.filename),"module":e_module$463,"require":e_require$464}));return function(code$488){var script$492;(script$492=vm$360.createScript(code$488,options$435.showname));return script$492.runInThisContext();};}else{return function(code$501){return eval(code$501);};}});(generate_from_ast$365=function(ast$508){var ex$515;var tr$516;var rval$517;(ex$515=std$357.expand(["top"],std$357.topscope,std$357.stdenv.fork().mark(["multi",ast$508])));(ex$515=opt$359.hoist(ex$515));(tr$516=Translator$356());(rval$517=tr$516.translate(ex$515,"expr"));return [tr$516.dump_store(),rval$517];});std$357.stdenv.bind(std$357.topscope,"macro",["macro",function(context$535,scope$536,form$537,$532$538){var t0$606;var t1$607;var prep$599;var code$600;var file$601;var ev$602;var mac$603;var mac2$604;var name$561;var sym$562;var arguments$563;var ast$564;var t0$553;var t1$554;var t2$555;var t3$556;var t4$557;var $540$548;var ph$542;(ph$542=$532$538);($540$548=ph$542);if((($540$548 instanceof Array)&&(((t0$553=$540$548.length)),((t0$553===3)&&(($540$548[0]==="data")&&(((t1$554=$540$548[1])),((t1$554 instanceof Array)&&(((t2$555=t1$554.length)),((t2$555===3)&&((t1$554[0]==="send")&&(((t3$556=t1$554[1])),((name$561=t3$556),((t3$556 instanceof Array)&&(((t4$557=t3$556.length)),((t4$557===2)&&(t3$556[0]==="symbol")))))))))))))))){(sym$562=t3$556[1]);(arguments$563=t1$554[2]);(ast$564=$540$548[2]);(t0$606=generate_from_ast$365(["send",["symbol","->"],["data",arguments$563,ast$564]]));if(((t0$606 instanceof Array)&&(((t1$607=t0$606.length)),(t1$607===2)))){(prep$599=t0$606[0]);(code$600=t0$606[1]);}else{$1007(generate_from_ast$365(["send",["symbol","->"],["data",arguments$563,ast$564]]),"/home/olivier/git/earl-grey/src/earl-grey.eg",1667,1717);}(file$601=form$537.location.source.url);(ev$602=evaluator$364(({"filename":file$601,"showname":file$601,"cwd":file$601})));(mac$603=ev$602((prep$599+((";("+code$600)+")"))));(mac2$604=function(c$633,s$634,f$635,e$636){var bindings$643;var env$644;var r$645;(bindings$643=form$537.env.list_bindings(scope$536));(env$644=exp$358.Env());(env$644.scopes[std$357.topscope.name]=bindings$643);(r$645=mac$603(c$633,s$634,f$635,e$636));return env$644.mark(r$645);});return ["declare_raw",name$561,["macro",mac2$604]];}else{$1007($540$548);}}]);std$357.stdenv.bind(std$357.topscope,"macros",["macro",function(context$667,scope$668,$662$669,$664$670){var t0$675;var t0$684;var t1$685;var t0$705;var t1$706;var $index$746;var $length$740;var temp$734;var acc$728;var prep$701;var code$702;var the_macros$703;var env$672;var body$673;(t0$675=$662$669);if($1285(t0$675,"env")){(env$672=t0$675.env);}else{$1007($662$669);}(t0$684=$664$670);if(((t0$684 instanceof Array)&&(((t1$685=t0$684.length)),((t1$685===2)&&(t0$684[0]==="data"))))){(body$673=t0$684[1]);}else{$1007($664$670);}(t0$705=generate_from_ast$365(body$673));if(((t0$705 instanceof Array)&&(((t1$706=t0$705.length)),(t1$706===2)))){(prep$701=t0$705[0]);(code$702=t0$705[1]);}else{$1007(generate_from_ast$365(body$673),"/home/olivier/git/earl-grey/src/earl-grey.eg",2635,2665);}(the_macros$703=eval((((prep$701+";(")+code$702)+")")));return ["splice"].concat((((acc$728=[])),(((temp$734=$1334(the_macros$703))),((($length$740=temp$734.length)),((($index$746=0)),function(){$723:for(;($index$746<$length$740);($index$746++)){var k$765;var v$766;var t0$760;var t1$761;var m$755;(m$755=temp$734[$index$746]);(t0$760=m$755);if(((t0$760 instanceof Array)&&(((t1$761=t0$760.length)),(t1$761===2)))){(k$765=t0$760[0]);(v$766=t0$760[1]);acc$728.push(["declare_raw",$257(["symbol",k$765],({"env":env$672})),["macro",v$766]]);}else{$1007(m$755,"/home/olivier/git/earl-grey/src/earl-grey.eg",2735,2842);}}}()))),acc$728));}]);(generate$366=function(source$785){return Generator$367().generate(source$785);});(Generator$367=function(){var interactive$812;var t0$808;var $799$803;var it$0$794;(it$0$794=function(){if((!$237(Generator$367)(this))){return Object.create(Generator$367.prototype);}else{return this;}}());($799$803=arguments);(t0$808=$799$803.length);if(((t0$808>=0)&&(t0$808<=1))){(interactive$812=function(){if((0>=t0$808)){return false;}else{return $799$803[0];}}());(it$0$794["tr"]=Translator$356(std$357.stdprelude));(it$0$794["env"]=std$357.stdenv.fork());(it$0$794["interactive"]=interactive$812);(it$0$794["_eval"]=null);}else{$1007($799$803);}return it$0$794;});(Generator$367.prototype["generate"]=function(){var t0$902;var t1$903;var t2$904;var args$900;var stmt$895;var t$881;var p$882;var ex$883;var rval$884;var source$867;var dump$868;var t0$863;var $846$858;var it$0$848;var self$849;(it$0$848=this);(self$849=this);($846$858=arguments);(t0$863=$846$858.length);if(((t0$863>=1)&&(t0$863<=2))){(source$867=$846$858[0]);(dump$868=function(){if((1>=t0$863)){return true;}else{return $846$858[1];}}());(t$881=tokenize$351(source$867));(p$882=parse$353(t$881));(ex$883=(((stmt$895=function(){if(it$0$848.interactive){(t0$902=$1351(["multi"])(p$882));if((t0$902[0]&&(((t1$903=t0$902[1])),(((t2$904=t1$903.length)),(t2$904>=0))))){(args$900=Array.prototype.slice.call(t1$903,0));}else{$1007(p$882,"/home/olivier/git/earl-grey/src/earl-grey.eg",3643,3644);}return ["interactive"].concat(args$900);}else{return ["multi",p$882];}}())),std$357.expand(["top"],std$357.topscope,it$0$848.env.mark(stmt$895))));(ex$883=opt$359.hoist(ex$883));(rval$884=it$0$848.tr.translate(ex$883,"stmt"));if(dump$868){return (it$0$848.tr.dump_store()+rval$884);}else{return rval$884;}}else{$1007($846$858);}});(Generator$367.prototype["evaluate"]=function(source$936){var file$953;var it$0$940;var self$941;(it$0$940=this);(self$941=this);if((!it$0$940._eval)){(file$953=source$936.url);(it$0$940["_eval"]=evaluator$364(({"filename":file$953,"showname":file$953,"cwd":file$953})));}return it$0$940._eval(it$0$940.generate(source$936));});$257(Generator$367,$257(((accum$963=({})),((accum$963["::name"]="Generator"),accum$963)),((accum$967=({})),((accum$967["::egclass"]=true),accum$967))));Generator$367;(exports["evaluator"]=evaluator$364);(exports["Source"]=Source$347);(exports["Location"]=Location$348);(exports["highlight_locations"]=highlight_locations$349);(exports["tokenize"]=tokenize$351);(exports["parse"]=parse$353);(exports["Generator"]=Generator$367);(exports["generate"]=generate$366);(exports["version"]=version$363);

}).call(this,typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./expand":9,"./lex":10,"./location":11,"./opt":12,"./parse":13,"./stdenv":16,"./translate-js":17,"module":20,"path":22,"vm":23}],9:[function(require,module,exports){
var $1634=function(type$1637){var f$1641;(f$1641=type$1637["::check"]);if((f$1641===(void 0))){return function(value$1647){return (value$1647 instanceof type$1637);};}else{return function(value$1651){return f$1641.call(type$1637,value$1651);};}};
var $1653=(function(o,m){if(typeof(m)==='string'||typeof(m)==='number'){return o[m];}else{return o['::send'](m);}});
var $1654=function(dest$1657,values$1658){var k$1663;(k$1663=null);$1661:for(k$1663 in values$1658){if(values$1658.hasOwnProperty(k$1663)){(dest$1657[k$1663]=values$1658[k$1663]);}}return dest$1657;};
var $1671=function($1673$1676){var ph$1682;(ph$1682=$1673$1676);var $1678$1688;($1678$1688=ph$1682);var bridge$1680$1693;var x$1697;(bridge$1680$1693=$1678$1688);if((((typeof(bridge$1680$1693)==="string")&&((x$1697=bridge$1680$1693),true))||((typeof(bridge$1680$1693)==="number")&&((x$1697=bridge$1680$1693),true)))){return ["value",x$1697];}else{var other$1708;(other$1708=$1678$1688);return other$1708["::serialize_ast"]();}};
var send$1408;(send$1408=function(obj$1415,$1412$1416){var ph$1422;var msg$1423;var t0$1425;(t0$1425=$1412$1416);(msg$1423=t0$1425);(ph$1422=t0$1425);var $1418$1434;($1418$1434=ph$1422);var bridge$1420$1439;(bridge$1420$1439=$1418$1434);if(((typeof(bridge$1420$1439)==="string")||(typeof(bridge$1420$1439)==="number"))){return obj$1415[msg$1423];}else{var other$1451;(other$1451=$1418$1434);return obj$1415["::send"](msg$1423);}});(Array[":::project"]=function($1457$1460){var ph$1465;var value$1466;var t0$1468;(t0$1468=$1457$1460);(value$1466=t0$1468);(ph$1465=t0$1468);var $1462$1477;($1462$1477=ph$1465);if($1634(Array)($1462$1477)){return [true,value$1466];}else{$1462$1477;return [true,[value$1466]];}});(Array.prototype["::check"]=function(value$1495){if((value$1495 instanceof Array)){var i$1501;(i$1501=0);$1498:for(;(i$1501<this.length);(i$1501++)){if(($1653(this,i$1501)!==$1653(value$1495,i$1501))){return false;}}return true;}else{return false;}});(Array.prototype["::clone"]=function(){return $1654(this.slice(0),this);});(Array.prototype[":::project"]=function(value$1520){if((value$1520 instanceof Array)){var i$1526;(i$1526=0);$1523:for(;(i$1526<this.length);(i$1526++)){if(($1653(this,i$1526)!==$1653(value$1520,i$1526))){return [true,[value$1520]];}}return [true,value$1520.slice(this.length)];}else{return [true,[value$1520]];}});(Array.prototype["::serialize_ast"]=function(){return ["array"].concat(this.map($1671));});(RegExp.prototype["::check"]=function($1544$1547){var ph$1552;(ph$1552=$1544$1547);var $1549$1558;($1549$1558=ph$1552);var value$1566;if((typeof($1549$1558)==="string")){(value$1566=$1549$1558);if(value$1566.match(this)){return true;}else{return false;}}else{var other$1571;(other$1571=$1549$1558);return false;}});(RegExp.prototype[":::project"]=function($1577$1580){var ph$1585;(ph$1585=$1577$1580);var $1582$1591;($1582$1591=ph$1585);var value$1599;if((typeof($1582$1591)==="string")){(value$1599=$1582$1591);var $1602$1607;($1602$1607=value$1599.match(this));var m$1615;if(($1602$1607===null)){(m$1615=$1602$1607);return [false,null];}else{var m$1620;(m$1620=$1602$1607);return [true,m$1620];}}else{var other$1624;(other$1624=$1582$1591);return [false,null];}});(Function.prototype["::send"]=function(args$1631){return this.apply(this,args$1631);});
var $4987=function(arr$4990){var results$4996;var l$4997;(results$4996=[]);(l$4997=arr$4990.length);var i$5006;(i$5006=0);$4995:for(;(i$5006<l$4997);(i$5006++)){results$4996.push([i$5006,$1653(arr$4990,i$5006)]);}return results$4996;};
var $4754=function(){var $4755$4761;($4755$4761=function(tags$4766){var it$0$4769;(it$0$4769=function(){if((!$1634($4755$4761)(this))){return Object.create($4755$4761.prototype);}else{return this;}}());(it$0$4769["tags"]=tags$4766);return it$0$4769;});($4755$4761.prototype["create"]=function(){var it$0$4789;var self$4790;(it$0$4789=this);(self$4790=this);var $4787$4799;($4787$4799=arguments);var t0$4804;var message$4808;var args$4809;(t0$4804=$4787$4799.length);if((t0$4804>=0)){(message$4808=function(){if((0>=t0$4804)){return "";}else{return $4787$4799[0];}}());(args$4809=Array.prototype.slice.call($4787$4799,1));var e$4822;(e$4822=Error(message$4808));(e$4822["::tags"]=it$0$4789.tags);(e$4822["args"]=args$4809);var temp$4838;(temp$4838=$4987(args$4809));var $length$4844;($length$4844=temp$4838.length);var $index$4850;($index$4850=0);$4823:for(;($index$4850<$length$4844);($index$4850++)){var m$4859;(m$4859=temp$4838[$index$4850]);var t0$4864;var t1$4865;var i$4869;var arg$4870;(t0$4864=m$4859);if(((t0$4864 instanceof Array)&&(((t1$4865=t0$4864.length)),(t1$4865===2)))){(i$4869=t0$4864[0]);(arg$4870=t0$4864[1]);(e$4822[i$4869]=arg$4870);}else{$4735(m$4859);}}(e$4822["length"]=args$4809.length);(e$4822["name"]=["E"].concat(it$0$4789.tags).join("."));return e$4822;}else{$4735($4787$4799);}});($4755$4761.prototype["::check"]=function(e$4900){var it$0$4904;var self$4905;(it$0$4904=this);(self$4905=this);var tags$4915;if(((!e$4900)||(!$1634(Error)(e$4900)))){return false;}(tags$4915=(e$4900["::tags"]||[]));var temp$4926;(temp$4926=it$0$4904.tags);var $length$4932;($length$4932=temp$4926.length);var $index$4938;($index$4938=0);$4916:for(;($index$4938<$length$4932);($index$4938++)){var m$4947;(m$4947=temp$4926[$index$4938]);var tag$4955;(tag$4955=m$4947);if((tags$4915.indexOf(tag$4955)===-1)){return false;}else{false;}}return true;});($4755$4761.prototype["::deconstruct"]=function(e$4964){var it$0$4968;var self$4969;(it$0$4968=this);(self$4969=this);return e$4964.args;});$1654($4755$4761,$1654(function(){var accum$4980;(accum$4980=({}));(accum$4980["::name"]="$4755");return accum$4980;}(),function(){var accum$4984;(accum$4984=({}));(accum$4984["::egclass"]=true);return accum$4984;}()));return $4755$4761;}();
var $4735=function(value$4738,url$4739,start$4740,end$4741){var err$4745;(err$4745=$4754(["match"]).create("Could not find a match for value",({"value":value$4738})));if(url$4739){(err$4745["location"]=["location",url$4739,start$4740,end$4741]);}throw err$4745;};
var $5013=function($5015$5018,key$5019){var ph$5027;(ph$5027=$5015$5018);var $5021$5033;($5021$5033=ph$5027);var bridge$5023$5038;(bridge$5023$5038=$5021$5033);if(((bridge$5023$5038===null)||(bridge$5023$5038===(void 0)))){return false;}else{var x$5050;if((typeof($5021$5033)==="string")){(x$5050=$5021$5033);return (key$5019 in String.prototype);}else{var x$5055;if((typeof($5021$5033)==="number")){(x$5055=$5021$5033);return (key$5019 in Number.prototype);}else{var x$5060;(x$5060=$5021$5033);return (key$5019 in x$5060);}}}};
var $5062=function(obj$5065){var results$5070;(results$5070=[]);var k$5075;(k$5075=null);$5069:for(k$5075 in obj$5065){if(Object.prototype.hasOwnProperty.call(obj$5065,k$5075)){results$5070.push([k$5075,$1653(obj$5065,k$5075)]);}}return results$5070;};
var $5079=function(type$5082){return function(value$5086){var f$5090;(f$5090=type$5082[":::project"]);if((f$5090===(void 0))){(f$5090=type$5082["::project"]);if((f$5090===(void 0))){return [true,type$5082(value$5086)];}else{var rval$5103;(rval$5103=false);try{(rval$5103=[true,f$5090(value$5086)]);}catch(excv$5114){var e$5120;(e$5120=excv$5114);(rval$5103=[false,null]);}return rval$5103;}}else{return f$5090.call(type$5082,value$5086);}};};var accum$2000;var accum$2004;var accum$2428;var accum$2432;var accum$4545;var accum$4549;var $1712$1753;var __lt____gt__$1754;var $1713$1755;var __lt____lt____colon__$1756;var util$1757;var classify$1758;var neighbours$1759;var GenSym$1760;var gensym$1761;var $1715$1762;var PatternParser$1763;var PatternProcessor$1764;var Scope$1765;var Env$1766;var track_location$1767;var Expander$1768;var mac1$1769;var __chk_ncache$1770;var __chk_scache$1771;var checker_db$1772;($1712$1753=require("./pp"));(__lt____gt__$1754=$1712$1753["<>"]);($1713$1755=require("./location"));(__lt____lt____colon__$1756=$1713$1755["<<:"]);(util$1757=require("./util"));(classify$1758=util$1757.classify);(neighbours$1759=util$1757.neighbours);(GenSym$1760=util$1757.GenSym);(gensym$1761=util$1757.gensym);($1715$1762=require("./pattern"));(PatternParser$1763=$1715$1762.PatternParser);(PatternProcessor$1764=$1715$1762.PatternProcessor);(Scope$1765=function(){var t0$1829;var $1820$1824;var it$0$1815;(it$0$1815=function(){if((!$1634(Scope$1765)(this))){return Object.create(Scope$1765.prototype);}else{return this;}}());($1820$1824=arguments);(t0$1829=$1820$1824.length);if(((t0$1829>=0)&&(t0$1829<=3))){(it$0$1815["parent"]=function(){if((0>=t0$1829)){return null;}else{return $1820$1824[0];}}());(it$0$1815["name"]=function(){if((1>=t0$1829)){return gensym$1761("scope");}else{return $1820$1824[1];}}());(it$0$1815["expander"]=function(){if((2>=t0$1829)){return it$0$1815.parent.expander;}else{return $1820$1824[2];}}());(it$0$1815["options"]=({}));}else{$4735($1820$1824);}return it$0$1815;});(Scope$1765.prototype["getopt"]=function(opt$1850){var otherwise$1887;var $1867$1876;var $1863$1870;var it$0$1854;var self$1855;(it$0$1854=this);(self$1855=this);($1863$1870=null);$1863$1870;if(Object.prototype.hasOwnProperty.call(it$0$1854.options,opt$1850)){return $1653(it$0$1854.options,opt$1850);}else{if((it$0$1854.parent===null)){return (void 0);}else{(otherwise$1887=$1863$1870);return it$0$1854.parent.getopt(opt$1850);}}});(Scope$1765.prototype["setopt"]=function(opt$1893,value$1894){var it$0$1898;var self$1899;(it$0$1898=this);(self$1899=this);(it$0$1898.options[opt$1893]=value$1894);});(Scope$1765.prototype["gensym"]=function(){var it$0$1918;var self$1919;(it$0$1918=this);(self$1919=this);return it$0$1918.expander.gensym();});(Scope$1765.prototype["step"]=function(context$1931,expr$1932){var it$0$1936;var self$1937;(it$0$1936=this);(self$1937=this);return it$0$1936.expander.step(context$1931,it$0$1936,expr$1932);});(Scope$1765.prototype["step_all"]=function(context$1949,exprs$1950){var it$0$1954;var self$1955;(it$0$1954=this);(self$1955=this);return it$0$1954.expander.step_all(context$1949,it$0$1954,exprs$1950);});(Scope$1765.prototype["expand"]=function(context$1967,expr$1968){var it$0$1972;var self$1973;(it$0$1972=this);(self$1973=this);return it$0$1972.expander.expand(context$1967,it$0$1972,expr$1968);});(Scope$1765.prototype["toString"]=function(){var it$0$1988;var self$1989;(it$0$1988=this);(self$1989=this);return (("Scope{"+it$0$1988.name)+"}");});$1654(Scope$1765,$1654(((accum$2000=({})),((accum$2000["::name"]="Scope"),accum$2000)),((accum$2004=({})),((accum$2004["::egclass"]=true),accum$2004))));Scope$1765;(Env$1766=function(){var it$0$2013;(it$0$2013=function(){if((!$1634(Env$1766)(this))){return Object.create(Env$1766.prototype);}else{return this;}}());(it$0$2013["scopes"]=({}));return it$0$2013;});(Env$1766.prototype["list_bindings"]=function(origin$2028){var values$2044;var scope$2045;var it$0$2032;var self$2033;(it$0$2032=this);(self$2033=this);(values$2044=({}));(scope$2045=origin$2028);$2052:while(scope$2045){$1654(values$2044,$1653(it$0$2032.scopes,scope$2045.name));(scope$2045=scope$2045.parent);}return values$2044;});(Env$1766.prototype["resolve"]=function(scope$2064,name$2065){var scope_data$2080;var it$0$2069;var self$2070;(it$0$2069=this);(self$2070=this);if((scope$2064===null)){return (void 0);}(scope_data$2080=$1653(it$0$2069.scopes,scope$2064.name));if((scope_data$2080&&Object.prototype.hasOwnProperty.call(scope_data$2080,name$2065))){return $1653(scope_data$2080,name$2065);}else{return it$0$2069.resolve(scope$2064.parent,name$2065);}});(Env$1766.prototype["bind"]=function(scope$2089,name$2090,value$2091){var it$0$2095;var self$2096;(it$0$2095=this);(self$2096=this);if((!$1653(it$0$2095.scopes,scope$2089.name))){(it$0$2095.scopes[scope$2089.name]=({}));}($1653(it$0$2095.scopes,scope$2089.name)[name$2090]=value$2091);});(Env$1766.prototype["mark"]=function(expr$2118){var x$2185;var x$2191;var bridge$2137$2177;var x$2197;var bridge$2136$2170;var x$2203;var bridge$2135$2163;var x$2209;var $index$2244;var $length$2238;var temp$2232;var other$2265;var type$2216;var args$2217;var e$2152;var bridge$2134$2147;var t0$2148;var $2131$2142;var it$0$2122;var self$2123;(it$0$2122=this);(self$2123=this);($2131$2142=expr$2118);if($5013($2131$2142,"env")){(e$2152=$2131$2142.env);return expr$2118;}else{(bridge$2134$2147=$2131$2142);if(((((bridge$2135$2163=bridge$2134$2147)),((((bridge$2136$2170=bridge$2135$2163)),((((bridge$2137$2177=bridge$2136$2170)),((((x$2185=bridge$2137$2177)),((x$2185 instanceof Array)&&(x$2185[0]==="symbol")))||(((x$2191=bridge$2137$2177)),((x$2191 instanceof Array)&&(x$2191[0]==="value")))))||(((x$2197=bridge$2136$2170)),((x$2197 instanceof Array)&&(x$2197[0]==="variable")))))||(((x$2203=bridge$2135$2163)),((x$2203 instanceof Array)&&(x$2203[0]==="macro")))))||(((x$2209=bridge$2134$2147)),((x$2209 instanceof Array)&&(x$2209[0]==="void"))))){return $1654(expr$2118,({"env":it$0$2122}));}else{if((($2131$2142 instanceof Array)&&(((t0$2148=$2131$2142.length)),(t0$2148>=1)))){(type$2216=$2131$2142[0]);(args$2217=Array.prototype.slice.call($2131$2142,1));(temp$2232=args$2217);($length$2238=temp$2232.length);($index$2244=0);$2226:for(;($index$2244<$length$2238);($index$2244++)){var arg$2261;var m$2253;(m$2253=temp$2232[$index$2244]);(arg$2261=m$2253);it$0$2122.mark(arg$2261);}return $1654(expr$2118,({"env":it$0$2122}));}else{(other$2265=$2131$2142);return $1654(expr$2118,({"env":it$0$2122}));}}}});(Env$1766.prototype["fork"]=function(){var $index$2307;var $length$2301;var temp$2295;var e$2285;var it$0$2274;var self$2275;(it$0$2274=this);(self$2275=this);(e$2285=Env$1766());(temp$2295=$5062(it$0$2274.scopes));($length$2301=temp$2295.length);($index$2307=0);$2286:for(;($index$2307<$length$2301);($index$2307++)){var $index$2362;var $length$2356;var temp$2350;var acc$2344;var scope$2326;var bindings$2327;var t0$2321;var t1$2322;var m$2316;(m$2316=temp$2295[$index$2307]);(t0$2321=m$2316);if(((t0$2321 instanceof Array)&&(((t1$2322=t0$2321.length)),(t1$2322===2)))){(scope$2326=t0$2321[0]);(bindings$2327=t0$2321[1]);(acc$2344=[]);(temp$2350=$5062(bindings$2327));($length$2356=temp$2350.length);($index$2362=0);$2339:for(;($index$2362<$length$2356);($index$2362++)){var k$2381;var v$2382;var t0$2376;var t1$2377;var m$2371;(m$2371=temp$2350[$index$2362]);(t0$2376=m$2371);if(((t0$2376 instanceof Array)&&(((t1$2377=t0$2376.length)),(t1$2377===2)))){(k$2381=t0$2376[0]);(v$2382=t0$2376[1]);acc$2344.push((function(){if((!$1653(e$2285.scopes,scope$2326))){(e$2285.scopes[scope$2326]=({}));}}(),(($1653(e$2285.scopes,scope$2326)[k$2381]=v$2382))));}else{$4735(m$2371,"/home/olivier/git/earl-grey/src/expand.eg",2269,2426);}}acc$2344;}else{$4735(m$2316,"/home/olivier/git/earl-grey/src/expand.eg",2229,2426);}}return e$2285;});(Env$1766.prototype["toString"]=function(){var it$0$2416;var self$2417;(it$0$2416=this);(self$2417=this);return "Env{...}";});$1654(Env$1766,$1654(((accum$2428=({})),((accum$2428["::name"]="Env"),accum$2428)),((accum$2432=({})),((accum$2432["::egclass"]=true),accum$2432))));Env$1766;(track_location$1767=function(f$2439){var f2$2443;(f2$2443=function(context$2448,scope$2449,expr$2450){var rval$2464;var other$2510;var v$2500;var t0$2496;var $2454$2491;var rval$2457;(rval$2457=(((rval$2464=false)),(function(){try{(rval$2464=f$2439(context$2448,scope$2449,expr$2450));}catch(excv$2475){var e$2481;(e$2481=excv$2475);(rval$2464=(__lt____lt____colon__$1756(e$2481,expr$2450),function(){throw e$2481;}()));}}(),rval$2464)));($2454$2491=rval$2457);if((($2454$2491 instanceof Array)&&(((t0$2496=$2454$2491.length)),((t0$2496===2)&&($2454$2491[0]==="bounce"))))){(v$2500=$2454$2491[1]);return f2$2443(context$2448,scope$2449,__lt____lt____colon__$1756(v$2500,expr$2450));}else{(other$2510=$2454$2491);return __lt____lt____colon__$1756(other$2510,expr$2450);}});return f2$2443;});(Expander$1768=function(env_factory$2518,generic_nodes$2519){var it$0$2522;(it$0$2522=function(){if((!$1634(Expander$1768)(this))){return Object.create(Expander$1768.prototype);}else{return this;}}());(it$0$2522["gensym"]=gensym$1761);(it$0$2522["mkenv"]=env_factory$2518);(it$0$2522["generic_nodes"]=generic_nodes$2519);return it$0$2522;});(Expander$1768.prototype["run_macro"]=function(m$2546,context$2547,scope$2548,form$2549,arg$2550){var rval$2573;var rval$2565;var it$0$2554;var self$2555;(it$0$2554=this);(self$2555=this);(rval$2565=(((rval$2573=false)),(function(){try{(rval$2573=m$2546(context$2547,scope$2548,form$2549,arg$2550));}catch(excv$2584){var msg$2641;var msg$2763;var find$2652;var err$2653;var other$2647;var $2624$2629;var e$2621;var e$2771;var value$2594;var t0$2587;var t1$2588;var t2$2589;var t3$2590;(t0$2587=excv$2584);if(($1634($4754(["match"]))(t0$2587)&&($5013(t0$2587,"args")&&(((t1$2588=t0$2587.args)),((t1$2588 instanceof Array)&&(((t2$2589=t1$2588.length)),((t2$2589===1)&&(((t3$2590=t1$2588[0])),$5013(t3$2590,"value"))))))))){(value$2594=t3$2590.value);(rval$2573=(((e$2621=((($2624$2629=value$2594)),function(){if(($2624$2629===context$2547)){(msg$2641="The macro cannot be found in this context.");return $4754(["syntax","context"]).create(msg$2641,({"context":context$2547,"form":form$2549}));}else{(other$2647=$2624$2629);(find$2652=function($2657$2660){var t0$2669;var msg$2691;var $index$2725;var $length$2719;var temp$2713;var other$2755;var type$2697;var xs$2698;var t0$2683;var $2662$2678;var ph$2666;var arg$2667;(t0$2669=$2657$2660);(arg$2667=t0$2669);(ph$2666=t0$2669);($2662$2678=ph$2666);if(($2662$2678===value$2594)){(msg$2691="The macro expected something different.");return $4754(["syntax","argument"]).create(msg$2691,({"context":context$2547,"argument":arg$2667,"form":form$2549}));}else{if((($2662$2678 instanceof Array)&&(((t0$2683=$2662$2678.length)),(t0$2683>=1)))){(type$2697=$2662$2678[0]);(xs$2698=Array.prototype.slice.call($2662$2678,1));(temp$2713=xs$2698);($length$2719=temp$2713.length);($index$2725=0);$2707:for(;($index$2725<$length$2719);($index$2725++)){var x$2743;var t0$2739;var m$2734;(m$2734=temp$2713[$index$2725]);(t0$2739=$5079(find$2652)(m$2734));if(t0$2739[0]){(x$2743=t0$2739[1]);if(x$2743){return x$2743;}}else{$4735(m$2734,"/home/olivier/git/earl-grey/src/expand.eg",3685,3770);}}return false;}else{(other$2755=$2662$2678);return false;}}});(err$2653=find$2652(arg$2550));if(err$2653){return err$2653;}else{(msg$2763="The macro expected something different (could not locate error in the source).");return $4754(["syntax","failure"]).create(msg$2763,({"form":form$2549,"value":value$2594}));}}}()))),function(){throw e$2621;}()));}else{(e$2771=excv$2584);(rval$2573=function(){throw e$2771;}());}}}(),rval$2573)));return it$0$2554.mkenv().mark(rval$2565);});(Expander$1768.prototype["step"]=function(context$2782,scope$2783,expr$2784){var helper$2799;var it$0$2788;var self$2789;(it$0$2788=this);(self$2789=this);(helper$2799=track_location$1767(function(context$2806,scope$2807,$2803$2808){var t0$2822;var other$2877;var env$2872;var $2859$2864;var other$2922;var t0$2909;var $2899$2904;var other$2926;var m$2891;var t0$2887;var $2853$2882;var env$2856;var other$2956;var t0$2943;var $2933$2938;var other$2988;var m$2978;var t0$2974;var $2964$2969;var other$2997;var x$2992;var f$2960;var arg$2961;var m$2930;var s$2843;var $2816$2838;var $2817$2839;var $2818$2840;var t0$2836;var $2810$2831;var ph$2819;var expr$2820;(t0$2822=$2803$2808);(expr$2820=t0$2822);(ph$2819=t0$2822);($2810$2831=ph$2819);if((($2816$2838=($2810$2831 instanceof Array))&&(((t0$2836=$2810$2831.length)),(($2818$2840=(t0$2836===2))&&($2810$2831[0]==="symbol"))))){(s$2843=$2810$2831[1]);(env$2856=((($2859$2864=expr$2820)),function(){if($5013($2859$2864,"env")){(env$2872=$2859$2864.env);return expr$2820.env;}else{(other$2877=$2859$2864);throw $4754(["syntax","no_env"]).create("No environment was found to resolve",({"symbol":expr$2820}));}}()));($2853$2882=env$2856.resolve(scope$2807,s$2843));if((($2853$2882 instanceof Array)&&(((t0$2887=$2853$2882.length)),((t0$2887===2)&&($2853$2882[0]==="macro"))))){(m$2891=$2853$2882[1]);($2899$2904=context$2806);if((($2899$2904 instanceof Array)&&(((t0$2909=$2899$2904.length)),((t0$2909===2)&&(($2899$2904[0]==="expr")&&($2899$2904[1]==="head")))))){return ["macro",m$2891];}else{(other$2922=$2899$2904);return ["bounce",it$0$2788.run_macro(m$2891,context$2806,scope$2807,expr$2820,__lt____lt____colon__$1756(["void"],expr$2820))];}}else{(other$2926=$2853$2882);return expr$2820;}}else{if(($2818$2840&&($2810$2831[0]==="macro"))){(m$2930=$2810$2831[1]);($2933$2938=context$2806);if((($2933$2938 instanceof Array)&&(((t0$2943=$2933$2938.length)),((t0$2943===2)&&(($2933$2938[0]==="expr")&&($2933$2938[1]==="head")))))){return expr$2820;}else{(other$2956=$2933$2938);return ["bounce",it$0$2788.run_macro(m$2930,context$2806,scope$2807,expr$2820,__lt____lt____colon__$1756(["void"],expr$2820))];}}else{if(($2816$2838&&((t0$2836===3)&&($2810$2831[0]==="send")))){(f$2960=$2810$2831[1]);(arg$2961=$2810$2831[2]);($2964$2969=helper$2799(["expr","head"],scope$2807,f$2960));if((($2964$2969 instanceof Array)&&(((t0$2974=$2964$2969.length)),((t0$2974===2)&&($2964$2969[0]==="macro"))))){(m$2978=$2964$2969[1]);return ["bounce",it$0$2788.run_macro(m$2978,context$2806,scope$2807,expr$2820,arg$2961)];}else{(other$2988=$2964$2969);return expr$2820;}}else{if(($2816$2838&&((t0$2836===2)&&($2810$2831[0]==="nostep")))){(x$2992=$2810$2831[1]);return x$2992;}else{(other$2997=$2810$2831);return expr$2820;}}}}}));return helper$2799(context$2782,scope$2783,expr$2784);});(Expander$1768.prototype["step_all"]=function(context$3006,scope$3007,$3003$3008){var t0$3023;var t1$3024;var pre$3041;var bulk$3042;var post$3043;var stmts$3021;var it$0$3012;var self$3013;(it$0$3012=this);(self$3013=this);(t0$3023=$3003$3008);if(((t0$3023 instanceof Array)&&(((t1$3024=t0$3023.length)),(t1$3024>=0)))){(stmts$3021=Array.prototype.slice.call(t0$3023,0));}else{$4735($3003$3008);}(pre$3041=[]);(bulk$3042=[]);(post$3043=[]);$3053:while(stmts$3021.length){var $index$3144;var $length$3138;var temp$3132;var acc$3126;var e$3115;var x$3167;var m$3109;var stmt$3104;var stmt$3099;var prepend$3085;var $3064$3080;var $3065$3081;var $3066$3082;var t0$3078;var $3058$3073;var current$3067;(current$3067=stmts$3021.shift());($3058$3073=it$0$3012.step(context$3006,scope$3007,current$3067));if((($3064$3080=($3058$3073 instanceof Array))&&(((t0$3078=$3058$3073.length)),((t0$3078>=1)&&($3058$3073[0]==="splice"))))){(prepend$3085=Array.prototype.slice.call($3058$3073,1));(stmts$3021=prepend$3085.concat(stmts$3021));}else{if(($3064$3080&&(($3066$3082=(t0$3078===2))&&($3058$3073[0]==="float")))){(stmt$3099=$3058$3073[1]);(pre$3041=pre$3041.concat(it$0$3012.step_all(context$3006,scope$3007,[stmt$3099])));}else{if(($3066$3082&&($3058$3073[0]==="sink"))){(stmt$3104=$3058$3073[1]);(post$3043=post$3043.concat(it$0$3012.step_all(context$3006,scope$3007,[stmt$3104])));}else{if(($3066$3082&&($3058$3073[0]==="restmacro"))){(m$3109=$3058$3073[1]);(e$3115=it$0$3012.mkenv());(stmts$3021=(((acc$3126=[])),(((temp$3132=m$3109(stmts$3021))),((($length$3138=temp$3132.length)),((($index$3144=0)),function(){$3121:for(;($index$3144<$length$3138);($index$3144++)){var stmt$3161;var m$3153;(m$3153=temp$3132[$index$3144]);(stmt$3161=m$3153);acc$3126.push(e$3115.mark(stmt$3161));}}()))),acc$3126));}else{(x$3167=$3058$3073);bulk$3042.push(x$3167);}}}}}return pre$3041.concat(bulk$3042).concat(post$3043);});(Expander$1768.prototype["expand"]=function(context$3173,scope$3174,expr$3175){var helper$3190;var it$0$3179;var self$3180;(it$0$3179=this);(self$3180=this);(helper$3190=track_location$1767(function(context$3195,scope$3196,expr$3197){var t0$3260;var other$3282;var $3255$3270;var env$3258;var $index$3335;var $length$3329;var temp$3323;var acc$3317;var newargs$3309;var $index$3389;var $length$3383;var temp$3377;var acc$3371;var newargs$3363;var t0$3453;var newscope$3447;var env$3448;var $index$3537;var $length$3531;var temp$3525;var acc$3519;var $index$3749;var $length$3743;var temp$3737;var acc$3731;var t0$3498;var newscope$3482;var stepscope$3483;var changes$3484;var newargs$3485;var vars$3486;var exp$3487;var $index$4172;var $length$4166;var temp$4160;var other$4276;var t0$4254;var $4243$4249;var is_obj$4051;var obj$4052;var arr$4053;var arr_parts$4054;var obj_parts$4055;var new_arr_part$4056;var new_obj_part$4057;var r$4058;var x$4314;var msg$4321;var otherwise$4337;var m$4327;var t0$4307;var $4292$4302;var t$4296;var $index$4381;var $length$4375;var temp$4369;var acc$4363;var newscope$4351;var s$4460;var newscope$4473;var name$4451;var t0$4447;var $index$4517;var $length$4511;var temp$4505;var acc$4499;var other$4539;var type$4488;var args$4489;var tag$4477;var body$4478;var x$4442;var $3217$4443;var bindings$4345;var body$4346;var target$4286;var value$4287;var args$4039;var args$3473;var args$3468;var args$3463;var variable$3427;var s$3428;var value$3429;var body$3430;var args$3358;var args$3304;var f$3298;var arg$3299;var s$3245;var $3223$3240;var $3224$3241;var $3225$3242;var t0$3236;var t1$3237;var t2$3238;var $3201$3231;(expr$3197=it$0$3179.step(context$3195,scope$3196,expr$3197));($3201$3231=expr$3197);if((($3223$3240=($3201$3231 instanceof Array))&&(((t0$3236=$3201$3231.length)),(($3225$3242=(t0$3236===2))&&($3201$3231[0]==="symbol"))))){(s$3245=$3201$3231[1]);(t0$3260=expr$3197);if($5013(t0$3260,"env")){(env$3258=t0$3260.env);}else{$4735(expr$3197,"/home/olivier/git/earl-grey/src/expand.eg",8047,8051);}($3255$3270=env$3258.resolve(scope$3196,s$3245));if(($3255$3270===(void 0))){throw $4754(["syntax","undeclared"]).create(("Undeclared variable: "+s$3245),({"node":expr$3197}));}else{(other$3282=$3255$3270);return ["bounce",other$3282];}}else{if(($3225$3242&&($3201$3231[0]==="value"))){$3201$3231[1];return expr$3197;}else{if(($3225$3242&&($3201$3231[0]==="variable"))){$3201$3231[1];return expr$3197;}else{if(($3223$3240&&((t0$3236===1)&&($3201$3231[0]==="void")))){return expr$3197;}else{if(($3223$3240&&((t0$3236===3)&&($3201$3231[0]==="send")))){(f$3298=$3201$3231[1]);(arg$3299=$3201$3231[2]);return ["send",helper$3190(["expr","head"],scope$3196,f$3298),helper$3190(["expr","tail"],scope$3196,arg$3299)];}else{if(($3223$3240&&(($3225$3242=(t0$3236>=1))&&($3201$3231[0]==="array")))){(args$3304=Array.prototype.slice.call($3201$3231,1));(newargs$3309=(((acc$3317=[])),(((temp$3323=it$0$3179.step_all(["expr","array"],scope$3196,args$3304))),((($length$3329=temp$3323.length)),((($index$3335=0)),function(){$3312:for(;($index$3335<$length$3329);($index$3335++)){var arg$3352;var m$3344;(m$3344=temp$3323[$index$3335]);(arg$3352=m$3344);acc$3317.push(helper$3190(["expr","expr"],scope$3196,arg$3352));}}()))),acc$3317));return ["array"].concat(newargs$3309);}else{if(($3225$3242&&($3201$3231[0]==="object"))){(args$3358=Array.prototype.slice.call($3201$3231,1));(newargs$3363=(((acc$3371=[])),(((temp$3377=it$0$3179.step_all(["expr","object"],scope$3196,args$3358))),((($length$3383=temp$3377.length)),((($index$3389=0)),function(){$3366:for(;($index$3389<$length$3383);($index$3389++)){var k$3408;var v$3409;var t0$3403;var t1$3404;var m$3398;(m$3398=temp$3377[$index$3389]);(t0$3403=m$3398);if(((t0$3403 instanceof Array)&&(((t1$3404=t0$3403.length)),((t1$3404===3)&&(t0$3403[0]==="array"))))){(k$3408=t0$3403[1]);(v$3409=t0$3403[2]);acc$3371.push(["array",helper$3190(["expr","expr"],scope$3196,k$3408),helper$3190(["expr","expr"],scope$3196,v$3409)]);}else{$4735(m$3398,"/home/olivier/git/earl-grey/src/expand.eg",8890,9079);}}}()))),acc$3371));return ["object"].concat(newargs$3363);}else{if(($3223$3240&&((t0$3236===4)&&(($3201$3231[0]==="bind")&&(((t1$3237=$3201$3231[1])),((variable$3427=t1$3237),((t1$3237 instanceof Array)&&(((t2$3238=t1$3237.length)),((t2$3238===2)&&(t1$3237[0]==="symbol")))))))))){(s$3428=t1$3237[1]);(value$3429=$3201$3231[2]);(body$3430=$3201$3231[3]);(newscope$3447=Scope$1765(scope$3196));(t0$3453=variable$3427);if($5013(t0$3453,"env")){(env$3448=t0$3453.env);}else{$4735(variable$3427,"/home/olivier/git/earl-grey/src/expand.eg",9222,9230);}env$3448.bind(newscope$3447,s$3428,value$3429);return helper$3190(context$3195,newscope$3447,body$3430);}else{if(($3223$3240&&(($3225$3242=(t0$3236>=1))&&($3201$3231[0]==="splice")))){(args$3463=Array.prototype.slice.call($3201$3231,1));return ["bounce",$1654(["multi"].concat(args$3463),({"override_scope":true}))];}else{if(($3225$3242&&($3201$3231[0]==="interactive"))){(args$3468=Array.prototype.slice.call($3201$3231,1));return ["bounce",$1654(["multi"].concat(args$3468),({"override_scope":true,"all_mutable":true}))];}else{if(($3225$3242&&($3201$3231[0]==="multi"))){(args$3473=Array.prototype.slice.call($3201$3231,1));(newscope$3482=function(){if(expr$3197.override_scope){return scope$3196;}else{return Scope$1765(scope$3196);}}());(stepscope$3483=function(){if(expr$3197.nonrecursive){return scope$3196;}else{return newscope$3482;}}());(changes$3484=false);(t0$3498=classify$1758("newargs","vars",(((acc$3519=[])),(((temp$3525=it$0$3179.step_all(["expr","multi"],stepscope$3483,args$3473))),((($length$3531=temp$3525.length)),((($index$3537=0)),function(){$3503:for(;($index$3537<$length$3531);($index$3537++)){var t0$3603;var env$3601;var t0$3637;var v$3648;var env$3635;var t0$3695;var env$3693;var other$3708;var s$3675;var variable$3676;var v$3657;var value$3658;var variable$3616;var s$3617;var value$3618;var variable$3581;var s$3582;var value$3583;var opt$3564;var value$3565;var $3511$3556;var $3512$3557;var $3513$3558;var $3514$3559;var $3515$3560;var $3516$3561;var t0$3551;var t1$3552;var t2$3553;var t3$3554;var m$3546;(m$3546=temp$3525[$index$3537]);(t0$3551=m$3546);if((($3512$3557=(t0$3551 instanceof Array))&&(((t1$3552=t0$3551.length)),(($3514$3559=(t1$3552===3))&&(t0$3551[0]==="option"))))){(opt$3564=t0$3551[1]);(value$3565=t0$3551[2]);acc$3519.push((newscope$3482.setopt(opt$3564,value$3565),["ignore"]));}else{if(($3514$3559&&((t0$3551[0]==="declare_raw")&&(((t2$3553=t0$3551[1])),((variable$3581=t2$3553),((t2$3553 instanceof Array)&&(((t3$3554=t2$3553.length)),((t3$3554===2)&&(t2$3553[0]==="symbol"))))))))){(s$3582=t2$3553[1]);(value$3583=t0$3551[2]);acc$3519.push(((((t0$3603=variable$3581)),function(){if($5013(t0$3603,"env")){(env$3601=t0$3603.env);}else{return $4735(variable$3581,"/home/olivier/git/earl-grey/src/expand.eg",10176,10184);}}()),env$3601.bind(newscope$3482,s$3582,value$3583),((changes$3484=true)),["ignore"]));}else{if(($3512$3557&&(($3514$3559=((t1$3552>=2)&&(t1$3552<=3)))&&(($3515$3560=(t0$3551[0]==="declare"))&&(((t2$3553=t0$3551[1])),((variable$3616=t2$3553),((t2$3553 instanceof Array)&&(((t3$3554=t2$3553.length)),((t3$3554===2)&&(t2$3553[0]==="symbol")))))))))){(s$3617=t2$3553[1]);(value$3618=function(){if((2>=t1$3552)){return null;}else{return t0$3551[2];}}());acc$3519.push(((((t0$3637=variable$3616)),function(){if($5013(t0$3637,"env")){(env$3635=t0$3637.env);}else{return $4735(variable$3616,"/home/olivier/git/earl-grey/src/expand.eg",10424,10432);}}()),function(){if((variable$3616.use_previous&&env$3635.resolve(newscope$3482,s$3617))){return ["splice"];}else{(v$3648=__lt____lt____colon__$1756(["variable",it$0$3179.gensym(s$3617)],variable$3616));$1654(v$3648,({"mutable":(expr$3197.all_mutable||variable$3616.mutable)}));env$3635.bind(newscope$3482,s$3617,v$3648);(changes$3484=true);if(value$3618){return ["splice",["newargs",["assign",v$3648,value$3618]],["vars",v$3648]];}else{return ["vars",v$3648];}}}()));}else{if(($3515$3560&&((v$3657=t2$3553),((t2$3553 instanceof Array)&&(((t3$3554=t2$3553.length)),((t3$3554===2)&&(t2$3553[0]==="variable"))))))){t2$3553[1];(value$3658=function(){if((2>=t1$3552)){return null;}else{return t0$3551[2];}}());acc$3519.push((((changes$3484=true)),function(){if(value$3658){return ["splice",["newargs",["assign",v$3657,value$3658]],["vars",v$3657]];}else{return ["vars",v$3657];}}()));}else{if(($3512$3557&&((t1$3552===2)&&((t0$3551[0]==="undeclare")&&(((t2$3553=t0$3551[1])),((t2$3553 instanceof Array)&&(((t3$3554=t2$3553.length)),((t3$3554===2)&&(t2$3553[0]==="symbol"))))))))){(s$3675=t2$3553[1]);(variable$3676=t2$3553);acc$3519.push(((((t0$3695=variable$3676)),function(){if($5013(t0$3695,"env")){(env$3693=t0$3695.env);}else{return $4735(variable$3676,"/home/olivier/git/earl-grey/src/expand.eg",11696,11704);}}()),env$3693.bind(newscope$3482,s$3675,(void 0)),((changes$3484=true)),["ignore"]));}else{(other$3708=m$3546);acc$3519.push(["newargs",other$3708]);}}}}}}}()))),acc$3519)));if(($5013(t0$3498,"newargs")&&((newargs$3485=t0$3498.newargs),$5013(t0$3498,"vars")))){(vars$3486=t0$3498.vars);}else{$4735(classify$1758("newargs","vars",(((acc$3731=[])),(((temp$3737=it$0$3179.step_all(["expr","multi"],stepscope$3483,args$3473))),((($length$3743=temp$3737.length)),((($index$3749=0)),function(){$3715:for(;($index$3749<$length$3743);($index$3749++)){var t0$3815;var env$3813;var t0$3849;var v$3860;var env$3847;var t0$3907;var env$3905;var other$3920;var s$3887;var variable$3888;var v$3869;var value$3870;var variable$3828;var s$3829;var value$3830;var variable$3793;var s$3794;var value$3795;var opt$3776;var value$3777;var $3723$3768;var $3724$3769;var $3725$3770;var $3726$3771;var $3727$3772;var $3728$3773;var t0$3763;var t1$3764;var t2$3765;var t3$3766;var m$3758;(m$3758=temp$3737[$index$3749]);(t0$3763=m$3758);if((($3724$3769=(t0$3763 instanceof Array))&&(((t1$3764=t0$3763.length)),(($3726$3771=(t1$3764===3))&&(t0$3763[0]==="option"))))){(opt$3776=t0$3763[1]);(value$3777=t0$3763[2]);acc$3731.push((newscope$3482.setopt(opt$3776,value$3777),["ignore"]));}else{if(($3726$3771&&((t0$3763[0]==="declare_raw")&&(((t2$3765=t0$3763[1])),((variable$3793=t2$3765),((t2$3765 instanceof Array)&&(((t3$3766=t2$3765.length)),((t3$3766===2)&&(t2$3765[0]==="symbol"))))))))){(s$3794=t2$3765[1]);(value$3795=t0$3763[2]);acc$3731.push(((((t0$3815=variable$3793)),function(){if($5013(t0$3815,"env")){(env$3813=t0$3815.env);}else{return $4735(variable$3793,"/home/olivier/git/earl-grey/src/expand.eg",10176,10184);}}()),env$3813.bind(newscope$3482,s$3794,value$3795),((changes$3484=true)),["ignore"]));}else{if(($3724$3769&&(($3726$3771=((t1$3764>=2)&&(t1$3764<=3)))&&(($3727$3772=(t0$3763[0]==="declare"))&&(((t2$3765=t0$3763[1])),((variable$3828=t2$3765),((t2$3765 instanceof Array)&&(((t3$3766=t2$3765.length)),((t3$3766===2)&&(t2$3765[0]==="symbol")))))))))){(s$3829=t2$3765[1]);(value$3830=function(){if((2>=t1$3764)){return null;}else{return t0$3763[2];}}());acc$3731.push(((((t0$3849=variable$3828)),function(){if($5013(t0$3849,"env")){(env$3847=t0$3849.env);}else{return $4735(variable$3828,"/home/olivier/git/earl-grey/src/expand.eg",10424,10432);}}()),function(){if((variable$3828.use_previous&&env$3847.resolve(newscope$3482,s$3829))){return ["splice"];}else{(v$3860=__lt____lt____colon__$1756(["variable",it$0$3179.gensym(s$3829)],variable$3828));$1654(v$3860,({"mutable":(expr$3197.all_mutable||variable$3828.mutable)}));env$3847.bind(newscope$3482,s$3829,v$3860);(changes$3484=true);if(value$3830){return ["splice",["newargs",["assign",v$3860,value$3830]],["vars",v$3860]];}else{return ["vars",v$3860];}}}()));}else{if(($3727$3772&&((v$3869=t2$3765),((t2$3765 instanceof Array)&&(((t3$3766=t2$3765.length)),((t3$3766===2)&&(t2$3765[0]==="variable"))))))){t2$3765[1];(value$3870=function(){if((2>=t1$3764)){return null;}else{return t0$3763[2];}}());acc$3731.push((((changes$3484=true)),function(){if(value$3870){return ["splice",["newargs",["assign",v$3869,value$3870]],["vars",v$3869]];}else{return ["vars",v$3869];}}()));}else{if(($3724$3769&&((t1$3764===2)&&((t0$3763[0]==="undeclare")&&(((t2$3765=t0$3763[1])),((t2$3765 instanceof Array)&&(((t3$3766=t2$3765.length)),((t3$3766===2)&&(t2$3765[0]==="symbol"))))))))){(s$3887=t2$3765[1]);(variable$3888=t2$3765);acc$3731.push(((((t0$3907=variable$3888)),function(){if($5013(t0$3907,"env")){(env$3905=t0$3907.env);}else{return $4735(variable$3888,"/home/olivier/git/earl-grey/src/expand.eg",11696,11704);}}()),env$3905.bind(newscope$3482,s$3887,(void 0)),((changes$3484=true)),["ignore"]));}else{(other$3920=m$3758);acc$3731.push(["newargs",other$3920]);}}}}}}}()))),acc$3731)),"/home/olivier/git/earl-grey/src/expand.eg",9848,11926);}(exp$3487=function(s$3927){var $index$3960;var $length$3954;var temp$3948;var acc$3942;var $index$4016;var $length$4010;var temp$4004;var acc$3998;var stepped$3931;(stepped$3931=(((acc$3942=[])),(((temp$3948=$4987(newargs$3485))),((($length$3954=temp$3948.length)),((($index$3960=0)),function(){$3937:for(;($index$3960<$length$3954);($index$3960++)){var i$3979;var arg$3980;var t0$3974;var t1$3975;var m$3969;(m$3969=temp$3948[$index$3960]);(t0$3974=m$3969);if(((t0$3974 instanceof Array)&&(((t1$3975=t0$3974.length)),(t1$3975===2)))){(i$3979=t0$3974[0]);(arg$3980=t0$3974[1]);acc$3942.push(it$0$3179.step(["expr",function(){if((i$3979===(newargs$3485.length-1))){return "expr";}else{return "ignore";}}()],s$3927,arg$3980));}else{$4735(m$3969,"/home/olivier/git/earl-grey/src/expand.eg",12148,12325);}}}()))),acc$3942));(acc$3998=[]);(temp$4004=stepped$3931);($length$4010=temp$4004.length);($index$4016=0);$3932:for(;($index$4016<$length$4010);($index$4016++)){var arg$4033;var m$4025;(m$4025=temp$4004[$index$4016]);(arg$4033=m$4025);acc$3998.push(helper$3190(["expr","expr"],s$3927,arg$4033));}return acc$3998;});if(changes$3484){return ["scope",vars$3486,["multi"].concat(exp$3487(newscope$3482))];}else{return ["multi"].concat(exp$3487(scope$3196));}}else{if(($3225$3242&&($3201$3231[0]==="data"))){(args$4039=Array.prototype.slice.call($3201$3231,1));(is_obj$4051=false);(obj$4052=["object"]);(arr$4053=["array"]);(arr_parts$4054=[]);(obj_parts$4055=[]);(new_arr_part$4056=function(){var other$4113;var t0$4100;var $4090$4095;($4090$4095=arr$4053);if((($4090$4095 instanceof Array)&&(((t0$4100=$4090$4095.length)),((t0$4100===1)&&($4090$4095[0]==="array"))))){return false;}else{(other$4113=$4090$4095);arr_parts$4054.push(arr$4053);(arr$4053=["array"]);}});(new_obj_part$4057=function(){var other$4149;var t0$4136;var $4126$4131;($4126$4131=obj$4052);if((($4126$4131 instanceof Array)&&(((t0$4136=$4126$4131.length)),((t0$4136===1)&&($4126$4131[0]==="object"))))){return false;}else{(other$4149=$4126$4131);obj_parts$4055.push(obj$4052);(obj$4052=["object"]);}});(temp$4160=it$0$3179.step_all(["expr","data"],scope$3196,args$4039));($length$4166=temp$4160.length);($index$4172=0);$4059:for(;($index$4172<$length$4166);($index$4172++)){var other$4239;var expr$4229;var expr$4223;var k$4212;var v$4213;var $4066$4189;var $4067$4190;var $4068$4191;var $4069$4192;var t0$4186;var t1$4187;var m$4181;(m$4181=temp$4160[$index$4172]);(t0$4186=m$4181);if((($4067$4190=(t0$4186 instanceof Array))&&(((t1$4187=t0$4186.length)),((t1$4187===1)&&(t0$4186[0]==="assoc"))))){(is_obj$4051=true);}else{if(($4067$4190&&((t1$4187===3)&&(t0$4186[0]==="assoc")))){(k$4212=t0$4186[1]);(v$4213=t0$4186[2]);(is_obj$4051=true);obj$4052.push(["array",k$4212,v$4213]);}else{if(($4067$4190&&(($4069$4192=(t1$4187===2))&&(t0$4186[0]==="dynsplice")))){(expr$4223=t0$4186[1]);new_arr_part$4056();arr_parts$4054.push(expr$4223);}else{if(($4069$4192&&(t0$4186[0]==="objsplice"))){(expr$4229=t0$4186[1]);(is_obj$4051=true);new_obj_part$4057();obj_parts$4055.push(expr$4229);}else{(other$4239=m$4181);arr$4053.push(other$4239);}}}}}new_arr_part$4056();new_obj_part$4057();(r$4058=((($4243$4249=arr_parts$4054)),function(){if((($4243$4249 instanceof Array)&&(((t0$4254=$4243$4249.length)),((t0$4254===0)&&is_obj$4051)))){return util$1757.construct(obj_parts$4055,function(x$4267,rest$4268){return ["send",["symbol","&:"],["data",x$4267,rest$4268]];},["object"]);}else{$4243$4249;if(is_obj$4051){throw $4754(["syntax","array","object"]).create("Cannot mix array and object notations.");}else{(other$4276=$4243$4249);return util$1757.construct(arr_parts$4054.reverse(),function(x$4280,rest$4281){return ["send",["send",rest$4281,["send",["symbol","."],["data",["void"],["symbol","concat"]]]],["data",x$4280]];},["array"]);}}}()));return helper$3190(context$3195,scope$3196,it$0$3179.mkenv().mark(r$4058));}else{if(($3223$3240&&(($3225$3242=(t0$3236===3))&&($3201$3231[0]==="assign")))){(target$4286=$3201$3231[1]);(value$4287=$3201$3231[2]);(t$4296=helper$3190(["expr","expr"],scope$3196,target$4286));($4292$4302=t$4296);if(((((x$4314=$4292$4302)),((x$4314 instanceof Array)&&(x$4314[0]==="variable")))&&(((!t$4296.mutable)&&t$4296.assigned)&&(t$4296.assigned.group_id!==target$4286.group_id)))){(msg$4321=["Variable was declared as read-only. Declare it as","mutable at the origin with `var` (if you have access","to the declaration) or declare a new variable with","`let` or `var` or remove the original binding with","`delete`"].join(" "));throw $4754(["syntax"]).create(msg$4321,({"variable":target$4286,"loc":t$4296.assigned}));}else{if((($4292$4302 instanceof Array)&&(((t0$4307=$4292$4302.length)),((t0$4307===2)&&($4292$4302[0]==="macro"))))){(m$4327=$4292$4302[1]);["bounce",m$4327(["assign"],scope$3196,expr$3197,value$4287)];}else{(otherwise$4337=$4292$4302);(t$4296["assigned"]=target$4286);}}return ["assign",t$4296,helper$3190(["expr","expr"],scope$3196,value$4287)];}else{if(($3225$3242&&($3201$3231[0]==="lambda"))){(bindings$4345=$3201$3231[1]);(body$4346=$3201$3231[2]);(newscope$4351=Scope$1765(scope$3196));return ["lambda",(((acc$4363=[])),(((temp$4369=bindings$4345)),((($length$4375=temp$4369.length)),((($index$4381=0)),function(){$4355:for(;($index$4381<$length$4375);($index$4381++)){var v$4418;var x$4429;var other$4437;var v$4425;var b$4401;var env$4402;var $4360$4398;var t0$4395;var t1$4396;var m$4390;(m$4390=temp$4369[$index$4381]);(t0$4395=m$4390);if(((t0$4395 instanceof Array)&&(((t1$4396=t0$4395.length)),((t1$4396===2)&&((t0$4395[0]==="symbol")&&((b$4401=t0$4395[1]),$5013(t0$4395,"env"))))))){(env$4402=t0$4395.env);acc$4363.push((((v$4418=["variable",it$0$3179.gensym(b$4401)])),(env$4402.bind(newscope$4351,b$4401,v$4418),v$4418)));}else{if((((x$4429=t0$4395)),((x$4429 instanceof Array)&&(x$4429[0]==="variable")))){(v$4425=t0$4395);acc$4363.push(v$4425);}else{(other$4437=m$4390);acc$4363.push(function(){throw $4754(["syntax","lambda","binding"]).create("Not a valid binding.",({"node":other$4437}));}());}}}}()))),acc$4363),helper$3190(["expr","expr"],newscope$4351,body$4346)];}else{if(($3225$3242&&($3201$3231[0]==="use"))){($3217$4443=$3201$3231[1]);(x$4442=$3201$3231[2]);(t0$4447=$3217$4443);if((typeof(t0$4447)==="string")){(name$4451=t0$4447);(s$4460=scope$3196);$4464:while(s$4460){if((s$4460.name.slice(0,(name$4451.length+1))===(name$4451+"/"))){break $4464;}else{(s$4460=s$4460.parent);}}if(s$4460){return helper$3190(context$3195,s$4460,x$4442);}else{throw $4754(["syntax","noscope"]).create(("Could not find a scope tagged: "+name$4451));}}else{(newscope$4473=$3217$4443);return helper$3190(context$3195,newscope$4473,x$4442);}}else{if(($3225$3242&&(($3201$3231[0]==="tagscope")&&(((t1$3237=$3201$3231[1])),(typeof(t1$3237)==="string"))))){(tag$4477=t1$3237);(body$4478=$3201$3231[2]);return helper$3190(context$3195,Scope$1765(scope$3196,it$0$3179.gensym((tag$4477+"/"))),body$4478);}else{if(($3223$3240&&((t0$3236>=1)&&((type$4488=$3201$3231[0]),((args$4489=Array.prototype.slice.call($3201$3231,1)),(it$0$3179.generic_nodes.indexOf(type$4488)!==-1)))))){return [type$4488].concat((((acc$4499=[])),(((temp$4505=args$4489)),((($length$4511=temp$4505.length)),((($index$4517=0)),function(){$4494:for(;($index$4517<$length$4511);($index$4517++)){var arg$4534;var m$4526;(m$4526=temp$4505[$index$4517]);(arg$4534=m$4526);acc$4499.push(helper$3190(["expr","expr"],scope$3196,arg$4534));}}()))),acc$4499));}else{(other$4539=$3201$3231);throw $4754(["syntax","illegal_node"]).create("An illegal node was found.",({"node":other$4539,"context":context$3195}));}}}}}}}}}}}}}}}}}}));return helper$3190(context$3173,scope$3174,expr$3175);});$1654(Expander$1768,$1654(((accum$4545=({})),((accum$4545["::name"]="Expander"),accum$4545)),((accum$4549=({})),((accum$4549["::egclass"]=true),accum$4549))));Expander$1768;(mac1$1769=function(f$4556){return ["macro",function(context$4562,scope$4563,form$4564,$4559$4565){var t0$4569;var t1$4570;var expr$4567;(t0$4569=$4559$4565);if(((t0$4569 instanceof Array)&&(((t1$4570=t0$4569.length)),((t1$4570===2)&&(t0$4569[0]==="data"))))){(expr$4567=t0$4569[1]);}else{$4735($4559$4565);}return f$4556(expr$4567);}];});(__chk_ncache$1770=({}));(__chk_scache$1771=({}));(checker_db$1772=function($4593$4596){var v$4641;var v$4660;var s$4654;var n$4635;var $4598$4611;var ph$4605;(ph$4605=$4593$4596);($4598$4611=ph$4605);if(($4598$4611===null)){return checker_db$1772.null;}else{if(($4598$4611===(void 0))){return checker_db$1772.undefined;}else{if(($4598$4611===true)){return checker_db$1772.true;}else{if(($4598$4611===false)){return checker_db$1772.false;}else{if((typeof($4598$4611)==="number")){(n$4635=$4598$4611);if($1653(__chk_ncache$1770,n$4635)){return $1653(__chk_ncache$1770,n$4635);}else{(v$4641=mac1$1769(function(x$4646){return ["send",["symbol","==="],["data",x$4646,["value",n$4635]]];}));(__chk_ncache$1770[n$4635]=v$4641);return v$4641;}}else{if((typeof($4598$4611)==="string")){(s$4654=$4598$4611);if(Object.prototype.hasOwnProperty.call(__chk_scache$1771,s$4654)){return $1653(__chk_scache$1771,s$4654);}else{(v$4660=mac1$1769(function(x$4665){return ["send",["symbol","==="],["data",x$4665,["value",s$4654]]];}));(__chk_scache$1771[s$4654]=v$4660);return v$4660;}}else{$4735($4598$4611);}}}}}}});$1654(checker_db$1772,({"String":mac1$1769(function(x$4676){return ["send",["symbol","==="],["data",["send",["symbol","typeof"],["data",x$4676]],["value","string"]]];}),"Number":mac1$1769(function(x$4680){return ["send",["symbol","==="],["data",["send",["symbol","typeof"],["data",x$4680]],["value","number"]]];}),"Array":mac1$1769(function(x$4684){return ["send",["symbol","instanceof"],["data",x$4684,["symbol","Array"]]];}),"true":mac1$1769(function(x$4688){return x$4688;}),"false":mac1$1769(function(x$4692){return ["send",["symbol","not"],["data",["void"],x$4692]];}),"null":mac1$1769(function(x$4696){return ["send",["symbol","==="],["data",x$4696,["value",null]]];}),"undefined":mac1$1769(function(x$4700){return ["send",["symbol","==="],["data",x$4700,["value",(void 0)]]];})}));(exports["Env"]=Env$1766);(exports["Scope"]=Scope$1765);(exports["track_location"]=track_location$1767);(exports["Expander"]=Expander$1768);(exports["GenSym"]=GenSym$1760);(exports["gensym"]=gensym$1761);(exports["mac1"]=mac1$1769);(exports["checker_db"]=checker_db$1772);

},{"./location":11,"./pattern":14,"./pp":15,"./util":18}],10:[function(require,module,exports){
var $5362=function(type$5365){var f$5369;(f$5369=type$5365["::check"]);if((f$5369===(void 0))){return function(value$5375){return (value$5375 instanceof type$5365);};}else{return function(value$5379){return f$5369.call(type$5365,value$5379);};}};
var $5381=(function(o,m){if(typeof(m)==='string'||typeof(m)==='number'){return o[m];}else{return o['::send'](m);}});
var $5382=function(dest$5385,values$5386){var k$5391;(k$5391=null);$5389:for(k$5391 in values$5386){if(values$5386.hasOwnProperty(k$5391)){(dest$5385[k$5391]=values$5386[k$5391]);}}return dest$5385;};
var $5399=function($5401$5404){var ph$5410;(ph$5410=$5401$5404);var $5406$5416;($5406$5416=ph$5410);var bridge$5408$5421;var x$5425;(bridge$5408$5421=$5406$5416);if((((typeof(bridge$5408$5421)==="string")&&((x$5425=bridge$5408$5421),true))||((typeof(bridge$5408$5421)==="number")&&((x$5425=bridge$5408$5421),true)))){return ["value",x$5425];}else{var other$5436;(other$5436=$5406$5416);return other$5436["::serialize_ast"]();}};
var send$5136;(send$5136=function(obj$5143,$5140$5144){var ph$5150;var msg$5151;var t0$5153;(t0$5153=$5140$5144);(msg$5151=t0$5153);(ph$5150=t0$5153);var $5146$5162;($5146$5162=ph$5150);var bridge$5148$5167;(bridge$5148$5167=$5146$5162);if(((typeof(bridge$5148$5167)==="string")||(typeof(bridge$5148$5167)==="number"))){return obj$5143[msg$5151];}else{var other$5179;(other$5179=$5146$5162);return obj$5143["::send"](msg$5151);}});(Array[":::project"]=function($5185$5188){var ph$5193;var value$5194;var t0$5196;(t0$5196=$5185$5188);(value$5194=t0$5196);(ph$5193=t0$5196);var $5190$5205;($5190$5205=ph$5193);if($5362(Array)($5190$5205)){return [true,value$5194];}else{$5190$5205;return [true,[value$5194]];}});(Array.prototype["::check"]=function(value$5223){if((value$5223 instanceof Array)){var i$5229;(i$5229=0);$5226:for(;(i$5229<this.length);(i$5229++)){if(($5381(this,i$5229)!==$5381(value$5223,i$5229))){return false;}}return true;}else{return false;}});(Array.prototype["::clone"]=function(){return $5382(this.slice(0),this);});(Array.prototype[":::project"]=function(value$5248){if((value$5248 instanceof Array)){var i$5254;(i$5254=0);$5251:for(;(i$5254<this.length);(i$5254++)){if(($5381(this,i$5254)!==$5381(value$5248,i$5254))){return [true,[value$5248]];}}return [true,value$5248.slice(this.length)];}else{return [true,[value$5248]];}});(Array.prototype["::serialize_ast"]=function(){return ["array"].concat(this.map($5399));});(RegExp.prototype["::check"]=function($5272$5275){var ph$5280;(ph$5280=$5272$5275);var $5277$5286;($5277$5286=ph$5280);var value$5294;if((typeof($5277$5286)==="string")){(value$5294=$5277$5286);if(value$5294.match(this)){return true;}else{return false;}}else{var other$5299;(other$5299=$5277$5286);return false;}});(RegExp.prototype[":::project"]=function($5305$5308){var ph$5313;(ph$5313=$5305$5308);var $5310$5319;($5310$5319=ph$5313);var value$5327;if((typeof($5310$5319)==="string")){(value$5327=$5310$5319);var $5330$5335;($5330$5335=value$5327.match(this));var m$5343;if(($5330$5335===null)){(m$5343=$5330$5335);return [false,null];}else{var m$5348;(m$5348=$5330$5335);return [true,m$5348];}}else{var other$5352;(other$5352=$5310$5319);return [false,null];}});(Function.prototype["::send"]=function(args$5359){return this.apply(this,args$5359);});
var $7461=function(arr$7464){var results$7470;var l$7471;(results$7470=[]);(l$7471=arr$7464.length);var i$7480;(i$7480=0);$7469:for(;(i$7480<l$7471);(i$7480++)){results$7470.push([i$7480,$5381(arr$7464,i$7480)]);}return results$7470;};
var $7228=function(){var $7229$7235;($7229$7235=function(tags$7240){var it$0$7243;(it$0$7243=function(){if((!$5362($7229$7235)(this))){return Object.create($7229$7235.prototype);}else{return this;}}());(it$0$7243["tags"]=tags$7240);return it$0$7243;});($7229$7235.prototype["create"]=function(){var it$0$7263;var self$7264;(it$0$7263=this);(self$7264=this);var $7261$7273;($7261$7273=arguments);var t0$7278;var message$7282;var args$7283;(t0$7278=$7261$7273.length);if((t0$7278>=0)){(message$7282=function(){if((0>=t0$7278)){return "";}else{return $7261$7273[0];}}());(args$7283=Array.prototype.slice.call($7261$7273,1));var e$7296;(e$7296=Error(message$7282));(e$7296["::tags"]=it$0$7263.tags);(e$7296["args"]=args$7283);var temp$7312;(temp$7312=$7461(args$7283));var $length$7318;($length$7318=temp$7312.length);var $index$7324;($index$7324=0);$7297:for(;($index$7324<$length$7318);($index$7324++)){var m$7333;(m$7333=temp$7312[$index$7324]);var t0$7338;var t1$7339;var i$7343;var arg$7344;(t0$7338=m$7333);if(((t0$7338 instanceof Array)&&(((t1$7339=t0$7338.length)),(t1$7339===2)))){(i$7343=t0$7338[0]);(arg$7344=t0$7338[1]);(e$7296[i$7343]=arg$7344);}else{$7209(m$7333);}}(e$7296["length"]=args$7283.length);(e$7296["name"]=["E"].concat(it$0$7263.tags).join("."));return e$7296;}else{$7209($7261$7273);}});($7229$7235.prototype["::check"]=function(e$7374){var it$0$7378;var self$7379;(it$0$7378=this);(self$7379=this);var tags$7389;if(((!e$7374)||(!$5362(Error)(e$7374)))){return false;}(tags$7389=(e$7374["::tags"]||[]));var temp$7400;(temp$7400=it$0$7378.tags);var $length$7406;($length$7406=temp$7400.length);var $index$7412;($index$7412=0);$7390:for(;($index$7412<$length$7406);($index$7412++)){var m$7421;(m$7421=temp$7400[$index$7412]);var tag$7429;(tag$7429=m$7421);if((tags$7389.indexOf(tag$7429)===-1)){return false;}else{false;}}return true;});($7229$7235.prototype["::deconstruct"]=function(e$7438){var it$0$7442;var self$7443;(it$0$7442=this);(self$7443=this);return e$7438.args;});$5382($7229$7235,$5382(function(){var accum$7454;(accum$7454=({}));(accum$7454["::name"]="$7229");return accum$7454;}(),function(){var accum$7458;(accum$7458=({}));(accum$7458["::egclass"]=true);return accum$7458;}()));return $7229$7235;}();
var $7209=function(value$7212,url$7213,start$7214,end$7215){var err$7219;(err$7219=$7228(["match"]).create("Could not find a match for value",({"value":value$7212})));if(url$7213){(err$7219["location"]=["location",url$7213,start$7214,end$7215]);}throw err$7219;};
var $7487=function(type$7490){return function(value$7494){var f$7498;(f$7498=type$7490[":::project"]);if((f$7498===(void 0))){(f$7498=type$7490["::project"]);if((f$7498===(void 0))){return [true,type$7490(value$7494)];}else{var rval$7511;(rval$7511=false);try{(rval$7511=[true,f$7498(value$7494)]);}catch(excv$7522){var e$7528;(e$7528=excv$7522);(rval$7511=[false,null]);}return rval$7511;}}else{return f$7498.call(type$7490,value$7494);}};};
var $7640=function($7642$7645,key$7646){var ph$7654;(ph$7654=$7642$7645);var $7648$7660;($7648$7660=ph$7654);var bridge$7650$7665;(bridge$7650$7665=$7648$7660);if(((bridge$7650$7665===null)||(bridge$7650$7665===(void 0)))){return false;}else{var x$7677;if((typeof($7648$7660)==="string")){(x$7677=$7648$7660);return (key$7646 in String.prototype);}else{var x$7682;if((typeof($7648$7660)==="number")){(x$7682=$7648$7660);return (key$7646 in Number.prototype);}else{var x$7687;(x$7687=$7648$7660);return (key$7646 in x$7687);}}}};
var $7556=function($7558$7561){var ph$7571;var x$7572;var t0$7574;(t0$7574=$7558$7561);(x$7572=t0$7574);(ph$7571=t0$7574);var $7563$7583;($7563$7583=ph$7571);var bridge$7565$7588;(bridge$7565$7588=$7563$7583);if((function(){var bridge$7566$7598;(bridge$7566$7598=bridge$7565$7588);return (function(){var bridge$7567$7605;(bridge$7567$7605=bridge$7566$7598);return ((bridge$7567$7605===(void 0))||(bridge$7567$7605===null));}()||(typeof(bridge$7566$7598)==="string"));}()||(typeof(bridge$7565$7588)==="number"))){return x$7572;}else{if($7640($7563$7583,"::clone")){$7563$7583["::clone"];return x$7572["::clone"]();}else{$7563$7583;if((Object.getPrototypeOf(x$7572)===Object.prototype)){var dest$7623;(dest$7623=({}));var k$7628;(k$7628=null);$7622:for(k$7628 in x$7572){if(Object.prototype.hasOwnProperty.call(x$7572,k$7628)){(dest$7623[k$7628]=x$7572[k$7628]);}}return dest$7623;}else{var other$7638;(other$7638=$7563$7583);throw $7228(["clone"]).create("Object cannot be cloned",({"obj":x$7572}));}}}};
var $7534=function(a$7537,b$7538){var dest$7543;(dest$7543=$7556(a$7537));var k$7548;(k$7548=null);$7542:for(k$7548 in b$7538){if(Object.prototype.hasOwnProperty.call(b$7538,k$7548)){(dest$7543[k$7548]=b$7538[k$7548]);}}return dest$7543;};var id$5503;var id_f$5504;var numr$5505;var numr_f$5506;var num$5507;var num_f$5508;var str$5509;var str_f$5510;var op$5511;var op2$5512;var op3$5513;var op4$5514;var op_f$5515;var indent$5516;var indent_f$5517;var cmnt$5518;var cmnt_f$5519;var unkn$5520;var unkn_f$5521;var $5440$5455;var Location$5456;var __lt____lt____colon__$5457;var special_ops$5458;var regexps$5459;var ws_re$5460;var eol_re$5461;var produce$5462;var indent_tracker$5463;var process_indent$5464;var disambiguate_fixity$5465;var alternate_operators$5466;var fill_locations$5467;var tokenize$5468;($5440$5455=require("./location"));(Location$5456=$5440$5455.Location);(__lt____lt____colon__$5457=$5440$5455["<<:"]);(special_ops$5458=({"(":"PFX","[":"PFX","{":"PFX",")":"SFX","]":"SFX","}":"SFX",",":"IFX",".":"PFX","'":"PFX","not":"PFX"}));(regexps$5459=(((id$5503=RegExp("(?:^[a-zA-Z$_](?:[a-zA-Z$_0-9]*))",""))),((id_f$5504=function(m$5529){return ["ID",m$5529[0]];})),((numr$5505=RegExp("(?:^((?:\\d+))[rR]((?:[A-Za-z0-9_]+))(?:(?:\\.((?:[A-Za-z0-9_]+)))?))",""))),((numr_f$5506=function(m$5539){var t0$5549;var t1$5550;var frac$5570;var radix$5544;var intp$5545;var frac$5546;var value$5547;(t0$5549=m$5539);if(((t0$5549 instanceof Array)&&(((t1$5550=t0$5549.length)),(t1$5550===4)))){t0$5549[0];(radix$5544=t0$5549[1]);(intp$5545=t0$5549[2]);(frac$5546=t0$5549[3]);}else{$7209(m$5539,"/home/olivier/git/earl-grey/src/lex.eg",1075,1076);}(value$5547=parseInt(intp$5545.replace(RegExp("_","g"),""),radix$5544));if(frac$5546){(frac$5570=frac$5546.replace(RegExp("_","g"),""));(value$5547=(value$5547+(parseInt(frac$5546,radix$5544)/Math.pow(radix$5544,frac$5546.length))));}return ["NUM",value$5547];})),((num$5507=RegExp("(?:^((?:[0-9_]+))(?:(?:\\.((?:\\d+)))?)(?:(?:[eE]((?:[+-]?)(?:[0-9_]+)))?))",""))),((num_f$5508=function(m$5585){return ["NUM",parseFloat(m$5585[0].replace(RegExp("_","g"),""))];})),((str$5509=RegExp("(?:^\"((?:(?:(?:\\\\.)|[^\"])*))\")",""))),((str_f$5510=function(m$5595){var rx$5610;var f$5611;var repl$5600;var r$5601;(repl$5600=({"b":String.fromCharCode(8),"f":String.fromCharCode(12),"n":"\n","r":String.fromCharCode(13),"t":String.fromCharCode(9)}));(r$5601=(((rx$5610=RegExp("\\\\u[0-9A-Fa-f]{4}|\\\\x[0-9A-Fa-f]{2}|\\\\.","g"))),((f$5611=function($5618$5621){var chr$5662;var digits$5643;var t0$5637;var t1$5638;var t2$5639;var $5623$5632;var ph$5626;(ph$5626=$5618$5621);($5623$5632=ph$5626);(t0$5637=$7487(RegExp("^(?:\\\\u|\\\\x)(.*)",""))($5623$5632));if((t0$5637[0]&&(((t1$5638=t0$5637[1])),(((t2$5639=t1$5638.length)),(t2$5639===2))))){t1$5638[0];(digits$5643=t1$5638[1]);return String.fromCharCode(parseInt(digits$5643,16));}else{(t0$5637=$7487(RegExp("^.(.)",""))($5623$5632));if((t0$5637[0]&&(((t1$5638=t0$5637[1])),(((t2$5639=t1$5638.length)),(t2$5639===2))))){t1$5638[0];(chr$5662=t1$5638[1]);return ($5381(repl$5600,chr$5662)||chr$5662);}else{$7209($5623$5632);}}})),m$5595[1].replace(rx$5610,f$5611)));return ["STR",r$5601];})),((op$5511=RegExp("(?:^(?:[+\\-*/~\\^<>=%&|?!@#.:']+))",""))),((op2$5512=RegExp("(?:^[\\[\\{\\}\\],])",""))),((op3$5513=RegExp("(?:^(?:(?:(?:(?:(?:(?:(?:(?:(?:with|where)|when)|and)|not)|or)|in)|mod)|each)|as)(?:(?:[+\\-*/~\\^<>=%&|?!@#.:']+)|\\b))",""))),((op4$5514=RegExp("(?:^`((?:[A-Za-z0-9_$]+))`)",""))),((op_f$5515=function(m$5700,column$5701){var fixity$5733;var otherwise$5739;var $5709$5722;var $5705$5716;var op$5710;(op$5710=(m$5700[1]||m$5700[0]));($5705$5716=null);$5705$5716;if((op$5710==="|")){return ["INDENT",(column$5701-1)];}else{if((op$5710 in special_ops$5458)){(fixity$5733=$5381(special_ops$5458,op$5710));return ["OP",fixity$5733,op$5710];}else{(otherwise$5739=$5705$5716);return ["OP","?FX",op$5710];}}})),((indent$5516=RegExp("(?:^(?:(?:\n(?: *);(?:[^\n]*))*)(?:(?:\n((?: *)))+))",""))),((indent_f$5517=function(m$5749){var ilen$5753;(ilen$5753=m$5749[1].length);return ["INDENT",ilen$5753];})),((cmnt$5518=RegExp("(?:^;(?:[^\n]*))",""))),((cmnt_f$5519=function(m$5765){return ["IGNORE"];})),((unkn$5520=RegExp("(?:^.)",""))),((unkn_f$5521=function(m$5775){return ["ILLEGAL",m$5775[0]];})),[[op3$5513,op_f$5515],[id$5503,id_f$5504],[numr$5505,numr_f$5506],[num$5507,num_f$5508],[str$5509,str_f$5510],[op$5511,op_f$5515],[op2$5512,op_f$5515],[op4$5514,op_f$5515],[indent$5516,indent_f$5517],[cmnt$5518,cmnt_f$5519],[unkn$5520,unkn_f$5521]]));(ws_re$5460=RegExp("(?:^(?: *)(?:(?:\n(?: *)\\\\(?: *))*))",""));(eol_re$5461=RegExp("(?:^(?: *)(?:\n|$))",""));(produce$5462=function(src$5789){var text$5798;var results$5799;var wsb$5800;var pos$5801;var column$5802;(text$5798=src$5789.text);(results$5799=[]);(wsb$5800=text$5798.match(ws_re$5460)[0].length);(text$5798=text$5798.slice(wsb$5800));(pos$5801=wsb$5800);(column$5802=0);$5821:while(text$5798){var i$5827;(i$5827=0);$5824:for(;(i$5827<regexps$5459.length);(++i$5827)){var t0$5841;var t1$5842;var splits$5891;var skip$5874;var endpos$5875;var wsa$5876;var eol$5877;var bwsb$5878;var bwsa$5879;var token$5880;var re$5837;var fn$5838;var m$5839;(t0$5841=$5381(regexps$5459,i$5827));if(((t0$5841 instanceof Array)&&(((t1$5842=t0$5841.length)),(t1$5842===2)))){(re$5837=t0$5841[0]);(fn$5838=t0$5841[1]);}else{$7209($5381(regexps$5459,i$5827),"/home/olivier/git/earl-grey/src/lex.eg",4106,4126);}(m$5839=text$5798.match(re$5837));if(m$5839){(skip$5874=m$5839[0].length);(endpos$5875=(pos$5801+skip$5874));(column$5802=(((splits$5891=m$5839[0].split("\n"))),function(){if((splits$5891.length>1)){return $5381(splits$5891,(splits$5891.length-1)).length;}else{return (column$5802+skip$5874);}}()));(text$5798=text$5798.slice(skip$5874));(wsa$5876=text$5798.match(ws_re$5460)[0].length);(eol$5877=(text$5798.match(eol_re$5461)&&true));(bwsb$5878=(wsb$5800>0));(bwsa$5879=function(){if(eol$5877){return bwsb$5878;}else{return (wsa$5876>0);}}());(token$5880=fn$5838(m$5839,column$5802));(token$5880["wsb"]=bwsb$5878);(token$5880["wsa"]=bwsa$5879);(token$5880["location"]=Location$5456(src$5789,pos$5801,endpos$5875));results$5799.push(token$5880);(text$5798=text$5798.slice(wsa$5876));(column$5802=(column$5802+wsa$5876));(wsb$5800=wsa$5876);(pos$5801=(endpos$5875+wsa$5876));break $5824;}}}return results$5799;});(indent_tracker$5463=function(){var curr$5945;var stack$5946;var stacks$5947;(curr$5945=0);(stack$5946=[]);(stacks$5947=[stack$5946]);return function($5943$5958){var t0$5981;var rval$6049;var $index$6129;var $length$6123;var temp$6117;var acc$6111;var rval$6103;var x$6160;var $index$6188;var $length$6182;var temp$6176;var acc$6170;var other$6209;var fixity$6090;var fixity$6070;var stuff$6065;var new_indent$6006;var $5962$6007;var $5974$6000;var $5975$6001;var $5976$6002;var $5977$6003;var t0$5995;var t1$5996;var bridge$5969$5997;var bridge$5971$5998;var $5960$5990;var ph$5978;var token$5979;(t0$5981=$5943$5958);(token$5979=t0$5981);(ph$5978=t0$5981);($5960$5990=ph$5978);if((($5974$6000=($5960$5990 instanceof Array))&&(((t0$5995=$5960$5990.length)),((t0$5995===2)&&($5960$5990[0]==="INDENT"))))){(t1$5996=$5960$5990[1]);(new_indent$6006=t1$5996);($5962$6007=t1$5996);$5962$6007;if((curr$5945===false)){(curr$5945=new_indent$6006);return [$7534(["OP","IFX",","],({"wsb":true,"wsa":true}))];}else{if(($5962$6007>curr$5945)){stack$5946.push(curr$5945);(curr$5945=new_indent$6006);return [$7534(["OP","PFX","["],({"wsb":true,"wsa":true}))];}else{if(($5962$6007===curr$5945)){return [$7534(["OP","IFX",","],({"wsb":true,"wsa":true}))];}else{if(($5962$6007<curr$5945)){(rval$6049=[]);$6053:while(((stack$5946.length>0)&&(new_indent$6006<curr$5945))){(curr$5945=stack$5946.pop());rval$6049.push($7534(["OP","SFX","]"],({"wsb":true,"wsa":true})));}rval$6049.push($7534(["OP","IFX",","],({"wsb":true,"wsa":true})));return rval$6049;}else{$7209($5962$6007,"/home/olivier/git/earl-grey/src/lex.eg",5483,5499);}}}}}else{if(($5974$6000&&((t0$5995>=1)&&($5960$5990[0]==="ID")))){(stuff$6065=Array.prototype.slice.call($5960$5990,1));return [token$5979];}else{if(($5974$6000&&(($5976$6002=(t0$5995===3))&&(($5977$6003=($5960$5990[0]==="OP"))&&((fixity$6070=$5960$5990[1]),(((bridge$5969$5997=$5960$5990[2])),((bridge$5969$5997==="[")||(bridge$5969$5997==="{")))))))){stack$5946.push(curr$5945);stacks$5947.push(stack$5946);(stack$5946=[]);(curr$5945=false);return [token$5979];}else{if(($5977$6003&&((fixity$6090=$5960$5990[1]),(((bridge$5971$5998=$5960$5990[2])),((bridge$5971$5998==="]")||(bridge$5971$5998==="}")))))){(rval$6103=(((acc$6111=[])),(((temp$6117=stack$5946)),((($length$6123=temp$6117.length)),((($index$6129=0)),function(){$6106:for(;($index$6129<$length$6123);($index$6129++)){var m$6138;(m$6138=temp$6117[$index$6129]);m$6138;acc$6111.push($7534(["OP","SFX","]"],({"wsb":true,"wsa":true})));}}()))),acc$6111));(stack$5946=stacks$5947.pop());(curr$5945=stack$5946.pop());rval$6103.push(token$5979);return rval$6103;}else{if((((x$6160=$5960$5990)),((x$6160 instanceof Array)&&(x$6160[0]==="EOF")))){(acc$6170=[]);(temp$6176=stack$5946);($length$6182=temp$6176.length);($index$6188=0);$6165:for(;($index$6188<$length$6182);($index$6188++)){var m$6197;(m$6197=temp$6176[$index$6188]);m$6197;acc$6170.push($7534(["OP","SFX","]"],({"wsb":true,"wsa":true})));}return acc$6170;}else{(other$6209=$5960$5990);return [token$5979];}}}}}};});(process_indent$5464=function(stream$6216){var $index$6247;var $length$6241;var temp$6235;var tracker$6221;var results$6222;(tracker$6221=indent_tracker$5463());(results$6222=[]);(temp$6235=stream$6216);($length$6241=temp$6235.length);($index$6247=0);$6223:for(;($index$6247<$length$6241);($index$6247++)){var token$6264;var m$6256;(m$6256=temp$6235[$index$6247]);(token$6264=m$6256);(results$6222=results$6222.concat(tracker$6221(token$6264)));}return results$6222.concat(tracker$6221(["EOF"]));});(disambiguate_fixity$5465=function(stream$6271){var $index$6755;var $length$6749;var temp$6743;var __lt____lt____lt____colon__$6280;var collapse_operators$6281;var buffer$6282;var pfx$6283;var collapse$6284;var results$6285;(__lt____lt____lt____colon__$6280=function(a$6301,b$6302){(a$6301["wsb"]=b$6302.wsb);(a$6301["wsa"]=b$6302.wsa);return __lt____lt____colon__$5457(a$6301,b$6302);});(collapse_operators$6281=function(){var msg$6422;var longer$6418;var token$6395;var fixity$6396;var name$6397;var t0$6389;var t1$6390;var t2$6391;var $6379$6384;var $index$6453;var $length$6447;var temp$6441;var acc$6435;var $index$6516;var $length$6510;var temp$6504;var acc$6498;var t0$6569;var t1$6570;var t2$6571;var t3$6572;var t0$6617;var t0$6624;var t0$6677;var t0$6684;var t1$6685;var t2$6686;var bridge$6658$6667;var $6656$6662;var t$6653;var results$6647;var $6561$6606;var $6562$6607;var $6563$6608;var bridge$6558$6603;var t0$6604;var $6556$6598;var first$6564;var fixity$6565;var name$6566;var rest$6567;var n$6359;var $6326$6353;var $6327$6354;var $6328$6355;var $6329$6356;var t0$6350;var t1$6351;var buffer$6341;var $6320$6342;var t0$6337;var $6318$6332;($6318$6332=arguments);(t0$6337=$6318$6332.length);if((t0$6337>=1)){(buffer$6341=$6318$6332[0]);($6320$6342=Array.prototype.slice.call($6318$6332,1));(n$6359=buffer$6341.length);$6320$6342;if((!buffer$6341.length)){return [];}else{(t0$6350=$6320$6342);(t1$6351=t0$6350.length);if((($6328$6355=(t1$6351===2))&&(($6329$6356=t0$6350[0])&&t0$6350[1]))){($6379$6384=buffer$6341);if((($6379$6384 instanceof Array)&&(((t0$6389=$6379$6384.length)),((t0$6389===1)&&(((t1$6390=$6379$6384[0])),((token$6395=t1$6390),((t1$6390 instanceof Array)&&(((t2$6391=t1$6390.length)),((t2$6391===3)&&(t1$6390[0]==="OP")))))))))){(fixity$6396=t1$6390[1]);(name$6397=t1$6390[2]);return [__lt____lt____lt____colon__$6280(["ID",name$6397],token$6395)];}else{(longer$6418=$6379$6384);(msg$6422="Too many consecutive operators were found here.");throw $7228(["syntax","nullary"]).create(msg$6422,({"operators":buffer$6341}));}}else{if($6329$6356){t0$6350[1];(acc$6435=[]);(temp$6441=buffer$6341);($length$6447=temp$6441.length);($index$6453=0);$6430:for(;($index$6453<$length$6447);($index$6453++)){var token$6472;var name$6473;var t0$6467;var t1$6468;var m$6462;(m$6462=temp$6441[$index$6453]);(t0$6467=m$6462);(token$6472=t0$6467);if(((t0$6467 instanceof Array)&&(((t1$6468=t0$6467.length)),((t1$6468===3)&&(t0$6467[0]==="OP"))))){t0$6467[1];(name$6473=t0$6467[2]);acc$6435.push(__lt____lt____lt____colon__$6280(["OP","PFX",name$6473],token$6472));}else{$7209(m$6462,"/home/olivier/git/earl-grey/src/lex.eg",7844,7938);}}return acc$6435;}else{if(($6328$6355&&(t0$6350[0],t0$6350[1]))){(acc$6498=[]);(temp$6504=buffer$6341);($length$6510=temp$6504.length);($index$6516=0);$6493:for(;($index$6516<$length$6510);($index$6516++)){var token$6535;var name$6536;var t0$6530;var t1$6531;var m$6525;(m$6525=temp$6504[$index$6516]);(t0$6530=m$6525);(token$6535=t0$6530);if(((t0$6530 instanceof Array)&&(((t1$6531=t0$6530.length)),((t1$6531===3)&&(t0$6530[0]==="OP"))))){t0$6530[1];(name$6536=t0$6530[2]);acc$6498.push(__lt____lt____lt____colon__$6280(["OP","SFX",name$6536],token$6535));}else{$7209(m$6525,"/home/olivier/git/earl-grey/src/lex.eg",7951,8045);}}return acc$6498;}else{$6320$6342;(t0$6569=buffer$6341);if(((t0$6569 instanceof Array)&&(((t1$6570=t0$6569.length)),((t1$6570>=1)&&(((t2$6571=t0$6569[0])),((first$6564=t2$6571),((t2$6571 instanceof Array)&&(((t3$6572=t2$6571.length)),((t3$6572===3)&&(t2$6571[0]==="OP")))))))))){(fixity$6565=t2$6571[1]);(name$6566=t2$6571[2]);(rest$6567=Array.prototype.slice.call(t0$6569,1));}else{$7209(buffer$6341,"/home/olivier/git/earl-grey/src/lex.eg",8098,8104);}($6556$6598=[first$6564.wsb,first$6564.wsa]);(bridge$6558$6603=$6556$6598);if((((bridge$6558$6603 instanceof Array)&&(((t0$6617=bridge$6558$6603.length)),((t0$6617===2)&&((!bridge$6558$6603[0])&&(!bridge$6558$6603[1])))))||((bridge$6558$6603 instanceof Array)&&(((t0$6624=bridge$6558$6603.length)),((t0$6624===2)&&(bridge$6558$6603[0]&&bridge$6558$6603[1])))))){return [__lt____lt____lt____colon__$6280(["OP","IFX",name$6566],first$6564)].concat(collapse_operators$6281(rest$6567,true,false));}else{if((($6561$6606=($6556$6598 instanceof Array))&&(((t0$6604=$6556$6598.length)),(($6563$6608=(t0$6604===2))&&$6556$6598[0])))){$6556$6598[1];return [__lt____lt____lt____colon__$6280(["OP","PFX",name$6566],first$6564)].concat(collapse_operators$6281(rest$6567,true,false));}else{if(($6563$6608&&($6556$6598[0],$6556$6598[1]))){(results$6647=collapse_operators$6281(rest$6567,false,false));(t$6653=((($6656$6662=results$6647)),(((bridge$6658$6667=$6656$6662)),function(){if((((bridge$6658$6667 instanceof Array)&&(((t0$6677=bridge$6658$6667.length)),(t0$6677===0)))||((bridge$6658$6667 instanceof Array)&&(((t0$6684=bridge$6658$6667.length)),((t0$6684>=1)&&(((t1$6685=bridge$6658$6667[0])),((t1$6685 instanceof Array)&&(((t2$6686=t1$6685.length)),((t2$6686>=2)&&((t1$6685[0]==="OP")&&((t1$6685[1]==="PFX")&&(Array.prototype.slice.call(t1$6685,2),(Array.prototype.slice.call(bridge$6658$6667,1),true))))))))))))){return ["OP","IFX",name$6566];}else{$6656$6662;return ["OP","SFX",name$6566];}}())));return [__lt____lt____lt____colon__$6280(t$6653,first$6564)].concat(results$6647);}else{$7209($6556$6598);}}}}}}}}else{$7209($6318$6332);}});(buffer$6282=[]);(pfx$6283=true);(collapse$6284=function(sfx$6724){var rval$6729;(rval$6729=collapse_operators$6281(buffer$6282,pfx$6283,sfx$6724));(buffer$6282=[]);return rval$6729;});(results$6285=[]);(temp$6743=stream$6271);($length$6749=temp$6743.length);($index$6755=0);$6286:for(;($index$6755<$length$6749);($index$6755++)){var other$6836;var name$6786;var $6291$6787;var t0$6781;var t1$6782;var token$6773;var $6289$6774;var t0$6769;var m$6764;(m$6764=temp$6743[$index$6755]);(t0$6769=m$6764);(token$6773=t0$6769);($6289$6774=t0$6769);(t0$6781=$6289$6774);if(((t0$6781 instanceof Array)&&(((t1$6782=t0$6781.length)),((t1$6782===3)&&(t0$6781[0]==="OP"))))){($6291$6787=t0$6781[1]);(name$6786=t0$6781[2]);if(($6291$6787==="?FX")){buffer$6282.push(token$6773);}else{if(($6291$6787==="IFX")){(results$6285=results$6285.concat(collapse$6284(true)));results$6285.push(token$6773);(pfx$6283=true);}else{if(($6291$6787==="PFX")){(results$6285=results$6285.concat(collapse$6284(false)));results$6285.push(token$6773);(pfx$6283=true);}else{if(($6291$6787==="SFX")){(results$6285=results$6285.concat(collapse$6284(true)));results$6285.push(token$6773);(pfx$6283=false);}else{$7209($6291$6787,"/home/olivier/git/earl-grey/src/lex.eg",8914,8919);}}}}}else{(other$6836=$6289$6774);(results$6285=results$6285.concat(collapse$6284(false)));results$6285.push(token$6773);(pfx$6283=false);}}return results$6285.concat(collapse$6284(true));});(alternate_operators$5466=function(stream$6848){var $index$6893;var $length$6887;var temp$6881;var W$6854;var last_op$6855;var results$6856;(W$6854=function(x$6869){if(x$6869){return "wide";}else{return "short";}});(last_op$6855=true);(results$6856=[]);(temp$6881=stream$6848);($length$6887=temp$6881.length);($index$6893=0);$6857:for(;($index$6893<$length$6887);($index$6893++)){var x$6927;var $6948$6955;var x$6996;var token$7003;var fixity$6934;var name$6935;var t0$6919;var t1$6920;var token$6911;var $6860$6912;var t0$6907;var m$6902;(m$6902=temp$6881[$index$6893]);(t0$6907=m$6902);(token$6911=t0$6907);($6860$6912=t0$6907);if((((x$6927=$6860$6912)),((x$6927 instanceof Array)&&(x$6927[0]==="IGNORE")))){null;}else{(t0$6919=$6860$6912);if(((t0$6919 instanceof Array)&&(((t1$6920=t0$6919.length)),((t1$6920===3)&&(t0$6919[0]==="OP"))))){(fixity$6934=t0$6919[1]);(name$6935=t0$6919[2]);if(last_op$6855){results$6856.push(["VOID"]);}($6948$6955=fixity$6934);if(($6948$6955==="IFX")){results$6856.push(__lt____lt____colon__$5457(["IFX",W$6854((token$6911.wsa||token$6911.wsb)),name$6935],token$6911));(last_op$6855=true);}else{if(($6948$6955==="PFX")){if((!last_op$6855)){results$6856.push(["IFX",W$6854(token$6911.wsb),"WHITE"],["VOID"]);}results$6856.push(__lt____lt____colon__$5457(["PFX",W$6854(token$6911.wsa),name$6935],token$6911));(last_op$6855=true);}else{if(($6948$6955==="SFX")){results$6856.push(__lt____lt____colon__$5457(["SFX",W$6854(token$6911.wsb),name$6935],token$6911),["VOID"]);(last_op$6855=false);}else{$7209($6948$6955);}}}}else{if((((x$6996=$6860$6912)),((x$6996 instanceof Array)&&(x$6996[0]==="ILLEGAL")))){throw $7228(["syntax","illegal"]).create("unknown character",({"chr":token$6911}));}else{(token$7003=$6860$6912);if((!last_op$6855)){results$6856.push(["IFX",W$6854(token$7003.wsb),"WHITE"]);}results$6856.push(token$7003);(last_op$6855=false);}}}}if(last_op$6855){results$6856.push(["VOID"]);}return results$6856;});(fill_locations$5467=function(source$7017,stream$7018){var $index$7115;var $length$7109;var temp$7103;var to_fill$7024;var start$7025;var fill$7026;(to_fill$7024=[]);(start$7025=0);(fill$7026=function(end$7041){var $index$7064;var $length$7058;var temp$7052;(temp$7052=to_fill$7024);($length$7058=temp$7052.length);($index$7064=0);$7045:for(;($index$7064<$length$7058);($index$7064++)){var token$7090;var token$7081;var m$7073;(m$7073=temp$7052[$index$7064]);(token$7081=m$7073);if(($index$7064===0)){(token$7081["location"]=Location$5456(source$7017,start$7025,end$7041));}else{(token$7090=m$7073);(token$7090["location"]=Location$5456(source$7017,end$7041,end$7041));}}(to_fill$7024=[]);});(temp$7103=stream$7018);($length$7109=temp$7103.length);($index$7115=0);$7027:for(;($index$7115<$length$7109);($index$7115++)){var other$7148;var location$7133;var t0$7129;var m$7124;(m$7124=temp$7103[$index$7115]);(t0$7129=m$7124);if(($7640(t0$7129,"location")&&((location$7133=t0$7129.location),location$7133))){fill$7026(location$7133.start);(start$7025=location$7133.end);}else{(other$7148=m$7124);to_fill$7024.push(other$7148);}}fill$7026(source$7017.text.length);return stream$7018;});(tokenize$5468=function(src$7155){var it$0$7183;var it$0$7177;var it$0$7171;var it$0$7165;var it$0$7159;(it$0$7159=src$7155);(it$0$7165=produce$5462(it$0$7159));(it$0$7171=process_indent$5464(it$0$7165));(it$0$7177=disambiguate_fixity$5465(it$0$7171));(it$0$7183=alternate_operators$5466(it$0$7177));return fill_locations$5467(src$7155,it$0$7183);});(exports["tokenize"]=tokenize$5468);(exports["process_indent"]=process_indent$5464);(exports["disambiguate_fixity"]=disambiguate_fixity$5465);(exports["alternate_operators"]=alternate_operators$5466);(exports["fill_locations"]=fill_locations$5467);

},{"./location":11}],11:[function(require,module,exports){
var $7925=function(type$7928){var f$7932;(f$7932=type$7928["::check"]);if((f$7932===(void 0))){return function(value$7938){return (value$7938 instanceof type$7928);};}else{return function(value$7942){return f$7932.call(type$7928,value$7942);};}};
var $7944=(function(o,m){if(typeof(m)==='string'||typeof(m)==='number'){return o[m];}else{return o['::send'](m);}});
var $7945=function(dest$7948,values$7949){var k$7954;(k$7954=null);$7952:for(k$7954 in values$7949){if(values$7949.hasOwnProperty(k$7954)){(dest$7948[k$7954]=values$7949[k$7954]);}}return dest$7948;};
var $7962=function($7964$7967){var ph$7973;(ph$7973=$7964$7967);var $7969$7979;($7969$7979=ph$7973);var bridge$7971$7984;var x$7988;(bridge$7971$7984=$7969$7979);if((((typeof(bridge$7971$7984)==="string")&&((x$7988=bridge$7971$7984),true))||((typeof(bridge$7971$7984)==="number")&&((x$7988=bridge$7971$7984),true)))){return ["value",x$7988];}else{var other$7999;(other$7999=$7969$7979);return other$7999["::serialize_ast"]();}};
var send$7699;(send$7699=function(obj$7706,$7703$7707){var ph$7713;var msg$7714;var t0$7716;(t0$7716=$7703$7707);(msg$7714=t0$7716);(ph$7713=t0$7716);var $7709$7725;($7709$7725=ph$7713);var bridge$7711$7730;(bridge$7711$7730=$7709$7725);if(((typeof(bridge$7711$7730)==="string")||(typeof(bridge$7711$7730)==="number"))){return obj$7706[msg$7714];}else{var other$7742;(other$7742=$7709$7725);return obj$7706["::send"](msg$7714);}});(Array[":::project"]=function($7748$7751){var ph$7756;var value$7757;var t0$7759;(t0$7759=$7748$7751);(value$7757=t0$7759);(ph$7756=t0$7759);var $7753$7768;($7753$7768=ph$7756);if($7925(Array)($7753$7768)){return [true,value$7757];}else{$7753$7768;return [true,[value$7757]];}});(Array.prototype["::check"]=function(value$7786){if((value$7786 instanceof Array)){var i$7792;(i$7792=0);$7789:for(;(i$7792<this.length);(i$7792++)){if(($7944(this,i$7792)!==$7944(value$7786,i$7792))){return false;}}return true;}else{return false;}});(Array.prototype["::clone"]=function(){return $7945(this.slice(0),this);});(Array.prototype[":::project"]=function(value$7811){if((value$7811 instanceof Array)){var i$7817;(i$7817=0);$7814:for(;(i$7817<this.length);(i$7817++)){if(($7944(this,i$7817)!==$7944(value$7811,i$7817))){return [true,[value$7811]];}}return [true,value$7811.slice(this.length)];}else{return [true,[value$7811]];}});(Array.prototype["::serialize_ast"]=function(){return ["array"].concat(this.map($7962));});(RegExp.prototype["::check"]=function($7835$7838){var ph$7843;(ph$7843=$7835$7838);var $7840$7849;($7840$7849=ph$7843);var value$7857;if((typeof($7840$7849)==="string")){(value$7857=$7840$7849);if(value$7857.match(this)){return true;}else{return false;}}else{var other$7862;(other$7862=$7840$7849);return false;}});(RegExp.prototype[":::project"]=function($7868$7871){var ph$7876;(ph$7876=$7868$7871);var $7873$7882;($7873$7882=ph$7876);var value$7890;if((typeof($7873$7882)==="string")){(value$7890=$7873$7882);var $7893$7898;($7893$7898=value$7890.match(this));var m$7906;if(($7893$7898===null)){(m$7906=$7893$7898);return [false,null];}else{var m$7911;(m$7911=$7893$7898);return [true,m$7911];}}else{var other$7915;(other$7915=$7873$7882);return [false,null];}});(Function.prototype["::send"]=function(args$7922){return this.apply(this,args$7922);});
var $10488=function(arr$10491){var results$10497;var l$10498;(results$10497=[]);(l$10498=arr$10491.length);var i$10507;(i$10507=0);$10496:for(;(i$10507<l$10498);(i$10507++)){results$10497.push([i$10507,$7944(arr$10491,i$10507)]);}return results$10497;};
var $10255=function(){var $10256$10262;($10256$10262=function(tags$10267){var it$0$10270;(it$0$10270=function(){if((!$7925($10256$10262)(this))){return Object.create($10256$10262.prototype);}else{return this;}}());(it$0$10270["tags"]=tags$10267);return it$0$10270;});($10256$10262.prototype["create"]=function(){var it$0$10290;var self$10291;(it$0$10290=this);(self$10291=this);var $10288$10300;($10288$10300=arguments);var t0$10305;var message$10309;var args$10310;(t0$10305=$10288$10300.length);if((t0$10305>=0)){(message$10309=function(){if((0>=t0$10305)){return "";}else{return $10288$10300[0];}}());(args$10310=Array.prototype.slice.call($10288$10300,1));var e$10323;(e$10323=Error(message$10309));(e$10323["::tags"]=it$0$10290.tags);(e$10323["args"]=args$10310);var temp$10339;(temp$10339=$10488(args$10310));var $length$10345;($length$10345=temp$10339.length);var $index$10351;($index$10351=0);$10324:for(;($index$10351<$length$10345);($index$10351++)){var m$10360;(m$10360=temp$10339[$index$10351]);var t0$10365;var t1$10366;var i$10370;var arg$10371;(t0$10365=m$10360);if(((t0$10365 instanceof Array)&&(((t1$10366=t0$10365.length)),(t1$10366===2)))){(i$10370=t0$10365[0]);(arg$10371=t0$10365[1]);(e$10323[i$10370]=arg$10371);}else{$10236(m$10360);}}(e$10323["length"]=args$10310.length);(e$10323["name"]=["E"].concat(it$0$10290.tags).join("."));return e$10323;}else{$10236($10288$10300);}});($10256$10262.prototype["::check"]=function(e$10401){var it$0$10405;var self$10406;(it$0$10405=this);(self$10406=this);var tags$10416;if(((!e$10401)||(!$7925(Error)(e$10401)))){return false;}(tags$10416=(e$10401["::tags"]||[]));var temp$10427;(temp$10427=it$0$10405.tags);var $length$10433;($length$10433=temp$10427.length);var $index$10439;($index$10439=0);$10417:for(;($index$10439<$length$10433);($index$10439++)){var m$10448;(m$10448=temp$10427[$index$10439]);var tag$10456;(tag$10456=m$10448);if((tags$10416.indexOf(tag$10456)===-1)){return false;}else{false;}}return true;});($10256$10262.prototype["::deconstruct"]=function(e$10465){var it$0$10469;var self$10470;(it$0$10469=this);(self$10470=this);return e$10465.args;});$7945($10256$10262,$7945(function(){var accum$10481;(accum$10481=({}));(accum$10481["::name"]="$10256");return accum$10481;}(),function(){var accum$10485;(accum$10485=({}));(accum$10485["::egclass"]=true);return accum$10485;}()));return $10256$10262;}();
var $10236=function(value$10239,url$10240,start$10241,end$10242){var err$10246;(err$10246=$10255(["match"]).create("Could not find a match for value",({"value":value$10239})));if(url$10240){(err$10246["location"]=["location",url$10240,start$10241,end$10242]);}throw err$10246;};
var $10803=function(type$10806){return function(value$10810){var f$10814;(f$10814=type$10806[":::project"]);if((f$10814===(void 0))){(f$10814=type$10806["::project"]);if((f$10814===(void 0))){return [true,type$10806(value$10810)];}else{var rval$10827;(rval$10827=false);try{(rval$10827=[true,f$10814(value$10810)]);}catch(excv$10838){var e$10844;(e$10844=excv$10838);(rval$10827=[false,null]);}return rval$10827;}}else{return f$10814.call(type$10806,value$10810);}};};
var $10850=function($10852$10855,key$10856){var ph$10864;(ph$10864=$10852$10855);var $10858$10870;($10858$10870=ph$10864);var bridge$10860$10875;(bridge$10860$10875=$10858$10870);if(((bridge$10860$10875===null)||(bridge$10860$10875===(void 0)))){return false;}else{var x$10887;if((typeof($10858$10870)==="string")){(x$10887=$10858$10870);return (key$10856 in String.prototype);}else{var x$10892;if((typeof($10858$10870)==="number")){(x$10892=$10858$10870);return (key$10856 in Number.prototype);}else{var x$10897;(x$10897=$10858$10870);return (key$10856 in x$10897);}}}};
var $10514=function(){var $10515$10520;($10515$10520=function($10524$10531,$10526$10532,$10528$10533){var it$0$10536;(it$0$10536=function(){if((!$7925($10515$10520)(this))){return Object.create($10515$10520.prototype);}else{return this;}}());var t0$10543;(t0$10543=$10803(Array)($10524$10531));if(t0$10543[0]){(it$0$10536["tags"]=t0$10543[1]);}else{$10236($10524$10531);}(it$0$10536["props"]=$10526$10532);var t0$10555;(t0$10555=$10803(Array)($10528$10533));if(t0$10555[0]){(it$0$10536["children"]=t0$10555[1]);}else{$10236($10528$10533);}undefined;return it$0$10536;});$7945(function(){var accum$10569;(accum$10569=({}));(accum$10569["::check"]=function(x$10574){return (((x$10574&&x$10574.tags)&&x$10574.props)&&x$10574.children);});return accum$10569;}(),$7945(function(){var accum$10577;(accum$10577=({}));(accum$10577[":::project"]=function($10581$10584){var ph$10589;(ph$10589=$10581$10584);var $10586$10595;($10586$10595=ph$10589);var tags$10603;var props$10604;var children$10605;if(($10850($10586$10595,"tags")&&((tags$10603=$10586$10595.tags),($10850($10586$10595,"props")&&((props$10604=$10586$10595.props),$10850($10586$10595,"children")))))){(children$10605=$10586$10595.children);return [true,[tags$10603,props$10604,children$10605]];}else{$10586$10595;return [false,null];}});return accum$10577;}(),$7945(function(){var accum$10614;(accum$10614=({}));(accum$10614["::name"]="$10515");return accum$10614;}(),function(){var accum$10618;(accum$10618=({}));(accum$10618["::egclass"]=true);return accum$10618;}())));($10515$10520.prototype["::check"]=function($10624$10627){var it$0$10631;var self$10632;(it$0$10631=this);(self$10632=this);var ph$10643;(ph$10643=$10624$10627);var $10640$10649;($10640$10649=ph$10643);var n$10657;if($7925($10514)($10640$10649)){(n$10657=$10640$10649);var temp$10667;(temp$10667=it$0$10631.tags);var $length$10673;($length$10673=temp$10667.length);var $index$10679;($index$10679=0);$10661:for(;($index$10679<$length$10673);($index$10679++)){var m$10688;(m$10688=temp$10667[$index$10679]);var c$10696;(c$10696=m$10688);if((n$10657.tags.indexOf(c$10696)===-1)){return false;}else{false;}}return true;}else{$10640$10649;return false;}});($10515$10520.prototype[":::project"]=function($10707$10710){var it$0$10714;var self$10715;(it$0$10714=this);(self$10715=this);var ph$10726;(ph$10726=$10707$10710);var $10723$10732;($10723$10732=ph$10726);var n$10740;if($7925(it$0$10714)($10723$10732)){(n$10740=$10723$10732);return [true,[n$10740.tags,n$10740.props,n$10740.children]];}else{$10723$10732;return [false,null];}});$7945($10515$10520,$7945(function(){var accum$10751;(accum$10751=({}));(accum$10751["::check"]=function(x$10756){return (((x$10756&&x$10756.tags)&&x$10756.props)&&x$10756.children);});return accum$10751;}(),$7945(function(){var accum$10759;(accum$10759=({}));(accum$10759[":::project"]=function($10763$10766){var ph$10771;(ph$10771=$10763$10766);var $10768$10777;($10768$10777=ph$10771);var tags$10785;var props$10786;var children$10787;if(($10850($10768$10777,"tags")&&((tags$10785=$10768$10777.tags),($10850($10768$10777,"props")&&((props$10786=$10768$10777.props),$10850($10768$10777,"children")))))){(children$10787=$10768$10777.children);return [true,[tags$10785,props$10786,children$10787]];}else{$10768$10777;return [false,null];}});return accum$10759;}(),$7945(function(){var accum$10796;(accum$10796=({}));(accum$10796["::name"]="$10515");return accum$10796;}(),function(){var accum$10800;(accum$10800=({}));(accum$10800["::egclass"]=true);return accum$10800;}()))));return $10515$10520;}();
var $10899=function(from$10902,to$10903){var rval$10908;(rval$10908=[]);var i$10914;(i$10914=from$10902);$10907:for(;(i$10914<=to$10903);(i$10914++)){rval$10908.push(i$10914);}return rval$10908;};
var $10921=function(obj$10924){var results$10929;(results$10929=[]);var k$10934;(k$10934=null);$10928:for(k$10934 in obj$10924){if(Object.prototype.hasOwnProperty.call(obj$10924,k$10934)){results$10929.push([k$10934,$7944(obj$10924,k$10934)]);}}return results$10929;};var accum$8215;var accum$8219;var accum$8579;var accum$8583;var $8003$8033;var binsearch$8034;var $8004$8035;var __lt____gt__$8036;var repr$8037;var fs$8038;var Source$8039;var Location$8040;var highlight$8041;var highlight_lines$8042;var clamp$8043;var morsel$8044;var highlight_locations$8045;var highlight_locations_same_source$8046;var merge_locations$8047;var __lt____lt____colon__$8048;var __plus____plus____colon__$8049;var format_error$8050;var display_error$8051;($8003$8033=require("./util"));(binsearch$8034=$8003$8033.binsearch);($8004$8035=require("./pp"));(__lt____gt__$8036=$8004$8035["<>"]);(repr$8037=$8004$8035.repr);(fs$8038=require("fs"));(Source$8039=function(){var $index$8139;var $length$8133;var temp$8127;var curr$8108;var text$8094;var url$8095;var t0$8090;var $8081$8085;var it$0$8076;(it$0$8076=function(){if((!$7925(Source$8039)(this))){return Object.create(Source$8039.prototype);}else{return this;}}());($8081$8085=arguments);(t0$8090=$8081$8085.length);if(((t0$8090>=1)&&(t0$8090<=2))){(text$8094=$8081$8085[0]);(url$8095=function(){if((1>=t0$8090)){return false;}else{return $8081$8085[1];}}());(it$0$8076["text"]=text$8094);(it$0$8076["url"]=url$8095);(it$0$8076["counts"]=[]);(curr$8108=0);(temp$8127=text$8094.split("\n"));($length$8133=temp$8127.length);($index$8139=0);$8109:for(;($index$8139<$length$8133);($index$8139++)){var line$8156;var m$8148;(m$8148=temp$8127[$index$8139]);(line$8156=m$8148);it$0$8076.counts.push(curr$8108);(curr$8108=(curr$8108+(line$8156.length+1)));}it$0$8076.counts.push(curr$8108);(it$0$8076["nlines"]=(it$0$8076.counts.length-1));}else{$10236($8081$8085);}return it$0$8076;});(Source$8039.prototype["linecol"]=function(pos$8169){var line$8185;var col$8186;var it$0$8173;var self$8174;(it$0$8173=this);(self$8174=this);(line$8185=binsearch$8034(it$0$8173.counts,pos$8169));(col$8186=(pos$8169-$7944(it$0$8173.counts,(line$8185-1))));return [line$8185,col$8186];});(Source$8039.prototype["highlight_lines"]=function(l1$8197,l2$8198,spans$8199){var it$0$8203;var self$8204;(it$0$8203=this);(self$8204=this);return highlight_lines$8042(it$0$8203.text,it$0$8203.counts,[(l1$8197-1),(l2$8198-1)],spans$8199);});$7945(Source$8039,$7945(((accum$8215=({})),((accum$8215["::name"]="Source"),accum$8215)),((accum$8219=({})),((accum$8219["::egclass"]=true),accum$8219))));Source$8039;(Location$8040=function(source$8226,start$8227,end$8228){var it$0$8231;(it$0$8231=function(){if((!$7925(Location$8040)(this))){return Object.create(Location$8040.prototype);}else{return this;}}());(it$0$8231["source"]=(source$8226||Source$8039("",null)));(it$0$8231["start"]=start$8227);(it$0$8231["end"]=end$8228);return it$0$8231;});(Location$8040.prototype["text"]=function(){var it$0$8258;var self$8259;(it$0$8258=this);(self$8259=this);return it$0$8258.source.text.slice(it$0$8258.start,it$0$8258.end);});(Location$8040.prototype["at_start"]=function(){var it$0$8274;var self$8275;(it$0$8274=this);(self$8275=this);return Location$8040(it$0$8274.source,it$0$8274.start,it$0$8274.start);});(Location$8040.prototype["at_end"]=function(){var it$0$8290;var self$8291;(it$0$8290=this);(self$8291=this);return Location$8040(it$0$8290.source,it$0$8290.end,it$0$8290.end);});(Location$8040.prototype["linerange"]=function(){var l2$8362;var t0$8353;var t1$8354;var l1$8333;var $8317$8334;var t0$8327;var t1$8328;var t2$8329;var $8315$8322;var it$0$8306;var self$8307;(it$0$8306=this);(self$8307=this);($8315$8322=it$0$8306.linecol());if((($8315$8322 instanceof Array)&&(((t0$8327=$8315$8322.length)),((t0$8327===2)&&(((t1$8328=$8315$8322[0])),((t1$8328 instanceof Array)&&(((t2$8329=t1$8328.length)),(t2$8329===2)))))))){(l1$8333=t1$8328[0]);t1$8328[1];($8317$8334=$8315$8322[1]);if(($8317$8334===null)){return [l1$8333,l1$8333];}else{(t0$8353=$8317$8334);if(((t0$8353 instanceof Array)&&(((t1$8354=t0$8353.length)),(t1$8354===2)))){(l2$8362=t0$8353[0]);t0$8353[1];return [l1$8333,l2$8362];}else{$10236($8317$8334,"/home/olivier/git/earl-grey/src/location.eg",1080,1085);}}}else{$10236($8315$8322);}});(Location$8040.prototype["linecol"]=function(){var start$8397;var end$8398;var it$0$8385;var self$8386;(it$0$8385=this);(self$8386=this);(start$8397=it$0$8385.source.linecol(it$0$8385.start));(end$8398=function(){if((it$0$8385.start===it$0$8385.end)){return null;}else{return it$0$8385.source.linecol((it$0$8385.end-1));}}());return [start$8397,end$8398];});(Location$8040.prototype["ref"]=function(){var otherwise$8532;var $8512$8521;var $8508$8515;var l2$8484;var c2$8485;var t0$8473;var t1$8474;var t2$8475;var t3$8476;var l1$8441;var c1$8442;var $8423$8443;var t0$8433;var t1$8434;var t2$8435;var t3$8436;var t4$8437;var $8421$8428;var it$0$8412;var self$8413;(it$0$8412=this);(self$8413=this);($8421$8428=it$0$8412.linecol());if((($8421$8428 instanceof Array)&&(((t0$8433=$8421$8428.length)),((t0$8433===2)&&(((t1$8434=$8421$8428[0])),((t1$8434 instanceof Array)&&(((t2$8435=t1$8434.length)),((t2$8435===2)&&(((t3$8436=[true,String(t1$8434[0])])),(t3$8436[0]&&((l1$8441=t3$8436[1]),(((t4$8437=[true,String(t1$8434[1])])),t4$8437[0])))))))))))){(c1$8442=t4$8437[1]);($8423$8443=$8421$8428[1]);if(($8423$8443===null)){return ((l1$8441+":")+c1$8442);}else{(t0$8473=$8423$8443);if(((t0$8473 instanceof Array)&&(((t1$8474=t0$8473.length)),((t1$8474===2)&&(((t2$8475=[true,String(t0$8473[0])])),(t2$8475[0]&&((l2$8484=t2$8475[1]),(((t3$8476=[true,String(t0$8473[1])])),t3$8476[0])))))))){(c2$8485=t3$8476[1]);($8508$8515=null);$8508$8515;if(((l1$8441===l2$8484)&&(c1$8442===c2$8485))){return ((l1$8441+":")+c1$8442);}else{if((l1$8441===l2$8484)){return ((((l1$8441+":")+c1$8442)+"-")+c2$8485);}else{(otherwise$8532=$8508$8515);return ((((((l1$8441+":")+c1$8442)+"-")+l1$8441)+":")+c2$8485);}}}else{$10236($8423$8443,"/home/olivier/git/earl-grey/src/location.eg",1422,1427);}}}else{$10236($8421$8428);}});(Location$8040.prototype["highlight"]=function(){var cls$8566;var context$8567;var t0$8562;var $8545$8557;var it$0$8547;var self$8548;(it$0$8547=this);(self$8548=this);($8545$8557=arguments);(t0$8562=$8545$8557.length);if(((t0$8562>=0)&&(t0$8562<=2))){(cls$8566=function(){if((0>=t0$8562)){return "hl1";}else{return $8545$8557[0];}}());(context$8567=function(){if((1>=t0$8562)){return 0;}else{return $8545$8557[1];}}());return highlight_locations$8045([[it$0$8547,cls$8566]],context$8567);}else{$10236($8545$8557);}});$7945(Location$8040,$7945(((accum$8579=({})),((accum$8579["::name"]="Location"),accum$8579)),((accum$8583=({})),((accum$8583["::egclass"]=true),accum$8583))));Location$8040;(highlight$8041=function(){var $index$8635;var $length$8629;var temp$8623;var acc$8617;var text$8603;var spans$8604;var offset$8605;var t0$8599;var $8590$8594;($8590$8594=arguments);(t0$8599=$8590$8594.length);if(((t0$8599>=2)&&(t0$8599<=3))){(text$8603=$8590$8594[0]);(spans$8604=$8590$8594[1]);(offset$8605=function(){if((2>=t0$8599)){return 0;}else{return $8590$8594[2];}}());return $10514([],({}),(((acc$8617=[])),(((temp$8623=morsel$8044(spans$8604))),((($length$8629=temp$8623.length)),((($index$8635=0)),function(){$8612:for(;($index$8635<$length$8629);($index$8635++)){var xstart$8672;var xend$8673;var start$8654;var end$8655;var attributes$8656;var t0$8649;var t1$8650;var m$8644;(m$8644=temp$8623[$index$8635]);(t0$8649=m$8644);if(((t0$8649 instanceof Array)&&(((t1$8650=t0$8649.length)),(t1$8650===3)))){(start$8654=t0$8649[0]);(end$8655=t0$8649[1]);(attributes$8656=t0$8649[2]);acc$8617.push((((xstart$8672=Math.max((start$8654-offset$8605),0))),((xend$8673=Math.min((end$8655-offset$8605),text$8603.length))),$10514([("."+attributes$8656.slice(0,1))],({}),text$8603.slice(xstart$8672,xend$8673))));}else{$10236(m$8644,"/home/olivier/git/earl-grey/src/location.eg",1969,2262);}}}()))),acc$8617));}else{$10236($8590$8594);}});(highlight_lines$8042=function(text$8691,linelocs$8692,$8688$8693,spans$8694){var t0$8699;var t1$8700;var $index$8736;var $length$8730;var temp$8724;var acc$8718;var l1$8696;var l2$8697;(t0$8699=$8688$8693);if(((t0$8699 instanceof Array)&&(((t1$8700=t0$8699.length)),(t1$8700===2)))){(l1$8696=t0$8699[0]);(l2$8697=t0$8699[1]);}else{$10236($8688$8693);}return $10514(["span"],({}),(((acc$8718=[])),(((temp$8724=$10899(l1$8696,l2$8697))),((($length$8730=temp$8724.length)),((($index$8736=0)),function(){$8713:for(;($index$8736<$length$8730);($index$8736++)){var start$8759;var end$8760;var lineno$8753;var m$8745;(m$8745=temp$8724[$index$8736]);(lineno$8753=m$8745);acc$8718.push((((start$8759=$7944(linelocs$8692,lineno$8753))),((end$8760=$7944(linelocs$8692,(lineno$8753+1)))),$10514(["span"],({}),[$10514([".lineno"],({}),(lineno$8753+1)),$10514([".source"],({}),highlight$8041(text$8691,[[start$8759,end$8760,[]]].concat(clamp$8043(spans$8694,start$8759,end$8760))))])));}}()))),acc$8718));});(clamp$8043=function(spans$8772,bot$8773,top$8774){var $index$8799;var $length$8793;var temp$8787;var acc$8781;(acc$8781=[]);(temp$8787=spans$8772);($length$8793=temp$8787.length);($index$8799=0);$8776:for(;($index$8799<$length$8793);($index$8799++)){var start$8818;var end$8819;var attr$8820;var t0$8813;var t1$8814;var m$8808;(m$8808=temp$8787[$index$8799]);(t0$8813=m$8808);if(((t0$8813 instanceof Array)&&(((t1$8814=t0$8813.length)),((t1$8814===3)&&((start$8818=t0$8813[0]),((end$8819=t0$8813[1]),((attr$8820=t0$8813[2]),((end$8819>=bot$8773)&&(start$8818<=top$8774))))))))){acc$8781.push([Math.max(start$8818,bot$8773),Math.min(end$8819,top$8774),attr$8820]);}else{false;}}return acc$8781;});(morsel$8044=function(spans$8842){var jump$8849;var jumptill$8850;var process_elements$8851;var thespans$8852;(jump$8849=function(active$8857,bot$8858,top$8859){var $index$8895;var $length$8889;var temp$8883;var acc$8877;var $index$8948;var $length$8942;var temp$8936;var e$8864;var attributes$8865;(e$8864=$7944(Math.min,[top$8859].concat((((acc$8877=[])),(((temp$8883=active$8857)),((($length$8889=temp$8883.length)),((($index$8895=0)),function(){$8872:for(;($index$8895<$length$8889);($index$8895++)){var x$8914;var t0$8909;var t1$8910;var m$8904;(m$8904=temp$8883[$index$8895]);(t0$8909=m$8904);if(((t0$8909 instanceof Array)&&(((t1$8910=t0$8909.length)),(t1$8910===3)))){t0$8909[0];(x$8914=t0$8909[1]);t0$8909[2];acc$8877.push(x$8914);}else{$10236(m$8904,"/home/olivier/git/earl-grey/src/location.eg",3585,3628);}}}()))),acc$8877))));(attributes$8865=[]);(temp$8936=active$8857);($length$8942=temp$8936.length);($index$8948=0);$8866:for(;($index$8948<$length$8942);($index$8948++)){var X$8967;var t0$8962;var t1$8963;var m$8957;(m$8957=temp$8936[$index$8948]);(t0$8962=m$8957);if(((t0$8962 instanceof Array)&&(((t1$8963=t0$8962.length)),(t1$8963===3)))){t0$8962[0];t0$8962[1];(X$8967=t0$8962[2]);(attributes$8865=attributes$8865.concat(X$8967));}else{$10236(m$8957,"/home/olivier/git/earl-grey/src/location.eg",3654,3695);}}return [e$8864,[bot$8858,e$8864,attributes$8865]];});(jumptill$8850=function(active$8986,bot$8987,top$8988){var t0$9000;var t1$9001;var $index$9039;var $length$9033;var temp$9027;var acc$9021;var t0$9079;var t1$9080;var newbot$8994;var span$8995;var newactive$8996;var spans$8997;var remainder$8998;if((bot$8987===top$8988)){return [[],active$8986];}else{(t0$9000=jump$8849(active$8986,bot$8987,top$8988));if(((t0$9000 instanceof Array)&&(((t1$9001=t0$9000.length)),(t1$9001===2)))){(newbot$8994=t0$9000[0]);(span$8995=t0$9000[1]);}else{$10236(jump$8849(active$8986,bot$8987,top$8988),"/home/olivier/git/earl-grey/src/location.eg",3931,3965);}(newactive$8996=(((acc$9021=[])),(((temp$9027=active$8986)),((($length$9033=temp$9027.length)),((($index$9039=0)),function(){$9016:for(;($index$9039<$length$9033);($index$9039++)){var x$9058;var e$9059;var attr$9060;var t0$9053;var t1$9054;var m$9048;(m$9048=temp$9027[$index$9039]);(t0$9053=m$9048);(x$9058=t0$9053);if(((t0$9053 instanceof Array)&&(((t1$9054=t0$9053.length)),((t1$9054===3)&&(t0$9053[0],((e$9059=t0$9053[1]),((attr$9060=t0$9053[2]),(e$9059>newbot$8994)))))))){acc$9021.push(x$9058);}else{false;}}}()))),acc$9021));(t0$9079=jumptill$8850(newactive$8996,newbot$8994,top$8988));if(((t0$9079 instanceof Array)&&(((t1$9080=t0$9079.length)),(t1$9080===2)))){(spans$8997=t0$9079[0]);(remainder$8998=t0$9079[1]);}else{$10236(jumptill$8850(newactive$8996,newbot$8994,top$8988),"/home/olivier/git/earl-grey/src/location.eg",4080,4124);}return [[span$8995].concat(spans$8997),remainder$8998];}});(process_elements$8851=function(start$9098,active$9099,rem$9100){var $index$9205;var $length$9199;var temp$9193;var acc$9187;var t0$9244;var t1$9245;var top$9177;var bot$9178;var spans$9179;var t0$9297;var t1$9298;var spans$9294;var newactive$9295;var start$9260;var active$9261;var next$9262;var target$9263;var end$9264;var attr$9265;var rest$9266;var start$9157;var active$9158;var $9106$9122;var $9107$9123;var $9108$9124;var t0$9116;var t1$9117;var t2$9118;var t3$9119;var t4$9120;var $9102$9111;($9102$9111=[start$9098,active$9099,rem$9100]);if((($9106$9122=($9102$9111 instanceof Array))&&(((t0$9116=$9102$9111.length)),(($9108$9124=(t0$9116===3))&&($9102$9111[0],(((t1$9117=$9102$9111[1])),((t1$9117 instanceof Array)&&(((t2$9118=t1$9117.length)),((t2$9118===0)&&(((t3$9119=$9102$9111[2])),((t3$9119 instanceof Array)&&(((t4$9120=t3$9119.length)),(t4$9120===0))))))))))))){return [];}else{if(($9108$9124&&((start$9157=$9102$9111[0]),((active$9158=$9102$9111[1]),(((t1$9117=$9102$9111[2])),((t1$9117 instanceof Array)&&(((t2$9118=t1$9117.length)),(t2$9118===0)))))))){(top$9177=$7944(Math.max,(((acc$9187=[])),(((temp$9193=active$9158)),((($length$9199=temp$9193.length)),((($index$9205=0)),function(){$9182:for(;($index$9205<$length$9199);($index$9205++)){var e$9224;var t0$9219;var t1$9220;var m$9214;(m$9214=temp$9193[$index$9205]);(t0$9219=m$9214);if(((t0$9219 instanceof Array)&&(((t1$9220=t0$9219.length)),(t1$9220===3)))){t0$9219[0];(e$9224=t0$9219[1]);t0$9219[2];acc$9187.push(e$9224);}else{$10236(m$9214,"/home/olivier/git/earl-grey/src/location.eg",4309,4347);}}}()))),acc$9187)));(bot$9178=Math.min(start$9157,top$9177));(t0$9244=jumptill$8850(active$9158,start$9157,top$9177));if(((t0$9244 instanceof Array)&&(((t1$9245=t0$9244.length)),(t1$9245===2)))){(spans$9179=t0$9244[0]);t0$9244[1];}else{$10236(jumptill$8850(active$9158,start$9157,top$9177),"/home/olivier/git/earl-grey/src/location.eg",4400,4438);}return spans$9179;}else{if(($9108$9124&&((start$9260=$9102$9111[0]),((active$9261=$9102$9111[1]),(((t1$9117=$9102$9111[2])),((t1$9117 instanceof Array)&&(((t2$9118=t1$9117.length)),((t2$9118>=1)&&(((t3$9119=t1$9117[0])),((next$9262=t3$9119),((t3$9119 instanceof Array)&&(((t4$9120=t3$9119.length)),(t4$9120===3))))))))))))){(target$9263=t3$9119[0]);(end$9264=t3$9119[1]);(attr$9265=t3$9119[2]);(rest$9266=Array.prototype.slice.call(t1$9117,1));(t0$9297=jumptill$8850(active$9261,start$9260,target$9263));if(((t0$9297 instanceof Array)&&(((t1$9298=t0$9297.length)),(t1$9298===2)))){(spans$9294=t0$9297[0]);(newactive$9295=t0$9297[1]);}else{$10236(jumptill$8850(active$9261,start$9260,target$9263),"/home/olivier/git/earl-grey/src/location.eg",4542,4583);}return spans$9294.concat(process_elements$8851(target$9263,[next$9262].concat(newactive$9295),rest$9266));}else{$10236($9102$9111);}}}});(thespans$8852=spans$8842.sort(function($9317$9322,$9319$9323){var t0$9330;var t1$9331;var t0$9345;var t1$9346;var s1$9325;var e1$9326;var s2$9327;var e2$9328;(t0$9330=$9317$9322);if(((t0$9330 instanceof Array)&&(((t1$9331=t0$9330.length)),(t1$9331===3)))){(s1$9325=t0$9330[0]);(e1$9326=t0$9330[1]);t0$9330[2];}else{$10236($9317$9322);}(t0$9345=$9319$9323);if(((t0$9345 instanceof Array)&&(((t1$9346=t0$9345.length)),(t1$9346===3)))){(s2$9327=t0$9345[0]);(e2$9328=t0$9345[1]);t0$9345[2];}else{$10236($9319$9323);}if((s1$9325===s2$9327)){return (e1$9326-e2$9328);}else{return (s1$9325-s2$9327);}}));return process_elements$8851(thespans$8852[0][0],[],thespans$8852);});(highlight_locations$8045=function(){var $index$9410;var $length$9404;var temp$9398;var $index$9478;var $length$9472;var temp$9466;var acc$9460;var srcs$9388;var locations$9378;var context$9379;var t0$9374;var $9365$9369;($9365$9369=arguments);(t0$9374=$9365$9369.length);if(((t0$9374>=1)&&(t0$9374<=2))){(locations$9378=$9365$9369[0]);(context$9379=function(){if((1>=t0$9374)){return 0;}else{return $9365$9369[1];}}());(srcs$9388=({}));(temp$9398=locations$9378);($length$9404=temp$9398.length);($index$9410=0);$9389:for(;($index$9410<$length$9404);($index$9410++)){var key$9444;var loc$9429;var cls$9430;var t0$9424;var t1$9425;var m$9419;(m$9419=temp$9398[$index$9410]);(t0$9424=m$9419);if(((t0$9424 instanceof Array)&&(((t1$9425=t0$9424.length)),(t1$9425===2)))){(loc$9429=t0$9424[0]);(cls$9430=t0$9424[1]);(key$9444=String((loc$9429.source&&loc$9429.source.url)));if((!$7944(srcs$9388,key$9444))){(srcs$9388[key$9444]=[]);}$7944(srcs$9388,key$9444).push([loc$9429,cls$9430]);}else{$10236(m$9419,"/home/olivier/git/earl-grey/src/location.eg",4929,5098);}}return $10514(["div"],({}),(((acc$9460=[])),(((temp$9466=$10921(srcs$9388))),((($length$9472=temp$9466.length)),((($index$9478=0)),function(){$9455:for(;($index$9478<$length$9472);($index$9478++)){var locs$9497;var t0$9492;var t1$9493;var m$9487;(m$9487=temp$9466[$index$9478]);(t0$9492=m$9487);if(((t0$9492 instanceof Array)&&(((t1$9493=t0$9492.length)),(t1$9493===2)))){t0$9492[0];(locs$9497=t0$9492[1]);acc$9460.push(highlight_locations_same_source$8046(locs$9497,context$9379));}else{$10236(m$9487,"/home/olivier/git/earl-grey/src/location.eg",5103,5197);}}}()))),acc$9460));}else{$10236($9365$9369);}});(highlight_locations_same_source$8046=function(){var $index$9577;var $length$9571;var temp$9565;var acc$9559;var t0$9617;var t1$9618;var $index$9660;var $length$9654;var temp$9648;var acc$9642;var $index$9718;var $length$9712;var temp$9706;var acc$9700;var loc$9546;var src$9547;var l1$9548;var l2$9549;var first$9550;var last$9551;var locations$9532;var context$9533;var t0$9528;var $9519$9523;($9519$9523=arguments);(t0$9528=$9519$9523.length);if(((t0$9528>=1)&&(t0$9528<=2))){(locations$9532=$9519$9523[0]);(context$9533=function(){if((1>=t0$9528)){return 0;}else{return $9519$9523[1];}}());(loc$9546=merge_locations$8047((((acc$9559=[])),(((temp$9565=locations$9532)),((($length$9571=temp$9565.length)),((($index$9577=0)),function(){$9554:for(;($index$9577<$length$9571);($index$9577++)){var x$9596;var cls$9597;var t0$9591;var t1$9592;var m$9586;(m$9586=temp$9565[$index$9577]);(t0$9591=m$9586);if(((t0$9591 instanceof Array)&&(((t1$9592=t0$9591.length)),(t1$9592===2)))){(x$9596=t0$9591[0]);(cls$9597=t0$9591[1]);acc$9559.push(x$9596);}else{$10236(m$9586,"/home/olivier/git/earl-grey/src/location.eg",5280,5308);}}}()))),acc$9559)));(src$9547=loc$9546.source);(t0$9617=loc$9546.linerange());if(((t0$9617 instanceof Array)&&(((t1$9618=t0$9617.length)),(t1$9618===2)))){(l1$9548=t0$9617[0]);(l2$9549=t0$9617[1]);}else{$10236(loc$9546.linerange(),"/home/olivier/git/earl-grey/src/location.eg",5344,5363);}(first$9550=Math.max(1,(l1$9548-context$9533)));(last$9551=Math.min(src$9547.nlines,(l2$9549+context$9533)));return $10514(["div",".location"],({}),[$10514(["div",".source"],({}),[$10514([".sourcefile"],({}),(src$9547.url||"???")),(((acc$9642=[])),(((temp$9648=locations$9532)),((($length$9654=temp$9648.length)),((($index$9660=0)),function(){$9637:for(;($index$9660<$length$9654);($index$9660++)){var loc$9679;var cls$9680;var t0$9674;var t1$9675;var m$9669;(m$9669=temp$9648[$index$9660]);(t0$9674=m$9669);if(((t0$9674 instanceof Array)&&(((t1$9675=t0$9674.length)),(t1$9675===2)))){(loc$9679=t0$9674[0]);(cls$9680=t0$9674[1]);acc$9642.push($10514([("."+cls$9680),".sourcepos"],({}),loc$9679.ref()));}else{$10236(m$9669,"/home/olivier/git/earl-grey/src/location.eg",5528,5674);}}}()))),acc$9642)]),src$9547.highlight_lines(first$9550,last$9551,(((acc$9700=[])),(((temp$9706=locations$9532)),((($length$9712=temp$9706.length)),((($index$9718=0)),function(){$9695:for(;($index$9718<$length$9712);($index$9718++)){var loc$9737;var cls$9738;var t0$9732;var t1$9733;var m$9727;(m$9727=temp$9706[$index$9718]);(t0$9732=m$9727);if(((t0$9732 instanceof Array)&&(((t1$9733=t0$9732.length)),(t1$9733===2)))){(loc$9737=t0$9732[0]);(cls$9738=t0$9732[1]);acc$9700.push([loc$9737.start,loc$9737.end,[cls$9738]]);}else{$10236(m$9727,"/home/olivier/git/earl-grey/src/location.eg",5729,5787);}}}()))),acc$9700))]);}else{$10236($9519$9523);}});(merge_locations$8047=function($9759$9762){var $index$9834;var $length$9828;var temp$9822;var acc$9816;var $index$9880;var $length$9874;var temp$9868;var acc$9862;var start$9807;var end$9808;var locs$9801;var loc$9796;var $9768$9783;var $9769$9784;var t0$9781;var $9764$9776;var ph$9770;(ph$9770=$9759$9762);($9764$9776=ph$9770);if((($9768$9783=($9764$9776 instanceof Array))&&(((t0$9781=$9764$9776.length)),(t0$9781===0)))){return Location$8040(null,0,0);}else{if(($9768$9783&&(t0$9781===1))){(loc$9796=$9764$9776[0]);return loc$9796;}else{if(($9768$9783&&(t0$9781>=0))){(locs$9801=Array.prototype.slice.call($9764$9776,0));(start$9807=$7944(Math.min,(((acc$9816=[])),(((temp$9822=locs$9801)),((($length$9828=temp$9822.length)),((($index$9834=0)),function(){$9811:for(;($index$9834<$length$9828);($index$9834++)){var loc$9851;var m$9843;(m$9843=temp$9822[$index$9834]);(loc$9851=m$9843);acc$9816.push(loc$9851.start);}}()))),acc$9816)));(end$9808=$7944(Math.max,(((acc$9862=[])),(((temp$9868=locs$9801)),((($length$9874=temp$9868.length)),((($index$9880=0)),function(){$9857:for(;($index$9880<$length$9874);($index$9880++)){var loc$9897;var m$9889;(m$9889=temp$9868[$index$9880]);(loc$9897=m$9889);acc$9862.push(loc$9897.end);}}()))),acc$9862)));return Location$8040(locs$9801[0].source,start$9807,end$9808);}else{$10236($9764$9776);}}}});(__lt____lt____colon__$8048=function(x$9908,y$9909){if((!$7925(Location$8040)(x$9908.location))){(x$9908["location"]=function(){if(((!y$9909)||$7925(Location$8040)(y$9909))){return y$9909;}else{return y$9909.location;}}());}return x$9908;});(__plus____plus____colon__$8049=function(x$9922,y$9923){var rval$9940;var x2$9928;var y2$9929;(x2$9928=function(){if(((!x$9922)||$7925(Location$8040)(x$9922))){return x$9922;}else{return x$9922.location;}}());(y2$9929=function(){if(((!y$9923)||$7925(Location$8040)(y$9923))){return y$9923;}else{return y$9923.location;}}());(rval$9940=false);try{(rval$9940=merge_locations$8047([x2$9928,y2$9929]));}catch(excv$9951){var e$9957;(e$9957=excv$9951);(rval$9940=(void 0));}return rval$9940;});(format_error$8050=function(){var $index$10073;var $length$10067;var temp$10061;var acc$10055;var hls$10043;var locs$10044;var rval$10155;var loc$10181;var data$10148;var other$10187;var url$10136;var start$10137;var end$10138;var loc$10126;var args$10023;var fmt_args$10013;var $9975$10008;var $9976$10009;var $9977$10010;var t0$10004;var t1$10005;var t2$10006;var e$9990;var context$9991;var $9970$9992;var t0$9985;var t1$9986;var $9968$9980;($9968$9980=arguments);(t0$9985=$9968$9980.length);if(((t0$9985>=1)&&(t0$9985<=2))){(t1$9986=$9968$9980[0]);(e$9990=t1$9986);($9970$9992=t1$9986);(context$9991=function(){if((1>=t0$9985)){return 0;}else{return $9968$9980[1];}}());(fmt_args$10013=function(e$10018){if((e$10018.args&&e$10018.args.length)){return $10514([".error_args"],({}),repr$8037(e$10018.args));}else{return "";}});(t0$10004=$9970$9992);if(($7925($10255(["syntax"]))(t0$10004)&&($10850(t0$10004,"args")&&(((t1$10005=t0$10004.args)),((t1$10005 instanceof Array)&&(((t2$10006=t1$10005.length)),(t2$10006===1))))))){(args$10023=t1$10005[0]);(hls$10043=["hl1","hl2","hl3","hl4"]);(locs$10044=(((acc$10055=[])),(((temp$10061=$10488($10921(args$10023)))),((($length$10067=temp$10061.length)),((($index$10073=0)),function(){$10050:for(;($index$10073<$length$10067);($index$10073++)){var i$10094;var key$10095;var arg$10096;var t0$10087;var t1$10088;var t2$10089;var t3$10090;var m$10082;(m$10082=temp$10061[$index$10073]);(t0$10087=m$10082);if(((t0$10087 instanceof Array)&&(((t1$10088=t0$10087.length)),((t1$10088===2)&&((i$10094=t0$10087[0]),(((t2$10089=t0$10087[1])),((t2$10089 instanceof Array)&&(((t3$10090=t2$10089.length)),((t3$10090===2)&&((key$10095=t2$10089[0]),((arg$10096=t2$10089[1]),(arg$10096&&arg$10096.location)))))))))))){acc$10055.push([arg$10096.location,$7944(hls$10043,(i$10094%4))]);}else{false;}}}()))),acc$10055));return $10514(["div"],({}),[$10514([".error"],({}),[$10514([".error_type"],({}),e$9990.name),$10514([".error_message"],({}),e$9990.message)]),$10514([".error_args",".syntax"],({}),repr$8037(args$10023)),highlight_locations$8045(locs$10044,context$9991)]);}else{if((($9976$10009=$10850(t0$10004,"location"))&&(((t1$10005=t0$10004.location)),$7925(Location$8040)(t1$10005)))){(loc$10126=t1$10005);return $10514(["div"],({}),[$10514([".error"],({}),[$10514([".error_type"],({}),e$9990.name),$10514([".error_message"],({}),e$9990.message)]),fmt_args$10013(e$9990),highlight_locations$8045([[loc$10126,"hl1"]],context$9991),$10514([".traceback"],({}),(e$9990.stack||""))]);}else{if(($9976$10009&&((t1$10005 instanceof Array)&&(((t2$10006=t1$10005.length)),((t2$10006===4)&&(t1$10005[0]==="location")))))){(url$10136=t1$10005[1]);(start$10137=t1$10005[2]);(end$10138=t1$10005[3]);(data$10148=(((rval$10155=false)),(function(){try{(rval$10155=fs$8038.readFileSync(url$10136,"utf8"));}catch(excv$10166){var e$10172;(e$10172=excv$10166);(rval$10155=null);}}(),rval$10155)));if(data$10148){(loc$10181=Location$8040(Source$8039(data$10148,url$10136),start$10137,end$10138));return $10514(["div"],({}),[$10514([".error"],({}),[$10514([".error_type"],({}),e$9990.name),$10514([".error_message"],({}),e$9990.message)]),fmt_args$10013(e$9990),highlight_locations$8045([[loc$10181,"hl1"]],context$9991),$10514([".traceback"],({}),($10514([],({}),e$9990.stack)||""))]);}else{return $10514(["div"],({}),[$10514([".error"],({}),[$10514([".error_type"],({}),e$9990.name),$10514([".error_message"],({}),e$9990.message)]),fmt_args$10013(e$9990),$10514([".traceback"],({}),($10514([],({}),e$9990.stack)||e$9990))]);}}else{(other$10187=$9970$9992);return $10514(["div"],({}),[$10514([".error"],({}),[$10514([".error_type"],({}),e$9990.name),$10514([".error_message"],({}),e$9990.message)]),fmt_args$10013(e$9990),$10514([".traceback"],({}),$10514([],({}),e$9990.stack))]);}}}}else{$10236($9968$9980);}});(display_error$8051=function(e$10196){return __lt____gt__$8036(null,format_error$8050(e$10196));});(exports["Source"]=Source$8039);(exports["Location"]=Location$8040);(exports["highlight"]=highlight$8041);(exports["highlight_locations"]=highlight_locations$8045);(exports["merge_locations"]=merge_locations$8047);(exports["<<:"]=__lt____lt____colon__$8048);(exports["++:"]=__plus____plus____colon__$8049);(exports["format_error"]=format_error$8050);(exports["display_error"]=display_error$8051);

},{"./pp":15,"./util":18,"fs":20}],12:[function(require,module,exports){
var $11174=function(type$11177){var f$11181;(f$11181=type$11177["::check"]);if((f$11181===(void 0))){return function(value$11187){return (value$11187 instanceof type$11177);};}else{return function(value$11191){return f$11181.call(type$11177,value$11191);};}};
var $11193=(function(o,m){if(typeof(m)==='string'||typeof(m)==='number'){return o[m];}else{return o['::send'](m);}});
var $11194=function(dest$11197,values$11198){var k$11203;(k$11203=null);$11201:for(k$11203 in values$11198){if(values$11198.hasOwnProperty(k$11203)){(dest$11197[k$11203]=values$11198[k$11203]);}}return dest$11197;};
var $11211=function($11213$11216){var ph$11222;(ph$11222=$11213$11216);var $11218$11228;($11218$11228=ph$11222);var bridge$11220$11233;var x$11237;(bridge$11220$11233=$11218$11228);if((((typeof(bridge$11220$11233)==="string")&&((x$11237=bridge$11220$11233),true))||((typeof(bridge$11220$11233)==="number")&&((x$11237=bridge$11220$11233),true)))){return ["value",x$11237];}else{var other$11248;(other$11248=$11218$11228);return other$11248["::serialize_ast"]();}};
var send$10948;(send$10948=function(obj$10955,$10952$10956){var ph$10962;var msg$10963;var t0$10965;(t0$10965=$10952$10956);(msg$10963=t0$10965);(ph$10962=t0$10965);var $10958$10974;($10958$10974=ph$10962);var bridge$10960$10979;(bridge$10960$10979=$10958$10974);if(((typeof(bridge$10960$10979)==="string")||(typeof(bridge$10960$10979)==="number"))){return obj$10955[msg$10963];}else{var other$10991;(other$10991=$10958$10974);return obj$10955["::send"](msg$10963);}});(Array[":::project"]=function($10997$11000){var ph$11005;var value$11006;var t0$11008;(t0$11008=$10997$11000);(value$11006=t0$11008);(ph$11005=t0$11008);var $11002$11017;($11002$11017=ph$11005);if($11174(Array)($11002$11017)){return [true,value$11006];}else{$11002$11017;return [true,[value$11006]];}});(Array.prototype["::check"]=function(value$11035){if((value$11035 instanceof Array)){var i$11041;(i$11041=0);$11038:for(;(i$11041<this.length);(i$11041++)){if(($11193(this,i$11041)!==$11193(value$11035,i$11041))){return false;}}return true;}else{return false;}});(Array.prototype["::clone"]=function(){return $11194(this.slice(0),this);});(Array.prototype[":::project"]=function(value$11060){if((value$11060 instanceof Array)){var i$11066;(i$11066=0);$11063:for(;(i$11066<this.length);(i$11066++)){if(($11193(this,i$11066)!==$11193(value$11060,i$11066))){return [true,[value$11060]];}}return [true,value$11060.slice(this.length)];}else{return [true,[value$11060]];}});(Array.prototype["::serialize_ast"]=function(){return ["array"].concat(this.map($11211));});(RegExp.prototype["::check"]=function($11084$11087){var ph$11092;(ph$11092=$11084$11087);var $11089$11098;($11089$11098=ph$11092);var value$11106;if((typeof($11089$11098)==="string")){(value$11106=$11089$11098);if(value$11106.match(this)){return true;}else{return false;}}else{var other$11111;(other$11111=$11089$11098);return false;}});(RegExp.prototype[":::project"]=function($11117$11120){var ph$11125;(ph$11125=$11117$11120);var $11122$11131;($11122$11131=ph$11125);var value$11139;if((typeof($11122$11131)==="string")){(value$11139=$11122$11131);var $11142$11147;($11142$11147=value$11139.match(this));var m$11155;if(($11142$11147===null)){(m$11155=$11142$11147);return [false,null];}else{var m$11160;(m$11160=$11142$11147);return [true,m$11160];}}else{var other$11164;(other$11164=$11122$11131);return [false,null];}});(Function.prototype["::send"]=function(args$11171){return this.apply(this,args$11171);});
var $11867=function(arr$11870){var results$11876;var l$11877;(results$11876=[]);(l$11877=arr$11870.length);var i$11886;(i$11886=0);$11875:for(;(i$11886<l$11877);(i$11886++)){results$11876.push([i$11886,$11193(arr$11870,i$11886)]);}return results$11876;};
var $11634=function(){var $11635$11641;($11635$11641=function(tags$11646){var it$0$11649;(it$0$11649=function(){if((!$11174($11635$11641)(this))){return Object.create($11635$11641.prototype);}else{return this;}}());(it$0$11649["tags"]=tags$11646);return it$0$11649;});($11635$11641.prototype["create"]=function(){var it$0$11669;var self$11670;(it$0$11669=this);(self$11670=this);var $11667$11679;($11667$11679=arguments);var t0$11684;var message$11688;var args$11689;(t0$11684=$11667$11679.length);if((t0$11684>=0)){(message$11688=function(){if((0>=t0$11684)){return "";}else{return $11667$11679[0];}}());(args$11689=Array.prototype.slice.call($11667$11679,1));var e$11702;(e$11702=Error(message$11688));(e$11702["::tags"]=it$0$11669.tags);(e$11702["args"]=args$11689);var temp$11718;(temp$11718=$11867(args$11689));var $length$11724;($length$11724=temp$11718.length);var $index$11730;($index$11730=0);$11703:for(;($index$11730<$length$11724);($index$11730++)){var m$11739;(m$11739=temp$11718[$index$11730]);var t0$11744;var t1$11745;var i$11749;var arg$11750;(t0$11744=m$11739);if(((t0$11744 instanceof Array)&&(((t1$11745=t0$11744.length)),(t1$11745===2)))){(i$11749=t0$11744[0]);(arg$11750=t0$11744[1]);(e$11702[i$11749]=arg$11750);}else{$11615(m$11739);}}(e$11702["length"]=args$11689.length);(e$11702["name"]=["E"].concat(it$0$11669.tags).join("."));return e$11702;}else{$11615($11667$11679);}});($11635$11641.prototype["::check"]=function(e$11780){var it$0$11784;var self$11785;(it$0$11784=this);(self$11785=this);var tags$11795;if(((!e$11780)||(!$11174(Error)(e$11780)))){return false;}(tags$11795=(e$11780["::tags"]||[]));var temp$11806;(temp$11806=it$0$11784.tags);var $length$11812;($length$11812=temp$11806.length);var $index$11818;($index$11818=0);$11796:for(;($index$11818<$length$11812);($index$11818++)){var m$11827;(m$11827=temp$11806[$index$11818]);var tag$11835;(tag$11835=m$11827);if((tags$11795.indexOf(tag$11835)===-1)){return false;}else{false;}}return true;});($11635$11641.prototype["::deconstruct"]=function(e$11844){var it$0$11848;var self$11849;(it$0$11848=this);(self$11849=this);return e$11844.args;});$11194($11635$11641,$11194(function(){var accum$11860;(accum$11860=({}));(accum$11860["::name"]="$11635");return accum$11860;}(),function(){var accum$11864;(accum$11864=({}));(accum$11864["::egclass"]=true);return accum$11864;}()));return $11635$11641;}();
var $11615=function(value$11618,url$11619,start$11620,end$11621){var err$11625;(err$11625=$11634(["match"]).create("Could not find a match for value",({"value":value$11618})));if(url$11619){(err$11625["location"]=["location",url$11619,start$11620,end$11621]);}throw err$11625;};var hoist$11256;var hoistable$11257;var not_hoistable$11258;var hoist_helper$11259;(hoist$11256=function(expr$11264){var t0$11271;var t1$11272;var b$11268;var inner$11269;(t0$11271=hoist_helper$11259(expr$11264));if(((t0$11271 instanceof Array)&&(((t1$11272=t0$11271.length)),(t1$11272===2)))){(b$11268=t0$11271[0]);(inner$11269=t0$11271[1]);}else{$11615(hoist_helper$11259(expr$11264),"/home/olivier/git/earl-grey/src/opt.eg",50,72);}return ["scope",inner$11269,b$11268];});(hoistable$11257=["send","array","object","multi","if","assign","js_break","js_continue","js_return","js_delete","js_throw","js_try","js_new"]);(not_hoistable$11258=["void","js_while","js_for","js_for_in","js_label"]);(hoist_helper$11259=function($11295$11298){var t0$11315;var x$11351;var x$11357;var bridge$11303$11343;var x$11363;var t0$11384;var t1$11385;var newbody$11381;var inner$11382;var t0$11409;var t1$11410;var newbody$11406;var inner$11407;var $index$11464;var $length$11458;var temp$11452;var acc$11446;var accum$11434;var newargs$11435;var $index$11540;var $length$11534;var temp$11528;var acc$11522;var newargs$11514;var other$11607;var type$11506;var args$11507;var type$11425;var args$11426;var vars$11400;var body$11401;var vars$11370;var body$11371;var $11309$11332;var $11310$11333;var $11311$11334;var bridge$11302$11329;var t0$11330;var $11300$11324;var ph$11312;var expr$11313;(t0$11315=$11295$11298);(expr$11313=t0$11315);(ph$11312=t0$11315);($11300$11324=ph$11312);(bridge$11302$11329=$11300$11324);if(((((bridge$11303$11343=bridge$11302$11329)),((((x$11351=bridge$11303$11343)),((x$11351 instanceof Array)&&(x$11351[0]==="symbol")))||(((x$11357=bridge$11303$11343)),((x$11357 instanceof Array)&&(x$11357[0]==="value")))))||(((x$11363=bridge$11302$11329)),((x$11363 instanceof Array)&&(x$11363[0]==="variable"))))){return [expr$11313,[]];}else{if((($11309$11332=($11300$11324 instanceof Array))&&(((t0$11330=$11300$11324.length)),(($11311$11334=(t0$11330===3))&&($11300$11324[0]==="scope"))))){(vars$11370=$11300$11324[1]);(body$11371=$11300$11324[2]);(t0$11384=hoist_helper$11259(body$11371));if(((t0$11384 instanceof Array)&&(((t1$11385=t0$11384.length)),(t1$11385===2)))){(newbody$11381=t0$11384[0]);(inner$11382=t0$11384[1]);}else{$11615(hoist_helper$11259(body$11371),"/home/olivier/git/earl-grey/src/opt.eg",1463,1488);}return [newbody$11381,inner$11382.concat(vars$11370)];}else{if(($11311$11334&&($11300$11324[0]==="lambda"))){(vars$11400=$11300$11324[1]);(body$11401=$11300$11324[2]);(t0$11409=hoist_helper$11259(body$11401));if(((t0$11409 instanceof Array)&&(((t1$11410=t0$11409.length)),(t1$11410===2)))){(newbody$11406=t0$11409[0]);(inner$11407=t0$11409[1]);}else{$11615(hoist_helper$11259(body$11401),"/home/olivier/git/earl-grey/src/opt.eg",1666,1691);}return [["lambda",vars$11400,["scope",inner$11407,newbody$11406]],[]];}else{if(($11309$11332&&(($11311$11334=(t0$11330>=1))&&((type$11425=$11300$11324[0]),((args$11426=Array.prototype.slice.call($11300$11324,1)),(hoistable$11257.indexOf(type$11425)!==-1)))))){(accum$11434=[]);(newargs$11435=(((acc$11446=[])),(((temp$11452=args$11426)),((($length$11458=temp$11452.length)),((($index$11464=0)),function(){$11441:for(;($index$11464<$length$11458);($index$11464++)){var t0$11489;var t1$11490;var b$11486;var inner$11487;var arg$11481;var m$11473;(m$11473=temp$11452[$index$11464]);(arg$11481=m$11473);acc$11446.push(((((t0$11489=hoist_helper$11259(arg$11481))),function(){if(((t0$11489 instanceof Array)&&(((t1$11490=t0$11489.length)),(t1$11490===2)))){(b$11486=t0$11489[0]);(inner$11487=t0$11489[1]);}else{return $11615(hoist_helper$11259(arg$11481),"/home/olivier/git/earl-grey/src/opt.eg",2027,2054);}}()),(accum$11434=accum$11434.concat(inner$11487)),b$11486));}}()))),acc$11446));return [[type$11425].concat(newargs$11435),accum$11434];}else{if(($11311$11334&&((type$11506=$11300$11324[0]),((args$11507=Array.prototype.slice.call($11300$11324,1)),(not_hoistable$11258.indexOf(type$11506)!==-1))))){(newargs$11514=(((acc$11522=[])),(((temp$11528=args$11507)),((($length$11534=temp$11528.length)),((($index$11540=0)),function(){$11517:for(;($index$11540<$length$11534);($index$11540++)){var t0$11568;var t1$11569;var other$11602;var t0$11589;var $11562$11584;var b$11565;var inner$11566;var arg$11557;var m$11549;(m$11549=temp$11528[$index$11540]);(arg$11557=m$11549);acc$11522.push(((((t0$11568=hoist_helper$11259(arg$11557))),function(){if(((t0$11568 instanceof Array)&&(((t1$11569=t0$11568.length)),(t1$11569===2)))){(b$11565=t0$11568[0]);(inner$11566=t0$11568[1]);}else{return $11615(hoist_helper$11259(arg$11557),"/home/olivier/git/earl-grey/src/opt.eg",2370,2397);}}()),((($11562$11584=inner$11566)),function(){if((($11562$11584 instanceof Array)&&(((t0$11589=$11562$11584.length)),(t0$11589===0)))){return b$11565;}else{(other$11602=$11562$11584);return ["scope",inner$11566,b$11565];}}())));}}()))),acc$11522));return [[type$11506].concat(newargs$11514),[]];}else{(other$11607=$11300$11324);throw $11634(["syntax","illegal"]).create("Illegal node -- this should not happen.",({"node":other$11607}));}}}}}});(exports["hoist"]=hoist$11256);

},{}],13:[function(require,module,exports){
var $12129=function(type$12132){var f$12136;(f$12136=type$12132["::check"]);if((f$12136===(void 0))){return function(value$12142){return (value$12142 instanceof type$12132);};}else{return function(value$12146){return f$12136.call(type$12132,value$12146);};}};
var $12148=(function(o,m){if(typeof(m)==='string'||typeof(m)==='number'){return o[m];}else{return o['::send'](m);}});
var $12149=function(dest$12152,values$12153){var k$12158;(k$12158=null);$12156:for(k$12158 in values$12153){if(values$12153.hasOwnProperty(k$12158)){(dest$12152[k$12158]=values$12153[k$12158]);}}return dest$12152;};
var $12166=function($12168$12171){var ph$12177;(ph$12177=$12168$12171);var $12173$12183;($12173$12183=ph$12177);var bridge$12175$12188;var x$12192;(bridge$12175$12188=$12173$12183);if((((typeof(bridge$12175$12188)==="string")&&((x$12192=bridge$12175$12188),true))||((typeof(bridge$12175$12188)==="number")&&((x$12192=bridge$12175$12188),true)))){return ["value",x$12192];}else{var other$12203;(other$12203=$12173$12183);return other$12203["::serialize_ast"]();}};
var send$11903;(send$11903=function(obj$11910,$11907$11911){var ph$11917;var msg$11918;var t0$11920;(t0$11920=$11907$11911);(msg$11918=t0$11920);(ph$11917=t0$11920);var $11913$11929;($11913$11929=ph$11917);var bridge$11915$11934;(bridge$11915$11934=$11913$11929);if(((typeof(bridge$11915$11934)==="string")||(typeof(bridge$11915$11934)==="number"))){return obj$11910[msg$11918];}else{var other$11946;(other$11946=$11913$11929);return obj$11910["::send"](msg$11918);}});(Array[":::project"]=function($11952$11955){var ph$11960;var value$11961;var t0$11963;(t0$11963=$11952$11955);(value$11961=t0$11963);(ph$11960=t0$11963);var $11957$11972;($11957$11972=ph$11960);if($12129(Array)($11957$11972)){return [true,value$11961];}else{$11957$11972;return [true,[value$11961]];}});(Array.prototype["::check"]=function(value$11990){if((value$11990 instanceof Array)){var i$11996;(i$11996=0);$11993:for(;(i$11996<this.length);(i$11996++)){if(($12148(this,i$11996)!==$12148(value$11990,i$11996))){return false;}}return true;}else{return false;}});(Array.prototype["::clone"]=function(){return $12149(this.slice(0),this);});(Array.prototype[":::project"]=function(value$12015){if((value$12015 instanceof Array)){var i$12021;(i$12021=0);$12018:for(;(i$12021<this.length);(i$12021++)){if(($12148(this,i$12021)!==$12148(value$12015,i$12021))){return [true,[value$12015]];}}return [true,value$12015.slice(this.length)];}else{return [true,[value$12015]];}});(Array.prototype["::serialize_ast"]=function(){return ["array"].concat(this.map($12166));});(RegExp.prototype["::check"]=function($12039$12042){var ph$12047;(ph$12047=$12039$12042);var $12044$12053;($12044$12053=ph$12047);var value$12061;if((typeof($12044$12053)==="string")){(value$12061=$12044$12053);if(value$12061.match(this)){return true;}else{return false;}}else{var other$12066;(other$12066=$12044$12053);return false;}});(RegExp.prototype[":::project"]=function($12072$12075){var ph$12080;(ph$12080=$12072$12075);var $12077$12086;($12077$12086=ph$12080);var value$12094;if((typeof($12077$12086)==="string")){(value$12094=$12077$12086);var $12097$12102;($12097$12102=value$12094.match(this));var m$12110;if(($12097$12102===null)){(m$12110=$12097$12102);return [false,null];}else{var m$12115;(m$12115=$12097$12102);return [true,m$12115];}}else{var other$12119;(other$12119=$12077$12086);return [false,null];}});(Function.prototype["::send"]=function(args$12126){return this.apply(this,args$12126);});
var $15215=function(arr$15218){var results$15224;var l$15225;(results$15224=[]);(l$15225=arr$15218.length);var i$15234;(i$15234=0);$15223:for(;(i$15234<l$15225);(i$15234++)){results$15224.push([i$15234,$12148(arr$15218,i$15234)]);}return results$15224;};
var $14982=function(){var $14983$14989;($14983$14989=function(tags$14994){var it$0$14997;(it$0$14997=function(){if((!$12129($14983$14989)(this))){return Object.create($14983$14989.prototype);}else{return this;}}());(it$0$14997["tags"]=tags$14994);return it$0$14997;});($14983$14989.prototype["create"]=function(){var it$0$15017;var self$15018;(it$0$15017=this);(self$15018=this);var $15015$15027;($15015$15027=arguments);var t0$15032;var message$15036;var args$15037;(t0$15032=$15015$15027.length);if((t0$15032>=0)){(message$15036=function(){if((0>=t0$15032)){return "";}else{return $15015$15027[0];}}());(args$15037=Array.prototype.slice.call($15015$15027,1));var e$15050;(e$15050=Error(message$15036));(e$15050["::tags"]=it$0$15017.tags);(e$15050["args"]=args$15037);var temp$15066;(temp$15066=$15215(args$15037));var $length$15072;($length$15072=temp$15066.length);var $index$15078;($index$15078=0);$15051:for(;($index$15078<$length$15072);($index$15078++)){var m$15087;(m$15087=temp$15066[$index$15078]);var t0$15092;var t1$15093;var i$15097;var arg$15098;(t0$15092=m$15087);if(((t0$15092 instanceof Array)&&(((t1$15093=t0$15092.length)),(t1$15093===2)))){(i$15097=t0$15092[0]);(arg$15098=t0$15092[1]);(e$15050[i$15097]=arg$15098);}else{$14963(m$15087);}}(e$15050["length"]=args$15037.length);(e$15050["name"]=["E"].concat(it$0$15017.tags).join("."));return e$15050;}else{$14963($15015$15027);}});($14983$14989.prototype["::check"]=function(e$15128){var it$0$15132;var self$15133;(it$0$15132=this);(self$15133=this);var tags$15143;if(((!e$15128)||(!$12129(Error)(e$15128)))){return false;}(tags$15143=(e$15128["::tags"]||[]));var temp$15154;(temp$15154=it$0$15132.tags);var $length$15160;($length$15160=temp$15154.length);var $index$15166;($index$15166=0);$15144:for(;($index$15166<$length$15160);($index$15166++)){var m$15175;(m$15175=temp$15154[$index$15166]);var tag$15183;(tag$15183=m$15175);if((tags$15143.indexOf(tag$15183)===-1)){return false;}else{false;}}return true;});($14983$14989.prototype["::deconstruct"]=function(e$15192){var it$0$15196;var self$15197;(it$0$15196=this);(self$15197=this);return e$15192.args;});$12149($14983$14989,$12149(function(){var accum$15208;(accum$15208=({}));(accum$15208["::name"]="$14983");return accum$15208;}(),function(){var accum$15212;(accum$15212=({}));(accum$15212["::egclass"]=true);return accum$15212;}()));return $14983$14989;}();
var $14963=function(value$14966,url$14967,start$14968,end$14969){var err$14973;(err$14973=$14982(["match"]).create("Could not find a match for value",({"value":value$14966})));if(url$14967){(err$14973["location"]=["location",url$14967,start$14968,end$14969]);}throw err$14973;};
var $15241=function(obj$15244){var results$15249;(results$15249=[]);var k$15254;(k$15254=null);$15248:for(k$15254 in obj$15244){if(Object.prototype.hasOwnProperty.call(obj$15244,k$15254)){results$15249.push([k$15254,$12148(obj$15244,k$15254)]);}}return results$15249;};
var $15258=function(arrays$15261){var results$15265;(results$15265=[]);var temp$15275;(temp$15275=arrays$15261);var $length$15281;($length$15281=temp$15275.length);var $index$15287;($index$15287=0);$15266:for(;($index$15287<$length$15281);($index$15287++)){var m$15296;(m$15296=temp$15275[$index$15287]);var a$15304;(a$15304=m$15296);(results$15265=results$15265.concat(a$15304));}return results$15265;};
var $15310=function(type$15313){return function(value$15317){var f$15321;(f$15321=type$15313[":::project"]);if((f$15321===(void 0))){(f$15321=type$15313["::project"]);if((f$15321===(void 0))){return [true,type$15313(value$15317)];}else{var rval$15334;(rval$15334=false);try{(rval$15334=[true,f$15321(value$15317)]);}catch(excv$15345){var e$15351;(e$15351=excv$15345);(rval$15334=[false,null]);}return rval$15334;}}else{return f$15321.call(type$15313,value$15317);}};};
var $15529=Object.keys;
var $15530=function($15532$15535,key$15536){var ph$15544;(ph$15544=$15532$15535);var $15538$15550;($15538$15550=ph$15544);var bridge$15540$15555;(bridge$15540$15555=$15538$15550);if(((bridge$15540$15555===null)||(bridge$15540$15555===(void 0)))){return false;}else{var x$15567;if((typeof($15538$15550)==="string")){(x$15567=$15538$15550);return (key$15536 in String.prototype);}else{var x$15572;if((typeof($15538$15550)==="number")){(x$15572=$15538$15550);return (key$15536 in Number.prototype);}else{var x$15577;(x$15577=$15538$15550);return (key$15536 in x$15577);}}}};
var $15357=function($15359$15362,b$15363){var ph$15377;var a$15378;var t0$15380;(t0$15380=$15359$15362);(a$15378=t0$15380);(ph$15377=t0$15380);var $15365$15389;($15365$15389=ph$15377);var bridge$15368$15394;if(($15365$15389===b$15363)){return true;}else{(bridge$15368$15394=$15365$15389);if((function(){var bridge$15369$15408;(bridge$15369$15408=bridge$15368$15394);return (function(){var bridge$15370$15415;(bridge$15370$15415=bridge$15369$15408);return (function(){var bridge$15371$15422;(bridge$15371$15422=bridge$15370$15415);return (function(){var bridge$15372$15429;(bridge$15372$15429=bridge$15371$15422);return ((typeof(bridge$15372$15429)==="number")||(typeof(bridge$15372$15429)==="string"));}()||(bridge$15371$15422===null));}()||(bridge$15370$15415===(void 0)));}()||(bridge$15369$15408===true));}()||(bridge$15368$15394===false))){return false;}else{if($12129(Array)($15365$15389)){if(((!$12129(Array)(b$15363))||(a$15378.length!==b$15363.length))){return false;}var i$15445;(i$15445=0);$15441:for(;(i$15445<a$15378.length);(i$15445++)){if((!$15357(a$15378[i$15445],b$15363[i$15445]))){return false;}}return true;}else{$15365$15389;if((((Object.getPrototypeOf(a$15378)===Object.prototype)&&$12129(Object)(b$15363))&&(Object.getPrototypeOf(b$15363)===Object.prototype))){var ka$15459;(ka$15459=$15529(a$15378));if((!$15357(ka$15459.sort(),$15529(b$15363).sort()))){return false;}var temp$15470;(temp$15470=ka$15459);var $length$15476;($length$15476=temp$15470.length);var $index$15482;($index$15482=0);$15460:for(;($index$15482<$length$15476);($index$15482++)){var m$15491;(m$15491=temp$15470[$index$15482]);var k$15499;(k$15499=m$15491);if((!$15357(a$15378[k$15499],b$15363[k$15499]))){return false;}}return true;}else{if($15530($15365$15389,"::serialize")){$15365$15389["::serialize"];var $15506$15511;($15506$15511=b$15363);if($15530($15506$15511,"::serialize")){$15506$15511["::serialize"];return $15357(a$15378["::serialize"](),b$15363["::serialize"]());}else{var otherwise$15523;(otherwise$15523=$15506$15511);return false;}}else{var otherwise$15527;(otherwise$15527=$15365$15389);return false;}}}}}};
var $15579=function(pairs$15582){var rval$15586;(rval$15586=({}));var temp$15596;(temp$15596=pairs$15582);var $length$15602;($length$15602=temp$15596.length);var $index$15608;($index$15608=0);$15587:for(;($index$15608<$length$15602);($index$15608++)){var m$15617;(m$15617=temp$15596[$index$15608]);var t0$15622;var t1$15623;var k$15627;var v$15628;(t0$15622=m$15617);if(((t0$15622 instanceof Array)&&(((t1$15623=t0$15622.length)),(t1$15623===2)))){(k$15627=t0$15622[0]);(v$15628=t0$15622[1]);(rval$15586[k$15627]=v$15628);}else{$14963(m$15617);}}return rval$15586;};var accum$12790;var accum$12794;var accum$13040;var accum$13556;var accum$13560;var accum$13785;var accum$13789;var accum$13793;var accum$13797;var accum$13801;var accum$13813;var accum$13817;var accum$13821;var accum$13825;var accum$13829;var eg_groups$13571;var eg_prio$13572;var $12207$12229;var __lt____lt____colon__$12230;var __plus____plus____colon__$12231;var transform$12232;var OperatorGroups$12233;var parse_op_description$12234;var eg_groups$12235;var SimplePriority$12236;var MAX$12237;var eg_order$12238;var DONE$12239;var NONE$12240;var LEFT$12241;var RIGHT$12242;var BOTH$12243;var oparse$12244;var finalize$12245;var parse$12246;($12207$12229=require("./location"));(__lt____lt____colon__$12230=$12207$12229["<<:"]);(__plus____plus____colon__$12231=$12207$12229["++:"]);(transform$12232=function(expr$12260,cb$12261){var rval$12281;var tr$12266;var result$12267;(tr$12266=function(x$12272){return transform$12232(x$12272,cb$12261);});(result$12267=(((rval$12281=false)),(function(){try{(rval$12281=cb$12261.call(tr$12266,expr$12260));}catch(excv$12292){var name$12344;var args$12345;var v$12339;var s$12334;var $12308$12320;var $12309$12321;var $12310$12322;var t0$12318;var $12303$12313;var e$12298;(e$12298=excv$12292);(rval$12281=((($12303$12313=expr$12260)),function(){if((($12308$12320=($12303$12313 instanceof Array))&&(((t0$12318=$12303$12313.length)),((t0$12318===1)&&($12303$12313[0]==="void"))))){return ["void"];}else{if(($12308$12320&&(($12310$12322=(t0$12318===2))&&($12303$12313[0]==="symbol")))){(s$12334=$12303$12313[1]);return expr$12260;}else{if(($12310$12322&&($12303$12313[0]==="value"))){(v$12339=$12303$12313[1]);return expr$12260;}else{if(($12308$12320&&(t0$12318>=1))){(name$12344=$12303$12313[0]);(args$12345=Array.prototype.slice.call($12303$12313,1));return [name$12344].concat(args$12345.map(tr$12266));}else{$14963($12303$12313);}}}}}()));}}(),rval$12281)));return __lt____lt____colon__$12230(result$12267,expr$12260);});(OperatorGroups$12233=function(groups$12357){var $index$12404;var $length$12398;var temp$12392;var acc$12386;var $index$12464;var $length$12458;var temp$12452;var acc$12446;var $index$12569;var $length$12563;var temp$12557;var acc$12551;var itg$12372;var it$0$12360;(it$0$12360=function(){if((!$12129(OperatorGroups$12233)(this))){return Object.create(OperatorGroups$12233.prototype);}else{return this;}}());(itg$12372=$15241(groups$12357));(it$0$12360["gnames"]=(((acc$12386=[])),(((temp$12392=itg$12372)),((($length$12398=temp$12392.length)),((($index$12404=0)),function(){$12381:for(;($index$12404<$length$12398);($index$12404++)){var name$12423;var t0$12418;var t1$12419;var m$12413;(m$12413=temp$12392[$index$12404]);(t0$12418=m$12413);if(((t0$12418 instanceof Array)&&(((t1$12419=t0$12418.length)),(t1$12419===2)))){(name$12423=t0$12418[0]);t0$12418[1];acc$12386.push(name$12423);}else{$14963(m$12413,"/home/olivier/git/earl-grey/src/parse.eg",539,565);}}}()))),acc$12386));(it$0$12360["groups"]=(((acc$12446=[])),(((temp$12452=itg$12372)),((($length$12458=temp$12452.length)),((($index$12464=0)),function(){$12441:for(;($index$12464<$length$12458);($index$12464++)){var $index$12520;var $length$12514;var temp$12508;var acc$12502;var name$12483;var descrs$12484;var t0$12478;var t1$12479;var m$12473;(m$12473=temp$12452[$index$12464]);(t0$12478=m$12473);if(((t0$12478 instanceof Array)&&(((t1$12479=t0$12478.length)),(t1$12479===2)))){(name$12483=t0$12478[0]);(descrs$12484=t0$12478[1]);acc$12446.push($15258((((acc$12502=[])),(((temp$12508=descrs$12484)),((($length$12514=temp$12508.length)),((($index$12520=0)),function(){$12497:for(;($index$12520<$length$12514);($index$12520++)){var descr$12537;var m$12529;(m$12529=temp$12508[$index$12520]);(descr$12537=m$12529);acc$12502.push(parse_op_description$12234(descr$12537));}}()))),acc$12502)));}else{$14963(m$12473,"/home/olivier/git/earl-grey/src/parse.eg",582,679);}}}()))),acc$12446));(it$0$12360["fns"]=[]);(it$0$12360["to_gid"]=({"IFX":({"wide":({}),"short":({})}),"PFX":({"wide":({}),"short":({})}),"SFX":({"wide":({}),"short":({})})}));(acc$12551=[]);(temp$12557=$15215(it$0$12360.groups));($length$12563=temp$12557.length);($index$12569=0);$12373:for(;($index$12569<$length$12563);($index$12569++)){var $index$12626;var $length$12620;var temp$12614;var acc$12608;var i$12588;var group$12589;var t0$12583;var t1$12584;var m$12578;(m$12578=temp$12557[$index$12569]);(t0$12583=m$12578);if(((t0$12583 instanceof Array)&&(((t1$12584=t0$12583.length)),(t1$12584===2)))){(i$12588=t0$12583[0]);(group$12589=t0$12583[1]);acc$12551.push((((acc$12608=[])),(((temp$12614=group$12589)),((($length$12620=temp$12614.length)),((($index$12626=0)),function(){$12602:for(;($index$12626<$length$12620);($index$12626++)){var f$12666;var fixity$12645;var width$12646;var name$12647;var t0$12640;var t1$12641;var m$12635;(m$12635=temp$12614[$index$12626]);(t0$12640=m$12635);if(((t0$12640 instanceof Array)&&(((t1$12641=t0$12640.length)),(t1$12641===3)))){(fixity$12645=t0$12640[0]);(width$12646=t0$12640[1]);(name$12647=t0$12640[2]);acc$12608.push((($12148($12148(it$0$12360.to_gid,fixity$12645),width$12646)[name$12647]=i$12588)));}else{(f$12666=m$12635);acc$12608.push(it$0$12360.fns.push([f$12666,i$12588]));}}}()))),acc$12608));}else{$14963(m$12578,"/home/olivier/git/earl-grey/src/parse.eg",844,1045);}}acc$12551;return it$0$12360;});(OperatorGroups$12233.prototype["get_name"]=function(o$12676){var it$0$12680;var self$12681;(it$0$12680=this);(self$12681=this);return $12148(it$0$12680.gnames,it$0$12680.get(o$12676));});(OperatorGroups$12233.prototype["get"]=function($12692$12695){var t0$12713;var t1$12714;var $index$12752;var $length$12746;var temp$12740;var attempt$12729;var o$12708;var fixity$12709;var width$12710;var name$12711;var it$0$12699;var self$12700;(it$0$12699=this);(self$12700=this);(t0$12713=$12692$12695);(o$12708=t0$12713);if(((t0$12713 instanceof Array)&&(((t1$12714=t0$12713.length)),(t1$12714===3)))){(fixity$12709=t0$12713[0]);(width$12710=t0$12713[1]);(name$12711=t0$12713[2]);}else{$14963($12692$12695);}(attempt$12729=$12148($12148($12148(it$0$12699.to_gid,fixity$12709),width$12710),name$12711));if((attempt$12729===(void 0))){(temp$12740=it$0$12699.fns);($length$12746=temp$12740.length);($index$12752=0);$12734:for(;($index$12752<$length$12746);($index$12752++)){var f$12771;var i$12772;var t0$12766;var t1$12767;var m$12761;(m$12761=temp$12740[$index$12752]);(t0$12766=m$12761);if(((t0$12766 instanceof Array)&&(((t1$12767=t0$12766.length)),(t1$12767===2)))){(f$12771=t0$12766[0]);(i$12772=t0$12766[1]);if(f$12771(o$12708)){return i$12772;}}else{$14963(m$12761,"/home/olivier/git/earl-grey/src/parse.eg",1224,1307);}}throw $14982(["syntax","unknown_operator"]).create(("Unknown operator: "+[true,String(o$12708)][1]),({"operator":o$12708}));}else{return attempt$12729;}});$12149(OperatorGroups$12233,$12149(((accum$12790=({})),((accum$12790["::name"]="OperatorGroups"),accum$12790)),((accum$12794=({})),((accum$12794["::egclass"]=true),accum$12794))));OperatorGroups$12233;(parse_op_description$12234=function($12800$12803){var otherwise$12893;var $12873$12882;var $12869$12876;var otherwise$12927;var $12907$12916;var $12903$12910;var t0$12863;var t1$12864;var fixity$12860;var short$12861;var other$12931;var x$12837;var w1$12838;var op$12839;var w2$12840;var y$12841;var f$12832;var rx$12826;var t0$12820;var t1$12821;var t2$12822;var $12805$12815;var ph$12809;(ph$12809=$12800$12803);($12805$12815=ph$12809);(rx$12826=RegExp("(?:^((?:X?))((?:[ _]?))((?:[^ _Y]*))((?:[ _]?))((?:Y?))$)",""));if($12129(Function)($12805$12815)){(f$12832=$12805$12815);return f$12832;}else{(t0$12820=$15310(rx$12826)($12805$12815));if((t0$12820[0]&&(((t1$12821=t0$12820[1])),(((t2$12822=t1$12821.length)),(t2$12822===6))))){t1$12821[0];(x$12837=t1$12821[1]);(w1$12838=t1$12821[2]);(op$12839=t1$12821[3]);(w2$12840=t1$12821[4]);(y$12841=t1$12821[5]);(t0$12863=((($12869$12876=null)),($12869$12876,function(){if((x$12837==="")){return ["PFX",(w2$12840==="")];}else{if((y$12841==="")){return ["SFX",(w1$12838==="")];}else{(otherwise$12893=$12869$12876);return ["IFX",((w1$12838==="")||(w2$12840===""))];}}}())));if(((t0$12863 instanceof Array)&&(((t1$12864=t0$12863.length)),(t1$12864===2)))){(fixity$12860=t0$12863[0]);(short$12861=t0$12863[1]);}else{$14963(((($12903$12910=null)),($12903$12910,function(){if((x$12837==="")){return ["PFX",(w2$12840==="")];}else{if((y$12841==="")){return ["SFX",(w1$12838==="")];}else{(otherwise$12927=$12903$12910);return ["IFX",((w1$12838==="")||(w2$12840===""))];}}}())),"/home/olivier/git/earl-grey/src/parse.eg",1678,1896);}if(((w1$12838==="_")||(w2$12840==="_"))){return [[fixity$12860,"short",op$12839],[fixity$12860,"wide",op$12839]];}else{return [[fixity$12860,function(){if(short$12861){return "short";}else{return "wide";}}(),op$12839]];}}else{(other$12931=$12805$12815);throw $14982(["invalid_op_description"]).create(("Invalid operator description: "+other$12931));}}});(eg_groups$12235=OperatorGroups$12233($12149(({"tokenpfx":[".Y","#Y","@Y"],"sjuxt":["XWHITEY"],"ifx":[function($12938$12941){var t0$12957;var $12943$12952;var ph$12946;(ph$12946=$12938$12941);($12943$12952=ph$12946);if((($12943$12952 instanceof Array)&&(((t0$12957=$12943$12952.length)),((t0$12957===3)&&(($12943$12952[0]==="IFX")&&($12943$12952[1]==="short")))))){$12943$12952[2];return true;}else{$12943$12952;return false;}}],"pfx":[function($12972$12975){var t0$12991;var $12977$12986;var ph$12980;(ph$12980=$12972$12975);($12977$12986=ph$12980);if((($12977$12986 instanceof Array)&&(((t0$12991=$12977$12986.length)),((t0$12991===3)&&(($12977$12986[0]==="PFX")&&($12977$12986[1]==="short")))))){$12977$12986[2];return true;}else{$12977$12986;return false;}}],"sfx":[function($13006$13009){var t0$13025;var $13011$13020;var ph$13014;(ph$13014=$13006$13009);($13011$13020=ph$13014);if((($13011$13020 instanceof Array)&&(((t0$13025=$13011$13020.length)),((t0$13025===3)&&(($13011$13020[0]==="SFX")&&($13011$13020[1]==="short")))))){$13011$13020[2];return true;}else{$13011$13020;return false;}}],"pow":["X ** Y"],"mul":["X * Y","X / Y","X // Y","X mod Y","+ Y","- Y"],"add":["X + Y","X - Y"],"cmp":["X < Y","X <= Y","X == Y","X > Y","X >= Y","X != Y"],"cat":["X ++ Y"],"union":["X & Y"],"range":["X .. Y","X ..",".. Y"],"in":["X in Y"],"wjuxt":["X WHITE Y"],"colon":["X_:_Y"],"and":"X and Y","or":"X or Y","not":"not Y"}),$12149(((accum$13040=({})),((accum$13040["with"]=["X with Y"]),accum$13040)),({"decl":["X -> Y","X = Y","X := Y","X => Y","X where Y","X when Y","X each Y"],"brack":["X_,_Y","(_Y","[_Y","{_Y","X_)","X_]","X_}"],"custom":[function(x$13045){return true;}]})))));(SimplePriority$12236=function(groups$13052,priorities$13053){var $index$13103;var $length$13097;var temp$13091;var acc$13085;var _i$13067;var tracks$13068;var it$0$13056;(it$0$13056=function(){if((!$12129(SimplePriority$12236)(this))){return Object.create(SimplePriority$12236.prototype);}else{return this;}}());(it$0$13056["groups"]=groups$13052);(_i$13067=0);(tracks$13068=({}));(it$0$13056["prio"]=(((acc$13085=[])),(((temp$13091=groups$13052.gnames)),((($length$13097=temp$13091.length)),((($index$13103=0)),function(){$13080:for(;($index$13103<$length$13097);($index$13103++)){var t0$13133;var t1$13134;var t2$13135;var t3$13136;var t4$13137;var t5$13138;var t6$13139;var t7$13140;var $index$13215;var $length$13209;var temp$13203;var acc$13197;var $index$13337;var $length$13331;var temp$13325;var acc$13319;var t0$13186;var t1$13187;var ltracks$13126;var lp$13127;var rtracks$13128;var rp$13129;var lt$13130;var rt$13131;var name$13120;var m$13112;(m$13112=temp$13091[$index$13103]);(name$13120=m$13112);acc$13085.push(((((t0$13133=$12148(priorities$13053,name$13120))),function(){if(((t0$13133 instanceof Array)&&(((t1$13134=t0$13133.length)),((t1$13134===2)&&(((t2$13135=t0$13133[0])),((t2$13135 instanceof Array)&&(((t3$13136=t2$13135.length)),((t3$13136===2)&&(((t4$13137=$15310(Array)(t2$13135[0]))),(t4$13137[0]&&((ltracks$13126=t4$13137[1]),((lp$13127=t2$13135[1]),(((t5$13138=t0$13133[1])),((t5$13138 instanceof Array)&&(((t6$13139=t5$13138.length)),((t6$13139===2)&&(((t7$13140=$15310(Array)(t5$13138[0]))),t7$13140[0]))))))))))))))))){(rtracks$13128=t7$13140[1]);(rp$13129=t5$13138[1]);}else{return $14963($12148(priorities$13053,name$13120),"/home/olivier/git/earl-grey/src/parse.eg",3581,3607);}}()),(((t0$13186=(((acc$13197=[])),(((temp$13203=[ltracks$13126,rtracks$13128])),((($length$13209=temp$13203.length)),((($index$13215=0)),function(){$13192:for(;($index$13215<$length$13209);($index$13215++)){var $index$13261;var $length$13255;var temp$13249;var rval$13237;var tr$13232;var m$13224;(m$13224=temp$13203[$index$13215]);(tr$13232=m$13224);acc$13197.push((((rval$13237=0)),(((temp$13249=tr$13232)),((($length$13255=temp$13249.length)),((($index$13261=0)),function(){$13238:for(;($index$13261<$length$13255);($index$13261++)){var t$13300;var t$13286;var m$13270;(m$13270=temp$13249[$index$13261]);if((m$13270==="all")){(rval$13237=(Math.pow(2,31)-1));}else{(t$13286=m$13270);if((!$12148(tracks$13068,t$13286))){(rval$13237=(rval$13237|Math.pow(2,_i$13067)));(tracks$13068[t$13286]=(_i$13067++));}else{(t$13300=m$13270);(rval$13237=(rval$13237|Math.pow(2,$12148(tracks$13068,t$13300))));}}}}()))),rval$13237));}}()))),acc$13197))),function(){if(((t0$13186 instanceof Array)&&(((t1$13187=t0$13186.length)),(t1$13187===2)))){(lt$13130=t0$13186[0]);(rt$13131=t0$13186[1]);}else{return $14963((((acc$13319=[])),(((temp$13325=[ltracks$13126,rtracks$13128])),((($length$13331=temp$13325.length)),((($index$13337=0)),function(){$13314:for(;($index$13337<$length$13331);($index$13337++)){var $index$13383;var $length$13377;var temp$13371;var rval$13359;var tr$13354;var m$13346;(m$13346=temp$13325[$index$13337]);(tr$13354=m$13346);acc$13319.push((((rval$13359=0)),(((temp$13371=tr$13354)),((($length$13377=temp$13371.length)),((($index$13383=0)),function(){$13360:for(;($index$13383<$length$13377);($index$13383++)){var t$13422;var t$13408;var m$13392;(m$13392=temp$13371[$index$13383]);if((m$13392==="all")){(rval$13359=(Math.pow(2,31)-1));}else{(t$13408=m$13392);if((!$12148(tracks$13068,t$13408))){(rval$13359=(rval$13359|Math.pow(2,_i$13067)));(tracks$13068[t$13408]=(_i$13067++));}else{(t$13422=m$13392);(rval$13359=(rval$13359|Math.pow(2,$12148(tracks$13068,t$13422))));}}}}()))),rval$13359));}}()))),acc$13319),"/home/olivier/git/earl-grey/src/parse.eg",3617,3938);}}()),[[lt$13130,lp$13127],[rt$13131,rp$13129]]));}}()))),acc$13085));return it$0$13056;});(SimplePriority$12236.prototype["compare"]=function(op1$13434,op2$13435){var t0$13472;var t1$13473;var t2$13474;var t3$13475;var t0$13500;var t1$13501;var t2$13502;var t3$13503;var $13458$13534;var $13453$13528;var i1$13459;var i2$13460;var code1$13461;var ord1$13462;var code2$13463;var ord2$13464;var it$0$13439;var self$13440;(it$0$13439=this);(self$13440=this);(i1$13459=it$0$13439.groups.get(op1$13434));(i2$13460=it$0$13439.groups.get(op2$13435));(t0$13472=$12148(it$0$13439.prio,i1$13459));if(((t0$13472 instanceof Array)&&(((t1$13473=t0$13472.length)),((t1$13473===2)&&(t0$13472[0],(((t2$13474=t0$13472[1])),((t2$13474 instanceof Array)&&(((t3$13475=t2$13474.length)),(t3$13475===2))))))))){(code1$13461=t2$13474[0]);(ord1$13462=t2$13474[1]);}else{$14963($12148(it$0$13439.prio,i1$13459),"/home/olivier/git/earl-grey/src/parse.eg",4065,4082);}(t0$13500=$12148(it$0$13439.prio,i2$13460));if(((t0$13500 instanceof Array)&&(((t1$13501=t0$13500.length)),((t1$13501===2)&&(((t2$13502=t0$13500[0])),((t2$13502 instanceof Array)&&(((t3$13503=t2$13502.length)),(t3$13503===2)))))))){(code2$13463=t2$13502[0]);(ord2$13464=t2$13502[1]);t0$13500[1];}else{$14963($12148(it$0$13439.prio,i2$13460),"/home/olivier/git/earl-grey/src/parse.eg",4102,4119);}($13453$13528=null);$13453$13528;if(((code1$13461&code2$13463)===0)){throw $14982(["syntax","order"]).create("Cannot mix operators in the given order",({"left":op1$13434,"right":op2$13435}));}else{if((ord1$13462>ord2$13464)){return LEFT$12241;}else{if((ord1$13462<ord2$13464)){return RIGHT$12242;}else{if((ord1$13462===ord2$13464)){return BOTH$12243;}else{$14963($13453$13528);}}}}});$12149(SimplePriority$12236,$12149(((accum$13556=({})),((accum$13556["::name"]="SimplePriority"),accum$13556)),((accum$13560=({})),((accum$13560["::egclass"]=true),accum$13560))));SimplePriority$12236;(MAX$12237=(1/0));(eg_order$12238=(((eg_groups$13571=OperatorGroups$12233($12149(({"sh_ifx":[function($13581$13584){var t0$13600;var $13586$13595;var ph$13589;(ph$13589=$13581$13584);($13586$13595=ph$13589);if((($13586$13595 instanceof Array)&&(((t0$13600=$13586$13595.length)),((t0$13600===3)&&(($13586$13595[0]==="IFX")&&($13586$13595[1]==="short")))))){$13586$13595[2];return true;}else{$13586$13595;return false;}}],"sh_pfx":[function($13615$13618){var t0$13634;var $13620$13629;var ph$13623;(ph$13623=$13615$13618);($13620$13629=ph$13623);if((($13620$13629 instanceof Array)&&(((t0$13634=$13620$13629.length)),((t0$13634===3)&&(($13620$13629[0]==="PFX")&&($13620$13629[1]==="short")))))){$13620$13629[2];return true;}else{$13620$13629;return false;}}],"sh_sfx":[function($13649$13652){var t0$13668;var $13654$13663;var ph$13657;(ph$13657=$13649$13652);($13654$13663=ph$13657);if((($13654$13663 instanceof Array)&&(((t0$13668=$13654$13663.length)),((t0$13668===3)&&(($13654$13663[0]==="SFX")&&($13654$13663[1]==="short")))))){$13654$13663[2];return true;}else{$13654$13663;return false;}}],"wi_ifx":[function($13683$13686){var t0$13702;var $13688$13697;var ph$13691;(ph$13691=$13683$13686);($13688$13697=ph$13691);if((($13688$13697 instanceof Array)&&(((t0$13702=$13688$13697.length)),((t0$13702===3)&&(($13688$13697[0]==="IFX")&&($13688$13697[1]==="wide")))))){$13688$13697[2];return true;}else{$13688$13697;return false;}}],"wi_pfx":[function($13717$13720){var t0$13736;var $13722$13731;var ph$13725;(ph$13725=$13717$13720);($13722$13731=ph$13725);if((($13722$13731 instanceof Array)&&(((t0$13736=$13722$13731.length)),((t0$13736===3)&&(($13722$13731[0]==="PFX")&&($13722$13731[1]==="wide")))))){$13722$13731[2];return true;}else{$13722$13731;return false;}}],"wi_sfx":[function($13751$13754){var t0$13770;var $13756$13765;var ph$13759;(ph$13759=$13751$13754);($13756$13765=ph$13759);if((($13756$13765 instanceof Array)&&(((t0$13770=$13756$13765.length)),((t0$13770===3)&&(($13756$13765[0]==="SFX")&&($13756$13765[1]==="wide")))))){$13756$13765[2];return true;}else{$13756$13765;return false;}}],"comma":["X_,_Y"],"obrack":["(_Y","[_Y","{_Y"],"cbrack":["X_)","X_]","X_}"]}),$12149(((accum$13785=({})),((accum$13785["with"]=["X with Y"]),accum$13785)),$12149(({"lowprio":["X each Y","X each? Y","X where Y","X !! Y","X -> Y","X => Y","X = Y","X := Y","X += Y","X -= Y","X *= Y","X /= Y","X <<= Y","X >>= Y","X >>>= Y","X ++= Y","X ?= Y","X or= Y","X and= Y","X each= Y","X % Y"]}),$12149(((accum$13789=({})),((accum$13789["when"]=["X when Y"]),accum$13789)),$12149(((accum$13793=({})),((accum$13793["or"]=["X or Y"]),accum$13793)),$12149(((accum$13797=({})),((accum$13797["and"]=["X and Y"]),accum$13797)),$12149(((accum$13801=({})),((accum$13801["not"]=["not Y"]),accum$13801)),({"cmp":["X == Y","X != Y","X >= Y","X <= Y","X > Y","X < Y"],"binxor":["X ^. Y"],"binor":["X |. Y"],"binand":["X &. Y"],"shift":["X << Y","X >> Y","X >>> Y"],"add":["X + Y","X - Y"],"mul":["X * Y","X / Y","X // Y","X mod Y"],"exp":["X ** Y"],"sjuxt":["XWHITEY"],"wjuxt":["X WHITE Y"],"colon":["X_:_Y"],"pfx":["._Y","#_Y","@_Y"],"when2":["when Y"],"pp":["<> Y"],"pipe":["X |> Y"]}))))))))))),((eg_prio$13572=$12149(({"comma":[["all",1],["all",1]],"obrack":[["all",MAX$12237],["all",1]],"cbrack":[["all",1],["all",MAX$12237]]}),$12149(((accum$13813=({})),((accum$13813["with"]=[["all",1999],["all",10]]),accum$13813)),$12149(({"lowprio":[["all",11],["all",10]]}),$12149(((accum$13817=({})),((accum$13817["when"]=[["all",100],["all",101]]),accum$13817)),$12149(((accum$13821=({})),((accum$13821["or"]=[["all",110],["all",111]]),accum$13821)),$12149(((accum$13825=({})),((accum$13825["and"]=[["all",120],["all",121]]),accum$13825)),$12149(((accum$13829=({})),((accum$13829["not"]=[["all",MAX$12237],["all",131]]),accum$13829)),({"cmp":[["all",200],["all",201]],"binxor":[["all",400],["all",401]],"binor":[["all",410],["all",411]],"binand":[["all",420],["all",421]],"shift":[["arith",500],["arith",501]],"add":[["arith",550],["arith",551]],"mul":[["arith",560],["arith",561]],"exp":[["arith",571],["arith",570]],"wjuxt":[["wjuxt",13],["all",12]],"colon":[["all",12],["all",10]],"sjuxt":[["all",2000],["all",2001]],"pfx":[["all",MAX$12237],["all",3000]],"pp":[["all",MAX$12237],["all",5]],"when2":[["all",MAX$12237],["all",101]],"pipe":[["pipe",550],["pipe",551]],"sh_ifx":[["all",1800],["all",1801]],"sh_pfx":[["all",MAX$12237],["all",1901]],"sh_sfx":[["all",1900],["all",MAX$12237]],"wi_ifx":[["customl",900],["customr",901]],"wi_pfx":[["all",MAX$12237],["all",901]],"wi_sfx":[["all",900],["all",MAX$12237]]})))))))))),SimplePriority$12236(eg_groups$13571,eg_prio$13572)));(DONE$12239=-1);(NONE$12240=0);(LEFT$12241=1);(RIGHT$12242=2);(BOTH$12243=3);(oparse$12244=function(next$13853,order$13854,finalize$13855){var between$13863;var right_op$13864;var stack$13865;var left_op$13866;var current$13867;(between$13863=finalize$13855(next$13853()));(right_op$13864=next$13853());(stack$13865=[]);(left_op$13866=null);(current$13867=null);$13868:while(true){var v$13919;var other$13972;var $13888$13900;var o$13894;(o$13894=function(){if(((!left_op$13866)&&(!right_op$13864))){return DONE$12239;}else{return ((((!left_op$13866)&&RIGHT$12242)||((!right_op$13864)&&LEFT$12241))||order$13854(left_op$13866,right_op$13864));}}());($13888$13900=o$13894);if(($13888$13900===DONE$12239)){return between$13863;}else{if(($13888$13900===LEFT$12241)){current$13867.push(between$13863);(between$13863=finalize$13855(current$13867));(v$13919=stack$13865.pop());(left_op$13866=v$13919[0]);(current$13867=v$13919[1]);}else{if(($13888$13900===RIGHT$12242)){stack$13865.push([left_op$13866,current$13867]);(left_op$13866=right_op$13864);(current$13867=[[right_op$13864],between$13863]);(between$13863=finalize$13855(next$13853()));(right_op$13864=next$13853());}else{if(($13888$13900===BOTH$12243)){current$13867[0].push(right_op$13864);current$13867.push(between$13863);(left_op$13866=right_op$13864);(between$13863=finalize$13855(next$13853()));(right_op$13864=next$13853());}else{(other$13972=$13888$13900);throw $14982(["should_never_happen"]).create("undefined priority",({"left":left_op$13866,"right":right_op$13864}));}}}}}});(finalize$12245=function($13978$13981){var t0$13996;var $index$14101;var $length$14095;var temp$14089;var $index$14139;var $length$14133;var temp$14127;var $index$14190;var $length$14184;var temp$14178;var acc$14172;var other$14552;var args$14547;var f$14523;var orig_args$14524;var args$14525;var $14493$14506;var $14494$14507;var t0$14502;var t1$14503;var t2$14504;var $14487$14497;var inserted$14329;var result$14330;var t0$14564;var f$14591;var other$14672;var x$14661;var $14637$14648;var $14638$14649;var t0$14646;var $14633$14641;var result$14581;var f$14698;var oloc$14803;var abloc$14804;var oabloc$14805;var rval$14806;var a$14793;var b$14794;var $14062$14754;var $14063$14755;var $14064$14756;var $14065$14757;var t0$14747;var t1$14748;var t2$14749;var t3$14750;var t4$14751;var t5$14752;var $index$14860;var $length$14854;var temp$14848;var acc$14842;var tokens$14833;var msg$14834;var op_strings$14826;var args$14827;var $14059$14743;var commas$14677;var commas$14556;var target$14289;var _b$14290;var body$14291;var f$14273;var body$14274;var f$14241;var arg$14242;var body$14243;var $14067$14232;var $14068$14233;var $14069$14234;var $14070$14235;var $14071$14236;var $14072$14237;var $14073$14238;var t0$14221;var t1$14222;var t2$14223;var t3$14224;var t4$14225;var t5$14226;var t6$14227;var t7$14228;var t8$14229;var bridge$14055$14230;var $14050$14216;var sumloc$14074;var orig_ops$14075;var op$14076;var other$14903;var ops$14041;var args$14042;var value$14032;var value$14027;var value$14017;var $13990$14012;var $13991$14013;var $13992$14014;var t0$14010;var $13983$14005;var ph$13993;var token$13994;(t0$13996=$13978$13981);(token$13994=t0$13996);(ph$13993=t0$13996);($13983$14005=ph$13993);if((($13990$14012=($13983$14005 instanceof Array))&&(((t0$14010=$13983$14005.length)),(($13992$14014=(t0$14010===2))&&($13983$14005[0]==="ID"))))){(value$14017=$13983$14005[1]);return __lt____lt____colon__$12230(["symbol",value$14017],token$13994);}else{if(($13992$14014&&($13983$14005[0]==="NUM"))){(value$14027=$13983$14005[1]);return __lt____lt____colon__$12230(["value",value$14027],token$13994);}else{if(($13992$14014&&($13983$14005[0]==="STR"))){(value$14032=$13983$14005[1]);return __lt____lt____colon__$12230(["value",value$14032],token$13994);}else{if(($13990$14012&&((t0$14010===1)&&($13983$14005[0]==="VOID")))){return __lt____lt____colon__$12230(["void"],token$13994);}else{if(($13990$14012&&(t0$14010>=1))){(ops$14041=$13983$14005[0]);(args$14042=Array.prototype.slice.call($13983$14005,1));(sumloc$14074=ops$14041[0].location);(temp$14089=ops$14041.slice(1));($length$14095=temp$14089.length);($index$14101=0);$14077:for(;($index$14101<$length$14095);($index$14101++)){var op$14118;var m$14110;(m$14110=temp$14089[$index$14101]);(op$14118=m$14110);(sumloc$14074=__plus____plus____colon__$12231(sumloc$14074,op$14118));}(temp$14127=args$14042);($length$14133=temp$14127.length);($index$14139=0);$14080:for(;($index$14139<$length$14133);($index$14139++)){var arg$14156;var m$14148;(m$14148=temp$14127[$index$14139]);(arg$14156=m$14148);(sumloc$14074=__plus____plus____colon__$12231(sumloc$14074,arg$14156));}(orig_ops$14075=ops$14041);(ops$14041=(((acc$14172=[])),(((temp$14178=ops$14041)),((($length$14184=temp$14178.length)),((($index$14190=0)),function(){$14167:for(;($index$14190<$length$14184);($index$14190++)){var o$14207;var m$14199;(m$14199=temp$14178[$index$14190]);(o$14207=m$14199);acc$14172.push(o$14207[2]);}}()))),acc$14172));(op$14076=ops$14041[0]);($14050$14216=[ops$14041,args$14042]);if((($14067$14232=($14050$14216 instanceof Array))&&(((t0$14221=$14050$14216.length)),(($14069$14234=(t0$14221===2))&&(((t1$14222=$14050$14216[0])),(($14071$14236=(t1$14222 instanceof Array))&&(((t2$14223=t1$14222.length)),((t2$14223===2)&&((t1$14222[0]==="WHITE")&&((t1$14222[1]===":")&&(((t3$14224=$14050$14216[1])),((t3$14224 instanceof Array)&&(((t4$14225=t3$14224.length)),(t4$14225===3)))))))))))))){(f$14241=t3$14224[0]);(arg$14242=t3$14224[1]);(body$14243=t3$14224[2]);return __lt____lt____colon__$12230(["send",f$14241,__lt____lt____colon__$12230(["data",arg$14242,body$14243],__plus____plus____colon__$12231(arg$14242,body$14243))],sumloc$14074);}else{if(($14071$14236&&(($14073$14238=(t2$14223===1))&&((t1$14222[0]===":")&&(((t3$14224=$14050$14216[1])),((t3$14224 instanceof Array)&&(((t4$14225=t3$14224.length)),(t4$14225===2)))))))){(f$14273=t3$14224[0]);(body$14274=t3$14224[1]);return __lt____lt____colon__$12230(["send",f$14273,__lt____lt____colon__$12230(["data",body$14274],body$14274)],sumloc$14074);}else{if(($14073$14238&&((t1$14222[0]==="with")&&(((t3$14224=$14050$14216[1])),((t3$14224 instanceof Array)&&(((t4$14225=t3$14224.length)),((t4$14225===2)&&((target$14289=t3$14224[0]),(((t5$14226=t3$14224[1])),((_b$14290=t5$14226),(((t6$14227=$15310(["multi"])(t5$14226))),(t6$14227[0]&&(((t7$14228=t6$14227[1])),(((t8$14229=t7$14228.length)),(t8$14229>=0))))))))))))))){(body$14291=Array.prototype.slice.call(t7$14228,0));(inserted$14329=false);(result$14330=transform$12232(target$14289,function($14337$14340){var t0$14349;var $index$14445;var $length$14439;var temp$14433;var tr$14418;var res$14419;var args$14407;var x$14383;var f$14384;var a$14385;var b$14386;var t0$14363;var t1$14364;var t2$14365;var $14342$14358;var ph$14346;var expr$14347;(t0$14349=$14337$14340);(expr$14347=t0$14349);(ph$14346=t0$14349);($14342$14358=ph$14346);if((($14342$14358 instanceof Array)&&(((t0$14363=$14342$14358.length)),((t0$14363===2)&&(($14342$14358[0]==="symbol")&&($14342$14358[1]==="...")))))){(inserted$14329=true);return __lt____lt____colon__$12230(["multi"].concat(body$14291),_b$14290);}else{(x$14383=$14342$14358);if((x$14383.fromop&&(($14342$14358 instanceof Array)&&(((t0$14363=$14342$14358.length)),((t0$14363===3)&&(($14342$14358[0]==="send")&&((f$14384=$14342$14358[1]),(((t1$14364=$14342$14358[2])),((t1$14364 instanceof Array)&&(((t2$14365=t1$14364.length)),((t2$14365===3)&&(t1$14364[0]==="data")))))))))))){(a$14385=t1$14364[1]);(b$14386=t1$14364[2]);return ["send",this(f$14384),__lt____lt____colon__$12230(["data",this(a$14385),this(b$14386)],__plus____plus____colon__$12231(a$14385,b$14386))];}else{if((($14342$14358 instanceof Array)&&(((t0$14363=$14342$14358.length)),((t0$14363>=1)&&($14342$14358[0]==="data"))))){(args$14407=Array.prototype.slice.call($14342$14358,1));(tr$14418=this);(res$14419=["data"]);(temp$14433=args$14407);($length$14439=temp$14433.length);($index$14445=0);$14420:for(;($index$14445<$length$14439);($index$14445++)){var other$14482;var t0$14459;var t1$14460;var m$14454;(m$14454=temp$14433[$index$14445]);(t0$14459=m$14454);if(((t0$14459 instanceof Array)&&(((t1$14460=t0$14459.length)),((t1$14460===2)&&((t0$14459[0]==="symbol")&&(t0$14459[1]==="...")))))){(inserted$14329=true);(res$14419=res$14419.concat(body$14291));}else{(other$14482=m$14454);res$14419.push(__lt____lt____colon__$12230(tr$14418(other$14482),other$14482));}}return __lt____lt____colon__$12230(res$14419,expr$14347);}else{$14963($14342$14358);}}}}));if((!inserted$14329)){($14487$14497=target$14289);if((($14487$14497 instanceof Array)&&(((t0$14502=$14487$14497.length)),((t0$14502===1)&&($14487$14497[0]==="void"))))){return __lt____lt____colon__$12230(["data"].concat(body$14291),sumloc$14074);}else{$14487$14497;if(target$14289.fromop){return __lt____lt____colon__$12230(["send",target$14289,__lt____lt____colon__$12230(["data"].concat(body$14291),_b$14290)],sumloc$14074);}else{if((($14493$14506=($14487$14497 instanceof Array))&&(((t0$14502=$14487$14497.length)),((t0$14502===3)&&(($14487$14497[0]==="send")&&((f$14523=$14487$14497[1]),(((t1$14503=$14487$14497[2])),((orig_args$14524=t1$14503),((t1$14503 instanceof Array)&&(((t2$14504=t1$14503.length)),((t2$14504>=1)&&(t1$14503[0]==="data")))))))))))){(args$14525=Array.prototype.slice.call(t1$14503,1));return __lt____lt____colon__$12230(["send",f$14523,__lt____lt____colon__$12230(["data"].concat(args$14525).concat(body$14291),__plus____plus____colon__$12231(orig_args$14524,_b$14290))],sumloc$14074);}else{if(($14493$14506&&((t0$14502>=1)&&($14487$14497[0]==="data")))){(args$14547=Array.prototype.slice.call($14487$14497,1));return __lt____lt____colon__$12230(target$14289.concat(body$14291),sumloc$14074);}else{(other$14552=$14487$14497);return __lt____lt____colon__$12230(["send",target$14289,__lt____lt____colon__$12230(["data"].concat(body$14291),_b$14290)],sumloc$14074);}}}}}else{return __lt____lt____colon__$12230(result$14330,sumloc$14074);}}else{if(($14069$14234&&(((bridge$14055$14230=$14050$14216[0])),((((bridge$14055$14230 instanceof Array)&&(((t0$14564=bridge$14055$14230.length)),((t0$14564>=2)&&((bridge$14055$14230[0]==="[")&&((commas$14556=Array.prototype.slice.call(bridge$14055$14230,1,-1)),(bridge$14055$14230[(t0$14564-1)]==="]"))))))||((commas$14556=bridge$14055$14230),true))&&($14050$14216[1],commas$14556.every(function(x$14575){return $15357(x$14575,",");})))))){if((op$14076==="[")){(args$14042=args$14042.slice(1,-1));}(args$14042=(((f$14591=function($14595$14598){var other$14627;var t0$14614;var $14600$14609;var ph$14603;(ph$14603=$14595$14598);($14600$14609=ph$14603);if((($14600$14609 instanceof Array)&&(((t0$14614=$14600$14609.length)),((t0$14614===1)&&($14600$14609[0]==="void"))))){return false;}else{(other$14627=$14600$14609);return true;}})),args$14042.filter(f$14591)));(result$14581=((($14633$14641=args$14042)),function(){if((($14637$14648=($14633$14641 instanceof Array))&&(((t0$14646=$14633$14641.length)),(t0$14646===0)))){return ["multi"];}else{if(($14637$14648&&(t0$14646===1))){(x$14661=$14633$14641[0]);if(((!isNaN(sumloc$14074.start))&&(!isNaN(sumloc$14074.end)))){(x$14661["location"]=sumloc$14074);}return x$14661;}else{(other$14672=$14633$14641);return ["multi"].concat(args$14042);}}}()));return __lt____lt____colon__$12230(result$14581,sumloc$14074);}else{if(($14069$14234&&(((t1$14222=$14050$14216[0])),(($14071$14236=(t1$14222 instanceof Array))&&(((t2$14223=t1$14222.length)),((t2$14223>=2)&&((t1$14222[0]==="{")&&((commas$14677=Array.prototype.slice.call(t1$14222,1,-1)),((t1$14222[(t2$14223-1)]==="}")&&($14050$14216[1],commas$14677.every(function(x$14693){return $15357(x$14693,",");}))))))))))){(f$14698=function($14702$14705){var other$14734;var t0$14721;var $14707$14716;var ph$14710;(ph$14710=$14702$14705);($14707$14716=ph$14710);if((($14707$14716 instanceof Array)&&(((t0$14721=$14707$14716.length)),((t0$14721===1)&&($14707$14716[0]==="void"))))){return false;}else{(other$14734=$14707$14716);return true;}});return __lt____lt____colon__$12230(["data"].concat(args$14042.slice(1,-1).filter(f$14698)),sumloc$14074);}else{if(($14071$14236&&(($14073$14238=(t2$14223===1))&&(t1$14222[0]==="WHITE")))){$14050$14216[1];return __lt____lt____colon__$12230(["send"].concat(args$14042),sumloc$14074);}else{if($14073$14238){t1$14222[0];($14059$14743=$14050$14216[1]);(t0$14747=$14059$14743);if((($14063$14755=(t0$14747 instanceof Array))&&(((t1$14748=t0$14747.length)),(($14065$14757=(t1$14748===2))&&(((t2$14749=t0$14747[0])),((t2$14749 instanceof Array)&&(((t3$14750=t2$14749.length)),((t3$14750===1)&&((t2$14749[0]==="void")&&(((t4$14751=t0$14747[1])),((t4$14751 instanceof Array)&&(((t5$14752=t4$14751.length)),((t5$14752===1)&&(t4$14751[0]==="void")))))))))))))){return __lt____lt____colon__$12230(["symbol",op$14076],orig_ops$14075[0]);}else{if($14065$14757){(a$14793=t0$14747[0]);(b$14794=t0$14747[1]);(oloc$14803=orig_ops$14075[0].location);(abloc$14804=__plus____plus____colon__$12231(a$14793,b$14794));(oabloc$14805=__plus____plus____colon__$12231(orig_ops$14075[0],abloc$14804));(rval$14806=__lt____lt____colon__$12230(["send",__lt____lt____colon__$12230(["symbol",op$14076],oloc$14803),__lt____lt____colon__$12230(["data",a$14793,b$14794],abloc$14804)],__plus____plus____colon__$12231(oloc$14803,abloc$14804)));(rval$14806["fromop"]=true);return rval$14806;}else{$14963($14059$14743,"/home/olivier/git/earl-grey/src/parse.eg",17400,17405);}}}else{if($14069$14234){(op_strings$14826=$14050$14216[0]);(args$14827=$14050$14216[1]);(tokens$14833=$15579((((acc$14842=[])),(((temp$14848=$15215(orig_ops$14075))),((($length$14854=temp$14848.length)),((($index$14860=0)),function(){$14837:for(;($index$14860<$length$14854);($index$14860++)){var i$14879;var op$14880;var t0$14874;var t1$14875;var m$14869;(m$14869=temp$14848[$index$14860]);(t0$14874=m$14869);if(((t0$14874 instanceof Array)&&(((t1$14875=t0$14874.length)),(t1$14875===2)))){(i$14879=t0$14874[0]);(op$14880=t0$14874[1]);acc$14842.push([("token"+String((i$14879+1))),op$14880]);}else{$14963(m$14869,"/home/olivier/git/earl-grey/src/parse.eg",17916,18015);}}}()))),acc$14842)));(msg$14834="Mismatched/missing brackets/tokens");throw $14982(["syntax","mismatch"]).create(msg$14834,tokens$14833);}else{$14963($14050$14216);}}}}}}}}}else{(other$14903=$13983$14005);throw $14982(["should_never_happen"]).create("unknown node (B)",({"node":token$13994}));}}}}}});(parse$12246=function(tokens$14910){var next$14914;(next$14914=function(){return tokens$14910.shift();});return oparse$12244(next$14914,eg_order$12238.compare.bind(eg_order$12238),finalize$12245);});(exports["OperatorGroups"]=OperatorGroups$12233);(exports["SimplePriority"]=SimplePriority$12236);(exports["parse"]=parse$12246);(exports["oparse"]=oparse$12244);(exports["finalize"]=finalize$12245);(exports["DONE"]=DONE$12239);(exports["NONE"]=NONE$12240);(exports["LEFT"]=LEFT$12241);(exports["RIGHT"]=RIGHT$12242);(exports["BOTH"]=BOTH$12243);

},{"./location":11}],14:[function(require,module,exports){
var $15882=function(type$15885){var f$15889;(f$15889=type$15885["::check"]);if((f$15889===(void 0))){return function(value$15895){return (value$15895 instanceof type$15885);};}else{return function(value$15899){return f$15889.call(type$15885,value$15899);};}};
var $15901=(function(o,m){if(typeof(m)==='string'||typeof(m)==='number'){return o[m];}else{return o['::send'](m);}});
var $15902=function(dest$15905,values$15906){var k$15911;(k$15911=null);$15909:for(k$15911 in values$15906){if(values$15906.hasOwnProperty(k$15911)){(dest$15905[k$15911]=values$15906[k$15911]);}}return dest$15905;};
var $15919=function($15921$15924){var ph$15930;(ph$15930=$15921$15924);var $15926$15936;($15926$15936=ph$15930);var bridge$15928$15941;var x$15945;(bridge$15928$15941=$15926$15936);if((((typeof(bridge$15928$15941)==="string")&&((x$15945=bridge$15928$15941),true))||((typeof(bridge$15928$15941)==="number")&&((x$15945=bridge$15928$15941),true)))){return ["value",x$15945];}else{var other$15956;(other$15956=$15926$15936);return other$15956["::serialize_ast"]();}};
var send$15656;(send$15656=function(obj$15663,$15660$15664){var ph$15670;var msg$15671;var t0$15673;(t0$15673=$15660$15664);(msg$15671=t0$15673);(ph$15670=t0$15673);var $15666$15682;($15666$15682=ph$15670);var bridge$15668$15687;(bridge$15668$15687=$15666$15682);if(((typeof(bridge$15668$15687)==="string")||(typeof(bridge$15668$15687)==="number"))){return obj$15663[msg$15671];}else{var other$15699;(other$15699=$15666$15682);return obj$15663["::send"](msg$15671);}});(Array[":::project"]=function($15705$15708){var ph$15713;var value$15714;var t0$15716;(t0$15716=$15705$15708);(value$15714=t0$15716);(ph$15713=t0$15716);var $15710$15725;($15710$15725=ph$15713);if($15882(Array)($15710$15725)){return [true,value$15714];}else{$15710$15725;return [true,[value$15714]];}});(Array.prototype["::check"]=function(value$15743){if((value$15743 instanceof Array)){var i$15749;(i$15749=0);$15746:for(;(i$15749<this.length);(i$15749++)){if(($15901(this,i$15749)!==$15901(value$15743,i$15749))){return false;}}return true;}else{return false;}});(Array.prototype["::clone"]=function(){return $15902(this.slice(0),this);});(Array.prototype[":::project"]=function(value$15768){if((value$15768 instanceof Array)){var i$15774;(i$15774=0);$15771:for(;(i$15774<this.length);(i$15774++)){if(($15901(this,i$15774)!==$15901(value$15768,i$15774))){return [true,[value$15768]];}}return [true,value$15768.slice(this.length)];}else{return [true,[value$15768]];}});(Array.prototype["::serialize_ast"]=function(){return ["array"].concat(this.map($15919));});(RegExp.prototype["::check"]=function($15792$15795){var ph$15800;(ph$15800=$15792$15795);var $15797$15806;($15797$15806=ph$15800);var value$15814;if((typeof($15797$15806)==="string")){(value$15814=$15797$15806);if(value$15814.match(this)){return true;}else{return false;}}else{var other$15819;(other$15819=$15797$15806);return false;}});(RegExp.prototype[":::project"]=function($15825$15828){var ph$15833;(ph$15833=$15825$15828);var $15830$15839;($15830$15839=ph$15833);var value$15847;if((typeof($15830$15839)==="string")){(value$15847=$15830$15839);var $15850$15855;($15850$15855=value$15847.match(this));var m$15863;if(($15850$15855===null)){(m$15863=$15850$15855);return [false,null];}else{var m$15868;(m$15868=$15850$15855);return [true,m$15868];}}else{var other$15872;(other$15872=$15830$15839);return [false,null];}});(Function.prototype["::send"]=function(args$15879){return this.apply(this,args$15879);});
var $19884=function($19886$19889,key$19890){var ph$19898;(ph$19898=$19886$19889);var $19892$19904;($19892$19904=ph$19898);var bridge$19894$19909;(bridge$19894$19909=$19892$19904);if(((bridge$19894$19909===null)||(bridge$19894$19909===(void 0)))){return false;}else{var x$19921;if((typeof($19892$19904)==="string")){(x$19921=$19892$19904);return (key$19890 in String.prototype);}else{var x$19926;if((typeof($19892$19904)==="number")){(x$19926=$19892$19904);return (key$19890 in Number.prototype);}else{var x$19931;(x$19931=$19892$19904);return (key$19890 in x$19931);}}}};
var $20166=function(arr$20169){var results$20175;var l$20176;(results$20175=[]);(l$20176=arr$20169.length);var i$20185;(i$20185=0);$20174:for(;(i$20185<l$20176);(i$20185++)){results$20175.push([i$20185,$15901(arr$20169,i$20185)]);}return results$20175;};
var $20192=function(value$20195,url$20196,start$20197,end$20198){var err$20202;(err$20202=$19933(["match"]).create("Could not find a match for value",({"value":value$20195})));if(url$20196){(err$20202["location"]=["location",url$20196,start$20197,end$20198]);}throw err$20202;};
var $19933=function(){var $19934$19940;($19934$19940=function(tags$19945){var it$0$19948;(it$0$19948=function(){if((!$15882($19934$19940)(this))){return Object.create($19934$19940.prototype);}else{return this;}}());(it$0$19948["tags"]=tags$19945);return it$0$19948;});($19934$19940.prototype["create"]=function(){var it$0$19968;var self$19969;(it$0$19968=this);(self$19969=this);var $19966$19978;($19966$19978=arguments);var t0$19983;var message$19987;var args$19988;(t0$19983=$19966$19978.length);if((t0$19983>=0)){(message$19987=function(){if((0>=t0$19983)){return "";}else{return $19966$19978[0];}}());(args$19988=Array.prototype.slice.call($19966$19978,1));var e$20001;(e$20001=Error(message$19987));(e$20001["::tags"]=it$0$19968.tags);(e$20001["args"]=args$19988);var temp$20017;(temp$20017=$20166(args$19988));var $length$20023;($length$20023=temp$20017.length);var $index$20029;($index$20029=0);$20002:for(;($index$20029<$length$20023);($index$20029++)){var m$20038;(m$20038=temp$20017[$index$20029]);var t0$20043;var t1$20044;var i$20048;var arg$20049;(t0$20043=m$20038);if(((t0$20043 instanceof Array)&&(((t1$20044=t0$20043.length)),(t1$20044===2)))){(i$20048=t0$20043[0]);(arg$20049=t0$20043[1]);(e$20001[i$20048]=arg$20049);}else{$20192(m$20038);}}(e$20001["length"]=args$19988.length);(e$20001["name"]=["E"].concat(it$0$19968.tags).join("."));return e$20001;}else{$20192($19966$19978);}});($19934$19940.prototype["::check"]=function(e$20079){var it$0$20083;var self$20084;(it$0$20083=this);(self$20084=this);var tags$20094;if(((!e$20079)||(!$15882(Error)(e$20079)))){return false;}(tags$20094=(e$20079["::tags"]||[]));var temp$20105;(temp$20105=it$0$20083.tags);var $length$20111;($length$20111=temp$20105.length);var $index$20117;($index$20117=0);$20095:for(;($index$20117<$length$20111);($index$20117++)){var m$20126;(m$20126=temp$20105[$index$20117]);var tag$20134;(tag$20134=m$20126);if((tags$20094.indexOf(tag$20134)===-1)){return false;}else{false;}}return true;});($19934$19940.prototype["::deconstruct"]=function(e$20143){var it$0$20147;var self$20148;(it$0$20147=this);(self$20148=this);return e$20143.args;});$15902($19934$19940,$15902(function(){var accum$20159;(accum$20159=({}));(accum$20159["::name"]="$19934");return accum$20159;}(),function(){var accum$20163;(accum$20163=({}));(accum$20163["::egclass"]=true);return accum$20163;}()));return $19934$19940;}();
var $19800=function($19802$19805){var ph$19815;var x$19816;var t0$19818;(t0$19818=$19802$19805);(x$19816=t0$19818);(ph$19815=t0$19818);var $19807$19827;($19807$19827=ph$19815);var bridge$19809$19832;(bridge$19809$19832=$19807$19827);if((function(){var bridge$19810$19842;(bridge$19810$19842=bridge$19809$19832);return (function(){var bridge$19811$19849;(bridge$19811$19849=bridge$19810$19842);return ((bridge$19811$19849===(void 0))||(bridge$19811$19849===null));}()||(typeof(bridge$19810$19842)==="string"));}()||(typeof(bridge$19809$19832)==="number"))){return x$19816;}else{if($19884($19807$19827,"::clone")){$19807$19827["::clone"];return x$19816["::clone"]();}else{$19807$19827;if((Object.getPrototypeOf(x$19816)===Object.prototype)){var dest$19867;(dest$19867=({}));var k$19872;(k$19872=null);$19866:for(k$19872 in x$19816){if(Object.prototype.hasOwnProperty.call(x$19816,k$19872)){(dest$19867[k$19872]=x$19816[k$19872]);}}return dest$19867;}else{var other$19882;(other$19882=$19807$19827);throw $19933(["clone"]).create("Object cannot be cloned",({"obj":x$19816}));}}}};
var $20211=function(a$20214,b$20215){var dest$20220;(dest$20220=$19800(a$20214));var k$20225;(k$20225=null);$20219:for(k$20225 in b$20215){if(Object.prototype.hasOwnProperty.call(b$20215,k$20225)){(dest$20220[k$20225]=b$20215[k$20225]);}}return dest$20220;};
var $20233=Object.keys;
var $20234=function(type$20237){return function(value$20241){var f$20245;(f$20245=type$20237[":::project"]);if((f$20245===(void 0))){(f$20245=type$20237["::project"]);if((f$20245===(void 0))){return [true,type$20237(value$20241)];}else{var rval$20258;(rval$20258=false);try{(rval$20258=[true,f$20245(value$20241)]);}catch(excv$20269){var e$20275;(e$20275=excv$20269);(rval$20258=[false,null]);}return rval$20258;}}else{return f$20245.call(type$20237,value$20241);}};};
var $20281=function(xs$20284,ys$20285){var acc$20292;(acc$20292=[]);var temp$20298;(temp$20298=$20166(xs$20284));var $length$20304;($length$20304=temp$20298.length);var $index$20310;($index$20310=0);$20287:for(;($index$20310<$length$20304);($index$20310++)){var m$20319;(m$20319=temp$20298[$index$20310]);var t0$20324;var t1$20325;var i$20329;var x$20330;(t0$20324=m$20319);if(((t0$20324 instanceof Array)&&(((t1$20325=t0$20324.length)),(t1$20325===2)))){(i$20329=t0$20324[0]);(x$20330=t0$20324[1]);acc$20292.push([x$20330,$15901(ys$20285,i$20329)]);}else{$20192(m$20319);}}return acc$20292;};
var $20345=function(from$20348,to$20349){var rval$20354;(rval$20354=[]);var i$20360;(i$20360=from$20348);$20353:for(;(i$20360<=to$20349);(i$20360++)){rval$20354.push(i$20360);}return rval$20354;};var accum$16948;var accum$16952;var accum$17737;var accum$17741;var $15960$15994;var __lt____gt__$15995;var $15961$15996;var __lt____lt____colon__$15997;var util$15998;var GenSym$15999;var gensym$16000;var neighbours$16001;var classify$16002;var classify_contiguous$16003;var identity$16004;var $15963$16005;var checker_db$16006;var PatternParser$16007;var PatternProcessor$16008;var assemble_conditions$16009;var assemble_pattern$16010;var inject_below_uses$16011;var parse_pattern$16012;var checkall$16013;var same_block$16014;var parse_clauses$16015;var opt_clauses$16016;var weave_clauses$16017;($15960$15994=require("./pp"));(__lt____gt__$15995=$15960$15994["<>"]);($15961$15996=require("./location"));(__lt____lt____colon__$15997=$15961$15996["<<:"]);(util$15998=require("./util"));(GenSym$15999=util$15998.GenSym);(gensym$16000=util$15998.gensym);(neighbours$16001=util$15998.neighbours);(classify$16002=util$15998.classify);(classify_contiguous$16003=util$15998.classify_contiguous);(identity$16004=util$15998.identity);($15963$16005=require("./expand"));(checker_db$16006=$15963$16005.checker_db);(PatternParser$16007=function(scope$16061,pattern$16062,opt$16063){var tags$16079;var it$0$16066;(it$0$16066=function(){if((!$15882(PatternParser$16007)(this))){return Object.create(PatternParser$16007.prototype);}else{return this;}}());(it$0$16066["opt"]=opt$16063);(it$0$16066["arguments"]=[]);(it$0$16066["vars"]=[]);(it$0$16066["specials"]=({}));(tags$16079=$19800((opt$16063.tags||({}))));(tags$16079["group_id"]=(tags$16079.group_id||gensym$16000("group")));(it$0$16066["pattern"]=it$0$16066.expand(scope$16061,pattern$16062,tags$16079,true,it$0$16066.opt.indexable));return it$0$16066;});(PatternParser$16007.prototype["parse_specs"]=function(scope$16103,specs$16104,tags$16105){var $index$16166;var $length$16160;var temp$16154;var acc$16148;var rest$16123;var has_defaults$16124;var rval$16125;var it$0$16109;var self$16110;(it$0$16109=this);(self$16110=this);(rest$16123=(void 0));(has_defaults$16124=false);(rval$16125=classify$16002("fw","bw","keys","defaults",(((acc$16148=[])),(((temp$16154=scope$16103.step_all(["pattern"],specs$16104))),((($length$16160=temp$16154.length)),((($index$16166=0)),function(){$16134:for(;($index$16166<$length$16160);($index$16166++)){var v$16240;var v$16234;var variable$16222;var value$16223;var key$16215;var subp$16216;var key$16209;var variable$16189;var $16142$16183;var $16143$16184;var $16144$16185;var $16145$16186;var t0$16180;var t1$16181;var m$16175;(m$16175=temp$16154[$index$16166]);(t0$16180=m$16175);if((($16143$16184=(t0$16180 instanceof Array))&&(((t1$16181=t0$16180.length)),(($16145$16186=(t1$16181===2))&&(t0$16180[0]==="dynsplice"))))){(variable$16189=t0$16180[1]);acc$16148.push((((rest$16123=it$0$16109.expand(scope$16103,variable$16189,tags$16105))),["ignore"]));}else{if(($16145$16186&&(t0$16180[0]==="assoc"))){(key$16209=t0$16180[1]);acc$16148.push(["keys",[key$16209,it$0$16109.expand(scope$16103,key$16209,tags$16105)]]);}else{if(($16143$16184&&(($16145$16186=(t1$16181===3))&&(t0$16180[0]==="assoc")))){(key$16215=t0$16180[1]);(subp$16216=t0$16180[2]);acc$16148.push(["keys",[key$16215,it$0$16109.expand(scope$16103,subp$16216,tags$16105)]]);}else{if(($16145$16186&&(t0$16180[0]==="default"))){(variable$16222=t0$16180[1]);(value$16223=t0$16180[2]);acc$16148.push((((has_defaults$16124=true)),function(){if(rest$16123){throw $19933(["syntax","pattern"]).create("No default arguments after rest arg.");}else{return ["defaults",[it$0$16109.expand(scope$16103,variable$16222,tags$16105),value$16223]];}}()));}else{(v$16234=m$16175);if(((rest$16123===(void 0))&&(!has_defaults$16124))){acc$16148.push(["fw",it$0$16109.expand(scope$16103,v$16234,tags$16105)]);}else{(v$16240=m$16175);acc$16148.push(["bw",it$0$16109.expand(scope$16103,v$16240,tags$16105)]);}}}}}}}()))),acc$16148)));(rval$16125["rest"]=rest$16123);return rval$16125;});(PatternParser$16007.prototype["expand"]=function(){var x$16340;var x$16350;var x$16379;var x$16385;var variable$16392;var variable$16409;var x$16449;var msg$16457;var msg$16473;var $index$16515;var $length$16509;var temp$16503;var acc$16497;var $index$16648;var $length$16642;var temp$16636;var acc$16630;var $index$16684;var $length$16678;var temp$16672;var t0$16759;var t1$16760;var t2$16761;var $index$16807;var $length$16801;var temp$16795;var acc$16789;var patts$16781;var canon$16545;var normalize$16546;var pps$16547;var vars$16548;var patt$16882;var msg$16928;var other$16924;var keys$16888;var fw$16861;var bw$16862;var defaults$16863;var rest$16864;var $16839$16858;var t0$16851;var t1$16852;var t2$16853;var t3$16854;var t4$16855;var t5$16856;var $16835$16846;var specs$16840;var other$16940;var mode$16934;var subp$16935;var args$16830;var xs$16537;var xs$16489;var x$16479;var f$16463;var arg$16464;var f$16438;var arguments$16439;var checker$16432;var subp$16433;var projector$16426;var subp$16427;var condition$16420;var subp$16421;var v$16415;var v$16398;var type$16357;var $16316$16331;var $16317$16332;var $16318$16333;var $16319$16334;var t0$16327;var bridge$16301$16328;var t1$16329;var $16296$16322;var expr$16289;var rval$16290;var scope$16275;var pattern$16276;var tags$16277;var toplevel$16278;var checked$16279;var t0$16271;var $16254$16266;var it$0$16256;var self$16257;(it$0$16256=this);(self$16257=this);($16254$16266=arguments);(t0$16271=$16254$16266.length);if(((t0$16271>=3)&&(t0$16271<=5))){(scope$16275=$16254$16266[0]);(pattern$16276=$16254$16266[1]);(tags$16277=$16254$16266[2]);(toplevel$16278=function(){if((3>=t0$16271)){return false;}else{return $16254$16266[3];}}());(checked$16279=function(){if((4>=t0$16271)){return false;}else{return $16254$16266[4];}}());(expr$16289=scope$16275.step(["pattern"],pattern$16276));(rval$16290=((($16296$16322=expr$16289)),function(){if((((x$16340=$16296$16322)),((x$16340 instanceof Array)&&(x$16340[0]==="void")))){return ["check",checker_db$16006.null,["ignore"]];}else{if((((x$16350=$16296$16322)),((x$16350 instanceof Array)&&(x$16350[0]==="ignore")))){return expr$16289;}else{if((($16296$16322 instanceof Array)&&(((t0$16327=$16296$16322.length)),((t0$16327===2)&&($16296$16322[0]==="special"))))){(type$16357=$16296$16322[1]);(it$0$16256.specials[type$16357]=true);return expr$16289;}else{(bridge$16301$16328=$16296$16322);if(((((x$16379=bridge$16301$16328)),((x$16379 instanceof Array)&&(x$16379[0]==="symbol")))||(((x$16385=bridge$16301$16328)),((x$16385 instanceof Array)&&(x$16385[0]==="variable"))))){(variable$16392=$20211(expr$16289,tags$16277));it$0$16256.vars.push(variable$16392);return ["assign",variable$16392];}else{if((($16316$16331=($16296$16322 instanceof Array))&&(((t0$16327=$16296$16322.length)),(($16318$16333=(t0$16327===2))&&(($16319$16334=($16296$16322[0]==="value"))&&((v$16398=$16296$16322[1]),it$0$16256.opt.strings_as_variables)))))){(variable$16409=__lt____lt____colon__$15997($20211(["symbol",v$16398],tags$16277),expr$16289));it$0$16256.vars.push(variable$16409);return ["assign",variable$16409];}else{if($16319$16334){(v$16415=$16296$16322[1]);return ["check",checker_db$16006(v$16415),["ignore"]];}else{if(($16316$16331&&(($16318$16333=(t0$16327===3))&&($16296$16322[0]==="test")))){(condition$16420=$16296$16322[1]);(subp$16421=$16296$16322[2]);return ["test",condition$16420,it$0$16256.expand(scope$16275,subp$16421,tags$16277,toplevel$16278,false)];}else{if(($16318$16333&&($16296$16322[0]==="project"))){(projector$16426=$16296$16322[1]);(subp$16427=$16296$16322[2]);return ["project",projector$16426,it$0$16256.expand(scope$16275,subp$16427,tags$16277,toplevel$16278,true)];}else{if(($16318$16333&&($16296$16322[0]==="check"))){(checker$16432=$16296$16322[1]);(subp$16433=$16296$16322[2]);return ["check",checker$16432,it$0$16256.expand(scope$16275,subp$16433,tags$16277,toplevel$16278,true)];}else{if(($16318$16333&&(($16319$16334=($16296$16322[0]==="send"))&&((f$16438=$16296$16322[1]),(((t1$16329=$16296$16322[2])),(((x$16449=t1$16329)),((x$16449 instanceof Array)&&(x$16449[0]==="data")))))))){(arguments$16439=t1$16329);if(toplevel$16278){it$0$16256.arguments.unshift(arguments$16439);return it$0$16256.expand(scope$16275,f$16438,tags$16277,true,false);}else{(msg$16457="Function arguments can only be declared as a top level pattern.");throw $19933(["syntax","pattern"]).create(msg$16457,({"node":expr$16289,"arg":arguments$16439}));}}else{if($16319$16334){(f$16463=$16296$16322[1]);(arg$16464=$16296$16322[2]);return ["assign",expr$16289];}else{$16296$16322;if((!it$0$16256.opt.allow_nested)){(msg$16473="Nested patterns are not allowed here.");throw $19933(["syntax","pattern"]).create(msg$16473,({"node":expr$16289}));}else{if((($16316$16331=($16296$16322 instanceof Array))&&(((t0$16327=$16296$16322.length)),((t0$16327===2)&&($16296$16322[0]==="neg"))))){(x$16479=$16296$16322[1]);return ["neg",it$0$16256.expand(scope$16275,x$16479,tags$16277)];}else{if(($16316$16331&&(($16318$16333=(t0$16327>=1))&&($16296$16322[0]==="all")))){(xs$16489=Array.prototype.slice.call($16296$16322,1));return ["all"].concat((((acc$16497=[])),(((temp$16503=xs$16489)),((($length$16509=temp$16503.length)),((($index$16515=0)),function(){$16492:for(;($index$16515<$length$16509);($index$16515++)){var x$16532;var m$16524;(m$16524=temp$16503[$index$16515]);(x$16532=m$16524);acc$16497.push(it$0$16256.expand(scope$16275,x$16532,tags$16277));}}()))),acc$16497));}else{if(($16318$16333&&($16296$16322[0]==="any"))){(xs$16537=Array.prototype.slice.call($16296$16322,1));(canon$16545=function(all$16556){return all$16556.sort().join(",");});(normalize$16546=function(vars$16563){var $index$16588;var $length$16582;var temp$16576;var acc$16570;return canon$16545((((acc$16570=[])),(((temp$16576=vars$16563)),((($length$16582=temp$16576.length)),((($index$16588=0)),function(){$16565:for(;($index$16588<$length$16582);($index$16588++)){var v$16607;var t0$16602;var t1$16603;var m$16597;(m$16597=temp$16576[$index$16588]);(t0$16602=m$16597);if(((t0$16602 instanceof Array)&&(((t1$16603=t0$16602.length)),((t1$16603===2)&&(t0$16602[0]==="symbol"))))){(v$16607=t0$16602[1]);acc$16570.push(v$16607);}else{$20192(m$16597,"/home/olivier/git/earl-grey/src/pattern.eg",3845,3902);}}}()))),acc$16570));});(pps$16547=(((acc$16630=[])),(((temp$16636=xs$16537)),((($length$16642=temp$16636.length)),((($index$16648=0)),function(){$16625:for(;($index$16648<$length$16642);($index$16648++)){var x$16665;var m$16657;(m$16657=temp$16636[$index$16648]);(x$16665=m$16657);acc$16630.push(PatternParser$16007(scope$16275,x$16665,$20211(it$0$16256.opt,({"tags":tags$16277}))));}}()))),acc$16630));(temp$16672=neighbours$16001(pps$16547));($length$16678=temp$16672.length);($index$16684=0);$16549:for(;($index$16684<$length$16678);($index$16684++)){var $index$16735;var $length$16729;var temp$16723;var pp1$16703;var pp2$16704;var t0$16698;var t1$16699;var m$16693;(m$16693=temp$16672[$index$16684]);(t0$16698=m$16693);if(((t0$16698 instanceof Array)&&(((t1$16699=t0$16698.length)),(t1$16699===2)))){(pp1$16703=t0$16698[0]);(pp2$16704=t0$16698[1]);(temp$16723=pps$16547);($length$16729=temp$16723.length);($index$16735=0);$16717:for(;($index$16735<$length$16729);($index$16735++)){var pp$16752;var m$16744;(m$16744=temp$16723[$index$16735]);(pp$16752=m$16744);normalize$16546(pp$16752.vars);}if((normalize$16546(pp1$16703.vars)!==normalize$16546(pp2$16704.vars))){throw $19933(["syntax","pattern"]).create("Both branches of 'or' must contain the same variables",({"vars1":__lt____lt____colon__$15997(pp1$16703.vars.sort(),pp1$16703.pattern),"vars2":__lt____lt____colon__$15997(pp2$16704.vars.sort(),pp2$16704.pattern)}));}if((canon$16545($20233(pp1$16703.specials))!==canon$16545($20233(pp2$16704.specials)))){throw $19933(["syntax","pattern"]).create("Both branches of 'or' must contain the same special tokens",({"special1":__lt____lt____colon__$15997($20233(pp1$16703.specials).sort(),pp1$16703.pattern),"special2":__lt____lt____colon__$15997($20233(pp2$16704.specials).sort(),pp2$16704.pattern)}));}}else{$20192(m$16693,"/home/olivier/git/earl-grey/src/pattern.eg",3994,4791);}}(t0$16759=pps$16547);if(((t0$16759 instanceof Array)&&(((t1$16760=t0$16759.length)),((t1$16760>=1)&&(((t2$16761=t0$16759[0])),$19884(t2$16761,"vars")))))){(vars$16548=t2$16761.vars);Array.prototype.slice.call(t0$16759,1);}else{$20192(pps$16547,"/home/olivier/git/earl-grey/src/pattern.eg",4808,4811);}(it$0$16256["vars"]=it$0$16256.vars.concat(vars$16548));(patts$16781=(((acc$16789=[])),(((temp$16795=pps$16547)),((($length$16801=temp$16795.length)),((($index$16807=0)),function(){$16784:for(;($index$16807<$length$16801);($index$16807++)){var pp$16824;var m$16816;(m$16816=temp$16795[$index$16807]);(pp$16824=m$16816);acc$16789.push(pp$16824.pattern);}}()))),acc$16789));return ["any"].concat(patts$16781);}else{if(($16318$16333&&($16296$16322[0]==="data"))){(args$16830=Array.prototype.slice.call($16296$16322,1));(specs$16840=it$0$16256.parse_specs(scope$16275,args$16830,tags$16277));($16835$16846=specs$16840);if((($16839$16858=$19884($16835$16846,"keys"))&&(((t0$16851=$16835$16846.keys)),((t0$16851 instanceof Array)&&(((t1$16852=t0$16851.length)),((t1$16852===0)&&($19884($16835$16846,"fw")&&((fw$16861=$16835$16846.fw),($19884($16835$16846,"bw")&&((bw$16862=$16835$16846.bw),($19884($16835$16846,"defaults")&&((defaults$16863=$16835$16846.defaults),$19884($16835$16846,"rest"))))))))))))){(rest$16864=$16835$16846.rest);(patt$16882=__lt____lt____colon__$15997(["array_pattern",fw$16861,bw$16862,defaults$16863,rest$16864],pattern$16276));if(checked$16279){return patt$16882;}else{return ["check",checker_db$16006.Array,patt$16882];}}else{if(($16839$16858&&((keys$16888=$16835$16846.keys),($19884($16835$16846,"fw")&&(((t0$16851=$16835$16846.fw)),((t0$16851 instanceof Array)&&(((t1$16852=t0$16851.length)),((t1$16852===0)&&($19884($16835$16846,"bw")&&(((t2$16853=$16835$16846.bw)),((t2$16853 instanceof Array)&&(((t3$16854=t2$16853.length)),((t3$16854===0)&&($19884($16835$16846,"defaults")&&(((t4$16855=$16835$16846.defaults)),((t4$16855 instanceof Array)&&(((t5$16856=t4$16855.length)),((t5$16856===0)&&($19884($16835$16846,"rest")&&($16835$16846.rest===(void 0))))))))))))))))))))){return ["object_pattern"].concat(keys$16888);}else{(other$16924=$16835$16846);(msg$16928="Pattern must be an array or an object.");throw $19933(["syntax","pattern"]).create(msg$16928,({"node":expr$16289,"specs":specs$16840}));}}}else{if(($16316$16331&&((t0$16327===3)&&($16296$16322[0]==="mode")))){(mode$16934=$16296$16322[1]);(subp$16935=$16296$16322[2]);return it$0$16256.expand(scope$16275,subp$16935,$20211(tags$16277,({"declare_mode":mode$16934})),toplevel$16278,checked$16279);}else{(other$16940=$16296$16322);throw $19933(["syntax","pattern"]).create("Illegal pattern",({"node":other$16940}));}}}}}}}}}}}}}}}}}}()));return (it$0$16256.opt.wrap_pattern||identity$16004)(__lt____lt____colon__$15997(rval$16290,pattern$16276),toplevel$16278);}else{$20192($16254$16266);}});$15902(PatternParser$16007,$15902(((accum$16948=({})),((accum$16948["::name"]="PatternParser"),accum$16948)),((accum$16952=({})),((accum$16952["::egclass"]=true),accum$16952))));PatternParser$16007;(PatternProcessor$16008=function(){var it$0$16961;(it$0$16961=function(){if((!$15882(PatternProcessor$16008)(this))){return Object.create(PatternProcessor$16008.prototype);}else{return this;}}());(it$0$16961["temps"]=[]);(it$0$16961["parts"]=[]);(it$0$16961["gen"]=GenSym$15999("t"));return it$0$16961;});(PatternProcessor$16008.prototype["do"]=function(part$16985){var it$0$16989;var self$16990;(it$0$16989=this);(self$16990=this);return it$0$16989.parts.push(["do",part$16985]);});(PatternProcessor$16008.prototype["check"]=function(){var part$17026;var tags$17027;var t0$17022;var $17005$17017;var it$0$17007;var self$17008;(it$0$17007=this);(self$17008=this);($17005$17017=arguments);(t0$17022=$17005$17017.length);if(((t0$17022>=1)&&(t0$17022<=2))){(part$17026=$17005$17017[0]);(tags$17027=function(){if((1>=t0$17022)){return ({});}else{return $17005$17017[1];}}());return it$0$17007.parts.push($20211(["check",part$17026],tags$17027));}else{$20192($17005$17017);}});(PatternProcessor$16008.prototype["temp"]=function(){var x$17094;var x$17100;var init$17107;var bridge$17074$17083;var $17072$17078;var x$17064;var v$17065;var t0$17060;var $17043$17055;var it$0$17045;var self$17046;(it$0$17045=this);(self$17046=this);($17043$17055=arguments);(t0$17060=$17043$17055.length);if(((t0$17060>=1)&&(t0$17060<=2))){(x$17064=$17043$17055[0]);(v$17065=function(){if((1>=t0$17060)){return null;}else{return $17043$17055[1];}}());($17072$17078=x$17064);(bridge$17074$17083=$17072$17078);if((((((x$17094=bridge$17074$17083)),((x$17094 instanceof Array)&&(x$17094[0]==="variable")))||(((x$17100=bridge$17074$17083)),((x$17100 instanceof Array)&&(x$17100[0]==="symbol"))))&&($19884($17072$17078,"single_assignment")&&($17072$17078.single_assignment&&(!v$17065))))){return x$17064;}else{(init$17107=$17072$17078);(v$17065=(v$17065||["symbol",it$0$17045.gen()]));(v$17065["single_assignment"]=true);it$0$17045.temps.push(v$17065);it$0$17045.do(["send",["symbol","="],["data",["send",["symbol","set"],v$17065],init$17107]]);return v$17065;}}else{$20192($17043$17055);}});(PatternProcessor$16008.prototype["process"]=function(pattern$17124,rhs$17125,fns$17126){var x$17179;var x$17213;var t$17226;var t$17238;var pp$17249;var $index$17282;var $length$17276;var temp$17270;var t$17260;var $index$17350;var $length$17344;var temp$17338;var acc$17332;var fn$17315;var parts$17316;var t$17308;var $index$17411;var $length$17405;var temp$17399;var acc$17393;var t$17384;var otherwise$17544;var $17522$17528;var $index$17561;var $length$17555;var temp$17549;var $index$17610;var $length$17604;var temp$17598;var end$17672;var pos$17666;var $index$17696;var $length$17690;var temp$17684;var acc$17678;var nfw$17477;var nbw$17478;var ndflt$17479;var extract_length$17480;var check_length$17481;var lo$17482;var hi$17483;var t$17484;var len$17485;var fw$17461;var bw$17462;var dflt$17463;var rest$17464;var subp$17379;var xs$17303;var xs$17255;var patt$17244;var projector$17232;var subp$17233;var checker$17220;var subp$17221;var checker$17208;var condition$17201;var subp$17202;var kind$17196;var sym$17186;var $17157$17170;var $17158$17171;var $17159$17172;var $17160$17173;var t0$17168;var $17144$17163;var rval$17141;var it$0$17130;var self$17131;(it$0$17130=this);(self$17131=this);(rval$17141=((($17144$17163=pattern$17124)),function(){if((((x$17179=$17144$17163)),((x$17179 instanceof Array)&&(x$17179[0]==="ignore")))){return it$0$17130.do(rhs$17125);}else{if((($17157$17170=($17144$17163 instanceof Array))&&(((t0$17168=$17144$17163.length)),(($17159$17172=(t0$17168===2))&&($17144$17163[0]==="assign"))))){(sym$17186=$17144$17163[1]);return it$0$17130.parts.push(fns$17126.assign(sym$17186,rhs$17125));}else{if(($17159$17172&&($17144$17163[0]==="special"))){(kind$17196=$17144$17163[1]);return it$0$17130.process(fns$17126.special(pattern$17124,rhs$17125),rhs$17125,fns$17126);}else{if(($17157$17170&&(($17159$17172=(t0$17168===3))&&($17144$17163[0]==="test")))){(condition$17201=$17144$17163[1]);(subp$17202=$17144$17163[2]);it$0$17130.process(subp$17202,rhs$17125,fns$17126);return it$0$17130.check(condition$17201,({"test":true}));}else{if(($17159$17172&&(($17160$17173=($17144$17163[0]==="check"))&&((checker$17208=$17144$17163[1]),(((x$17213=$17144$17163[2])),((x$17213 instanceof Array)&&(x$17213[0]==="ignore"))))))){return it$0$17130.check(["send",checker$17208,["data",rhs$17125]]);}else{if($17160$17173){(checker$17220=$17144$17163[1]);(subp$17221=$17144$17163[2]);(t$17226=it$0$17130.temp(rhs$17125));it$0$17130.check(["send",checker$17220,["data",t$17226]]);return it$0$17130.process(subp$17221,t$17226,fns$17126);}else{if(($17159$17172&&($17144$17163[0]==="project"))){(projector$17232=$17144$17163[1]);(subp$17233=$17144$17163[2]);(t$17238=it$0$17130.temp(["send",projector$17232,["data",rhs$17125]]));it$0$17130.check(["send",t$17238,["value",0]]);return it$0$17130.process(subp$17233,["send",t$17238,["value",1]],fns$17126);}else{if(($17157$17170&&((t0$17168===2)&&($17144$17163[0]==="neg")))){(patt$17244=$17144$17163[1]);return it$0$17130.check(["send",["symbol","not"],["data",["void"],(((pp$17249=PatternProcessor$16008())),pp$17249.process(patt$17244,rhs$17125,fns$17126),assemble_conditions$16009(pp$17249))]]);}else{if(($17157$17170&&(($17159$17172=(t0$17168>=1))&&($17144$17163[0]==="all")))){(xs$17255=Array.prototype.slice.call($17144$17163,1));(t$17260=it$0$17130.temp(rhs$17125));(temp$17270=xs$17255);($length$17276=temp$17270.length);($index$17282=0);$17261:for(;($index$17282<$length$17276);($index$17282++)){var x$17299;var m$17291;(m$17291=temp$17270[$index$17282]);(x$17299=m$17291);it$0$17130.process(x$17299,t$17260,fns$17126);}return null;}else{if(($17159$17172&&($17144$17163[0]==="any"))){(xs$17303=Array.prototype.slice.call($17144$17163,1));(t$17308=it$0$17130.temp(rhs$17125,["symbol",gensym$16000("bridge")]));return it$0$17130.check((((fn$17315=function(x$17321,rest$17322){return ["send",["symbol","or"],["data",x$17321,rest$17322]];})),((parts$17316=(((acc$17332=[])),(((temp$17338=xs$17303)),((($length$17344=temp$17338.length)),((($index$17350=0)),function(){$17327:for(;($index$17350<$length$17344);($index$17350++)){var pp$17372;var x$17367;var m$17359;(m$17359=temp$17338[$index$17350]);(x$17367=m$17359);acc$17332.push((((pp$17372=PatternProcessor$16008())),pp$17372.process(x$17367,t$17308,fns$17126),assemble_conditions$16009(pp$17372)));}}()))),acc$17332))),util$15998.construct(parts$17316,fn$17315,["symbol","false"])));}else{if(($17159$17172&&($17144$17163[0]==="object_pattern"))){(subp$17379=Array.prototype.slice.call($17144$17163,1));(t$17384=it$0$17130.temp(rhs$17125));(acc$17393=[]);(temp$17399=subp$17379);($length$17405=temp$17399.length);($index$17411=0);$17385:for(;($index$17411<$length$17405);($index$17411++)){var k$17432;var v$17433;var t0$17425;var t1$17426;var t2$17427;var t3$17428;var m$17420;(m$17420=temp$17399[$index$17411]);(t0$17425=m$17420);if(((t0$17425 instanceof Array)&&(((t1$17426=t0$17425.length)),((t1$17426===2)&&(((t2$17427=t0$17425[0])),((t2$17427 instanceof Array)&&(((t3$17428=t2$17427.length)),((t3$17428===2)&&(t2$17427[0]==="value"))))))))){(k$17432=t2$17427[1]);(v$17433=t0$17425[1]);acc$17393.push((it$0$17130.check(["send",["symbol","___hasprop"],["data",t$17384,["value",k$17432]]]),it$0$17130.process(v$17433,["send",t$17384,["value",k$17432]],fns$17126)));}else{$20192(m$17420,"/home/olivier/git/earl-grey/src/pattern.eg",8140,8272);}}return acc$17393;}else{if(($17157$17170&&((t0$17168===5)&&($17144$17163[0]==="array_pattern")))){(fw$17461=$17144$17163[1]);(bw$17462=$17144$17163[2]);(dflt$17463=$17144$17163[3]);(rest$17464=$17144$17163[4]);(nfw$17477=fw$17461.length);(nbw$17478=bw$17462.length);(ndflt$17479=dflt$17463.length);(extract_length$17480=true);(check_length$17481=true);(lo$17482=(nfw$17477+nbw$17478));(hi$17483=(lo$17482+ndflt$17479));(t$17484=it$0$17130.temp(rhs$17125));(len$17485=it$0$17130.temp(["send",t$17484,["send",["symbol","."],["data",["void"],["symbol","length"]]]]));it$0$17130.check(((($17522$17528=rest$17464)),function(){if($17522$17528){return ["send",["symbol",">="],["data",len$17485,["value",lo$17482]]];}else{$17522$17528;if((lo$17482===hi$17483)){return ["send",["symbol","==="],["data",len$17485,["value",lo$17482]]];}else{(otherwise$17544=$17522$17528);return ["send",["symbol","and"],["data",["send",["symbol",">="],["data",len$17485,["value",lo$17482]]],["send",["symbol","<="],["data",len$17485,["value",hi$17483]]]]];}}}()));(temp$17549=$20166(fw$17461));($length$17555=temp$17549.length);($index$17561=0);$17486:for(;($index$17561<$length$17555);($index$17561++)){var i$17580;var m$17581;var t0$17575;var t1$17576;var m$17570;(m$17570=temp$17549[$index$17561]);(t0$17575=m$17570);if(((t0$17575 instanceof Array)&&(((t1$17576=t0$17575.length)),(t1$17576===2)))){(i$17580=t0$17575[0]);(m$17581=t0$17575[1]);it$0$17130.process(m$17581,["send",t$17484,["value",i$17580]],fns$17126);}else{$20192(m$17570,"/home/olivier/git/earl-grey/src/pattern.eg",9004,9090);}}(temp$17598=$20166(dflt$17463));($length$17604=temp$17598.length);($index$17610=0);$17489:for(;($index$17610<$length$17604);($index$17610++)){var idx$17658;var i$17631;var patt$17632;var value$17633;var t0$17624;var t1$17625;var t2$17626;var t3$17627;var m$17619;(m$17619=temp$17598[$index$17610]);(t0$17624=m$17619);if(((t0$17624 instanceof Array)&&(((t1$17625=t0$17624.length)),((t1$17625===2)&&((i$17631=t0$17624[0]),(((t2$17626=t0$17624[1])),((t2$17626 instanceof Array)&&(((t3$17627=t2$17626.length)),(t3$17627===2))))))))){(patt$17632=t2$17626[0]);(value$17633=t2$17626[1]);(idx$17658=(i$17631+nfw$17477));it$0$17130.process(patt$17632,["send",["symbol","if"],["data",["send",["symbol",">="],["data",["value",(idx$17658+nbw$17478)],len$17485]],value$17633,["send",t$17484,["value",idx$17658]]]],fns$17126);}else{$20192(m$17619,"/home/olivier/git/earl-grey/src/pattern.eg",9090,9259);}}if((rest$17464!==(void 0))){(pos$17666=(nfw$17477+ndflt$17479));(end$17672=function(){if((nbw$17478>0)){return [["value",(-nbw$17478)]];}else{return [];}}());it$0$17130.process(rest$17464,["send",["send",["send",["send",["symbol","Array"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]],["send",["symbol","."],["data",["void"],["symbol","slice"]]]],["send",["symbol","."],["data",["void"],["symbol","call"]]]],["data",t$17484,["value",pos$17666]].concat(end$17672)],fns$17126);}else{[];}(acc$17678=[]);(temp$17684=$20166(bw$17462));($length$17690=temp$17684.length);($index$17696=0);$17492:for(;($index$17696<$length$17690);($index$17696++)){var i$17715;var m$17716;var t0$17710;var t1$17711;var m$17705;(m$17705=temp$17684[$index$17696]);(t0$17710=m$17705);if(((t0$17710 instanceof Array)&&(((t1$17711=t0$17710.length)),(t1$17711===2)))){(i$17715=t0$17710[0]);(m$17716=t0$17710[1]);acc$17678.push(it$0$17130.process(m$17716,["send",["symbol","___js_fetch"],["data",t$17484,["send",["symbol","-"],["data",len$17485,["value",(nbw$17478-i$17715)]]]]],fns$17126));}else{$20192(m$17705,"/home/olivier/git/earl-grey/src/pattern.eg",9710,9861);}}return acc$17678;}else{$20192($17144$17163);}}}}}}}}}}}}}()));return rval$17141;});$15902(PatternProcessor$16008,$15902(((accum$17737=({})),((accum$17737["::name"]="PatternProcessor"),accum$17737)),((accum$17741=({})),((accum$17741["::egclass"]=true),accum$17741))));PatternProcessor$16008;(assemble_conditions$16009=function(pp$17748){var $index$17872;var $length$17866;var temp$17860;var acc$17854;var decls$17846;var construct$17752;(construct$17752=function($17756$17759){var x$17827;var rest$17828;var x$17812;var x$17796;var rest$17797;var $17766$17783;var $17767$17784;var t0$17779;var t1$17780;var t2$17781;var $17761$17774;var ph$17768;(ph$17768=$17756$17759);($17761$17774=ph$17768);if((($17766$17783=($17761$17774 instanceof Array))&&(((t0$17779=$17761$17774.length)),(t0$17779===0)))){return ["value",true];}else{if(($17766$17783&&((t0$17779>=1)&&(((t1$17780=$17761$17774[0])),((t1$17780 instanceof Array)&&(((t2$17781=t1$17780.length)),((t2$17781===2)&&(t1$17780[0]==="do")))))))){(x$17796=t1$17780[1]);(rest$17797=Array.prototype.slice.call($17761$17774,1));return ["multi",x$17796,construct$17752(rest$17797)];}else{if(($17766$17783&&((t0$17779===1)&&(((t1$17780=$17761$17774[0])),((t1$17780 instanceof Array)&&(((t2$17781=t1$17780.length)),((t2$17781===2)&&(t1$17780[0]==="check")))))))){(x$17812=t1$17780[1]);return x$17812;}else{if(($17766$17783&&((t0$17779>=1)&&(((t1$17780=$17761$17774[0])),((t1$17780 instanceof Array)&&(((t2$17781=t1$17780.length)),((t2$17781===2)&&(t1$17780[0]==="check")))))))){(x$17827=t1$17780[1]);(rest$17828=Array.prototype.slice.call($17761$17774,1));return ["send",["symbol","and"],["data",x$17827,construct$17752(rest$17828)]];}else{$20192($17761$17774);}}}}});if(pp$17748.temps.length){(decls$17846=(((acc$17854=[])),(((temp$17860=pp$17748.temps)),((($length$17866=temp$17860.length)),((($index$17872=0)),function(){$17849:for(;($index$17872<$length$17866);($index$17872++)){var t$17889;var m$17881;(m$17881=temp$17860[$index$17872]);(t$17889=m$17881);acc$17854.push(["declare",t$17889]);}}()))),acc$17854));return ["multi"].concat(decls$17846).concat([construct$17752(pp$17748.parts)]);}else{return construct$17752(pp$17748.parts);}});(assemble_pattern$16010=function(){var $index$17961;var $length$17955;var temp$17949;var $index$18022;var $length$18016;var temp$18010;var test$18161;var lead$17924;var trail$17925;var construct$17926;var parts$17911;var t$17912;var f$17913;var t0$17907;var $17898$17902;($17898$17902=arguments);(t0$17907=$17898$17902.length);if(((t0$17907>=2)&&(t0$17907<=3))){(parts$17911=$17898$17902[0]);(t$17912=$17898$17902[1]);(f$17913=function(){if((2>=t0$17907)){return null;}else{return $17898$17902[2];}}());(lead$17924=[]);(temp$17949=parts$17911.slice(0));($length$17955=temp$17949.length);($index$17961=0);$17927:for(;($index$17961<$length$17955);($index$17961++)){var x$17999;var x$17984;var $17931$17978;var $17932$17979;var $17933$17980;var $17934$17981;var t0$17975;var t1$17976;var m$17970;(m$17970=temp$17949[$index$17961]);(t0$17975=m$17970);if((($17932$17979=(t0$17975 instanceof Array))&&(((t1$17976=t0$17975.length)),(($17934$17981=(t1$17976===2))&&(t0$17975[0]==="do"))))){(x$17984=t0$17975[1]);lead$17924.push(x$17984);parts$17911.shift();}else{if(($17934$17981&&(t0$17975[0]==="check"))){(x$17999=t0$17975[1]);break $17927;}else{$20192(m$17970,"/home/olivier/git/earl-grey/src/pattern.eg",10322,10432);}}}(trail$17925=[]);(temp$18010=parts$17911.slice(0).reverse());($length$18016=temp$18010.length);($index$18022=0);$17935:for(;($index$18022<$length$18016);($index$18022++)){var x$18060;var x$18045;var $17939$18039;var $17940$18040;var $17941$18041;var $17942$18042;var t0$18036;var t1$18037;var m$18031;(m$18031=temp$18010[$index$18022]);(t0$18036=m$18031);if((($17940$18040=(t0$18036 instanceof Array))&&(((t1$18037=t0$18036.length)),(($17942$18042=(t1$18037===2))&&(t0$18036[0]==="do"))))){(x$18045=t0$18036[1]);trail$17925.unshift(x$18045);parts$17911.pop();}else{if(($17942$18042&&(t0$18036[0]==="check"))){(x$18060=t0$18036[1]);break $17935;}else{$20192(m$18031,"/home/olivier/git/earl-grey/src/pattern.eg",10446,10568);}}}(construct$17926=function($18068$18071){var other$18156;var x$18140;var rest$18141;var x$18125;var x$18109;var rest$18110;var $18079$18096;var $18080$18097;var t0$18092;var t1$18093;var t2$18094;var $18073$18087;var ph$18081;(ph$18081=$18068$18071);($18073$18087=ph$18081);if((($18079$18096=($18073$18087 instanceof Array))&&(((t0$18092=$18073$18087.length)),(t0$18092===0)))){return ["value",true];}else{if(($18079$18096&&((t0$18092>=1)&&(((t1$18093=$18073$18087[0])),((t1$18093 instanceof Array)&&(((t2$18094=t1$18093.length)),((t2$18094===2)&&(t1$18093[0]==="do")))))))){(x$18109=t1$18093[1]);(rest$18110=Array.prototype.slice.call($18073$18087,1));return ["multi",x$18109,construct$17926(rest$18110)];}else{if(($18079$18096&&((t0$18092===1)&&(((t1$18093=$18073$18087[0])),((t1$18093 instanceof Array)&&(((t2$18094=t1$18093.length)),((t2$18094===2)&&(t1$18093[0]==="check")))))))){(x$18125=t1$18093[1]);return x$18125;}else{if(($18079$18096&&((t0$18092>=1)&&(((t1$18093=$18073$18087[0])),((t1$18093 instanceof Array)&&(((t2$18094=t1$18093.length)),((t2$18094===2)&&(t1$18093[0]==="check")))))))){(x$18140=t1$18093[1]);(rest$18141=Array.prototype.slice.call($18073$18087,1));return ["send",["symbol","and"],["data",x$18140,construct$17926(rest$18141)]];}else{(other$18156=$18073$18087);throw $19933(["oops"]).create("?!?",other$18156);}}}}});if(parts$17911.length){(test$18161=construct$17926(parts$17911));return ["multi"].concat(lead$17924).concat([function(){if(f$17913){return ["send",["symbol","if"],["data",test$18161,["multi"].concat(trail$17925).concat([t$17912]),f$17913]];}else{return ["send",["symbol","if"],["data",test$18161,["multi"].concat(trail$17925).concat([t$17912])]];}}()]);}else{return ["multi"].concat(lead$17924).concat(trail$17925).concat([t$17912]);}}else{$20192($17898$17902);}});(inject_below_uses$16011=function($18171$18174,fn$18175){var other$18206;var scope$18195;var x$18196;var t0$18191;var $18177$18186;var ph$18180;(ph$18180=$18171$18174);($18177$18186=ph$18180);if((($18177$18186 instanceof Array)&&(((t0$18191=$18177$18186.length)),((t0$18191===3)&&($18177$18186[0]==="use"))))){(scope$18195=$18177$18186[1]);(x$18196=$18177$18186[2]);return ["use",scope$18195,inject_below_uses$16011(x$18196,fn$18175)];}else{(other$18206=$18177$18186);return fn$18175(other$18206);}});(parse_pattern$16012=function(scope$18213,pattern$18214,rhs$18215,opt$18216){var t0$18230;var $index$18282;var $length$18276;var temp$18270;var acc$18264;var parse$18222;var target$18223;var proc$18224;(parse$18222=PatternParser$16007(scope$18213,pattern$18214,opt$18216));if(((!opt$18216.allow_arguments)&&parse$18222.arguments.length)){throw $19933(["syntax","pattern","arguments"]).create("Arguments cannot be declared in this pattern",({"args":parse$18222.arguments[0]}));}(t0$18230=$20234((opt$18216.wrap_target||identity$16004))(function(){if(parse$18222.arguments.length){return inject_below_uses$16011(rhs$18215,function(x$18237){return util$15998.construct(parse$18222.arguments.concat([x$18237]),function(args$18241,rest$18242){return ["send",["symbol","->"],["data",args$18241,rest$18242]];});});}else{return rhs$18215;}}()));if(t0$18230[0]){(target$18223=t0$18230[1]);}else{$20192(function(){if(parse$18222.arguments.length){return inject_below_uses$16011(rhs$18215,function(x$18249){return util$15998.construct(parse$18222.arguments.concat([x$18249]),function(args$18253,rest$18254){return ["send",["symbol","->"],["data",args$18253,rest$18254]];});});}else{return rhs$18215;}}(),"/home/olivier/git/earl-grey/src/pattern.eg",11961,12394);}(proc$18224=PatternProcessor$16008());proc$18224.process(parse$18222.pattern,target$18223,opt$18216);if(opt$18216.finalize){return ["splice"].concat(opt$18216.declare(scope$18213,parse$18222.vars)).concat([["multi"].concat((((acc$18264=[])),(((temp$18270=proc$18224.temps)),((($length$18276=temp$18270.length)),((($index$18282=0)),function(){$18259:for(;($index$18282<$length$18276);($index$18282++)){var t$18299;var m$18291;(m$18291=temp$18270[$index$18282]);(t$18299=m$18291);acc$18264.push(["declare",t$18299]);}}()))),acc$18264)).concat([assemble_pattern$16010(proc$18224.parts,opt$18216.success(target$18223),opt$18216.failure(target$18223))])]);}else{return [parse$18222.vars,proc$18224.temps,proc$18224.parts];}});(checkall$16013=["send","data","multi","assign","void","check","do"]);(same_block$16014=function($18309$18312,ban1$18313,ban2$18314){var $index$18478;var $length$18472;var temp$18466;var other$18500;var type1$18439;var args1$18440;var type2$18441;var args2$18442;var m1$18422;var m2$18423;var v1$18405;var v2$18406;var s1$18388;var s2$18389;var v1$18356;var v2$18357;var $18323$18347;var $18324$18348;var $18325$18349;var $18326$18350;var $18327$18351;var $18328$18352;var $18329$18353;var t0$18341;var t1$18342;var t2$18343;var t3$18344;var t4$18345;var $18316$18336;var ph$18330;(ph$18330=$18309$18312);($18316$18336=ph$18330);if((($18323$18347=($18316$18336 instanceof Array))&&(((t0$18341=$18316$18336.length)),(($18325$18349=(t0$18341===2))&&(((t1$18342=$18316$18336[0])),(($18327$18351=(t1$18342 instanceof Array))&&(((t2$18343=t1$18342.length)),(($18329$18353=(t2$18343===2))&&((t1$18342[0]==="variable")&&((v1$18356=t1$18342[1]),(((t3$18344=$18316$18336[1])),((t3$18344 instanceof Array)&&(((t4$18345=t3$18344.length)),((t4$18345===2)&&(t3$18344[0]==="variable"))))))))))))))){(v2$18357=t3$18344[1]);return (v1$18356===v2$18357);}else{if(($18329$18353&&((t1$18342[0]==="symbol")&&((s1$18388=t1$18342[1]),(((t3$18344=$18316$18336[1])),((t3$18344 instanceof Array)&&(((t4$18345=t3$18344.length)),((t4$18345===2)&&(t3$18344[0]==="symbol"))))))))){(s2$18389=t3$18344[1]);return (((!$15901(ban1$18313,s1$18388))&&(!$15901(ban2$18314,s2$18389)))&&(s1$18388===s2$18389));}else{if(($18329$18353&&((t1$18342[0]==="value")&&((v1$18405=t1$18342[1]),(((t3$18344=$18316$18336[1])),((t3$18344 instanceof Array)&&(((t4$18345=t3$18344.length)),((t4$18345===2)&&(t3$18344[0]==="value"))))))))){(v2$18406=t3$18344[1]);return (v1$18405===v2$18406);}else{if(($18329$18353&&((t1$18342[0]==="macro")&&((m1$18422=t1$18342[1]),(((t3$18344=$18316$18336[1])),((t3$18344 instanceof Array)&&(((t4$18345=t3$18344.length)),((t4$18345===2)&&(t3$18344[0]==="macro"))))))))){(m2$18423=t3$18344[1]);return (m1$18422===m2$18423);}else{if(($18327$18351&&((t2$18343>=1)&&((type1$18439=t1$18342[0]),((args1$18440=Array.prototype.slice.call(t1$18342,1)),(((t3$18344=$18316$18336[1])),((t3$18344 instanceof Array)&&(((t4$18345=t3$18344.length)),((t4$18345>=1)&&((type2$18441=t3$18344[0]),((args2$18442=Array.prototype.slice.call(t3$18344,1)),(checkall$16013.indexOf(type1$18439)!==-1)))))))))))){if(((type1$18439===type2$18441)&&(args1$18440.length===args2$18442.length))){(temp$18466=$20281(args1$18440,args2$18442));($length$18472=temp$18466.length);($index$18478=0);$18460:for(;($index$18478<$length$18472);($index$18478++)){var pair$18495;var m$18487;(m$18487=temp$18466[$index$18478]);(pair$18495=m$18487);if((!same_block$16014(pair$18495,ban1$18313,ban2$18314))){return false;}}return true;}else{return false;}}else{(other$18500=$18316$18336);return false;}}}}}});(parse_clauses$16015=function(scope$18507,target$18508,stmts$18509,opt$18510){var $index$18550;var $length$18544;var temp$18538;var acc$18532;var $index$18796;var $length$18790;var temp$18784;var acc$18778;var $index$18859;var $length$18853;var temp$18847;var acc$18841;var decls$18833;var all_temps$18516;var the_parts$18517;var unique_temps$18518;(all_temps$18516=[]);(the_parts$18517=(((acc$18532=[])),(((temp$18538=scope$18507.step_all(["clause"],stmts$18509))),((($length$18544=temp$18538.length)),((($index$18550=0)),function(){$18524:for(;($index$18550<$length$18544);($index$18550++)){var accum$18662;var accum$18680;var t0$18654;var t1$18655;var $index$18707;var $length$18701;var temp$18695;var bod$18748;var placeholder$18589;var special_fn$18590;var vars$18591;var temps$18592;var blocks$18593;var vars2$18594;var x$18758;var other$18766;var b$18754;var pattern$18570;var body$18571;var $18529$18567;var t0$18564;var t1$18565;var m$18559;(m$18559=temp$18538[$index$18550]);(t0$18564=m$18559);if(((t0$18564 instanceof Array)&&(((t1$18565=t0$18564.length)),((t1$18565===3)&&(t0$18564[0]==="clause"))))){(pattern$18570=t0$18564[1]);(body$18571=t0$18564[2]);acc$18532.push((((placeholder$18589=(void 0))),((special_fn$18590=function($18605$18608,value$18609){var t0$18617;var t1$18618;var other$18650;var $18611$18633;var ph$18614;var expr$18615;(t0$18617=$18605$18608);if(((t0$18617 instanceof Array)&&(((t1$18618=t0$18617.length)),((t1$18618===2)&&(t0$18617[0]==="special"))))){(ph$18614=t0$18617[1]);(expr$18615=t0$18617);}else{$20192($18605$18608);}($18611$18633=ph$18614);if(($18611$18633==="match")){(placeholder$18589=__lt____lt____colon__$15997(["symbol",scope$18507.gensym("ph")],expr$18615));return ["assign",placeholder$18589];}else{(other$18650=$18611$18633);throw $19933(["syntax","pattern","special"]).create("Special token cannot be used here",({"special":expr$18615}));}})),(((t0$18654=parse_pattern$16012(scope$18507,pattern$18570,target$18508,$20211(opt$18510,$15902(({"allow_arguments":false,"allow_nested":true,"special":special_fn$18590}),$15902(((accum$18662=({})),((accum$18662["assign"]=function(v$18667,value$18668){return ["do",__lt____lt____colon__$15997(["assign",v$18667,value$18668],v$18667)];}),accum$18662)),({"finalize":false}))))))),function(){if(((t0$18654 instanceof Array)&&(((t1$18655=t0$18654.length)),(t1$18655===3)))){(vars$18591=t0$18654[0]);(temps$18592=t0$18654[1]);(blocks$18593=t0$18654[2]);}else{return $20192(parse_pattern$16012(scope$18507,pattern$18570,target$18508,$20211(opt$18510,$15902(({"allow_arguments":false,"allow_nested":true,"special":special_fn$18590}),$15902(((accum$18680=({})),((accum$18680["assign"]=function(v$18685,value$18686){return ["do",__lt____lt____colon__$15997(["assign",v$18685,value$18686],v$18685)];}),accum$18680)),({"finalize":false}))))),"/home/olivier/git/earl-grey/src/pattern.eg",14032,14379);}}()),(all_temps$18516=all_temps$18516.concat(temps$18592)),function(){if(placeholder$18589){return vars$18591.push(placeholder$18589);}}(),((vars2$18594=({}))),(((temp$18695=vars$18591)),((($length$18701=temp$18695.length)),((($index$18707=0)),function(){$18595:for(;($index$18707<$length$18701);($index$18707++)){var other$18744;var xxx$18726;var t0$18721;var t1$18722;var m$18716;(m$18716=temp$18695[$index$18707]);(t0$18721=m$18716);if(((t0$18721 instanceof Array)&&(((t1$18722=t0$18721.length)),((t1$18722===2)&&(t0$18721[0]==="symbol"))))){(xxx$18726=t0$18721[1]);(vars2$18594[xxx$18726]=true);}else{(other$18744=m$18716);throw $19933(["syntax","unexpected"]).create();}}}()))),(((bod$18748=function(){if(placeholder$18589){return parse_clauses$16015(scope$18507,placeholder$18589,$20234(["multi"])(body$18571)[1],opt$18510);}else{if(opt$18510.wrap){return opt$18510.wrap(body$18571);}else{return body$18571;}}}())),["clause",vars$18591,vars2$18594,blocks$18593,bod$18748])));}else{if((((x$18758=t0$18564)),((x$18758 instanceof Array)&&(x$18758[0]==="block")))){(b$18754=t0$18564);acc$18532.push(b$18754);}else{(other$18766=m$18559);acc$18532.push(function(){throw $19933(["syntax","clause"]).create("Illegal clause",({"clause":other$18766}));}());}}}}()))),acc$18532));if(opt$18510.fallback){the_parts$18517.push(["block",opt$18510.fallback(target$18508)]);}(unique_temps$18518=$20233(util$15998.mkset((((acc$18778=[])),(((temp$18784=all_temps$18516)),((($length$18790=temp$18784.length)),((($index$18796=0)),function(){$18773:for(;($index$18796<$length$18790);($index$18796++)){var t$18815;var t0$18810;var t1$18811;var m$18805;(m$18805=temp$18784[$index$18796]);(t0$18810=m$18805);if(((t0$18810 instanceof Array)&&(((t1$18811=t0$18810.length)),((t1$18811===2)&&(t0$18810[0]==="symbol"))))){(t$18815=t0$18810[1]);acc$18778.push(t$18815);}else{$20192(m$18805,"/home/olivier/git/earl-grey/src/pattern.eg",15188,15218);}}}()))),acc$18778))));(decls$18833=(((acc$18841=[])),(((temp$18847=unique_temps$18518)),((($length$18853=temp$18847.length)),((($index$18859=0)),function(){$18836:for(;($index$18859<$length$18853);($index$18859++)){var t$18876;var m$18868;(m$18868=temp$18847[$index$18859]);(t$18876=m$18868);acc$18841.push(["declare",$15902(["symbol",t$18876],({"mutable":true}))]);}}()))),acc$18841));return ["multi"].concat(decls$18833).concat([weave_clauses$16017(the_parts$18517)]);});(opt_clauses$16016=function(clauses$18885){var $index$18925;var $length$18919;var temp$18913;var acc$18907;var $index$19109;var $length$19103;var temp$19097;var acc$19091;var $index$19169;var $length$19163;var temp$19157;var acc$19151;var $index$19221;var $length$19215;var temp$19209;var acc$19203;var shares$18894;var max$18895;var temps$18896;var shared_last$18897;var idx_last$18898;var new_clauses$18899;(shares$18894=(((acc$18907=[])),(((temp$18913=$20166(clauses$18885.slice(1)))),((($length$18919=temp$18913.length)),((($index$18925=0)),function(){$18902:for(;($index$18925<$length$18919);($index$18925++)){var t0$18986;var t1$18987;var $index$19021;var $length$19015;var temp$19009;var varsd0$18978;var blocks0$18979;var share$18980;var idx$18981;var i$18946;var vars$18947;var varsd$18948;var blocks$18949;var body$18950;var t0$18939;var t1$18940;var t2$18941;var t3$18942;var m$18934;(m$18934=temp$18913[$index$18925]);(t0$18939=m$18934);if(((t0$18939 instanceof Array)&&(((t1$18940=t0$18939.length)),((t1$18940===2)&&((i$18946=t0$18939[0]),(((t2$18941=t0$18939[1])),((t2$18941 instanceof Array)&&(((t3$18942=t2$18941.length)),((t3$18942===5)&&(t2$18941[0]==="clause")))))))))){(vars$18947=t2$18941[1]);(varsd$18948=t2$18941[2]);(blocks$18949=t2$18941[3]);(body$18950=t2$18941[4]);acc$18907.push(((((t0$18986=$15901(clauses$18885,i$18946))),function(){if(((t0$18986 instanceof Array)&&(((t1$18987=t0$18986.length)),((t1$18987===5)&&(t0$18986[0]==="clause"))))){t0$18986[1];(varsd0$18978=t0$18986[2]);(blocks0$18979=t0$18986[3]);t0$18986[4];}else{return $20192($15901(clauses$18885,i$18946),"/home/olivier/git/earl-grey/src/pattern.eg",15511,15531);}}()),((share$18980=0)),((idx$18981=0)),(((temp$19009=blocks$18949)),((($length$19015=temp$19009.length)),((($index$19021=0)),function(){$18982:for(;($index$19021<$length$19015);($index$19021++)){var x$19058;var x$19068;var other$19079;var $19041$19047;var b$19038;var m$19030;(m$19030=temp$19009[$index$19021]);(b$19038=m$19030);if(same_block$16014([$15901(blocks0$18979,share$18980),b$19038],varsd0$18978,varsd$18948)){(share$18980++);($19041$19047=b$19038);if((((x$19058=$19041$19047)),((x$19058 instanceof Array)&&(x$19058[0]==="do")))){null;}else{if((((x$19068=$19041$19047)),((x$19068 instanceof Array)&&(x$19068[0]==="check")))){(idx$18981=share$18980);}else{(other$19079=$19041$19047);__lt____gt__$15995(null,other$19079);}}}else{break $18982;}}}()))),[share$18980,idx$18981]));}else{$20192(m$18934,"/home/olivier/git/earl-grey/src/pattern.eg",15387,15915);}}}()))),acc$18907));(max$18895=$15901(Math.max,(((acc$19091=[])),(((temp$19097=shares$18894)),((($length$19103=temp$19097.length)),((($index$19109=0)),function(){$19086:for(;($index$19109<$length$19103);($index$19109++)){var x$19128;var t0$19123;var t1$19124;var m$19118;(m$19118=temp$19097[$index$19109]);(t0$19123=m$19118);if(((t0$19123 instanceof Array)&&(((t1$19124=t0$19123.length)),(t1$19124===2)))){(x$19128=t0$19123[0]);t0$19123[1];acc$19091.push(x$19128);}else{$20192(m$19118,"/home/olivier/git/earl-grey/src/pattern.eg",15929,15958);}}}()))),acc$19091)));shares$18894.push([0,0]);(temps$18896=(((acc$19151=[])),(((temp$19157=$20345(1,max$18895))),((($length$19163=temp$19157.length)),((($index$19169=0)),function(){$19146:for(;($index$19169<$length$19163);($index$19169++)){var m$19178;(m$19178=temp$19157[$index$19169]);m$19178;acc$19151.push(["symbol",gensym$16000()]);}}()))),acc$19151));(shared_last$18897=0);(idx_last$18898=0);(new_clauses$18899=(((acc$19203=[])),(((temp$19209=$20166(clauses$18885))),((($length$19215=temp$19209.length)),((($index$19221=0)),function(){$19197:for(;($index$19221<$length$19215);($index$19221++)){var t0$19283;var t1$19284;var $index$19333;var $length$19327;var temp$19321;var acc$19315;var rest$19417;var newblocks$19412;var share$19277;var idx$19278;var shared$19279;var n_to_share$19280;var to_share$19281;var other$19424;var i$19242;var vars$19243;var varsd$19244;var blocks$19245;var body$19246;var t0$19235;var t1$19236;var t2$19237;var t3$19238;var m$19230;(m$19230=temp$19209[$index$19221]);(t0$19235=m$19230);if(((t0$19235 instanceof Array)&&(((t1$19236=t0$19235.length)),((t1$19236===2)&&((i$19242=t0$19235[0]),(((t2$19237=t0$19235[1])),((t2$19237 instanceof Array)&&(((t3$19238=t2$19237.length)),((t3$19238===5)&&(t2$19237[0]==="clause")))))))))){(vars$19243=t2$19237[1]);(varsd$19244=t2$19237[2]);(blocks$19245=t2$19237[3]);(body$19246=t2$19237[4]);acc$19203.push(((((t0$19283=$15901(shares$18894,i$19242))),function(){if(((t0$19283 instanceof Array)&&(((t1$19284=t0$19283.length)),(t1$19284===2)))){(share$19277=t0$19283[0]);(idx$19278=t0$19283[1]);}else{return $20192($15901(shares$18894,i$19242),"/home/olivier/git/earl-grey/src/pattern.eg",16187,16206);}}()),((shared$19279=function(){if(idx_last$18898){return [["check",$15901(temps$18896,(idx_last$18898-1))]];}else{return [];}}())),((n_to_share$19280=Math.max(shared_last$18897,share$19277))),((to_share$19281=(((acc$19315=[])),(((temp$19321=$20166(blocks$19245.slice(shared_last$18897,n_to_share$19280)))),((($length$19327=temp$19321.length)),((($index$19333=0)),function(){$19305:for(;($index$19333<$length$19327);($index$19333++)){var j$19385;var x$19386;var j$19358;var x$19359;var $19309$19352;var $19310$19353;var $19311$19354;var $19312$19355;var t0$19347;var t1$19348;var t2$19349;var t3$19350;var m$19342;(m$19342=temp$19321[$index$19333]);(t0$19347=m$19342);if((($19310$19353=(t0$19347 instanceof Array))&&(((t1$19348=t0$19347.length)),(($19312$19355=(t1$19348===2))&&((j$19358=t0$19347[0]),(((t2$19349=t0$19347[1])),((t2$19349 instanceof Array)&&(((t3$19350=t2$19349.length)),((t3$19350===2)&&(t2$19349[0]==="check")))))))))){(x$19359=t2$19349[1]);acc$19315.push(["check",["assign",$15901(temps$18896,(shared_last$18897+j$19358)),x$19359]]);}else{if(($19312$19355&&((j$19385=t0$19347[0]),(((t2$19349=t0$19347[1])),((t2$19349 instanceof Array)&&(((t3$19350=t2$19349.length)),((t3$19350===2)&&(t2$19349[0]==="do")))))))){(x$19386=t2$19349[1]);acc$19315.push(["do",x$19386]);}else{$20192(m$19342,"/home/olivier/git/earl-grey/src/pattern.eg",16335,16506);}}}}()))),acc$19315))),((shared_last$18897=share$19277)),((idx_last$18898=idx$19278)),(((newblocks$19412=(((rest$19417=blocks$19245.slice(n_to_share$19280))),shared$19279.concat(to_share$19281).concat(rest$19417)))),["clause",vars$19243,varsd$19244,newblocks$19412,body$19246])));}else{(other$19424=m$19230);acc$19203.push(function(){throw $19933(["oops"]).create("what",({"value":other$19424}));}());}}}()))),acc$19203));return [temps$18896,new_clauses$18899];});(weave_clauses$16017=function(parts$19433){var $index$19498;var $length$19492;var temp$19486;var $index$19762;var $length$19756;var temp$19750;var acc$19744;var groups$19440;var reassemble$19441;var new_temps$19442;var helper$19443;(groups$19440=classify_contiguous$16003(parts$19433,function($19455$19458){var t0$19462;var t1$19463;var cls$19460;(t0$19462=$19455$19458);if(((t0$19462 instanceof Array)&&(((t1$19463=t0$19462.length)),(t1$19463>=1)))){(cls$19460=t0$19462[0]);Array.prototype.slice.call(t0$19462,1);}else{$20192($19455$19458);}return cls$19460;}));(reassemble$19441=[]);(new_temps$19442=[]);(temp$19486=groups$19440);($length$19492=temp$19486.length);($index$19498=0);$19444:for(;($index$19498<$length$19492);($index$19498++)){var t0$19538;var t1$19539;var ts$19535;var new_clauses$19536;var elems$19554;var elems$19521;var $19448$19515;var $19449$19516;var $19450$19517;var $19451$19518;var t0$19512;var t1$19513;var m$19507;(m$19507=temp$19486[$index$19498]);(t0$19512=m$19507);if((($19449$19516=(t0$19512 instanceof Array))&&(((t1$19513=t0$19512.length)),(($19451$19518=(t1$19513>=1))&&(t0$19512[0]==="clause"))))){(elems$19521=Array.prototype.slice.call(t0$19512,1));(t0$19538=opt_clauses$16016(elems$19521));if(((t0$19538 instanceof Array)&&(((t1$19539=t0$19538.length)),(t1$19539===2)))){(ts$19535=t0$19538[0]);(new_clauses$19536=t0$19538[1]);}else{$20192(opt_clauses$16016(elems$19521),"/home/olivier/git/earl-grey/src/pattern.eg",17015,17043);}(new_temps$19442=new_temps$19442.concat(ts$19535));(reassemble$19441=reassemble$19441.concat(new_clauses$19536));}else{if(($19451$19518&&(t0$19512[0]==="block"))){(elems$19554=Array.prototype.slice.call(t0$19512,1));(reassemble$19441=reassemble$19441.concat(elems$19554));}else{$20192(m$19507,"/home/olivier/git/earl-grey/src/pattern.eg",16949,17154);}}}(helper$19443=function($19562$19565){var $index$19678;var $length$19672;var temp$19666;var acc$19660;var decls$19652;var vars$19643;var varsd$19644;var blocks$19645;var body$19646;var rest$19647;var body$19612;var rest$19613;var $19571$19595;var $19572$19596;var $19573$19597;var $19574$19598;var $19575$19599;var $19576$19600;var t0$19588;var t1$19589;var t2$19590;var t3$19591;var t4$19592;var t5$19593;var $19567$19583;var ph$19577;(ph$19577=$19562$19565);($19567$19583=ph$19577);if((($19571$19595=($19567$19583 instanceof Array))&&(((t0$19588=$19567$19583.length)),(t0$19588===0)))){return ["multi"];}else{if(($19571$19595&&(($19573$19597=(t0$19588>=1))&&(((t1$19589=$19567$19583[0])),(($19575$19599=(t1$19589 instanceof Array))&&(((t2$19590=t1$19589.length)),((t2$19590===2)&&((t1$19589[0]==="block")&&(((t3$19591=$20234(["multi"])(t1$19589[1]))),(t3$19591[0]&&(((t4$19592=t3$19591[1])),(((t5$19593=t4$19592.length)),(t5$19593>=0))))))))))))){(body$19612=Array.prototype.slice.call(t4$19592,0));(rest$19613=Array.prototype.slice.call($19567$19583,1));return ["multi"].concat(body$19612).concat([helper$19443(rest$19613)]);}else{if(($19575$19599&&((t2$19590===5)&&(t1$19589[0]==="clause")))){(vars$19643=t1$19589[1]);(varsd$19644=t1$19589[2]);(blocks$19645=t1$19589[3]);(body$19646=t1$19589[4]);(rest$19647=Array.prototype.slice.call($19567$19583,1));(decls$19652=(((acc$19660=[])),(((temp$19666=vars$19643)),((($length$19672=temp$19666.length)),((($index$19678=0)),function(){$19655:for(;($index$19678<$length$19672);($index$19678++)){var bridge$19703$19711;var $19698$19706;var v$19695;var m$19687;(m$19687=temp$19666[$index$19678]);(v$19695=m$19687);acc$19660.push(((($19698$19706=v$19695.declare_mode)),function(){if(($19698$19706==="set")){return ["splice"];}else{if(($19698$19706==="let")){return ["declare",$20211(v$19695,({"mutable":false}))];}else{if(($19698$19706==="var")){return ["declare",$20211(v$19695,({"mutable":true}))];}else{(bridge$19703$19711=$19698$19706);if(((bridge$19703$19711==="unqualified")||(bridge$19703$19711===(void 0)))){return ["declare",$20211(v$19695,({"mutable":false}))];}else{$20192($19698$19706);}}}}}()));}}()))),acc$19660));return ["tagscope","back",["multi"].concat(decls$19652).concat([assemble_pattern$16010(blocks$19645,body$19646,["use","back",helper$19443(rest$19647)])])];}else{$20192($19567$19583);}}}});return ["multi"].concat((((acc$19744=[])),(((temp$19750=new_temps$19442)),((($length$19756=temp$19750.length)),((($index$19762=0)),function(){$19739:for(;($index$19762<$length$19756);($index$19762++)){var t$19779;var m$19771;(m$19771=temp$19750[$index$19762]);(t$19779=m$19771);acc$19744.push(["declare",t$19779]);}}()))),acc$19744)).concat([helper$19443(reassemble$19441)]);});(exports["PatternParser"]=PatternParser$16007);(exports["PatternProcessor"]=PatternProcessor$16008);(exports["parse_clauses"]=parse_clauses$16015);(exports["parse_pattern"]=parse_pattern$16012);

},{"./expand":9,"./location":11,"./pp":15,"./util":18}],15:[function(require,module,exports){
var $20603=function(type$20606){var f$20610;(f$20610=type$20606["::check"]);if((f$20610===(void 0))){return function(value$20616){return (value$20616 instanceof type$20606);};}else{return function(value$20620){return f$20610.call(type$20606,value$20620);};}};
var $20622=(function(o,m){if(typeof(m)==='string'||typeof(m)==='number'){return o[m];}else{return o['::send'](m);}});
var $20623=function(dest$20626,values$20627){var k$20632;(k$20632=null);$20630:for(k$20632 in values$20627){if(values$20627.hasOwnProperty(k$20632)){(dest$20626[k$20632]=values$20627[k$20632]);}}return dest$20626;};
var $20640=function($20642$20645){var ph$20651;(ph$20651=$20642$20645);var $20647$20657;($20647$20657=ph$20651);var bridge$20649$20662;var x$20666;(bridge$20649$20662=$20647$20657);if((((typeof(bridge$20649$20662)==="string")&&((x$20666=bridge$20649$20662),true))||((typeof(bridge$20649$20662)==="number")&&((x$20666=bridge$20649$20662),true)))){return ["value",x$20666];}else{var other$20677;(other$20677=$20647$20657);return other$20677["::serialize_ast"]();}};
var send$20377;(send$20377=function(obj$20384,$20381$20385){var ph$20391;var msg$20392;var t0$20394;(t0$20394=$20381$20385);(msg$20392=t0$20394);(ph$20391=t0$20394);var $20387$20403;($20387$20403=ph$20391);var bridge$20389$20408;(bridge$20389$20408=$20387$20403);if(((typeof(bridge$20389$20408)==="string")||(typeof(bridge$20389$20408)==="number"))){return obj$20384[msg$20392];}else{var other$20420;(other$20420=$20387$20403);return obj$20384["::send"](msg$20392);}});(Array[":::project"]=function($20426$20429){var ph$20434;var value$20435;var t0$20437;(t0$20437=$20426$20429);(value$20435=t0$20437);(ph$20434=t0$20437);var $20431$20446;($20431$20446=ph$20434);if($20603(Array)($20431$20446)){return [true,value$20435];}else{$20431$20446;return [true,[value$20435]];}});(Array.prototype["::check"]=function(value$20464){if((value$20464 instanceof Array)){var i$20470;(i$20470=0);$20467:for(;(i$20470<this.length);(i$20470++)){if(($20622(this,i$20470)!==$20622(value$20464,i$20470))){return false;}}return true;}else{return false;}});(Array.prototype["::clone"]=function(){return $20623(this.slice(0),this);});(Array.prototype[":::project"]=function(value$20489){if((value$20489 instanceof Array)){var i$20495;(i$20495=0);$20492:for(;(i$20495<this.length);(i$20495++)){if(($20622(this,i$20495)!==$20622(value$20489,i$20495))){return [true,[value$20489]];}}return [true,value$20489.slice(this.length)];}else{return [true,[value$20489]];}});(Array.prototype["::serialize_ast"]=function(){return ["array"].concat(this.map($20640));});(RegExp.prototype["::check"]=function($20513$20516){var ph$20521;(ph$20521=$20513$20516);var $20518$20527;($20518$20527=ph$20521);var value$20535;if((typeof($20518$20527)==="string")){(value$20535=$20518$20527);if(value$20535.match(this)){return true;}else{return false;}}else{var other$20540;(other$20540=$20518$20527);return false;}});(RegExp.prototype[":::project"]=function($20546$20549){var ph$20554;(ph$20554=$20546$20549);var $20551$20560;($20551$20560=ph$20554);var value$20568;if((typeof($20551$20560)==="string")){(value$20568=$20551$20560);var $20571$20576;($20571$20576=value$20568.match(this));var m$20584;if(($20571$20576===null)){(m$20584=$20571$20576);return [false,null];}else{var m$20589;(m$20589=$20571$20576);return [true,m$20589];}}else{var other$20593;(other$20593=$20551$20560);return [false,null];}});(Function.prototype["::send"]=function(args$20600){return this.apply(this,args$20600);});
var $21790=function(type$21793){return function(value$21797){var f$21801;(f$21801=type$21793[":::project"]);if((f$21801===(void 0))){(f$21801=type$21793["::project"]);if((f$21801===(void 0))){return [true,type$21793(value$21797)];}else{var rval$21814;(rval$21814=false);try{(rval$21814=[true,f$21801(value$21797)]);}catch(excv$21825){var e$21831;(e$21831=excv$21825);(rval$21814=[false,null]);}return rval$21814;}}else{return f$21801.call(type$21793,value$21797);}};};
var $22089=function(arr$22092){var results$22098;var l$22099;(results$22098=[]);(l$22099=arr$22092.length);var i$22108;(i$22108=0);$22097:for(;(i$22108<l$22099);(i$22108++)){results$22098.push([i$22108,$20622(arr$22092,i$22108)]);}return results$22098;};
var $21856=function(){var $21857$21863;($21857$21863=function(tags$21868){var it$0$21871;(it$0$21871=function(){if((!$20603($21857$21863)(this))){return Object.create($21857$21863.prototype);}else{return this;}}());(it$0$21871["tags"]=tags$21868);return it$0$21871;});($21857$21863.prototype["create"]=function(){var it$0$21891;var self$21892;(it$0$21891=this);(self$21892=this);var $21889$21901;($21889$21901=arguments);var t0$21906;var message$21910;var args$21911;(t0$21906=$21889$21901.length);if((t0$21906>=0)){(message$21910=function(){if((0>=t0$21906)){return "";}else{return $21889$21901[0];}}());(args$21911=Array.prototype.slice.call($21889$21901,1));var e$21924;(e$21924=Error(message$21910));(e$21924["::tags"]=it$0$21891.tags);(e$21924["args"]=args$21911);var temp$21940;(temp$21940=$22089(args$21911));var $length$21946;($length$21946=temp$21940.length);var $index$21952;($index$21952=0);$21925:for(;($index$21952<$length$21946);($index$21952++)){var m$21961;(m$21961=temp$21940[$index$21952]);var t0$21966;var t1$21967;var i$21971;var arg$21972;(t0$21966=m$21961);if(((t0$21966 instanceof Array)&&(((t1$21967=t0$21966.length)),(t1$21967===2)))){(i$21971=t0$21966[0]);(arg$21972=t0$21966[1]);(e$21924[i$21971]=arg$21972);}else{$21837(m$21961);}}(e$21924["length"]=args$21911.length);(e$21924["name"]=["E"].concat(it$0$21891.tags).join("."));return e$21924;}else{$21837($21889$21901);}});($21857$21863.prototype["::check"]=function(e$22002){var it$0$22006;var self$22007;(it$0$22006=this);(self$22007=this);var tags$22017;if(((!e$22002)||(!$20603(Error)(e$22002)))){return false;}(tags$22017=(e$22002["::tags"]||[]));var temp$22028;(temp$22028=it$0$22006.tags);var $length$22034;($length$22034=temp$22028.length);var $index$22040;($index$22040=0);$22018:for(;($index$22040<$length$22034);($index$22040++)){var m$22049;(m$22049=temp$22028[$index$22040]);var tag$22057;(tag$22057=m$22049);if((tags$22017.indexOf(tag$22057)===-1)){return false;}else{false;}}return true;});($21857$21863.prototype["::deconstruct"]=function(e$22066){var it$0$22070;var self$22071;(it$0$22070=this);(self$22071=this);return e$22066.args;});$20623($21857$21863,$20623(function(){var accum$22082;(accum$22082=({}));(accum$22082["::name"]="$21857");return accum$22082;}(),function(){var accum$22086;(accum$22086=({}));(accum$22086["::egclass"]=true);return accum$22086;}()));return $21857$21863;}();
var $21837=function(value$21840,url$21841,start$21842,end$21843){var err$21847;(err$21847=$21856(["match"]).create("Could not find a match for value",({"value":value$21840})));if(url$21841){(err$21847["location"]=["location",url$21841,start$21842,end$21843]);}throw err$21847;};
var $22115=function($22117$22120,key$22121){var ph$22129;(ph$22129=$22117$22120);var $22123$22135;($22123$22135=ph$22129);var bridge$22125$22140;(bridge$22125$22140=$22123$22135);if(((bridge$22125$22140===null)||(bridge$22125$22140===(void 0)))){return false;}else{var x$22152;if((typeof($22123$22135)==="string")){(x$22152=$22123$22135);return (key$22121 in String.prototype);}else{var x$22157;if((typeof($22123$22135)==="number")){(x$22157=$22123$22135);return (key$22121 in Number.prototype);}else{var x$22162;(x$22162=$22123$22135);return (key$22121 in x$22162);}}}};
var $21501=function(){var $21502$21507;($21502$21507=function($21511$21518,$21513$21519,$21515$21520){var it$0$21523;(it$0$21523=function(){if((!$20603($21502$21507)(this))){return Object.create($21502$21507.prototype);}else{return this;}}());var t0$21530;(t0$21530=$21790(Array)($21511$21518));if(t0$21530[0]){(it$0$21523["tags"]=t0$21530[1]);}else{$21837($21511$21518);}(it$0$21523["props"]=$21513$21519);var t0$21542;(t0$21542=$21790(Array)($21515$21520));if(t0$21542[0]){(it$0$21523["children"]=t0$21542[1]);}else{$21837($21515$21520);}undefined;return it$0$21523;});$20623(function(){var accum$21556;(accum$21556=({}));(accum$21556["::check"]=function(x$21561){return (((x$21561&&x$21561.tags)&&x$21561.props)&&x$21561.children);});return accum$21556;}(),$20623(function(){var accum$21564;(accum$21564=({}));(accum$21564[":::project"]=function($21568$21571){var ph$21576;(ph$21576=$21568$21571);var $21573$21582;($21573$21582=ph$21576);var tags$21590;var props$21591;var children$21592;if(($22115($21573$21582,"tags")&&((tags$21590=$21573$21582.tags),($22115($21573$21582,"props")&&((props$21591=$21573$21582.props),$22115($21573$21582,"children")))))){(children$21592=$21573$21582.children);return [true,[tags$21590,props$21591,children$21592]];}else{$21573$21582;return [false,null];}});return accum$21564;}(),$20623(function(){var accum$21601;(accum$21601=({}));(accum$21601["::name"]="$21502");return accum$21601;}(),function(){var accum$21605;(accum$21605=({}));(accum$21605["::egclass"]=true);return accum$21605;}())));($21502$21507.prototype["::check"]=function($21611$21614){var it$0$21618;var self$21619;(it$0$21618=this);(self$21619=this);var ph$21630;(ph$21630=$21611$21614);var $21627$21636;($21627$21636=ph$21630);var n$21644;if($20603($21501)($21627$21636)){(n$21644=$21627$21636);var temp$21654;(temp$21654=it$0$21618.tags);var $length$21660;($length$21660=temp$21654.length);var $index$21666;($index$21666=0);$21648:for(;($index$21666<$length$21660);($index$21666++)){var m$21675;(m$21675=temp$21654[$index$21666]);var c$21683;(c$21683=m$21675);if((n$21644.tags.indexOf(c$21683)===-1)){return false;}else{false;}}return true;}else{$21627$21636;return false;}});($21502$21507.prototype[":::project"]=function($21694$21697){var it$0$21701;var self$21702;(it$0$21701=this);(self$21702=this);var ph$21713;(ph$21713=$21694$21697);var $21710$21719;($21710$21719=ph$21713);var n$21727;if($20603(it$0$21701)($21710$21719)){(n$21727=$21710$21719);return [true,[n$21727.tags,n$21727.props,n$21727.children]];}else{$21710$21719;return [false,null];}});$20623($21502$21507,$20623(function(){var accum$21738;(accum$21738=({}));(accum$21738["::check"]=function(x$21743){return (((x$21743&&x$21743.tags)&&x$21743.props)&&x$21743.children);});return accum$21738;}(),$20623(function(){var accum$21746;(accum$21746=({}));(accum$21746[":::project"]=function($21750$21753){var ph$21758;(ph$21758=$21750$21753);var $21755$21764;($21755$21764=ph$21758);var tags$21772;var props$21773;var children$21774;if(($22115($21755$21764,"tags")&&((tags$21772=$21755$21764.tags),($22115($21755$21764,"props")&&((props$21773=$21755$21764.props),$22115($21755$21764,"children")))))){(children$21774=$21755$21764.children);return [true,[tags$21772,props$21773,children$21774]];}else{$21755$21764;return [false,null];}});return accum$21746;}(),$20623(function(){var accum$21783;(accum$21783=({}));(accum$21783["::name"]="$21502");return accum$21783;}(),function(){var accum$21787;(accum$21787=({}));(accum$21787["::egclass"]=true);return accum$21787;}()))));return $21502$21507;}();
var $22164=function(obj$22167){var results$22172;(results$22172=[]);var k$22177;(k$22177=null);$22171:for(k$22177 in obj$22167){if(Object.prototype.hasOwnProperty.call(obj$22167,k$22177)){results$22172.push([k$22177,$20622(obj$22167,k$22177)]);}}return results$22172;};var pr_terminus$20688;var pr$20689;var __lt____gt__$20690;var repr$20691;var escape_html$20692;var quotify$20693;var HTML$20694;(pr_terminus$20688=function(node$20699){var r$20705;var pre$20706;var post$20707;(r$20705=HTML$20694(node$20699,"span"));(pre$20706=(String.fromCharCode(27)+"[?0;7y+h <div class=\"ug\">"));(post$20707=("</div>"+String.fromCharCode(7)));return console.log(((pre$20706+r$20705)+post$20707));});(pr$20689=function($20721$20724,r$20725){var x$20749;var n$20744;var $20727$20736;var ph$20730;(ph$20730=$20721$20724);($20727$20736=ph$20730);if($20603($21501)($20727$20736)){(n$20744=$20727$20736);return pr_terminus$20688(n$20744);}else{(x$20749=$20727$20736);return pr_terminus$20688((r$20725||repr$20691)(x$20749));}});(__lt____gt__$20690=function($20755$20758,x$20759){if(($20755$20758===null)){}else{$21837($20755$20758);}return pr$20689(x$20759);});(repr$20691=function(){var $index$20878;var $length$20872;var temp$20866;var acc$20860;var $index$20929;var $length$20923;var temp$20917;var acc$20911;var other$20966;var entries$20848;var $20783$20821;var t0$20819;var x$20797;var recur$20798;var $20772$20799;var t0$20791;var t1$20792;var t2$20793;var $20770$20786;($20770$20786=arguments);(t0$20791=$20770$20786.length);if((((t0$20791>=1)&&(t0$20791<=2))&&(((t1$20792=$20770$20786[0])),((x$20797=t1$20792),(($20772$20799=t1$20792),(((t2$20793=function(){if((1>=t0$20791)){return repr$20691;}else{return $20770$20786[1];}}())),$20603(Function)(t2$20793))))))){(recur$20798=t2$20793);if(($20772$20799===true)){return $21501([".special",".true"],({}),"true");}else{if(($20772$20799===false)){return $21501([".special",".false"],({}),"false");}else{if(($20772$20799===null)){return $21501([".special",".nil"],({}),"null");}else{if(($20772$20799===(void 0))){return $21501([".special",".nil"],({}),"undefined");}else{if((typeof($20772$20799)==="number")){return $21501([".num"],({}),String(x$20797));}else{if((typeof($20772$20799)==="string")){return $21501([".str"],({}),x$20797);}else{(t0$20819=$20772$20799);if($20603(Array)(t0$20819)){(entries$20848=t0$20819);return $21501([".sequence"],({}),(((acc$20860=[])),(((temp$20866=entries$20848)),((($length$20872=temp$20866.length)),((($index$20878=0)),function(){$20855:for(;($index$20878<$length$20872);($index$20878++)){var x$20895;var m$20887;(m$20887=temp$20866[$index$20878]);(x$20895=m$20887);acc$20860.push(recur$20798(x$20895,repr$20691));}}()))),acc$20860));}else{$20772$20799;if(x$20797["::repr"]){return x$20797["::repr"](recur$20798);}else{if((Object.getPrototypeOf(x$20797)===Object.prototype)){return $21501(["table",".object"],({}),(((acc$20911=[])),(((temp$20917=$22164(x$20797))),((($length$20923=temp$20917.length)),((($index$20929=0)),function(){$20906:for(;($index$20929<$length$20923);($index$20929++)){var k$20948;var v$20949;var t0$20943;var t1$20944;var m$20938;(m$20938=temp$20917[$index$20929]);(t0$20943=m$20938);if(((t0$20943 instanceof Array)&&(((t1$20944=t0$20943.length)),(t1$20944===2)))){(k$20948=t0$20943[0]);(v$20949=t0$20943[1]);acc$20911.push($21501(["tr"],({}),[$21501(["th"],({}),recur$20798(k$20948,repr$20691)),$21501(["td"],({}),recur$20798(v$20949,repr$20691))]));}else{$21837(m$20938,"/home/olivier/git/earl-grey/src/pp.eg",914,1244);}}}()))),acc$20911));}else{(other$20966=$20772$20799);return $21501([".unknown"],({}),other$20966.toString());}}}}}}}}}}else{$21837($20770$20786);}});(escape_html$20692=function($20974$20977){var t0$20981;var repl$20991;var s$20979;(t0$20981=[true,String($20974$20977)]);if(t0$20981[0]){(s$20979=t0$20981[1]);}else{$21837($20974$20977);}(repl$20991=({"&":"&amp;","<":"&lt;",">":"&gt;"}));return s$20979.replace(RegExp("[&<>]","g"),function(x$20997){return $20622(repl$20991,x$20997);});});(quotify$20693=function($21003$21006){var t0$21010;var s$21008;(t0$21010=[true,String($21003$21006)]);if(t0$21010[0]){(s$21008=t0$21010[1]);}else{$21837($21003$21006);}return s$21008.replace(RegExp("[\"\\\\]","g"),function(x$21020){return ("\\"+x$21020);});});(HTML$20694=function($21026$21029,default_tag$21030){var $index$21083;var $length$21077;var temp$21071;var acc$21065;var $index$21167;var $length$21161;var temp$21155;var $index$21227;var $length$21221;var temp$21215;var $index$21298;var $length$21292;var temp$21286;var acc$21280;var $index$21378;var $length$21372;var temp$21366;var acc$21360;var $index$21436;var $length$21430;var temp$21424;var acc$21418;var other$21411;var $21339$21344;var x$21475;var other$21471;var $21120$21459;var tag$21123;var classes$21124;var id$21125;var kv$21126;var sub$21127;var accum$21128;var children2$21129;var other$21481;var tags$21105;var props$21106;var children$21107;var children$21056;var s$21051;var $21032$21043;var ph$21037;(ph$21037=$21026$21029);($21032$21043=ph$21037);if((typeof($21032$21043)==="string")){(s$21051=$21032$21043);return escape_html$20692(s$21051);}else{if($20603(Array)($21032$21043)){(children$21056=$21032$21043);return (((acc$21065=[])),(((temp$21071=children$21056)),((($length$21077=temp$21071.length)),((($index$21083=0)),function(){$21060:for(;($index$21083<$length$21077);($index$21083++)){var child$21100;var m$21092;(m$21092=temp$21071[$index$21083]);(child$21100=m$21092);acc$21065.push(HTML$20694(child$21100,default_tag$21030));}}()))),acc$21065).join("");}else{if(($20603($21501)($21032$21043)&&($22115($21032$21043,"tags")&&((tags$21105=$21032$21043.tags),($22115($21032$21043,"props")&&((props$21106=$21032$21043.props),$22115($21032$21043,"children"))))))){(children$21107=$21032$21043.children);(tag$21123=(default_tag$21030||"span"));(classes$21124=[]);(id$21125=null);(kv$21126=[]);(sub$21127=[]);(temp$21155=tags$21105);($length$21161=temp$21155.length);($index$21167=0);$21130:for(;($index$21167<$length$21161);($index$21167++)){var other$21206;var cls$21187;var t0$21181;var t1$21182;var t2$21183;var m$21176;(m$21176=temp$21155[$index$21167]);(t0$21181=$21790(RegExp("^\\.(.*)",""))(m$21176));if((t0$21181[0]&&(((t1$21182=t0$21181[1])),(((t2$21183=t1$21182.length)),(t2$21183===2))))){t1$21182[0];(cls$21187=t1$21182[1]);classes$21124.push(cls$21187);}else{(other$21206=m$21176);(tag$21123=other$21206);}}(temp$21215=$22164(props$21106));($length$21221=temp$21215.length);($index$21227=0);$21134:for(;($index$21227<$length$21221);($index$21227++)){var k$21246;var v$21247;var t0$21241;var t1$21242;var m$21236;(m$21236=temp$21215[$index$21227]);(t0$21241=m$21236);if(((t0$21241 instanceof Array)&&(((t1$21242=t0$21241.length)),(t1$21242===2)))){(k$21246=t0$21241[0]);(v$21247=t0$21241[1]);kv$21126.push([k$21246,v$21247]);}else{$21837(m$21236,"/home/olivier/git/earl-grey/src/pp.eg",1956,2020);}}(accum$21128=function(){if((tag$21123==="raw")){return [];}else{return ["<",tag$21123];}}());if(id$21125){(accum$21128=accum$21128.concat(" id=\"",id$21125,"\""));}if(classes$21124.length){(accum$21128=accum$21128.concat(" class=\"",quotify$20693(classes$21124.join(" ")),"\""));}if(kv$21126){(acc$21280=[]);(temp$21286=kv$21126);($length$21292=temp$21286.length);($index$21298=0);$21275:for(;($index$21298<$length$21292);($index$21298++)){var k$21317;var v$21318;var t0$21312;var t1$21313;var m$21307;(m$21307=temp$21286[$index$21298]);(t0$21312=m$21307);if(((t0$21312 instanceof Array)&&(((t1$21313=t0$21312.length)),(t1$21313===2)))){(k$21317=t0$21312[0]);(v$21318=t0$21312[1]);acc$21280.push(((accum$21128=accum$21128.concat(function(){if((v$21318!==null)){return [" ",k$21317,"=\"",quotify$20693(v$21318),"\""];}else{return [" ",k$21317];}}()))));}else{$21837(m$21307,"/home/olivier/git/earl-grey/src/pp.eg",2282,2482);}}acc$21280;}(children2$21129=((($21339$21344=tag$21123)),function(){if(($21339$21344==="raw")){(acc$21360=[]);(temp$21366=children$21107);($length$21372=temp$21366.length);($index$21378=0);$21354:for(;($index$21378<$length$21372);($index$21378++)){var c$21406;var s$21396;var t0$21392;var m$21387;(m$21387=temp$21366[$index$21378]);(t0$21392=m$21387);if((typeof(t0$21392)==="string")){(s$21396=t0$21392);acc$21360.push(s$21396);}else{(c$21406=m$21387);acc$21360.push(HTML$20694(c$21406,default_tag$21030));}}return acc$21360;}else{(other$21411=$21339$21344);(acc$21418=[]);(temp$21424=children$21107);($length$21430=temp$21424.length);($index$21436=0);$21413:for(;($index$21436<$length$21430);($index$21436++)){var c$21453;var m$21445;(m$21445=temp$21424[$index$21436]);(c$21453=m$21445);acc$21418.push(HTML$20694(c$21453,default_tag$21030));}return acc$21418;}}()));($21120$21459=tag$21123);if(($21120$21459==="raw")){return accum$21128.concat(children2$21129).join("");}else{(other$21471=$21120$21459);(x$21475=[">"].concat(children2$21129).concat(["</",tag$21123,">"]));return accum$21128.concat(x$21475).join("");}}else{(other$21481=$21032$21043);return HTML$20694([true,String(other$21481)][1],default_tag$21030);}}}});(exports["pr_terminus"]=pr_terminus$20688);(exports["pr"]=pr$20689);(exports["<>"]=__lt____gt__$20690);(exports["repr"]=repr$20691);

},{}],16:[function(require,module,exports){
var $25294=function(type$25297){var f$25301;(f$25301=type$25297["::check"]);if((f$25301===(void 0))){return function(value$25307){return (value$25307 instanceof type$25297);};}else{return function(value$25311){return f$25301.call(type$25297,value$25311);};}};
var $25313=(function(o,m){if(typeof(m)==='string'||typeof(m)==='number'){return o[m];}else{return o['::send'](m);}});
var $25314=function(dest$25317,values$25318){var k$25323;(k$25323=null);$25321:for(k$25323 in values$25318){if(values$25318.hasOwnProperty(k$25323)){(dest$25317[k$25323]=values$25318[k$25323]);}}return dest$25317;};
var $25331=function($25333$25336){var ph$25342;(ph$25342=$25333$25336);var $25338$25348;($25338$25348=ph$25342);var bridge$25340$25353;var x$25357;(bridge$25340$25353=$25338$25348);if((((typeof(bridge$25340$25353)==="string")&&((x$25357=bridge$25340$25353),true))||((typeof(bridge$25340$25353)==="number")&&((x$25357=bridge$25340$25353),true)))){return ["value",x$25357];}else{var other$25368;(other$25368=$25338$25348);return other$25368["::serialize_ast"]();}};
var send$25068;(send$25068=function(obj$25075,$25072$25076){var ph$25082;var msg$25083;var t0$25085;(t0$25085=$25072$25076);(msg$25083=t0$25085);(ph$25082=t0$25085);var $25078$25094;($25078$25094=ph$25082);var bridge$25080$25099;(bridge$25080$25099=$25078$25094);if(((typeof(bridge$25080$25099)==="string")||(typeof(bridge$25080$25099)==="number"))){return obj$25075[msg$25083];}else{var other$25111;(other$25111=$25078$25094);return obj$25075["::send"](msg$25083);}});(Array[":::project"]=function($25117$25120){var ph$25125;var value$25126;var t0$25128;(t0$25128=$25117$25120);(value$25126=t0$25128);(ph$25125=t0$25128);var $25122$25137;($25122$25137=ph$25125);if($25294(Array)($25122$25137)){return [true,value$25126];}else{$25122$25137;return [true,[value$25126]];}});(Array.prototype["::check"]=function(value$25155){if((value$25155 instanceof Array)){var i$25161;(i$25161=0);$25158:for(;(i$25161<this.length);(i$25161++)){if(($25313(this,i$25161)!==$25313(value$25155,i$25161))){return false;}}return true;}else{return false;}});(Array.prototype["::clone"]=function(){return $25314(this.slice(0),this);});(Array.prototype[":::project"]=function(value$25180){if((value$25180 instanceof Array)){var i$25186;(i$25186=0);$25183:for(;(i$25186<this.length);(i$25186++)){if(($25313(this,i$25186)!==$25313(value$25180,i$25186))){return [true,[value$25180]];}}return [true,value$25180.slice(this.length)];}else{return [true,[value$25180]];}});(Array.prototype["::serialize_ast"]=function(){return ["array"].concat(this.map($25331));});(RegExp.prototype["::check"]=function($25204$25207){var ph$25212;(ph$25212=$25204$25207);var $25209$25218;($25209$25218=ph$25212);var value$25226;if((typeof($25209$25218)==="string")){(value$25226=$25209$25218);if(value$25226.match(this)){return true;}else{return false;}}else{var other$25231;(other$25231=$25209$25218);return false;}});(RegExp.prototype[":::project"]=function($25237$25240){var ph$25245;(ph$25245=$25237$25240);var $25242$25251;($25242$25251=ph$25245);var value$25259;if((typeof($25242$25251)==="string")){(value$25259=$25242$25251);var $25262$25267;($25262$25267=value$25259.match(this));var m$25275;if(($25262$25267===null)){(m$25275=$25262$25267);return [false,null];}else{var m$25280;(m$25280=$25262$25267);return [true,m$25280];}}else{var other$25284;(other$25284=$25242$25251);return [false,null];}});(Function.prototype["::send"]=function(args$25291){return this.apply(this,args$25291);});
var $36545=function($36547$36550,key$36551){var ph$36559;(ph$36559=$36547$36550);var $36553$36565;($36553$36565=ph$36559);var bridge$36555$36570;(bridge$36555$36570=$36553$36565);if(((bridge$36555$36570===null)||(bridge$36555$36570===(void 0)))){return false;}else{var x$36582;if((typeof($36553$36565)==="string")){(x$36582=$36553$36565);return (key$36551 in String.prototype);}else{var x$36587;if((typeof($36553$36565)==="number")){(x$36587=$36553$36565);return (key$36551 in Number.prototype);}else{var x$36592;(x$36592=$36553$36565);return (key$36551 in x$36592);}}}};
var $36827=function(arr$36830){var results$36836;var l$36837;(results$36836=[]);(l$36837=arr$36830.length);var i$36846;(i$36846=0);$36835:for(;(i$36846<l$36837);(i$36846++)){results$36836.push([i$36846,$25313(arr$36830,i$36846)]);}return results$36836;};
var $36853=function(value$36856,url$36857,start$36858,end$36859){var err$36863;(err$36863=$36594(["match"]).create("Could not find a match for value",({"value":value$36856})));if(url$36857){(err$36863["location"]=["location",url$36857,start$36858,end$36859]);}throw err$36863;};
var $36594=function(){var $36595$36601;($36595$36601=function(tags$36606){var it$0$36609;(it$0$36609=function(){if((!$25294($36595$36601)(this))){return Object.create($36595$36601.prototype);}else{return this;}}());(it$0$36609["tags"]=tags$36606);return it$0$36609;});($36595$36601.prototype["create"]=function(){var it$0$36629;var self$36630;(it$0$36629=this);(self$36630=this);var $36627$36639;($36627$36639=arguments);var t0$36644;var message$36648;var args$36649;(t0$36644=$36627$36639.length);if((t0$36644>=0)){(message$36648=function(){if((0>=t0$36644)){return "";}else{return $36627$36639[0];}}());(args$36649=Array.prototype.slice.call($36627$36639,1));var e$36662;(e$36662=Error(message$36648));(e$36662["::tags"]=it$0$36629.tags);(e$36662["args"]=args$36649);var temp$36678;(temp$36678=$36827(args$36649));var $length$36684;($length$36684=temp$36678.length);var $index$36690;($index$36690=0);$36663:for(;($index$36690<$length$36684);($index$36690++)){var m$36699;(m$36699=temp$36678[$index$36690]);var t0$36704;var t1$36705;var i$36709;var arg$36710;(t0$36704=m$36699);if(((t0$36704 instanceof Array)&&(((t1$36705=t0$36704.length)),(t1$36705===2)))){(i$36709=t0$36704[0]);(arg$36710=t0$36704[1]);(e$36662[i$36709]=arg$36710);}else{$36853(m$36699);}}(e$36662["length"]=args$36649.length);(e$36662["name"]=["E"].concat(it$0$36629.tags).join("."));return e$36662;}else{$36853($36627$36639);}});($36595$36601.prototype["::check"]=function(e$36740){var it$0$36744;var self$36745;(it$0$36744=this);(self$36745=this);var tags$36755;if(((!e$36740)||(!$25294(Error)(e$36740)))){return false;}(tags$36755=(e$36740["::tags"]||[]));var temp$36766;(temp$36766=it$0$36744.tags);var $length$36772;($length$36772=temp$36766.length);var $index$36778;($index$36778=0);$36756:for(;($index$36778<$length$36772);($index$36778++)){var m$36787;(m$36787=temp$36766[$index$36778]);var tag$36795;(tag$36795=m$36787);if((tags$36755.indexOf(tag$36795)===-1)){return false;}else{false;}}return true;});($36595$36601.prototype["::deconstruct"]=function(e$36804){var it$0$36808;var self$36809;(it$0$36808=this);(self$36809=this);return e$36804.args;});$25314($36595$36601,$25314(function(){var accum$36820;(accum$36820=({}));(accum$36820["::name"]="$36595");return accum$36820;}(),function(){var accum$36824;(accum$36824=({}));(accum$36824["::egclass"]=true);return accum$36824;}()));return $36595$36601;}();
var $36461=function($36463$36466){var ph$36476;var x$36477;var t0$36479;(t0$36479=$36463$36466);(x$36477=t0$36479);(ph$36476=t0$36479);var $36468$36488;($36468$36488=ph$36476);var bridge$36470$36493;(bridge$36470$36493=$36468$36488);if((function(){var bridge$36471$36503;(bridge$36471$36503=bridge$36470$36493);return (function(){var bridge$36472$36510;(bridge$36472$36510=bridge$36471$36503);return ((bridge$36472$36510===(void 0))||(bridge$36472$36510===null));}()||(typeof(bridge$36471$36503)==="string"));}()||(typeof(bridge$36470$36493)==="number"))){return x$36477;}else{if($36545($36468$36488,"::clone")){$36468$36488["::clone"];return x$36477["::clone"]();}else{$36468$36488;if((Object.getPrototypeOf(x$36477)===Object.prototype)){var dest$36528;(dest$36528=({}));var k$36533;(k$36533=null);$36527:for(k$36533 in x$36477){if(Object.prototype.hasOwnProperty.call(x$36477,k$36533)){(dest$36528[k$36533]=x$36477[k$36533]);}}return dest$36528;}else{var other$36543;(other$36543=$36468$36488);throw $36594(["clone"]).create("Object cannot be cloned",({"obj":x$36477}));}}}};
var $36439=function(a$36442,b$36443){var dest$36448;(dest$36448=$36461(a$36442));var k$36453;(k$36453=null);$36447:for(k$36453 in b$36443){if(Object.prototype.hasOwnProperty.call(b$36443,k$36453)){(dest$36448[k$36453]=b$36443[k$36453]);}}return dest$36448;};
var $36872=function(type$36875){return function(value$36879){var f$36883;(f$36883=type$36875[":::project"]);if((f$36883===(void 0))){(f$36883=type$36875["::project"]);if((f$36883===(void 0))){return [true,type$36875(value$36879)];}else{var rval$36896;(rval$36896=false);try{(rval$36896=[true,f$36883(value$36879)]);}catch(excv$36907){var e$36913;(e$36913=excv$36907);(rval$36896=[false,null]);}return rval$36896;}}else{return f$36883.call(type$36875,value$36879);}};};
var $36919=function(obj$36922){var results$36927;(results$36927=[]);var k$36932;(k$36932=null);$36926:for(k$36932 in obj$36922){if(Object.prototype.hasOwnProperty.call(obj$36922,k$36932)){results$36927.push([k$36932,$25313(obj$36922,k$36932)]);}}return results$36927;};
var $37108=Object.keys;
var $36936=function($36938$36941,b$36942){var ph$36956;var a$36957;var t0$36959;(t0$36959=$36938$36941);(a$36957=t0$36959);(ph$36956=t0$36959);var $36944$36968;($36944$36968=ph$36956);var bridge$36947$36973;if(($36944$36968===b$36942)){return true;}else{(bridge$36947$36973=$36944$36968);if((function(){var bridge$36948$36987;(bridge$36948$36987=bridge$36947$36973);return (function(){var bridge$36949$36994;(bridge$36949$36994=bridge$36948$36987);return (function(){var bridge$36950$37001;(bridge$36950$37001=bridge$36949$36994);return (function(){var bridge$36951$37008;(bridge$36951$37008=bridge$36950$37001);return ((typeof(bridge$36951$37008)==="number")||(typeof(bridge$36951$37008)==="string"));}()||(bridge$36950$37001===null));}()||(bridge$36949$36994===(void 0)));}()||(bridge$36948$36987===true));}()||(bridge$36947$36973===false))){return false;}else{if($25294(Array)($36944$36968)){if(((!$25294(Array)(b$36942))||(a$36957.length!==b$36942.length))){return false;}var i$37024;(i$37024=0);$37020:for(;(i$37024<a$36957.length);(i$37024++)){if((!$36936(a$36957[i$37024],b$36942[i$37024]))){return false;}}return true;}else{$36944$36968;if((((Object.getPrototypeOf(a$36957)===Object.prototype)&&$25294(Object)(b$36942))&&(Object.getPrototypeOf(b$36942)===Object.prototype))){var ka$37038;(ka$37038=$37108(a$36957));if((!$36936(ka$37038.sort(),$37108(b$36942).sort()))){return false;}var temp$37049;(temp$37049=ka$37038);var $length$37055;($length$37055=temp$37049.length);var $index$37061;($index$37061=0);$37039:for(;($index$37061<$length$37055);($index$37061++)){var m$37070;(m$37070=temp$37049[$index$37061]);var k$37078;(k$37078=m$37070);if((!$36936(a$36957[k$37078],b$36942[k$37078]))){return false;}}return true;}else{if($36545($36944$36968,"::serialize")){$36944$36968["::serialize"];var $37085$37090;($37085$37090=b$36942);if($36545($37085$37090,"::serialize")){$37085$37090["::serialize"];return $36936(a$36957["::serialize"](),b$36942["::serialize"]());}else{var otherwise$37102;(otherwise$37102=$37085$37090);return false;}}else{var otherwise$37106;(otherwise$37106=$36944$36968);return false;}}}}}};
var $37109=function(xs$37112,ys$37113){var acc$37120;(acc$37120=[]);var temp$37126;(temp$37126=$36827(xs$37112));var $length$37132;($length$37132=temp$37126.length);var $index$37138;($index$37138=0);$37115:for(;($index$37138<$length$37132);($index$37138++)){var m$37147;(m$37147=temp$37126[$index$37138]);var t0$37152;var t1$37153;var i$37157;var x$37158;(t0$37152=m$37147);if(((t0$37152 instanceof Array)&&(((t1$37153=t0$37152.length)),(t1$37153===2)))){(i$37157=t0$37152[0]);(x$37158=t0$37152[1]);acc$37120.push([x$37158,$25313(ys$37113,i$37157)]);}else{$36853(m$37147);}}return acc$37120;};var accum$25608;var accum$25612;var $index$25658;var $length$25652;var temp$25646;var accum$26488;var accum$26535;var accum$26618;var accum$26631;var accum$26643;var accum$26687;var accum$26696;var accum$26709;var accum$27086;var accum$27174;var accum$27266;var accum$27355;var accum$27385;var accum$27509;var accum$27645;var accum$27685;var accum$27737;var accum$27810;var accum$27872;var accum$27934;var accum$27989;var accum$28143;var accum$28284;var accum$28480;var accum$28510;var accum$28797;var accum$29135;var accum$29326;var accum$29459;var accum$30080;var t0$30185;var accum$30183;var t0$30409;var accum$30407;var t0$30497;var accum$30495;var t0$30705;var accum$30703;var t0$31207;var accum$31205;var accum$31505;var accum$31733;var accum$31756;var accum$31779;var t0$31951;var accum$31949;var accum$32221;var t0$32253;var accum$32251;var t0$32275;var accum$32273;var t0$32297;var accum$32295;var accum$32317;var accum$32366;var accum$32413;var accum$32722;var accum$33007;var accum$33209;var accum$33526;var accum$33698;var accum$34391;var accum$34917;var $index$35031;var $length$35025;var temp$27036;var accum$36200;var accum$36204;var mac$36216;var $index$36378;var $length$36372;var temp$36366;var $25372$25437;var __lt____gt__$25438;var $25373$25439;var __lt____lt____colon__$25440;var util$25441;var GenSym$25442;var neighbours$25443;var classify_contiguous$25444;var $25375$25445;var PatternParser$25446;var PatternProcessor$25447;var parse_pattern$25448;var parse_clauses$25449;var mt$25450;var Expander$25451;var Scope$25452;var Env$25453;var nullenv$25454;var mac1$25455;var checker_db$25456;var generic_nodes$25457;var mkid$25458;var Embedded$25459;var stdenv$25460;var mkstdenv$25461;var expander$25462;var expand$25463;var topscope$25464;var embed_location$25465;var error_embed_location$25466;var match_error$25467;var drop_ctx$25468;var expr_mac$25469;var overridable$25470;var protected_value$25471;var setup_label$25472;var break_mac$25473;var continue_mac$25474;var var_operator$25475;var accum_flags$25476;var pattern_constructors$25477;var disregard_specials$25478;var pattern_handlers$25479;var build_loop$25480;var partial_pattern$25481;var make_assigner$25482;var blocktest_wrap$25483;var blocktest_mac$25484;var qqstruct$25485;var qq$25486;var RegexBuilder$25487;var build_regexp$25488;var errf_macro$25489;var stdprelude$25490;($25372$25437=require("./pp"));(__lt____gt__$25438=$25372$25437["<>"]);($25373$25439=require("./location"));(__lt____lt____colon__$25440=$25373$25439["<<:"]);(util$25441=require("./util"));(GenSym$25442=util$25441.GenSym);(neighbours$25443=util$25441.neighbours);(classify_contiguous$25444=util$25441.classify_contiguous);($25375$25445=require("./pattern"));(PatternParser$25446=$25375$25445.PatternParser);(PatternProcessor$25447=$25375$25445.PatternProcessor);(parse_pattern$25448=$25375$25445.parse_pattern);(parse_clauses$25449=$25375$25445.parse_clauses);(mt$25450=require("./expand"));(Expander$25451=mt$25450.Expander);(Scope$25452=mt$25450.Scope);(Env$25453=mt$25450.Env);(nullenv$25454=mt$25450.nullenv);(mac1$25455=mt$25450["mac1"]);(checker_db$25456=mt$25450.checker_db);(generic_nodes$25457=["if","js_while","js_for","js_for_in","js_label","js_break","js_continue","js_return","js_delete","js_throw","js_try","js_new"]);(mkid$25458=GenSym$25442("#"));(Embedded$25459=function(code$25570){var it$0$25573;(it$0$25573=function(){if((!$25294(Embedded$25459)(this))){return Object.create(Embedded$25459.prototype);}else{return this;}}());(it$0$25573["code"]=mkstdenv$25461().mark(code$25570));(it$0$25573["::id"]=mkid$25458());return it$0$25573;});(Embedded$25459.prototype["::serialize_ast"]=function(){var it$0$25596;var self$25597;(it$0$25596=this);(self$25597=this);return expand$25463(["top"],topscope$25464,it$0$25596.code);});$25314(Embedded$25459,$25314(((accum$25608=({})),((accum$25608["::name"]="Embedded"),accum$25608)),((accum$25612=({})),((accum$25612["::egclass"]=true),accum$25612))));Embedded$25459;(stdenv$25460=Env$25453());(mkstdenv$25461=function(){var e$25626;(e$25626=Env$25453());(e$25626.scopes["top"]=stdenv$25460.scopes.top);return e$25626;});(expander$25462=Expander$25451(mkstdenv$25461,generic_nodes$25457));(expand$25463=expander$25462.expand.bind(expander$25462));(topscope$25464=Scope$25452(null,"top",expander$25462));(temp$25646=["+","-","*","/","mod","&.","|.","^.","and","or","not","===","!==","<",">","<=",">=","<<",">>",">>>","in","instanceof","--","++","true","false","null","undefined","typeof","String","Array","Number","Boolean","Object","RegExp","Function","Date","parseInt","parseFloat","Math","Error","TypeError","ReferenceError","console","process","eval","setTimeout","clearTimeout","___js_fetch","___node","arguments","this","exports","global"]);($length$25652=temp$25646.length);($index$25658=0);$25491:for(;($index$25658<$length$25652);($index$25658++)){var k$25675;var m$25667;(m$25667=temp$25646[$index$25658]);(k$25675=m$25667);stdenv$25460.bind(topscope$25464,k$25675,$36439(["variable",k$25675],({"mutable":false,"assigned":true})));}stdenv$25460.bind(topscope$25464,"pass",["variable","undefined"]);(embed_location$25465=function($25680$25683){var other$25723;var url$25704;var start$25705;var end$25706;var t0$25699;var t1$25700;var $25685$25694;var ph$25688;(ph$25688=$25680$25683);($25685$25694=ph$25688);if(($36545($25685$25694,"location")&&(((t0$25699=$25685$25694.location)),($36545(t0$25699,"source")&&(((t1$25700=t0$25699.source)),($36545(t1$25700,"url")&&((url$25704=t1$25700.url),($36545(t0$25699,"start")&&((start$25705=t0$25699.start),$36545(t0$25699,"end")))))))))){(end$25706=t0$25699.end);return ["send",["send",["symbol","#"],["data",["void"],["symbol","location"]]],["data",["value",url$25704],["value",start$25705],["value",end$25706]]];}else{(other$25723=$25685$25694);return ["send",["send",["symbol","#"],["data",["void"],["symbol","location"]]],["data",["symbol","null"],["value",0],["value",0]]];}});(error_embed_location$25466=function(error$25730,target$25731){return ["send",["symbol","throw"],["send",["symbol","&:"],["data",error$25730,["data",["send",["symbol","="],["data",["symbol","location"],embed_location$25465(target$25731)]]]]]];});(match_error$25467=function($25737$25740){var t0$25748;var other$25786;var url$25767;var start$25768;var end$25769;var t0$25762;var t1$25763;var $25742$25757;var ph$25745;var target$25746;(t0$25748=$25737$25740);(target$25746=t0$25748);(ph$25745=t0$25748);($25742$25757=ph$25745);if(($36545($25742$25757,"location")&&(((t0$25762=$25742$25757.location)),($36545(t0$25762,"source")&&(((t1$25763=t0$25762.source)),($36545(t1$25763,"url")&&((url$25767=t1$25763.url),($36545(t0$25762,"start")&&((start$25768=t0$25762.start),$36545(t0$25762,"end")))))))))){(end$25769=t0$25762.end);return ["send",["symbol","___match_error"],["data",target$25746,["value",url$25767],["value",start$25768],["value",end$25769]]];}else{(other$25786=$25742$25757);return ["send",["symbol","___match_error"],["data",other$25786]];}});(drop_ctx$25468=function(f$25793){return function(context$25797,scope$25798,form$25799,arg$25800){var rval$25806;(rval$25806=false);try{(rval$25806=f$25793(context$25797,scope$25798,form$25799,arg$25800));}catch(excv$25817){var t0$25854;var e$25867;var t0$25820;var t1$25821;var t2$25822;var t3$25823;var t4$25824;(t0$25820=excv$25817);if(($25294($36594(["match"]))(t0$25820)&&($36545(t0$25820,"args")&&(((t1$25821=t0$25820.args)),((t1$25821 instanceof Array)&&(((t2$25822=t1$25821.length)),((t2$25822===1)&&(((t3$25823=t1$25821[0])),($36545(t3$25823,"value")&&(((t4$25824=t3$25823.value)),((t4$25824===context$25797)&&(!((t4$25824 instanceof Array)&&(((t0$25854=t4$25824.length)),((t0$25854===2)&&((t4$25824[0]==="expr")&&(t4$25824[1]==="expr"))))))))))))))))){(rval$25806=["nostep",form$25799]);}else{(e$25867=excv$25817);(rval$25806=function(){throw e$25867;}());}}return rval$25806;};});(expr_mac$25469=function(f$25878){return function($25881$25884,scope$25885,form$25886,arg$25887){var t0$25914;var t0$25921;var otherwise$25930;var bridge$25891$25904;var $25889$25899;var ph$25893;(ph$25893=$25881$25884);($25889$25899=ph$25893);(bridge$25891$25904=$25889$25899);if((((bridge$25891$25904 instanceof Array)&&(((t0$25914=bridge$25891$25904.length)),((t0$25914===2)&&((bridge$25891$25904[0]==="expr")&&(bridge$25891$25904[1]==="expr")))))||((bridge$25891$25904 instanceof Array)&&(((t0$25921=bridge$25891$25904.length)),((t0$25921===2)&&((bridge$25891$25904[0]==="expr")&&(bridge$25891$25904[1]==="head"))))))){return f$25878(scope$25885,form$25886,arg$25887);}else{(otherwise$25930=$25889$25899);return ["nostep",form$25886];}};});(overridable$25470=function(f$25937){return function($25940$25943,scope$25944,form$25945,arg$25946){var t0$25955;var x$25976;var other$25992;var t0$25969;var $25948$25964;var ph$25952;var context$25953;(t0$25955=$25940$25943);(context$25953=t0$25955);(ph$25952=t0$25955);($25948$25964=ph$25952);if((((x$25976=$25948$25964)),((x$25976 instanceof Array)&&(x$25976[0]==="pattern")))){return ["nostep",form$25945];}else{if((($25948$25964 instanceof Array)&&(((t0$25969=$25948$25964.length)),((t0$25969===2)&&(($25948$25964[0]==="expr")&&($25948$25964[1]==="multi")))))){return ["nostep",form$25945];}else{(other$25992=$25948$25964);return f$25937(context$25953,scope$25944,form$25945,arg$25946);}}};});(protected_value$25471=function(name$25999,value$26000){return function($26003$26006,scope$26007,form$26008,arg$26009){var x$26031;var other$26063;var t0$26050;var $26040$26045;var other$26038;var $26011$26020;var ph$26014;(ph$26014=$26003$26006);($26011$26020=ph$26014);if((((x$26031=$26011$26020)),((x$26031 instanceof Array)&&(x$26031[0]==="pattern")))){throw $36594(["syntax","pattern"]).create((("'"+name$25999)+"' is not a valid pattern and cannot be redeclared"));}else{(other$26038=$26011$26020);($26040$26045=arg$26009);if((($26040$26045 instanceof Array)&&(((t0$26050=$26040$26045.length)),((t0$26050===1)&&($26040$26045[0]==="void"))))){return ["value",value$26000];}else{(other$26063=$26040$26045);return ["send",["value",value$26000],arg$26009];}}};});(setup_label$25472=function(label$26070,env$26071,body$26072){return ["bind",$36439(["symbol","break"],({"env":env$26071})),["macro",break_mac$25473(label$26070)],["bind",$36439(["symbol","continue"],({"env":env$26071})),["macro",continue_mac$25474(label$26070)],["js_label",["value",label$26070],body$26072]]];});(break_mac$25473=function(default_label$26079){return overridable$25470(function(context$26085,scope$26086,form$26087,$26082$26088){var t0$26102;var v$26142;var v$26137;var $26095$26118;var $26096$26119;var $26097$26120;var $26098$26121;var t0$26116;var $26090$26111;var ph$26099;var expr$26100;(t0$26102=$26082$26088);(expr$26100=t0$26102);(ph$26099=t0$26102);($26090$26111=ph$26099);if((($26095$26118=($26090$26111 instanceof Array))&&(((t0$26116=$26090$26111.length)),(($26097$26120=(t0$26116===1))&&(($26098$26121=($26090$26111[0]==="void"))&&default_label$26079))))){return ["js_break",["value",default_label$26079]];}else{if($26098$26121){return ["js_break"];}else{if(($26095$26118&&(($26097$26120=(t0$26116===2))&&($26090$26111[0]==="value")))){(v$26137=$26090$26111[1]);return ["js_break",expr$26100];}else{if(($26097$26120&&($26090$26111[0]==="symbol"))){(v$26142=$26090$26111[1]);return ["js_break",["value",v$26142]];}else{$36853($26090$26111);}}}}});});(continue_mac$25474=function(default_label$26152){return overridable$25470(function(context$26158,scope$26159,form$26160,$26155$26161){var t0$26175;var v$26215;var v$26210;var $26168$26191;var $26169$26192;var $26170$26193;var $26171$26194;var t0$26189;var $26163$26184;var ph$26172;var expr$26173;(t0$26175=$26155$26161);(expr$26173=t0$26175);(ph$26172=t0$26175);($26163$26184=ph$26172);if((($26168$26191=($26163$26184 instanceof Array))&&(((t0$26189=$26163$26184.length)),(($26170$26193=(t0$26189===1))&&(($26171$26194=($26163$26184[0]==="void"))&&default_label$26152))))){return ["js_continue",["value",default_label$26152]];}else{if($26171$26194){return ["js_continue"];}else{if(($26168$26191&&(($26170$26193=(t0$26189===2))&&($26163$26184[0]==="value")))){(v$26210=$26163$26184[1]);return ["js_continue",expr$26173];}else{if(($26170$26193&&($26163$26184[0]==="symbol"))){(v$26215=$26163$26184[1]);return ["js_continue",["value",v$26215]];}else{$36853($26163$26184);}}}}});});(var_operator$25475=function(name$26225){return function(context$26229,scope$26230,form$26231,expr$26232){var t0$26248;var x$26285;var other$26310;var s$26296;var t0$26291;var t1$26292;var $26240$26281;var $26243$26268;var $26244$26269;var t0$26266;var $26237$26261;var env$26245;var sym$26246;(t0$26248=form$26231);if($36545(t0$26248,"env")){(env$26245=t0$26248.env);}else{$36853(form$26231,"/home/olivier/git/earl-grey/src/stdenv.eg",3659,3663);}(sym$26246=$36439(["symbol",name$26225],({"env":env$26245})));($26237$26261=expr$26232);if((($26243$26268=($26237$26261 instanceof Array))&&(((t0$26266=$26237$26261.length)),((t0$26266===1)&&($26237$26261[0]==="void"))))){return sym$26246;}else{if(($26243$26268&&((t0$26266===3)&&(($26237$26261[0]==="data")&&(((x$26285=$26237$26261[1])),((x$26285 instanceof Array)&&(x$26285[0]==="void"))))))){($26240$26281=$26237$26261[2]);(t0$26291=$26240$26281);if(((t0$26291 instanceof Array)&&(((t1$26292=t0$26291.length)),((t1$26292===2)&&(t0$26291[0]==="symbol"))))){(s$26296=t0$26291[1]);return ["send",sym$26246,["value",s$26296]];}else{(other$26310=$26240$26281);return ["send",sym$26246,other$26310];}}else{$36853($26237$26261);}}};});(accum_flags$25476=function(){var make$26342;var mac$26332;var also_values$26333;var t0$26328;var $26319$26323;($26319$26323=arguments);(t0$26328=$26319$26323.length);if(((t0$26328>=1)&&(t0$26328<=2))){(mac$26332=$26319$26323[0]);(also_values$26333=function(){if((1>=t0$26328)){return true;}else{return $26319$26323[1];}}());(make$26342=function(flags$26347){return function(context$26353,scope$26354,form$26355,$26350$26356){var other$26445;var flag$26400;var flag$26389;var $26362$26385;var $26363$26386;var t0$26375;var t1$26376;var t2$26377;var t3$26378;var t4$26379;var t5$26380;var t6$26381;var t7$26382;var t8$26383;var $26358$26370;var ph$26364;(ph$26364=$26350$26356);($26358$26370=ph$26364);if((($26362$26385=($26358$26370 instanceof Array))&&(((t0$26375=$26358$26370.length)),((t0$26375===2)&&(($26358$26370[0]==="value")&&((flag$26389=$26358$26370[1]),also_values$26333)))))){return ["macro",make$26342(flags$26347.concat([flag$26389]))];}else{if(($26362$26385&&((t0$26375===3)&&(($26358$26370[0]==="send")&&(((t1$26376=$26358$26370[1])),((t1$26376 instanceof Array)&&(((t2$26377=t1$26376.length)),((t2$26377===2)&&((t1$26376[0]==="symbol")&&((t1$26376[1]===".")&&(((t3$26378=$26358$26370[2])),((t3$26378 instanceof Array)&&(((t4$26379=t3$26378.length)),((t4$26379===3)&&((t3$26378[0]==="data")&&(((t5$26380=t3$26378[1])),((t5$26380 instanceof Array)&&(((t6$26381=t5$26380.length)),((t6$26381===1)&&((t5$26380[0]==="void")&&(((t7$26382=t3$26378[2])),((t7$26382 instanceof Array)&&(((t8$26383=t7$26382.length)),((t8$26383===2)&&(t7$26382[0]==="symbol"))))))))))))))))))))))))){(flag$26400=t7$26382[1]);return ["macro",make$26342(flags$26347.concat([flag$26400]))];}else{(other$26445=$26358$26370);return mac$26332(context$26353,scope$26354,form$26355,other$26445,flags$26347);}}};});return make$26342([]);}else{$36853($26319$26323);}});(pattern_constructors$25477=({}));(disregard_specials$25478=function($26457$26460,value$26461){var t0$26466;var t1$26467;var kind$26463;var expr$26464;(t0$26466=$26457$26460);if(((t0$26466 instanceof Array)&&(((t1$26467=t0$26466.length)),((t1$26467===2)&&(t0$26466[0]==="special"))))){(kind$26463=t0$26466[1]);(expr$26464=t0$26466);}else{$36853($26457$26460);}throw $36594(["syntax","pattern","special"]).create("Special token cannot be used here",({"special":expr$26464}));});(pattern_handlers$25479=({"declare_variables":$25314(({"allow_nested":true,"allow_arguments":true,"special":disregard_specials$25478}),$25314(((accum$26488=({})),((accum$26488["assign"]=function($26492$26495,value$26496){var t0$26504;var v$26532;var name$26522;var t0$26518;var $26498$26513;var ph$26501;var v$26502;(t0$26504=$26492$26495);(v$26502=t0$26504);(ph$26501=t0$26504);($26498$26513=ph$26501);if((($26498$26513 instanceof Array)&&(((t0$26518=$26498$26513.length)),((t0$26518===2)&&($26498$26513[0]==="symbol"))))){(name$26522=$26498$26513[1]);return ["do",__lt____lt____colon__$25440(["assign",v$26502,$25314(value$26496,({"name":name$26522}))],v$26502)];}else{(v$26532=$26498$26513);return ["do",__lt____lt____colon__$25440(["assign",v$26532,value$26496],v$26532)];}}),accum$26488)),$25314(({"finalize":true,"tags":({"declare_mode":"unqualified"})}),$25314(((accum$26535=({})),((accum$26535["declare"]=function(scope$26540,vars$26541){var $index$26566;var $length$26560;var temp$26554;var acc$26548;(acc$26548=[]);(temp$26554=vars$26541);($length$26560=temp$26554.length);($index$26566=0);$26543:for(;($index$26566<$length$26560);($index$26566++)){var $26586$26593;var v$26583;var m$26575;(m$26575=temp$26554[$index$26566]);(v$26583=m$26575);acc$26548.push(((($26586$26593=v$26583.declare_mode)),function(){if(($26586$26593==="set")){return ["splice"];}else{if(($26586$26593==="let")){return ["declare",$36439(v$26583,({"mutable":false}))];}else{if(($26586$26593==="var")){return ["declare",$36439(v$26583,({"mutable":true}))];}else{if(($26586$26593==="unqualified")){return ["declare",$36439(v$26583,({"mutable":false,"use_previous":true}))];}else{$36853($26586$26593);}}}}}()));}return acc$26548;}),accum$26535)),$25314(((accum$26618=({})),((accum$26618["success"]=function($26622$26625){$26622$26625;return ["multi"];}),accum$26618)),((accum$26631=({})),((accum$26631["failure"]=function(target$26636){return match_error$25467(target$26636);}),accum$26631))))))),"build_object":$25314(({"strings_as_variables":true,"allow_nested":true,"allow_arguments":true,"special":disregard_specials$25478}),$25314(((accum$26643=({})),((accum$26643["assign"]=function($26647$26653,value$26654,$26650$26655){var t0$26666;var t0$26674;var bridge$26649$26659;var v$26657;(bridge$26649$26659=$26647$26653);if((((bridge$26649$26659 instanceof Array)&&(((t0$26666=bridge$26649$26659.length)),((t0$26666===2)&&((bridge$26649$26659[0]==="symbol")&&((v$26657=bridge$26649$26659[1]),true)))))||((bridge$26649$26659 instanceof Array)&&(((t0$26674=bridge$26649$26659.length)),((t0$26674===2)&&((bridge$26649$26659[0]==="value")&&((v$26657=bridge$26649$26659[1]),true))))))){}else{$36853($26647$26653);}$26650$26655;return ["do",__lt____lt____colon__$25440(["assign",["send",["symbol","accum"],["value",v$26657]],value$26654],v$26657)];}),accum$26643)),$25314(({"finalize":true}),$25314(((accum$26687=({})),((accum$26687["declare"]=function(scope$26692,vars$26693){return [["declare",["symbol","accum"],["data",["symbol","="]]]];}),accum$26687)),$25314(((accum$26696=({})),((accum$26696["success"]=function($26700$26703){$26700$26703;return ["symbol","accum"];}),accum$26696)),((accum$26709=({})),((accum$26709["failure"]=function(target$26714){return match_error$25467(target$26714);}),accum$26709)))))))}));(build_loop$25480=function(scope$26721,env$26722,form$26723,li$26724,clauses$26725,wrap$26726,pre$26727,post$26728,opt$26729){var t0$26756;var t0$26803;var accum$26857;var lbl$26739;var i$26740;var len$26741;var first_mac$26742;var last_mac$26743;var newscope$26744;var m$26745;(lbl$26739=function(){if(env$26722){return $36439(["value",scope$26721.gensym()],({"env":env$26722}));}else{return ["value",scope$26721.gensym()];}}());(i$26740=$36439(["symbol","$index"],({"env":env$26722})));(len$26741=$36439(["symbol","$length"],({"env":env$26722})));(t0$26756=$36872(drop_ctx$25468)(function($26762$26765,scope$26766,form$26767,subp$26768){var x$26774;if((((x$26774=$26762$26765)),((x$26774 instanceof Array)&&(x$26774[0]==="pattern")))){}else{$36853($26762$26765);}return ["test",["send",["symbol","==="],["data",i$26740,["value",0]]],subp$26768];}));if(t0$26756[0]){(first_mac$26742=t0$26756[1]);}else{$36853(function($26784$26787,scope$26788,form$26789,subp$26790){var x$26796;if((((x$26796=$26784$26787)),((x$26796 instanceof Array)&&(x$26796[0]==="pattern")))){}else{$36853($26784$26787);}return ["test",["send",["symbol","==="],["data",i$26740,["value",0]]],subp$26790];});}(t0$26803=$36872(drop_ctx$25468)(function($26809$26812,scope$26813,form$26814,subp$26815){var x$26821;if((((x$26821=$26809$26812)),((x$26821 instanceof Array)&&(x$26821[0]==="pattern")))){}else{$36853($26809$26812);}return ["test",["send",["symbol","==="],["data",i$26740,["send",["symbol","-"],["data",len$26741,["value",1]]]]],subp$26815];}));if(t0$26803[0]){(last_mac$26743=t0$26803[1]);}else{$36853(function($26831$26834,scope$26835,form$26836,subp$26837){var x$26843;if((((x$26843=$26831$26834)),((x$26843 instanceof Array)&&(x$26843[0]==="pattern")))){}else{$36853($26831$26834);}return ["test",["send",["symbol","==="],["data",i$26740,["send",["symbol","-"],["data",len$26741,["value",1]]]]],subp$26837];});}(newscope$26744=Scope$25452(scope$26721));env$26722.bind(newscope$26744,"first",["macro",first_mac$26742]);env$26722.bind(newscope$26744,"last",["macro",last_mac$26743]);(m$26745=__lt____lt____colon__$25440(["symbol","m"],form$26723));return ["multi",pre$26727,["send",["symbol","let"],["data",["multi",["send",["symbol","="],["data",["symbol","temp"],li$26724]],["send",["symbol","="],["data",len$26741,["send",["symbol","temp"],["send",["symbol","."],["data",["void"],["symbol","length"]]]]]]],["send",["send",["symbol","for"],lbl$26739],["data",["multi",["send",["symbol","="],["data",["send",["symbol","var"],i$26740],["value",0]]],["send",["symbol","<"],["data",i$26740,len$26741]],["send",["symbol","++"],["data",i$26740,["void"]]]],["multi",["send",["symbol","="],["data",m$26745,["send",["symbol","___js_fetch"],["data",["symbol","temp"],i$26740]]]],parse_clauses$25449(newscope$26744,m$26745,clauses$26725,$36439(opt$26729,((accum$26857=({})),((accum$26857["wrap"]=function(x$26862){return wrap$26726(x$26862,i$26740);}),accum$26857))))]]]]],post$26728];});(partial_pattern$25481=function(operator$26869){var x$26893;var $26877$26882;var op$26874;(op$26874=((($26877$26882=operator$26869)),function(){if((((x$26893=$26877$26882)),((x$26893 instanceof Array)&&(x$26893[0]==="symbol")))){return operator$26869;}else{if((typeof($26877$26882)==="string")){return ["variable",operator$26869];}else{$36853($26877$26882);}}}()));return function(context$26906,scope$26907,form$26908,expr$26909){var x$26945;var m$26972;var other$26997;var val$26936;var $26915$26931;var $26916$26932;var $26917$26933;var t0$26925;var t1$26926;var t2$26927;var t3$26928;var t4$26929;var $26911$26920;($26911$26920=[context$26906,expr$26909]);if((($26915$26931=($26911$26920 instanceof Array))&&(((t0$26925=$26911$26920.length)),(($26917$26933=(t0$26925===2))&&((((x$26945=$26911$26920[0])),((x$26945 instanceof Array)&&(x$26945[0]==="pattern")))&&(((t1$26926=$26911$26920[1])),((t1$26926 instanceof Array)&&(((t2$26927=t1$26926.length)),((t2$26927===3)&&((t1$26926[0]==="data")&&(((t3$26928=t1$26926[1])),((t3$26928 instanceof Array)&&(((t4$26929=t3$26928.length)),((t4$26929===1)&&(t3$26928[0]==="void"))))))))))))))){(val$26936=t1$26926[2]);(m$26972=mac1$25455(function(x$26977){return ["send",op$26874,["data",x$26977,val$26936]];}));return ["check",m$26972,["ignore"]];}else{if(($26917$26933&&($26911$26920[0],(((t1$26926=$26911$26920[1])),((t1$26926 instanceof Array)&&(((t2$26927=t1$26926.length)),((t2$26927===1)&&(t1$26926[0]==="void")))))))){return op$26874;}else{(other$26997=$26911$26920);return ["send",op$26874,expr$26909];}}};});(make_assigner$25482=function(op$27004){return function(context$27010,scope$27011,form$27012,$27007$27013){var t0$27018;var t1$27019;var a$27015;var b$27016;(t0$27018=$27007$27013);if(((t0$27018 instanceof Array)&&(((t1$27019=t0$27018.length)),((t1$27019===3)&&(t0$27018[0]==="data"))))){(a$27015=t0$27018[1]);(b$27016=t0$27018[2]);}else{$36853($27007$27013);}return ["assign",a$27015,["send",["symbol",op$27004],["data",a$27015,b$27016]]];};});(temp$27036=$36919($25314(({"true":protected_value$25471("true",true),"false":protected_value$25471("false",false),"null":protected_value$25471("null",null),"undefined":protected_value$25471("undefined",(void 0)),"===":partial_pattern$25481("==="),"!==":partial_pattern$25481("!=="),"==":partial_pattern$25481(["symbol","___equal"]),"!=":partial_pattern$25481(["symbol","___nequal"]),"<=":partial_pattern$25481("<="),">=":partial_pattern$25481(">="),"<":partial_pattern$25481("<"),">":partial_pattern$25481(">")}),$25314(((accum$27086=({})),((accum$27086["-"]=function(context$27093,scope$27094,form$27095,$27090$27096){var t0$27107;var other$27171;var n$27132;var $27102$27128;var $27103$27129;var t0$27121;var t1$27122;var t2$27123;var t3$27124;var t4$27125;var t5$27126;var $27098$27116;var ph$27104;var expr$27105;(t0$27107=$27090$27096);(expr$27105=t0$27107);(ph$27104=t0$27107);($27098$27116=ph$27104);if((($27102$27128=($27098$27116 instanceof Array))&&(((t0$27121=$27098$27116.length)),((t0$27121===3)&&(($27098$27116[0]==="data")&&(((t1$27122=$27098$27116[1])),((t1$27122 instanceof Array)&&(((t2$27123=t1$27122.length)),((t2$27123===1)&&((t1$27122[0]==="void")&&(((t3$27124=$27098$27116[2])),((t3$27124 instanceof Array)&&(((t4$27125=t3$27124.length)),((t4$27125===2)&&((t3$27124[0]==="value")&&(((t5$27126=t3$27124[1])),(typeof(t5$27126)==="number"))))))))))))))))){(n$27132=t5$27126);return ["value",(-n$27132)];}else{if(($27102$27128&&((t0$27121===1)&&($27098$27116[0]==="void")))){return ["variable","-"];}else{(other$27171=$27098$27116);return ["send",["variable","-"],expr$27105];}}}),accum$27086)),$25314(((accum$27174=({})),((accum$27174["++"]=function(context$27181,scope$27182,form$27183,$27178$27184){var other$27263;var x$27253;var y$27254;var x$27237;var x$27217;var $27192$27211;var $27193$27212;var $27194$27213;var $27195$27214;var t0$27207;var t1$27208;var t2$27209;var $27186$27202;var ph$27196;(ph$27196=$27178$27184);($27186$27202=ph$27196);if((($27192$27211=($27186$27202 instanceof Array))&&(((t0$27207=$27186$27202.length)),(($27194$27213=(t0$27207===3))&&(($27195$27214=($27186$27202[0]==="data"))&&(((t1$27208=$27186$27202[1])),((t1$27208 instanceof Array)&&(((t2$27209=t1$27208.length)),((t2$27209===1)&&(t1$27208[0]==="void")))))))))){(x$27217=$27186$27202[2]);return ["send",["variable","++"],["data",["void"],x$27217]];}else{if(($27195$27214&&((x$27237=$27186$27202[1]),(((t1$27208=$27186$27202[2])),((t1$27208 instanceof Array)&&(((t2$27209=t1$27208.length)),((t2$27209===1)&&(t1$27208[0]==="void")))))))){return ["send",["variable","++"],["data",x$27237,["void"]]];}else{if($27195$27214){(x$27253=$27186$27202[1]);(y$27254=$27186$27202[2]);return ["send",["send",x$27253,["send",["symbol","."],["data",["void"],["symbol","concat"]]]],["data",y$27254]];}else{if(($27192$27211&&((t0$27207===1)&&($27186$27202[0]==="void")))){return ["send",["symbol","->"],["data",["data",["symbol","x"],["symbol","y"]],["send",["send",["symbol","x"],["send",["symbol","."],["data",["void"],["symbol","concat"]]]],["data",["symbol","y"]]]]];}else{(other$27263=$27186$27202);return ["send",["symbol","___build_array"],["data",other$27263]];}}}}}),accum$27174)),$25314(((accum$27266=({})),((accum$27266[".."]=function(context$27273,scope$27274,form$27275,$27270$27276){var x$27344;var y$27345;var x$27328;var x$27308;var $27283$27302;var $27284$27303;var $27285$27304;var $27286$27305;var t0$27298;var t1$27299;var t2$27300;var $27278$27293;var ph$27287;(ph$27287=$27270$27276);($27278$27293=ph$27287);if((($27283$27302=($27278$27293 instanceof Array))&&(((t0$27298=$27278$27293.length)),(($27285$27304=(t0$27298===3))&&(($27286$27305=($27278$27293[0]==="data"))&&(((t1$27299=$27278$27293[1])),((t1$27299 instanceof Array)&&(((t2$27300=t1$27299.length)),((t2$27300===1)&&(t1$27299[0]==="void")))))))))){(x$27308=$27278$27293[2]);return ["send",["symbol","range"],["data",["value",1],x$27308]];}else{if(($27286$27305&&((x$27328=$27278$27293[1]),(((t1$27299=$27278$27293[2])),((t1$27299 instanceof Array)&&(((t2$27300=t1$27299.length)),((t2$27300===1)&&(t1$27299[0]==="void")))))))){return ["send",["symbol","range"],["data",x$27328]];}else{if($27286$27305){(x$27344=$27278$27293[1]);(y$27345=$27278$27293[2]);return ["send",["symbol","range"],["data",x$27344,y$27345]];}else{if(($27283$27302&&((t0$27298===1)&&($27278$27293[0]==="void")))){return ["symbol","range"];}else{$36853($27278$27293);}}}}}),accum$27266)),$25314(((accum$27355=({})),((accum$27355["//"]=function(context$27362,scope$27363,form$27364,$27359$27365){var t0$27370;var t1$27371;var a$27367;var b$27368;(t0$27370=$27359$27365);if(((t0$27370 instanceof Array)&&(((t1$27371=t0$27370.length)),((t1$27371===3)&&(t0$27370[0]==="data"))))){(a$27367=t0$27370[1]);(b$27368=t0$27370[2]);}else{$36853($27359$27365);}return ["send",["send",["symbol","Math"],["send",["symbol","."],["data",["void"],["symbol","floor"]]]],["data",["send",["symbol","/"],["data",a$27367,b$27368]]]];}),accum$27355)),$25314(((accum$27385=({})),((accum$27385["*"]=function(context$27390,scope$27391,form$27392,expr$27393){var x$27431;var x$27457;var t0$27462;var other$27506;var val$27448;var $27401$27418;var $27402$27419;var $27403$27420;var t0$27411;var t1$27412;var t2$27413;var bridge$27398$27414;var t3$27415;var t4$27416;var $27395$27406;($27395$27406=[context$27390,expr$27393]);if((($27401$27418=($27395$27406 instanceof Array))&&(((t0$27411=$27395$27406.length)),(($27403$27420=(t0$27411===2))&&((((x$27431=$27395$27406[0])),((x$27431 instanceof Array)&&(x$27431[0]==="pattern")))&&(((t1$27412=$27395$27406[1])),((t1$27412 instanceof Array)&&(((t2$27413=t1$27412.length)),((t2$27413===1)&&(t1$27412[0]==="void")))))))))){return ["dynsplice",["ignore"]];}else{if(($27403$27420&&(((bridge$27398$27414=$27395$27406[0])),(((((x$27457=bridge$27398$27414)),((x$27457 instanceof Array)&&(x$27457[0]==="pattern")))||((bridge$27398$27414 instanceof Array)&&(((t0$27462=bridge$27398$27414.length)),((t0$27462===2)&&((bridge$27398$27414[0]==="expr")&&(bridge$27398$27414[1]==="data"))))))&&(((t1$27412=$27395$27406[1])),((t1$27412 instanceof Array)&&(((t2$27413=t1$27412.length)),((t2$27413===3)&&((t1$27412[0]==="data")&&(((t3$27415=t1$27412[1])),((t3$27415 instanceof Array)&&(((t4$27416=t3$27415.length)),((t4$27416===1)&&(t3$27415[0]==="void")))))))))))))){(val$27448=t1$27412[2]);return ["dynsplice",val$27448];}else{if(($27403$27420&&($27395$27406[0],(((t1$27412=$27395$27406[1])),((t1$27412 instanceof Array)&&(((t2$27413=t1$27412.length)),((t2$27413===1)&&(t1$27412[0]==="void")))))))){return ["variable","*"];}else{(other$27506=$27395$27406);return ["send",["variable","*"],expr$27393];}}}}),accum$27385)),$25314(((accum$27509=({})),((accum$27509["**"]=function(context$27514,scope$27515,form$27516,expr$27517){var x$27563;var x$27589;var t0$27594;var a$27638;var b$27639;var val$27580;var $27525$27546;var $27526$27547;var $27527$27548;var $27528$27549;var $27529$27550;var $27530$27551;var $27531$27552;var t0$27539;var t1$27540;var t2$27541;var bridge$27522$27542;var t3$27543;var t4$27544;var $27519$27534;($27519$27534=[context$27514,expr$27517]);if((($27525$27546=($27519$27534 instanceof Array))&&(((t0$27539=$27519$27534.length)),(($27527$27548=(t0$27539===2))&&((((x$27563=$27519$27534[0])),((x$27563 instanceof Array)&&(x$27563[0]==="pattern")))&&(((t1$27540=$27519$27534[1])),((t1$27540 instanceof Array)&&(((t2$27541=t1$27540.length)),((t2$27541===1)&&(t1$27540[0]==="void")))))))))){return ["objsplice",["ignore"]];}else{if(($27527$27548&&(((bridge$27522$27542=$27519$27534[0])),(((((x$27589=bridge$27522$27542)),((x$27589 instanceof Array)&&(x$27589[0]==="pattern")))||((bridge$27522$27542 instanceof Array)&&(((t0$27594=bridge$27522$27542.length)),((t0$27594===2)&&((bridge$27522$27542[0]==="expr")&&(bridge$27522$27542[1]==="data"))))))&&(((t1$27540=$27519$27534[1])),((t1$27540 instanceof Array)&&(((t2$27541=t1$27540.length)),((t2$27541===3)&&((t1$27540[0]==="data")&&(((t3$27543=t1$27540[1])),((t3$27543 instanceof Array)&&(((t4$27544=t3$27543.length)),((t4$27544===1)&&(t3$27543[0]==="void")))))))))))))){(val$27580=t1$27540[2]);return ["objsplice",val$27580];}else{if(($27527$27548&&($27519$27534[0],(((t1$27540=$27519$27534[1])),(($27530$27551=(t1$27540 instanceof Array))&&(((t2$27541=t1$27540.length)),((t2$27541===1)&&(t1$27540[0]==="void")))))))){return ["send",["symbol","Math"],["send",["symbol","."],["data",["void"],["symbol","pow"]]]];}else{if(($27530$27551&&((t2$27541===3)&&(t1$27540[0]==="data")))){(a$27638=t1$27540[1]);(b$27639=t1$27540[2]);return ["send",["send",["symbol","Math"],["send",["symbol","."],["data",["void"],["symbol","pow"]]]],["data",a$27638,b$27639]];}else{$36853($27519$27534);}}}}}),accum$27509)),$25314(((accum$27645=({})),((accum$27645["_"]=function($27649$27654,scope$27655,form$27656,$27651$27657){var x$27663;var t0$27670;var t1$27671;if((((x$27663=$27649$27654)),((x$27663 instanceof Array)&&(x$27663[0]==="pattern")))){}else{$36853($27649$27654);}(t0$27670=$27651$27657);if(((t0$27670 instanceof Array)&&(((t1$27671=t0$27670.length)),((t1$27671===1)&&(t0$27670[0]==="void"))))){}else{$36853($27651$27657);}return ["ignore"];}),accum$27645)),$25314(((accum$27685=({})),((accum$27685["else"]=function($27689$27694,scope$27695,form$27696,$27691$27697){var x$27722;var msg$27732;var $27699$27711;var ph$27702;(ph$27702=$27689$27694);$27691$27697;($27699$27711=ph$27702);if((((x$27722=$27699$27711)),((x$27722 instanceof Array)&&(x$27722[0]==="pattern")))){return ["ignore"];}else{$27699$27711;(msg$27732="'else' should be found inside an 'if' block");throw $36594(["syntax","else"]).create(msg$27732,({"node":form$27696}));}}),accum$27685)),$25314(((accum$27737=({})),((accum$27737["not"]=function($27741$27746,scope$27747,form$27748,$27743$27749){var t0$27761;var t1$27762;var t2$27763;var t3$27764;var x$27800;var other$27807;var $27751$27789;var ph$27754;var rhs$27755;var arg$27756;(ph$27754=$27741$27746);(t0$27761=$27743$27749);if(((t0$27761 instanceof Array)&&(((t1$27762=t0$27761.length)),((t1$27762===3)&&((t0$27761[0]==="data")&&(((t2$27763=t0$27761[1])),((t2$27763 instanceof Array)&&(((t3$27764=t2$27763.length)),((t3$27764===1)&&(t2$27763[0]==="void")))))))))){(rhs$27755=t0$27761[2]);(arg$27756=t0$27761);}else{$36853($27743$27749);}($27751$27789=ph$27754);if((((x$27800=$27751$27789)),((x$27800 instanceof Array)&&(x$27800[0]==="pattern")))){return ["neg",rhs$27755];}else{(other$27807=$27751$27789);return ["send",["variable","not"],arg$27756];}}),accum$27737)),$25314(((accum$27810=({})),((accum$27810["and"]=function($27814$27819,scope$27820,form$27821,$27816$27822){var t0$27835;var t1$27836;var x$27862;var other$27869;var $27824$27851;var ph$27827;var lhs$27828;var rhs$27829;var arg$27830;(ph$27827=$27814$27819);(t0$27835=$27816$27822);if(((t0$27835 instanceof Array)&&(((t1$27836=t0$27835.length)),((t1$27836===3)&&(t0$27835[0]==="data"))))){(lhs$27828=t0$27835[1]);(rhs$27829=t0$27835[2]);(arg$27830=t0$27835);}else{$36853($27816$27822);}($27824$27851=ph$27827);if((((x$27862=$27824$27851)),((x$27862 instanceof Array)&&(x$27862[0]==="pattern")))){return ["all",lhs$27828,rhs$27829];}else{(other$27869=$27824$27851);return ["send",["variable","and"],arg$27830];}}),accum$27810)),$25314(((accum$27872=({})),((accum$27872["or"]=function($27876$27881,scope$27882,form$27883,$27878$27884){var t0$27897;var t1$27898;var x$27924;var other$27931;var $27886$27913;var ph$27889;var lhs$27890;var rhs$27891;var arg$27892;(ph$27889=$27876$27881);(t0$27897=$27878$27884);if(((t0$27897 instanceof Array)&&(((t1$27898=t0$27897.length)),((t1$27898===3)&&(t0$27897[0]==="data"))))){(lhs$27890=t0$27897[1]);(rhs$27891=t0$27897[2]);(arg$27892=t0$27897);}else{$36853($27878$27884);}($27886$27913=ph$27889);if((((x$27924=$27886$27913)),((x$27924 instanceof Array)&&(x$27924[0]==="pattern")))){return ["any",lhs$27890,rhs$27891];}else{(other$27931=$27886$27913);return ["send",["variable","or"],arg$27892];}}),accum$27872)),$25314(((accum$27934=({})),((accum$27934["when"]=function(context$27941,scope$27942,form$27943,$27938$27944){var t0$27952;var t1$27953;var other$27986;var t0$27973;var $27946$27968;var ph$27949;var condition$27950;(t0$27952=$27938$27944);if(((t0$27952 instanceof Array)&&(((t1$27953=t0$27952.length)),((t1$27953===3)&&(t0$27952[0]==="data"))))){(ph$27949=t0$27952[1]);(condition$27950=t0$27952[2]);}else{$36853($27938$27944);}($27946$27968=ph$27949);if((($27946$27968 instanceof Array)&&(((t0$27973=$27946$27968.length)),((t0$27973===1)&&($27946$27968[0]==="void"))))){return ["test",condition$27950,["ignore"]];}else{(other$27986=$27946$27968);return ["test",condition$27950,other$27986];}}),accum$27934)),$25314(((accum$27989=({})),((accum$27989["."]=function(context$27996,scope$27997,form$27998,$27993$27999){var t0$28003;var t1$28004;var t2$28005;var t3$28006;var f$28031;var expr$28001;(t0$28003=$27993$27999);if(((t0$28003 instanceof Array)&&(((t1$28004=t0$28003.length)),((t1$28004===3)&&((t0$28003[0]==="data")&&(((t2$28005=t0$28003[1])),((t2$28005 instanceof Array)&&(((t3$28006=t2$28005.length)),((t3$28006===1)&&(t2$28005[0]==="void")))))))))){(expr$28001=t0$28003[2]);}else{$36853($27993$27999);}(f$28031=function($28035$28038){var t0$28068;var t0$28076;var $index$28117;var $length$28111;var temp$28105;var acc$28099;var other$28139;var args$28086;var x$28061;var bridge$28042$28056;var t0$28057;var $28040$28051;var ph$28045;(ph$28045=$28035$28038);($28040$28051=ph$28045);(bridge$28042$28056=$28040$28051);if((((bridge$28042$28056 instanceof Array)&&(((t0$28068=bridge$28042$28056.length)),((t0$28068===2)&&((bridge$28042$28056[0]==="symbol")&&((x$28061=bridge$28042$28056[1]),true)))))||((bridge$28042$28056 instanceof Array)&&(((t0$28076=bridge$28042$28056.length)),((t0$28076===2)&&((bridge$28042$28056[0]==="value")&&((x$28061=bridge$28042$28056[1]),true))))))){return ["value",x$28061];}else{if((($28040$28051 instanceof Array)&&(((t0$28057=$28040$28051.length)),((t0$28057>=1)&&($28040$28051[0]==="data"))))){(args$28086=Array.prototype.slice.call($28040$28051,1));return ["data"].concat((((acc$28099=[])),(((temp$28105=args$28086)),((($length$28111=temp$28105.length)),((($index$28117=0)),function(){$28094:for(;($index$28117<$length$28111);($index$28117++)){var arg$28134;var m$28126;(m$28126=temp$28105[$index$28117]);(arg$28134=m$28126);acc$28099.push(f$28031(arg$28134));}}()))),acc$28099));}else{(other$28139=$28040$28051);throw $36594(["syntax","dot"]).create("Argument to '.' must be a symbol or an array",({"argument":other$28139}));}}});return f$28031(expr$28001);}),accum$27989)),$25314(((accum$28143=({})),((accum$28143["="]=function(context$28148,scope$28149,form$28150,expr$28151){var x$28171;var t0$28181;var t1$28182;var lhs$28178;var rhs$28179;var lhs$28254;var rhs$28255;var s$28238;var rhs$28239;var $28208$28223;var $28209$28224;var $28210$28225;var $28211$28226;var t0$28219;var t1$28220;var t2$28221;var $28204$28214;var t0$28269;var t1$28270;var lhs$28266;var rhs$28267;var other$28262;var t0$28164;var $28153$28159;($28153$28159=context$28148);if((((x$28171=$28153$28159)),((x$28171 instanceof Array)&&(x$28171[0]==="pattern")))){(t0$28181=expr$28151);if(((t0$28181 instanceof Array)&&(((t1$28182=t0$28181.length)),((t1$28182===3)&&(t0$28181[0]==="data"))))){(lhs$28178=t0$28181[1]);(rhs$28179=t0$28181[2]);}else{$36853(expr$28151,"/home/olivier/git/earl-grey/src/stdenv.eg",11731,11735);}return ["default",lhs$28178,rhs$28179];}else{if((($28153$28159 instanceof Array)&&(((t0$28164=$28153$28159.length)),((t0$28164===2)&&(($28153$28159[0]==="expr")&&($28153$28159[1]==="data")))))){($28204$28214=expr$28151);if((($28208$28223=($28204$28214 instanceof Array))&&(((t0$28219=$28204$28214.length)),((t0$28219===1)&&($28204$28214[0]==="void"))))){return ["assoc"];}else{if(($28208$28223&&(($28210$28225=(t0$28219===3))&&(($28211$28226=($28204$28214[0]==="data"))&&(((t1$28220=$28204$28214[1])),((t1$28220 instanceof Array)&&(((t2$28221=t1$28220.length)),((t2$28221===2)&&(t1$28220[0]==="symbol"))))))))){(s$28238=t1$28220[1]);(rhs$28239=$28204$28214[2]);return ["assoc",["value",s$28238],rhs$28239];}else{if($28211$28226){(lhs$28254=$28204$28214[1]);(rhs$28255=$28204$28214[2]);return ["objsplice",["multi",parse_pattern$25448(scope$28149,lhs$28254,__lt____lt____colon__$25440(["use",scope$28149,rhs$28255],rhs$28255),pattern_handlers$25479.build_object)]];}else{$36853($28204$28214);}}}}else{(other$28262=$28153$28159);(t0$28269=expr$28151);if(((t0$28269 instanceof Array)&&(((t1$28270=t0$28269.length)),((t1$28270===3)&&(t0$28269[0]==="data"))))){(lhs$28266=t0$28269[1]);(rhs$28267=t0$28269[2]);}else{$36853(expr$28151,"/home/olivier/git/earl-grey/src/stdenv.eg",12306,12310);}return parse_pattern$25448(scope$28149,lhs$28266,__lt____lt____colon__$25440(["use",scope$28149,rhs$28267],rhs$28267),pattern_handlers$25479.declare_variables);}}}),accum$28143)),$25314(((accum$28284=({})),((accum$28284["=>"]=function($28288$28295,scope$28296,$28290$28297,$28292$28298){var t0$28312;var t0$28321;var t1$28322;var x$28348;var x$28386;var t0$28396;var t0$28404;var t0$28423;var t0$28431;var k$28414;var rhs$28415;var k$28377;var $28358$28372;var $28359$28373;var $28360$28374;var t0$28368;var bridge$28355$28369;var bridge$28357$28370;var $28353$28363;var x$28446;var t0$28455;var t1$28456;var t2$28457;var stmts$28453;var other$28477;var $28300$28337;var ph$28304;var env$28305;var lhs$28306;var rhs$28307;(ph$28304=$28288$28295);(t0$28312=$28290$28297);if($36545(t0$28312,"env")){(env$28305=t0$28312.env);}else{$36853($28290$28297);}(t0$28321=$28292$28298);if(((t0$28321 instanceof Array)&&(((t1$28322=t0$28321.length)),((t1$28322===3)&&(t0$28321[0]==="data"))))){(lhs$28306=t0$28321[1]);(rhs$28307=t0$28321[2]);}else{$36853($28292$28298);}($28300$28337=ph$28304);if((((x$28348=$28300$28337)),((x$28348 instanceof Array)&&(x$28348[0]==="pattern")))){($28353$28363=[lhs$28306,rhs$28307]);if((($28358$28372=($28353$28363 instanceof Array))&&(((t0$28368=$28353$28363.length)),(($28360$28374=(t0$28368===2))&&((((x$28386=$28353$28363[0])),((x$28386 instanceof Array)&&(x$28386[0]==="void")))&&(((bridge$28355$28369=$28353$28363[1])),(((bridge$28355$28369 instanceof Array)&&(((t0$28396=bridge$28355$28369.length)),((t0$28396===2)&&((bridge$28355$28369[0]==="symbol")&&((k$28377=bridge$28355$28369[1]),true)))))||((bridge$28355$28369 instanceof Array)&&(((t0$28404=bridge$28355$28369.length)),((t0$28404===2)&&((bridge$28355$28369[0]==="value")&&((k$28377=bridge$28355$28369[1]),true)))))))))))){return ["assoc",["value",k$28377],$36439(__lt____lt____colon__$25440(["symbol",k$28377],rhs$28307),({"env":env$28305}))];}else{if(($28360$28374&&(((bridge$28357$28370=$28353$28363[0])),(((bridge$28357$28370 instanceof Array)&&(((t0$28423=bridge$28357$28370.length)),((t0$28423===2)&&((bridge$28357$28370[0]==="symbol")&&((k$28414=bridge$28357$28370[1]),true)))))||((bridge$28357$28370 instanceof Array)&&(((t0$28431=bridge$28357$28370.length)),((t0$28431===2)&&((bridge$28357$28370[0]==="value")&&((k$28414=bridge$28357$28370[1]),true))))))))){(rhs$28415=$28353$28363[1]);return ["assoc",["value",k$28414],rhs$28415];}else{$36853($28353$28363);}}}else{if((((x$28446=$28300$28337)),((x$28446 instanceof Array)&&(x$28446[0]==="test")))){(t0$28455=$36872(["multi"])(rhs$28307));if((t0$28455[0]&&(((t1$28456=t0$28455[1])),(((t2$28457=t1$28456.length)),(t2$28457>=0))))){(stmts$28453=Array.prototype.slice.call(t1$28456,0));}else{$36853(rhs$28307,"/home/olivier/git/earl-grey/src/stdenv.eg",12881,12884);}return ["blocktest",lhs$28306,stmts$28453];}else{(other$28477=$28300$28337);return ["assoc",lhs$28306,rhs$28307];}}}),accum$28284)),$25314(((accum$28480=({})),((accum$28480[":="]=function(context$28487,scope$28488,form$28489,$28484$28490){var t0$28495;var t1$28496;var lhs$28492;var rhs$28493;(t0$28495=$28484$28490);if(((t0$28495 instanceof Array)&&(((t1$28496=t0$28495.length)),((t1$28496===3)&&(t0$28495[0]==="data"))))){(lhs$28492=t0$28495[1]);(rhs$28493=t0$28495[2]);}else{$36853($28484$28490);}return ["assign",lhs$28492,rhs$28493];}),accum$28480)),$25314(({"+=":make_assigner$25482("+"),"-=":make_assigner$25482("-"),"*=":make_assigner$25482("*"),"/=":make_assigner$25482("/"),"<<=":make_assigner$25482("<<"),">>=":make_assigner$25482(">>"),">>>=":make_assigner$25482(">>>"),"++=":make_assigner$25482("++"),"?=":make_assigner$25482("match"),"or=":make_assigner$25482("or"),"and=":make_assigner$25482("and"),"each=":make_assigner$25482("each")}),$25314(((accum$28510=({})),((accum$28510["_lambda"]=function(context$28517,scope$28518,form$28519,$28514$28520){var t0$28528;var t1$28529;var t2$28530;var t3$28531;var $index$28658;var $length$28652;var temp$28646;var acc$28640;var decls$28625;var newargs$28626;var body2$28792;var a$28786;var other$28782;var fw$28593;var t0$28585;var t1$28586;var t2$28587;var t3$28588;var t4$28589;var $28557$28580;var wrap$28560;var pp$28561;var args$28522;var arg$28523;var pre$28524;var body$28525;var post$28526;(t0$28528=$28514$28520);if(((t0$28528 instanceof Array)&&(((t1$28529=t0$28528.length)),((t1$28529===5)&&((t0$28528[0]==="data")&&(((t2$28530=t0$28528[1])),((t2$28530 instanceof Array)&&(((t3$28531=t2$28530.length)),((t3$28531>=1)&&(t2$28530[0]==="data")))))))))){(args$28522=Array.prototype.slice.call(t2$28530,1));(arg$28523=t2$28530);(pre$28524=t0$28528[2]);(body$28525=t0$28528[3]);(post$28526=t0$28528[4]);}else{$36853($28514$28520);}(wrap$28560=function(body2$28566){var body3$28570;(body3$28570=function(){if($36936(post$28526,["value",null])){return body2$28566;}else{return ["multi",body2$28566,post$28526];}}());if($36936(pre$28524,["value",null])){return body3$28570;}else{return ["multi",pre$28524,body3$28570];}});(pp$28561=PatternParser$25446(scope$28518,arg$28523,({"indexable":true,"allow_nested":true})));($28557$28580=pp$28561.pattern);if((($28557$28580 instanceof Array)&&(((t0$28585=$28557$28580.length)),((t0$28585===5)&&(($28557$28580[0]==="array_pattern")&&((fw$28593=$28557$28580[1]),(((t1$28586=$28557$28580[2])),((t1$28586 instanceof Array)&&(((t2$28587=t1$28586.length)),((t2$28587===0)&&(((t3$28588=$28557$28580[3])),((t3$28588 instanceof Array)&&(((t4$28589=t3$28588.length)),((t4$28589===0)&&($28557$28580[4]===(void 0)))))))))))))))){(decls$28625=function(){if(pp$28561.specials.match){return [["declare",["symbol","ph"]]];}else{return [];}}());(newargs$28626=(((acc$28640=[])),(((temp$28646=$37109(fw$28593,args$28522))),((($length$28652=temp$28646.length)),((($index$28658=0)),function(){$28632:for(;($index$28658<$length$28652);($index$28658++)){var newv$28730;var other$28725;var expr$28698;var v$28699;var t0$28691;var t1$28692;var t2$28693;var t3$28694;var arg$28677;var $28635$28678;var t0$28672;var t1$28673;var m$28667;(m$28667=temp$28646[$index$28658]);(t0$28672=m$28667);if(((t0$28672 instanceof Array)&&(((t1$28673=t0$28672.length)),(t1$28673===2)))){($28635$28678=t0$28672[0]);(arg$28677=t0$28672[1]);(t0$28691=$28635$28678);if(((t0$28691 instanceof Array)&&(((t1$28692=t0$28691.length)),((t1$28692===2)&&((t0$28691[0]==="assign")&&(((t2$28693=t0$28691[1])),((expr$28698=t2$28693),((t2$28693 instanceof Array)&&(((t3$28694=t2$28693.length)),((t3$28694===2)&&(t2$28693[0]==="symbol"))))))))))){(v$28699=t2$28693[1]);acc$28640.push(expr$28698);}else{(other$28725=$28635$28678);acc$28640.push((((newv$28730=$36439(["symbol",scope$28518.gensym("temp")],({"env":stdenv$25460})))),decls$28625.push(parse_pattern$25448(scope$28518,arg$28677,newv$28730,$36439(pattern_handlers$25479.declare_variables,({"tags":({"declare_mode":"let"}),"special":function($28735$28738,value$28739){var t0$28747;var t1$28748;var other$28775;var $28741$28763;var ph$28744;var expr$28745;(t0$28747=$28735$28738);if(((t0$28747 instanceof Array)&&(((t1$28748=t0$28747.length)),((t1$28748===2)&&(t0$28747[0]==="special"))))){(ph$28744=t0$28747[1]);(expr$28745=t0$28747);}else{$36853($28735$28738);}($28741$28763=ph$28744);if(($28741$28763==="match")){return ["assign",["symbol","ph"]];}else{(other$28775=$28741$28763);throw $36594(["syntax","pattern","special"]).create("Special token cannot be used here",({"special":expr$28745}));}}})))),newv$28730));}}else{$36853(m$28667,"/home/olivier/git/earl-grey/src/stdenv.eg",13961,14826);}}}()))),acc$28640));return ["lambda",newargs$28626,wrap$28560(["multi"].concat(decls$28625).concat([function(){if(pp$28561.specials.match){return ["send",["symbol","match"],["data",["symbol","ph"],body$28525]];}else{return body$28525;}}()]))];}else{(other$28782=$28557$28580);(a$28786=__lt____lt____colon__$25440(["symbol","arguments"],arg$28523));(body2$28792=["send",["send",["symbol","match"],["send",["symbol","."],["data",["void"],["symbol","indexable"]]]],["data",a$28786,["send",["symbol","->"],["data",arg$28523,body$28525]]]]);return ["lambda",[],wrap$28560(body2$28792)];}}),accum$28510)),$25314(((accum$28797=({})),((accum$28797["->"]=function($28801$28804,scope$28805,form$28806,expr$28807){var x$28831;var t0$28841;var t1$28842;var lhs$28838;var rhs$28839;var other$28884;var args$28873;var body$28874;var t0$28869;var $28859$28864;var other$28857;var $28809$28818;var ph$28812;(ph$28812=$28801$28804);($28809$28818=ph$28812);if(form$28806.name){console.log(form$28806.name);}if((((x$28831=$28809$28818)),((x$28831 instanceof Array)&&(x$28831[0]==="clause")))){(t0$28841=expr$28807);if(((t0$28841 instanceof Array)&&(((t1$28842=t0$28841.length)),((t1$28842===3)&&(t0$28841[0]==="data"))))){(lhs$28838=t0$28841[1]);(rhs$28839=t0$28841[2]);}else{$36853(expr$28807,"/home/olivier/git/earl-grey/src/stdenv.eg",15325,15329);}return ["clause",lhs$28838,rhs$28839];}else{(other$28857=$28809$28818);($28859$28864=expr$28807);if((($28859$28864 instanceof Array)&&(((t0$28869=$28859$28864.length)),((t0$28869===3)&&($28859$28864[0]==="data"))))){(args$28873=$28859$28864[1]);(body$28874=$28859$28864[2]);return ["send",["symbol","_lambda"],["data",args$28873,["value",null],body$28874,["value",null]]];}else{(other$28884=$28859$28864);throw $36594(["syntax","lambda"]).create("Bad lambda syntax",({"node":other$28884}));}}}),accum$28797)),$25314(({"match":accum_flags$25476(function($28887$28890,scope$28891,form$28892,expr$28893,flags$28894){var x$28916;var other$28944;var t0$28931;var $28921$28926;var v$29017;var b$29018;var b$28992;var $28974$28988;var $28975$28989;var t0$28983;var t1$28984;var t2$28985;var t3$28986;var $28971$28978;var v$29093;var b$29094;var b$29068;var $29050$29064;var $29051$29065;var t0$29059;var t1$29060;var t2$29061;var t3$29062;var $29047$29054;var t0$28965;var t1$28966;var accum$29122;var mbody$29117;var opt$28954;var to_match$28955;var value$28956;var body$28957;var other$28948;var $28896$28905;var ph$28899;(ph$28899=$28887$28890);($28896$28905=ph$28899);if((((x$28916=$28896$28905)),((x$28916 instanceof Array)&&(x$28916[0]==="pattern")))){($28921$28926=expr$28893);if((($28921$28926 instanceof Array)&&(((t0$28931=$28921$28926.length)),((t0$28931===1)&&($28921$28926[0]==="void"))))){return ["special","match"];}else{(other$28944=$28921$28926);return ["all",__lt____lt____colon__$25440(other$28944,expr$28893),__lt____lt____colon__$25440(["special","match"],form$28892)];}}else{(other$28948=$28896$28905);(opt$28954=util$25441.mkset(flags$28894));(to_match$28955=$36439(["symbol",scope$28891.gensym("m")],({"single_assignment":true})));(t0$28965=((($28971$28978=expr$28893)),function(){if((($28974$28988=($28971$28978 instanceof Array))&&(((t0$28983=$28971$28978.length)),((t0$28983===2)&&(($28971$28978[0]==="data")&&(((t1$28984=$36872(["multi"])($28971$28978[1]))),(t1$28984[0]&&(((t2$28985=t1$28984[1])),(((t3$28986=t2$28985.length)),(t3$28986>=0)))))))))){(b$28992=Array.prototype.slice.call(t2$28985,0));return [["value",null],b$28992];}else{if(($28974$28988&&((t0$28983===3)&&(($28971$28978[0]==="data")&&((v$29017=$28971$28978[1]),(((t1$28984=$36872(["multi"])($28971$28978[2]))),(t1$28984[0]&&(((t2$28985=t1$28984[1])),(((t3$28986=t2$28985.length)),(t3$28986>=0)))))))))){(b$29018=Array.prototype.slice.call(t2$28985,0));return [v$29017,b$29018];}else{$36853($28971$28978);}}}()));if(((t0$28965 instanceof Array)&&(((t1$28966=t0$28965.length)),(t1$28966===2)))){(value$28956=t0$28965[0]);(body$28957=t0$28965[1]);}else{$36853(((($29047$29054=expr$28893)),function(){if((($29050$29064=($29047$29054 instanceof Array))&&(((t0$29059=$29047$29054.length)),((t0$29059===2)&&(($29047$29054[0]==="data")&&(((t1$29060=$36872(["multi"])($29047$29054[1]))),(t1$29060[0]&&(((t2$29061=t1$29060[1])),(((t3$29062=t2$29061.length)),(t3$29062>=0)))))))))){(b$29068=Array.prototype.slice.call(t2$29061,0));return [["value",null],b$29068];}else{if(($29050$29064&&((t0$29059===3)&&(($29047$29054[0]==="data")&&((v$29093=$29047$29054[1]),(((t1$29060=$36872(["multi"])($29047$29054[2]))),(t1$29060[0]&&(((t2$29061=t1$29060[1])),(((t3$29062=t2$29061.length)),(t3$29062>=0)))))))))){(b$29094=Array.prototype.slice.call(t2$29061,0));return [v$29093,b$29094];}else{$36853($29047$29054);}}}()),"/home/olivier/git/earl-grey/src/stdenv.eg",17959,18078);}(mbody$29117=parse_clauses$25449(scope$28891,to_match$28955,body$28957,$36439(opt$28954,$25314(((accum$29122=({})),((accum$29122["fallback"]=function(target$29127){return match_error$25467(target$29127);}),accum$29122)),({"wrap":function(x$29131){return x$29131;}})))));return ["send",["symbol","let"],["data",["send",["symbol","="],["data",to_match$28955,value$28956]],mbody$29117]];}})}),$25314(((accum$29135=({})),((accum$29135["each"]=function($29139$29146,scope$29147,$29141$29148,$29143$29149){var t0$29169;var t0$29178;var t1$29179;var t2$29180;var t3$29181;var t4$29182;var x$29295;var other$29319;var ends_with_test$29227;var _build_loop$29228;var $29156$29220;var $29157$29221;var $29158$29222;var $29159$29223;var t0$29218;var $29151$29213;var ph$29160;var form$29161;var env$29162;var li$29163;var clauses$29164;(ph$29160=$29139$29146);(t0$29169=$29141$29148);(form$29161=t0$29169);if($36545(t0$29169,"env")){(env$29162=t0$29169.env);}else{$36853($29141$29148);}(t0$29178=$29143$29149);if(((t0$29178 instanceof Array)&&(((t1$29179=t0$29178.length)),((t1$29179===3)&&((t0$29178[0]==="data")&&((li$29163=t0$29178[1]),(((t2$29180=$36872(["multi"])(t0$29178[2]))),(t2$29180[0]&&(((t3$29181=t2$29180[1])),(((t4$29182=t3$29181.length)),(t4$29182>=0))))))))))){(clauses$29164=Array.prototype.slice.call(t3$29181,0));}else{$36853($29143$29149);}($29151$29213=ph$29160);(ends_with_test$29227=false);(_build_loop$29228=function(wrap$29236,pre$29237,post$29238){var accum$29243;var accum$29282;return build_loop$25480(scope$29147,env$29162,form$29161,li$29163,clauses$29164,wrap$29236,pre$29237,post$29238,$25314(((accum$29243=({})),((accum$29243["wrap_pattern"]=function(x$29248,toplevel$29249){var x$29271;var other$29278;var $29255$29260;(ends_with_test$29227=((($29255$29260=x$29248)),function(){if((((x$29271=$29255$29260)),((x$29271 instanceof Array)&&(x$29271[0]==="test")))){return toplevel$29249;}else{(other$29278=$29255$29260);return false;}}()));return x$29248;}),accum$29243)),((accum$29282=({})),((accum$29282["fallback"]=function(target$29287){if(ends_with_test$29227){return ["symbol","false"];}else{return match_error$25467(target$29287);}}),accum$29282))));});if((((x$29295=$29151$29213)),((x$29295 instanceof Array)&&(x$29295[0]==="test")))){return $36439(["test_factory",li$29163,clauses$29164],({"env":env$29162}));}else{if((($29156$29220=($29151$29213 instanceof Array))&&(((t0$29218=$29151$29213.length)),(($29158$29222=(t0$29218===2))&&(($29159$29223=($29151$29213[0]==="expr"))&&($29151$29213[1]==="multi")))))){return ["nostep",form$29161];}else{if(($29159$29223&&($29151$29213[1]==="ignore"))){return _build_loop$29228(function(x$29315){return x$29315;},["splice"],["splice"]);}else{(other$29319=$29151$29213);return _build_loop$29228(function(x$29323){return ["send",["send",["symbol","acc"],["send",["symbol","."],["data",["void"],["symbol","push"]]]],["data",["multi",x$29323]]];},["send",["symbol","="],["data",["send",["symbol","var"],["symbol","acc"]],["data"]]],["symbol","acc"]);}}}}),accum$29135)),$25314(((accum$29326=({})),((accum$29326["each?"]=function($29330$29337,scope$29338,$29332$29339,$29334$29340){var t0$29360;var t0$29369;var t1$29370;var t2$29371;var t3$29372;var t4$29373;var x$29420;var other$29448;var $29347$29411;var $29348$29412;var $29349$29413;var $29350$29414;var t0$29409;var $29342$29404;var ph$29351;var form$29352;var env$29353;var li$29354;var clauses$29355;(ph$29351=$29330$29337);(t0$29360=$29332$29339);(form$29352=t0$29360);if($36545(t0$29360,"env")){(env$29353=t0$29360.env);}else{$36853($29332$29339);}(t0$29369=$29334$29340);if(((t0$29369 instanceof Array)&&(((t1$29370=t0$29369.length)),((t1$29370===3)&&((t0$29369[0]==="data")&&((li$29354=t0$29369[1]),(((t2$29371=$36872(["multi"])(t0$29369[2]))),(t2$29371[0]&&(((t3$29372=t2$29371[1])),(((t4$29373=t3$29372.length)),(t4$29373>=0))))))))))){(clauses$29355=Array.prototype.slice.call(t3$29372,0));}else{$36853($29334$29340);}($29342$29404=ph$29351);if((((x$29420=$29342$29404)),((x$29420 instanceof Array)&&(x$29420[0]==="test")))){return $36439(["test_factory",li$29354,clauses$29355],({"env":env$29353}));}else{if((($29347$29411=($29342$29404 instanceof Array))&&(((t0$29409=$29342$29404.length)),(($29349$29413=(t0$29409===2))&&(($29350$29414=($29342$29404[0]==="expr"))&&($29342$29404[1]==="multi")))))){return ["nostep",form$29352];}else{if(($29350$29414&&($29342$29404[1]==="ignore"))){return build_loop$25480(scope$29338,env$29353,form$29352,li$29354,clauses$29355,function(x$29440){return x$29440;},["splice"],["splice"],({"fallback":function(target$29444){return ["symbol","false"];}}));}else{(other$29448=$29342$29404);return build_loop$25480(scope$29338,env$29353,form$29352,li$29354,clauses$29355,function(x$29452){return ["send",["send",["symbol","acc"],["send",["symbol","."],["data",["void"],["symbol","push"]]]],["data",x$29452]];},["send",["symbol","="],["data",["send",["symbol","var"],["symbol","acc"]],["data"]]],["symbol","acc"],({"fallback":function(target$29456){return ["symbol","false"];}}));}}}}),accum$29326)),$25314(((accum$29459=({})),((accum$29459["try"]=function($29463$29468,scope$29469,form$29470,$29465$29471){var t0$29487;var t1$29488;var t2$29489;var t3$29490;var t4$29491;var msg$29840;var otherwise$29836;var a$29789;var c$29790;var a$29762;var b$29763;var a$29688;var b$29689;var c$29690;var $29649$29678;var $29650$29679;var $29651$29680;var $29652$29681;var $29653$29682;var $29654$29683;var $29655$29684;var $29656$29685;var t0$29664;var t1$29665;var t2$29666;var t3$29667;var t4$29668;var t5$29669;var t6$29670;var t7$29671;var t8$29672;var t9$29673;var t10$29674;var t11$29675;var t12$29676;var $29644$29659;var msg$30048;var otherwise$30044;var a$29997;var c$29998;var a$29970;var b$29971;var a$29896;var b$29897;var c$29898;var $29857$29886;var $29858$29887;var $29859$29888;var $29860$29889;var $29861$29890;var $29862$29891;var $29863$29892;var $29864$29893;var t0$29872;var t1$29873;var t2$29874;var t3$29875;var t4$29876;var t5$29877;var t6$29878;var t7$29879;var t8$29880;var t9$29881;var t10$29882;var t11$29883;var t12$29884;var $29852$29867;var t0$29638;var t1$29639;var other$30072;var grouped$29535;var stmts$29536;var clauses$29537;var finally$29538;var $29477$29528;var $29478$29529;var $29479$29530;var $29480$29531;var t0$29526;var $29473$29521;var ph$29481;var parts$29482;(ph$29481=$29463$29468);(t0$29487=$29465$29471);if(((t0$29487 instanceof Array)&&(((t1$29488=t0$29487.length)),((t1$29488===2)&&((t0$29487[0]==="data")&&(((t2$29489=$36872(["multi"])(t0$29487[1]))),(t2$29489[0]&&(((t3$29490=t2$29489[1])),(((t4$29491=t3$29490.length)),(t4$29491>=0)))))))))){(parts$29482=Array.prototype.slice.call(t3$29490,0));}else{$36853($29465$29471);}($29473$29521=ph$29481);(grouped$29535=classify_contiguous$25444(parts$29482,function($29542$29545){var other$29634;var e$29618;var b$29619;var b$29588;var $29551$29577;var $29552$29578;var $29553$29579;var $29554$29580;var $29555$29581;var $29556$29582;var $29557$29583;var $29558$29584;var $29559$29585;var t0$29571;var t1$29572;var t2$29573;var t3$29574;var t4$29575;var $29547$29566;var ph$29560;(ph$29560=$29542$29545);($29547$29566=ph$29560);if((($29551$29577=($29547$29566 instanceof Array))&&(((t0$29571=$29547$29566.length)),(($29553$29579=(t0$29571===3))&&(($29554$29580=($29547$29566[0]==="send"))&&(((t1$29572=$29547$29566[1])),(($29556$29582=(t1$29572 instanceof Array))&&(((t2$29573=t1$29572.length)),(($29558$29584=(t2$29573===2))&&(($29559$29585=(t1$29572[0]==="symbol"))&&((t1$29572[1]==="finally")&&(((t3$29574=$29547$29566[2])),((t3$29574 instanceof Array)&&(((t4$29575=t3$29574.length)),((t4$29575===2)&&(t3$29574[0]==="data")))))))))))))))){(b$29588=t3$29574[1]);return "finally";}else{if(($29559$29585&&((t1$29572[1]==="->")&&(((t3$29574=$29547$29566[2])),((t3$29574 instanceof Array)&&(((t4$29575=t3$29574.length)),((t4$29575===3)&&(t3$29574[0]==="data")))))))){(e$29618=t3$29574[1]);(b$29619=t3$29574[2]);return "clause";}else{(other$29634=$29547$29566);return "stmt";}}}));(t0$29638=((($29644$29659=grouped$29535)),function(){if((($29649$29678=($29644$29659 instanceof Array))&&(((t0$29664=$29644$29659.length)),((t0$29664===3)&&(((t1$29665=$29644$29659[0])),((t1$29665 instanceof Array)&&(((t2$29666=t1$29665.length)),((t2$29666>=1)&&((t1$29665[0]==="stmt")&&((a$29688=Array.prototype.slice.call(t1$29665,1)),(((t3$29667=$29644$29659[1])),((t3$29667 instanceof Array)&&(((t4$29668=t3$29667.length)),((t4$29668>=1)&&((t3$29667[0]==="clause")&&((b$29689=Array.prototype.slice.call(t3$29667,1)),(((t5$29669=$29644$29659[2])),((t5$29669 instanceof Array)&&(((t6$29670=t5$29669.length)),((t6$29670===2)&&((t5$29669[0]==="finally")&&(((t7$29671=t5$29669[1])),((t7$29671 instanceof Array)&&(((t8$29672=t7$29671.length)),((t8$29672===3)&&((t7$29671[0]==="send")&&(((t9$29673=t7$29671[1])),((t9$29673 instanceof Array)&&(((t10$29674=t9$29673.length)),((t10$29674===2)&&((t9$29673[0]==="symbol")&&((t9$29673[1]==="finally")&&(((t11$29675=t7$29671[2])),((t11$29675 instanceof Array)&&(((t12$29676=t11$29675.length)),((t12$29676===2)&&(t11$29675[0]==="data"))))))))))))))))))))))))))))))))))))){(c$29690=t11$29675[1]);return [a$29688,b$29689,c$29690];}else{if(($29649$29678&&(($29651$29680=(t0$29664===2))&&(((t1$29665=$29644$29659[0])),(($29653$29682=(t1$29665 instanceof Array))&&(((t2$29666=t1$29665.length)),(($29655$29684=(t2$29666>=1))&&(($29656$29685=(t1$29665[0]==="stmt"))&&((a$29762=Array.prototype.slice.call(t1$29665,1)),(((t3$29667=$29644$29659[1])),((t3$29667 instanceof Array)&&(((t4$29668=t3$29667.length)),((t4$29668>=1)&&(t3$29667[0]==="clause")))))))))))))){(b$29763=Array.prototype.slice.call(t3$29667,1));return [a$29762,b$29763,null];}else{if(($29656$29685&&((a$29789=Array.prototype.slice.call(t1$29665,1)),(((t3$29667=$29644$29659[1])),((t3$29667 instanceof Array)&&(((t4$29668=t3$29667.length)),((t4$29668===2)&&((t3$29667[0]==="finally")&&(((t5$29669=t3$29667[1])),((t5$29669 instanceof Array)&&(((t6$29670=t5$29669.length)),((t6$29670===3)&&((t5$29669[0]==="send")&&(((t7$29671=t5$29669[1])),((t7$29671 instanceof Array)&&(((t8$29672=t7$29671.length)),((t8$29672===2)&&((t7$29671[0]==="symbol")&&((t7$29671[1]==="finally")&&(((t9$29673=t5$29669[2])),((t9$29673 instanceof Array)&&(((t10$29674=t9$29673.length)),((t10$29674===2)&&(t9$29673[0]==="data")))))))))))))))))))))))){(c$29790=t9$29673[1]);return [a$29789,[],c$29790];}else{(otherwise$29836=$29644$29659);(msg$29840=["try expects a list of statements","and one or more catch clauses and/or","a finally clause"].join(" "));throw $36594(["syntax","try"]).create(msg$29840,({"node":form$29470}));}}}}()));if(((t0$29638 instanceof Array)&&(((t1$29639=t0$29638.length)),(t1$29639===3)))){(stmts$29536=t0$29638[0]);(clauses$29537=t0$29638[1]);(finally$29538=t0$29638[2]);}else{$36853(((($29852$29867=grouped$29535)),function(){if((($29857$29886=($29852$29867 instanceof Array))&&(((t0$29872=$29852$29867.length)),((t0$29872===3)&&(((t1$29873=$29852$29867[0])),((t1$29873 instanceof Array)&&(((t2$29874=t1$29873.length)),((t2$29874>=1)&&((t1$29873[0]==="stmt")&&((a$29896=Array.prototype.slice.call(t1$29873,1)),(((t3$29875=$29852$29867[1])),((t3$29875 instanceof Array)&&(((t4$29876=t3$29875.length)),((t4$29876>=1)&&((t3$29875[0]==="clause")&&((b$29897=Array.prototype.slice.call(t3$29875,1)),(((t5$29877=$29852$29867[2])),((t5$29877 instanceof Array)&&(((t6$29878=t5$29877.length)),((t6$29878===2)&&((t5$29877[0]==="finally")&&(((t7$29879=t5$29877[1])),((t7$29879 instanceof Array)&&(((t8$29880=t7$29879.length)),((t8$29880===3)&&((t7$29879[0]==="send")&&(((t9$29881=t7$29879[1])),((t9$29881 instanceof Array)&&(((t10$29882=t9$29881.length)),((t10$29882===2)&&((t9$29881[0]==="symbol")&&((t9$29881[1]==="finally")&&(((t11$29883=t7$29879[2])),((t11$29883 instanceof Array)&&(((t12$29884=t11$29883.length)),((t12$29884===2)&&(t11$29883[0]==="data"))))))))))))))))))))))))))))))))))))){(c$29898=t11$29883[1]);return [a$29896,b$29897,c$29898];}else{if(($29857$29886&&(($29859$29888=(t0$29872===2))&&(((t1$29873=$29852$29867[0])),(($29861$29890=(t1$29873 instanceof Array))&&(((t2$29874=t1$29873.length)),(($29863$29892=(t2$29874>=1))&&(($29864$29893=(t1$29873[0]==="stmt"))&&((a$29970=Array.prototype.slice.call(t1$29873,1)),(((t3$29875=$29852$29867[1])),((t3$29875 instanceof Array)&&(((t4$29876=t3$29875.length)),((t4$29876>=1)&&(t3$29875[0]==="clause")))))))))))))){(b$29971=Array.prototype.slice.call(t3$29875,1));return [a$29970,b$29971,null];}else{if(($29864$29893&&((a$29997=Array.prototype.slice.call(t1$29873,1)),(((t3$29875=$29852$29867[1])),((t3$29875 instanceof Array)&&(((t4$29876=t3$29875.length)),((t4$29876===2)&&((t3$29875[0]==="finally")&&(((t5$29877=t3$29875[1])),((t5$29877 instanceof Array)&&(((t6$29878=t5$29877.length)),((t6$29878===3)&&((t5$29877[0]==="send")&&(((t7$29879=t5$29877[1])),((t7$29879 instanceof Array)&&(((t8$29880=t7$29879.length)),((t8$29880===2)&&((t7$29879[0]==="symbol")&&((t7$29879[1]==="finally")&&(((t9$29881=t5$29877[2])),((t9$29881 instanceof Array)&&(((t10$29882=t9$29881.length)),((t10$29882===2)&&(t9$29881[0]==="data")))))))))))))))))))))))){(c$29998=t9$29881[1]);return [a$29997,[],c$29998];}else{(otherwise$30044=$29852$29867);(msg$30048=["try expects a list of statements","and one or more catch clauses and/or","a finally clause"].join(" "));throw $36594(["syntax","try"]).create(msg$30048,({"node":form$29470}));}}}}()),"/home/olivier/git/earl-grey/src/stdenv.eg",21330,21854);}if((($29477$29528=($29473$29521 instanceof Array))&&(((t0$29526=$29473$29521.length)),(($29479$29530=(t0$29526===2))&&(($29480$29531=($29473$29521[0]==="expr"))&&($29473$29521[1]==="multi")))))){return ["nostep",form$29470];}else{if(($29480$29531&&($29473$29521[1]==="ignore"))){clauses$29537.push(mkstdenv$25461().mark(["send",["symbol","->"],["data",["symbol","e"],["send",["symbol","throw"],["symbol","e"]]]]));return ["js_try",["multi"].concat(stmts$29536),["send",["symbol","->"],["data",["data",["symbol","excv"]],parse_clauses$25449(scope$29469,["symbol","excv"],clauses$29537,({"wrap":function(x$30068){return x$30068;}}))]],(finally$29538||["void"])];}else{(other$30072=$29473$29521);clauses$29537.push(mkstdenv$25461().mark(["send",["symbol","->"],["data",["symbol","e"],["send",["symbol","throw"],["symbol","e"]]]]));return ["send",["symbol","let"],["data",["send",["symbol","="],["data",["send",["symbol","var"],["symbol","rval"]],["symbol","false"]]],["multi",["js_try",["send",["symbol","="],["data",["send",["symbol","set"],["symbol","rval"]],["multi"].concat(stmts$29536)]],["send",["symbol","->"],["data",["data",["symbol","excv"]],parse_clauses$25449(scope$29469,["symbol","excv"],clauses$29537,({"wrap":function(x$30077){return ["send",["symbol","="],["data",["send",["symbol","set"],["symbol","rval"]],x$30077]];}}))]],(finally$29538||["void"])],["symbol","rval"]]]];}}}),accum$29459)),$25314(((accum$30080=({})),((accum$30080["!!"]=function($30084$30089,scope$30090,form$30091,$30086$30092){var t0$30109;var t1$30110;var t2$30111;var t3$30112;var t4$30113;var other$30175;var $30098$30151;var $30099$30152;var $30100$30153;var $30101$30154;var t0$30149;var $30094$30144;var ph$30102;var expr$30103;var clauses$30104;(ph$30102=$30084$30089);(t0$30109=$30086$30092);if(((t0$30109 instanceof Array)&&(((t1$30110=t0$30109.length)),((t1$30110===3)&&((t0$30109[0]==="data")&&((expr$30103=t0$30109[1]),(((t2$30111=$36872(["multi"])(t0$30109[2]))),(t2$30111[0]&&(((t3$30112=t2$30111[1])),(((t4$30113=t3$30112.length)),(t4$30113>=0))))))))))){(clauses$30104=Array.prototype.slice.call(t3$30112,0));}else{$36853($30086$30092);}($30094$30144=ph$30102);if((($30098$30151=($30094$30144 instanceof Array))&&(((t0$30149=$30094$30144.length)),(($30100$30153=(t0$30149===2))&&(($30101$30154=($30094$30144[0]==="expr"))&&($30094$30144[1]==="multi")))))){return ["nostep",form$30091];}else{if(($30101$30154&&($30094$30144[1]==="ignore"))){clauses$30104.push(mkstdenv$25461().mark(["send",["symbol","->"],["data",["symbol","e"],["send",["symbol","throw"],["symbol","e"]]]]));return ["js_try",expr$30103,["send",["symbol","->"],["data",["data",["symbol","excv"]],parse_clauses$25449(scope$30090,["symbol","excv"],clauses$30104,({"wrap":function(x$30171){return x$30171;}}))]],["void"]];}else{(other$30175=$30094$30144);clauses$30104.push(mkstdenv$25461().mark(["send",["symbol","->"],["data",["symbol","e"],["send",["symbol","throw"],["symbol","e"]]]]));return ["send",["symbol","let"],["data",["send",["symbol","="],["data",["send",["symbol","var"],["symbol","rval"]],["symbol","false"]]],["multi",["js_try",["send",["symbol","="],["data",["send",["symbol","set"],["symbol","rval"]],expr$30103]],["send",["symbol","->"],["data",["data",["symbol","excv"]],parse_clauses$25449(scope$30090,["symbol","excv"],clauses$30104,({"wrap":function(x$30180){return ["send",["symbol","="],["data",["send",["symbol","set"],["symbol","rval"]],x$30180]];}}))]],["void"]],["symbol","rval"]]]];}}}),accum$30080)),$25314(({"@":var_operator$25475(expander$25462.gensym("it"))}),$25314(((accum$30183=({})),(((t0$30185=$36872(expr_mac$25469)(function(scope$30194,form$30195,$30191$30196){var t0$30202;var t1$30203;var t2$30204;var t3$30205;var t4$30206;var t5$30207;var it$30245;var construct$30246;var defn$30198;var env$30199;var body$30200;(t0$30202=$30191$30196);if(((t0$30202 instanceof Array)&&(((t1$30203=t0$30202.length)),((t1$30203===3)&&((t0$30202[0]==="data")&&(((t2$30204=t0$30202[1])),((defn$30198=t2$30204),($36545(t2$30204,"env")&&((env$30199=t2$30204.env),(((t3$30205=$36872(["multi"])(t0$30202[2]))),(t3$30205[0]&&(((t4$30206=t3$30205[1])),(((t5$30207=t4$30206.length)),(t5$30207>=0)))))))))))))){(body$30200=Array.prototype.slice.call(t4$30206,0));}else{$36853($30191$30196);}(it$30245=$36439(["symbol","@"],({"env":env$30199})));(construct$30246=function($30253$30256){var x$30290;var rest$30291;var x$30280;var $30261$30276;var $30262$30277;var t0$30274;var $30258$30269;var ph$30263;(ph$30263=$30253$30256);($30258$30269=ph$30263);if((($30261$30276=($30258$30269 instanceof Array))&&(((t0$30274=$30258$30269.length)),(t0$30274===1)))){(x$30280=$30258$30269[0]);return x$30280;}else{if(($30261$30276&&(t0$30274>=1))){(x$30290=$30258$30269[0]);(rest$30291=Array.prototype.slice.call($30258$30269,1));return ["send",["symbol","let"],["data",["send",["symbol","="],["data",it$30245,x$30290]],construct$30246(rest$30291)]];}else{$36853($30258$30269);}}});return construct$30246([defn$30198].concat(body$30200));}))),function(){if(t0$30185[0]){(accum$30183["chain"]=t0$30185[1]);return accum$30183;}else{return $36853(function(scope$30303,form$30304,$30300$30305){var t0$30311;var t1$30312;var t2$30313;var t3$30314;var t4$30315;var t5$30316;var it$30354;var construct$30355;var defn$30307;var env$30308;var body$30309;(t0$30311=$30300$30305);if(((t0$30311 instanceof Array)&&(((t1$30312=t0$30311.length)),((t1$30312===3)&&((t0$30311[0]==="data")&&(((t2$30313=t0$30311[1])),((defn$30307=t2$30313),($36545(t2$30313,"env")&&((env$30308=t2$30313.env),(((t3$30314=$36872(["multi"])(t0$30311[2]))),(t3$30314[0]&&(((t4$30315=t3$30314[1])),(((t5$30316=t4$30315.length)),(t5$30316>=0)))))))))))))){(body$30309=Array.prototype.slice.call(t4$30315,0));}else{$36853($30300$30305);}(it$30354=$36439(["symbol","@"],({"env":env$30308})));(construct$30355=function($30362$30365){var x$30399;var rest$30400;var x$30389;var $30370$30385;var $30371$30386;var t0$30383;var $30367$30378;var ph$30372;(ph$30372=$30362$30365);($30367$30378=ph$30372);if((($30370$30385=($30367$30378 instanceof Array))&&(((t0$30383=$30367$30378.length)),(t0$30383===1)))){(x$30389=$30367$30378[0]);return x$30389;}else{if(($30370$30385&&(t0$30383>=1))){(x$30399=$30367$30378[0]);(rest$30400=Array.prototype.slice.call($30367$30378,1));return ["send",["symbol","let"],["data",["send",["symbol","="],["data",it$30354,x$30399]],construct$30355(rest$30400)]];}else{$36853($30367$30378);}}});return construct$30355([defn$30307].concat(body$30309));});}}())),$25314(((accum$30407=({})),(((t0$30409=$36872(expr_mac$25469)(function(scope$30418,form$30419,$30415$30420){var t0$30426;var t1$30427;var t2$30428;var it$30449;var defn$30422;var env$30423;var body$30424;(t0$30426=$30415$30420);if(((t0$30426 instanceof Array)&&(((t1$30427=t0$30426.length)),((t1$30427===3)&&((t0$30426[0]==="data")&&(((t2$30428=t0$30426[1])),((defn$30422=t2$30428),$36545(t2$30428,"env")))))))){(env$30423=t2$30428.env);(body$30424=t0$30426[2]);}else{$36853($30415$30420);}(it$30449=$36439(["symbol","@"],({"env":env$30423})));return ["send",["symbol","let"],["data",["send",["symbol","="],["data",it$30449,defn$30422]],body$30424]];}))),function(){if(t0$30409[0]){(accum$30407["using"]=t0$30409[1]);return accum$30407;}else{return $36853(function(scope$30459,form$30460,$30456$30461){var t0$30467;var t1$30468;var t2$30469;var it$30490;var defn$30463;var env$30464;var body$30465;(t0$30467=$30456$30461);if(((t0$30467 instanceof Array)&&(((t1$30468=t0$30467.length)),((t1$30468===3)&&((t0$30467[0]==="data")&&(((t2$30469=t0$30467[1])),((defn$30463=t2$30469),$36545(t2$30469,"env")))))))){(env$30464=t2$30469.env);(body$30465=t0$30467[2]);}else{$36853($30456$30461);}(it$30490=$36439(["symbol","@"],({"env":env$30464})));return ["send",["symbol","let"],["data",["send",["symbol","="],["data",it$30490,defn$30463]],body$30465]];});}}())),$25314(((accum$30495=({})),(((t0$30497=$36872(overridable$25470)(function($30503$30508,scope$30509,form$30510,$30505$30511){var t0$30523;var t1$30524;var x$30550;var x$30560;var t0$30569;var t1$30570;var t2$30571;var stmts$30567;var x$30594;var $30513$30539;var ph$30517;var body$30518;(ph$30517=$30503$30508);(t0$30523=$30505$30511);if(((t0$30523 instanceof Array)&&(((t1$30524=t0$30523.length)),((t1$30524===2)&&(t0$30523[0]==="data"))))){(body$30518=t0$30523[1]);}else{$36853($30505$30511);}($30513$30539=ph$30517);if((((x$30550=$30513$30539)),((x$30550 instanceof Array)&&(x$30550[0]==="clause")))){return ["block",body$30518];}else{if((((x$30560=$30513$30539)),((x$30560 instanceof Array)&&(x$30560[0]==="test")))){(t0$30569=$36872(["multi"])(body$30518));if((t0$30569[0]&&(((t1$30570=t0$30569[1])),(((t2$30571=t1$30570.length)),(t2$30571>=0))))){(stmts$30567=Array.prototype.slice.call(t1$30570,0));}else{$36853(body$30518,"/home/olivier/git/earl-grey/src/stdenv.eg",24013,24017);}return ["do",["splice"].concat(stmts$30567)];}else{if((((x$30594=$30513$30539)),((x$30594 instanceof Array)&&(x$30594[0]==="expr")))){return ["multi",body$30518];}else{$36853($30513$30539);}}}}))),function(){if(t0$30497[0]){(accum$30495["do"]=t0$30497[1]);return accum$30495;}else{return $36853(function($30604$30609,scope$30610,form$30611,$30606$30612){var t0$30624;var t1$30625;var x$30651;var x$30661;var t0$30670;var t1$30671;var t2$30672;var stmts$30668;var x$30695;var $30614$30640;var ph$30618;var body$30619;(ph$30618=$30604$30609);(t0$30624=$30606$30612);if(((t0$30624 instanceof Array)&&(((t1$30625=t0$30624.length)),((t1$30625===2)&&(t0$30624[0]==="data"))))){(body$30619=t0$30624[1]);}else{$36853($30606$30612);}($30614$30640=ph$30618);if((((x$30651=$30614$30640)),((x$30651 instanceof Array)&&(x$30651[0]==="clause")))){return ["block",body$30619];}else{if((((x$30661=$30614$30640)),((x$30661 instanceof Array)&&(x$30661[0]==="test")))){(t0$30670=$36872(["multi"])(body$30619));if((t0$30670[0]&&(((t1$30671=t0$30670[1])),(((t2$30672=t1$30671.length)),(t2$30672>=0))))){(stmts$30668=Array.prototype.slice.call(t1$30671,0));}else{$36853(body$30619,"/home/olivier/git/earl-grey/src/stdenv.eg",24013,24017);}return ["do",["splice"].concat(stmts$30668)];}else{if((((x$30695=$30614$30640)),((x$30695 instanceof Array)&&(x$30695[0]==="expr")))){return ["multi",body$30619];}else{$36853($30614$30640);}}}});}}())),$25314(((accum$30703=({})),(((t0$30705=$36872(expr_mac$25469)(function(scope$30714,form$30715,$30711$30716){var other$30952;var s1$30915;var b$30916;var a$30848;var b$30849;var a$30804;var $30726$30799;var $30727$30800;var $30728$30801;var t0$30784;var t1$30785;var t2$30786;var t3$30787;var t4$30788;var t5$30789;var t6$30790;var t7$30791;var t8$30792;var t9$30793;var t10$30794;var t11$30795;var t12$30796;var t13$30797;var test$30763;var $30721$30764;var test$30751;var a$30752;var b$30753;var $30729$30747;var $30730$30748;var t0$30742;var t1$30743;var t2$30744;var t3$30745;var $30718$30737;var ph$30731;(ph$30731=$30711$30716);($30718$30737=ph$30731);if((($30729$30747=($30718$30737 instanceof Array))&&(((t0$30742=$30718$30737.length)),((t0$30742===4)&&($30718$30737[0]==="data"))))){(test$30751=$30718$30737[1]);(a$30752=$30718$30737[2]);(b$30753=$30718$30737[3]);return ["if",test$30751,a$30752,b$30753];}else{if(($30729$30747&&((t0$30742===3)&&(($30718$30737[0]==="data")&&((test$30763=$30718$30737[1]),(((t1$30743=$36872(["multi"])($30718$30737[2]))),(t1$30743[0]&&(((t2$30744=t1$30743[1])),(((t3$30745=t2$30744.length)),(t3$30745>=0)))))))))){($30721$30764=Array.prototype.slice.call(t2$30744,0));(t0$30784=$30721$30764);if((($30727$30800=(t0$30784 instanceof Array))&&(((t1$30785=t0$30784.length)),((t1$30785===1)&&(((t2$30786=t0$30784[0])),((t2$30786 instanceof Array)&&(((t3$30787=t2$30786.length)),((t3$30787===3)&&((t2$30786[0]==="send")&&(((t4$30788=t2$30786[1])),((t4$30788 instanceof Array)&&(((t5$30789=t4$30788.length)),((t5$30789===2)&&((t4$30788[0]==="symbol")&&((t4$30788[1]==="then")&&(((t6$30790=t2$30786[2])),((t6$30790 instanceof Array)&&(((t7$30791=t6$30790.length)),((t7$30791===2)&&(t6$30790[0]==="data")))))))))))))))))))){(a$30804=t6$30790[1]);return ["if",test$30763,a$30804,["value",(void 0)]];}else{if(($30727$30800&&((t1$30785===2)&&(((t2$30786=t0$30784[0])),((t2$30786 instanceof Array)&&(((t3$30787=t2$30786.length)),((t3$30787===3)&&((t2$30786[0]==="send")&&(((t4$30788=t2$30786[1])),((t4$30788 instanceof Array)&&(((t5$30789=t4$30788.length)),((t5$30789===2)&&((t4$30788[0]==="symbol")&&((t4$30788[1]==="then")&&(((t6$30790=t2$30786[2])),((t6$30790 instanceof Array)&&(((t7$30791=t6$30790.length)),((t7$30791===2)&&((t6$30790[0]==="data")&&((a$30848=t6$30790[1]),(((t8$30792=t0$30784[1])),((t8$30792 instanceof Array)&&(((t9$30793=t8$30792.length)),((t9$30793===3)&&((t8$30792[0]==="send")&&(((t10$30794=t8$30792[1])),((t10$30794 instanceof Array)&&(((t11$30795=t10$30794.length)),((t11$30795===2)&&((t10$30794[0]==="symbol")&&((t10$30794[1]==="else")&&(((t12$30796=t8$30792[2])),((t12$30796 instanceof Array)&&(((t13$30797=t12$30796.length)),((t13$30797===2)&&(t12$30796[0]==="data")))))))))))))))))))))))))))))))))))){(b$30849=t12$30796[1]);return ["if",test$30763,a$30848,b$30849];}else{if(($30727$30800&&((t1$30785>=1)&&((s1$30915=Array.prototype.slice.call(t0$30784,0,-1)),(((t2$30786=t0$30784[(t1$30785-1)])),((t2$30786 instanceof Array)&&(((t3$30787=t2$30786.length)),((t3$30787===3)&&((t2$30786[0]==="send")&&(((t4$30788=t2$30786[1])),((t4$30788 instanceof Array)&&(((t5$30789=t4$30788.length)),((t5$30789===2)&&((t4$30788[0]==="symbol")&&((t4$30788[1]==="else")&&(((t6$30790=t2$30786[2])),((t6$30790 instanceof Array)&&(((t7$30791=t6$30790.length)),((t7$30791===2)&&(t6$30790[0]==="data")))))))))))))))))))){(b$30916=t6$30790[1]);return ["if",test$30763,["multi"].concat(s1$30915),b$30916];}else{(other$30952=$30721$30764);return ["if",test$30763,["multi"].concat(other$30952),["value",(void 0)]];}}}}else{$36853($30718$30737);}}}))),function(){if(t0$30705[0]){(accum$30703["if"]=t0$30705[1]);return accum$30703;}else{return $36853(function(scope$30962,form$30963,$30959$30964){var other$31200;var s1$31163;var b$31164;var a$31096;var b$31097;var a$31052;var $30974$31047;var $30975$31048;var $30976$31049;var t0$31032;var t1$31033;var t2$31034;var t3$31035;var t4$31036;var t5$31037;var t6$31038;var t7$31039;var t8$31040;var t9$31041;var t10$31042;var t11$31043;var t12$31044;var t13$31045;var test$31011;var $30969$31012;var test$30999;var a$31000;var b$31001;var $30977$30995;var $30978$30996;var t0$30990;var t1$30991;var t2$30992;var t3$30993;var $30966$30985;var ph$30979;(ph$30979=$30959$30964);($30966$30985=ph$30979);if((($30977$30995=($30966$30985 instanceof Array))&&(((t0$30990=$30966$30985.length)),((t0$30990===4)&&($30966$30985[0]==="data"))))){(test$30999=$30966$30985[1]);(a$31000=$30966$30985[2]);(b$31001=$30966$30985[3]);return ["if",test$30999,a$31000,b$31001];}else{if(($30977$30995&&((t0$30990===3)&&(($30966$30985[0]==="data")&&((test$31011=$30966$30985[1]),(((t1$30991=$36872(["multi"])($30966$30985[2]))),(t1$30991[0]&&(((t2$30992=t1$30991[1])),(((t3$30993=t2$30992.length)),(t3$30993>=0)))))))))){($30969$31012=Array.prototype.slice.call(t2$30992,0));(t0$31032=$30969$31012);if((($30975$31048=(t0$31032 instanceof Array))&&(((t1$31033=t0$31032.length)),((t1$31033===1)&&(((t2$31034=t0$31032[0])),((t2$31034 instanceof Array)&&(((t3$31035=t2$31034.length)),((t3$31035===3)&&((t2$31034[0]==="send")&&(((t4$31036=t2$31034[1])),((t4$31036 instanceof Array)&&(((t5$31037=t4$31036.length)),((t5$31037===2)&&((t4$31036[0]==="symbol")&&((t4$31036[1]==="then")&&(((t6$31038=t2$31034[2])),((t6$31038 instanceof Array)&&(((t7$31039=t6$31038.length)),((t7$31039===2)&&(t6$31038[0]==="data")))))))))))))))))))){(a$31052=t6$31038[1]);return ["if",test$31011,a$31052,["value",(void 0)]];}else{if(($30975$31048&&((t1$31033===2)&&(((t2$31034=t0$31032[0])),((t2$31034 instanceof Array)&&(((t3$31035=t2$31034.length)),((t3$31035===3)&&((t2$31034[0]==="send")&&(((t4$31036=t2$31034[1])),((t4$31036 instanceof Array)&&(((t5$31037=t4$31036.length)),((t5$31037===2)&&((t4$31036[0]==="symbol")&&((t4$31036[1]==="then")&&(((t6$31038=t2$31034[2])),((t6$31038 instanceof Array)&&(((t7$31039=t6$31038.length)),((t7$31039===2)&&((t6$31038[0]==="data")&&((a$31096=t6$31038[1]),(((t8$31040=t0$31032[1])),((t8$31040 instanceof Array)&&(((t9$31041=t8$31040.length)),((t9$31041===3)&&((t8$31040[0]==="send")&&(((t10$31042=t8$31040[1])),((t10$31042 instanceof Array)&&(((t11$31043=t10$31042.length)),((t11$31043===2)&&((t10$31042[0]==="symbol")&&((t10$31042[1]==="else")&&(((t12$31044=t8$31040[2])),((t12$31044 instanceof Array)&&(((t13$31045=t12$31044.length)),((t13$31045===2)&&(t12$31044[0]==="data")))))))))))))))))))))))))))))))))))){(b$31097=t12$31044[1]);return ["if",test$31011,a$31096,b$31097];}else{if(($30975$31048&&((t1$31033>=1)&&((s1$31163=Array.prototype.slice.call(t0$31032,0,-1)),(((t2$31034=t0$31032[(t1$31033-1)])),((t2$31034 instanceof Array)&&(((t3$31035=t2$31034.length)),((t3$31035===3)&&((t2$31034[0]==="send")&&(((t4$31036=t2$31034[1])),((t4$31036 instanceof Array)&&(((t5$31037=t4$31036.length)),((t5$31037===2)&&((t4$31036[0]==="symbol")&&((t4$31036[1]==="else")&&(((t6$31038=t2$31034[2])),((t6$31038 instanceof Array)&&(((t7$31039=t6$31038.length)),((t7$31039===2)&&(t6$31038[0]==="data")))))))))))))))))))){(b$31164=t6$31038[1]);return ["if",test$31011,["multi"].concat(s1$31163),b$31164];}else{(other$31200=$30969$31012);return ["if",test$31011,["multi"].concat(other$31200),["value",(void 0)]];}}}}else{$36853($30966$30985);}}});}}())),$25314(((accum$31205=({})),(((t0$31207=$36872(expr_mac$25469)(function(scope$31216,form$31217,$31213$31218){var t0$31227;var t0$31254;var t1$31255;var t2$31256;var t3$31257;var t4$31258;var t5$31259;var t6$31260;var t7$31261;var t8$31262;var t0$31310;var test$31346;var body$31347;var label$31247;var bridge$31222$31242;var t0$31243;var $31220$31237;var ph$31224;var env$31225;(t0$31227=$31213$31218);if($36545(t0$31227,"env")){(env$31225=t0$31227.env);(ph$31224=t0$31227);}else{$36853($31213$31218);}($31220$31237=ph$31224);(bridge$31222$31242=$31220$31237);if((((bridge$31222$31242 instanceof Array)&&(((t0$31254=bridge$31222$31242.length)),((t0$31254===3)&&((bridge$31222$31242[0]==="send")&&(((t1$31255=bridge$31222$31242[1])),((t1$31255 instanceof Array)&&(((t2$31256=t1$31255.length)),((t2$31256===2)&&((t1$31255[0]==="symbol")&&((t1$31255[1]===".")&&(((t3$31257=bridge$31222$31242[2])),((t3$31257 instanceof Array)&&(((t4$31258=t3$31257.length)),((t4$31258===3)&&((t3$31257[0]==="data")&&(((t5$31259=t3$31257[1])),((t5$31259 instanceof Array)&&(((t6$31260=t5$31259.length)),((t6$31260===1)&&((t5$31259[0]==="void")&&(((t7$31261=t3$31257[2])),((t7$31261 instanceof Array)&&(((t8$31262=t7$31261.length)),((t8$31262===2)&&((t7$31261[0]==="symbol")&&((label$31247=t7$31261[1]),true))))))))))))))))))))))))))||((bridge$31222$31242 instanceof Array)&&(((t0$31310=bridge$31222$31242.length)),((t0$31310===2)&&((bridge$31222$31242[0]==="value")&&((label$31247=bridge$31222$31242[1]),true))))))){return ["macro",function(context$31322,scope$31323,form$31324,$31319$31325){var t0$31330;var t1$31331;var test$31327;var body$31328;(t0$31330=$31319$31325);if(((t0$31330 instanceof Array)&&(((t1$31331=t0$31330.length)),((t1$31331===3)&&(t0$31330[0]==="data"))))){(test$31327=t0$31330[1]);(body$31328=t0$31330[2]);}else{$36853($31319$31325);}return setup_label$25472(label$31247,env$31225,["js_while",test$31327,body$31328]);}];}else{if((($31220$31237 instanceof Array)&&(((t0$31243=$31220$31237.length)),((t0$31243===3)&&($31220$31237[0]==="data"))))){(test$31346=$31220$31237[1]);(body$31347=$31220$31237[2]);return setup_label$25472(scope$31216.gensym(),env$31225,["js_while",test$31346,body$31347]);}else{$36853($31220$31237);}}}))),function(){if(t0$31207[0]){(accum$31205["while"]=t0$31207[1]);return accum$31205;}else{return $36853(function(scope$31363,form$31364,$31360$31365){var t0$31374;var t0$31401;var t1$31402;var t2$31403;var t3$31404;var t4$31405;var t5$31406;var t6$31407;var t7$31408;var t8$31409;var t0$31457;var test$31493;var body$31494;var label$31394;var bridge$31369$31389;var t0$31390;var $31367$31384;var ph$31371;var env$31372;(t0$31374=$31360$31365);if($36545(t0$31374,"env")){(env$31372=t0$31374.env);(ph$31371=t0$31374);}else{$36853($31360$31365);}($31367$31384=ph$31371);(bridge$31369$31389=$31367$31384);if((((bridge$31369$31389 instanceof Array)&&(((t0$31401=bridge$31369$31389.length)),((t0$31401===3)&&((bridge$31369$31389[0]==="send")&&(((t1$31402=bridge$31369$31389[1])),((t1$31402 instanceof Array)&&(((t2$31403=t1$31402.length)),((t2$31403===2)&&((t1$31402[0]==="symbol")&&((t1$31402[1]===".")&&(((t3$31404=bridge$31369$31389[2])),((t3$31404 instanceof Array)&&(((t4$31405=t3$31404.length)),((t4$31405===3)&&((t3$31404[0]==="data")&&(((t5$31406=t3$31404[1])),((t5$31406 instanceof Array)&&(((t6$31407=t5$31406.length)),((t6$31407===1)&&((t5$31406[0]==="void")&&(((t7$31408=t3$31404[2])),((t7$31408 instanceof Array)&&(((t8$31409=t7$31408.length)),((t8$31409===2)&&((t7$31408[0]==="symbol")&&((label$31394=t7$31408[1]),true))))))))))))))))))))))))))||((bridge$31369$31389 instanceof Array)&&(((t0$31457=bridge$31369$31389.length)),((t0$31457===2)&&((bridge$31369$31389[0]==="value")&&((label$31394=bridge$31369$31389[1]),true))))))){return ["macro",function(context$31469,scope$31470,form$31471,$31466$31472){var t0$31477;var t1$31478;var test$31474;var body$31475;(t0$31477=$31466$31472);if(((t0$31477 instanceof Array)&&(((t1$31478=t0$31477.length)),((t1$31478===3)&&(t0$31477[0]==="data"))))){(test$31474=t0$31477[1]);(body$31475=t0$31477[2]);}else{$36853($31466$31472);}return setup_label$25472(label$31394,env$31372,["js_while",test$31474,body$31475]);}];}else{if((($31367$31384 instanceof Array)&&(((t0$31390=$31367$31384.length)),((t0$31390===3)&&($31367$31384[0]==="data"))))){(test$31493=$31367$31384[1]);(body$31494=$31367$31384[2]);return setup_label$25472(scope$31363.gensym(),env$31372,["js_while",test$31493,body$31494]);}else{$36853($31367$31384);}}});}}())),$25314(((accum$31505=({})),((accum$31505["for"]=function(context$31512,scope$31513,form$31514,$31509$31515){var t0$31524;var t0$31629;var t1$31630;var t2$31631;var t3$31632;var t4$31633;var t5$31634;var t6$31635;var t7$31636;var t8$31637;var t0$31685;var spec$31721;var body$31722;var label$31622;var setup_for$31543;var bridge$31519$31538;var t0$31539;var $31517$31533;var ph$31521;var expr$31522;(t0$31524=$31509$31515);(expr$31522=t0$31524);(ph$31521=t0$31524);($31517$31533=ph$31521);(setup_for$31543=function(label$31550,env$31551,$31547$31552,body$31553){var a$31593;var b$31594;var a$31581;var b$31582;var c$31583;var $31558$31577;var $31559$31578;var t0$31571;var t1$31572;var t2$31573;var t3$31574;var t4$31575;var $31555$31566;var ph$31560;(ph$31560=$31547$31552);($31555$31566=ph$31560);if((($31558$31577=($31555$31566 instanceof Array))&&(((t0$31571=$31555$31566.length)),((t0$31571===4)&&($31555$31566[0]==="multi"))))){(a$31581=$31555$31566[1]);(b$31582=$31555$31566[2]);(c$31583=$31555$31566[3]);return ["multi",a$31581,setup_label$25472(label$31550,env$31551,["js_for",["multi"],b$31582,c$31583,body$31553])];}else{if(($31558$31577&&((t0$31571===3)&&(($31555$31566[0]==="send")&&(((t1$31572=$31555$31566[1])),((t1$31572 instanceof Array)&&(((t2$31573=t1$31572.length)),((t2$31573===2)&&((t1$31572[0]==="symbol")&&((t1$31572[1]==="in")&&(((t3$31574=$31555$31566[2])),((t3$31574 instanceof Array)&&(((t4$31575=t3$31574.length)),((t4$31575===3)&&(t3$31574[0]==="data"))))))))))))))){(a$31593=t3$31574[1]);(b$31594=t3$31574[2]);return ["multi",["declare",a$31593,["value",null]],setup_label$25472(label$31550,env$31551,["js_for_in",a$31593,b$31594,body$31553])];}else{$36853($31555$31566);}}});(bridge$31519$31538=$31517$31533);if((((bridge$31519$31538 instanceof Array)&&(((t0$31629=bridge$31519$31538.length)),((t0$31629===3)&&((bridge$31519$31538[0]==="send")&&(((t1$31630=bridge$31519$31538[1])),((t1$31630 instanceof Array)&&(((t2$31631=t1$31630.length)),((t2$31631===2)&&((t1$31630[0]==="symbol")&&((t1$31630[1]===".")&&(((t3$31632=bridge$31519$31538[2])),((t3$31632 instanceof Array)&&(((t4$31633=t3$31632.length)),((t4$31633===3)&&((t3$31632[0]==="data")&&(((t5$31634=t3$31632[1])),((t5$31634 instanceof Array)&&(((t6$31635=t5$31634.length)),((t6$31635===1)&&((t5$31634[0]==="void")&&(((t7$31636=t3$31632[2])),((t7$31636 instanceof Array)&&(((t8$31637=t7$31636.length)),((t8$31637===2)&&((t7$31636[0]==="symbol")&&((label$31622=t7$31636[1]),true))))))))))))))))))))))))))||((bridge$31519$31538 instanceof Array)&&(((t0$31685=bridge$31519$31538.length)),((t0$31685===2)&&((bridge$31519$31538[0]==="value")&&((label$31622=bridge$31519$31538[1]),true))))))){return ["macro",function(context$31697,scope$31698,form$31699,$31694$31700){var t0$31705;var t1$31706;var spec$31702;var body$31703;(t0$31705=$31694$31700);if(((t0$31705 instanceof Array)&&(((t1$31706=t0$31705.length)),((t1$31706===3)&&(t0$31705[0]==="data"))))){(spec$31702=t0$31705[1]);(body$31703=t0$31705[2]);}else{$36853($31694$31700);}return setup_for$31543(label$31622,expr$31522.env,spec$31702,body$31703);}];}else{if((($31517$31533 instanceof Array)&&(((t0$31539=$31517$31533.length)),((t0$31539===3)&&($31517$31533[0]==="data"))))){(spec$31721=$31517$31533[1]);(body$31722=$31517$31533[2]);return setup_for$31543(scope$31513.gensym(),form$31514.env,spec$31721,body$31722);}else{$36853($31517$31533);}}}),accum$31505)),$25314(((accum$31733=({})),((accum$31733["var"]=function($31737$31740,scope$31741,form$31742,argument$31743){var x$31749;if((((x$31749=$31737$31740)),((x$31749 instanceof Array)&&(x$31749[0]==="pattern")))){}else{$36853($31737$31740);}return ["mode","var",argument$31743];}),accum$31733)),$25314(((accum$31756=({})),((accum$31756["set"]=function($31760$31763,scope$31764,form$31765,argument$31766){var x$31772;if((((x$31772=$31760$31763)),((x$31772 instanceof Array)&&(x$31772[0]==="pattern")))){}else{$36853($31760$31763);}return ["mode","set",argument$31766];}),accum$31756)),$25314(((accum$31779=({})),((accum$31779["let"]=function($31783$31786,scope$31787,form$31788,argument$31789){var x$31811;var construct$31862;var bindings$31836;var body$31837;var t0$31829;var t1$31830;var t2$31831;var t3$31832;var $31820$31824;var other$31818;var $31791$31800;var ph$31794;(ph$31794=$31783$31786);($31791$31800=ph$31794);if((((x$31811=$31791$31800)),((x$31811 instanceof Array)&&(x$31811[0]==="pattern")))){return ["mode","let",argument$31789];}else{(other$31818=$31791$31800);($31820$31824=argument$31789);if((($31820$31824 instanceof Array)&&(((t0$31829=$31820$31824.length)),((t0$31829===3)&&(($31820$31824[0]==="data")&&(((t1$31830=$36872(["multi"])($31820$31824[1]))),(t1$31830[0]&&(((t2$31831=t1$31830[1])),(((t3$31832=t2$31831.length)),(t3$31832>=0)))))))))){(bindings$31836=Array.prototype.slice.call(t2$31831,0));(body$31837=$31820$31824[2]);(construct$31862=function($31866$31869){var bind$31908;var val$31909;var xs$31910;var $31874$31895;var $31875$31896;var t0$31887;var t1$31888;var t2$31889;var t3$31890;var t4$31891;var t5$31892;var t6$31893;var $31871$31882;var ph$31876;(ph$31876=$31866$31869);($31871$31882=ph$31876);if((($31874$31895=($31871$31882 instanceof Array))&&(((t0$31887=$31871$31882.length)),(t0$31887===0)))){return body$31837;}else{if(($31874$31895&&((t0$31887>=1)&&(((t1$31888=$31871$31882[0])),((t1$31888 instanceof Array)&&(((t2$31889=t1$31888.length)),((t2$31889===3)&&((t1$31888[0]==="send")&&(((t3$31890=t1$31888[1])),((t3$31890 instanceof Array)&&(((t4$31891=t3$31890.length)),((t4$31891===2)&&((t3$31890[0]==="symbol")&&((t3$31890[1]==="=")&&(((t5$31892=t1$31888[2])),((t5$31892 instanceof Array)&&(((t6$31893=t5$31892.length)),((t6$31893===3)&&(t5$31892[0]==="data"))))))))))))))))))){(bind$31908=t5$31892[1]);(val$31909=t5$31892[2]);(xs$31910=Array.prototype.slice.call($31871$31882,1));return $36439(["multi",["send",["symbol","="],["data",["send",["symbol","let"],bind$31908],val$31909]],construct$31862(xs$31910)],({"nonrecursive":true}));}else{$36853($31871$31882);}}});return construct$31862(bindings$31836);}else{$36853($31820$31824);}}}),accum$31779)),$25314(((accum$31949=({})),(((t0$31951=$36872(expr_mac$25469)(function(scope$31960,form$31961,$31957$31962){var t0$31967;var t1$31968;var t2$31969;var t3$31970;var t4$31971;var $index$32027;var $length$32021;var temp$32015;var acc$32009;var let_bindings$32001;var bindings$31964;var body$31965;(t0$31967=$31957$31962);if(((t0$31967 instanceof Array)&&(((t1$31968=t0$31967.length)),((t1$31968===3)&&((t0$31967[0]==="data")&&(((t2$31969=$36872(["multi"])(t0$31967[1]))),(t2$31969[0]&&(((t3$31970=t2$31969[1])),(((t4$31971=t3$31970.length)),(t4$31971>=0)))))))))){(bindings$31964=Array.prototype.slice.call(t3$31970,0));(body$31965=t0$31967[2]);}else{$36853($31957$31962);}(let_bindings$32001=(((acc$32009=[])),(((temp$32015=bindings$31964)),((($length$32021=temp$32015.length)),((($index$32027=0)),function(){$32004:for(;($index$32027<$length$32021);($index$32027++)){var b$32050;var v$32051;var t0$32041;var t1$32042;var t2$32043;var t3$32044;var t4$32045;var t5$32046;var m$32036;(m$32036=temp$32015[$index$32027]);(t0$32041=m$32036);if(((t0$32041 instanceof Array)&&(((t1$32042=t0$32041.length)),((t1$32042===3)&&((t0$32041[0]==="send")&&(((t2$32043=t0$32041[1])),((t2$32043 instanceof Array)&&(((t3$32044=t2$32043.length)),((t3$32044===2)&&((t2$32043[0]==="symbol")&&((t2$32043[1]==="=")&&(((t4$32045=t0$32041[2])),((t4$32045 instanceof Array)&&(((t5$32046=t4$32045.length)),((t5$32046===3)&&(t4$32045[0]==="data")))))))))))))))){(b$32050=t4$32045[1]);(v$32051=t4$32045[2]);acc$32009.push(["send",["symbol","="],["data",["send",["symbol","let"],b$32050],v$32051]]);}else{$36853(m$32036,"/home/olivier/git/earl-grey/src/stdenv.eg",26625,26672);}}}()))),acc$32009));return ["multi"].concat(let_bindings$32001).concat([body$31965]);}))),function(){if(t0$31951[0]){(accum$31949["letrec"]=t0$31951[1]);return accum$31949;}else{return $36853(function(scope$32093,form$32094,$32090$32095){var t0$32100;var t1$32101;var t2$32102;var t3$32103;var t4$32104;var $index$32160;var $length$32154;var temp$32148;var acc$32142;var let_bindings$32134;var bindings$32097;var body$32098;(t0$32100=$32090$32095);if(((t0$32100 instanceof Array)&&(((t1$32101=t0$32100.length)),((t1$32101===3)&&((t0$32100[0]==="data")&&(((t2$32102=$36872(["multi"])(t0$32100[1]))),(t2$32102[0]&&(((t3$32103=t2$32102[1])),(((t4$32104=t3$32103.length)),(t4$32104>=0)))))))))){(bindings$32097=Array.prototype.slice.call(t3$32103,0));(body$32098=t0$32100[2]);}else{$36853($32090$32095);}(let_bindings$32134=(((acc$32142=[])),(((temp$32148=bindings$32097)),((($length$32154=temp$32148.length)),((($index$32160=0)),function(){$32137:for(;($index$32160<$length$32154);($index$32160++)){var b$32183;var v$32184;var t0$32174;var t1$32175;var t2$32176;var t3$32177;var t4$32178;var t5$32179;var m$32169;(m$32169=temp$32148[$index$32160]);(t0$32174=m$32169);if(((t0$32174 instanceof Array)&&(((t1$32175=t0$32174.length)),((t1$32175===3)&&((t0$32174[0]==="send")&&(((t2$32176=t0$32174[1])),((t2$32176 instanceof Array)&&(((t3$32177=t2$32176.length)),((t3$32177===2)&&((t2$32176[0]==="symbol")&&((t2$32176[1]==="=")&&(((t4$32178=t0$32174[2])),((t4$32178 instanceof Array)&&(((t5$32179=t4$32178.length)),((t5$32179===3)&&(t4$32178[0]==="data")))))))))))))))){(b$32183=t4$32178[1]);(v$32184=t4$32178[2]);acc$32142.push(["send",["symbol","="],["data",["send",["symbol","let"],b$32183],v$32184]]);}else{$36853(m$32169,"/home/olivier/git/earl-grey/src/stdenv.eg",26625,26672);}}}()))),acc$32142));return ["multi"].concat(let_bindings$32134).concat([body$32098]);});}}())),$25314(((accum$32221=({})),((accum$32221["where"]=function(context$32228,scope$32229,form$32230,$32225$32231){var t0$32236;var t1$32237;var body$32233;var bindings$32234;(t0$32236=$32225$32231);if(((t0$32236 instanceof Array)&&(((t1$32237=t0$32236.length)),((t1$32237===3)&&(t0$32236[0]==="data"))))){(body$32233=t0$32236[1]);(bindings$32234=t0$32236[2]);}else{$36853($32225$32231);}return ["send",["symbol","letrec"],["data",bindings$32234,body$32233]];}),accum$32221)),$25314(({"break":break_mac$25473(null),"continue":continue_mac$25474(null)}),$25314(((accum$32251=({})),(((t0$32253=$36872(expr_mac$25469)(function(scope$32260,form$32261,arg$32262){return ["js_throw",arg$32262];}))),function(){if(t0$32253[0]){(accum$32251["throw"]=t0$32253[1]);return accum$32251;}else{return $36853(function(scope$32268,form$32269,arg$32270){return ["js_throw",arg$32270];});}}())),$25314(((accum$32273=({})),(((t0$32275=$36872(expr_mac$25469)(function(scope$32282,form$32283,arg$32284){return ["js_return",arg$32284];}))),function(){if(t0$32275[0]){(accum$32273["return"]=t0$32275[1]);return accum$32273;}else{return $36853(function(scope$32290,form$32291,arg$32292){return ["js_return",arg$32292];});}}())),$25314(((accum$32295=({})),(((t0$32297=$36872(expr_mac$25469)(function(scope$32304,form$32305,arg$32306){return ["js_new",arg$32306];}))),function(){if(t0$32297[0]){(accum$32295["new"]=t0$32297[1]);return accum$32295;}else{return $36853(function(scope$32312,form$32313,arg$32314){return ["js_new",arg$32314];});}}())),$25314(((accum$32317=({})),((accum$32317["delete"]=function(context$32324,scope$32325,form$32326,$32321$32327){var t0$32335;var other$32363;var s$32353;var t0$32349;var $32329$32344;var ph$32332;var arg$32333;(t0$32335=$32321$32327);(arg$32333=t0$32335);(ph$32332=t0$32335);($32329$32344=ph$32332);if((($32329$32344 instanceof Array)&&(((t0$32349=$32329$32344.length)),((t0$32349===2)&&($32329$32344[0]==="symbol"))))){(s$32353=$32329$32344[1]);return ["undeclare",arg$32333];}else{(other$32363=$32329$32344);return ["js_delete",other$32363];}}),accum$32317)),$25314(((accum$32366=({})),((accum$32366["splice"]=function(context$32373,scope$32374,form$32375,$32370$32376){var t0$32380;var t1$32381;var t2$32382;var t3$32383;var t4$32384;var stmts$32378;(t0$32380=$32370$32376);if(((t0$32380 instanceof Array)&&(((t1$32381=t0$32380.length)),((t1$32381===2)&&((t0$32380[0]==="data")&&(((t2$32382=$36872(["multi"])(t0$32380[1]))),(t2$32382[0]&&(((t3$32383=t2$32382[1])),(((t4$32384=t3$32383.length)),(t4$32384>=0)))))))))){(stmts$32378=Array.prototype.slice.call(t3$32383,0));}else{$36853($32370$32376);}return ["splice"].concat(stmts$32378);}),accum$32366)),$25314(((accum$32413=({})),((accum$32413["?"]=function(context$32420,scope$32421,form$32422,$32417$32423){var other$32533;var $32485$32498;var $32486$32499;var $32487$32500;var $32488$32501;var t0$32496;var $32477$32491;var checker$32474;var other$32669;var $32621$32634;var $32622$32635;var $32623$32636;var $32624$32637;var t0$32632;var $32613$32627;var x$32685;var other$32713;var t0$32700;var $32690$32695;var other$32717;var $32607$32674;var checker$32610;var chk$32601;var target$32602;var expr$32453;var $32428$32447;var $32429$32448;var $32430$32449;var $32431$32450;var t0$32443;var t1$32444;var t2$32445;var $32425$32438;var ph$32432;(ph$32432=$32417$32423);($32425$32438=ph$32432);if((($32428$32447=($32425$32438 instanceof Array))&&(((t0$32443=$32425$32438.length)),(($32430$32449=(t0$32443===3))&&(($32431$32450=($32425$32438[0]==="data"))&&((expr$32453=$32425$32438[1]),(((t1$32444=$32425$32438[2])),((t1$32444 instanceof Array)&&(((t2$32445=t1$32444.length)),((t2$32445===1)&&(t1$32444[0]==="void"))))))))))){(checker$32474=((($32477$32491=expr$32453)),function(){if((($32485$32498=($32477$32491 instanceof Array))&&(((t0$32496=$32477$32491.length)),(($32487$32500=(t0$32496===2))&&(($32488$32501=($32477$32491[0]==="symbol"))&&($32477$32491[1]==="String")))))){return checker_db$25456.String;}else{if(($32488$32501&&($32477$32491[1]==="Number"))){return checker_db$25456.Number;}else{if(($32488$32501&&($32477$32491[1]==="true"))){return checker_db$25456.true;}else{if(($32488$32501&&($32477$32491[1]==="false"))){return checker_db$25456.false;}else{if(($32488$32501&&($32477$32491[1]==="null"))){return checker_db$25456.null;}else{if(($32488$32501&&($32477$32491[1]==="undefined"))){return checker_db$25456.undefined;}else{(other$32533=$32477$32491);return ["send",["symbol","___checker"],["data",expr$32453]];}}}}}}}()));return ["macro",function($32537$32540,env$32541,form$32542,expr$32543){var x$32565;var other$32593;var t0$32580;var $32570$32575;var other$32597;var $32545$32554;var ph$32548;(ph$32548=$32537$32540);($32545$32554=ph$32548);if((((x$32565=$32545$32554)),((x$32565 instanceof Array)&&(x$32565[0]==="pattern")))){($32570$32575=expr$32543);if((($32570$32575 instanceof Array)&&(((t0$32580=$32570$32575.length)),((t0$32580===1)&&($32570$32575[0]==="void"))))){return ["check",checker$32474,["ignore"]];}else{(other$32593=$32570$32575);return ["check",checker$32474,expr$32543];}}else{(other$32597=$32545$32554);return ["send",checker$32474,["data",expr$32543]];}}];}else{if($32431$32450){(chk$32601=$32425$32438[1]);(target$32602=$32425$32438[2]);(checker$32610=((($32613$32627=chk$32601)),function(){if((($32621$32634=($32613$32627 instanceof Array))&&(((t0$32632=$32613$32627.length)),(($32623$32636=(t0$32632===2))&&(($32624$32637=($32613$32627[0]==="symbol"))&&($32613$32627[1]==="String")))))){return checker_db$25456.String;}else{if(($32624$32637&&($32613$32627[1]==="Number"))){return checker_db$25456.Number;}else{if(($32624$32637&&($32613$32627[1]==="true"))){return checker_db$25456.true;}else{if(($32624$32637&&($32613$32627[1]==="false"))){return checker_db$25456.false;}else{if(($32624$32637&&($32613$32627[1]==="null"))){return checker_db$25456.null;}else{if(($32624$32637&&($32613$32627[1]==="undefined"))){return checker_db$25456.undefined;}else{(other$32669=$32613$32627);return ["send",["symbol","___checker"],["data",chk$32601]];}}}}}}}()));($32607$32674=context$32420);if((((x$32685=$32607$32674)),((x$32685 instanceof Array)&&(x$32685[0]==="pattern")))){($32690$32695=target$32602);if((($32690$32695 instanceof Array)&&(((t0$32700=$32690$32695.length)),((t0$32700===1)&&($32690$32695[0]==="void"))))){return ["check",checker$32610,["ignore"]];}else{(other$32713=$32690$32695);return ["check",checker$32610,target$32602];}}else{(other$32717=$32607$32674);return ["send",checker$32610,["data",target$32602]];}}else{$36853($32425$32438);}}}),accum$32413)),$25314(((accum$32722=({})),((accum$32722["!"]=function(context$32729,scope$32730,form$32731,$32726$32732){var other$32830;var $32790$32803;var $32791$32804;var $32792$32805;var $32793$32806;var t0$32801;var $32786$32796;var projector$32783;var other$32954;var $32914$32927;var $32915$32928;var $32916$32929;var $32917$32930;var t0$32925;var $32910$32920;var x$32970;var other$32998;var t0$32985;var $32975$32980;var other$33002;var $32904$32959;var projector$32907;var prj$32898;var target$32899;var expr$32762;var $32737$32756;var $32738$32757;var $32739$32758;var $32740$32759;var t0$32752;var t1$32753;var t2$32754;var $32734$32747;var ph$32741;(ph$32741=$32726$32732);($32734$32747=ph$32741);if((($32737$32756=($32734$32747 instanceof Array))&&(((t0$32752=$32734$32747.length)),(($32739$32758=(t0$32752===3))&&(($32740$32759=($32734$32747[0]==="data"))&&((expr$32762=$32734$32747[1]),(((t1$32753=$32734$32747[2])),((t1$32753 instanceof Array)&&(((t2$32754=t1$32753.length)),((t2$32754===1)&&(t1$32753[0]==="void"))))))))))){(projector$32783=((($32786$32796=expr$32762)),function(){if((($32790$32803=($32786$32796 instanceof Array))&&(((t0$32801=$32786$32796.length)),(($32792$32805=(t0$32801===2))&&(($32793$32806=($32786$32796[0]==="symbol"))&&($32786$32796[1]==="String")))))){return mac1$25455(function(x$32818){return ["data",["symbol","true"],["send",["symbol","String"],["data",x$32818]]];});}else{if(($32793$32806&&($32786$32796[1]==="Number"))){return mac1$25455(function(x$32826){return ["data",["symbol","true"],["send",["symbol","parseFloat"],["data",x$32826]]];});}else{(other$32830=$32786$32796);return ["send",["symbol","___projector"],["data",expr$32762]];}}}()));return ["macro",function($32834$32837,env$32838,form$32839,expr$32840){var x$32862;var other$32890;var t0$32877;var $32867$32872;var other$32894;var $32842$32851;var ph$32845;(ph$32845=$32834$32837);($32842$32851=ph$32845);if((((x$32862=$32842$32851)),((x$32862 instanceof Array)&&(x$32862[0]==="pattern")))){($32867$32872=expr$32840);if((($32867$32872 instanceof Array)&&(((t0$32877=$32867$32872.length)),((t0$32877===1)&&($32867$32872[0]==="void"))))){return ["project",projector$32783,["ignore"]];}else{(other$32890=$32867$32872);return ["project",projector$32783,expr$32840];}}else{(other$32894=$32842$32851);return ["send",["send",projector$32783,["data",expr$32840]],["value",1]];}}];}else{if($32740$32759){(prj$32898=$32734$32747[1]);(target$32899=$32734$32747[2]);(projector$32907=((($32910$32920=prj$32898)),function(){if((($32914$32927=($32910$32920 instanceof Array))&&(((t0$32925=$32910$32920.length)),(($32916$32929=(t0$32925===2))&&(($32917$32930=($32910$32920[0]==="symbol"))&&($32910$32920[1]==="String")))))){return mac1$25455(function(x$32942){return ["data",["symbol","true"],["send",["symbol","String"],["data",x$32942]]];});}else{if(($32917$32930&&($32910$32920[1]==="Number"))){return mac1$25455(function(x$32950){return ["data",["symbol","true"],["send",["symbol","parseFloat"],["data",x$32950]]];});}else{(other$32954=$32910$32920);return ["send",["symbol","___projector"],["data",prj$32898]];}}}()));($32904$32959=context$32729);if((((x$32970=$32904$32959)),((x$32970 instanceof Array)&&(x$32970[0]==="pattern")))){($32975$32980=target$32899);if((($32975$32980 instanceof Array)&&(((t0$32985=$32975$32980.length)),((t0$32985===1)&&($32975$32980[0]==="void"))))){return ["project",projector$32907,["ignore"]];}else{(other$32998=$32975$32980);return ["project",projector$32907,target$32899];}}else{(other$33002=$32904$32959);return ["send",["send",projector$32907,["data",target$32899]],["value",1]];}}else{$36853($32734$32747);}}}),accum$32722)),$25314(((accum$33007=({})),((accum$33007["#"]=function(context$33014,scope$33015,form$33016,$33011$33017){var t0$33021;var t1$33022;var t2$33023;var t3$33024;var t4$33025;var t5$33026;var f$33066;var tag$33019;(t0$33021=$33011$33017);if(((t0$33021 instanceof Array)&&(((t1$33022=t0$33021.length)),((t1$33022===3)&&((t0$33021[0]==="data")&&(((t2$33023=t0$33021[1])),((t2$33023 instanceof Array)&&(((t3$33024=t2$33023.length)),((t3$33024===1)&&((t2$33023[0]==="void")&&(((t4$33025=t0$33021[2])),((t4$33025 instanceof Array)&&(((t5$33026=t4$33025.length)),((t5$33026===2)&&(t4$33025[0]==="symbol"))))))))))))))){(tag$33019=t4$33025[1]);}else{$36853($33011$33017);}(tag$33019=["value",tag$33019]);(f$33066=function($33070$33073,scope$33074,form$33075,expr$33076){var x$33098;var other$33167;var subp$33153;var $33109$33149;var $33110$33150;var t0$33147;var $33105$33142;var checker_mac$33111;var other$33205;var args$33200;var $33176$33187;var $33177$33188;var t0$33185;var $33172$33180;var $33078$33087;var ph$33081;(ph$33081=$33070$33073);($33078$33087=ph$33081);if((((x$33098=$33078$33087)),((x$33098 instanceof Array)&&(x$33098[0]==="pattern")))){(checker_mac$33111=["macro",function(context$33118,scope$33119,form$33120,$33115$33121){var t0$33125;var t1$33126;var expr$33123;(t0$33125=$33115$33121);if(((t0$33125 instanceof Array)&&(((t1$33126=t0$33125.length)),((t1$33126===2)&&(t0$33125[0]==="data"))))){(expr$33123=t0$33125[1]);}else{$36853($33115$33121);}return ["send",["symbol","let"],["data",["send",["symbol","="],["data",["symbol","x"],expr$33123]],["send",["symbol","and"],["data",["send",["symbol","instanceof"],["data",["symbol","x"],["symbol","Array"]]],["send",["symbol","==="],["data",["send",["symbol","x"],["value",0]],tag$33019]]]]]];}]);($33105$33142=expr$33076);if((($33109$33149=($33105$33142 instanceof Array))&&(((t0$33147=$33105$33142.length)),((t0$33147>=1)&&($33105$33142[0]==="data"))))){(subp$33153=Array.prototype.slice.call($33105$33142,1));return ["data",tag$33019].concat(subp$33153);}else{if(($33109$33149&&((t0$33147===1)&&($33105$33142[0]==="void")))){return ["check",checker_mac$33111,["ignore"]];}else{(other$33167=$33105$33142);return ["check",checker_mac$33111,expr$33076];}}}else{$33078$33087;($33172$33180=expr$33076);if((($33176$33187=($33172$33180 instanceof Array))&&(((t0$33185=$33172$33180.length)),((t0$33185===1)&&($33172$33180[0]==="void"))))){return ["data",tag$33019];}else{if(($33176$33187&&((t0$33185>=1)&&($33172$33180[0]==="data")))){(args$33200=Array.prototype.slice.call($33172$33180,1));return ["data",tag$33019].concat(args$33200);}else{(other$33205=$33172$33180);return ["send",["data",tag$33019],other$33205];}}}});return ["macro",f$33066];}),accum$33007)),$25314(((accum$33209=({})),((accum$33209["require"]=function(context$33216,scope$33217,form$33218,$33213$33219){var req$33257;var stmts$33258;var topfetch$33259;var produce$33260;var arg$33523;var expr$33244;var $33225$33240;var $33226$33241;var t0$33238;var $33221$33233;var ph$33227;(ph$33227=$33213$33219);($33221$33233=ph$33227);if((($33225$33240=($33221$33233 instanceof Array))&&(((t0$33238=$33221$33233.length)),((t0$33238===2)&&($33221$33233[0]==="data"))))){(expr$33244=$33221$33233[1]);(req$33257=["variable","require"]);(stmts$33258=[]);(topfetch$33259=function(pkg$33271,v$33272){stmts$33258.push(["send",["symbol","="],["data",v$33272,["send",req$33257,["data",pkg$33271]]]]);return v$33272;});(produce$33260=function($33279$33282,fetch$33283){var t0$33305;var t0$33366;var t0$33374;var $index$33401;var $length$33395;var temp$33389;var pkgv$33504;var pkg$33488;var subp$33489;var pkg$33462;var s$33463;var name$33422;var subp$33359;var s$33349;var s$33339;var $33293$33328;var $33294$33329;var $33295$33330;var $33296$33331;var $33297$33332;var $33298$33333;var $33299$33334;var $33300$33335;var $33301$33336;var t0$33319;var t1$33320;var bridge$33289$33321;var t2$33322;var t3$33323;var t4$33324;var t5$33325;var t6$33326;var $33285$33314;var ph$33302;var expr$33303;(t0$33305=$33279$33282);(expr$33303=t0$33305);(ph$33302=t0$33305);($33285$33314=ph$33302);if((($33293$33328=($33285$33314 instanceof Array))&&(((t0$33319=$33285$33314.length)),(($33295$33330=(t0$33319===2))&&($33285$33314[0]==="symbol"))))){(s$33339=$33285$33314[1]);return fetch$33283(["value",s$33339],expr$33303);}else{if(($33295$33330&&(($33285$33314[0]==="value")&&(((t1$33320=$33285$33314[1])),(typeof(t1$33320)==="string"))))){(s$33349=t1$33320);return fetch$33283(expr$33303,["symbol",scope$33217.gensym()]);}else{(bridge$33289$33321=$33285$33314);if((((bridge$33289$33321 instanceof Array)&&(((t0$33366=bridge$33289$33321.length)),((t0$33366>=1)&&((bridge$33289$33321[0]==="multi")&&((subp$33359=Array.prototype.slice.call(bridge$33289$33321,1)),true)))))||((bridge$33289$33321 instanceof Array)&&(((t0$33374=bridge$33289$33321.length)),((t0$33374>=1)&&((bridge$33289$33321[0]==="data")&&((subp$33359=Array.prototype.slice.call(bridge$33289$33321,1)),true))))))){(temp$33389=subp$33359);($length$33395=temp$33389.length);($index$33401=0);$33383:for(;($index$33401<$length$33395);($index$33401++)){var p$33418;var m$33410;(m$33410=temp$33389[$index$33401]);(p$33418=m$33410);produce$33260(p$33418,fetch$33283);}return null;}else{if((($33293$33328=($33285$33314 instanceof Array))&&(((t0$33319=$33285$33314.length)),(($33295$33330=(t0$33319===3))&&(($33296$33331=($33285$33314[0]==="send"))&&(((t1$33320=$33285$33314[1])),(($33298$33333=(t1$33320 instanceof Array))&&(((t2$33322=t1$33320.length)),(($33300$33335=(t2$33322===2))&&(($33301$33336=(t1$33320[0]==="symbol"))&&((t1$33320[1]==="^")&&(((t3$33323=$33285$33314[2])),((t3$33323 instanceof Array)&&(((t4$33324=t3$33323.length)),((t4$33324===3)&&((t3$33323[0]==="data")&&(((t5$33325=t3$33323[1])),((t5$33325 instanceof Array)&&(((t6$33326=t5$33325.length)),((t6$33326===1)&&(t5$33325[0]==="void"))))))))))))))))))))){(name$33422=t3$33323[2]);return fetch$33283(name$33422,["symbol",scope$33217.gensym()]);}else{if(($33301$33336&&((t1$33320[1]==="as")&&(((t3$33323=$33285$33314[2])),((t3$33323 instanceof Array)&&(((t4$33324=t3$33323.length)),((t4$33324===3)&&(t3$33323[0]==="data")))))))){(pkg$33462=t3$33323[1]);(s$33463=t3$33323[2]);return produce$33260(pkg$33462,function(the_pkg$33480,$33477$33481){$33477$33481;return fetch$33283(the_pkg$33480,s$33463);});}else{if(($33301$33336&&((t1$33320[1]==="->")&&(((t3$33323=$33285$33314[2])),((t3$33323 instanceof Array)&&(((t4$33324=t3$33323.length)),((t4$33324===3)&&(t3$33323[0]==="data")))))))){(pkg$33488=t3$33323[1]);(subp$33489=t3$33323[2]);(pkgv$33504=produce$33260(pkg$33488,fetch$33283));return produce$33260(subp$33489,function(pkg$33510,v$33511){stmts$33258.push(["send",["symbol","="],["data",v$33511,["send",pkgv$33504,pkg$33510]]]);return v$33511;});}else{$36853($33285$33314);}}}}}}});produce$33260(expr$33244,topfetch$33259);return ["splice"].concat(stmts$33258);}else{if(($33225$33240&&((t0$33238===1)&&($33221$33233[0]==="void")))){return ["variable","require"];}else{(arg$33523=$33221$33233);return ["send",["variable","require"],arg$33523];}}}),accum$33209)),$25314(((accum$33526=({})),((accum$33526["provide"]=function(context$33533,scope$33534,form$33535,$33530$33536){var t0$33540;var t1$33541;var t2$33542;var t3$33543;var t4$33544;var $index$33599;var $length$33593;var temp$33587;var acc$33581;var expr$33538;(t0$33540=$33530$33536);if(((t0$33540 instanceof Array)&&(((t1$33541=t0$33540.length)),((t1$33541===2)&&((t0$33540[0]==="data")&&(((t2$33542=$36872(["multi"])(t0$33540[1]))),(t2$33542[0]&&(((t3$33543=t2$33542[1])),(((t4$33544=t3$33543.length)),(t4$33544>=0)))))))))){(expr$33538=Array.prototype.slice.call(t3$33543,0));}else{$36853($33530$33536);}return ["sink",["multi"].concat((((acc$33581=[])),(((temp$33587=expr$33538)),((($length$33593=temp$33587.length)),((($index$33599=0)),function(){$33572:for(;($index$33599<$length$33593);($index$33599++)){var t0$33675;var t0$33683;var other$33694;var s$33640;var name$33641;var s$33624;var name$33625;var $33578$33621;var t0$33613;var t1$33614;var t2$33615;var t3$33616;var t4$33617;var t5$33618;var bridge$33576$33619;var m$33608;(m$33608=temp$33587[$index$33599]);(t0$33613=m$33608);(s$33624=t0$33613);if(((t0$33613 instanceof Array)&&(((t1$33614=t0$33613.length)),((t1$33614===2)&&(t0$33613[0]==="symbol"))))){(name$33625=t0$33613[1]);acc$33581.push(["send",["symbol","="],["data",["send",["symbol","exports"],["value",name$33625]],s$33624]]);}else{if(((t0$33613 instanceof Array)&&(((t1$33614=t0$33613.length)),((t1$33614===3)&&((t0$33613[0]==="send")&&(((t2$33615=t0$33613[1])),((t2$33615 instanceof Array)&&(((t3$33616=t2$33615.length)),((t3$33616===2)&&((t2$33615[0]==="symbol")&&((t2$33615[1]==="as")&&(((t4$33617=t0$33613[2])),((t4$33617 instanceof Array)&&(((t5$33618=t4$33617.length)),((t5$33618===3)&&((t4$33617[0]==="data")&&((s$33640=t4$33617[1]),(((bridge$33576$33619=t4$33617[2])),(((bridge$33576$33619 instanceof Array)&&(((t0$33675=bridge$33576$33619.length)),((t0$33675===2)&&((bridge$33576$33619[0]==="symbol")&&((name$33641=bridge$33576$33619[1]),true)))))||((bridge$33576$33619 instanceof Array)&&(((t0$33683=bridge$33576$33619.length)),((t0$33683===2)&&((bridge$33576$33619[0]==="value")&&((name$33641=bridge$33576$33619[1]),true)))))))))))))))))))))))){acc$33581.push(["send",["symbol","="],["data",["send",["symbol","exports"],["value",name$33641]],s$33640]]);}else{(other$33694=m$33608);acc$33581.push(function(){throw $36594(["syntax","provide"]).create("Each clause of provide must be 'sym' or 'sym as name'");}());}}}}()))),acc$33581))];}),accum$33526)),$25314(((accum$33698=({})),((accum$33698["class"]=function(context$33705,scope$33706,$33702$33707,expr$33708){var t0$33712;var name$34366;var name$34340;var super$34341;var t0$34333;var t1$34334;var t2$34335;var t3$34336;var stmts$34370;var stmts$34307;var $33724$34308;var $33728$34303;var $33729$34304;var t0$34298;var t1$34299;var t2$34300;var t3$34301;var $33722$34293;var helper$33730;var env$33710;(t0$33712=$33702$33707);if($36545(t0$33712,"env")){(env$33710=t0$33712.env);}else{$36853($33702$33707);}(helper$33730=function(name$33735,super$33736,stmts$33737){var $index$33792;var $length$33786;var temp$33780;var acc$33774;var t0$34211;var t1$34212;var t0$34235;var env2$34231;var it$34232;var cls$34233;var t0$34251;var t1$34252;var other$34288;var t0$34275;var $33747$34270;var statics$33750;var ctor$33751;var new_stmts$33752;var ctor_args$33753;var ctor_body$33754;var ctor_expr$33755;var name_str$33756;var node$33757;(statics$33750=["data",["symbol","="]]);(ctor$33751=[["data"],$36439(["multi"],({"env":env$33710}))]);(new_stmts$33752=(((acc$33774=[])),(((temp$33780=stmts$33737)),((($length$33786=temp$33780.length)),((($index$33792=0)),function(){$33766:for(;($index$33792<$length$33786);($index$33792++)){var t0$33877;var t1$33878;var t2$33879;var t3$33880;var t4$33881;var t5$33882;var t6$33883;var t7$33884;var t8$33885;var t0$33934;var t1$33935;var t2$33936;var t3$33937;var t4$33938;var t5$33939;var t6$33940;var t7$33941;var t8$33942;var t9$33943;var t10$33944;var t11$33945;var t12$33946;var accum$34062;var accum$34100;var accum$34108;var accum$34195;var lhs$34023;var rhs$34024;var args$33869;var body$33870;var methods$33819;var t0$33806;var t1$33807;var t2$33808;var t3$33809;var t4$33810;var t5$33811;var t6$33812;var t7$33813;var t8$33814;var bridge$33770$33815;var m$33801;(m$33801=temp$33780[$index$33792]);(t0$33806=m$33801);if(((t0$33806 instanceof Array)&&(((t1$33807=t0$33806.length)),((t1$33807===3)&&((t0$33806[0]==="send")&&(((t2$33808=t0$33806[1])),((t2$33808 instanceof Array)&&(((t3$33809=t2$33808.length)),((t3$33809===2)&&((t2$33808[0]==="symbol")&&((t2$33808[1]==="static")&&(((t4$33810=t0$33806[2])),((t4$33810 instanceof Array)&&(((t5$33811=t4$33810.length)),((t5$33811===2)&&((t4$33810[0]==="data")&&(((t6$33812=$36872(["multi"])(t4$33810[1]))),(t6$33812[0]&&(((t7$33813=t6$33812[1])),(((t8$33814=t7$33813.length)),(t8$33814>=0))))))))))))))))))))){(methods$33819=Array.prototype.slice.call(t7$33813,0));acc$33774.push((statics$33750=statics$33750.concat(methods$33819)));}else{(bridge$33770$33815=m$33801);if((((bridge$33770$33815 instanceof Array)&&(((t0$33877=bridge$33770$33815.length)),((t0$33877===3)&&((bridge$33770$33815[0]==="send")&&(((t1$33878=bridge$33770$33815[1])),((t1$33878 instanceof Array)&&(((t2$33879=t1$33878.length)),((t2$33879===2)&&((t1$33878[0]==="symbol")&&((t1$33878[1]==="=")&&(((t3$33880=bridge$33770$33815[2])),((t3$33880 instanceof Array)&&(((t4$33881=t3$33880.length)),((t4$33881===3)&&((t3$33880[0]==="data")&&(((t5$33882=t3$33880[1])),((t5$33882 instanceof Array)&&(((t6$33883=t5$33882.length)),((t6$33883===3)&&((t5$33882[0]==="send")&&(((t7$33884=t5$33882[1])),((t7$33884 instanceof Array)&&(((t8$33885=t7$33884.length)),((t8$33885===2)&&((t7$33884[0]==="symbol")&&((t7$33884[1]==="constructor")&&((args$33869=t5$33882[2]),((body$33870=t3$33880[2]),true))))))))))))))))))))))))))))||((bridge$33770$33815 instanceof Array)&&(((t0$33934=bridge$33770$33815.length)),((t0$33934===3)&&((bridge$33770$33815[0]==="send")&&(((t1$33935=bridge$33770$33815[1])),((t1$33935 instanceof Array)&&(((t2$33936=t1$33935.length)),((t2$33936===2)&&((t1$33935[0]==="symbol")&&((t1$33935[1]==="=")&&(((t3$33937=bridge$33770$33815[2])),((t3$33937 instanceof Array)&&(((t4$33938=t3$33937.length)),((t4$33938===3)&&((t3$33937[0]==="data")&&(((t5$33939=t3$33937[1])),((t5$33939 instanceof Array)&&(((t6$33940=t5$33939.length)),((t6$33940===2)&&((t5$33939[0]==="symbol")&&((t5$33939[1]==="constructor")&&(((t7$33941=t3$33937[2])),((t7$33941 instanceof Array)&&(((t8$33942=t7$33941.length)),((t8$33942===3)&&((t7$33941[0]==="send")&&(((t9$33943=t7$33941[1])),((t9$33943 instanceof Array)&&(((t10$33944=t9$33943.length)),((t10$33944===2)&&((t9$33943[0]==="symbol")&&((t9$33943[1]==="->")&&(((t11$33945=t7$33941[2])),((t11$33945 instanceof Array)&&(((t12$33946=t11$33945.length)),((t12$33946===3)&&((t11$33945[0]==="data")&&((args$33869=t11$33945[1]),((body$33870=t11$33945[2]),true))))))))))))))))))))))))))))))))))))))))){acc$33774.push((((ctor$33751=[args$33869,body$33870])),["splice"]));}else{(t0$33806=m$33801);if(((t0$33806 instanceof Array)&&(((t1$33807=t0$33806.length)),((t1$33807===3)&&((t0$33806[0]==="send")&&(((t2$33808=t0$33806[1])),((t2$33808 instanceof Array)&&(((t3$33809=t2$33808.length)),((t3$33809===2)&&((t2$33808[0]==="symbol")&&((t2$33808[1]==="=")&&(((t4$33810=t0$33806[2])),((t4$33810 instanceof Array)&&(((t5$33811=t4$33810.length)),((t5$33811===3)&&(t4$33810[0]==="data")))))))))))))))){(lhs$34023=t4$33810[1]);(rhs$34024=t4$33810[2]);acc$33774.push(parse_pattern$25448(scope$33706,lhs$34023,rhs$34024,$36439(pattern_handlers$25479.build_object,$25314(({"allow_nested":false}),$25314(((accum$34062=({})),((accum$34062["assign"]=function($34066$34070,value$34071){var t0$34082;var t0$34090;var bridge$34068$34075;var v$34073;(bridge$34068$34075=$34066$34070);if((((bridge$34068$34075 instanceof Array)&&(((t0$34082=bridge$34068$34075.length)),((t0$34082===2)&&((bridge$34068$34075[0]==="symbol")&&((v$34073=bridge$34068$34075[1]),true)))))||((bridge$34068$34075 instanceof Array)&&(((t0$34090=bridge$34068$34075.length)),((t0$34090===2)&&((bridge$34068$34075[0]==="value")&&((v$34073=bridge$34068$34075[1]),true))))))){}else{$36853($34066$34070);}return ["do",__lt____lt____colon__$25440(["assign",["send",["send",name$33735,["send",["symbol","."],["data",["void"],["symbol","prototype"]]]],["value",v$34073]],value$34071],v$34073)];}),accum$34062)),$25314(((accum$34100=({})),((accum$34100["declare"]=function(vars$34105){return [];}),accum$34100)),$25314(((accum$34108=({})),((accum$34108["wrap_target"]=function($34112$34115){var t0$34176;var other_env$34172;var it$34173;var it2$34174;var other$34192;var args$34139;var body$34140;var t0$34131;var t1$34132;var t2$34133;var t3$34134;var t4$34135;var $34117$34126;var ph$34120;(ph$34120=$34112$34115);($34117$34126=ph$34120);if((($34117$34126 instanceof Array)&&(((t0$34131=$34117$34126.length)),((t0$34131===3)&&(($34117$34126[0]==="send")&&(((t1$34132=$34117$34126[1])),((t1$34132 instanceof Array)&&(((t2$34133=t1$34132.length)),((t2$34133===2)&&((t1$34132[0]==="symbol")&&((t1$34132[1]==="->")&&(((t3$34134=$34117$34126[2])),((t3$34134 instanceof Array)&&(((t4$34135=t3$34134.length)),((t4$34135===3)&&(t3$34134[0]==="data")))))))))))))))){(args$34139=t3$34134[1]);(body$34140=t3$34134[2]);(t0$34176=body$34140);if($36545(t0$34176,"env")){(other_env$34172=t0$34176.env);}else{$36853(body$34140,"/home/olivier/git/earl-grey/src/stdenv.eg",33026,33030);}(it$34173=$36439(["symbol","@"],({"env":other_env$34172})));(it2$34174=$36439(["symbol","self"],({"env":other_env$34172})));return ["send",["symbol","_lambda"],["data",args$34139,["send",["symbol","splice"],["data",["multi",["send",["symbol","="],["data",["send",["symbol","let"],it$34173],["symbol","this"]]],["send",["symbol","="],["data",["send",["symbol","let"],it2$34174],["symbol","this"]]]]]],body$34140,["value",null]]];}else{(other$34192=$34117$34126);return other$34192;}}),accum$34108)),((accum$34195=({})),((accum$34195["success"]=function($34199$34202){$34199$34202;return ["splice"];}),accum$34195)))))))));}else{$36853(m$33801,"/home/olivier/git/earl-grey/src/stdenv.eg",32292,33538);}}}}}()))),acc$33774));(t0$34211=ctor$33751);if(((t0$34211 instanceof Array)&&(((t1$34212=t0$34211.length)),(t1$34212===2)))){(ctor_args$33753=t0$34211[0]);(ctor_body$33754=t0$34211[1]);}else{$36853(ctor$33751,"/home/olivier/git/earl-grey/src/stdenv.eg",33563,33567);}(ctor_expr$33755=((((t0$34235=ctor_body$33754)),function(){if($36545(t0$34235,"env")){(env2$34231=t0$34235.env);}else{return $36853(ctor_body$33754,"/home/olivier/git/earl-grey/src/stdenv.eg",33617,33626);}}()),((it$34232=$36439(["symbol","@"],({"env":env2$34231})))),((cls$34233=["send",["symbol","_lambda"],["data",ctor_args$33753,["send",["symbol","="],["data",it$34232,["send",["symbol","if"],["data",["send",["symbol","not"],["data",["void"],["send",["symbol","?"],["data",name$33735,["symbol","this"]]]]],["send",["send",["symbol","Object"],["send",["symbol","."],["data",["void"],["symbol","create"]]]],["data",["send",name$33735,["send",["symbol","."],["data",["void"],["symbol","prototype"]]]]]],["symbol","this"]]]]],ctor_body$33754,it$34232]])),function(){if(super$33736){return ["send",["symbol","___extend"],["data",cls$34233,super$33736]];}else{return cls$34233;}}()));(t0$34251=name$33735);if(((t0$34251 instanceof Array)&&(((t1$34252=t0$34251.length)),((t1$34252===2)&&(t0$34251[0]==="symbol"))))){(name_str$33756=t0$34251[1]);}else{$36853(name$33735,"/home/olivier/git/earl-grey/src/stdenv.eg",34286,34290);}statics$33750.push(["send",["symbol","="],["data",["value","::name"],["value",name_str$33756]]]);statics$33750.push(["send",["symbol","="],["data",["value","::egclass"],["symbol","true"]]]);(node$33757=["splice",["send",["symbol","="],["data",name$33735,ctor_expr$33755]]].concat(new_stmts$33752).concat([["send",["symbol","&:"],["data",name$33735,statics$33750]],name$33735]));($33747$34270=context$33705);if((($33747$34270 instanceof Array)&&(((t0$34275=$33747$34270.length)),((t0$34275===2)&&(($33747$34270[0]==="expr")&&($33747$34270[1]==="multi")))))){return node$33757;}else{(other$34288=$33747$34270);return ["multi",node$33757];}});($33722$34293=expr$33708);if((($33728$34303=($33722$34293 instanceof Array))&&(((t0$34298=$33722$34293.length)),((t0$34298===3)&&(($33722$34293[0]==="data")&&(($33724$34308=$33722$34293[1]),(((t1$34299=$36872(["multi"])($33722$34293[2]))),(t1$34299[0]&&(((t2$34300=t1$34299[1])),(((t3$34301=t2$34300.length)),(t3$34301>=0))))))))))){(stmts$34307=Array.prototype.slice.call(t2$34300,0));(t0$34333=$33724$34308);if(((t0$34333 instanceof Array)&&(((t1$34334=t0$34333.length)),((t1$34334===3)&&((t0$34333[0]==="send")&&((name$34340=t0$34333[1]),(((t2$34335=t0$34333[2])),((t2$34335 instanceof Array)&&(((t3$34336=t2$34335.length)),((t3$34336===2)&&(t2$34335[0]==="data"))))))))))){(super$34341=t2$34335[1]);return helper$33730(name$34340,super$34341,stmts$34307);}else{(name$34366=$33724$34308);return helper$33730(name$34366,null,stmts$34307);}}else{if(($33728$34303&&((t0$34298===2)&&(($33722$34293[0]==="data")&&(((t1$34299=$36872(["multi"])($33722$34293[1]))),(t1$34299[0]&&(((t2$34300=t1$34299[1])),(((t3$34301=t2$34300.length)),(t3$34301>=0))))))))){(stmts$34370=Array.prototype.slice.call(t2$34300,0));return helper$33730(["symbol",scope$33706.gensym()],null,stmts$34370);}else{$36853($33722$34293);}}}),accum$33698)),$25314(((accum$34391=({})),((accum$34391["%"]=function(context$34400,scope$34401,$34395$34402,$34397$34403){var t0$34409;var t0$34418;var t1$34419;var $index$34775;var $length$34769;var temp$34763;var xs$34750;var x$34914;var pair$34881;var k$34882;var v$34883;var args$34745;var $34717$34732;var $34718$34733;var t0$34726;var t1$34727;var t2$34728;var t3$34729;var t4$34730;var $34712$34721;var tags$34436;var kv$34437;var parse$34438;var env$34405;var descr$34406;var contents$34407;(t0$34409=$34395$34402);if($36545(t0$34409,"env")){(env$34405=t0$34409.env);}else{$36853($34395$34402);}(t0$34418=$34397$34403);if(((t0$34418 instanceof Array)&&(((t1$34419=t0$34418.length)),((t1$34419===3)&&(t0$34418[0]==="data"))))){(descr$34406=t0$34418[1]);(contents$34407=t0$34418[2]);}else{$36853($34397$34403);}(tags$34436=["data"]);(kv$34437=["data",["symbol","="]]);(parse$34438=function($34448$34451){var t0$34476;var t0$34573;var t0$34581;var t1$34582;var t0$34650;var t0$34658;var $index$34689;var $length$34683;var temp$34677;var acc$34671;var args$34643;var expr$34636;var rest$34637;var expr$34597;var x$34535;var x$34525;var s$34520;var $34464$34500;var $34465$34501;var $34466$34502;var $34467$34503;var $34468$34504;var $34469$34505;var $34470$34506;var $34471$34507;var $34472$34508;var t0$34490;var t1$34491;var t2$34492;var t3$34493;var t4$34494;var t5$34495;var t6$34496;var bridge$34458$34497;var bridge$34463$34498;var $34453$34485;var ph$34473;var whole$34474;(t0$34476=$34448$34451);(whole$34474=t0$34476);(ph$34473=t0$34476);($34453$34485=ph$34473);if((($34464$34500=($34453$34485 instanceof Array))&&(((t0$34490=$34453$34485.length)),((t0$34490===1)&&($34453$34485[0]==="void"))))){return null;}else{if(($34464$34500&&(($34466$34502=(t0$34490===2))&&($34453$34485[0]==="symbol")))){(s$34520=$34453$34485[1]);return tags$34436.push(["value",s$34520]);}else{if(($34466$34502&&(($34453$34485[0]==="value")&&(((t1$34491=[true,String($34453$34485[1])])),t1$34491[0])))){(x$34525=t1$34491[1]);return tags$34436.push(["value",x$34525]);}else{if(($34464$34500&&(($34466$34502=(t0$34490===3))&&(($34467$34503=($34453$34485[0]==="send"))&&(((t1$34491=$34453$34485[1])),(($34469$34505=(t1$34491 instanceof Array))&&(((t2$34492=t1$34491.length)),(($34471$34507=(t2$34492===2))&&(($34472$34508=(t1$34491[0]==="symbol"))&&((t1$34491[1]===".")&&(((t3$34493=$34453$34485[2])),((t3$34493 instanceof Array)&&(((t4$34494=t3$34493.length)),((t4$34494===3)&&((t3$34493[0]==="data")&&(((t5$34495=t3$34493[1])),((t5$34495 instanceof Array)&&(((t6$34496=t5$34495.length)),((t6$34496===1)&&((t5$34495[0]==="void")&&(((bridge$34458$34497=t3$34493[2])),(((bridge$34458$34497 instanceof Array)&&(((t0$34573=bridge$34458$34497.length)),((t0$34573===2)&&((bridge$34458$34497[0]==="symbol")&&((x$34535=bridge$34458$34497[1]),true)))))||((bridge$34458$34497 instanceof Array)&&(((t0$34581=bridge$34458$34497.length)),((t0$34581===2)&&((bridge$34458$34497[0]==="value")&&(((t1$34582=[true,String(bridge$34458$34497[1])])),(t1$34582[0]&&((x$34535=t1$34582[1]),true))))))))))))))))))))))))))))){return tags$34436.push(["value",("."+x$34535)]);}else{if(($34472$34508&&((t1$34491[1]==="^")&&(((t3$34493=$34453$34485[2])),((t3$34493 instanceof Array)&&(((t4$34494=t3$34493.length)),((t4$34494===3)&&((t3$34493[0]==="data")&&(((t5$34495=t3$34493[1])),((t5$34495 instanceof Array)&&(((t6$34496=t5$34495.length)),((t6$34496===1)&&(t5$34495[0]==="void"))))))))))))){(expr$34597=t3$34493[2]);return tags$34436.push(expr$34597);}else{if(($34472$34508&&((t1$34491[1]==="=")&&(((t3$34493=$34453$34485[2])),((t3$34493 instanceof Array)&&(((t4$34494=t3$34493.length)),((t4$34494===3)&&(t3$34493[0]==="data")))))))){t3$34493[1];t3$34493[2];return kv$34437.push(whole$34474);}else{if($34467$34503){(expr$34636=$34453$34485[1]);(rest$34637=$34453$34485[2]);parse$34438(expr$34636);return parse$34438(rest$34637);}else{(bridge$34463$34498=$34453$34485);if((((bridge$34463$34498 instanceof Array)&&(((t0$34650=bridge$34463$34498.length)),((t0$34650>=1)&&((bridge$34463$34498[0]==="multi")&&((args$34643=Array.prototype.slice.call(bridge$34463$34498,1)),true)))))||((bridge$34463$34498 instanceof Array)&&(((t0$34658=bridge$34463$34498.length)),((t0$34658>=1)&&((bridge$34463$34498[0]==="data")&&((args$34643=Array.prototype.slice.call(bridge$34463$34498,1)),true))))))){(acc$34671=[]);(temp$34677=args$34643);($length$34683=temp$34677.length);($index$34689=0);$34666:for(;($index$34689<$length$34683);($index$34689++)){var arg$34706;var m$34698;(m$34698=temp$34677[$index$34689]);(arg$34706=m$34698);acc$34671.push(parse$34438(arg$34706));}return acc$34671;}else{$36853($34453$34485);}}}}}}}}});parse$34438(descr$34406);(contents$34407=((($34712$34721=contents$34407)),function(){if((($34717$34732=($34712$34721 instanceof Array))&&(((t0$34726=$34712$34721.length)),((t0$34726===1)&&($34712$34721[0]==="void"))))){return ["array"];}else{if(($34717$34732&&((t0$34726>=1)&&($34712$34721[0]==="multi")))){(args$34745=Array.prototype.slice.call($34712$34721,1));(xs$34750=[]);(temp$34763=args$34745);($length$34769=temp$34763.length);($index$34775=0);$34751:for(;($index$34775<$length$34769);($index$34775++)){var other$34877;var spl$34837;var pair$34801;var k$34802;var v$34803;var $34756$34798;var t0$34789;var t1$34790;var t2$34791;var t3$34792;var t4$34793;var t5$34794;var t6$34795;var t7$34796;var m$34784;(m$34784=temp$34763[$index$34775]);(t0$34789=m$34784);(pair$34801=t0$34789);if(((t0$34789 instanceof Array)&&(((t1$34790=t0$34789.length)),((t1$34790===3)&&((t0$34789[0]==="send")&&(((t2$34791=t0$34789[1])),((t2$34791 instanceof Array)&&(((t3$34792=t2$34791.length)),((t3$34792===2)&&((t2$34791[0]==="symbol")&&((t2$34791[1]==="=")&&(((t4$34793=t0$34789[2])),((t4$34793 instanceof Array)&&(((t5$34794=t4$34793.length)),((t5$34794===3)&&(t4$34793[0]==="data")))))))))))))))){(k$34802=t4$34793[1]);(v$34803=t4$34793[2]);kv$34437.push(pair$34801);}else{(spl$34837=t0$34789);if(((t0$34789 instanceof Array)&&(((t1$34790=t0$34789.length)),((t1$34790===3)&&((t0$34789[0]==="send")&&(((t2$34791=t0$34789[1])),((t2$34791 instanceof Array)&&(((t3$34792=t2$34791.length)),((t3$34792===2)&&((t2$34791[0]==="symbol")&&((t2$34791[1]==="**")&&(((t4$34793=t0$34789[2])),((t4$34793 instanceof Array)&&(((t5$34794=t4$34793.length)),((t5$34794===3)&&((t4$34793[0]==="data")&&(((t6$34795=t4$34793[1])),((t6$34795 instanceof Array)&&(((t7$34796=t6$34795.length)),((t7$34796===1)&&(t6$34795[0]==="void"))))))))))))))))))))){t4$34793[2];kv$34437.push(spl$34837);}else{(other$34877=m$34784);xs$34750.push(other$34877);}}}return ["array"].concat(xs$34750);}else{(pair$34881=$34712$34721);if((($34712$34721 instanceof Array)&&(((t0$34726=$34712$34721.length)),((t0$34726===3)&&(($34712$34721[0]==="send")&&(((t1$34727=$34712$34721[1])),((t1$34727 instanceof Array)&&(((t2$34728=t1$34727.length)),((t2$34728===2)&&((t1$34727[0]==="symbol")&&((t1$34727[1]==="=")&&(((t3$34729=$34712$34721[2])),((t3$34729 instanceof Array)&&(((t4$34730=t3$34729.length)),((t4$34730===3)&&(t3$34729[0]==="data")))))))))))))))){(k$34882=t3$34729[1]);(v$34883=t3$34729[2]);kv$34437.push(pair$34881);return ["array"];}else{(x$34914=$34712$34721);return x$34914;}}}}()));return ["send",["symbol","Node"],["data",tags$34436,kv$34437,contents$34407]];}),accum$34391)),((accum$34917=({})),((accum$34917["globals"]=function(context$34924,scope$34925,form$34926,$34921$34927){var t0$34931;var t1$34932;var t2$34933;var t3$34934;var t4$34935;var $index$34987;var $length$34981;var temp$34975;var acc$34969;var vars$34929;(t0$34931=$34921$34927);if(((t0$34931 instanceof Array)&&(((t1$34932=t0$34931.length)),((t1$34932===2)&&((t0$34931[0]==="data")&&(((t2$34933=$36872(["multi"])(t0$34931[1]))),(t2$34933[0]&&(((t3$34934=t2$34933[1])),(((t4$34935=t3$34934.length)),(t4$34935>=0)))))))))){(vars$34929=Array.prototype.slice.call(t3$34934,0));}else{$36853($34921$34927);}return ["splice"].concat((((acc$34969=[])),(((temp$34975=vars$34929)),((($length$34981=temp$34975.length)),((($index$34987=0)),function(){$34964:for(;($index$34987<$length$34981);($index$34987++)){var variable$35006;var s$35007;var t0$35001;var t1$35002;var m$34996;(m$34996=temp$34975[$index$34987]);(t0$35001=m$34996);(variable$35006=t0$35001);if(((t0$35001 instanceof Array)&&(((t1$35002=t0$35001.length)),((t1$35002===2)&&(t0$35001[0]==="symbol"))))){(s$35007=t0$35001[1]);acc$34969.push(["declare_raw",variable$35006,["variable",s$35007]]);}else{$36853(m$34996,"/home/olivier/git/earl-grey/src/stdenv.eg",37331,37418);}}}()))),acc$34969));}),accum$34917))))))))))))))))))))))))))))))))))))))))))))))))))))));($length$35025=temp$27036.length);($index$35031=0);$25494:for(;($index$35031<$length$35025);($index$35031++)){var k$35050;var v$35051;var t0$35045;var t1$35046;var m$35040;(m$35040=temp$27036[$index$35031]);(t0$35045=m$35040);if(((t0$35045 instanceof Array)&&(((t1$35046=t0$35045.length)),(t1$35046===2)))){(k$35050=t0$35045[0]);(v$35051=t0$35045[1]);stdenv$25460.bind(topscope$25464,k$35050,["macro",v$35051]);}else{$36853(m$35040,"/home/olivier/git/earl-grey/src/stdenv.eg",8445,8511);}}(blocktest_wrap$25483=function(expr$35069){return ["multi",["send",["symbol","="],["data",["symbol","value"],["send",["symbol","!!"],["data",["multi",["send",["symbol","match"],["data",expr$35069,["multi",["send",["symbol","->"],["data",["send",["symbol","?"],["data",["symbol","true"],["symbol","x"]]],["send",["send",["symbol","#"],["data",["void"],["symbol","success"]]],["data",["symbol","x"]]]]],["send",["symbol","->"],["data",["send",["symbol","?"],["data",["symbol","false"],["symbol","x"]]],["send",["send",["symbol","#"],["data",["void"],["symbol","failure"]]],["data",["symbol","x"]]]]]]]]],["send",["symbol","->"],["data",["symbol","e"],["send",["send",["symbol","#"],["data",["void"],["symbol","error"]]],["data",["symbol","e"]]]]]]]]],["send",["send",["symbol","acc"],["send",["symbol","."],["data",["void"],["symbol","push"]]]],["data",["send",["send",["symbol","#"],["data",["void"],["symbol","test_result"]]],["data",["symbol","label"],["symbol","value"]]]]]];});(blocktest_mac$25484=function(scope$35076,tests$35077){var $index$35124;var $length$35118;var temp$35112;var acc$35106;var exptests$35083;var n$35084;var stmts$35085;(exptests$35083=$36827(scope$35076.step_all(["test"],tests$35077)));(n$35084=exptests$35083.length);(stmts$35085=(((acc$35106=[])),(((temp$35112=exptests$35083)),((($length$35118=temp$35112.length)),((($index$35124=0)),function(){$35094:for(;($index$35124<$length$35118);($index$35124++)){var wrap$35218;var fall$35219;var lbl$35244;var i$35237;var expr$35238;var i$35195;var elements$35196;var clauses$35197;var env$35198;var i$35176;var more_labels$35177;var more_tests$35178;var i$35149;var stmt$35150;var $35100$35143;var $35101$35144;var $35102$35145;var $35103$35146;var t0$35138;var t1$35139;var t2$35140;var t3$35141;var m$35133;(m$35133=temp$35112[$index$35124]);(t0$35138=m$35133);if((($35101$35144=(t0$35138 instanceof Array))&&(((t1$35139=t0$35138.length)),(($35103$35146=(t1$35139===2))&&((i$35149=t0$35138[0]),(((t2$35140=t0$35138[1])),((t2$35140 instanceof Array)&&(((t3$35141=t2$35140.length)),((t3$35141===2)&&(t2$35140[0]==="do")))))))))){(stmt$35150=t2$35140[1]);acc$35106.push(stmt$35150);}else{if(($35103$35146&&((i$35176=t0$35138[0]),(((t2$35140=t0$35138[1])),((t2$35140 instanceof Array)&&(((t3$35141=t2$35140.length)),((t3$35141===3)&&(t2$35140[0]==="blocktest")))))))){(more_labels$35177=t2$35140[1]);(more_tests$35178=t2$35140[2]);acc$35106.push(["send",["symbol","let"],["data",["send",["symbol","="],["data",["symbol","label"],["send",["send",["symbol","label"],["send",["symbol","."],["data",["void"],["symbol","concat"]]]],["data",["send",["symbol","!"],["data",["symbol","Array"],more_labels$35177]]]]]],["send",["symbol","="],["data",["send",["symbol","set"],["symbol","acc"]],["send",["send",["symbol","acc"],["send",["symbol","."],["data",["void"],["symbol","concat"]]]],["data",blocktest_mac$25484(scope$35076,more_tests$35178)]]]]]]);}else{if(($35103$35146&&((i$35195=t0$35138[0]),(((t2$35140=t0$35138[1])),((t2$35140 instanceof Array)&&(((t3$35141=t2$35140.length)),((t3$35141===3)&&((t2$35140[0]==="test_factory")&&((elements$35196=t2$35140[1]),((clauses$35197=t2$35140[2]),$36545(t2$35140,"env"))))))))))){(env$35198=t2$35140.env);acc$35106.push((((wrap$35218=function(expr$35224,index$35225){return ["send",["symbol","let"],["data",["send",["symbol","="],["data",["symbol","label"],["send",["send",["symbol","label"],["send",["symbol","."],["data",["void"],["symbol","concat"]]]],["data",["data",index$35225]]]]],blocktest_wrap$25483(expr$35224)]];})),((fall$35219=function(target$35232){return match_error$25467(target$35232);})),build_loop$25480(scope$35076,env$35198,["void"],elements$35196,clauses$35197,wrap$35218,["splice"],["splice"],({"fallback":fall$35219}))));}else{if($35103$35146){(i$35237=t0$35138[0]);(expr$35238=t0$35138[1]);acc$35106.push((((lbl$35244=function(){if((n$35084===1)){return ["data"];}else{return ["data",["value",i$35237]];}}())),["send",["symbol","let"],["data",["send",["symbol","="],["data",["symbol","label"],["send",["send",["symbol","label"],["send",["symbol","."],["data",["void"],["symbol","concat"]]]],["data",lbl$35244]]]],blocktest_wrap$25483(expr$35238)]]));}else{$36853(m$35133,"/home/olivier/git/earl-grey/src/stdenv.eg",37755,38564);}}}}}}()))),acc$35106));return ["send",["symbol","let"],["data",["send",["symbol","="],["data",["send",["symbol","var"],["symbol","acc"]],["data"]]],["send",["symbol","!!"],["data",["multi"].concat(stmts$35085).concat([["symbol","acc"]]),["send",["symbol","->"],["data",["symbol","e"],["send",["send",["symbol","acc"],["send",["symbol","."],["data",["void"],["symbol","concat"]]]],["data",["data",["send",["send",["symbol","#"],["data",["void"],["symbol","error"]]],["data",["symbol","label"],["symbol","e"]]]]]]]]]]]];});stdenv$25460.bind(topscope$25464,"blocktest",["macro",function(context$35256,scope$35257,form$35258,$35253$35259){var t0$35268;var t1$35269;var labels$35323;var tests$35324;var tests$35298;var $35264$35294;var $35265$35295;var t0$35289;var t1$35290;var t2$35291;var t3$35292;var $35261$35284;var args$35266;(t0$35268=$35253$35259);if(((t0$35268 instanceof Array)&&(((t1$35269=t0$35268.length)),((t1$35269>=1)&&(t0$35268[0]==="data"))))){(args$35266=Array.prototype.slice.call(t0$35268,1));}else{$36853($35253$35259);}($35261$35284=args$35266);if((($35264$35294=($35261$35284 instanceof Array))&&(((t0$35289=$35261$35284.length)),((t0$35289===1)&&(((t1$35290=$36872(["multi"])($35261$35284[0]))),(t1$35290[0]&&(((t2$35291=t1$35290[1])),(((t3$35292=t2$35291.length)),(t3$35292>=0))))))))){(tests$35298=Array.prototype.slice.call(t2$35291,0));return ["multi",["send",["symbol","="],["data",["symbol","label"],["data"]]],blocktest_mac$25484(scope$35257,tests$35298)];}else{if(($35264$35294&&((t0$35289===2)&&((labels$35323=$35261$35284[0]),(((t1$35290=$36872(["multi"])($35261$35284[1]))),(t1$35290[0]&&(((t2$35291=t1$35290[1])),(((t3$35292=t2$35291.length)),(t3$35292>=0))))))))){(tests$35324=Array.prototype.slice.call(t2$35291,0));return ["multi",["send",["symbol","="],["data",["symbol","label"],["send",["symbol","!"],["data",["symbol","Array"],labels$35323]]]],blocktest_mac$25484(scope$35257,tests$35324)];}else{$36853($35261$35284);}}}]);(qqstruct$25485=function(name$35349,args$35350){return ["data",["value",name$35349]].concat(args$35350);});(qq$25486=function($35356$35359){var t0$35381;var $index$35545;var $length$35539;var temp$35533;var acc$35527;var name$35518;var args$35519;var insert$35493;var insert$35468;var insert$35433;var v$35428;var s$35414;var $35369$35403;var $35370$35404;var $35371$35405;var $35372$35406;var $35373$35407;var $35374$35408;var $35375$35409;var $35376$35410;var $35377$35411;var t0$35395;var t1$35396;var t2$35397;var t3$35398;var t4$35399;var t5$35400;var t6$35401;var $35361$35390;var ph$35378;var expr$35379;(t0$35381=$35356$35359);(expr$35379=t0$35381);(ph$35378=t0$35381);($35361$35390=ph$35378);if((($35369$35403=($35361$35390 instanceof Array))&&(((t0$35395=$35361$35390.length)),((t0$35395===2)&&($35361$35390[0]==="symbol"))))){(s$35414=$35361$35390[1]);return qqstruct$25485("symbol",[["value",s$35414]]);}else{if(($35369$35403&&((t0$35395===1)&&($35361$35390[0]==="void")))){return qqstruct$25485("void",[]);}else{if(($35369$35403&&((t0$35395===2)&&($35361$35390[0]==="value")))){(v$35428=$35361$35390[1]);return qqstruct$25485("value",[expr$35379]);}else{if(($35369$35403&&(($35371$35405=(t0$35395===3))&&(($35372$35406=($35361$35390[0]==="send"))&&(((t1$35396=$35361$35390[1])),(($35374$35408=(t1$35396 instanceof Array))&&(((t2$35397=t1$35396.length)),(($35376$35410=(t2$35397===2))&&(($35377$35411=(t1$35396[0]==="symbol"))&&((t1$35396[1]==="^")&&(((t3$35398=$35361$35390[2])),((t3$35398 instanceof Array)&&(((t4$35399=t3$35398.length)),((t4$35399===3)&&((t3$35398[0]==="data")&&(((t5$35400=t3$35398[1])),((t5$35400 instanceof Array)&&(((t6$35401=t5$35400.length)),((t6$35401===1)&&(t5$35400[0]==="void")))))))))))))))))))){(insert$35433=t3$35398[2]);return insert$35433;}else{if(($35377$35411&&((t1$35396[1]==="^=")&&(((t3$35398=$35361$35390[2])),((t3$35398 instanceof Array)&&(((t4$35399=t3$35398.length)),((t4$35399===3)&&((t3$35398[0]==="data")&&(((t5$35400=t3$35398[1])),((t5$35400 instanceof Array)&&(((t6$35401=t5$35400.length)),((t6$35401===1)&&(t5$35400[0]==="void"))))))))))))){(insert$35468=t3$35398[2]);return qqstruct$25485("value",[insert$35468]);}else{if(($35377$35411&&((t1$35396[1]==="^*")&&(((t3$35398=$35361$35390[2])),((t3$35398 instanceof Array)&&(((t4$35399=t3$35398.length)),((t4$35399===3)&&((t3$35398[0]==="data")&&(((t5$35400=t3$35398[1])),((t5$35400 instanceof Array)&&(((t6$35401=t5$35400.length)),((t6$35401===1)&&(t5$35400[0]==="void"))))))))))))){(insert$35493=t3$35398[2]);return ["send",["symbol","*"],["data",["void"],insert$35493]];}else{if(($35369$35403&&(t0$35395>=1))){(name$35518=$35361$35390[0]);(args$35519=Array.prototype.slice.call($35361$35390,1));return qqstruct$25485(name$35518,(((acc$35527=[])),(((temp$35533=args$35519)),((($length$35539=temp$35533.length)),((($index$35545=0)),function(){$35522:for(;($index$35545<$length$35539);($index$35545++)){var arg$35562;var m$35554;(m$35554=temp$35533[$index$35545]);(arg$35562=m$35554);acc$35527.push(qq$25486(arg$35562));}}()))),acc$35527));}else{$36853($35361$35390);}}}}}}}});stdenv$25460.bind(topscope$25464,"'",["macro",function(context$35572,scope$35573,form$35574,$35569$35575){var t0$35579;var t1$35580;var t2$35581;var t3$35582;var expr$35577;(t0$35579=$35569$35575);if(((t0$35579 instanceof Array)&&(((t1$35580=t0$35579.length)),((t1$35580===3)&&((t0$35579[0]==="data")&&(((t2$35581=t0$35579[1])),((t2$35581 instanceof Array)&&(((t3$35582=t2$35581.length)),((t3$35582===1)&&(t2$35581[0]==="void")))))))))){(expr$35577=t0$35579[2]);}else{$36853($35569$35575);}return qq$25486(expr$35577);}]);(RegexBuilder$25487=function(){var it$0$35611;(it$0$35611=function(){if((!$25294(RegexBuilder$25487)(this))){return Object.create(RegexBuilder$25487.prototype);}else{return this;}}());return it$0$35611;});(RegexBuilder$25487.prototype["wrap"]=function(x$35623){var it$0$35627;var self$35628;(it$0$35627=this);(self$35628=this);return (("(?:"+x$35623)+")");});(RegexBuilder$25487.prototype["quote"]=function(x$35640){var it$0$35644;var self$35645;(it$0$35644=this);(self$35645=this);return x$35640.replace(RegExp("([.?*+\\^$\\[\\]\\(\\)\\{\\}|\\\\])","g"),"\\$1");});(RegexBuilder$25487.prototype["quote_charset"]=function(x$35657){var it$0$35661;var self$35662;(it$0$35661=this);(self$35662=this);return x$35657.replace(RegExp("([\\[\\]\\(\\)\\{\\}\\^])","g"),"\\$1");});(RegexBuilder$25487.prototype["build"]=function(expr$35674){var t0$35879;var t1$35880;var t0$35900;var t1$35901;var t0$35921;var t1$35922;var t0$35944;var t1$35945;var t0$35959;var t1$35960;var x$35975;var v$35942;var t0$35988;var t1$35989;var t0$36003;var t1$36004;var t2$36005;var t3$36006;var t4$36007;var t5$36008;var t6$36009;var t7$36010;var t8$36011;var t9$36012;var x$36067;var v$35986;var $index$36113;var $length$36107;var temp$36101;var acc$36095;var $index$36173;var $length$36167;var temp$36161;var acc$36155;var other$36195;var args$36135;var args$36075;var a$35846;var b$35847;var $35706$35848;var s$35821;var x$35816;var $35689$35750;var $35717$35739;var $35718$35740;var $35719$35741;var $35720$35742;var $35721$35743;var $35722$35744;var $35723$35745;var $35724$35746;var $35725$35747;var t0$35733;var t1$35734;var t2$35735;var t3$35736;var t4$35737;var $35687$35728;var it$0$35678;var self$35679;(it$0$35678=this);(self$35679=this);($35687$35728=expr$35674);if((($35717$35739=($35687$35728 instanceof Array))&&(((t0$35733=$35687$35728.length)),(($35719$35741=(t0$35733===2))&&($35687$35728[0]==="symbol"))))){($35689$35750=$35687$35728[1]);if(($35689$35750==="any")){return ".";}else{if(($35689$35750==="start")){return "^";}else{if(($35689$35750==="end")){return "$";}else{if(($35689$35750==="alpha")){return "\\a";}else{if(($35689$35750==="digit")){return "\\d";}else{if(($35689$35750==="word")){return "\\w";}else{if(($35689$35750==="space")){return "\\s";}else{if(($35689$35750==="boundary")){return "\\b";}else{if(($35689$35750==="a")){return "\\a";}else{if(($35689$35750==="d")){return "\\d";}else{if(($35689$35750==="w")){return "\\w";}else{if(($35689$35750==="s")){return "\\s";}else{if(($35689$35750==="b")){return "\\b";}else{$36853($35689$35750,"/home/olivier/git/earl-grey/src/stdenv.eg",39862,39867);}}}}}}}}}}}}}}else{if(($35719$35741&&($35687$35728[0]==="value"))){(x$35816=$35687$35728[1]);return it$0$35678.quote(x$35816);}else{if(($35717$35739&&(($35719$35741=(t0$35733===3))&&(($35720$35742=($35687$35728[0]==="send"))&&(((t1$35734=$35687$35728[1])),(($35722$35744=(t1$35734 instanceof Array))&&(((t2$35735=t1$35734.length)),(($35724$35746=(t2$35735===2))&&(($35725$35747=(t1$35734[0]==="symbol"))&&((t1$35734[1]==="raw")&&(((t3$35736=$35687$35728[2])),((t3$35736 instanceof Array)&&(((t4$35737=t3$35736.length)),((t4$35737===2)&&(t3$35736[0]==="value"))))))))))))))){(s$35821=t3$35736[1]);return s$35821;}else{if(($35725$35747&&(($35706$35848=t1$35734[1]),(((t3$35736=$35687$35728[2])),((t3$35736 instanceof Array)&&(((t4$35737=t3$35736.length)),((t4$35737===3)&&(t3$35736[0]==="data")))))))){(a$35846=t3$35736[1]);(b$35847=t3$35736[2]);if(($35706$35848==="||")){return it$0$35678.wrap(((it$0$35678.build(a$35846)+"|")+it$0$35678.build(b$35847)));}else{if(($35706$35848==="or")){return it$0$35678.wrap(((it$0$35678.build(a$35846)+"|")+it$0$35678.build(b$35847)));}else{if(($35706$35848==="*")){(t0$35879=a$35846);if(((t0$35879 instanceof Array)&&(((t1$35880=t0$35879.length)),((t1$35880===1)&&(t0$35879[0]==="void"))))){}else{$36853(a$35846,"/home/olivier/git/earl-grey/src/stdenv.eg",40534,40535);}return it$0$35678.wrap((it$0$35678.build(b$35847)+"*"));}else{if(($35706$35848==="+")){(t0$35900=a$35846);if(((t0$35900 instanceof Array)&&(((t1$35901=t0$35900.length)),((t1$35901===1)&&(t0$35900[0]==="void"))))){}else{$36853(a$35846,"/home/olivier/git/earl-grey/src/stdenv.eg",40618,40619);}return it$0$35678.wrap((it$0$35678.build(b$35847)+"+"));}else{if(($35706$35848==="?")){(t0$35921=a$35846);if(((t0$35921 instanceof Array)&&(((t1$35922=t0$35921.length)),((t1$35922===1)&&(t0$35921[0]==="void"))))){}else{$36853(a$35846,"/home/olivier/git/earl-grey/src/stdenv.eg",40702,40703);}return it$0$35678.wrap((it$0$35678.build(b$35847)+"?"));}else{if(($35706$35848==="in")){(t0$35944=a$35846);if(((t0$35944 instanceof Array)&&(((t1$35945=t0$35944.length)),((t1$35945===1)&&(t0$35944[0]==="void"))))){}else{$36853(a$35846,"/home/olivier/git/earl-grey/src/stdenv.eg",40787,40788);}(t0$35959=b$35847);if(((t0$35959 instanceof Array)&&(((t1$35960=t0$35959.length)),((t1$35960===2)&&(t0$35959[0]==="value"))))){(v$35942=t0$35959[1]);}else{$36853(b$35847,"/home/olivier/git/earl-grey/src/stdenv.eg",40816,40817);}(x$35975=it$0$35678.quote_charset(v$35942));return (("["+x$35975)+"]");}else{if(($35706$35848==="not")){(t0$35988=a$35846);if(((t0$35988 instanceof Array)&&(((t1$35989=t0$35988.length)),((t1$35989===1)&&(t0$35988[0]==="void"))))){}else{$36853(a$35846,"/home/olivier/git/earl-grey/src/stdenv.eg",40941,40942);}(t0$36003=b$35847);if(((t0$36003 instanceof Array)&&(((t1$36004=t0$36003.length)),((t1$36004===3)&&((t0$36003[0]==="send")&&(((t2$36005=t0$36003[1])),((t2$36005 instanceof Array)&&(((t3$36006=t2$36005.length)),((t3$36006===2)&&((t2$36005[0]==="symbol")&&((t2$36005[1]==="in")&&(((t4$36007=t0$36003[2])),((t4$36007 instanceof Array)&&(((t5$36008=t4$36007.length)),((t5$36008===3)&&((t4$36007[0]==="data")&&(((t6$36009=t4$36007[1])),((t6$36009 instanceof Array)&&(((t7$36010=t6$36009.length)),((t7$36010===1)&&((t6$36009[0]==="void")&&(((t8$36011=t4$36007[2])),((t8$36011 instanceof Array)&&(((t9$36012=t8$36011.length)),((t9$36012===2)&&(t8$36011[0]==="value")))))))))))))))))))))))))){(v$35986=t8$36011[1]);}else{$36853(b$35847,"/home/olivier/git/earl-grey/src/stdenv.eg",41008,41009);}(x$36067=it$0$35678.quote_charset(v$35986));return (("[^"+x$36067)+"]");}else{$36853($35706$35848,"/home/olivier/git/earl-grey/src/stdenv.eg",40326,40331);}}}}}}}}else{if(($35717$35739&&(($35719$35741=(t0$35733>=1))&&($35687$35728[0]==="data")))){(args$36075=Array.prototype.slice.call($35687$35728,1));return (("("+(((acc$36095=[])),(((temp$36101=args$36075)),((($length$36107=temp$36101.length)),((($index$36113=0)),function(){$36090:for(;($index$36113<$length$36107);($index$36113++)){var arg$36130;var m$36122;(m$36122=temp$36101[$index$36113]);(arg$36130=m$36122);acc$36095.push(it$0$35678.build(arg$36130));}}()))),acc$36095).join(""))+")");}else{if(($35719$35741&&($35687$35728[0]==="multi"))){(args$36135=Array.prototype.slice.call($35687$35728,1));return (("(?:"+(((acc$36155=[])),(((temp$36161=args$36135)),((($length$36167=temp$36161.length)),((($index$36173=0)),function(){$36150:for(;($index$36173<$length$36167);($index$36173++)){var arg$36190;var m$36182;(m$36182=temp$36161[$index$36173]);(arg$36190=m$36182);acc$36155.push(it$0$35678.build(arg$36190));}}()))),acc$36155).join(""))+")");}else{(other$36195=$35687$35728);return $36594(["syntax","regexp"]).create("Illegal regular expression",({"expr":expr$35674}));}}}}}}});$25314(RegexBuilder$25487,$25314(((accum$36200=({})),((accum$36200["::name"]="RegexBuilder"),accum$36200)),((accum$36204=({})),((accum$36204["::egclass"]=true),accum$36204))));RegexBuilder$25487;(build_regexp$25488=function(x$36211){return RegexBuilder$25487().build(x$36211);});(mac$36216=function(context$36223,scope$36224,form$36225,$36220$36226,flags$36227){var arg$36272;var v$36257;var $36232$36253;var $36233$36254;var t0$36245;var t1$36246;var t2$36247;var t3$36248;var t4$36249;var t5$36250;var t6$36251;var $36229$36240;var ph$36234;(ph$36234=$36220$36226);($36229$36240=ph$36234);if((($36232$36253=($36229$36240 instanceof Array))&&(((t0$36245=$36229$36240.length)),((t0$36245===2)&&(($36229$36240[0]==="value")&&(((t1$36246=$36229$36240[1])),(typeof(t1$36246)==="string"))))))){(v$36257=t1$36246);return ["send",["symbol","RegExp"],["data",["value",v$36257],["value",flags$36227.join("")]]];}else{if(($36232$36253&&((t0$36245===3)&&(($36229$36240[0]==="send")&&(((t1$36246=$36229$36240[1])),((t1$36246 instanceof Array)&&(((t2$36247=t1$36246.length)),((t2$36247===2)&&((t1$36246[0]==="symbol")&&((t1$36246[1]==="'")&&(((t3$36248=$36229$36240[2])),((t3$36248 instanceof Array)&&(((t4$36249=t3$36248.length)),((t4$36249===3)&&((t3$36248[0]==="data")&&(((t5$36250=t3$36248[1])),((t5$36250 instanceof Array)&&(((t6$36251=t5$36250.length)),((t6$36251===1)&&(t5$36250[0]==="void")))))))))))))))))))){(arg$36272=t3$36248[2]);return ["send",["symbol","RegExp"],["data",["value",build_regexp$25488(arg$36272)],["value",flags$36227.join("")]]];}else{$36853($36229$36240);}}});stdenv$25460.bind(topscope$25464,"R",["macro",accum_flags$25476(mac$36216,false)]);(errf_macro$25489=function(tags$36312){return function(context$36318,scope$36319,form$36320,$36315$36321){var other$36360;var args$36355;var $36327$36342;var $36328$36343;var t0$36340;var $36323$36335;var ph$36329;(ph$36329=$36315$36321);($36323$36335=ph$36329);if((($36327$36342=($36323$36335 instanceof Array))&&(((t0$36340=$36323$36335.length)),((t0$36340===1)&&($36323$36335[0]==="void"))))){return ["send",["symbol","ErrorFactory"],["data",["data"].concat(tags$36312)]];}else{if(($36327$36342&&((t0$36340>=1)&&($36323$36335[0]==="data")))){(args$36355=Array.prototype.slice.call($36323$36335,1));return ["send",["send",["send",["symbol","ErrorFactory"],["data",["data"].concat(tags$36312)]],["send",["symbol","."],["data",["void"],["symbol","create"]]]],["data"].concat(args$36355)];}else{(other$36360=$36323$36335);return ["macro",errf_macro$25489(tags$36312.concat([other$36360]))];}}};});stdenv$25460.bind(topscope$25464,"E",["macro",errf_macro$25489([])]);(temp$36366=$36919(({"___build_array":Embedded$25459(["send",["symbol","->"],["data",["data",["symbol","arrays"]],["multi",["send",["symbol","="],["data",["send",["symbol","var"],["symbol","results"]],["data"]]],["send",["symbol","each"],["data",["symbol","arrays"],["send",["symbol","->"],["data",["symbol","a"],["send",["symbol","="],["data",["send",["symbol","set"],["symbol","results"]],["send",["send",["symbol","results"],["send",["symbol","."],["data",["void"],["symbol","concat"]]]],["data",["symbol","a"]]]]]]]]],["symbol","results"]]]]),"object":Embedded$25459(["send",["symbol","->"],["data",["data",["symbol","pairs"]],["multi",["send",["symbol","="],["data",["symbol","rval"],["data",["symbol","="]]]],["send",["symbol","each"],["data",["symbol","pairs"],["send",["symbol","->"],["data",["data",["symbol","k"],["symbol","v"]],["send",["symbol","="],["data",["send",["symbol","rval"],["symbol","k"]],["symbol","v"]]]]]]],["symbol","rval"]]]]),"items":Embedded$25459(["send",["symbol","->"],["data",["data",["symbol","obj"]],["multi",["send",["symbol","="],["data",["symbol","results"],["data"]]],["send",["symbol","for"],["data",["send",["symbol","in"],["data",["symbol","k"],["symbol","obj"]]],["send",["symbol","if"],["data",["send",["send",["send",["send",["symbol","Object"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]],["send",["symbol","."],["data",["void"],["symbol","hasOwnProperty"]]]],["send",["symbol","."],["data",["void"],["symbol","call"]]]],["data",["symbol","obj"],["symbol","k"]]],["send",["send",["symbol","results"],["send",["symbol","."],["data",["void"],["symbol","push"]]]],["data",["data",["symbol","k"],["send",["symbol","obj"],["symbol","k"]]]]]]]]],["symbol","results"]]]]),"keys":Embedded$25459(["send",["symbol","Object"],["send",["symbol","."],["data",["void"],["symbol","keys"]]]]),"enumerate":Embedded$25459(["send",["symbol","->"],["data",["data",["symbol","arr"]],["multi",["send",["symbol","="],["data",["symbol","results"],["data"]]],["send",["symbol","="],["data",["symbol","l"],["send",["symbol","arr"],["send",["symbol","."],["data",["void"],["symbol","length"]]]]]],["send",["symbol","for"],["data",["multi",["send",["symbol","="],["data",["symbol","i"],["value",0]]],["send",["symbol","<"],["data",["symbol","i"],["symbol","l"]]],["send",["symbol","++"],["data",["symbol","i"],["void"]]]],["send",["send",["symbol","results"],["send",["symbol","."],["data",["void"],["symbol","push"]]]],["data",["data",["symbol","i"],["send",["symbol","arr"],["symbol","i"]]]]]]],["symbol","results"]]]]),"zip":Embedded$25459(["send",["symbol","->"],["data",["data",["symbol","xs"],["symbol","ys"]],["send",["symbol","each"],["data",["send",["symbol","enumerate"],["data",["symbol","xs"]]],["send",["symbol","->"],["data",["data",["symbol","i"],["symbol","x"]],["data",["symbol","x"],["send",["symbol","ys"],["symbol","i"]]]]]]]]]),"predicate":Embedded$25459(["send",["symbol","->"],["data",["data",["symbol","f"]],["multi",["send",["symbol","="],["data",["send",["symbol","f"],["value","::check"]],["symbol","f"]]],["symbol","f"]]]]),"___nequal":Embedded$25459(["send",["symbol","->"],["data",["data",["symbol","x"],["symbol","y"]],["send",["symbol","not"],["data",["void"],["send",["symbol","=="],["data",["symbol","x"],["symbol","y"]]]]]]]),"___equal":Embedded$25459(["send",["symbol","->"],["data",["data",["send",["symbol","match"],["symbol","a"]],["symbol","b"]],["multi",["send",["symbol","->"],["data",["send",["symbol","==="],["data",["void"],["symbol","b"]]],["symbol","true"]]],["send",["symbol","->"],["data",["send",["symbol","or"],["data",["send",["symbol","or"],["data",["send",["symbol","or"],["data",["send",["symbol","or"],["data",["send",["symbol","or"],["data",["send",["symbol","?"],["data",["symbol","Number"],["void"]]],["send",["symbol","?"],["data",["symbol","String"],["void"]]]]],["send",["symbol","?"],["data",["symbol","null"],["void"]]]]],["send",["symbol","?"],["data",["symbol","undefined"],["void"]]]]],["send",["symbol","==="],["data",["void"],["symbol","true"]]]]],["send",["symbol","==="],["data",["void"],["symbol","false"]]]]],["symbol","false"]]],["send",["symbol","->"],["data",["send",["symbol","?"],["data",["symbol","Array"],["void"]]],["multi",["send",["symbol","if"],["data",["send",["symbol","or"],["data",["send",["symbol","not"],["data",["void"],["send",["symbol","?"],["data",["symbol","Array"],["symbol","b"]]]]],["send",["symbol","!=="],["data",["send",["symbol","a"],["send",["symbol","."],["data",["void"],["symbol","length"]]]],["send",["symbol","b"],["send",["symbol","."],["data",["void"],["symbol","length"]]]]]]]],["send",["symbol","return"],["symbol","false"]]]],["send",["symbol","for"],["data",["multi",["send",["symbol","="],["data",["symbol","i"],["value",0]]],["send",["symbol","<"],["data",["symbol","i"],["send",["symbol","a"],["send",["symbol","."],["data",["void"],["symbol","length"]]]]]],["send",["symbol","++"],["data",["symbol","i"],["void"]]]],["send",["symbol","if"],["data",["send",["symbol","not"],["data",["void"],["send",["symbol","=="],["data",["send",["symbol","___js_fetch"],["data",["symbol","a"],["symbol","i"]]],["send",["symbol","___js_fetch"],["data",["symbol","b"],["symbol","i"]]]]]]],["send",["symbol","return"],["symbol","false"]]]]]],["symbol","true"]]]],["send",["symbol","->"],["data",["send",["symbol","when"],["data",["void"],["send",["symbol","and"],["data",["send",["symbol","and"],["data",["send",["symbol","==="],["data",["send",["send",["symbol","Object"],["send",["symbol","."],["data",["void"],["symbol","getPrototypeOf"]]]],["data",["symbol","a"]]],["send",["symbol","Object"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]]]],["send",["symbol","?"],["data",["symbol","Object"],["symbol","b"]]]]],["send",["symbol","==="],["data",["send",["send",["symbol","Object"],["send",["symbol","."],["data",["void"],["symbol","getPrototypeOf"]]]],["data",["symbol","b"]]],["send",["symbol","Object"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]]]]]]]],["multi",["send",["symbol","="],["data",["symbol","ka"],["send",["symbol","keys"],["data",["symbol","a"]]]]],["send",["symbol","if"],["data",["send",["symbol","not"],["data",["void"],["send",["symbol","=="],["data",["send",["send",["symbol","ka"],["send",["symbol","."],["data",["void"],["symbol","sort"]]]],["data"]],["send",["send",["send",["symbol","keys"],["data",["symbol","b"]]],["send",["symbol","."],["data",["void"],["symbol","sort"]]]],["data"]]]]]],["send",["symbol","return"],["symbol","false"]]]],["send",["symbol","each"],["data",["symbol","ka"],["send",["symbol","->"],["data",["symbol","k"],["send",["symbol","if"],["data",["send",["symbol","not"],["data",["void"],["send",["symbol","=="],["data",["send",["symbol","___js_fetch"],["data",["symbol","a"],["symbol","k"]]],["send",["symbol","___js_fetch"],["data",["symbol","b"],["symbol","k"]]]]]]],["send",["symbol","return"],["symbol","false"]]]]]]]],["symbol","true"]]]],["send",["symbol","->"],["data",["data",["send",["symbol","=>"],["data",["value","::serialize"],["symbol","_"]]]],["send",["symbol","match"],["data",["symbol","b"],["multi",["send",["symbol","->"],["data",["data",["send",["symbol","=>"],["data",["value","::serialize"],["symbol","_"]]]],["send",["symbol","=="],["data",["send",["send",["symbol","a"],["value","::serialize"]],["data"]],["send",["send",["symbol","b"],["value","::serialize"]],["data"]]]]]],["send",["symbol","->"],["data",["symbol","otherwise"],["symbol","false"]]]]]]]],["send",["symbol","->"],["data",["symbol","otherwise"],["symbol","false"]]]]]]),"&:":Embedded$25459(["send",["symbol","->"],["data",["data",["symbol","dest"],["symbol","values"]],["multi",["send",["symbol","for"],["data",["send",["symbol","in"],["data",["symbol","k"],["symbol","values"]]],["send",["symbol","if"],["data",["send",["send",["symbol","values"],["send",["symbol","."],["data",["void"],["symbol","hasOwnProperty"]]]],["data",["symbol","k"]]],["send",["symbol","="],["data",["send",["symbol","dest"],["symbol","k"]],["send",["symbol","___js_fetch"],["data",["symbol","values"],["symbol","k"]]]]]]]]],["symbol","dest"]]]]),"&":Embedded$25459(["send",["symbol","->"],["data",["data",["symbol","a"],["symbol","b"]],["multi",["send",["symbol","="],["data",["symbol","dest"],["send",["symbol","clone"],["data",["symbol","a"]]]]],["send",["symbol","for"],["data",["send",["symbol","in"],["data",["symbol","k"],["symbol","b"]]],["send",["symbol","if"],["data",["send",["send",["send",["send",["symbol","Object"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]],["send",["symbol","."],["data",["void"],["symbol","hasOwnProperty"]]]],["send",["symbol","."],["data",["void"],["symbol","call"]]]],["data",["symbol","b"],["symbol","k"]]],["send",["symbol","="],["data",["send",["symbol","dest"],["symbol","k"]],["send",["symbol","___js_fetch"],["data",["symbol","b"],["symbol","k"]]]]]]]]],["symbol","dest"]]]]),"&+":Embedded$25459(["send",["symbol","->"],["data",["data",["symbol","a"],["symbol","b"]],["multi",["send",["symbol","="],["data",["symbol","dest"],["send",["symbol","clone"],["data",["symbol","a"]]]]],["send",["symbol","for"],["data",["send",["symbol","in"],["data",["symbol","k"],["symbol","b"]]],["send",["symbol","if"],["data",["send",["send",["send",["send",["symbol","Object"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]],["send",["symbol","."],["data",["void"],["symbol","hasOwnProperty"]]]],["send",["symbol","."],["data",["void"],["symbol","call"]]]],["data",["symbol","b"],["symbol","k"]]],["send",["symbol","="],["data",["send",["symbol","dest"],["symbol","k"]],["send",["symbol","___js_fetch"],["data",["symbol","b"],["symbol","k"]]]]]]]]],["symbol","dest"]]]]),"|>":Embedded$25459(["send",["symbol","->"],["data",["data",["symbol","f"],["symbol","g"]],["send",["symbol","->"],["data",["data",["symbol","x"]],["send",["symbol","g"],["data",["send",["symbol","f"],["data",["symbol","x"]]]]]]]]]),"clone":Embedded$25459(["send",["symbol","->"],["data",["data",["send",["symbol","match"],["symbol","x"]]],["multi",["send",["symbol","->"],["data",["send",["symbol","or"],["data",["send",["symbol","or"],["data",["send",["symbol","or"],["data",["send",["symbol","?"],["data",["symbol","undefined"],["void"]]],["send",["symbol","?"],["data",["symbol","null"],["void"]]]]],["send",["symbol","?"],["data",["symbol","String"],["void"]]]]],["send",["symbol","?"],["data",["symbol","Number"],["void"]]]]],["symbol","x"]]],["send",["symbol","->"],["data",["data",["send",["symbol","=>"],["data",["value","::clone"],["symbol","_"]]]],["send",["send",["symbol","x"],["value","::clone"]],["data"]]]],["send",["symbol","->"],["data",["send",["symbol","when"],["data",["void"],["send",["symbol","==="],["data",["send",["send",["symbol","Object"],["send",["symbol","."],["data",["void"],["symbol","getPrototypeOf"]]]],["data",["symbol","x"]]],["send",["symbol","Object"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]]]]]],["multi",["send",["symbol","="],["data",["symbol","dest"],["data",["symbol","="]]]],["send",["symbol","for"],["data",["send",["symbol","in"],["data",["symbol","k"],["symbol","x"]]],["send",["symbol","if"],["data",["send",["send",["send",["send",["symbol","Object"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]],["send",["symbol","."],["data",["void"],["symbol","hasOwnProperty"]]]],["send",["symbol","."],["data",["void"],["symbol","call"]]]],["data",["symbol","x"],["symbol","k"]]],["send",["symbol","="],["data",["send",["symbol","dest"],["symbol","k"]],["send",["symbol","___js_fetch"],["data",["symbol","x"],["symbol","k"]]]]]]]]],["symbol","dest"]]]],["send",["symbol","->"],["data",["symbol","other"],["send",["symbol","throw"],["send",["send",["symbol","E"],["send",["symbol","."],["data",["void"],["symbol","clone"]]]],["data",["value","Object cannot be cloned"],["data",["send",["symbol","="],["data",["symbol","obj"],["symbol","x"]]]]]]]]]]]]),"___checker":Embedded$25459(["send",["symbol","->"],["data",["data",["symbol","type"]],["multi",["send",["symbol","="],["data",["symbol","f"],["send",["symbol","type"],["value","::check"]]]],["send",["symbol","if"],["data",["send",["symbol","==="],["data",["symbol","f"],["symbol","undefined"]]],["multi",["send",["symbol","then"],["data",["send",["symbol","->"],["data",["data",["symbol","value"]],["send",["symbol","instanceof"],["data",["symbol","value"],["symbol","type"]]]]]]],["send",["symbol","else"],["data",["send",["symbol","->"],["data",["data",["symbol","value"]],["send",["send",["symbol","f"],["send",["symbol","."],["data",["void"],["symbol","call"]]]],["data",["symbol","type"],["symbol","value"]]]]]]]]]]]]]),"___projector":Embedded$25459(["send",["symbol","->"],["data",["data",["symbol","type"]],["send",["symbol","->"],["data",["data",["symbol","value"]],["multi",["send",["symbol","="],["data",["send",["symbol","var"],["symbol","f"]],["send",["symbol","type"],["value",":::project"]]]],["send",["symbol","if"],["data",["send",["symbol","==="],["data",["symbol","f"],["symbol","undefined"]]],["multi",["send",["symbol","then"],["data",["multi",["send",["symbol","="],["data",["send",["symbol","set"],["symbol","f"]],["send",["symbol","type"],["value","::project"]]]],["send",["symbol","if"],["data",["send",["symbol","==="],["data",["symbol","f"],["symbol","undefined"]]],["multi",["send",["symbol","then"],["data",["data",["symbol","true"],["send",["symbol","type"],["data",["symbol","value"]]]]]],["send",["symbol","else"],["data",["send",["symbol","!!"],["data",["data",["symbol","true"],["send",["symbol","f"],["data",["symbol","value"]]]],["send",["symbol","->"],["data",["symbol","e"],["data",["symbol","false"],["symbol","null"]]]]]]]]]]]]]],["send",["symbol","else"],["data",["send",["send",["symbol","f"],["send",["symbol","."],["data",["void"],["symbol","call"]]]],["data",["symbol","type"],["symbol","value"]]]]]]]]]]]]]),"___hasprop":Embedded$25459(["send",["symbol","->"],["data",["data",["symbol","match"],["symbol","key"]],["multi",["send",["symbol","->"],["data",["send",["symbol","or"],["data",["send",["symbol","?"],["data",["symbol","null"],["void"]]],["send",["symbol","?"],["data",["symbol","undefined"],["void"]]]]],["symbol","false"]]],["send",["symbol","->"],["data",["send",["symbol","?"],["data",["symbol","String"],["symbol","x"]]],["send",["symbol","in"],["data",["symbol","key"],["send",["symbol","String"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]]]]]],["send",["symbol","->"],["data",["send",["symbol","?"],["data",["symbol","Number"],["symbol","x"]]],["send",["symbol","in"],["data",["symbol","key"],["send",["symbol","Number"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]]]]]],["send",["symbol","->"],["data",["symbol","x"],["send",["symbol","in"],["data",["symbol","key"],["symbol","x"]]]]]]]]),"range":Embedded$25459(["send",["symbol","->"],["data",["data",["symbol","from"],["symbol","to"]],["multi",["send",["symbol","="],["data",["symbol","rval"],["data"]]],["send",["symbol","for"],["data",["multi",["send",["symbol","="],["data",["symbol","i"],["symbol","from"]]],["send",["symbol","<="],["data",["symbol","i"],["symbol","to"]]],["send",["symbol","++"],["data",["symbol","i"],["void"]]]],["send",["send",["symbol","rval"],["send",["symbol","."],["data",["void"],["symbol","push"]]]],["data",["symbol","i"]]]]],["symbol","rval"]]]]),"___serialize_ast":Embedded$25459(["send",["symbol","->"],["data",["data",["symbol","match"]],["multi",["send",["symbol","->"],["data",["send",["symbol","or"],["data",["send",["symbol","?"],["data",["symbol","String"],["symbol","x"]]],["send",["symbol","?"],["data",["symbol","Number"],["symbol","x"]]]]],["send",["send",["symbol","#"],["data",["void"],["symbol","value"]]],["data",["symbol","x"]]]]],["send",["symbol","->"],["data",["symbol","other"],["send",["send",["symbol","other"],["value","::serialize_ast"]],["data"]]]]]]]),"___match_error":Embedded$25459(["send",["symbol","->"],["data",["data",["symbol","value"],["symbol","url"],["symbol","start"],["symbol","end"]],["multi",["send",["symbol","="],["data",["symbol","err"],["send",["send",["symbol","E"],["send",["symbol","."],["data",["void"],["symbol","match"]]]],["data",["value","Could not find a match for value"],["data",["send",["symbol","="],["data",["symbol","value"],["symbol","value"]]]]]]]],["send",["symbol","if"],["data",["symbol","url"],["send",["symbol","="],["data",["send",["symbol","err"],["send",["symbol","."],["data",["void"],["symbol","location"]]]],["send",["send",["symbol","#"],["data",["void"],["symbol","location"]]],["data",["symbol","url"],["symbol","start"],["symbol","end"]]]]]]],["send",["symbol","throw"],["symbol","err"]]]]]),"___extend":Embedded$25459(["send",["symbol","->"],["data",["data",["symbol","child"],["symbol","parent"]],["multi",["send",["symbol","each"],["data",["send",["symbol","items"],["data",["symbol","parent"]]],["send",["symbol","->"],["data",["data",["symbol","key"],["symbol","value"]],["send",["symbol","="],["data",["send",["symbol","child"],["symbol","key"]],["symbol","value"]]]]]]],["send",["symbol","="],["data",["send",["symbol","child"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]],["send",["send",["symbol","Object"],["send",["symbol","."],["data",["void"],["symbol","create"]]]],["data",["send",["symbol","parent"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]]]]]],["send",["symbol","="],["data",["send",["send",["symbol","child"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]],["send",["symbol","."],["data",["void"],["symbol","constructor"]]]],["symbol","child"]]],["send",["symbol","="],["data",["send",["symbol","child"],["value","::super"]],["send",["symbol","parent"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]]]],["symbol","child"]]]]),"ErrorFactory":Embedded$25459(["send",["symbol","class"],["data",["multi",["send",["symbol","="],["data",["send",["symbol","constructor"],["data",["symbol","tags"]]],["send",["symbol","="],["data",["send",["symbol","@"],["data",["void"],["symbol","tags"]]],["symbol","tags"]]]]],["send",["symbol","="],["data",["send",["symbol","create"],["data",["send",["symbol","="],["data",["symbol","message"],["value",""]]],["send",["symbol","*"],["data",["void"],["symbol","args"]]]]],["multi",["send",["symbol","="],["data",["symbol","e"],["send",["symbol","Error"],["data",["symbol","message"]]]]],["send",["symbol","="],["data",["send",["symbol","e"],["value","::tags"]],["send",["symbol","@"],["data",["void"],["symbol","tags"]]]]],["send",["symbol","="],["data",["send",["symbol","e"],["send",["symbol","."],["data",["void"],["symbol","args"]]]],["symbol","args"]]],["send",["symbol","each"],["data",["send",["symbol","enumerate"],["data",["symbol","args"]]],["send",["symbol","->"],["data",["data",["symbol","i"],["symbol","arg"]],["send",["symbol","="],["data",["send",["symbol","e"],["symbol","i"]],["symbol","arg"]]]]]]],["send",["symbol","="],["data",["send",["symbol","e"],["send",["symbol","."],["data",["void"],["symbol","length"]]]],["send",["symbol","args"],["send",["symbol","."],["data",["void"],["symbol","length"]]]]]],["send",["symbol","="],["data",["send",["symbol","e"],["send",["symbol","."],["data",["void"],["symbol","name"]]]],["send",["send",["send",["symbol","++"],["data",["data",["send",["symbol","."],["data",["void"],["symbol","E"]]]],["send",["symbol","@"],["data",["void"],["symbol","tags"]]]]],["send",["symbol","."],["data",["void"],["symbol","join"]]]],["data",["value","."]]]]],["symbol","e"]]]],["send",["symbol","="],["data",["send",["value","::check"],["data",["symbol","e"]]],["multi",["send",["symbol","if"],["data",["send",["symbol","or"],["data",["send",["symbol","not"],["data",["void"],["symbol","e"]]],["send",["symbol","not"],["data",["void"],["send",["symbol","?"],["data",["symbol","Error"],["symbol","e"]]]]]]],["send",["symbol","return"],["symbol","false"]]]],["send",["symbol","="],["data",["symbol","tags"],["send",["symbol","or"],["data",["send",["symbol","e"],["value","::tags"]],["data"]]]]],["send",["symbol","each?"],["data",["send",["symbol","@"],["data",["void"],["symbol","tags"]]],["send",["symbol","->"],["data",["send",["symbol","when"],["data",["symbol","tag"],["send",["symbol","==="],["data",["send",["send",["symbol","tags"],["send",["symbol","."],["data",["void"],["symbol","indexOf"]]]],["data",["symbol","tag"]]],["send",["symbol","-"],["data",["void"],["value",1]]]]]]],["send",["symbol","return"],["symbol","false"]]]]]],["symbol","true"]]]],["send",["symbol","="],["data",["send",["value","::deconstruct"],["data",["symbol","e"]]],["send",["symbol","e"],["send",["symbol","."],["data",["void"],["symbol","args"]]]]]]]]]),"Node":Embedded$25459(["send",["symbol","class"],["data",["multi",["send",["symbol","static"],["data",["multi",["send",["symbol","="],["data",["send",["value","::check"],["data",["symbol","x"]]],["send",["symbol","and"],["data",["send",["symbol","and"],["data",["send",["symbol","and"],["data",["symbol","x"],["send",["symbol","x"],["send",["symbol","."],["data",["void"],["symbol","tags"]]]]]],["send",["symbol","x"],["send",["symbol","."],["data",["void"],["symbol","props"]]]]]],["send",["symbol","x"],["send",["symbol","."],["data",["void"],["symbol","children"]]]]]]]],["send",["symbol","="],["data",["send",["value",":::project"],["data",["symbol","match"]]],["multi",["send",["symbol","->"],["data",["data",["send",["symbol","=>"],["data",["void"],["symbol","tags"]]],["send",["symbol","=>"],["data",["void"],["symbol","props"]]],["send",["symbol","=>"],["data",["void"],["symbol","children"]]]],["data",["symbol","true"],["data",["symbol","tags"],["symbol","props"],["symbol","children"]]]]],["send",["symbol","->"],["data",["symbol","else"],["data",["symbol","false"],["symbol","null"]]]]]]]]]],["send",["symbol","="],["data",["send",["symbol","constructor"],["data",["send",["symbol","!"],["data",["symbol","Array"],["send",["symbol","@"],["data",["void"],["symbol","tags"]]]]],["send",["symbol","@"],["data",["void"],["symbol","props"]]],["send",["symbol","!"],["data",["symbol","Array"],["send",["symbol","@"],["data",["void"],["symbol","children"]]]]]]],["symbol","pass"]]],["send",["symbol","="],["data",["send",["value","::check"],["data",["symbol","match"]]],["multi",["send",["symbol","->"],["data",["send",["symbol","?"],["data",["symbol","Node"],["symbol","n"]]],["multi",["send",["symbol","each?"],["data",["send",["symbol","@"],["data",["void"],["symbol","tags"]]],["send",["symbol","->"],["data",["send",["symbol","when"],["data",["symbol","c"],["send",["symbol","==="],["data",["send",["send",["send",["symbol","n"],["send",["symbol","."],["data",["void"],["symbol","tags"]]]],["send",["symbol","."],["data",["void"],["symbol","indexOf"]]]],["data",["symbol","c"]]],["send",["symbol","-"],["data",["void"],["value",1]]]]]]],["send",["symbol","return"],["symbol","false"]]]]]],["symbol","true"]]]],["send",["symbol","->"],["data",["symbol","else"],["symbol","false"]]]]]],["send",["symbol","="],["data",["send",["value",":::project"],["data",["symbol","match"]]],["multi",["send",["symbol","->"],["data",["send",["symbol","?"],["data",["symbol","@"],["symbol","n"]]],["data",["symbol","true"],["data",["send",["symbol","n"],["send",["symbol","."],["data",["void"],["symbol","tags"]]]],["send",["symbol","n"],["send",["symbol","."],["data",["void"],["symbol","props"]]]],["send",["symbol","n"],["send",["symbol","."],["data",["void"],["symbol","children"]]]]]]]],["send",["symbol","->"],["data",["symbol","else"],["data",["symbol","false"],["symbol","null"]]]]]]]]]])})));($length$36372=temp$36366.length);($index$36378=0);$25497:for(;($index$36378<$length$36372);($index$36378++)){var k$36397;var v$36398;var t0$36392;var t1$36393;var m$36387;(m$36387=temp$36366[$index$36378]);(t0$36392=m$36387);if(((t0$36392 instanceof Array)&&(((t1$36393=t0$36392.length)),(t1$36393===2)))){(k$36397=t0$36392[0]);(v$36398=t0$36392[1]);stdenv$25460.bind(topscope$25464,k$36397,["value",v$36398]);}else{$36853(m$36387,"/home/olivier/git/earl-grey/src/stdenv.eg",42093,42159);}}(stdprelude$25490=Embedded$25459(["multi",["send",["symbol","="],["data",["send",["symbol","send"],["data",["symbol","obj"],["send",["symbol","match"],["symbol","msg"]]]],["multi",["send",["symbol","->"],["data",["send",["symbol","or"],["data",["send",["symbol","?"],["data",["symbol","String"],["void"]]],["send",["symbol","?"],["data",["symbol","Number"],["void"]]]]],["send",["symbol","___js_fetch"],["data",["symbol","obj"],["symbol","msg"]]]]],["send",["symbol","->"],["data",["symbol","other"],["send",["send",["symbol","obj"],["value","::send"]],["data",["symbol","msg"]]]]]]]],["send",["symbol","="],["data",["send",["send",["symbol","Array"],["value",":::project"]],["data",["send",["symbol","match"],["symbol","value"]]]],["multi",["send",["symbol","->"],["data",["send",["symbol","?"],["data",["symbol","Array"],["void"]]],["data",["symbol","true"],["symbol","value"]]]],["send",["symbol","->"],["data",["symbol","_"],["data",["symbol","true"],["data",["symbol","value"]]]]]]]],["send",["symbol","="],["data",["send",["send",["send",["symbol","Array"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]],["value","::check"]],["data",["symbol","value"]]],["send",["symbol","if"],["data",["send",["symbol","instanceof"],["data",["symbol","value"],["symbol","Array"]]],["multi",["send",["symbol","then"],["data",["multi",["send",["symbol","for"],["data",["multi",["send",["symbol","="],["data",["symbol","i"],["value",0]]],["send",["symbol","<"],["data",["symbol","i"],["send",["symbol","this"],["send",["symbol","."],["data",["void"],["symbol","length"]]]]]],["send",["symbol","++"],["data",["symbol","i"],["void"]]]],["send",["symbol","if"],["data",["send",["symbol","!=="],["data",["send",["symbol","this"],["symbol","i"]],["send",["symbol","value"],["symbol","i"]]]],["send",["symbol","return"],["symbol","false"]]]]]],["symbol","true"]]]],["send",["symbol","else"],["data",["symbol","false"]]]]]]]],["send",["symbol","="],["data",["send",["send",["send",["symbol","Array"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]],["value","::clone"]],["data"]],["send",["symbol","&:"],["data",["send",["send",["symbol","this"],["send",["symbol","."],["data",["void"],["symbol","slice"]]]],["data",["value",0]]],["symbol","this"]]]]],["send",["symbol","="],["data",["send",["send",["send",["symbol","Array"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]],["value",":::project"]],["data",["symbol","value"]]],["send",["symbol","if"],["data",["send",["symbol","instanceof"],["data",["symbol","value"],["symbol","Array"]]],["multi",["send",["symbol","then"],["data",["multi",["send",["symbol","for"],["data",["multi",["send",["symbol","="],["data",["symbol","i"],["value",0]]],["send",["symbol","<"],["data",["symbol","i"],["send",["symbol","this"],["send",["symbol","."],["data",["void"],["symbol","length"]]]]]],["send",["symbol","++"],["data",["symbol","i"],["void"]]]],["send",["symbol","if"],["data",["send",["symbol","!=="],["data",["send",["symbol","this"],["symbol","i"]],["send",["symbol","value"],["symbol","i"]]]],["send",["symbol","return"],["data",["symbol","true"],["data",["symbol","value"]]]]]]]],["data",["symbol","true"],["send",["send",["symbol","value"],["send",["symbol","."],["data",["void"],["symbol","slice"]]]],["data",["send",["symbol","this"],["send",["symbol","."],["data",["void"],["symbol","length"]]]]]]]]]],["send",["symbol","else"],["data",["data",["symbol","true"],["data",["symbol","value"]]]]]]]]]],["send",["symbol","="],["data",["send",["send",["send",["symbol","Array"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]],["value","::serialize_ast"]],["data"]],["send",["send",["symbol","#"],["data",["void"],["symbol","array"]]],["data",["send",["symbol","*"],["data",["void"],["send",["send",["symbol","this"],["send",["symbol","."],["data",["void"],["symbol","map"]]]],["data",["symbol","___serialize_ast"]]]]]]]]],["send",["symbol","="],["data",["send",["send",["send",["symbol","RegExp"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]],["value","::check"]],["data",["symbol","match"]]],["multi",["send",["symbol","->"],["data",["send",["symbol","?"],["data",["symbol","String"],["symbol","value"]]],["send",["symbol","if"],["data",["send",["send",["symbol","value"],["send",["symbol","."],["data",["void"],["symbol","match"]]]],["data",["symbol","this"]]],["symbol","true"],["symbol","false"]]]]],["send",["symbol","->"],["data",["symbol","other"],["symbol","false"]]]]]],["send",["symbol","="],["data",["send",["send",["send",["symbol","RegExp"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]],["value",":::project"]],["data",["symbol","match"]]],["multi",["send",["symbol","->"],["data",["send",["symbol","?"],["data",["symbol","String"],["symbol","value"]]],["send",["symbol","match"],["data",["send",["send",["symbol","value"],["send",["symbol","."],["data",["void"],["symbol","match"]]]],["data",["symbol","this"]]],["multi",["send",["symbol","->"],["data",["send",["symbol","?"],["data",["symbol","null"],["symbol","m"]]],["data",["symbol","false"],["symbol","null"]]]],["send",["symbol","->"],["data",["symbol","m"],["data",["symbol","true"],["symbol","m"]]]]]]]]],["send",["symbol","->"],["data",["symbol","other"],["data",["symbol","false"],["symbol","null"]]]]]]],["send",["symbol","="],["data",["send",["send",["send",["symbol","Function"],["send",["symbol","."],["data",["void"],["symbol","prototype"]]]],["value","::send"]],["data",["symbol","args"]]],["send",["send",["symbol","this"],["send",["symbol","."],["data",["void"],["symbol","apply"]]]],["data",["symbol","this"],["symbol","args"]]]]]]));(expander$25462["utils"]=({"var_operator":var_operator$25475}));(exports["topscope"]=topscope$25464);(exports["stdenv"]=stdenv$25460);(exports["expander"]=expander$25462);(exports["expand"]=expand$25463);(exports["stdprelude"]=stdprelude$25490);

},{"./expand":9,"./location":11,"./pattern":14,"./pp":15,"./util":18}],17:[function(require,module,exports){
var $37409=function(type$37412){var f$37416;(f$37416=type$37412["::check"]);if((f$37416===(void 0))){return function(value$37422){return (value$37422 instanceof type$37412);};}else{return function(value$37426){return f$37416.call(type$37412,value$37426);};}};
var $37428=(function(o,m){if(typeof(m)==='string'||typeof(m)==='number'){return o[m];}else{return o['::send'](m);}});
var $37429=function(dest$37432,values$37433){var k$37438;(k$37438=null);$37436:for(k$37438 in values$37433){if(values$37433.hasOwnProperty(k$37438)){(dest$37432[k$37438]=values$37433[k$37438]);}}return dest$37432;};
var $37446=function($37448$37451){var ph$37457;(ph$37457=$37448$37451);var $37453$37463;($37453$37463=ph$37457);var bridge$37455$37468;var x$37472;(bridge$37455$37468=$37453$37463);if((((typeof(bridge$37455$37468)==="string")&&((x$37472=bridge$37455$37468),true))||((typeof(bridge$37455$37468)==="number")&&((x$37472=bridge$37455$37468),true)))){return ["value",x$37472];}else{var other$37483;(other$37483=$37453$37463);return other$37483["::serialize_ast"]();}};
var send$37183;(send$37183=function(obj$37190,$37187$37191){var ph$37197;var msg$37198;var t0$37200;(t0$37200=$37187$37191);(msg$37198=t0$37200);(ph$37197=t0$37200);var $37193$37209;($37193$37209=ph$37197);var bridge$37195$37214;(bridge$37195$37214=$37193$37209);if(((typeof(bridge$37195$37214)==="string")||(typeof(bridge$37195$37214)==="number"))){return obj$37190[msg$37198];}else{var other$37226;(other$37226=$37193$37209);return obj$37190["::send"](msg$37198);}});(Array[":::project"]=function($37232$37235){var ph$37240;var value$37241;var t0$37243;(t0$37243=$37232$37235);(value$37241=t0$37243);(ph$37240=t0$37243);var $37237$37252;($37237$37252=ph$37240);if($37409(Array)($37237$37252)){return [true,value$37241];}else{$37237$37252;return [true,[value$37241]];}});(Array.prototype["::check"]=function(value$37270){if((value$37270 instanceof Array)){var i$37276;(i$37276=0);$37273:for(;(i$37276<this.length);(i$37276++)){if(($37428(this,i$37276)!==$37428(value$37270,i$37276))){return false;}}return true;}else{return false;}});(Array.prototype["::clone"]=function(){return $37429(this.slice(0),this);});(Array.prototype[":::project"]=function(value$37295){if((value$37295 instanceof Array)){var i$37301;(i$37301=0);$37298:for(;(i$37301<this.length);(i$37301++)){if(($37428(this,i$37301)!==$37428(value$37295,i$37301))){return [true,[value$37295]];}}return [true,value$37295.slice(this.length)];}else{return [true,[value$37295]];}});(Array.prototype["::serialize_ast"]=function(){return ["array"].concat(this.map($37446));});(RegExp.prototype["::check"]=function($37319$37322){var ph$37327;(ph$37327=$37319$37322);var $37324$37333;($37324$37333=ph$37327);var value$37341;if((typeof($37324$37333)==="string")){(value$37341=$37324$37333);if(value$37341.match(this)){return true;}else{return false;}}else{var other$37346;(other$37346=$37324$37333);return false;}});(RegExp.prototype[":::project"]=function($37352$37355){var ph$37360;(ph$37360=$37352$37355);var $37357$37366;($37357$37366=ph$37360);var value$37374;if((typeof($37357$37366)==="string")){(value$37374=$37357$37366);var $37377$37382;($37377$37382=value$37374.match(this));var m$37390;if(($37377$37382===null)){(m$37390=$37377$37382);return [false,null];}else{var m$37395;(m$37395=$37377$37382);return [true,m$37395];}}else{var other$37399;(other$37399=$37357$37366);return [false,null];}});(Function.prototype["::send"]=function(args$37406){return this.apply(this,args$37406);});
var $39849=function(arr$39852){var results$39858;var l$39859;(results$39858=[]);(l$39859=arr$39852.length);var i$39868;(i$39868=0);$39857:for(;(i$39868<l$39859);(i$39868++)){results$39858.push([i$39868,$37428(arr$39852,i$39868)]);}return results$39858;};
var $39616=function(){var $39617$39623;($39617$39623=function(tags$39628){var it$0$39631;(it$0$39631=function(){if((!$37409($39617$39623)(this))){return Object.create($39617$39623.prototype);}else{return this;}}());(it$0$39631["tags"]=tags$39628);return it$0$39631;});($39617$39623.prototype["create"]=function(){var it$0$39651;var self$39652;(it$0$39651=this);(self$39652=this);var $39649$39661;($39649$39661=arguments);var t0$39666;var message$39670;var args$39671;(t0$39666=$39649$39661.length);if((t0$39666>=0)){(message$39670=function(){if((0>=t0$39666)){return "";}else{return $39649$39661[0];}}());(args$39671=Array.prototype.slice.call($39649$39661,1));var e$39684;(e$39684=Error(message$39670));(e$39684["::tags"]=it$0$39651.tags);(e$39684["args"]=args$39671);var temp$39700;(temp$39700=$39849(args$39671));var $length$39706;($length$39706=temp$39700.length);var $index$39712;($index$39712=0);$39685:for(;($index$39712<$length$39706);($index$39712++)){var m$39721;(m$39721=temp$39700[$index$39712]);var t0$39726;var t1$39727;var i$39731;var arg$39732;(t0$39726=m$39721);if(((t0$39726 instanceof Array)&&(((t1$39727=t0$39726.length)),(t1$39727===2)))){(i$39731=t0$39726[0]);(arg$39732=t0$39726[1]);(e$39684[i$39731]=arg$39732);}else{$39597(m$39721);}}(e$39684["length"]=args$39671.length);(e$39684["name"]=["E"].concat(it$0$39651.tags).join("."));return e$39684;}else{$39597($39649$39661);}});($39617$39623.prototype["::check"]=function(e$39762){var it$0$39766;var self$39767;(it$0$39766=this);(self$39767=this);var tags$39777;if(((!e$39762)||(!$37409(Error)(e$39762)))){return false;}(tags$39777=(e$39762["::tags"]||[]));var temp$39788;(temp$39788=it$0$39766.tags);var $length$39794;($length$39794=temp$39788.length);var $index$39800;($index$39800=0);$39778:for(;($index$39800<$length$39794);($index$39800++)){var m$39809;(m$39809=temp$39788[$index$39800]);var tag$39817;(tag$39817=m$39809);if((tags$39777.indexOf(tag$39817)===-1)){return false;}else{false;}}return true;});($39617$39623.prototype["::deconstruct"]=function(e$39826){var it$0$39830;var self$39831;(it$0$39830=this);(self$39831=this);return e$39826.args;});$37429($39617$39623,$37429(function(){var accum$39842;(accum$39842=({}));(accum$39842["::name"]="$39617");return accum$39842;}(),function(){var accum$39846;(accum$39846=({}));(accum$39846["::egclass"]=true);return accum$39846;}()));return $39617$39623;}();
var $39597=function(value$39600,url$39601,start$39602,end$39603){var err$39607;(err$39607=$39616(["match"]).create("Could not find a match for value",({"value":value$39600})));if(url$39601){(err$39607["location"]=["location",url$39601,start$39602,end$39603]);}throw err$39607;};
var $39875=function(type$39878){return function(value$39882){var f$39886;(f$39886=type$39878[":::project"]);if((f$39886===(void 0))){(f$39886=type$39878["::project"]);if((f$39886===(void 0))){return [true,type$39878(value$39882)];}else{var rval$39899;(rval$39899=false);try{(rval$39899=[true,f$39886(value$39882)]);}catch(excv$39910){var e$39916;(e$39916=excv$39910);(rval$39899=[false,null]);}return rval$39899;}}else{return f$39886.call(type$39878,value$39882);}};};
var $39922=function($39924$39927,key$39928){var ph$39936;(ph$39936=$39924$39927);var $39930$39942;($39930$39942=ph$39936);var bridge$39932$39947;(bridge$39932$39947=$39930$39942);if(((bridge$39932$39947===null)||(bridge$39932$39947===(void 0)))){return false;}else{var x$39959;if((typeof($39930$39942)==="string")){(x$39959=$39930$39942);return (key$39928 in String.prototype);}else{var x$39964;if((typeof($39930$39942)==="number")){(x$39964=$39930$39942);return (key$39928 in Number.prototype);}else{var x$39969;(x$39969=$39930$39942);return (key$39928 in x$39969);}}}};var accum$39562;var accum$39566;var $37487$37505;var gensym$37506;var $37488$37507;var __lt____gt__$37508;var js_op_table2$37509;var js_op_table$37510;var Translator$37511;var translate$37512;($37487$37505=require("./util"));(gensym$37506=$37487$37505.gensym);($37488$37507=require("./pp"));(__lt____gt__$37508=$37488$37507["<>"]);(js_op_table2$37509=({"+":"+","-":"-","*":"*","/":"/","mod":"%","&.":"&","|.":"|","^.":"^","~":"~","and":"&&","or":"||","not":"!","==":"===","!=":"!==","===":"===","!==":"!==","<":"<",">":">","<=":"<=",">=":">=","<<":"<<",">>":">>",">>>":">>>","in":" in ","instanceof":" instanceof ","++":"++","--":"--"}));(js_op_table$37510=({"___plus":"+","___minus":"-","___times":"*","___div":"/","___mod":"%","___binxor":"^","___binand":"&","___binor":"|","___binnot":"~","___and":"&&","___or":"||","___not":"!","___is":"===","___isnt":"!==","___eq":"===","___neq":"!==","___lt":"<","___gt":">","___lte":"<=","___gte":">=","___shl":"<<","___shr":">>","___shr2":">>>","___in":" in ","___instanceof":" instanceof ","___plusplus":"++","___minusminus":"--"}));(Translator$37511=function(){var prelude$37555;var t0$37551;var $37542$37546;var it$0$37537;(it$0$37537=function(){if((!$37409(Translator$37511)(this))){return Object.create(Translator$37511.prototype);}else{return this;}}());($37542$37546=arguments);(t0$37551=$37542$37546.length);if(((t0$37551>=0)&&(t0$37551<=1))){(prelude$37555=function(){if((0>=t0$37551)){return null;}else{return $37542$37546[0];}}());(it$0$37537["cache"]=({}));(it$0$37537["prepend"]=[]);if(prelude$37555){it$0$37537.prepend.push(it$0$37537.translate($37446(prelude$37555),"stmt"));}}else{$39597($37542$37546);}return it$0$37537;});(Translator$37511.prototype["register_value"]=function(v$37579,id$37580){var temp$37611;var name$37620;var $37593$37598;var it$0$37584;var self$37585;(it$0$37584=this);(self$37585=this);($37593$37598=$37428(it$0$37584.cache,id$37580));if(($37593$37598===(void 0))){(temp$37611=["symbol",gensym$37506()]);(it$0$37584.cache[id$37580]=temp$37611);it$0$37584.prepend.push(it$0$37584.translate(["declare",temp$37611,$37446(v$37579)],"stmt"));return temp$37611;}else{(name$37620=$37593$37598);return name$37620;}});(Translator$37511.prototype["register_raw"]=function(raw$37626,id$37627){var temp$37658;var name$37667;var $37640$37645;var it$0$37631;var self$37632;(it$0$37631=this);(self$37632=this);($37640$37645=$37428(it$0$37631.cache,id$37627));if(($37640$37645===(void 0))){(temp$37658=["symbol",gensym$37506()]);(it$0$37631.cache[id$37627]=temp$37658);it$0$37631.prepend.push(it$0$37631.translate(["declare",temp$37658,["raw",raw$37626]],"stmt"));return temp$37658;}else{(name$37667=$37640$37645);return name$37667;}});(Translator$37511.prototype["dump_store"]=function(){var rval$37688;var it$0$37676;var self$37677;(it$0$37676=this);(self$37677=this);(rval$37688=it$0$37676.prepend.join("\n"));(it$0$37676["prepend"]=[]);return rval$37688;});(Translator$37511.prototype["mangle"]=function(name$37699){var i$37726;var tr$37716;var r$37717;var it$0$37703;var self$37704;(it$0$37703=this);(self$37704=this);(tr$37716=({"+":"__plus__","-":"__minus__","*":"__asterisk__","/":"__slash__","%":"__percent__","^":"__caret__","#":"__hash__","&":"__amp__","|":"__pipe__","@":"__at__","!":"__bang__","?":"__qmark__","=":"__equal__","<":"__lt__",">":"__gt__","~":"__tilde__",".":"__dot__",":":"__colon__"}));(r$37717=[]);(i$37726=0);$37715:for(;(i$37726<name$37699.length);(++i$37726)){var c$37735;(c$37735=$37428(name$37699,i$37726));r$37717.push(($37428(tr$37716,c$37735)||c$37735));}return r$37717.join("");});(Translator$37511.prototype["body"]=function(orig$37743,mode$37744){var t0$37768;var t1$37769;var t2$37770;var x$37809;var stmts$37820;var ret$37821;var other$37834;var $37760$37797;var b$37765;var trst$37766;var it$0$37748;var self$37749;(it$0$37748=this);(self$37749=this);(t0$37768=$39875(["multi"])(orig$37743));if((t0$37768[0]&&(((t1$37769=t0$37768[1])),(((t2$37770=t1$37769.length)),(t2$37770>=0))))){(b$37765=Array.prototype.slice.call(t1$37769,0));}else{$39597(orig$37743,"/home/olivier/git/earl-grey/src/translate-js.eg",3071,3075);}(trst$37766=function(stmt$37792){return it$0$37748.translate(stmt$37792,"stmt");});($37760$37797=mode$37744);if(($37760$37797==="expr")){(x$37809=["send",["lambda",[],orig$37743],["array"]]);return it$0$37748.translate(x$37809,mode$37744);}else{if(($37760$37797==="return")){(stmts$37820=b$37765.slice(0,-1));(ret$37821=$37428(b$37765,(b$37765.length-1)));return (stmts$37820.map(trst$37766).join("")+it$0$37748.translate(ret$37821,"return"));}else{if(($37760$37797==="stmt")){return b$37765.map(trst$37766).join("");}else{(other$37834=$37760$37797);throw $39616(["syntax","mode"]).create("Unknown mode",({"mode":mode$37744}));}}}});(Translator$37511.prototype["expr"]=function(x$37840,mode$37841){var other$37881;var $37854$37861;var it$0$37845;var self$37846;(it$0$37845=this);(self$37846=this);($37854$37861=mode$37841);if(($37854$37861==="expr")){return x$37840;}else{if(($37854$37861==="stmt")){return (x$37840+";");}else{if(($37854$37861==="return")){return (("return "+x$37840)+";");}else{(other$37881=$37854$37861);throw "OopsI";}}}});(Translator$37511.prototype["op"]=function(op$37887,a$37888,b$37889){var $37911$37925;var $37912$37926;var $37913$37927;var t0$37921;var t1$37922;var t2$37923;var $37907$37916;var e$37904;var it$0$37893;var self$37894;(it$0$37893=this);(self$37894=this);(e$37904=((($37907$37916=[a$37888,b$37889])),function(){if((($37911$37925=($37907$37916 instanceof Array))&&(((t0$37921=$37907$37916.length)),(($37913$37927=(t0$37921===2))&&(((t1$37922=$37907$37916[0])),((t1$37922 instanceof Array)&&(((t2$37923=t1$37922.length)),((t2$37923===1)&&(t1$37922[0]==="void"))))))))){$37907$37916[1];return (op$37887+it$0$37893.translate(b$37889,"expr"));}else{if(($37913$37927&&($37907$37916[0],(((t1$37922=$37907$37916[1])),((t1$37922 instanceof Array)&&(((t2$37923=t1$37922.length)),((t2$37923===1)&&(t1$37922[0]==="void")))))))){return (it$0$37893.translate(a$37888,"expr")+op$37887);}else{$37907$37916;return ((it$0$37893.translate(a$37888,"expr")+op$37887)+it$0$37893.translate(b$37889,"expr"));}}}()));return (("("+e$37904)+")");});(Translator$37511.prototype["translate"]=function(expr$37970,mode$37971){var repl$38096;var it$0$38135;var it$0$38129;var it$0$38123;var it$0$38117;var bridge$38077$38154;var bridge$38076$38147;var other$38169;var id$38163;var bridge$38075$38087;var $38070$38082;var r$38067;var t0$38208;var t0$38215;var trf$38235;var trmsg$38236;var trf$38280;var trmsg$38281;var trf$38295;var trmsg$38296;var otherwise$38290;var $38262$38267;var x$38356;var x$38346;var $38329$38341;var $38330$38342;var $38331$38343;var t0$38339;var $38325$38334;var $index$38396;var $length$38390;var temp$38384;var acc$38378;var trf$38366;var trargs$38367;var op$38322;var code$38435;var code$38449;var t0$38427;var t1$38428;var trf$38456;var trmsg$38457;var codevar$38425;var f$38476;var r$38471;var f$38551;var f$38597;var v$38591;var all_strings$38493;var r$38494;var $index$38684;var $length$38678;var temp$38672;var acc$38666;var a$38651;var b$38652;var name$38644;var a$38748;var b$38749;var other$38743;var $38726$38731;var a$38786;var b$38787;var c$38788;var other$38780;var $38763$38768;var a$38841;var other$38837;var bridge$38816$38825;var $38814$38820;var a$38879;var b$38880;var other$38874;var bridge$38853$38862;var $38851$38857;var a$38908;var b$38909;var c$38910;var a$38929;var b$38930;var $index$39040;var $length$39034;var temp$39028;var acc$39022;var $index$39086;var $length$39080;var temp$39074;var acc$39068;var xs$39014;var $38952$39002;var $38948$38996;var isdecl$38953;var $index$39156;var $length$39150;var temp$39144;var acc$39138;var decls$39130;var f$39189;var r$39184;var other$39311;var $39294$39299;var a$39341;var b$39342;var other$39336;var $39319$39324;var a$39381;var b$39382;var c$39383;var d$39384;var other$39374;var $39357$39362;var a$39427;var b$39428;var c$39429;var other$39421;var $39404$39409;var t0$39473;var t0$39481;var a$39519;var b$39520;var other$39514;var $39497$39502;var other$39548;var t0$39535;var $39491$39530;var r$39494;var other$39557;var x$39552;var attempt$39441;var v$39442;var body$39443;var finally$39444;var x$39399;var y$39400;var body$39401;var x$39351;var y$39352;var z$39353;var body$39354;var test$39315;var body$39316;var label$39280;var body$39281;var value$39275;var value$39270;var value$39265;var label$39250;var label$39235;var value$39230;var args$39179;var vars$39124;var body$39125;var s$39119;var args$39114;var args$38943;var lhs$38922;var rhs$38923;var obj$38889;var msg$38890;var rhs$38891;var binding$38847;var value$38848;var binding$38800;var test$38758;var pos$38759;var neg$38760;var test$38710;var pos$38711;var bindings$38638;var body$38639;var args$38487;var args$38466;var f$38419;var msg$38420;var f$38305;var args$38306;var f$38245;var msg$38246;var s$38247;var f$38199;var msg$38200;var f$38174;var v$38062;var s$38048;var $38023$38042;var $38024$38043;var $38025$38044;var $38026$38045;var t0$38034;var t1$38035;var t2$38036;var t3$38037;var t4$38038;var bridge$37990$38039;var bridge$38020$38040;var $37984$38029;var it$0$37975;var self$37976;(it$0$37975=this);(self$37976=this);($37984$38029=expr$37970);if((($38023$38042=($37984$38029 instanceof Array))&&(((t0$38034=$37984$38029.length)),((t0$38034===2)&&($37984$38029[0]==="symbol"))))){(s$38048=$37984$38029[1]);return it$0$37975.expr(it$0$37975.mangle(s$38048),mode$37971);}else{if(($38023$38042&&((t0$38034===1)&&($37984$38029[0]==="void")))){return it$0$37975.expr("null",mode$37971);}else{if(($38023$38042&&((t0$38034===2)&&($37984$38029[0]==="value")))){(v$38062=$37984$38029[1]);(r$38067=((($38070$38082=v$38062)),function(){if((typeof($38070$38082)==="string")){(repl$38096=({"\"":"\\\"","\n":"\\n","\\":"\\\\"}));(v$38062=v$38062.replace(RegExp("((?:(?:\"|\\\\)|\n))","g"),function(m$38104){return $37428(repl$38096,m$38104);}));return (("\""+v$38062)+"\"");}else{if(($38070$38082===(void 0))){return "(void 0)";}else{if($37409(RegExp)($38070$38082)){(it$0$38117=String(v$38062));(it$0$38123=it$0$38117.slice(1,-1));(it$0$38129=it$0$38123.replace(RegExp("/","g"),"\\/"));(it$0$38135=it$0$38129.replace(RegExp("\n","g"),"\\n"));return "/".concat(it$0$38135).concat("/");}else{(bridge$38075$38087=$38070$38082);if(((((bridge$38076$38147=bridge$38075$38087)),((((bridge$38077$38154=bridge$38076$38147)),((typeof(bridge$38077$38154)==="number")||(bridge$38077$38154===true)))||(bridge$38076$38147===false)))||(bridge$38075$38087===null))){return String(v$38062);}else{if(($39922($38070$38082,"::id")&&((id$38163=$38070$38082["::id"]),id$38163))){return it$0$37975.translate(it$0$37975.register_value(v$38062,id$38163),mode$37971);}else{(other$38169=$38070$38082);throw $39616(["cannot_serialize"]).create("Cannot serialize value",({"value":v$38062}));}}}}}}()));return it$0$37975.expr(r$38067,mode$37971);}else{if(($38023$38042&&(($38025$38044=(t0$38034===3))&&(($38026$38045=($37984$38029[0]==="send"))&&(((t1$38035=$37984$38029[1])),((t1$38035 instanceof Array)&&(((t2$38036=t1$38035.length)),((t2$38036===2)&&((t1$38035[0]==="variable")&&((t1$38035[1]==="___node")&&(((t3$38037=$37984$38029[2])),((t3$38037 instanceof Array)&&(((t4$38038=t3$38037.length)),((t4$38038===2)&&(t3$38037[0]==="value"))))))))))))))){(f$38174=t3$38037[1]);return f$38174;}else{if(($38026$38045&&(((bridge$37990$38039=$37984$38029[1])),((((bridge$37990$38039 instanceof Array)&&(((t0$38208=bridge$37990$38039.length)),((t0$38208===2)&&((bridge$37990$38039[0]==="symbol")&&(bridge$37990$38039[1]==="___js_fetch")))))||((bridge$37990$38039 instanceof Array)&&(((t0$38215=bridge$37990$38039.length)),((t0$38215===2)&&((bridge$37990$38039[0]==="variable")&&(bridge$37990$38039[1]==="___js_fetch"))))))&&(((t1$38035=$37984$38029[2])),((t1$38035 instanceof Array)&&(((t2$38036=t1$38035.length)),((t2$38036===3)&&(t1$38035[0]==="array"))))))))){(f$38199=t1$38035[1]);(msg$38200=t1$38035[2]);(trf$38235=it$0$37975.translate(f$38199,"expr"));(trmsg$38236=it$0$37975.translate(msg$38200,"expr"));return it$0$37975.expr((((trf$38235+"[")+trmsg$38236)+"]"),mode$37971);}else{if(($38026$38045&&((f$38245=$37984$38029[1]),(((t1$38035=$37984$38029[2])),((msg$38246=t1$38035),((t1$38035 instanceof Array)&&(((t2$38036=t1$38035.length)),((t2$38036===2)&&(t1$38035[0]==="value"))))))))){(s$38247=t1$38035[1]);($38262$38267=null);$38262$38267;if(((typeof(s$38247)==="string")&&s$38247.match(RegExp("(?:^(?:[a-zA-Z_$]+)$)","")))){(trf$38280=it$0$37975.translate(f$38245,"expr"));(trmsg$38281=it$0$37975.translate(["symbol",s$38247],"expr"));return it$0$37975.expr(((trf$38280+".")+trmsg$38281),mode$37971);}else{(otherwise$38290=$38262$38267);(trf$38295=it$0$37975.translate(f$38245,"expr"));(trmsg$38296=it$0$37975.translate(msg$38246,"expr"));return it$0$37975.expr((((trf$38295+"[")+trmsg$38296)+"]"),mode$37971);}}else{if(($38026$38045&&((f$38305=$37984$38029[1]),(((t1$38035=$37984$38029[2])),((t1$38035 instanceof Array)&&(((t2$38036=t1$38035.length)),((t2$38036>=1)&&(t1$38035[0]==="array")))))))){(args$38306=Array.prototype.slice.call(t1$38035,1));(op$38322=((($38325$38334=f$38305)),function(){if((($38329$38341=($38325$38334 instanceof Array))&&(((t0$38339=$38325$38334.length)),(($38331$38343=(t0$38339===2))&&($38325$38334[0]==="symbol"))))){(x$38346=$38325$38334[1]);return $37428(js_op_table$37510,x$38346);}else{if(($38331$38343&&($38325$38334[0]==="variable"))){(x$38356=$38325$38334[1]);return $37428(js_op_table2$37509,x$38356);}else{$38325$38334;return null;}}}()));if(op$38322){return it$0$37975.expr(it$0$37975.op(op$38322,args$38306[0],args$38306[1]),mode$37971);}else{(trf$38366=it$0$37975.translate(f$38305,"expr"));(trargs$38367=(((acc$38378=[])),(((temp$38384=args$38306)),((($length$38390=temp$38384.length)),((($index$38396=0)),function(){$38373:for(;($index$38396<$length$38390);($index$38396++)){var x$38413;var m$38405;(m$38405=temp$38384[$index$38396]);(x$38413=m$38405);acc$38378.push(it$0$37975.translate(x$38413,"expr"));}}()))),acc$38378));return it$0$37975.expr((((trf$38366+"(")+trargs$38367.join(","))+")"),mode$37971);}}else{if($38026$38045){(f$38419=$37984$38029[1]);(msg$38420=$37984$38029[2]);(t0$38427=(((code$38435="(function(o,m){if(typeof(m)==='string'||typeof(m)==='number'){return o[m];}else{return o['::send'](m);}})")),it$0$37975.register_raw(code$38435,"~send")));if(((t0$38427 instanceof Array)&&(((t1$38428=t0$38427.length)),((t1$38428===2)&&(t0$38427[0]==="symbol"))))){(codevar$38425=t0$38427[1]);}else{$39597((((code$38449="(function(o,m){if(typeof(m)==='string'||typeof(m)==='number'){return o[m];}else{return o['::send'](m);}})")),it$0$37975.register_raw(code$38449,"~send")),"/home/olivier/git/earl-grey/src/translate-js.eg",6698,6908);}(trf$38456=it$0$37975.translate(f$38419,"expr"));(trmsg$38457=it$0$37975.translate(msg$38420,"expr"));return it$0$37975.expr((((((codevar$38425+"(")+trf$38456)+",")+trmsg$38457)+")"),mode$37971);}else{if(($38023$38042&&(($38025$38044=(t0$38034>=1))&&($37984$38029[0]==="array")))){(args$38466=Array.prototype.slice.call($37984$38029,1));(r$38471=(((f$38476=function(x$38481){return it$0$37975.translate(x$38481,"expr");})),(("["+args$38466.map(f$38476).join(","))+"]")));return it$0$37975.expr(r$38471,mode$37971);}else{if(($38025$38044&&($37984$38029[0]==="object"))){(args$38487=Array.prototype.slice.call($37984$38029,1));(all_strings$38493=args$38487.every(function($38498$38501){var t0$38509;var t1$38510;var other$38544;var v$38534;var t0$38530;var $38503$38525;var ph$38506;var y$38507;(t0$38509=$38498$38501);if(((t0$38509 instanceof Array)&&(((t1$38510=t0$38509.length)),((t1$38510===3)&&(t0$38509[0]==="array"))))){(ph$38506=t0$38509[1]);(y$38507=t0$38509[2]);}else{$39597($38498$38501);}($38503$38525=ph$38506);if((($38503$38525 instanceof Array)&&(((t0$38530=$38503$38525.length)),((t0$38530===2)&&($38503$38525[0]==="value"))))){(v$38534=$38503$38525[1]);return true;}else{(other$38544=$38503$38525);return false;}}));(r$38494=function(){if(all_strings$38493){(f$38551=function($38555$38558){var t0$38563;var t1$38564;var a$38580;var b$38581;var x$38560;var y$38561;(t0$38563=$38555$38558);if(((t0$38563 instanceof Array)&&(((t1$38564=t0$38563.length)),((t1$38564===3)&&(t0$38563[0]==="array"))))){(x$38560=t0$38563[1]);(y$38561=t0$38563[2]);}else{$39597($38555$38558);}(a$38580=it$0$37975.translate(x$38560,"expr"));(b$38581=it$0$37975.translate(y$38561,"expr"));return ((a$38580+":")+b$38581);});return (("({"+args$38487.map(f$38551).join(","))+"})");}else{(v$38591=gensym$37506());(f$38597=function($38601$38604){var t0$38609;var t1$38610;var a$38626;var b$38627;var x$38606;var y$38607;(t0$38609=$38601$38604);if(((t0$38609 instanceof Array)&&(((t1$38610=t0$38609.length)),((t1$38610===3)&&(t0$38609[0]==="array"))))){(x$38606=t0$38609[1]);(y$38607=t0$38609[2]);}else{$39597($38601$38604);}(a$38626=it$0$37975.translate(x$38606,"expr"));(b$38627=it$0$37975.translate(y$38607,"expr"));return (((((v$38591+"[")+a$38626)+"]=")+b$38627)+";");});return ((((((("(function(){"+"var ")+v$38591)+"={};")+args$38487.map(f$38597).join(""))+";return ")+v$38591)+";}())");}}());return it$0$37975.expr(r$38494,mode$37971);}else{if(($38023$38042&&((t0$38034===3)&&($37984$38029[0]==="lambda")))){(bindings$38638=$37984$38029[1]);(body$38639=$37984$38029[2]);(name$38644=function(){if($37409(RegExp("^[$_a-zA-Z]*$",""))(expr$37970.name)){return (expr$37970.name+" ");}else{return "";}}());(a$38651=(((acc$38666=[])),(((temp$38672=bindings$38638)),((($length$38678=temp$38672.length)),((($index$38684=0)),function(){$38661:for(;($index$38684<$length$38678);($index$38684++)){var x$38701;var m$38693;(m$38693=temp$38672[$index$38684]);(x$38701=m$38693);acc$38666.push(it$0$37975.translate(x$38701,"expr"));}}()))),acc$38666).join(","));(b$38652=it$0$37975.body(body$38639,"return"));return it$0$37975.expr((((((("function"+name$38644)+"(")+a$38651)+"){")+b$38652)+"}"),mode$37971);}else{if(($38023$38042&&(($38025$38044=(t0$38034===4))&&(($38026$38045=($37984$38029[0]==="if"))&&((test$38710=$37984$38029[1]),((pos$38711=$37984$38029[2]),(((t1$38035=$37984$38029[3])),((t1$38035 instanceof Array)&&(((t2$38036=t1$38035.length)),((t2$38036===2)&&((t1$38035[0]==="value")&&(t1$38035[1]===(void 0))))))))))))){($38726$38731=mode$37971);if(($38726$38731==="expr")){return it$0$37975.body(expr$37970,"expr");}else{(other$38743=$38726$38731);(a$38748=it$0$37975.translate(test$38710,"expr"));(b$38749=it$0$37975.translate(pos$38711,mode$37971));return (((("if("+a$38748)+"){")+b$38749)+"}");}}else{if($38026$38045){(test$38758=$37984$38029[1]);(pos$38759=$37984$38029[2]);(neg$38760=$37984$38029[3]);($38763$38768=mode$37971);if(($38763$38768==="expr")){return it$0$37975.body(expr$37970,"expr");}else{(other$38780=$38763$38768);(a$38786=it$0$37975.translate(test$38758,"expr"));(b$38787=it$0$37975.translate(pos$38759,mode$37971));(c$38788=it$0$37975.translate(neg$38760,mode$37971));return (((((("if("+a$38786)+"){")+b$38787)+"}else{")+c$38788)+"}");}}else{if(($38023$38042&&(($38025$38044=(t0$38034===3))&&(($38026$38045=($37984$38029[0]==="declare"))&&((binding$38800=$37984$38029[1]),(((t1$38035=$37984$38029[2])),((t1$38035 instanceof Array)&&(((t2$38036=t1$38035.length)),((t2$38036===2)&&((t1$38035[0]==="value")&&(t1$38035[1]===(void 0)))))))))))){($38814$38820=mode$37971);(bridge$38816$38825=$38814$38820);if(((bridge$38816$38825==="expr")||(bridge$38816$38825==="return"))){throw "Invalid in expr ctx";}else{(other$38837=$38814$38820);(a$38841=it$0$37975.translate(binding$38800,"expr"));return (("var "+a$38841)+";");}}else{if($38026$38045){(binding$38847=$37984$38029[1]);(value$38848=$37984$38029[2]);($38851$38857=mode$37971);(bridge$38853$38862=$38851$38857);if(((bridge$38853$38862==="expr")||(bridge$38853$38862==="return"))){throw "Invalid in expr ctx";}else{(other$38874=$38851$38857);(a$38879=it$0$37975.translate(binding$38847,"expr"));(b$38880=it$0$37975.translate(value$38848,"expr"));return (((("var "+a$38879)+"=")+b$38880)+";");}}else{if(($38025$38044&&(($38026$38045=($37984$38029[0]==="assign"))&&(((t1$38035=$37984$38029[1])),((t1$38035 instanceof Array)&&(((t2$38036=t1$38035.length)),((t2$38036===3)&&(t1$38035[0]==="send")))))))){(obj$38889=t1$38035[1]);(msg$38890=t1$38035[2]);(rhs$38891=$37984$38029[2]);(a$38908=it$0$37975.translate(obj$38889,"expr"));(b$38909=it$0$37975.translate(msg$38890,"expr"));(c$38910=it$0$37975.translate(rhs$38891,"expr"));return it$0$37975.expr((((((("("+a$38908)+"[")+b$38909)+"]=")+c$38910)+")"),mode$37971);}else{if($38026$38045){(lhs$38922=$37984$38029[1]);(rhs$38923=$37984$38029[2]);(a$38929=it$0$37975.translate(lhs$38922,"expr"));(b$38930=it$0$37975.translate(rhs$38923,"expr"));return it$0$37975.expr((((("("+a$38929)+"=")+b$38930)+")"),mode$37971);}else{if(($38023$38042&&((t0$38034===1)&&($37984$38029[0]==="multi")))){return "";}else{if(($38023$38042&&(($38025$38044=(t0$38034>=1))&&($37984$38029[0]==="multi")))){(args$38943=Array.prototype.slice.call($37984$38029,1));(isdecl$38953=function($38957$38960){var other$38991;var variable$38980;var value$38981;var t0$38976;var $38962$38971;var ph$38965;(ph$38965=$38957$38960);($38962$38971=ph$38965);if((($38962$38971 instanceof Array)&&(((t0$38976=$38962$38971.length)),((t0$38976===3)&&($38962$38971[0]==="declare"))))){(variable$38980=$38962$38971[1]);(value$38981=$38962$38971[2]);return true;}else{(other$38991=$38962$38971);return false;}});($38948$38996=null);$38948$38996;if((args$38943.length===1)){return it$0$37975.translate(args$38943[0],mode$37971);}else{if(((mode$37971==="expr")&&(!args$38943.some(isdecl$38953)))){(xs$39014=(((acc$39022=[])),(((temp$39028=args$38943)),((($length$39034=temp$39028.length)),((($index$39040=0)),function(){$39017:for(;($index$39040<$length$39034);($index$39040++)){var x$39057;var m$39049;(m$39049=temp$39028[$index$39040]);(x$39057=m$39049);acc$39022.push(it$0$37975.translate(x$39057,"expr"));}}()))),acc$39022));(xs$39014=(((acc$39068=[])),(((temp$39074=xs$39014)),((($length$39080=temp$39074.length)),((($index$39086=0)),function(){$39063:for(;($index$39086<$length$39080);($index$39086++)){var x$39103;var m$39095;(m$39095=temp$39074[$index$39086]);(x$39103=m$39095);if((x$39103!=="")){acc$39068.push(x$39103);}else{false;}}}()))),acc$39068));return (("("+xs$39014.join(","))+")");}else{return it$0$37975.body(expr$37970,mode$37971);}}}else{if(($38025$38044&&($37984$38029[0]==="splice"))){(args$39114=Array.prototype.slice.call($37984$38029,1));return it$0$37975.translate(["multi"].concat(args$39114),mode$37971);}else{if(($38023$38042&&((t0$38034===2)&&($37984$38029[0]==="variable")))){(s$39119=$37984$38029[1]);return it$0$37975.expr(it$0$37975.mangle(s$39119),mode$37971);}else{if(($38023$38042&&((t0$38034===3)&&($37984$38029[0]==="scope")))){(vars$39124=$37984$38029[1]);(body$39125=$37984$38029[2]);(decls$39130=(((acc$39138=[])),(((temp$39144=vars$39124)),((($length$39150=temp$39144.length)),((($index$39156=0)),function(){$39133:for(;($index$39156<$length$39150);($index$39156++)){var v$39173;var m$39165;(m$39165=temp$39144[$index$39156]);(v$39173=m$39165);acc$39138.push(["declare",v$39173,["value",(void 0)]]);}}()))),acc$39138));return it$0$37975.translate(["multi"].concat(decls$39130).concat([body$39125]),mode$37971);}else{if(($38023$38042&&((t0$38034>=1)&&($37984$38029[0]==="object2")))){(args$39179=Array.prototype.slice.call($37984$38029,1));(r$39184=(((f$39189=function($39193$39196){var t0$39201;var t1$39202;var a$39218;var b$39219;var x$39198;var y$39199;(t0$39201=$39193$39196);if(((t0$39201 instanceof Array)&&(((t1$39202=t0$39201.length)),(t1$39202===2)))){(x$39198=t0$39201[0]);(y$39199=t0$39201[1]);}else{$39597($39193$39196);}(a$39218=it$0$37975.translate(x$39198,"expr"));(b$39219=it$0$37975.translate(y$39199,"expr"));return ((a$39218+":")+b$39219);})),(("({"+args$39179.map(f$39189).join(","))+"})")));return it$0$37975.expr(r$39184,mode$37971);}else{if(($38023$38042&&((t0$38034===2)&&($37984$38029[0]==="js_new")))){(value$39230=$37984$38029[1]);return it$0$37975.expr((("(new "+it$0$37975.translate(value$39230,"expr"))+")"),mode$37971);}else{if(($38023$38042&&(($38025$38044=((t0$38034>=1)&&(t0$38034<=2)))&&(($37984$38029[0]==="js_break")&&(((t1$38035=function(){if((1>=t0$38034)){return ["value",null];}else{return $37984$38029[1];}}())),((t1$38035 instanceof Array)&&(((t2$38036=t1$38035.length)),((t2$38036===2)&&(t1$38035[0]==="value"))))))))){(label$39235=t1$38035[1]);if((mode$37971==="expr")){throw "Invalid break in ctx";}else{return (("break"+function(){if(label$39235){return (" "+label$39235);}else{return "";}}())+";");}}else{if(($38025$38044&&(($37984$38029[0]==="js_continue")&&(((t1$38035=function(){if((1>=t0$38034)){return ["value",null];}else{return $37984$38029[1];}}())),((t1$38035 instanceof Array)&&(((t2$38036=t1$38035.length)),((t2$38036===2)&&(t1$38035[0]==="value")))))))){(label$39250=t1$38035[1]);if((mode$37971==="expr")){throw "Invalid continue in ctx";}else{return (("continue"+function(){if(label$39250){return (" "+label$39250);}else{return "";}}())+";");}}else{if(($38023$38042&&(($38025$38044=(t0$38034===2))&&($37984$38029[0]==="js_return")))){(value$39265=$37984$38029[1]);if((mode$37971==="expr")){throw "Invalid return in ctx";}else{return (("return "+it$0$37975.translate(value$39265,"expr"))+";");}}else{if(($38025$38044&&($37984$38029[0]==="js_delete"))){(value$39270=$37984$38029[1]);if((mode$37971==="expr")){throw "Invalid delete in ctx";}else{return (("delete "+it$0$37975.translate(value$39270,"expr"))+";");}}else{if(($38025$38044&&($37984$38029[0]==="js_throw"))){(value$39275=$37984$38029[1]);if((mode$37971==="expr")){return (("function(){throw "+it$0$37975.translate(value$39275,"expr"))+";}()");}else{return (("throw "+it$0$37975.translate(value$39275,"expr"))+";");}}else{if(($38023$38042&&(($38025$38044=(t0$38034===3))&&(($37984$38029[0]==="js_label")&&(((t1$38035=$37984$38029[1])),((t1$38035 instanceof Array)&&(((t2$38036=t1$38035.length)),((t2$38036===2)&&(t1$38035[0]==="value"))))))))){(label$39280=t1$38035[1]);(body$39281=$37984$38029[2]);($39294$39299=mode$37971);if(($39294$39299==="expr")){return it$0$37975.body(expr$37970,"expr");}else{(other$39311=$39294$39299);return ((label$39280+":")+it$0$37975.translate(body$39281,other$39311));}}else{if(($38025$38044&&($37984$38029[0]==="js_while"))){(test$39315=$37984$38029[1]);(body$39316=$37984$38029[2]);($39319$39324=mode$37971);if(($39319$39324==="expr")){return it$0$37975.body(expr$37970,"expr");}else{(other$39336=$39319$39324);(a$39341=it$0$37975.translate(test$39315,"expr"));(b$39342=it$0$37975.translate(body$39316,"stmt"));return (((("while("+a$39341)+"){")+b$39342)+"}");}}else{if(($38023$38042&&((t0$38034===5)&&($37984$38029[0]==="js_for")))){(x$39351=$37984$38029[1]);(y$39352=$37984$38029[2]);(z$39353=$37984$38029[3]);(body$39354=$37984$38029[4]);($39357$39362=mode$37971);if(($39357$39362==="expr")){return it$0$37975.body(expr$37970,"expr");}else{(other$39374=$39357$39362);(a$39381=it$0$37975.translate(x$39351,"expr"));(b$39382=it$0$37975.translate(y$39352,"expr"));(c$39383=it$0$37975.translate(z$39353,"expr"));(d$39384=it$0$37975.translate(body$39354,"stmt"));return (((((((("for("+a$39381)+";")+b$39382)+";")+c$39383)+"){")+d$39384)+"}");}}else{if(($38023$38042&&(($38025$38044=(t0$38034===4))&&($37984$38029[0]==="js_for_in")))){(x$39399=$37984$38029[1]);(y$39400=$37984$38029[2]);(body$39401=$37984$38029[3]);($39404$39409=mode$37971);if(($39404$39409==="expr")){return it$0$37975.body(expr$37970,"expr");}else{(other$39421=$39404$39409);(a$39427=it$0$37975.translate(x$39399,"expr"));(b$39428=it$0$37975.translate(y$39400,"expr"));(c$39429=it$0$37975.translate(body$39401,"stmt"));return (((((("for("+a$39427)+" in ")+b$39428)+"){")+c$39429)+"}");}}else{if(($38025$38044&&(($37984$38029[0]==="js_try")&&((attempt$39441=$37984$38029[1]),(((t1$38035=$37984$38029[2])),((t1$38035 instanceof Array)&&(((t2$38036=t1$38035.length)),((t2$38036===3)&&((t1$38035[0]==="lambda")&&(((t3$38037=t1$38035[1])),((t3$38037 instanceof Array)&&(((t4$38038=t3$38037.length)),((t4$38038===1)&&(((bridge$38020$38040=t3$38037[0])),(((bridge$38020$38040 instanceof Array)&&(((t0$39473=bridge$38020$38040.length)),((t0$39473===2)&&((bridge$38020$38040[0]==="symbol")&&((v$39442=bridge$38020$38040[1]),true)))))||((bridge$38020$38040 instanceof Array)&&(((t0$39481=bridge$38020$38040.length)),((t0$39481===2)&&((bridge$38020$38040[0]==="variable")&&((v$39442=bridge$38020$38040[1]),true)))))))))))))))))))){(body$39443=t1$38035[2]);(finally$39444=$37984$38029[3]);(r$39494=((($39497$39502=mode$37971)),function(){if(($39497$39502==="expr")){return it$0$37975.body(expr$37970,"expr");}else{(other$39514=$39497$39502);(a$39519=it$0$37975.translate(attempt$39441,"stmt"));(b$39520=it$0$37975.translate(body$39443,"stmt"));return (((((("try{"+a$39519)+"}catch(")+v$39442)+"){")+b$39520)+"}");}}()));($39491$39530=finally$39444);if((($39491$39530 instanceof Array)&&(((t0$39535=$39491$39530.length)),((t0$39535===1)&&($39491$39530[0]==="void"))))){return r$39494;}else{(other$39548=$39491$39530);return (((r$39494+"finally{")+it$0$37975.translate(other$39548,"stmt"))+"}");}}else{if(($38023$38042&&((t0$38034===2)&&($37984$38029[0]==="raw")))){(x$39552=$37984$38029[1]);return x$39552;}else{(other$39557=$37984$38029);throw other$39557;}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}});$37429(Translator$37511,$37429(((accum$39562=({})),((accum$39562["::name"]="Translator"),accum$39562)),((accum$39566=({})),((accum$39566["::egclass"]=true),accum$39566))));Translator$37511;(translate$37512=function(expr$39573,mode$39574){var tr$39579;var t$39580;(tr$39579=Translator$37511());(t$39580=tr$39579.translate(expr$39573,mode$39574));return (tr$39579.dump_store()+t$39580);});(exports["Translator"]=Translator$37511);(exports["translate"]=translate$37512);

},{"./pp":15,"./util":18}],18:[function(require,module,exports){
var $40207=function(type$40210){var f$40214;(f$40214=type$40210["::check"]);if((f$40214===(void 0))){return function(value$40220){return (value$40220 instanceof type$40210);};}else{return function(value$40224){return f$40214.call(type$40210,value$40224);};}};
var $40226=(function(o,m){if(typeof(m)==='string'||typeof(m)==='number'){return o[m];}else{return o['::send'](m);}});
var $40227=function(dest$40230,values$40231){var k$40236;(k$40236=null);$40234:for(k$40236 in values$40231){if(values$40231.hasOwnProperty(k$40236)){(dest$40230[k$40236]=values$40231[k$40236]);}}return dest$40230;};
var $40244=function($40246$40249){var ph$40255;(ph$40255=$40246$40249);var $40251$40261;($40251$40261=ph$40255);var bridge$40253$40266;var x$40270;(bridge$40253$40266=$40251$40261);if((((typeof(bridge$40253$40266)==="string")&&((x$40270=bridge$40253$40266),true))||((typeof(bridge$40253$40266)==="number")&&((x$40270=bridge$40253$40266),true)))){return ["value",x$40270];}else{var other$40281;(other$40281=$40251$40261);return other$40281["::serialize_ast"]();}};
var send$39981;(send$39981=function(obj$39988,$39985$39989){var ph$39995;var msg$39996;var t0$39998;(t0$39998=$39985$39989);(msg$39996=t0$39998);(ph$39995=t0$39998);var $39991$40007;($39991$40007=ph$39995);var bridge$39993$40012;(bridge$39993$40012=$39991$40007);if(((typeof(bridge$39993$40012)==="string")||(typeof(bridge$39993$40012)==="number"))){return obj$39988[msg$39996];}else{var other$40024;(other$40024=$39991$40007);return obj$39988["::send"](msg$39996);}});(Array[":::project"]=function($40030$40033){var ph$40038;var value$40039;var t0$40041;(t0$40041=$40030$40033);(value$40039=t0$40041);(ph$40038=t0$40041);var $40035$40050;($40035$40050=ph$40038);if($40207(Array)($40035$40050)){return [true,value$40039];}else{$40035$40050;return [true,[value$40039]];}});(Array.prototype["::check"]=function(value$40068){if((value$40068 instanceof Array)){var i$40074;(i$40074=0);$40071:for(;(i$40074<this.length);(i$40074++)){if(($40226(this,i$40074)!==$40226(value$40068,i$40074))){return false;}}return true;}else{return false;}});(Array.prototype["::clone"]=function(){return $40227(this.slice(0),this);});(Array.prototype[":::project"]=function(value$40093){if((value$40093 instanceof Array)){var i$40099;(i$40099=0);$40096:for(;(i$40099<this.length);(i$40099++)){if(($40226(this,i$40099)!==$40226(value$40093,i$40099))){return [true,[value$40093]];}}return [true,value$40093.slice(this.length)];}else{return [true,[value$40093]];}});(Array.prototype["::serialize_ast"]=function(){return ["array"].concat(this.map($40244));});(RegExp.prototype["::check"]=function($40117$40120){var ph$40125;(ph$40125=$40117$40120);var $40122$40131;($40122$40131=ph$40125);var value$40139;if((typeof($40122$40131)==="string")){(value$40139=$40122$40131);if(value$40139.match(this)){return true;}else{return false;}}else{var other$40144;(other$40144=$40122$40131);return false;}});(RegExp.prototype[":::project"]=function($40150$40153){var ph$40158;(ph$40158=$40150$40153);var $40155$40164;($40155$40164=ph$40158);var value$40172;if((typeof($40155$40164)==="string")){(value$40172=$40155$40164);var $40175$40180;($40175$40180=value$40172.match(this));var m$40188;if(($40175$40180===null)){(m$40188=$40175$40180);return [false,null];}else{var m$40193;(m$40193=$40175$40180);return [true,m$40193];}}else{var other$40197;(other$40197=$40155$40164);return [false,null];}});(Function.prototype["::send"]=function(args$40204){return this.apply(this,args$40204);});
var $41249=function(arr$41252){var results$41258;var l$41259;(results$41258=[]);(l$41259=arr$41252.length);var i$41268;(i$41268=0);$41257:for(;(i$41268<l$41259);(i$41268++)){results$41258.push([i$41268,$40226(arr$41252,i$41268)]);}return results$41258;};
var $41016=function(){var $41017$41023;($41017$41023=function(tags$41028){var it$0$41031;(it$0$41031=function(){if((!$40207($41017$41023)(this))){return Object.create($41017$41023.prototype);}else{return this;}}());(it$0$41031["tags"]=tags$41028);return it$0$41031;});($41017$41023.prototype["create"]=function(){var it$0$41051;var self$41052;(it$0$41051=this);(self$41052=this);var $41049$41061;($41049$41061=arguments);var t0$41066;var message$41070;var args$41071;(t0$41066=$41049$41061.length);if((t0$41066>=0)){(message$41070=function(){if((0>=t0$41066)){return "";}else{return $41049$41061[0];}}());(args$41071=Array.prototype.slice.call($41049$41061,1));var e$41084;(e$41084=Error(message$41070));(e$41084["::tags"]=it$0$41051.tags);(e$41084["args"]=args$41071);var temp$41100;(temp$41100=$41249(args$41071));var $length$41106;($length$41106=temp$41100.length);var $index$41112;($index$41112=0);$41085:for(;($index$41112<$length$41106);($index$41112++)){var m$41121;(m$41121=temp$41100[$index$41112]);var t0$41126;var t1$41127;var i$41131;var arg$41132;(t0$41126=m$41121);if(((t0$41126 instanceof Array)&&(((t1$41127=t0$41126.length)),(t1$41127===2)))){(i$41131=t0$41126[0]);(arg$41132=t0$41126[1]);(e$41084[i$41131]=arg$41132);}else{$40997(m$41121);}}(e$41084["length"]=args$41071.length);(e$41084["name"]=["E"].concat(it$0$41051.tags).join("."));return e$41084;}else{$40997($41049$41061);}});($41017$41023.prototype["::check"]=function(e$41162){var it$0$41166;var self$41167;(it$0$41166=this);(self$41167=this);var tags$41177;if(((!e$41162)||(!$40207(Error)(e$41162)))){return false;}(tags$41177=(e$41162["::tags"]||[]));var temp$41188;(temp$41188=it$0$41166.tags);var $length$41194;($length$41194=temp$41188.length);var $index$41200;($index$41200=0);$41178:for(;($index$41200<$length$41194);($index$41200++)){var m$41209;(m$41209=temp$41188[$index$41200]);var tag$41217;(tag$41217=m$41209);if((tags$41177.indexOf(tag$41217)===-1)){return false;}else{false;}}return true;});($41017$41023.prototype["::deconstruct"]=function(e$41226){var it$0$41230;var self$41231;(it$0$41230=this);(self$41231=this);return e$41226.args;});$40227($41017$41023,$40227(function(){var accum$41242;(accum$41242=({}));(accum$41242["::name"]="$41017");return accum$41242;}(),function(){var accum$41246;(accum$41246=({}));(accum$41246["::egclass"]=true);return accum$41246;}()));return $41017$41023;}();
var $40997=function(value$41000,url$41001,start$41002,end$41003){var err$41007;(err$41007=$41016(["match"]).create("Could not find a match for value",({"value":value$41000})));if(url$41001){(err$41007["location"]=["location",url$41001,start$41002,end$41003]);}throw err$41007;};var GenSym$40296;var gensym$40297;var identity$40298;var binsearch$40299;var classify$40300;var classify_contiguous$40301;var neighbours$40302;var partition$40303;var product$40304;var construct$40305;var mkset$40306;(GenSym$40296=function(prefix$40311){var id$40316;(id$40316=0);return function(){var r$40343;var pfx$40334;var t0$40330;var $40321$40325;($40321$40325=arguments);(t0$40330=$40321$40325.length);if(((t0$40330>=0)&&(t0$40330<=1))){(pfx$40334=function(){if((0>=t0$40330)){return "";}else{return $40321$40325[0];}}());(r$40343=((pfx$40334+prefix$40311)+[true,String(id$40316)][1]));(id$40316++);return r$40343;}else{$40997($40321$40325);}};});(gensym$40297=GenSym$40296("$"));(identity$40298=function(x$40357){return x$40357;});(binsearch$40299=function(xs$40364,x$40365){var lo$40370;var hi$40371;(lo$40370=0);(hi$40371=(xs$40364.length-1));$40378:while((lo$40370<=hi$40371)){var $40384$40398;var mid$40388;var v$40389;(mid$40388=(lo$40370+((hi$40371-lo$40370)>>1)));(v$40389=$40226(xs$40364,mid$40388));($40384$40398=$40226(xs$40364,mid$40388));if(($40384$40398<x$40365)){(lo$40370=(mid$40388+1));}else{if(($40384$40398>x$40365)){(hi$40371=(mid$40388-1));}else{$40384$40398;return (mid$40388+1);}}}return lo$40370;});(classify$40300=function(){var $index$40473;var $length$40467;var temp$40461;var results$40451;var classes$40441;var xs$40442;var t0$40437;var $40428$40432;($40428$40432=arguments);(t0$40437=$40428$40432.length);if((t0$40437>=1)){(classes$40441=Array.prototype.slice.call($40428$40432,0,-1));(xs$40442=$40428$40432[(t0$40437-1)]);(results$40451=({"rest":[]}));(temp$40461=classes$40441);($length$40467=temp$40461.length);($index$40473=0);$40452:for(;($index$40473<$length$40467);($index$40473++)){var cls$40490;var m$40482;(m$40482=temp$40461[$index$40473]);(cls$40490=m$40482);(results$40451[cls$40490]=[]);}$40496:while(xs$40442.length){var x$40532;var other$40552;var cls$40539;var x$40540;var newxs$40515;var t0$40511;var $40499$40506;($40499$40506=xs$40442.shift());if((($40499$40506 instanceof Array)&&(((t0$40511=$40499$40506.length)),((t0$40511>=1)&&($40499$40506[0]==="splice"))))){(newxs$40515=Array.prototype.slice.call($40499$40506,1));(xs$40442=newxs$40515.concat(xs$40442));}else{if((((x$40532=$40499$40506)),((x$40532 instanceof Array)&&(x$40532[0]==="ignore")))){null;}else{if((($40499$40506 instanceof Array)&&(((t0$40511=$40499$40506.length)),((t0$40511===2)&&((cls$40539=$40499$40506[0]),((x$40540=$40499$40506[1]),$40226(results$40451,cls$40539))))))){$40226(results$40451,cls$40539).push(x$40540);}else{(other$40552=$40499$40506);results$40451.rest.push(other$40552);}}}}return results$40451;}else{$40997($40428$40432);}});(classify_contiguous$40301=function(xs$40561,classifier$40562){var $index$40598;var $length$40592;var temp$40586;var groups$40568;var currcls$40569;var curr$40570;(groups$40568=[]);(currcls$40569=null);(curr$40570=null);(temp$40586=xs$40561);($length$40592=temp$40586.length);($index$40598=0);$40571:for(;($index$40598<$length$40592);($index$40598++)){var cls$40619;var x$40615;var m$40607;(m$40607=temp$40586[$index$40598]);(x$40615=m$40607);(cls$40619=classifier$40562(x$40615));if((cls$40619===currcls$40569)){curr$40570.push(x$40615);}else{if(curr$40570){groups$40568.push(curr$40570);}(curr$40570=[cls$40619,x$40615]);(currcls$40569=cls$40619);}}if(curr$40570){groups$40568.push(curr$40570);}return groups$40568;});(neighbours$40302=function($40638$40641){var x$40680;var y$40681;var rest$40682;var x$40675;var $40647$40662;var $40648$40663;var t0$40660;var $40643$40655;var ph$40649;(ph$40649=$40638$40641);($40643$40655=ph$40649);if((($40647$40662=($40643$40655 instanceof Array))&&(((t0$40660=$40643$40655.length)),(t0$40660===0)))){return [];}else{if(($40647$40662&&(t0$40660===1))){(x$40675=$40643$40655[0]);return [];}else{if(($40647$40662&&(t0$40660>=2))){(x$40680=$40643$40655[0]);(y$40681=$40643$40655[1]);(rest$40682=Array.prototype.slice.call($40643$40655,2));return [[x$40680,y$40681]].concat(neighbours$40302([y$40681].concat(rest$40682)));}else{$40997($40643$40655);}}}});(partition$40303=function(xs$40692,predicate$40693){var $index$40725;var $length$40719;var temp$40713;var t$40698;var f$40699;(t$40698=[]);(f$40699=[]);(temp$40713=xs$40692);($length$40719=temp$40713.length);($index$40725=0);$40700:for(;($index$40725<$length$40719);($index$40725++)){var x$40747;var x$40742;var m$40734;(m$40734=temp$40713[$index$40725]);(x$40742=m$40734);if(predicate$40693(x$40742)){t$40698.push(x$40742);}else{(x$40747=m$40734);f$40699.push(x$40747);}}return [t$40698,f$40699];});(product$40304=function(a$40754,b$40755){var $index$40781;var $length$40775;var temp$40769;var results$40759;(results$40759=[]);(temp$40769=a$40754);($length$40775=temp$40769.length);($index$40781=0);$40760:for(;($index$40781<$length$40775);($index$40781++)){var $index$40823;var $length$40817;var temp$40811;var acc$40805;var x$40798;var m$40790;(m$40790=temp$40769[$index$40781]);(x$40798=m$40790);(results$40759=results$40759.concat((((acc$40805=[])),(((temp$40811=b$40755)),((($length$40817=temp$40811.length)),((($index$40823=0)),function(){$40800:for(;($index$40823<$length$40817);($index$40823++)){var y$40840;var m$40832;(m$40832=temp$40811[$index$40823]);(y$40840=m$40832);acc$40805.push([x$40798,y$40840]);}}()))),acc$40805)));}return results$40759;});(construct$40305=function($40847$40850,fn$40851,zero$40852){var x$40891;var rest$40892;var x$40886;var $40858$40873;var $40859$40874;var t0$40871;var $40854$40866;var ph$40860;(ph$40860=$40847$40850);($40854$40866=ph$40860);if((($40858$40873=($40854$40866 instanceof Array))&&(((t0$40871=$40854$40866.length)),(t0$40871===0)))){return zero$40852;}else{if(($40858$40873&&(t0$40871===1))){(x$40886=$40854$40866[0]);return x$40886;}else{if(($40858$40873&&(t0$40871>=1))){(x$40891=$40854$40866[0]);(rest$40892=Array.prototype.slice.call($40854$40866,1));return fn$40851(x$40891,construct$40305(rest$40892,fn$40851,zero$40852));}else{$40997($40854$40866);}}}});(mkset$40306=function(xs$40902){var $index$40928;var $length$40922;var temp$40916;var rval$40906;(rval$40906=({}));(temp$40916=xs$40902);($length$40922=temp$40916.length);($index$40928=0);$40907:for(;($index$40928<$length$40922);($index$40928++)){var x$40945;var m$40937;(m$40937=temp$40916[$index$40928]);(x$40945=m$40937);(rval$40906[x$40945]=true);}return rval$40906;});(exports["GenSym"]=GenSym$40296);(exports["gensym"]=gensym$40297);(exports["identity"]=identity$40298);(exports["binsearch"]=binsearch$40299);(exports["classify"]=classify$40300);(exports["classify_contiguous"]=classify_contiguous$40301);(exports["neighbours"]=neighbours$40302);(exports["partition"]=partition$40303);(exports["construct"]=construct$40305);(exports["mkset"]=mkset$40306);(exports["product"]=product$40304);

},{}],19:[function(require,module,exports){
var $237=function(type$240){var f$244;(f$244=type$240["::check"]);if((f$244===(void 0))){return function(value$250){return (value$250 instanceof type$240);};}else{return function(value$254){return f$244.call(type$240,value$254);};}};
var $256=(function(o,m){if(typeof(m)==='string'||typeof(m)==='number'){return o[m];}else{return o['::send'](m);}});
var $257=function(dest$260,values$261){var k$266;(k$266=null);$264:for(k$266 in values$261){if(values$261.hasOwnProperty(k$266)){(dest$260[k$266]=values$261[k$266]);}}return dest$260;};
var $274=function($276$279){var ph$285;(ph$285=$276$279);var $281$291;($281$291=ph$285);var bridge$283$296;var x$300;(bridge$283$296=$281$291);if((((typeof(bridge$283$296)==="string")&&((x$300=bridge$283$296),true))||((typeof(bridge$283$296)==="number")&&((x$300=bridge$283$296),true)))){return ["value",x$300];}else{var other$311;(other$311=$281$291);return other$311["::serialize_ast"]();}};
var send$11;(send$11=function(obj$18,$15$19){var ph$25;var msg$26;var t0$28;(t0$28=$15$19);(msg$26=t0$28);(ph$25=t0$28);var $21$37;($21$37=ph$25);var bridge$23$42;(bridge$23$42=$21$37);if(((typeof(bridge$23$42)==="string")||(typeof(bridge$23$42)==="number"))){return obj$18[msg$26];}else{var other$54;(other$54=$21$37);return obj$18["::send"](msg$26);}});(Array[":::project"]=function($60$63){var ph$68;var value$69;var t0$71;(t0$71=$60$63);(value$69=t0$71);(ph$68=t0$71);var $65$80;($65$80=ph$68);if($237(Array)($65$80)){return [true,value$69];}else{$65$80;return [true,[value$69]];}});(Array.prototype["::check"]=function(value$98){if((value$98 instanceof Array)){var i$104;(i$104=0);$101:for(;(i$104<this.length);(i$104++)){if(($256(this,i$104)!==$256(value$98,i$104))){return false;}}return true;}else{return false;}});(Array.prototype["::clone"]=function(){return $257(this.slice(0),this);});(Array.prototype[":::project"]=function(value$123){if((value$123 instanceof Array)){var i$129;(i$129=0);$126:for(;(i$129<this.length);(i$129++)){if(($256(this,i$129)!==$256(value$123,i$129))){return [true,[value$123]];}}return [true,value$123.slice(this.length)];}else{return [true,[value$123]];}});(Array.prototype["::serialize_ast"]=function(){return ["array"].concat(this.map($274));});(RegExp.prototype["::check"]=function($147$150){var ph$155;(ph$155=$147$150);var $152$161;($152$161=ph$155);var value$169;if((typeof($152$161)==="string")){(value$169=$152$161);if(value$169.match(this)){return true;}else{return false;}}else{var other$174;(other$174=$152$161);return false;}});(RegExp.prototype[":::project"]=function($180$183){var ph$188;(ph$188=$180$183);var $185$194;($185$194=ph$188);var value$202;if((typeof($185$194)==="string")){(value$202=$185$194);var $205$210;($205$210=value$202.match(this));var m$218;if(($205$210===null)){(m$218=$205$210);return [false,null];}else{var m$223;(m$223=$205$210);return [true,m$223];}}else{var other$227;(other$227=$185$194);return [false,null];}});(Function.prototype["::send"]=function(args$234){return this.apply(this,args$234);});
var $5524=function($5526$5529,key$5530){var ph$5538;(ph$5538=$5526$5529);var $5532$5544;($5532$5544=ph$5538);var bridge$5534$5549;(bridge$5534$5549=$5532$5544);if(((bridge$5534$5549===null)||(bridge$5534$5549===(void 0)))){return false;}else{var x$5561;if((typeof($5532$5544)==="string")){(x$5561=$5532$5544);return (key$5530 in String.prototype);}else{var x$5566;if((typeof($5532$5544)==="number")){(x$5566=$5532$5544);return (key$5530 in Number.prototype);}else{var x$5571;(x$5571=$5532$5544);return (key$5530 in x$5571);}}}};
var $5825=function(arr$5828){var results$5834;var l$5835;(results$5834=[]);(l$5835=arr$5828.length);var i$5844;(i$5844=0);$5833:for(;(i$5844<l$5835);(i$5844++)){results$5834.push([i$5844,$256(arr$5828,i$5844)]);}return results$5834;};
var $5592=function(){var $5593$5599;($5593$5599=function(tags$5604){var it$0$5607;(it$0$5607=function(){if((!$237($5593$5599)(this))){return Object.create($5593$5599.prototype);}else{return this;}}());(it$0$5607["tags"]=tags$5604);return it$0$5607;});($5593$5599.prototype["create"]=function(){var it$0$5627;var self$5628;(it$0$5627=this);(self$5628=this);var $5625$5637;($5625$5637=arguments);var t0$5642;var message$5646;var args$5647;(t0$5642=$5625$5637.length);if((t0$5642>=0)){(message$5646=function(){if((0>=t0$5642)){return "";}else{return $5625$5637[0];}}());(args$5647=Array.prototype.slice.call($5625$5637,1));var e$5660;(e$5660=Error(message$5646));(e$5660["::tags"]=it$0$5627.tags);(e$5660["args"]=args$5647);var temp$5676;(temp$5676=$5825(args$5647));var $length$5682;($length$5682=temp$5676.length);var $index$5688;($index$5688=0);$5661:for(;($index$5688<$length$5682);($index$5688++)){var m$5697;(m$5697=temp$5676[$index$5688]);var t0$5702;var t1$5703;var i$5707;var arg$5708;(t0$5702=m$5697);if(((t0$5702 instanceof Array)&&(((t1$5703=t0$5702.length)),(t1$5703===2)))){(i$5707=t0$5702[0]);(arg$5708=t0$5702[1]);(e$5660[i$5707]=arg$5708);}else{$5573(m$5697);}}(e$5660["length"]=args$5647.length);(e$5660["name"]=["E"].concat(it$0$5627.tags).join("."));return e$5660;}else{$5573($5625$5637);}});($5593$5599.prototype["::check"]=function(e$5738){var it$0$5742;var self$5743;(it$0$5742=this);(self$5743=this);var tags$5753;if(((!e$5738)||(!$237(Error)(e$5738)))){return false;}(tags$5753=(e$5738["::tags"]||[]));var temp$5764;(temp$5764=it$0$5742.tags);var $length$5770;($length$5770=temp$5764.length);var $index$5776;($index$5776=0);$5754:for(;($index$5776<$length$5770);($index$5776++)){var m$5785;(m$5785=temp$5764[$index$5776]);var tag$5793;(tag$5793=m$5785);if((tags$5753.indexOf(tag$5793)===-1)){return false;}else{false;}}return true;});($5593$5599.prototype["::deconstruct"]=function(e$5802){var it$0$5806;var self$5807;(it$0$5806=this);(self$5807=this);return e$5802.args;});$257($5593$5599,$257(function(){var accum$5818;(accum$5818=({}));(accum$5818["::name"]="$5593");return accum$5818;}(),function(){var accum$5822;(accum$5822=({}));(accum$5822["::egclass"]=true);return accum$5822;}()));return $5593$5599;}();
var $5573=function(value$5576,url$5577,start$5578,end$5579){var err$5583;(err$5583=$5592(["match"]).create("Could not find a match for value",({"value":value$5576})));if(url$5577){(err$5583["location"]=["location",url$5577,start$5578,end$5579]);}throw err$5583;};
var $5873=function($5875$5878){var ph$5888;var x$5889;var t0$5891;(t0$5891=$5875$5878);(x$5889=t0$5891);(ph$5888=t0$5891);var $5880$5900;($5880$5900=ph$5888);var bridge$5882$5905;(bridge$5882$5905=$5880$5900);if((function(){var bridge$5883$5915;(bridge$5883$5915=bridge$5882$5905);return (function(){var bridge$5884$5922;(bridge$5884$5922=bridge$5883$5915);return ((bridge$5884$5922===(void 0))||(bridge$5884$5922===null));}()||(typeof(bridge$5883$5915)==="string"));}()||(typeof(bridge$5882$5905)==="number"))){return x$5889;}else{if($5524($5880$5900,"::clone")){$5880$5900["::clone"];return x$5889["::clone"]();}else{$5880$5900;if((Object.getPrototypeOf(x$5889)===Object.prototype)){var dest$5940;(dest$5940=({}));var k$5945;(k$5945=null);$5939:for(k$5945 in x$5889){if(Object.prototype.hasOwnProperty.call(x$5889,k$5945)){(dest$5940[k$5945]=x$5889[k$5945]);}}return dest$5940;}else{var other$5955;(other$5955=$5880$5900);throw $5592(["clone"]).create("Object cannot be cloned",({"obj":x$5889}));}}}};
var $5851=function(a$5854,b$5855){var dest$5860;(dest$5860=$5873(a$5854));var k$5865;(k$5865=null);$5859:for(k$5865 in b$5855){if(Object.prototype.hasOwnProperty.call(b$5855,k$5865)){(dest$5860[k$5865]=b$5855[k$5865]);}}return dest$5860;};
var $6129=Object.keys;
var $5957=function($5959$5962,b$5963){var ph$5977;var a$5978;var t0$5980;(t0$5980=$5959$5962);(a$5978=t0$5980);(ph$5977=t0$5980);var $5965$5989;($5965$5989=ph$5977);var bridge$5968$5994;if(($5965$5989===b$5963)){return true;}else{(bridge$5968$5994=$5965$5989);if((function(){var bridge$5969$6008;(bridge$5969$6008=bridge$5968$5994);return (function(){var bridge$5970$6015;(bridge$5970$6015=bridge$5969$6008);return (function(){var bridge$5971$6022;(bridge$5971$6022=bridge$5970$6015);return (function(){var bridge$5972$6029;(bridge$5972$6029=bridge$5971$6022);return ((typeof(bridge$5972$6029)==="number")||(typeof(bridge$5972$6029)==="string"));}()||(bridge$5971$6022===null));}()||(bridge$5970$6015===(void 0)));}()||(bridge$5969$6008===true));}()||(bridge$5968$5994===false))){return false;}else{if($237(Array)($5965$5989)){if(((!$237(Array)(b$5963))||(a$5978.length!==b$5963.length))){return false;}var i$6045;(i$6045=0);$6041:for(;(i$6045<a$5978.length);(i$6045++)){if((!$5957(a$5978[i$6045],b$5963[i$6045]))){return false;}}return true;}else{$5965$5989;if((((Object.getPrototypeOf(a$5978)===Object.prototype)&&$237(Object)(b$5963))&&(Object.getPrototypeOf(b$5963)===Object.prototype))){var ka$6059;(ka$6059=$6129(a$5978));if((!$5957(ka$6059.sort(),$6129(b$5963).sort()))){return false;}var temp$6070;(temp$6070=ka$6059);var $length$6076;($length$6076=temp$6070.length);var $index$6082;($index$6082=0);$6060:for(;($index$6082<$length$6076);($index$6082++)){var m$6091;(m$6091=temp$6070[$index$6082]);var k$6099;(k$6099=m$6091);if((!$5957(a$5978[k$6099],b$5963[k$6099]))){return false;}}return true;}else{if($5524($5965$5989,"::serialize")){$5965$5989["::serialize"];var $6106$6111;($6106$6111=b$5963);if($5524($6106$6111,"::serialize")){$6106$6111["::serialize"];return $5957(a$5978["::serialize"](),b$5963["::serialize"]());}else{var otherwise$6123;(otherwise$6123=$6106$6111);return false;}}else{var otherwise$6127;(otherwise$6127=$5965$5989);return false;}}}}}};
var $6130=function(arrays$6133){var results$6137;(results$6137=[]);var temp$6147;(temp$6147=arrays$6133);var $length$6153;($length$6153=temp$6147.length);var $index$6159;($index$6159=0);$6138:for(;($index$6159<$length$6153);($index$6159++)){var m$6168;(m$6168=temp$6147[$index$6159]);var a$6176;(a$6176=m$6168);(results$6137=results$6137.concat(a$6176));}return results$6137;};
var $6182=function(type$6185){return function(value$6189){var f$6193;(f$6193=type$6185[":::project"]);if((f$6193===(void 0))){(f$6193=type$6185["::project"]);if((f$6193===(void 0))){return [true,type$6185(value$6189)];}else{var rval$6206;(rval$6206=false);try{(rval$6206=[true,f$6193(value$6189)]);}catch(excv$6217){var e$6223;(e$6223=excv$6217);(rval$6206=[false,null]);}return rval$6206;}}else{return f$6193.call(type$6185,value$6189);}};};
var $6229=function(pairs$6232){var rval$6236;(rval$6236=({}));var temp$6246;(temp$6246=pairs$6232);var $length$6252;($length$6252=temp$6246.length);var $index$6258;($index$6258=0);$6237:for(;($index$6258<$length$6252);($index$6258++)){var m$6267;(m$6267=temp$6246[$index$6258]);var t0$6272;var t1$6273;var k$6277;var v$6278;(t0$6272=m$6267);if(((t0$6272 instanceof Array)&&(((t1$6273=t0$6272.length)),(t1$6273===2)))){(k$6277=t0$6272[0]);(v$6278=t0$6272[1]);(rval$6236[k$6277]=v$6278);}else{$5573(m$6267);}}return rval$6236;};
var $6297=function(xs$6300,ys$6301){var acc$6308;(acc$6308=[]);var temp$6314;(temp$6314=$5825(xs$6300));var $length$6320;($length$6320=temp$6314.length);var $index$6326;($index$6326=0);$6303:for(;($index$6326<$length$6320);($index$6326++)){var m$6335;(m$6335=temp$6314[$index$6326]);var t0$6340;var t1$6341;var i$6345;var x$6346;(t0$6340=m$6335);if(((t0$6340 instanceof Array)&&(((t1$6341=t0$6340.length)),(t1$6341===2)))){(i$6345=t0$6340[0]);(x$6346=t0$6340[1]);acc$6308.push([x$6346,$256(ys$6301,i$6345)]);}else{$5573(m$6335);}}return acc$6308;};
var $6361=function(obj$6364){var results$6369;(results$6369=[]);var k$6374;(k$6374=null);$6368:for(k$6374 in obj$6364){if(Object.prototype.hasOwnProperty.call(obj$6364,k$6374)){results$6369.push([k$6374,$256(obj$6364,k$6374)]);}}return results$6369;};
var $6378=function(){var $6379$6384;($6379$6384=function($6388$6395,$6390$6396,$6392$6397){var it$0$6400;(it$0$6400=function(){if((!$237($6379$6384)(this))){return Object.create($6379$6384.prototype);}else{return this;}}());var t0$6407;(t0$6407=$6182(Array)($6388$6395));if(t0$6407[0]){(it$0$6400["tags"]=t0$6407[1]);}else{$5573($6388$6395);}(it$0$6400["props"]=$6390$6396);var t0$6419;(t0$6419=$6182(Array)($6392$6397));if(t0$6419[0]){(it$0$6400["children"]=t0$6419[1]);}else{$5573($6392$6397);}undefined;return it$0$6400;});$257(function(){var accum$6433;(accum$6433=({}));(accum$6433["::check"]=function(x$6438){return (((x$6438&&x$6438.tags)&&x$6438.props)&&x$6438.children);});return accum$6433;}(),$257(function(){var accum$6441;(accum$6441=({}));(accum$6441[":::project"]=function($6445$6448){var ph$6453;(ph$6453=$6445$6448);var $6450$6459;($6450$6459=ph$6453);var tags$6467;var props$6468;var children$6469;if(($5524($6450$6459,"tags")&&((tags$6467=$6450$6459.tags),($5524($6450$6459,"props")&&((props$6468=$6450$6459.props),$5524($6450$6459,"children")))))){(children$6469=$6450$6459.children);return [true,[tags$6467,props$6468,children$6469]];}else{$6450$6459;return [false,null];}});return accum$6441;}(),$257(function(){var accum$6478;(accum$6478=({}));(accum$6478["::name"]="$6379");return accum$6478;}(),function(){var accum$6482;(accum$6482=({}));(accum$6482["::egclass"]=true);return accum$6482;}())));($6379$6384.prototype["::check"]=function($6488$6491){var it$0$6495;var self$6496;(it$0$6495=this);(self$6496=this);var ph$6507;(ph$6507=$6488$6491);var $6504$6513;($6504$6513=ph$6507);var n$6521;if($237($6378)($6504$6513)){(n$6521=$6504$6513);var temp$6531;(temp$6531=it$0$6495.tags);var $length$6537;($length$6537=temp$6531.length);var $index$6543;($index$6543=0);$6525:for(;($index$6543<$length$6537);($index$6543++)){var m$6552;(m$6552=temp$6531[$index$6543]);var c$6560;(c$6560=m$6552);if((n$6521.tags.indexOf(c$6560)===-1)){return false;}else{false;}}return true;}else{$6504$6513;return false;}});($6379$6384.prototype[":::project"]=function($6571$6574){var it$0$6578;var self$6579;(it$0$6578=this);(self$6579=this);var ph$6590;(ph$6590=$6571$6574);var $6587$6596;($6587$6596=ph$6590);var n$6604;if($237(it$0$6578)($6587$6596)){(n$6604=$6587$6596);return [true,[n$6604.tags,n$6604.props,n$6604.children]];}else{$6587$6596;return [false,null];}});$257($6379$6384,$257(function(){var accum$6615;(accum$6615=({}));(accum$6615["::check"]=function(x$6620){return (((x$6620&&x$6620.tags)&&x$6620.props)&&x$6620.children);});return accum$6615;}(),$257(function(){var accum$6623;(accum$6623=({}));(accum$6623[":::project"]=function($6627$6630){var ph$6635;(ph$6635=$6627$6630);var $6632$6641;($6632$6641=ph$6635);var tags$6649;var props$6650;var children$6651;if(($5524($6632$6641,"tags")&&((tags$6649=$6632$6641.tags),($5524($6632$6641,"props")&&((props$6650=$6632$6641.props),$5524($6632$6641,"children")))))){(children$6651=$6632$6641.children);return [true,[tags$6649,props$6650,children$6651]];}else{$6632$6641;return [false,null];}});return accum$6623;}(),$257(function(){var accum$6660;(accum$6660=({}));(accum$6660["::name"]="$6379");return accum$6660;}(),function(){var accum$6664;(accum$6664=({}));(accum$6664["::egclass"]=true);return accum$6664;}()))));return $6379$6384;}();var q_groups$2179;var q_prio$2180;var accum$3670;var accum$3674;var accum$4072;var accum$4076;var accum$4173;var accum$4177;var accum$4553;var accum$4588;var accum$4610;var accum$4632;var accum$4654;var accum$4682;var accum$4801;var accum$4823;var accum$4845;var accum$4867;var accum$4889;var accum$4911;var accum$4933;var accum$4955;var accum$4977;var accum$5048;var accum$5119;var $index$5159;var $length$5153;var temp$5147;var filter$5197;var spec$5198;var fn$5199;var $315$373;var Source$374;var Location$375;var __lt____lt____colon__$376;var __plus____plus____colon__$377;var $316$378;var fill_locations$379;var $317$380;var OperatorGroups$381;var SimplePriority$382;var oparse$383;var $318$384;var Generator$385;var $319$386;var topscope$387;var fixity_table$388;var inherent_fixity$389;var fullsplit$390;var produce$391;var indent_tracker$392;var process_indent$393;var disambiguate_fixity$394;var alternate_operators$395;var produce_line$396;var dirty_hacks$397;var tokenize$398;var MAX$399;var fxm$400;var q_order$401;var finalize$402;var parse$403;var extract$404;var parse_spec$405;var make_extractor$406;var Dispatcher$407;var Engine$408;var Spec$409;var dispatch$410;var mergeable$411;var collapse$412;var shed$413;var shed_all$414;var shed_indent$415;var components$416;var Quaint$417;($315$373=require("earl-grey/location"));(Source$374=$315$373.Source);(Location$375=$315$373.Location);(__lt____lt____colon__$376=$315$373["<<:"]);(__plus____plus____colon__$377=$315$373["++:"]);($316$378=require("earl-grey/lex"));(fill_locations$379=$316$378.fill_locations);($317$380=require("earl-grey/parse"));(OperatorGroups$381=$317$380.OperatorGroups);(SimplePriority$382=$317$380.SimplePriority);(oparse$383=$317$380.oparse);($318$384=require("earl-grey/earl-grey"));(Generator$385=$318$384.Generator);($319$386=require("earl-grey/stdenv"));(topscope$387=$319$386.topscope);(fixity_table$388=({"(":"PFX","[":"PFX","{":"PFX",")":"SFX","]":"SFX","}":"SFX",",":"IFX"}));(inherent_fixity$389=function(op$473){return ($256(fixity_table$388,op$473)||"?FX");});(fullsplit$390=function(pos0$480,text$481,_re$482){var re$490;var ss$491;var results$492;var pos$493;var lastpos$494;(re$490=(new RegExp((("(\\\\.)|("+_re$482)+")"),"g")));(ss$491=function(a$502,b$503){return text$481.substring((a$502-pos0$480),(b$503-pos0$480));});(results$492=[]);(pos$493=pos0$480);$512:while(true){var m$556;var m$538;var index$539;var $519$530;var $520$531;var t0$528;var $515$523;($515$523=re$490.exec(text$481));if(($515$523===null)){break $512;}else{if((($519$530=($515$523 instanceof Array))&&(((t0$528=$515$523.length)),((t0$528>=2)&&((m$538=$515$523[0]),(($515$523[1]===(void 0))&&(Array.prototype.slice.call($515$523,2),$5524($515$523,"index")))))))){(index$539=$515$523.index);results$492.push(["word",pos$493,(index$539+pos0$480),ss$491(pos$493,(index$539+pos0$480))],["sep",(index$539+pos0$480),(re$490.lastIndex+pos0$480),ss$491((index$539+pos0$480),(re$490.lastIndex+pos0$480))]);(pos$493=(re$490.lastIndex+pos0$480));}else{if(($519$530&&(t0$528>=1))){(m$556=$515$523[0]);Array.prototype.slice.call($515$523,1);continue $512;}else{$5573($515$523);}}}}(lastpos$494=(pos0$480+text$481.length));results$492.push(["word",pos$493,lastpos$494,ss$491(pos$493,lastpos$494)]);return results$492;});(produce$391=function(src$569){var $index$623;var $length$617;var temp$611;var lineop_re$577;var text$578;var url$579;var results$580;var curw$581;(lineop_re$577=RegExp("^[!@#$%^&*_\\-+=<>/?;:.`|]{3,}$",""));(text$578=src$569.text);(url$579=src$569.url);(results$580=[]);(curw$581=0);(temp$611=fullsplit$390(0,text$578,"[ ~]*(\n[ ~]*)+"));($length$617=temp$611.length);($index$623=0);$582:for(;($index$623<$length$617);($index$623++)){var t0$669;var spl$664;var lw$702;var info$692;var s$678;var e$679;var w$680;var $586$681;var s$647;var e$648;var word$649;var $589$641;var $590$642;var $591$643;var $592$644;var t0$637;var t1$638;var t2$639;var m$632;(m$632=temp$611[$index$623]);(t0$637=m$632);if((($590$642=(t0$637 instanceof Array))&&(((t1$638=t0$637.length)),(($592$644=(t1$638===4))&&(t0$637[0]==="sep"))))){(s$647=t0$637[1]);(e$648=t0$637[2]);(word$649=t0$637[3]);(spl$664=word$649.split("\n"));(t0$669=(spl$664.length-2));(curw$581=t0$669);($256(results$580,(results$580.length-1))["wsa"]=t0$669);results$580.push($257(["INDENT",$256(spl$664,(spl$664.length-1)).length],({"location":Location$375(src$569,s$647,e$648)})));}else{if(($592$644&&(t0$637[0]==="word"))){(s$678=t0$637[1]);(e$679=t0$637[2]);(t2$639=t0$637[3]);(w$680=t2$639);($586$681=t2$639);(info$692=({"location":Location$375(src$569,s$678,e$679),"wsb":curw$581}));if($237(lineop_re$577)($586$681)){(lw$702=("L"+w$680));results$580.push($257(["OP",inherent_fixity$389(lw$702),lw$702],info$692));}else{$586$681;results$580.push($257(["LINE",w$680],info$692));}}else{$5573(m$632,"/home/olivier/git/egquaint/src/index.eg",1357,2021);}}}return results$580;});(indent_tracker$392=function(){var curr$723;var stack$724;(curr$723=0);(stack$724=[]);return function($721$732){var t0$749;var rval$813;var x$837;var $index$865;var $length$859;var temp$853;var acc$847;var other$886;var stuff$829;var new_indent$770;var $736$771;var $744$766;var $745$767;var t0$763;var t1$764;var $734$758;var ph$746;var token$747;(t0$749=$721$732);(token$747=t0$749);(ph$746=t0$749);($734$758=ph$746);if((($744$766=($734$758 instanceof Array))&&(((t0$763=$734$758.length)),((t0$763===2)&&($734$758[0]==="INDENT"))))){(t1$764=$734$758[1]);(new_indent$770=t1$764);($736$771=t1$764);$736$771;if((curr$723===false)){(curr$723=new_indent$770);return [];}else{if(($736$771>curr$723)){stack$724.push(curr$723);(curr$723=new_indent$770);return [$5851(["OP","?FX","I("],({"wsb":true,"wsa":true}))];}else{if(($736$771===curr$723)){return [];}else{if(($736$771<curr$723)){(rval$813=[]);$817:while(((stack$724.length>0)&&(new_indent$770<curr$723))){(curr$723=stack$724.pop());rval$813.push($5851(["OP","SFX",")I"],({"wsb":true,"wsa":true})));}return rval$813;}else{$5573($736$771,"/home/olivier/git/egquaint/src/index.eg",2550,2566);}}}}}else{if(($744$766&&((t0$763>=1)&&($734$758[0]==="ID")))){(stuff$829=Array.prototype.slice.call($734$758,1));return [token$747];}else{if((((x$837=$734$758)),((x$837 instanceof Array)&&(x$837[0]==="EOF")))){(acc$847=[]);(temp$853=stack$724);($length$859=temp$853.length);($index$865=0);$842:for(;($index$865<$length$859);($index$865++)){var m$874;(m$874=temp$853[$index$865]);m$874;acc$847.push($5851(["OP","SFX",")I"],({"wsb":true,"wsa":true})));}return acc$847;}else{(other$886=$734$758);return [token$747];}}}};});(process_indent$393=function(stream$893){var $index$924;var $length$918;var temp$912;var tracker$898;var results$899;(tracker$898=indent_tracker$392());(results$899=[]);(temp$912=stream$893);($length$918=temp$912.length);($index$924=0);$900:for(;($index$924<$length$918);($index$924++)){var token$941;var m$933;(m$933=temp$912[$index$924]);(token$941=m$933);(results$899=results$899.concat(tracker$898(token$941)));}return results$899.concat(tracker$898(["EOF"]));});(disambiguate_fixity$394=function(stream$948){var $index$1394;var $length$1388;var temp$1382;var __lt____lt____lt____colon__$957;var collapse_operators$958;var buffer$959;var pfx$960;var collapse$961;var results$962;(__lt____lt____lt____colon__$957=function(a$978,b$979){(a$978["wsb"]=b$979.wsb);(a$978["wsa"]=b$979.wsa);return __lt____lt____colon__$376(a$978,b$979);});(collapse_operators$958=function(){var $index$1079;var $length$1073;var temp$1067;var acc$1061;var $index$1156;var $length$1150;var temp$1144;var acc$1138;var $index$1219;var $length$1213;var temp$1207;var acc$1201;var t0$1272;var t1$1273;var t2$1274;var t3$1275;var t0$1320;var t0$1327;var $1264$1309;var $1265$1310;var $1266$1311;var bridge$1261$1306;var t0$1307;var $1259$1301;var first$1267;var fixity$1268;var name$1269;var rest$1270;var n$1036;var $1003$1030;var $1004$1031;var $1005$1032;var $1006$1033;var t0$1027;var t1$1028;var buffer$1018;var $997$1019;var t0$1014;var $995$1009;($995$1009=arguments);(t0$1014=$995$1009.length);if((t0$1014>=1)){(buffer$1018=$995$1009[0]);($997$1019=Array.prototype.slice.call($995$1009,1));(n$1036=buffer$1018.length);$997$1019;if($5957(n$1036,0)){return [];}else{(t0$1027=$997$1019);(t1$1028=t0$1027.length);if((($1005$1032=(t1$1028===2))&&(($1006$1033=t0$1027[0])&&t0$1027[1]))){(acc$1061=[]);(temp$1067=buffer$1018);($length$1073=temp$1067.length);($index$1079=0);$1056:for(;($index$1079<$length$1073);($index$1079++)){var t0$1120;var r$1115;var token$1098;var name$1099;var t0$1093;var t1$1094;var m$1088;(m$1088=temp$1067[$index$1079]);(t0$1093=m$1088);(token$1098=t0$1093);if(((t0$1093 instanceof Array)&&(((t1$1094=t0$1093.length)),((t1$1094===3)&&(t0$1093[0]==="OP"))))){t0$1093[1];(name$1099=t0$1093[2]);acc$1061.push((((r$1115=["OP","PFX",name$1099])),(((t0$1120=1)),(r$1115["wsb"]=t0$1120),(r$1115["wsa"]=t0$1120)),__lt____lt____colon__$376(r$1115,token$1098)));}else{$5573(m$1088,"/home/olivier/git/egquaint/src/index.eg",3991,4425);}}return acc$1061;}else{if($1006$1033){t0$1027[1];(acc$1138=[]);(temp$1144=buffer$1018);($length$1150=temp$1144.length);($index$1156=0);$1133:for(;($index$1156<$length$1150);($index$1156++)){var token$1175;var name$1176;var t0$1170;var t1$1171;var m$1165;(m$1165=temp$1144[$index$1156]);(t0$1170=m$1165);(token$1175=t0$1170);if(((t0$1170 instanceof Array)&&(((t1$1171=t0$1170.length)),((t1$1171===3)&&(t0$1170[0]==="OP"))))){t0$1170[1];(name$1176=t0$1170[2]);acc$1138.push(__lt____lt____lt____colon__$957(["OP","PFX",name$1176],token$1175));}else{$5573(m$1165,"/home/olivier/git/egquaint/src/index.eg",4438,4532);}}return acc$1138;}else{if(($1005$1032&&(t0$1027[0],t0$1027[1]))){(acc$1201=[]);(temp$1207=buffer$1018);($length$1213=temp$1207.length);($index$1219=0);$1196:for(;($index$1219<$length$1213);($index$1219++)){var token$1238;var name$1239;var t0$1233;var t1$1234;var m$1228;(m$1228=temp$1207[$index$1219]);(t0$1233=m$1228);(token$1238=t0$1233);if(((t0$1233 instanceof Array)&&(((t1$1234=t0$1233.length)),((t1$1234===3)&&(t0$1233[0]==="OP"))))){t0$1233[1];(name$1239=t0$1233[2]);acc$1201.push(__lt____lt____lt____colon__$957(["OP","SFX",name$1239],token$1238));}else{$5573(m$1228,"/home/olivier/git/egquaint/src/index.eg",4545,4639);}}return acc$1201;}else{$997$1019;(t0$1272=buffer$1018);if(((t0$1272 instanceof Array)&&(((t1$1273=t0$1272.length)),((t1$1273>=1)&&(((t2$1274=t0$1272[0])),((first$1267=t2$1274),((t2$1274 instanceof Array)&&(((t3$1275=t2$1274.length)),((t3$1275===3)&&(t2$1274[0]==="OP")))))))))){(fixity$1268=t2$1274[1]);(name$1269=t2$1274[2]);(rest$1270=Array.prototype.slice.call(t0$1272,1));}else{$5573(buffer$1018,"/home/olivier/git/egquaint/src/index.eg",4692,4698);}($1259$1301=[first$1267.wsb,first$1267.wsa]);(bridge$1261$1306=$1259$1301);if((((bridge$1261$1306 instanceof Array)&&(((t0$1320=bridge$1261$1306.length)),((t0$1320===2)&&((!bridge$1261$1306[0])&&(!bridge$1261$1306[1])))))||((bridge$1261$1306 instanceof Array)&&(((t0$1327=bridge$1261$1306.length)),((t0$1327===2)&&(bridge$1261$1306[0]&&bridge$1261$1306[1])))))){return [__lt____lt____lt____colon__$957(["OP","IFX",name$1269],first$1267)].concat(collapse_operators$958(rest$1270,true,false));}else{if((($1264$1309=($1259$1301 instanceof Array))&&(((t0$1307=$1259$1301.length)),(($1266$1311=(t0$1307===2))&&$1259$1301[0])))){$1259$1301[1];return [__lt____lt____lt____colon__$957(["OP","PFX",name$1269],first$1267)].concat(collapse_operators$958(rest$1270,true,false));}else{if(($1266$1311&&($1259$1301[0],$1259$1301[1]))){return [__lt____lt____lt____colon__$957(["OP","SFX",name$1269],first$1267)].concat(collapse_operators$958(rest$1270,false,false));}else{$5573($1259$1301);}}}}}}}}else{$5573($995$1009);}});(buffer$959=[]);(pfx$960=true);(collapse$961=function(sfx$1363){var rval$1368;(rval$1368=collapse_operators$958(buffer$959,pfx$960,sfx$1363));(buffer$959=[]);return rval$1368;});(results$962=[]);(temp$1382=stream$948);($length$1388=temp$1382.length);($index$1394=0);$963:for(;($index$1394<$length$1388);($index$1394++)){var other$1475;var name$1425;var $968$1426;var t0$1420;var t1$1421;var token$1412;var $966$1413;var t0$1408;var m$1403;(m$1403=temp$1382[$index$1394]);(t0$1408=m$1403);(token$1412=t0$1408);($966$1413=t0$1408);(t0$1420=$966$1413);if(((t0$1420 instanceof Array)&&(((t1$1421=t0$1420.length)),((t1$1421===3)&&(t0$1420[0]==="OP"))))){($968$1426=t0$1420[1]);(name$1425=t0$1420[2]);if(($968$1426==="?FX")){buffer$959.push(token$1412);}else{if(($968$1426==="IFX")){(results$962=results$962.concat(collapse$961(true)));results$962.push(token$1412);(pfx$960=true);}else{if(($968$1426==="PFX")){(results$962=results$962.concat(collapse$961(false)));results$962.push(token$1412);(pfx$960=true);}else{if(($968$1426==="SFX")){(results$962=results$962.concat(collapse$961(true)));results$962.push(token$1412);(pfx$960=false);}else{$5573($968$1426,"/home/olivier/git/egquaint/src/index.eg",5631,5636);}}}}}else{(other$1475=$966$1413);(results$962=results$962.concat(collapse$961(false)));results$962.push(token$1412);(pfx$960=false);}}return results$962.concat(collapse$961(true));});(alternate_operators$395=function(stream$1487,white$1488){var $index$1538;var $length$1532;var temp$1526;var W$1495;var last_op$1496;var line_op$1497;var results$1498;(W$1495=function(x$1511){if(x$1511){return "wide";}else{return "short";}});(last_op$1496=true);(line_op$1497=false);(results$1498=[]);(temp$1526=stream$1487);($length$1532=temp$1526.length);($index$1538=0);$1499:for(;($index$1538<$length$1532);($index$1538++)){var x$1572;var $1593$1601;var x$1645;var token$1652;var fixity$1579;var name$1580;var t0$1564;var t1$1565;var token$1556;var $1502$1557;var t0$1552;var m$1547;(m$1547=temp$1526[$index$1538]);(t0$1552=m$1547);(token$1556=t0$1552);($1502$1557=t0$1552);if((((x$1572=$1502$1557)),((x$1572 instanceof Array)&&(x$1572[0]==="IGNORE")))){null;}else{(t0$1564=$1502$1557);if(((t0$1564 instanceof Array)&&(((t1$1565=t0$1564.length)),((t1$1565===3)&&(t0$1564[0]==="OP"))))){(fixity$1579=t0$1564[1]);(name$1580=t0$1564[2]);if(last_op$1496){results$1498.push(["VOID"]);}($1593$1601=fixity$1579);if(($1593$1601==="IFX")){results$1498.push(__lt____lt____colon__$376(["IFX",W$1495((token$1556.wsa||token$1556.wsb)),name$1580],token$1556));(last_op$1496=true);}else{if(($1593$1601==="PFX")){if((!last_op$1496)){results$1498.push(["IFX",W$1495(token$1556.wsb),white$1488],["VOID"]);}results$1498.push(__lt____lt____colon__$376(["PFX",W$1495(token$1556.wsa),name$1580],token$1556));(last_op$1496=true);}else{if(($1593$1601==="SFX")){results$1498.push(__lt____lt____colon__$376(["SFX",W$1495(token$1556.wsb),name$1580],token$1556),["VOID"]);(last_op$1496=false);}else{$5573($1593$1601);}}}(line_op$1497=$237(RegExp("^L",""))(name$1580));}else{if((((x$1645=$1502$1557)),((x$1645 instanceof Array)&&(x$1645[0]==="ILLEGAL")))){throw $5592(["syntax","illegal"]).create("unknown character",({"chr":token$1556}));}else{(token$1652=$1502$1557);if((!last_op$1496)){results$1498.push(["IFX",W$1495(token$1652.wsb),white$1488]);}results$1498.push(token$1652);(last_op$1496=false);}}}}if(last_op$1496){results$1498.push(["VOID"]);}return results$1498;});(produce_line$396=function(src$1666,line$1667,start$1668){var $index$1704;var $length$1698;var temp$1692;var ws$1673;var results$1674;(ws$1673=0);(results$1674=[]);(temp$1692=fullsplit$390(start$1668,line$1667,"[ ~]+"));($length$1698=temp$1692.length);($index$1704=0);$1675:for(;($index$1704<$length$1698);($index$1704++)){var $index$1784;var $length$1778;var temp$1772;var prod$1759;var s$1752;var e$1753;var w$1754;var s$1727;var e$1728;var white$1729;var $1679$1721;var $1680$1722;var $1681$1723;var $1682$1724;var t0$1718;var t1$1719;var m$1713;(m$1713=temp$1692[$index$1704]);(t0$1718=m$1713);if((($1680$1722=(t0$1718 instanceof Array))&&(((t1$1719=t0$1718.length)),(($1682$1724=(t1$1719===4))&&(t0$1718[0]==="sep"))))){(s$1727=t0$1718[1]);(e$1728=t0$1718[2]);(white$1729=t0$1718[3]);(ws$1673=white$1729.length);($256(results$1674,(results$1674.length-1))["wsa"]=ws$1673);}else{if(($1682$1724&&(t0$1718[0]==="word"))){(s$1752=t0$1718[1]);(e$1753=t0$1718[2]);(w$1754=t0$1718[3]);(prod$1759=false);(temp$1772=fullsplit$390(s$1752,w$1754,"[!@#$%^&*_\\-+=<>/?;:.`|]+|[(){}\\[\\],.]"));($length$1778=temp$1772.length);($index$1784=0);$1760:for(;($index$1784<$length$1778);($index$1784++)){var w2$1866;var $1849$1854;var info$1828;var type$1804;var s2$1805;var e2$1806;var w2$1807;var $1763$1808;var t0$1798;var t1$1799;var t2$1800;var m$1793;(m$1793=temp$1772[$index$1784]);(t0$1798=m$1793);if(((t0$1798 instanceof Array)&&(((t1$1799=t0$1798.length)),(t1$1799===4)))){(t2$1800=t0$1798[0]);(type$1804=t2$1800);($1763$1808=t2$1800);(s2$1805=t0$1798[1]);(e2$1806=t0$1798[2]);(w2$1807=t0$1798[3]);(info$1828=({"location":Location$375(src$1666,s2$1805,e2$1806),"wsb":ws$1673,"wsa":0}));if(($1763$1808==="sep")){(prod$1759=true);results$1674.push($257(["OP",inherent_fixity$389(w2$1807),w2$1807],info$1828));(ws$1673=0);}else{if(($1763$1808==="word")){($1849$1854=w2$1807);if(($1849$1854==="")){undefined;}else{(w2$1866=$1849$1854);(prod$1759=true);results$1674.push($257(["ID",w2$1866],info$1828));(ws$1673=0);}}else{$5573($1763$1808,"/home/olivier/git/egquaint/src/index.eg",8566,8576);}}}else{$5573(m$1793,"/home/olivier/git/egquaint/src/index.eg",8487,9218);}}if((!prod$1759)){results$1674.push($257(["ID",""],({"location":Location$375(src$1666,s$1752,e$1753),"wsb":ws$1673,"wsa":0})));}}else{$5573(m$1713,"/home/olivier/git/egquaint/src/index.eg",8260,9397);}}}return results$1674;});(dirty_hacks$397=function(tokens$1889){var $index$1913;var $length$1907;var temp$1901;(temp$1901=$5825(tokens$1889));($length$1907=temp$1901.length);($index$1913=0);$1892:for(;($index$1913<$length$1907);($index$1913++)){var t0$1979;var $1969$1974;var oper$1957;var t0$1952;var t1$1953;var i$1933;var token$1934;var $1895$1935;var t0$1927;var t1$1928;var t2$1929;var m$1922;(m$1922=temp$1901[$index$1913]);(t0$1927=m$1922);if(((t0$1927 instanceof Array)&&(((t1$1928=t0$1927.length)),(t1$1928===2)))){(i$1933=t0$1927[0]);(t2$1929=t0$1927[1]);(token$1934=t2$1929);($1895$1935=t2$1929);(t0$1952=$1895$1935);if(((t0$1952 instanceof Array)&&(((t1$1953=t0$1952.length)),((t1$1953===3)&&((t0$1952[0]==="SFX")&&(t0$1952[1]==="wide")))))){(oper$1957=t0$1952[2]);($1969$1974=$256(tokens$1889,(i$1933+2)));if((($1969$1974 instanceof Array)&&(((t0$1979=$1969$1974.length)),((t0$1979===3)&&(($1969$1974[0]==="IFX")&&(($1969$1974[1]==="wide")&&($1969$1974[2]==="I("))))))){(token$1934[0]="IFX");$256(tokens$1889,(i$1933+1)).splice(0,1,"ID","");}else{$1969$1974;undefined;}}else{$1895$1935;undefined;}}else{$5573(m$1922,"/home/olivier/git/egquaint/src/index.eg",9432,9719);}}return tokens$1889;});(tokenize$398=function(src$2008){var $index$2069;var $length$2063;var temp$2057;var acc$2051;var it$0$2123;var it$0$2042;var it$0$2036;var it$0$2030;var it$0$2024;var it$0$2018;var it$0$2012;(it$0$2012=src$2008);(it$0$2018=produce$391(it$0$2012));(it$0$2024=process_indent$393(it$0$2018));(it$0$2030=disambiguate_fixity$394(it$0$2024));(it$0$2036=alternate_operators$395(it$0$2030,"NL"));(it$0$2042=$6130((((acc$2051=[])),(((temp$2057=it$0$2036)),((($length$2063=temp$2057.length)),((($index$2069=0)),function(){$2045:for(;($index$2069<$length$2063);($index$2069++)){var it$0$2111;var it$0$2105;var other$2117;var l$2088;var loc$2089;var t0$2083;var t1$2084;var m$2078;(m$2078=temp$2057[$index$2069]);(t0$2083=m$2078);if(((t0$2083 instanceof Array)&&(((t1$2084=t0$2083.length)),((t1$2084===2)&&((t0$2083[0]==="LINE")&&((l$2088=t0$2083[1]),$5524(t0$2083,"location"))))))){(loc$2089=t0$2083.location);acc$2051.push((((it$0$2105=produce_line$396(loc$2089.source,l$2088,loc$2089.start))),(((it$0$2111=disambiguate_fixity$394(it$0$2105))),alternate_operators$395(it$0$2111,"JUXT"))));}else{(other$2117=m$2078);acc$2051.push([other$2117]);}}}()))),acc$2051)));(it$0$2123=dirty_hacks$397(it$0$2042));return fill_locations$379(src$2008,it$0$2123);});(MAX$399=(1/0));(fxm$400=function(fx$2135,w$2136,re$2137){return function($2140$2143){var t0$2159;var $2145$2154;var ph$2148;(ph$2148=$2140$2143);($2145$2154=ph$2148);if((($2145$2154 instanceof Array)&&(((t0$2159=$2145$2154.length)),((t0$2159===3)&&($5957($2145$2154[0],fx$2135)&&($5957($2145$2154[1],w$2136)&&$237(re$2137)($2145$2154[2]))))))){return true;}else{$2145$2154;return false;}};});(q_order$401=(((q_groups$2179=OperatorGroups$381(({"sh_ifx":[fxm$400("IFX","short",RegExp("^[^L]",""))],"sh_pfx":[fxm$400("PFX","short",RegExp("^[^L]",""))],"sh_sfx":[fxm$400("SFX","short",RegExp("^[^L]",""))],"wi_ifx":[fxm$400("IFX","wide",RegExp("^[^L]",""))],"wi_pfx":[fxm$400("PFX","wide",RegExp("^[^L]",""))],"wi_sfx":[fxm$400("SFX","wide",RegExp("^[^L]",""))],"lsh_ifx":[fxm$400("IFX","short",RegExp("^L",""))],"lsh_pfx":[fxm$400("PFX","short",RegExp("^L",""))],"lsh_sfx":[fxm$400("SFX","short",RegExp("^L",""))],"lwi_ifx":[fxm$400("IFX","wide",RegExp("^L",""))],"lwi_pfx":[fxm$400("PFX","wide",RegExp("^L",""))],"lwi_sfx":[fxm$400("SFX","wide",RegExp("^L",""))],"sjuxt":["XJUXTY"],"wjuxt":["X JUXT Y"],"snl":["XNLY"],"wnl":["X NL Y"],"obrack":["(_Y","[_Y","{_Y"],"cbrack":["X_)","X_]","X_}"],"oindent":["X_I(_Y"],"oindentp":["I(_Y"],"cindent":["X_)I"],"period":["X."],"comma":["X_,_Y"]})))),((q_prio$2180=({"oindent":[["all",114],["all",1]],"oindentp":[["all",MAX$399],["all",1]],"cindent":[["all",1],["all",MAX$399]],"obrack":[["all",MAX$399],["all",2]],"cbrack":[["all",2],["all",MAX$399]],"lwi_pfx":[["all",MAX$399],["all",10]],"lwi_ifx":[["all",12],["all",11]],"lwi_sfx":[["all",13],["all",MAX$399]],"wnl":[["all",15],["all",15]],"lsh_pfx":[["all",MAX$399],["all",20]],"lsh_ifx":[["all",22],["all",21]],"lsh_sfx":[["all",23],["all",MAX$399]],"snl":[["all",25],["all",25]],"wi_pfx":[["all",MAX$399],["all",110]],"comma":[["all",112],["all",111]],"wi_ifx":[["all",112],["all",111]],"wi_sfx":[["all",113],["all",MAX$399]],"wjuxt":[["all",115],["all",115]],"period":[["all",119],["all",MAX$399]],"sh_pfx":[["all",MAX$399],["all",120]],"sh_ifx":[["all",122],["all",121]],"sh_sfx":[["all",123],["all",MAX$399]],"sjuxt":[["all",125],["all",125]]}))),SimplePriority$382(q_groups$2179,q_prio$2180)));(finalize$402=function($2191$2194){var t0$2205;var $index$2286;var $length$2280;var temp$2274;var $index$2324;var $length$2318;var temp$2312;var $index$2368;var $length$2362;var temp$2356;var $2509$2514;var t0$2579;var t0$2586;var mid2$2642;var $2619$2624;var $2555$2568;var $2556$2569;var $2557$2570;var bridge$2552$2565;var t0$2566;var $2550$2560;var w$2547;var $2497$2539;var width$2503;var _insert$2504;var start$2505;var end$2506;var pre$2459;var inds$2460;var mid$2461;var inde$2462;var t0$2451;var t1$2452;var t2$2453;var t3$2454;var t4$2455;var $2247$2446;var t0$2686;var t1$2687;var sumloc$2251;var rval$2252;var left$2253;var ops$2239;var args$2240;var text$2225;var $2200$2221;var $2201$2222;var t0$2219;var $2196$2214;var ph$2202;var x$2203;(t0$2205=$2191$2194);(x$2203=t0$2205);(ph$2202=t0$2205);($2196$2214=ph$2202);if((($2200$2221=($2196$2214 instanceof Array))&&(((t0$2219=$2196$2214.length)),((t0$2219===2)&&($2196$2214[0]==="ID"))))){(text$2225=$2196$2214[1]);return __lt____lt____colon__$376(["text",text$2225],x$2203);}else{if(($2200$2221&&((t0$2219===1)&&($2196$2214[0]==="VOID")))){return __lt____lt____colon__$376(["text",""],x$2203.location.at_start());}else{if(($2200$2221&&(t0$2219>=1))){(ops$2239=$2196$2214[0]);(args$2240=Array.prototype.slice.call($2196$2214,1));(sumloc$2251=ops$2239[0].location);(temp$2274=ops$2239.slice(1));($length$2280=temp$2274.length);($index$2286=0);$2254:for(;($index$2286<$length$2280);($index$2286++)){var op$2303;var m$2295;(m$2295=temp$2274[$index$2286]);(op$2303=m$2295);(sumloc$2251=__plus____plus____colon__$377(sumloc$2251,op$2303));}(temp$2312=args$2240);($length$2318=temp$2312.length);($index$2324=0);$2257:for(;($index$2324<$length$2318);($index$2324++)){var arg$2341;var m$2333;(m$2333=temp$2312[$index$2324]);(arg$2341=m$2333);(sumloc$2251=__plus____plus____colon__$377(sumloc$2251,arg$2341));}(rval$2252=["seq"]);(left$2253=0);(temp$2356=$5825(args$2240));($length$2362=temp$2356.length);($index$2368=0);$2260:for(;($index$2368<$length$2362);($index$2368++)){var t0$2422;var t1$2423;var o$2418;var name$2419;var l$2420;var i$2410;var arg$2411;var arg$2391;var $2264$2385;var $2265$2386;var $2266$2387;var $2267$2388;var t0$2382;var t1$2383;var m$2377;(m$2377=temp$2356[$index$2368]);(t0$2382=m$2377);if((($2265$2386=(t0$2382 instanceof Array))&&(((t1$2383=t0$2382.length)),(($2267$2388=(t1$2383===2))&&(t0$2382[0]===0))))){(arg$2391=t0$2382[1]);rval$2252.push(arg$2391);(left$2253=arg$2391.location.end);}else{if($2267$2388){(i$2410=t0$2382[0]);(arg$2411=t0$2382[1]);(t0$2422=$256(ops$2239,(i$2410-1)));(o$2418=t0$2422);if(((t0$2422 instanceof Array)&&(((t1$2423=t0$2422.length)),(t1$2423===3)))){t0$2422[0];t0$2422[1];(name$2419=t0$2422[2]);}else{$5573($256(ops$2239,(i$2410-1)),"/home/olivier/git/egquaint/src/index.eg",13017,13040);}(l$2420=arg$2411.location);rval$2252.push($257(["oper",name$2419],({"location":Location$375(l$2420.source,left$2253,l$2420.start)})),arg$2411);(left$2253=arg$2411.location.end);}else{$5573(m$2377,"/home/olivier/git/egquaint/src/index.eg",12854,13258);}}}($2247$2446=rval$2252);if((($2247$2446 instanceof Array)&&(((t0$2451=$2247$2446.length)),((t0$2451===6)&&(($2247$2446[0]==="seq")&&((pre$2459=$2247$2446[1]),(((t1$2452=$2247$2446[2])),((inds$2460=t1$2452),((t1$2452 instanceof Array)&&(((t2$2453=t1$2452.length)),((t2$2453===2)&&((t1$2452[0]==="oper")&&((t1$2452[1]==="I(")&&((mid$2461=$2247$2446[3]),(((t3$2454=$2247$2446[4])),((inde$2462=t3$2454),((t3$2454 instanceof Array)&&(((t4$2455=t3$2454.length)),((t4$2455===2)&&((t3$2454[0]==="oper")&&(t3$2454[1]===")I"))))))))))))))))))))){$2247$2446[5];(width$2503=((($2509$2514=(inds$2460.location.text().split("\n").length-1))),function(){if(($2509$2514>1)){return "wide";}else{$2509$2514;return "short";}}()));(_insert$2504=function(m$2532,v$2533){m$2532.shift();m$2532.unshift(__lt____lt____colon__$376(["oper","NL"],inds$2460));m$2532.unshift(v$2533);m$2532.unshift("seq");return __lt____lt____colon__$376(m$2532,__plus____plus____colon__$377(v$2533.location,m$2532.location));});($2497$2539=mid$2461);if(($5524($2497$2539,"operator")&&(($2497$2539.operator==="NL")&&$5524($2497$2539,"width")))){(w$2547=$2497$2539.width);($2550$2560=[width$2503,w$2547]);(bridge$2552$2565=$2550$2560);if((((bridge$2552$2565 instanceof Array)&&(((t0$2579=bridge$2552$2565.length)),((t0$2579===2)&&((bridge$2552$2565[0]==="wide")&&(bridge$2552$2565[1]==="wide")))))||((bridge$2552$2565 instanceof Array)&&(((t0$2586=bridge$2552$2565.length)),((t0$2586===2)&&((bridge$2552$2565[0]==="short")&&(bridge$2552$2565[1]==="short"))))))){_insert$2504(mid$2461,pre$2459);}else{if((($2555$2568=($2550$2560 instanceof Array))&&(((t0$2566=$2550$2560.length)),(($2557$2570=(t0$2566===2))&&(($2550$2560[0]==="wide")&&($2550$2560[1]==="short")))))){(mid$2461=["seq",pre$2459,__lt____lt____colon__$376(["oper","NL"],inds$2460),mid$2461]);(mid$2461["operator"]="NL");(mid$2461["width"]=width$2503);}else{if(($2557$2570&&(($2550$2560[0]==="short")&&($2550$2560[1]==="wide")))){($2619$2624=mid$2461[1]);if(($5524($2619$2624,"operator")&&(($2619$2624.operator==="NL")&&($5524($2619$2624,"width")&&($2619$2624.width==="short"))))){_insert$2504(mid$2461[1],pre$2459);}else{$2619$2624;(mid2$2642=["seq",pre$2459,__lt____lt____colon__$376(["oper","NL"],inds$2460),mid$2461[1]]);(mid2$2642["operator"]="NL");(mid2$2642["width"]=width$2503);__lt____lt____colon__$376(mid2$2642,__plus____plus____colon__$377(pre$2459.location,mid$2461[1].location));(mid$2461[1]=mid2$2642);}}else{$5573($2550$2560);}}}}else{$2497$2539;(mid$2461=["seq",pre$2459,__lt____lt____colon__$376(["oper","NL"],inds$2460),mid$2461]);(mid$2461["operator"]="NL");(mid$2461["width"]=width$2503);}__lt____lt____colon__$376(mid$2461,sumloc$2251);(start$2505=pre$2459.location.at_start());(end$2506=pre$2459.location.at_start());(rval$2252=["seq",__lt____lt____colon__$376(["text",""],start$2505),__lt____lt____colon__$376(["oper","I("],start$2505),mid$2461,inde$2462,__lt____lt____colon__$376(["text",""],inde$2462.location.at_end())]);}else{$2247$2446;undefined;}(t0$2686=ops$2239[0]);if(((t0$2686 instanceof Array)&&(((t1$2687=t0$2686.length)),(t1$2687===3)))){t0$2686[0];(rval$2252["width"]=t0$2686[1]);(rval$2252["operator"]=t0$2686[2]);}else{$5573(ops$2239[0],"/home/olivier/git/egquaint/src/index.eg",15221,15235);}return __lt____lt____colon__$376(rval$2252,sumloc$2251);}else{$5573($2196$2214);}}}});(parse$403=function(tokens$2707){var next$2712;var order$2713;(next$2712=function(){return tokens$2707.shift();});(order$2713=function(){var a$2752;var b$2753;var t0$2747;var t1$2748;var $2726$2739;var t0$2735;var $2724$2730;($2724$2730=arguments);(t0$2735=$2724$2730.length);if((t0$2735>=0)){($2726$2739=Array.prototype.slice.call($2724$2730,0));(t0$2747=$2726$2739);(t1$2748=t0$2747.length);if((t1$2748===2)){(a$2752=t0$2747[0]);(b$2753=t0$2747[1]);return q_order$401.compare(a$2752,b$2753);}else{$5573($2726$2739,"/home/olivier/git/egquaint/src/index.eg",15306,15311);}}else{$5573($2724$2730);}});return oparse$383(next$2712,order$2713,finalize$402);});(extract$404=function($2773$2776){var $index$2832;var $length$2826;var temp$2820;var acc$2814;var newargs$2806;var other$2872;var args$2796;var t0$2792;var $2778$2787;var ph$2781;(ph$2781=$2773$2776);($2778$2787=ph$2781);if((($2778$2787 instanceof Array)&&(((t0$2792=$2778$2787.length)),((t0$2792>=1)&&($2778$2787[0]==="seq"))))){(args$2796=Array.prototype.slice.call($2778$2787,1));(newargs$2806=(((acc$2814=[])),(((temp$2820=$5825(args$2796))),((($length$2826=temp$2820.length)),((($index$2832=0)),function(){$2809:for(;($index$2832<$length$2826);($index$2832++)){var i$2851;var arg$2852;var t0$2846;var t1$2847;var m$2841;(m$2841=temp$2820[$index$2832]);(t0$2846=m$2841);if(((t0$2846 instanceof Array)&&(((t1$2847=t0$2846.length)),((t1$2847===2)&&((i$2851=t0$2846[0]),((arg$2852=t0$2846[1]),$5957((i$2851%2),0))))))){acc$2814.push(arg$2852);}else{false;}}}()))),acc$2814));return ["seq",args$2796[1][1]].concat(newargs$2806);}else{(other$2872=$2778$2787);return other$2872;}});(parse_spec$405=function($2878$2881){var helper$2926;var tokens$2909;var ast$2910;var top$2911;var rval$2912;var top$3166;var rval$3167;var spec$2901;var t0$2897;var $2883$2892;var ph$2886;(ph$2886=$2878$2881);($2883$2892=ph$2886);if((typeof($2883$2892)==="string")){(spec$2901=$2883$2892);(tokens$2909=tokenize$398(Source$374(spec$2901)));(ast$2910=parse$403(tokens$2909));(top$2911=null);(rval$2912=(((helper$2926=function($2930$2933,opts$2934){var $index$3013;var $length$3007;var temp$3001;var acc$2995;var $index$3140;var $length$3134;var temp$3128;var acc$3122;var args$3106;var operator$3107;var contents$3078;var op$3073;var v$3068;var ast$3054;var ast$3049;var tags$2972;var pattern$2973;var $2945$2966;var $2946$2967;var $2947$2968;var $2948$2969;var t0$2960;var t1$2961;var t2$2962;var t3$2963;var t4$2964;var $2936$2955;var ph$2949;(ph$2949=$2930$2933);($2936$2955=ph$2949);(t0$2960=$6182(extract$404)($2936$2955));if((t0$2960[0]&&(((t1$2961=t0$2960[1])),(((t2$2962=t1$2961.length)),((t2$2962>=3)&&((t1$2961[0]==="seq")&&(t1$2961[1]==="JUXT"))))))){(tags$2972=Array.prototype.slice.call(t1$2961,2,-1));(pattern$2973=t1$2961[(t2$2962-1)]);return helper$2926(pattern$2973,$5851(opts$2934,$6229((((acc$2995=[])),(((temp$3001=tags$2972)),((($length$3007=temp$3001.length)),((($index$3013=0)),function(){$2990:for(;($index$3013<$length$3007);($index$3013++)){var tag$3032;var t0$3027;var t1$3028;var m$3022;(m$3022=temp$3001[$index$3013]);(t0$3027=m$3022);if(((t0$3027 instanceof Array)&&(((t1$3028=t0$3027.length)),((t1$3028===2)&&(t0$3027[0]==="text"))))){(tag$3032=t0$3027[1]);acc$2995.push([tag$3032,true]);}else{$5573(m$3022,"/home/olivier/git/egquaint/src/index.eg",16111,16156);}}}()))),acc$2995))));}else{(ast$3049=$2936$2955);if(opts$2934.wide){return ["iswide",helper$2926(ast$3049,$5851(opts$2934,({"wide":false})))];}else{(ast$3054=$2936$2955);if(opts$2934.short){return ["isshort",helper$2926(ast$3054,$5851(opts$2934,({"short":false})))];}else{if((($2945$2966=($2936$2955 instanceof Array))&&(((t0$2960=$2936$2955.length)),(($2947$2968=(t0$2960===2))&&(($2948$2969=($2936$2955[0]==="text"))&&($2936$2955[1]==="")))))){return ["eq",["text",""]];}else{if($2948$2969){(v$3068=$2936$2955[1]);return ["put",v$3068,(opts$2934.maybe===true)];}else{if(($2947$2968&&($2936$2955[0]==="oper"))){(op$3073=$2936$2955[1]);return ["eq",["oper",op$3073]];}else{if(($2945$2966&&((t0$2960===6)&&(($2936$2955[0]==="seq")&&($2936$2955[1],(((t1$2961=$2936$2955[2])),((t1$2961 instanceof Array)&&(((t2$2962=t1$2961.length)),((t2$2962===2)&&((t1$2961[0]==="oper")&&((t1$2961[1]==="[")&&((contents$3078=$2936$2955[3]),(((t3$2963=$2936$2955[4])),((t3$2963 instanceof Array)&&(((t4$2964=t3$2963.length)),((t4$2964===2)&&((t3$2963[0]==="oper")&&((t3$2963[1]==="]")&&($2936$2955[5],opts$2934.shed))))))))))))))))))){return helper$2926(contents$3078,$5851(opts$2934,({"shed":false})));}else{if(($2945$2966&&((t0$2960>=1)&&(($2936$2955[0]==="seq")&&((args$3106=Array.prototype.slice.call($2936$2955,1)),$5524($2936$2955,"operator")))))){(operator$3107=$2936$2955.operator);if((!top$2911)){(top$2911=operator$3107);}return ["seq"].concat((((acc$3122=[])),(((temp$3128=args$3106)),((($length$3134=temp$3128.length)),((($index$3140=0)),function(){$3117:for(;($index$3140<$length$3134);($index$3140++)){var arg$3157;var m$3149;(m$3149=temp$3128[$index$3140]);(arg$3157=m$3149);acc$3122.push(helper$2926(arg$3157,opts$2934));}}()))),acc$3122));}else{$5573($2936$2955);}}}}}}}}})),helper$2926(ast$2910,({"shed":true}))));return [top$2911,rval$2912];}else{if((($2883$2892 instanceof Array)&&(((t0$2897=$2883$2892.length)),(t0$2897===2)))){(top$3166=$2883$2892[0]);(rval$3167=$2883$2892[1]);return [top$3166,rval$3167];}else{$5573($2883$2892);}}});(make_extractor$406=function($3181$3184){var t0$3189;var t1$3190;var t2$3191;var top$3186;var spec$3187;(t0$3189=$6182(parse_spec$405)($3181$3184));if((t0$3189[0]&&(((t1$3190=t0$3189[1])),(((t2$3191=t1$3190.length)),(t2$3191===2))))){(top$3186=t1$3190[0]);(spec$3187=t1$3190[1]);}else{$5573($3181$3184);}return [top$3186,function(node$3211){var helper$3215;(helper$3215=function($3219$3222,node$3223){var t0$3283;var $3273$3278;var x$3306;var $index$3368;var $length$3362;var temp$3356;var rval$3346;var other$3423;var args$3335;var t0$3331;var $3321$3326;var f$3427;var subspecs$3313;var v$3269;var maybe$3270;var subspec$3264;var subspec$3254;var $3233$3249;var $3234$3250;var $3235$3251;var t0$3247;var $3225$3242;var ph$3236;(ph$3236=$3219$3222);($3225$3242=ph$3236);if((($3233$3249=($3225$3242 instanceof Array))&&(((t0$3247=$3225$3242.length)),(($3235$3251=(t0$3247===2))&&($3225$3242[0]==="iswide"))))){(subspec$3254=$3225$3242[1]);return ($5957(node$3223.width,"wide")&&helper$3215(subspec$3254,node$3223));}else{if(($3235$3251&&($3225$3242[0]==="isshort"))){(subspec$3264=$3225$3242[1]);return ($5957(node$3223.width,"short")&&helper$3215(subspec$3264,node$3223));}else{if(($3233$3249&&((t0$3247===3)&&($3225$3242[0]==="put")))){(v$3269=$3225$3242[1]);(maybe$3270=$3225$3242[2]);($3273$3278=node$3223);if((($3273$3278 instanceof Array)&&(((t0$3283=$3273$3278.length)),((t0$3283===2)&&(($3273$3278[0]==="text")&&(($3273$3278[1]==="")&&(!maybe$3270))))))){return false;}else{$3273$3278;return (function(){var $6296={};$6296[v$3269]=node$3223;;return $6296;}());}}else{if(($3233$3249&&((t0$3247===2)&&(($3225$3242[0]==="eq")&&$5957($3225$3242[1],node$3223))))){return ({});}else{if((((x$3306=$3225$3242)),((x$3306 instanceof Array)&&(x$3306[0]==="eq")))){return false;}else{if((($3233$3249=($3225$3242 instanceof Array))&&(((t0$3247=$3225$3242.length)),((t0$3247>=1)&&($3225$3242[0]==="seq"))))){(subspecs$3313=Array.prototype.slice.call($3225$3242,1));($3321$3326=node$3223);if((($3321$3326 instanceof Array)&&(((t0$3331=$3321$3326.length)),((t0$3331>=1)&&(($3321$3326[0]==="seq")&&((args$3335=Array.prototype.slice.call($3321$3326,1)),$5957(subspecs$3313.length,args$3335.length))))))){(rval$3346=({}));(temp$3356=$6297(subspecs$3313,args$3335));($length$3362=temp$3356.length);($index$3368=0);$3347:for(;($index$3368<$length$3362);($index$3368++)){var vars$3417;var $3400$3405;var subspec$3387;var arg$3388;var t0$3382;var t1$3383;var m$3377;(m$3377=temp$3356[$index$3368]);(t0$3382=m$3377);if(((t0$3382 instanceof Array)&&(((t1$3383=t0$3382.length)),(t1$3383===2)))){(subspec$3387=t0$3382[0]);(arg$3388=t0$3382[1]);($3400$3405=helper$3215(subspec$3387,arg$3388));if((!$3400$3405)){return false;}else{(vars$3417=$3400$3405);$257(rval$3346,vars$3417);}}else{$5573(m$3377,"/home/olivier/git/egquaint/src/index.eg",17630,17904);}}return rval$3346;}else{(other$3423=$3321$3326);return false;}}else{if(($3233$3249&&((t0$3247===2)&&($3225$3242[0]==="fn")))){(f$3427=$3225$3242[1]);return f$3427(node$3223);}else{$5573($3225$3242);}}}}}}}});return helper$3215(spec$3187,node$3211);}];});(Dispatcher$407=function(){var it$0$3440;(it$0$3440=function(){if((!$237(Dispatcher$407)(this))){return Object.create(Dispatcher$407.prototype);}else{return this;}}());(it$0$3440["dispatch"]=[]);return it$0$3440;});(Dispatcher$407.prototype["handler"]=function(node$3455){var $index$3512;var $length$3506;var temp$3500;var candidates$3491;var $3470$3479;var key$3473;var it$0$3459;var self$3460;(it$0$3459=this);(self$3460=this);(key$3473=node$3455.operator);($3470$3479=$256(it$0$3459.dispatch,key$3473));if(($3470$3479===(void 0))){return false;}else{(candidates$3491=$3470$3479);(temp$3500=candidates$3491);($length$3506=temp$3500.length);($index$3512=0);$3494:for(;($index$3512<$length$3506);($index$3512++)){var parts$3545;var t0$3541;var $3531$3536;var c$3529;var m$3521;(m$3521=temp$3500[$index$3512]);(c$3529=m$3521);($3531$3536=node$3455);(t0$3541=$6182(c$3529)($3531$3536));if(t0$3541[0]){(parts$3545=t0$3541[1]);return [parts$3545,c$3529];}else{$3531$3536;undefined;}}return false;}});(Dispatcher$407.prototype["register"]=function(handler$3559){var key$3575;var l$3576;var it$0$3563;var self$3564;(it$0$3563=this);(self$3564=this);(key$3575=handler$3559.operator);(l$3576=(it$0$3563.dispatch[key$3575]=($256(it$0$3563.dispatch,key$3575)||[])));return l$3576.unshift(handler$3559);});(Dispatcher$407.prototype["clone"]=function(){var $index$3631;var $length$3625;var temp$3619;var acc$3613;var d$3602;var it$0$3590;var self$3591;(it$0$3590=this);(self$3591=this);(d$3602=Dispatcher$407());(d$3602["dispatch"]=$6229((((acc$3613=[])),(((temp$3619=$6361(it$0$3590.dispatch))),((($length$3625=temp$3619.length)),((($index$3631=0)),function(){$3608:for(;($index$3631<$length$3625);($index$3631++)){var key$3650;var l$3651;var t0$3645;var t1$3646;var m$3640;(m$3640=temp$3619[$index$3631]);(t0$3645=m$3640);if(((t0$3645 instanceof Array)&&(((t1$3646=t0$3645.length)),(t1$3646===2)))){(key$3650=t0$3645[0]);(l$3651=t0$3645[1]);acc$3613.push([key$3650,l$3651.slice(0)]);}else{$5573(m$3640,"/home/olivier/git/egquaint/src/index.eg",18639,18706);}}}()))),acc$3613)));return d$3602;});$257(Dispatcher$407,$257(((accum$3670=({})),((accum$3670["::name"]="Dispatcher"),accum$3670)),((accum$3674=({})),((accum$3674["::egclass"]=true),accum$3674))));Dispatcher$407;(Engine$408=function(){var $index$3744;var $length$3738;var temp$3732;var acc$3726;var env$3701;var t0$3697;var $3688$3692;var it$0$3683;(it$0$3683=function(){if((!$237(Engine$408)(this))){return Object.create(Engine$408.prototype);}else{return this;}}());($3688$3692=arguments);(t0$3697=$3688$3692.length);if(((t0$3697>=1)&&(t0$3697<=2))){(it$0$3683["dispatch"]=$3688$3692[0]);(env$3701=function(){if((1>=t0$3697)){return ({});}else{return $3688$3692[1];}}());(it$0$3683["gen"]=Generator$385(true));(it$0$3683["glob"]=it$0$3683.gen.evaluate(Source$374("globals: global, global","<quaint>")));(env$3701=$5851(env$3701,({"engine":it$0$3683})));(acc$3726=[]);(temp$3732=$6361(env$3701));($length$3738=temp$3732.length);($index$3744=0);$3712:for(;($index$3744<$length$3738);($index$3744++)){var k$3763;var v$3764;var t0$3758;var t1$3759;var m$3753;(m$3753=temp$3732[$index$3744]);(t0$3758=m$3753);if(((t0$3758 instanceof Array)&&(((t1$3759=t0$3758.length)),(t1$3759===2)))){(k$3763=t0$3758[0]);(v$3764=t0$3758[1]);acc$3726.push(it$0$3683.setenv(k$3763,v$3764));}else{$5573(m$3753,"/home/olivier/git/egquaint/src/index.eg",18911,18964);}}acc$3726;}else{$5573($3688$3692);}return it$0$3683;});(Engine$408.prototype["setenv"]=function(v$3786,value$3787){var it$0$3791;var self$3792;(it$0$3791=this);(self$3792=this);it$0$3791.gen.env.bind(topscope$387,v$3786,["variable",v$3786]);(it$0$3791.glob[v$3786]=value$3787);return null;});(Engine$408.prototype["run"]=function($3808$3811){var tokens$3853;var parsed$3854;var node$3863;var src$3847;var text$3842;var $3824$3834;var ph$3828;var it$0$3815;var self$3816;(it$0$3815=this);(self$3816=this);(ph$3828=$3808$3811);($3824$3834=ph$3828);if((typeof($3824$3834)==="string")){(text$3842=$3824$3834);return it$0$3815.run(Source$374(text$3842));}else{if($237(Source$374)($3824$3834)){(src$3847=$3824$3834);(tokens$3853=tokenize$398(src$3847));(parsed$3854=parse$403(tokens$3853));return it$0$3815._run(parsed$3854);}else{(node$3863=$3824$3834);return it$0$3815._run(node$3863);}}});(Engine$408.prototype["_run"]=function($3868$3871){var t0$3891;var t0$3917;var t0$3925;var l$3935;var $index$4017;var $length$4011;var temp$4005;var acc$3999;var values$4039;var handler$4040;var t0$3988;var $3978$3983;var parts$3970;var t$3910;var bridge$3886$3905;var t0$3906;var $3884$3900;var ph$3888;var node$3889;var it$0$3875;var self$3876;(it$0$3875=this);(self$3876=this);(t0$3891=$3868$3871);(node$3889=t0$3891);(ph$3888=t0$3891);($3884$3900=ph$3888);(bridge$3886$3905=$3884$3900);if((((bridge$3886$3905 instanceof Array)&&(((t0$3917=bridge$3886$3905.length)),((t0$3917===2)&&((bridge$3886$3905[0]==="text")&&((t$3910=bridge$3886$3905[1]),true)))))||((bridge$3886$3905 instanceof Array)&&(((t0$3925=bridge$3886$3905.length)),((t0$3925===2)&&((bridge$3886$3905[0]==="oper")&&((t$3910=bridge$3886$3905[1]),true))))))){(l$3935=node$3889.location);return node$3889.location.text().replace(RegExp("~|\\\\.","g"),function($3940$3943){var s$3966;var $3945$3954;var ph$3948;(ph$3948=$3940$3943);($3945$3954=ph$3948);if(($3945$3954==="~")){return "";}else{(s$3966=$3945$3954);return s$3966[1];}});}else{if((($3884$3900 instanceof Array)&&(((t0$3906=$3884$3900.length)),((t0$3906>=1)&&($3884$3900[0]==="seq"))))){(parts$3970=Array.prototype.slice.call($3884$3900,1));($3978$3983=it$0$3875.dispatch.handler(node$3889));if((!$3978$3983)){return $6378(["span"],({}),(((acc$3999=[])),(((temp$4005=parts$3970)),((($length$4011=temp$4005.length)),((($index$4017=0)),function(){$3994:for(;($index$4017<$length$4011);($index$4017++)){var part$4034;var m$4026;(m$4026=temp$4005[$index$4017]);(part$4034=m$4026);acc$3999.push(it$0$3875.run(part$4034));}}()))),acc$3999));}else{if((($3978$3983 instanceof Array)&&(((t0$3988=$3978$3983.length)),(t0$3988===2)))){(values$4039=$3978$3983[0]);(handler$4040=$3978$3983[1]);return handler$4040.run(it$0$3875,node$3889,values$4039);}else{$5573($3978$3983);}}}else{$5573($3884$3900);}}});(Engine$408.prototype["eval"]=function(code$4056){var it$0$4060;var self$4061;(it$0$4060=this);(self$4061=this);return it$0$4060.gen.evaluate(Source$374(code$4056,"<quaint>"));});$257(Engine$408,$257(((accum$4072=({})),((accum$4072["::name"]="Engine"),accum$4072)),((accum$4076=({})),((accum$4076["::egclass"]=true),accum$4076))));Engine$408;(Spec$409=function($4082$4087,$4084$4088){var t0$4098;var t1$4099;var t2$4100;var it$0$4091;(it$0$4091=function(){if((!$237(Spec$409)(this))){return Object.create(Spec$409.prototype);}else{return this;}}());(t0$4098=$6182(make_extractor$406)($4082$4087));if((t0$4098[0]&&(((t1$4099=t0$4098[1])),(((t2$4100=t1$4099.length)),(t2$4100===2))))){(it$0$4091["operator"]=t1$4099[0]);(it$0$4091["extractor"]=t1$4099[1]);}else{$5573($4082$4087);}(it$0$4091["run"]=$4084$4088);undefined;return it$0$4091;});(Spec$409.prototype[":::project"]=function($4125$4128){var t0$4146;var values$4168;var $4141$4156;var ph$4144;var it$0$4132;var self$4133;(it$0$4132=this);(self$4133=this);(t0$4146=$6182(it$0$4132.extractor)($4125$4128));if(t0$4146[0]){(ph$4144=t0$4146[1]);}else{$5573($4125$4128);}($4141$4156=ph$4144);if((!$4141$4156)){return [false,null];}else{(values$4168=$4141$4156);return [true,values$4168];}});$257(Spec$409,$257(((accum$4173=({})),((accum$4173["::name"]="Spec"),accum$4173)),((accum$4177=({})),((accum$4177["::egclass"]=true),accum$4177))));Spec$409;(dispatch$410=Dispatcher$407());(mergeable$411=function(tag$4187,child$4188){var merge$4194;var node$4195;(merge$4194=function($4199$4202){var t0$4210;var other$4252;var tags$4230;var props$4231;var children$4232;var t0$4224;var t1$4225;var t2$4226;var $4204$4219;var ph$4207;var node$4208;(t0$4210=$4199$4202);(node$4208=t0$4210);(ph$4207=t0$4210);($4204$4219=ph$4207);(t0$4224=$6182($6378([tag$4187],({}),[]))($4204$4219));if((t0$4224[0]&&(((t1$4225=t0$4224[1])),(((t2$4226=t1$4225.length)),(t2$4226===3))))){(tags$4230=t1$4225[0]);(props$4231=t1$4225[1]);(children$4232=t1$4225[2]);(this["children"]=this.children.concat(children$4232));return this;}else{(other$4252=$4204$4219);return false;}});(node$4195=$6378([tag$4187],({}),child$4188));(node$4195["merge"]=merge$4194);return node$4195;});(collapse$412=function(operator$4268,$4265$4269){var node$4311;var l$4291;var r$4292;var t0$4285;var t1$4286;var t2$4287;var $4271$4280;var ph$4274;(ph$4274=$4265$4269);($4271$4280=ph$4274);(t0$4285=$6182(extract$404)($4271$4280));if((t0$4285[0]&&(((t1$4286=t0$4285[1])),(((t2$4287=t1$4286.length)),((t2$4287===4)&&((t1$4286[0]==="seq")&&(t1$4286[1]===operator$4268))))))){(l$4291=t1$4286[2]);(r$4292=t1$4286[3]);return [l$4291].concat(collapse$412(operator$4268,r$4292));}else{(node$4311=$4271$4280);return [node$4311];}});(shed$413=function(){var lw$4393;var rw$4394;var loc$4395;var node$4407;var ob$4352;var mid$4353;var cb$4354;var t0$4343;var t1$4344;var t2$4345;var t3$4346;var t4$4347;var t5$4348;var n$4334;var $4320$4335;var t0$4330;var $4318$4325;($4318$4325=arguments);(t0$4330=$4318$4325.length);if(((t0$4330>=1)&&(t0$4330<=2))){($4320$4335=$4318$4325[0]);(n$4334=function(){if((1>=t0$4330)){return 1;}else{return $4318$4325[1];}}());(t0$4343=$4320$4335);(t1$4344=t0$4343.length);if(((t1$4344===6)&&((t0$4343[0]==="seq")&&(t0$4343[1],(((t2$4345=t0$4343[2])),((ob$4352=t2$4345),((t2$4345 instanceof Array)&&(((t3$4346=t2$4345.length)),((t3$4346===2)&&((t2$4345[0]==="oper")&&((t2$4345[1]==="[")&&((mid$4353=t0$4343[3]),(((t4$4347=t0$4343[4])),((cb$4354=t4$4347),((t4$4347 instanceof Array)&&(((t5$4348=t4$4347.length)),((t5$4348===2)&&((t4$4347[0]==="oper")&&(t4$4347[1]==="]"))))))))))))))))))){t0$4343[5];if((n$4334>1)){return shed$413(mid$4353,(n$4334-1));}else{(lw$4393=ob$4352.location.text().split("[").pop());(rw$4394=cb$4354.location.text().split("]").shift());(loc$4395=mid$4353.location);return $5851(mid$4353,({"location":Location$375(loc$4395.source,(loc$4395.start-lw$4393.length),(loc$4395.end+rw$4394.length))}));}}else{(node$4407=$4320$4335);return node$4407;}}else{$5573($4318$4325);}});(shed_all$414=function(node$4416){return shed$413(node$4416,(1/0));});(shed_indent$415=function($4422$4425){var x$4497;var t0$4489;var t1$4490;var t2$4491;var t3$4492;var t4$4493;var $4479$4484;var node$4530;var mid$4449;var t0$4441;var t1$4442;var t2$4443;var t3$4444;var t4$4445;var $4427$4436;var ph$4430;(ph$4430=$4422$4425);($4427$4436=ph$4430);if((($4427$4436 instanceof Array)&&(((t0$4441=$4427$4436.length)),((t0$4441===6)&&(($4427$4436[0]==="seq")&&($4427$4436[1],(((t1$4442=$4427$4436[2])),((t1$4442 instanceof Array)&&(((t2$4443=t1$4442.length)),((t2$4443===2)&&((t1$4442[0]==="oper")&&((t1$4442[1]==="I(")&&((mid$4449=$4427$4436[3]),(((t3$4444=$4427$4436[4])),((t3$4444 instanceof Array)&&(((t4$4445=t3$4444.length)),((t4$4445===2)&&((t3$4444[0]==="oper")&&(t3$4444[1]===")I"))))))))))))))))))){$4427$4436[5];($4479$4484=mid$4449);if((($4479$4484 instanceof Array)&&(((t0$4489=$4479$4484.length)),((t0$4489===4)&&(($4479$4484[0]==="seq")&&(((t1$4490=$4479$4484[1])),((t1$4490 instanceof Array)&&(((t2$4491=t1$4490.length)),((t2$4491===2)&&((t1$4490[0]==="text")&&((t1$4490[1]==="")&&(((t3$4492=$4479$4484[2])),((t3$4492 instanceof Array)&&(((t4$4493=t3$4492.length)),((t4$4493===2)&&((t3$4492[0]==="oper")&&(t3$4492[1]==="NL"))))))))))))))))){(x$4497=$4479$4484[3]);return x$4497;}else{$4479$4484;return mid$4449;}}else{(node$4530=$4427$4436);return node$4530;}});(components$416=$257(((accum$4553=({})),((accum$4553["[[x]]"]=function(engine$4562,$4557$4563,$4559$4564){var t0$4570;var t1$4571;var o$4566;var x$4567;var c$4568;(t0$4570=$4557$4563);if(((t0$4570 instanceof Array)&&(((t1$4571=t0$4570.length)),((t1$4571===6)&&(t0$4570[0]==="seq"))))){t0$4570[1];(o$4566=t0$4570[2]);(x$4567=t0$4570[3]);(c$4568=t0$4570[4]);t0$4570[5];}else{$5573($4557$4563);}$4559$4564;return $6378(["span"],({}),[o$4566.location.text().replace("[",""),engine$4562.run(x$4567),c$4568.location.text().replace("]","")]);}),accum$4553)),$257(((accum$4588=({})),((accum$4588["{x}"]=function(engine$4595,node$4596,$4592$4597){var t0$4601;var x$4599;(t0$4601=$4592$4597);if($5524(t0$4601,"x")){(x$4599=t0$4601.x);}else{$5573($4592$4597);}return engine$4595.eval(x$4599.location.text());}),accum$4588)),$257(((accum$4610=({})),((accum$4610["_ x"]=function(engine$4617,node$4618,$4614$4619){var t0$4623;var x$4621;(t0$4623=$4614$4619);if($5524(t0$4623,"x")){(x$4621=t0$4623.x);}else{$5573($4614$4619);}return $6378(["i"],({}),engine$4617.run(x$4621));}),accum$4610)),$257(((accum$4632=({})),((accum$4632["__ x"]=function(engine$4639,node$4640,$4636$4641){var t0$4645;var x$4643;(t0$4645=$4636$4641);if($5524(t0$4645,"x")){(x$4643=t0$4645.x);}else{$5573($4636$4641);}return $6378(["b"],({}),engine$4639.run(x$4643));}),accum$4632)),$257(((accum$4654=({})),((accum$4654["` x"]=function(engine$4661,node$4662,$4658$4663){var t0$4667;var t1$4668;var x$4665;(t0$4667=$4658$4663);if(($5524(t0$4667,"x")&&(((t1$4668=$6182(shed$413)(t0$4667.x))),t1$4668[0]))){(x$4665=t1$4668[1]);}else{$5573($4658$4663);}return $6378(["code"],({}),x$4665.location.text());}),accum$4654)),$257(((accum$4682=({})),((accum$4682["descr .. maybe contents"]=function(engine$4689,node$4690,$4686$4691){var t0$4696;var $index$4743;var $length$4737;var temp$4731;var parts$4710;var id$4711;var tags$4712;var props$4713;var descr$4693;var contents$4694;(t0$4696=$4686$4691);if(($5524(t0$4696,"descr")&&((descr$4693=t0$4696.descr),$5524(t0$4696,"contents")))){(contents$4694=t0$4696.contents);}else{$5573($4686$4691);}(parts$4710=descr$4693.location.text().split(RegExp("[ +]|(?=\\.|#)","")));(id$4711=null);(tags$4712=[]);(temp$4731=parts$4710);($length$4737=temp$4731.length);($index$4743=0);$4714:for(;($index$4743<$length$4737);($index$4743++)){var tag$4790;var _id$4767;var t0$4757;var t1$4758;var t2$4759;var m$4752;(m$4752=temp$4731[$index$4743]);if((m$4752==="")){undefined;}else{(t0$4757=$6182(RegExp("^#(.*)",""))(m$4752));if((t0$4757[0]&&(((t1$4758=t0$4757[1])),(((t2$4759=t1$4758.length)),(t2$4759===2))))){t1$4758[0];(_id$4767=t1$4758[1]);(id$4711=_id$4767);}else{(tag$4790=m$4752);tags$4712.push(tag$4790);}}}(props$4713=({}));if(id$4711){(props$4713["id"]=id$4711);}return $6378(tags$4712,props$4713,[engine$4689.run(shed_indent$415(contents$4694))]);}),accum$4682)),$257(((accum$4801=({})),((accum$4801["wide [= x]"]=function(engine$4808,node$4809,$4805$4810){var t0$4814;var x$4812;(t0$4814=$4805$4810);if($5524(t0$4814,"x")){(x$4812=t0$4814.x);}else{$5573($4805$4810);}return $6378(["h1"],({}),engine$4808.run(x$4812));}),accum$4801)),$257(((accum$4823=({})),((accum$4823["wide [== x]"]=function(engine$4830,node$4831,$4827$4832){var t0$4836;var x$4834;(t0$4836=$4827$4832);if($5524(t0$4836,"x")){(x$4834=t0$4836.x);}else{$5573($4827$4832);}return $6378(["h2"],({}),engine$4830.run(x$4834));}),accum$4823)),$257(((accum$4845=({})),((accum$4845["wide [=== x]"]=function(engine$4852,node$4853,$4849$4854){var t0$4858;var x$4856;(t0$4858=$4849$4854);if($5524(t0$4858,"x")){(x$4856=t0$4858.x);}else{$5573($4849$4854);}return $6378(["h3"],({}),engine$4852.run(x$4856));}),accum$4845)),$257(((accum$4867=({})),((accum$4867["wide [==== x]"]=function(engine$4874,node$4875,$4871$4876){var t0$4880;var x$4878;(t0$4880=$4871$4876);if($5524(t0$4880,"x")){(x$4878=t0$4880.x);}else{$5573($4871$4876);}return $6378(["h4"],({}),engine$4874.run(x$4878));}),accum$4867)),$257(((accum$4889=({})),((accum$4889["wide [===== x]"]=function(engine$4896,node$4897,$4893$4898){var t0$4902;var x$4900;(t0$4902=$4893$4898);if($5524(t0$4902,"x")){(x$4900=t0$4902.x);}else{$5573($4893$4898);}return $6378(["h5"],({}),engine$4896.run(x$4900));}),accum$4889)),$257(((accum$4911=({})),((accum$4911["wide [====== x]"]=function(engine$4918,node$4919,$4915$4920){var t0$4924;var x$4922;(t0$4924=$4915$4920);if($5524(t0$4924,"x")){(x$4922=t0$4924.x);}else{$5573($4915$4920);}return $6378(["h6"],({}),engine$4918.run(x$4922));}),accum$4911)),$257(((accum$4933=({})),((accum$4933["wide [# x]"]=function(engine$4940,node$4941,$4937$4942){var t0$4946;var x$4944;(t0$4946=$4937$4942);if($5524(t0$4946,"x")){(x$4944=t0$4946.x);}else{$5573($4937$4942);}return mergeable$411("ol",$6378(["li"],({}),engine$4940.run(x$4944)));}),accum$4933)),$257(((accum$4955=({})),((accum$4955["wide [* x]"]=function(engine$4962,node$4963,$4959$4964){var t0$4968;var x$4966;(t0$4968=$4959$4964);if($5524(t0$4968,"x")){(x$4966=t0$4968.x);}else{$5573($4959$4964);}return mergeable$411("ul",$6378(["li"],({}),engine$4962.run(x$4966)));}),accum$4955)),$257(((accum$4977=({})),((accum$4977["wide [+ x]"]=function(engine$4984,node$4985,$4981$4986){var t0$4990;var $index$5027;var $length$5021;var temp$5015;var acc$5009;var args$5000;var x$4988;(t0$4990=$4981$4986);if($5524(t0$4990,"x")){(x$4988=t0$4990.x);}else{$5573($4981$4986);}(args$5000=collapse$412("+",x$4988));return mergeable$411("table",$6378(["tr"],({}),(((acc$5009=[])),(((temp$5015=args$5000)),((($length$5021=temp$5015.length)),((($index$5027=0)),function(){$5004:for(;($index$5027<$length$5021);($index$5027++)){var arg$5044;var m$5036;(m$5036=temp$5015[$index$5027]);(arg$5044=m$5036);acc$5009.push($6378(["th"],({}),engine$4984.run(arg$5044)));}}()))),acc$5009)));}),accum$4977)),$257(((accum$5048=({})),((accum$5048["wide [| x]"]=function(engine$5055,node$5056,$5052$5057){var t0$5061;var $index$5098;var $length$5092;var temp$5086;var acc$5080;var args$5071;var x$5059;(t0$5061=$5052$5057);if($5524(t0$5061,"x")){(x$5059=t0$5061.x);}else{$5573($5052$5057);}(args$5071=collapse$412("|",x$5059));return mergeable$411("table",$6378(["tr"],({}),(((acc$5080=[])),(((temp$5086=args$5071)),((($length$5092=temp$5086.length)),((($index$5098=0)),function(){$5075:for(;($index$5098<$length$5092);($index$5098++)){var arg$5115;var m$5107;(m$5107=temp$5086[$index$5098]);(arg$5115=m$5107);acc$5080.push($6378(["td"],({}),engine$5055.run(arg$5115)));}}()))),acc$5080)));}),accum$5048)),((accum$5119=({})),((accum$5119["v <- value"]=function(engine$5126,node$5127,$5123$5128){var t0$5133;var v$5130;var value$5131;(t0$5133=$5123$5128);if(($5524(t0$5133,"v")&&((v$5130=t0$5133.v),$5524(t0$5133,"value")))){(value$5131=t0$5133.value);}else{$5573($5123$5128);}engine$5126.setenv(v$5130.location.text(),engine$5126.run(value$5131));return "";}),accum$5119)))))))))))))))))));(temp$5147=$6361(components$416));($length$5153=temp$5147.length);($index$5159=0);$418:for(;($index$5159<$length$5153);($index$5159++)){var spec$5178;var fn$5179;var t0$5173;var t1$5174;var m$5168;(m$5168=temp$5147[$index$5159]);(t0$5173=m$5168);if(((t0$5173 instanceof Array)&&(((t1$5174=t0$5173.length)),(t1$5174===2)))){(spec$5178=t0$5173[0]);(fn$5179=t0$5173[1]);dispatch$410.register(Spec$409(spec$5178,fn$5179));}else{$5573(m$5168,"/home/olivier/git/egquaint/src/index.eg",23080,23160);}}(filter$5197=function($5203$5206){var t0$5214;var args$5234;var t0$5228;var t1$5229;var t2$5230;var $5208$5223;var ph$5211;var node$5212;(t0$5214=$5203$5206);(node$5212=t0$5214);(ph$5211=t0$5214);($5208$5223=ph$5211);(t0$5228=$6182(extract$404)($5208$5223));if((t0$5228[0]&&(((t1$5229=t0$5228[1])),(((t2$5230=t1$5229.length)),((t2$5230>=2)&&((t1$5229[0]==="seq")&&(t1$5229[1]==="NL"))))))){(args$5234=Array.prototype.slice.call(t1$5229,2));return ({"args":args$5234});}else{$5208$5223;return false;}});(spec$5198=["NL",["fn",filter$5197]]);(fn$5199=function(engine$5266,$5261$5267,$5263$5268){var t0$5274;var t1$5275;var t0$5289;var $index$5401;var $length$5395;var temp$5389;var results$5304;var wide$5305;var last$5306;var run$5307;var i$5308;var add$5309;var node$5270;var elems$5271;var args$5272;(t0$5274=$5261$5267);(node$5270=t0$5274);if(((t0$5274 instanceof Array)&&(((t1$5275=t0$5274.length)),((t1$5275>=1)&&(t0$5274[0]==="seq"))))){(elems$5271=Array.prototype.slice.call(t0$5274,1));}else{$5573($5261$5267);}(t0$5289=$5263$5268);if($5524(t0$5289,"args")){(args$5272=t0$5289.args);}else{$5573($5263$5268);}(results$5304=[]);(wide$5305=$5957(node$5270.width,"wide"));(last$5306=null);(run$5307=engine$5266.run.bind(engine$5266));(i$5308=-3);(add$5309=function(){var $5361$5370;var $5357$5364;var addblank$5349;var t0$5345;var $5336$5340;($5336$5340=arguments);(t0$5345=$5336$5340.length);if(((t0$5345>=0)&&(t0$5345<=1))){(addblank$5349=function(){if((0>=t0$5345)){return true;}else{return $5336$5340[0];}}());results$5304.push(((($5357$5364=last$5306)),function(){if($237($6378(["div"],({}),[]))($5357$5364)){return last$5306;}else{$5357$5364;if(wide$5305){return $6378(["div"],({}),last$5306);}else{return last$5306;}}}()));if(addblank$5349){return results$5304.push($256(elems$5271,i$5308).location.text());}}else{$5573($5336$5340);}});(temp$5389=args$5272);($length$5395=temp$5389.length);($index$5401=0);$5310:for(;($index$5401<$length$5395);($index$5401++)){var newx$5465;var $5443$5448;var x$5473;var x$5440;var x$5431;var $5313$5419;var t0$5415;var m$5410;(m$5410=temp$5389[$index$5401]);(t0$5415=$6182(run$5307)(m$5410));if(t0$5415[0]){($5313$5419=t0$5415[1]);(i$5308=(i$5308+2));(x$5431=$5313$5419);if(($index$5401===0)){(last$5306=x$5431);}else{(x$5440=$5313$5419);if((last$5306&&last$5306.merge)){($5443$5448=last$5306.merge(x$5440));if((!$5443$5448)){add$5309();(last$5306=x$5440);}else{(newx$5465=$5443$5448);(last$5306=newx$5465);}}else{(x$5473=$5313$5419);add$5309();(last$5306=x$5473);}}}else{$5573(m$5410,"/home/olivier/git/egquaint/src/index.eg",23855,24214);}}(i$5308=(i$5308+2));if(last$5306){add$5309(false);}if(wide$5305){return $6378(["div",".blocks"],({}),results$5304);}else{return $6378(["span"],({}),results$5304);}});dispatch$410.register(Spec$409(spec$5198,fn$5199));(Quaint$417=Engine$408(dispatch$410));(exports["Quaint"]=Quaint$417);(exports["Engine"]=Engine$408);(exports["Spec"]=Spec$409);(exports["dispatch"]=dispatch$410);(exports["shed"]=shed$413);(exports["shed_all"]=shed_all$414);(exports["shed_indent"]=shed_indent$415);(exports["collapse"]=collapse$412);(exports["mergeable"]=mergeable$411);

},{"earl-grey/earl-grey":8,"earl-grey/lex":10,"earl-grey/location":11,"earl-grey/parse":13,"earl-grey/stdenv":16}],20:[function(require,module,exports){

},{}],21:[function(require,module,exports){
// shim for using process in browser

var process = module.exports = {};

process.nextTick = (function () {
    var canSetImmediate = typeof window !== 'undefined'
    && window.setImmediate;
    var canPost = typeof window !== 'undefined'
    && window.postMessage && window.addEventListener
    ;

    if (canSetImmediate) {
        return function (f) { return window.setImmediate(f) };
    }

    if (canPost) {
        var queue = [];
        window.addEventListener('message', function (ev) {
            var source = ev.source;
            if ((source === window || source === null) && ev.data === 'process-tick') {
                ev.stopPropagation();
                if (queue.length > 0) {
                    var fn = queue.shift();
                    fn();
                }
            }
        }, true);

        return function nextTick(fn) {
            queue.push(fn);
            window.postMessage('process-tick', '*');
        };
    }

    return function nextTick(fn) {
        setTimeout(fn, 0);
    };
})();

process.title = 'browser';
process.browser = true;
process.env = {};
process.argv = [];

process.binding = function (name) {
    throw new Error('process.binding is not supported');
}

// TODO(shtylman)
process.cwd = function () { return '/' };
process.chdir = function (dir) {
    throw new Error('process.chdir is not supported');
};

},{}],22:[function(require,module,exports){
(function (process){
// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

// resolves . and .. elements in a path array with directory names there
// must be no slashes, empty elements, or device names (c:\) in the array
// (so also no leading and trailing slashes - it does not distinguish
// relative and absolute paths)
function normalizeArray(parts, allowAboveRoot) {
  // if the path tries to go above the root, `up` ends up > 0
  var up = 0;
  for (var i = parts.length - 1; i >= 0; i--) {
    var last = parts[i];
    if (last === '.') {
      parts.splice(i, 1);
    } else if (last === '..') {
      parts.splice(i, 1);
      up++;
    } else if (up) {
      parts.splice(i, 1);
      up--;
    }
  }

  // if the path is allowed to go above the root, restore leading ..s
  if (allowAboveRoot) {
    for (; up--; up) {
      parts.unshift('..');
    }
  }

  return parts;
}

// Split a filename into [root, dir, basename, ext], unix version
// 'root' is just a slash, or nothing.
var splitPathRe =
    /^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/;
var splitPath = function(filename) {
  return splitPathRe.exec(filename).slice(1);
};

// path.resolve([from ...], to)
// posix version
exports.resolve = function() {
  var resolvedPath = '',
      resolvedAbsolute = false;

  for (var i = arguments.length - 1; i >= -1 && !resolvedAbsolute; i--) {
    var path = (i >= 0) ? arguments[i] : process.cwd();

    // Skip empty and invalid entries
    if (typeof path !== 'string') {
      throw new TypeError('Arguments to path.resolve must be strings');
    } else if (!path) {
      continue;
    }

    resolvedPath = path + '/' + resolvedPath;
    resolvedAbsolute = path.charAt(0) === '/';
  }

  // At this point the path should be resolved to a full absolute path, but
  // handle relative paths to be safe (might happen when process.cwd() fails)

  // Normalize the path
  resolvedPath = normalizeArray(filter(resolvedPath.split('/'), function(p) {
    return !!p;
  }), !resolvedAbsolute).join('/');

  return ((resolvedAbsolute ? '/' : '') + resolvedPath) || '.';
};

// path.normalize(path)
// posix version
exports.normalize = function(path) {
  var isAbsolute = exports.isAbsolute(path),
      trailingSlash = substr(path, -1) === '/';

  // Normalize the path
  path = normalizeArray(filter(path.split('/'), function(p) {
    return !!p;
  }), !isAbsolute).join('/');

  if (!path && !isAbsolute) {
    path = '.';
  }
  if (path && trailingSlash) {
    path += '/';
  }

  return (isAbsolute ? '/' : '') + path;
};

// posix version
exports.isAbsolute = function(path) {
  return path.charAt(0) === '/';
};

// posix version
exports.join = function() {
  var paths = Array.prototype.slice.call(arguments, 0);
  return exports.normalize(filter(paths, function(p, index) {
    if (typeof p !== 'string') {
      throw new TypeError('Arguments to path.join must be strings');
    }
    return p;
  }).join('/'));
};


// path.relative(from, to)
// posix version
exports.relative = function(from, to) {
  from = exports.resolve(from).substr(1);
  to = exports.resolve(to).substr(1);

  function trim(arr) {
    var start = 0;
    for (; start < arr.length; start++) {
      if (arr[start] !== '') break;
    }

    var end = arr.length - 1;
    for (; end >= 0; end--) {
      if (arr[end] !== '') break;
    }

    if (start > end) return [];
    return arr.slice(start, end - start + 1);
  }

  var fromParts = trim(from.split('/'));
  var toParts = trim(to.split('/'));

  var length = Math.min(fromParts.length, toParts.length);
  var samePartsLength = length;
  for (var i = 0; i < length; i++) {
    if (fromParts[i] !== toParts[i]) {
      samePartsLength = i;
      break;
    }
  }

  var outputParts = [];
  for (var i = samePartsLength; i < fromParts.length; i++) {
    outputParts.push('..');
  }

  outputParts = outputParts.concat(toParts.slice(samePartsLength));

  return outputParts.join('/');
};

exports.sep = '/';
exports.delimiter = ':';

exports.dirname = function(path) {
  var result = splitPath(path),
      root = result[0],
      dir = result[1];

  if (!root && !dir) {
    // No dirname whatsoever
    return '.';
  }

  if (dir) {
    // It has a dirname, strip trailing slash
    dir = dir.substr(0, dir.length - 1);
  }

  return root + dir;
};


exports.basename = function(path, ext) {
  var f = splitPath(path)[2];
  // TODO: make this comparison case-insensitive on windows?
  if (ext && f.substr(-1 * ext.length) === ext) {
    f = f.substr(0, f.length - ext.length);
  }
  return f;
};


exports.extname = function(path) {
  return splitPath(path)[3];
};

function filter (xs, f) {
    if (xs.filter) return xs.filter(f);
    var res = [];
    for (var i = 0; i < xs.length; i++) {
        if (f(xs[i], i, xs)) res.push(xs[i]);
    }
    return res;
}

// String.prototype.substr - negative index don't work in IE8
var substr = 'ab'.substr(-1) === 'b'
    ? function (str, start, len) { return str.substr(start, len) }
    : function (str, start, len) {
        if (start < 0) start = str.length + start;
        return str.substr(start, len);
    }
;

}).call(this,require("/usr/local/lib/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js"))
},{"/usr/local/lib/node_modules/browserify/node_modules/insert-module-globals/node_modules/process/browser.js":21}],23:[function(require,module,exports){
var indexOf = require('indexof');

var Object_keys = function (obj) {
    if (Object.keys) return Object.keys(obj)
    else {
        var res = [];
        for (var key in obj) res.push(key)
        return res;
    }
};

var forEach = function (xs, fn) {
    if (xs.forEach) return xs.forEach(fn)
    else for (var i = 0; i < xs.length; i++) {
        fn(xs[i], i, xs);
    }
};

var defineProp = (function() {
    try {
        Object.defineProperty({}, '_', {});
        return function(obj, name, value) {
            Object.defineProperty(obj, name, {
                writable: true,
                enumerable: false,
                configurable: true,
                value: value
            })
        };
    } catch(e) {
        return function(obj, name, value) {
            obj[name] = value;
        };
    }
}());

var globals = ['Array', 'Boolean', 'Date', 'Error', 'EvalError', 'Function',
'Infinity', 'JSON', 'Math', 'NaN', 'Number', 'Object', 'RangeError',
'ReferenceError', 'RegExp', 'String', 'SyntaxError', 'TypeError', 'URIError',
'decodeURI', 'decodeURIComponent', 'encodeURI', 'encodeURIComponent', 'escape',
'eval', 'isFinite', 'isNaN', 'parseFloat', 'parseInt', 'undefined', 'unescape'];

function Context() {}
Context.prototype = {};

var Script = exports.Script = function NodeScript (code) {
    if (!(this instanceof Script)) return new Script(code);
    this.code = code;
};

Script.prototype.runInContext = function (context) {
    if (!(context instanceof Context)) {
        throw new TypeError("needs a 'context' argument.");
    }
    
    var iframe = document.createElement('iframe');
    if (!iframe.style) iframe.style = {};
    iframe.style.display = 'none';
    
    document.body.appendChild(iframe);
    
    var win = iframe.contentWindow;
    var wEval = win.eval, wExecScript = win.execScript;

    if (!wEval && wExecScript) {
        // win.eval() magically appears when this is called in IE:
        wExecScript.call(win, 'null');
        wEval = win.eval;
    }
    
    forEach(Object_keys(context), function (key) {
        win[key] = context[key];
    });
    forEach(globals, function (key) {
        if (context[key]) {
            win[key] = context[key];
        }
    });
    
    var winKeys = Object_keys(win);

    var res = wEval.call(win, this.code);
    
    forEach(Object_keys(win), function (key) {
        // Avoid copying circular objects like `top` and `window` by only
        // updating existing context properties or new properties in the `win`
        // that was only introduced after the eval.
        if (key in context || indexOf(winKeys, key) === -1) {
            context[key] = win[key];
        }
    });

    forEach(globals, function (key) {
        if (!(key in context)) {
            defineProp(context, key, win[key]);
        }
    });
    
    document.body.removeChild(iframe);
    
    return res;
};

Script.prototype.runInThisContext = function () {
    return eval(this.code); // maybe...
};

Script.prototype.runInNewContext = function (context) {
    var ctx = Script.createContext(context);
    var res = this.runInContext(ctx);

    forEach(Object_keys(ctx), function (key) {
        context[key] = ctx[key];
    });

    return res;
};

forEach(Object_keys(Script.prototype), function (name) {
    exports[name] = Script[name] = function (code) {
        var s = Script(code);
        return s[name].apply(s, [].slice.call(arguments, 1));
    };
});

exports.createScript = function (code) {
    return exports.Script(code);
};

exports.createContext = Script.createContext = function (context) {
    var copy = new Context();
    if(typeof context === 'object') {
        forEach(Object_keys(context), function (key) {
            copy[key] = context[key];
        });
    }
    return copy;
};

},{"indexof":24}],24:[function(require,module,exports){

var indexOf = [].indexOf;

module.exports = function(arr, obj){
  if (indexOf) return arr.indexOf(obj);
  for (var i = 0; i < arr.length; ++i) {
    if (arr[i] === obj) return i;
  }
  return -1;
};
},{}]},{},[])